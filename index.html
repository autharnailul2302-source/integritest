<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SI UJIAN</title>
    
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            if(message.includes("ResizeObserver")) return;
            console.error(message, lineno);
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SheetJS for Excel import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Mammoth.js for Word import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- EXPOSE FIREBASE FUNCTIONS ---
        window.getDocs = getDocs;
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;

        window.db = null;
        window.auth = null;
        window.appId = 'ukktkj'; 
        window.isFirebaseReady = false;
        
        // --- GLOBAL SETTINGS ---
        window.currentExamToken = "TKJ2025"; 
        window.currentExamDuration = 60; 
        window.currentMinExamDuration = 0; 
        window.deviceCooldownHours = 30; // Default 30 Menit (bukan jam)
        window.currentSesiId = null;      // ID sesi aktif
        window.currentSesiName = "Sesi Aktif"; // Nama sesi aktif
        
        window.allQuestionsDB = []; 
        window.currentExamDocId = null; 
        window.examStartTime = null; 

        // --- DEVICE FINGERPRINTING (REVISED V2) ---
        // UPDATE: Menggunakan key 'v2' untuk mereset ID lama yang mungkin duplikat pada HP sejenis (Oppo/Vivo/Xiaomi)
        function getDeviceFingerprint() {
            // Kita ganti nama key storage agar semua device membuat ID baru yang benar-benar unik
            const STORAGE_KEY = 'ukktkj_device_v2'; 
            let deviceId = localStorage.getItem(STORAGE_KEY);
            
            if (!deviceId) {
                // Generate ID yang dijamin unik menggunakan Timestamp + Math.random
                // Meskipun tipe HP sama persis, Math.random() akan membedakannya
                const timestamp = Date.now().toString(36);
                const randomPart = Math.random().toString(36).substring(2, 10);
                const randomPart2 = Math.random().toString(36).substring(2, 10);
                
                // Format: V2-TIMESTAMP-RANDOM-RANDOM
                deviceId = `V2-${timestamp}-${randomPart}-${randomPart2}`;
                
                // Simpan permanen di HP ini
                try {
                    localStorage.setItem(STORAGE_KEY, deviceId);
                } catch (e) {
                    console.warn("Gagal menyimpan device ID ke local storage (Private Mode?)");
                }
            }
            
            return deviceId;
        }

        async function initFirebase() {
            // TIME LIMIT FOR CONNECTION
            const connectionTimeout = new Promise((_, reject) => 
                setTimeout(() => reject(new Error("Koneksi Timeout")), 5000)
            );

            try {
                let firebaseConfig;
                const customConfig = {
                    apiKey: "AIzaSyAdqApOvuUXrZUO19NfiqZCLSyUYR74w5M",
                    authDomain: "waliq-ded98.firebaseapp.com",
                    projectId: "waliq-ded98",
                    storageBucket: "waliq-ded98.firebasestorage.app",
                    messagingSenderId: "915222555864",
                    appId: "1:915222555864:web:25320841c97661172e3bad",
                    measurementId: "G-K51RW0YQ0M"
                };

                if (customConfig.apiKey && customConfig.apiKey !== "GANTI_DENGAN_API_KEY_ANDA") {
                    firebaseConfig = customConfig;
                } else if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else {
                    throw new Error("Config Kosong");
                }

                if (typeof __app_id !== 'undefined') window.appId = __app_id;

                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);

                // Race between connection and timeout
                await Promise.race([
                    (async () => {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(window.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    })(),
                    connectionTimeout
                ]);
                
                window.isFirebaseReady = true;
                console.log("Firebase Connected");
                updateConnectionStatus(true, "Terhubung ke Server");
                
                listenForSettings(); 
                listenForQuestions();
                // Load ruang ujian & sesi aktif untuk dropdown siswa (deferred ke setelah LOGIC SCRIPT dimuat)
                setTimeout(() => { 
                    if (window.listenForRuang) window.listenForRuang();
                    if (window.listenForActiveSesi) window.listenForActiveSesi();
                }, 500);
                
                if (window.currentUserRole === 'teacher') {
                    setupRealtimeListener();
                    window.listenForKelas();
                    window.listenForPaket();
                    window.listenForRuang();
                }

            } catch (error) {
                console.warn("Firebase Init Error/Timeout:", error);
                window.isFirebaseReady = false;
                // Tetap izinkan aplikasi berjalan dalam mode offline
                updateConnectionStatus(false, "Mode Offline (Lokal)");
            }
        }
        
        function updateConnectionStatus(isOnline, text) {
            const el = document.getElementById('connection-status');
            if(el) {
                el.innerText = text;
                // Updated styles for better visibility on new background
                el.innerHTML = isOnline 
                    ? `<span class="inline-block w-2 h-2 rounded-full bg-green-400 mr-1 animate-pulse"></span> ${text}`
                    : `<span class="inline-block w-2 h-2 rounded-full bg-red-400 mr-1"></span> ${text}`;
                
                el.className = isOnline 
                    ? "text-[10px] font-bold text-white/90 bg-green-500/20 px-3 py-1 rounded-full border border-green-400/30 backdrop-blur-sm" 
                    : "text-[10px] font-bold text-white/90 bg-red-500/20 px-3 py-1 rounded-full border border-red-400/30 backdrop-blur-sm";
            }
        }

        initFirebase();

        // Listeners
        function listenForSettings() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'app_settings'));
            onSnapshot(q, (snapshot) => {
                let latestTime = 0;
                let latestAppearance = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.timestamp > latestTime) {
                        latestTime = data.timestamp;
                        if (data.token) window.currentExamToken = data.token;
                        if (data.examDuration) window.currentExamDuration = parseInt(data.examDuration);
                        if (data.minDuration) window.currentMinExamDuration = parseInt(data.minDuration); 
                        if (data.deviceCooldown) window.deviceCooldownHours = parseInt(data.deviceCooldown); // menit
                        // Appearance
                        if (data.judulUjian) latestAppearance.judulUjian = data.judulUjian;
                        if (data.subJudul)   latestAppearance.subJudul   = data.subJudul;
                        if (data.motivasi)   latestAppearance.motivasi   = data.motivasi;
                        if (data.logoUrl)    latestAppearance.logoUrl    = data.logoUrl;
                    }
                });
                
                const teacherInput = document.getElementById('teacher-token-input');
                const durationInput = document.getElementById('teacher-duration-input');
                const minDurationInput = document.getElementById('teacher-min-duration-input'); 
                const cooldownInput = document.getElementById('teacher-cooldown-input');
                
                if(teacherInput && document.activeElement !== teacherInput) teacherInput.value = window.currentExamToken;
                if(durationInput && document.activeElement !== durationInput) durationInput.value = window.currentExamDuration;
                if(minDurationInput && document.activeElement !== minDurationInput) minDurationInput.value = window.currentMinExamDuration;
                if(cooldownInput && document.activeElement !== cooldownInput) cooldownInput.value = window.deviceCooldownHours;

                // Terapkan pengaturan tampilan
                if (Object.keys(latestAppearance).length > 0) {
                    window._savedAppearance = latestAppearance;
                    if (window.applyAppearanceSettings) window.applyAppearanceSettings(latestAppearance);
                }
            }, (error) => {
                console.log("Offline mode triggered by snapshot error");
                window.isFirebaseReady = false;
                updateConnectionStatus(false, "Mode Offline (Lokal)");
            });
        }

        function listenForQuestions() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'));
            onSnapshot(q, (snapshot) => {
                window.allQuestionsDB = [];
                snapshot.forEach((doc) => {
                    window.allQuestionsDB.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${window.allQuestionsDB.length} questions from DB`);
                
                if (typeof window.filterQuestionBank === 'function' && !document.getElementById('section-dashboard').classList.contains('hidden-section')) {
                    window.filterQuestionBank();
                }
            }, (err) => {});
        }

        // --- START EXAM LOG ---
        window.saveExamStart = async (data) => {
            if (window.isFirebaseReady && window.db) {
                try {
                    data.deviceFingerprint = getDeviceFingerprint();
                    const docRef = await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'), data);
                    window.currentExamDocId = docRef.id; 
                } catch (e) {
                    console.error("Failed to log start", e);
                }
            } else {
                console.log("Offline: Exam start stored locally only");
            }
        }

        // --- SAVE RESULT ---
        window.saveExamResult = async (data) => {
            if (window.isFirebaseReady && window.db) {
                try {
                    if (window.currentExamDocId) {
                        await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', window.currentExamDocId), data);
                    } else {
                        await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'), data);
                    }
                } catch (e) {
                    console.error("Failed save", e);
                    alert("Gagal menyimpan ke database pusat (Offline Mode). Nilai tetap tersimpan di layar ini.");
                }
            }
        }

        // --- SAVE SETTINGS ---
        window.saveSettings = async () => {
            const newToken = document.getElementById('teacher-token-input').value.trim().toUpperCase();
            const newDuration = parseInt(document.getElementById('teacher-duration-input').value);
            const newMinDuration = parseInt(document.getElementById('teacher-min-duration-input').value) || 0; 
            const newCooldown = parseInt(document.getElementById('teacher-cooldown-input').value) || 30;

            if(!newToken) return alert("Token tidak boleh kosong!");
            if(!newDuration || newDuration < 1) return alert("Durasi tidak valid (minimal 1 menit)!");
            if(newMinDuration > newDuration) return alert("Durasi minimal tidak boleh lebih besar dari durasi ujian!");
            if(newCooldown < 10) return alert("Cooldown device minimal 10 menit!");

            // Ambil juga pengaturan tampilan
            const newJudulUjian   = (document.getElementById('setting-judul-ujian')?.value || '').trim();
            const newSubJudul     = (document.getElementById('setting-sub-judul')?.value || '').trim();
            const newMotivasi     = (document.getElementById('setting-motivasi')?.value || '').trim();
            const newLogoUrl      = (document.getElementById('setting-logo-url')?.value || '').trim();

            if (window.isFirebaseReady && window.db) {
                await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'app_settings'), {
                    token: newToken,
                    examDuration: newDuration,
                    minDuration: newMinDuration, 
                    deviceCooldown: newCooldown,  // dalam MENIT
                    judulUjian:   newJudulUjian   || undefined,
                    subJudul:     newSubJudul     || undefined,
                    motivasi:     newMotivasi     || undefined,
                    logoUrl:      newLogoUrl      || undefined,
                    timestamp: Date.now()
                });
                // Terapkan ke UI langsung
                window.applyAppearanceSettings({ judulUjian: newJudulUjian, subJudul: newSubJudul, motivasi: newMotivasi, logoUrl: newLogoUrl });
                alert(`‚úÖ Pengaturan disimpan!\nToken: ${newToken} | Durasi: ${newDuration} mnt | Cooldown: ${newCooldown} mnt`);
            } else {
                // Offline ‚Äî terapkan ke UI saja
                window.applyAppearanceSettings({ judulUjian: newJudulUjian, subJudul: newSubJudul, motivasi: newMotivasi, logoUrl: newLogoUrl });
                alert("Mode Offline: Pengaturan tampilan diterapkan sementara, pengaturan ujian tidak tersimpan ke server.");
            }
        };

        window.seedDatabase = async () => {
            if(!window.isFirebaseReady) return alert("Fitur ini butuh koneksi internet (Firebase).");

            // Pastikan questionBank sudah tersedia (didefinisikan di script terpisah)
            const qBank = window.questionBank;
            if (!qBank) return alert("Data soal belum siap, coba refresh halaman.");

            if (!confirm(
                "Upload Soal Bawaan ke Database?\n\n" +
                "Ini akan:\n" +
                "1. Membuat 3 Paket Soal (A, B, C) jika belum ada\n" +
                "2. Mengupload soal ke masing-masing paket\n\n" +
                "Soal duplikat akan dilewati secara otomatis."
            )) return;

            const btn = document.getElementById('btn-seed-db');
            if(btn) { btn.disabled = true; btn.innerText = "‚è≥ Sedang Upload... Jangan tutup halaman ini"; }

            try {
                // ‚îÄ‚îÄ STEP 1: Fetch paket SEGAR dari Firestore (hindari cache stale) ‚îÄ‚îÄ
                const paketSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal'));
                const freshPaket = [];
                paketSnap.forEach(d => freshPaket.push({ id: d.id, ...d.data() }));

                const paketDefs = [
                    { jenis: 'A', nama: 'Paket A - PKK (PKWU)', mapel: 'Produk Kreatif dan Kewirausahaan', token: window.currentExamToken || 'TKJ2025' },
                    { jenis: 'B', nama: 'Paket B - PKK (PKWU)', mapel: 'Produk Kreatif dan Kewirausahaan', token: window.currentExamToken || 'TKJ2025' },
                    { jenis: 'C', nama: 'Paket C - Keamanan Jaringan', mapel: 'Keamanan Jaringan', token: window.currentExamToken || 'TKJ2025' },
                ];

                const paketMap = {}; // jenis -> paketId
                let paketBaru = 0;

                for (const def of paketDefs) {
                    const existing = freshPaket.find(p => p.jenis === def.jenis);
                    if (existing) {
                        paketMap[def.jenis] = existing.id;
                    } else {
                        const ref = await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal'), {
                            ...def, aktif: true, kelas: [], createdAt: Date.now(), updatedAt: Date.now()
                        });
                        paketMap[def.jenis] = ref.id;
                        paketBaru++;
                    }
                }

                // ‚îÄ‚îÄ STEP 2: Fetch soal SEGAR dari Firestore (hindari cache stale) ‚îÄ‚îÄ
                const soalSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'));
                const freshSoal = [];
                soalSnap.forEach(d => freshSoal.push({ id: d.id, ...d.data() }));

                // ‚îÄ‚îÄ STEP 3: Upload soal ke masing-masing paket ‚îÄ‚îÄ
                let count = 0, skipped = 0;

                for (const pkt of ['A', 'B', 'C']) {
                    const questions = qBank[pkt];
                    if (!questions || !questions.length) continue;
                    const paketId = paketMap[pkt];

                    for (const q of questions) {
                        // Cek duplikat berdasarkan teks soal + paketId
                        const duplikat = freshSoal.some(dbQ =>
                            dbQ.paketId === paketId && dbQ.text === q.text
                        );
                        if (duplikat) { skipped++; continue; }

                        await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'), {
                            paketId,
                            packet: pkt,
                            text: q.text,
                            options: q.options,
                            correct: q.correct,
                            aktif: true,
                            createdAt: Date.now(),
                            updatedAt: Date.now()
                        });
                        count++;
                        // Update label progres
                        if(btn) btn.innerText = `‚è≥ Upload soal... (${count} soal)`;
                    }
                }

                alert(`‚úÖ Selesai!\n\nPaket baru dibuat: ${paketBaru}\nPaket diverifikasi: ${3 - paketBaru}\nSoal baru diupload: ${count}\nSoal duplikat dilewati: ${skipped}`);
            } catch (e) {
                console.error(e);
                alert("‚ùå Gagal upload: " + e.message);
            } finally {
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = `<i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload Soal Bawaan ke DB (+ Buat Paket A/B/C)`;
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                }
            }
        };

        window.deleteQuestion = async (id) => {
            if(!window.isFirebaseReady) return alert("Mode Offline.");
            if(!confirm("Hapus soal ini?")) return;
            try { await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'questions', id)); } catch(e) { alert("Gagal hapus: " + e.message); }
        };
        
        window.deleteExamResult = async (id) => {
            if(!window.isFirebaseReady) return alert("Mode Offline.");
            if(!confirm("Apakah Anda yakin ingin MENGHAPUS data ujian siswa ini?\n\nTindakan ini tidak dapat dibatalkan.")) return;
            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', id));
            } catch(e) {
                alert("Gagal menghapus: " + e.message);
            }
        };

        window.resetAllExamData = async () => {
            if(!window.isFirebaseReady) return alert("Mode Offline.");
            const sesiNama = window.currentSesiName || 'Sesi Aktif';
            const key = prompt(
                `‚ö†Ô∏è HAPUS DATA SESI INI\n\n` +
                `Anda akan menghapus semua data hasil ujian di "${sesiNama}".\n` +
                `Data sesi lain TIDAK akan terhapus.\n\n` +
                `Ketik 'HAPUS SESI' untuk konfirmasi:`
            );
            
            if (key !== 'HAPUS SESI') {
                return alert("Penghapusan dibatalkan.");
            }

            const btn = document.getElementById('btn-reset-all');
            if(btn) { btn.disabled = true; btn.innerText = "Sedang Menghapus..."; }

            try {
                const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) { alert("Data sudah kosong."); return; }

                const activeSesiId = window.currentSesiId || 'default';
                const toDelete = [];
                snapshot.forEach((d) => {
                    const data = d.data();
                    // Hanya hapus data yang sesiIdnya cocok dengan sesi aktif
                    const matchSesi = (data.sesiId === activeSesiId) || (!data.sesiId && activeSesiId === 'default');
                    if (matchSesi) toDelete.push(deleteDoc(d.ref));
                });
                
                await Promise.all(toDelete);
                alert(`‚úÖ Berhasil menghapus ${toDelete.length} data ujian dari "${sesiNama}".`);
                
            } catch(e) {
                console.error(e);
                alert("Gagal mereset data: " + e.message);
            } finally {
                if(btn) { btn.disabled = false; btn.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i> Reset Sesi Ini`; if(typeof lucide !== 'undefined') lucide.createIcons(); }
            }
        };

        // ---- HELPER: Konversi URL Google Drive ke direct link ----
        window.convertGDriveUrl = function(url) {
            if (!url) return '';
            // Format: https://drive.google.com/file/d/FILE_ID/view?...
            const matchFile = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (matchFile) return `https://drive.google.com/uc?export=view&id=${matchFile[1]}`;
            // Format: https://drive.google.com/open?id=FILE_ID
            const matchOpen = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (matchOpen) return `https://drive.google.com/uc?export=view&id=${matchOpen[1]}`;
            // Format lain (langsung URL gambar) - kembalikan apa adanya
            return url;
        };

        // ---- HELPER: Switch tab URL/Upload di editor soal ----
        window.switchImgTab = function(prefix, tab) {
            const urlPanel    = document.getElementById(`${prefix}-img-panel-url`);
            const uploadPanel = document.getElementById(`${prefix}-img-panel-upload`);
            const tabUrl      = document.getElementById(`${prefix}-img-tab-url`);
            const tabUpload   = document.getElementById(`${prefix}-img-tab-upload`);
            if (tab === 'url') {
                urlPanel.classList.remove('hidden');
                uploadPanel.classList.add('hidden');
                tabUrl.className    = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-blue-600 text-white';
                tabUpload.className = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-white text-blue-600 border border-blue-300 hover:bg-blue-50';
            } else {
                urlPanel.classList.add('hidden');
                uploadPanel.classList.remove('hidden');
                tabUrl.className    = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-white text-blue-600 border border-blue-300 hover:bg-blue-50';
                tabUpload.className = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-blue-600 text-white';
            }
        };

        // ---- HELPER: Preview gambar dari URL ----
        window.previewImg = function(prefix, url) {
            const finalUrl = window.convertGDriveUrl(url.trim());
            const preview  = document.getElementById(`${prefix}-img-preview`);
            const img      = document.getElementById(`${prefix}-img-preview-img`);
            const dataEl   = document.getElementById(`${prefix}-image-data`);
            if (finalUrl) {
                img.src = finalUrl;
                preview.classList.remove('hidden');
                dataEl.value = finalUrl;
            } else {
                preview.classList.add('hidden');
                dataEl.value = '';
            }
        };

        // ---- HELPER: Upload gambar ‚Üí Base64 ----
        window.handleImgUpload = function(prefix, input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 900 * 1024) {
                alert('Ukuran gambar terlalu besar (maks 800KB). Kompres dulu gambarnya ya!');
                input.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                const preview = document.getElementById(`${prefix}-img-preview`);
                const img     = document.getElementById(`${prefix}-img-preview-img`);
                const dataEl  = document.getElementById(`${prefix}-image-data`);
                img.src = base64;
                preview.classList.remove('hidden');
                dataEl.value = base64;
            };
            reader.readAsDataURL(file);
        };

        // ---- HELPER: Hapus gambar ----
        window.clearImg = function(prefix) {
            document.getElementById(`${prefix}-img-preview`).classList.add('hidden');
            document.getElementById(`${prefix}-img-preview-img`).src = '';
            document.getElementById(`${prefix}-image-data`).value = '';
            const urlInput = document.getElementById(`${prefix}-image-url`);
            if (urlInput) urlInput.value = '';
            const fileInput = document.getElementById(`${prefix}-img-file`);
            if (fileInput) fileInput.value = '';
        };

        // ---- HELPER: hapus gambar opsi ----
        window.clearOptImg = function(btn) {
            const wrapper = btn.closest('.opt-img-wrapper');
            if (!wrapper) return;
            wrapper.querySelector('.opt-img-preview').classList.add('hidden');
            wrapper.querySelector('.opt-img-preview img').src = '';
            wrapper.querySelector('.opt-image-data').value = '';
            const urlInput = wrapper.querySelector('.opt-image-url');
            if (urlInput) urlInput.value = '';
            const fileInput = wrapper.querySelector('.opt-img-file');
            if (fileInput) fileInput.value = '';
        };

        window.openQuestionModal = (id = null) => {
            const modal = document.getElementById('modal-question');
            const form  = document.getElementById('form-question');
            form.reset();
            document.getElementById('q-id').value = id || '';
            document.getElementById('q-options-container').innerHTML = '';
            document.getElementById('q-aktif').checked = true;
            document.getElementById('q-aktif-label').textContent = 'Aktif';
            document.getElementById('q-aktif-label').className = 'text-sm font-bold text-green-600';

            // Set paket context
            const paket = window.allPaketDB.find(p => p.id === window.activePaketId);
            document.getElementById('q-packet').value = window.activePaketId || '';
            document.getElementById('modal-q-paket-label').textContent = paket ? paket.nama : '‚Äî';

            // Reset gambar soal
            window.clearImg('q');
            window.switchImgTab('q', 'url');

            // aktif toggle
            document.getElementById('q-aktif').onchange = function() {
                const lbl = document.getElementById('q-aktif-label');
                lbl.textContent = this.checked ? 'Aktif' : 'Nonaktif';
                lbl.className = `text-sm font-bold ${this.checked ? 'text-green-600' : 'text-gray-400'}`;
            };

            if (id) {
                document.getElementById('modal-q-title').textContent = 'Edit Soal';
                const q = window.allQuestionsDB.find(x => x.id === id);
                if (q) {
                    document.getElementById('q-correct').value = q.correct;
                    document.getElementById('q-text').value    = q.text || '';
                    const isAktif = q.aktif !== false;
                    document.getElementById('q-aktif').checked = isAktif;
                    document.getElementById('q-aktif-label').textContent = isAktif ? 'Aktif' : 'Nonaktif';
                    document.getElementById('q-aktif-label').className = `text-sm font-bold ${isAktif ? 'text-green-600' : 'text-gray-400'}`;
                    if (q.image) {
                        document.getElementById('q-image-data').value = q.image;
                        const img = document.getElementById('q-img-preview-img');
                        img.src = q.image;
                        document.getElementById('q-img-preview').classList.remove('hidden');
                        if (!q.image.startsWith('data:')) document.getElementById('q-image-url').value = q.image;
                    }
                    q.options.forEach((opt, i) => addOptionInput(opt, q.optionImages ? q.optionImages[i] : ''));
                }
            } else {
                document.getElementById('modal-q-title').textContent = 'Tambah Soal Baru';
                for(let i=0; i<5; i++) addOptionInput('', '');
            }
            modal.classList.remove('hidden');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closeQuestionModal = () => { document.getElementById('modal-question').classList.add('hidden'); };

        window.addOptionInput = (value = '', imgValue = '') => {
            const container = document.getElementById('q-options-container');
            const idx = container.children.length;
            const labels = ['A','B','C','D','E'];
            const div = document.createElement('div');
            div.className = "mb-3 border rounded-xl p-3 bg-gray-50";
            div.innerHTML = `
                <div class="flex gap-2 mb-2 items-center">
                    <span class="py-1.5 px-3 bg-blue-600 text-white rounded-lg text-sm font-bold min-w-[32px] text-center">${labels[idx]||idx}</span>
                    <input type="text" name="options[]" value="${value.replace(/"/g,'&quot;')}" class="flex-1 px-3 py-2 border rounded-lg outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm" placeholder="Teks pilihan (boleh kosong jika pakai gambar)">
                    <button type="button" onclick="this.closest('.mb-3').remove(); window.reindexOptions()" class="text-red-400 hover:bg-red-50 p-2 rounded-lg shrink-0"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
                <div class="opt-img-wrapper">
                    <div class="flex gap-2 mb-1">
                        <button type="button" onclick="window.switchOptImgTab(this,'url')" class="opt-img-tab-url px-2 py-1 text-xs font-bold rounded bg-purple-600 text-white">üîó URL/Drive</button>
                        <button type="button" onclick="window.switchOptImgTab(this,'upload')" class="opt-img-tab-upload px-2 py-1 text-xs font-bold rounded bg-white text-purple-600 border border-purple-300 hover:bg-purple-50">üìÅ Upload</button>
                        <span class="text-xs text-gray-400 self-center">Gambar pilihan (opsional)</span>
                    </div>
                    <div class="opt-img-panel-url">
                        <input type="text" class="opt-image-url w-full px-2 py-1.5 border rounded text-xs outline-none focus:ring-1 focus:ring-purple-400 bg-white" placeholder="URL gambar atau link Google Drive..." value="${imgValue && !imgValue.startsWith('data:') ? imgValue.replace(/"/g,'&quot;') : ''}" oninput="window.previewOptImg(this)">
                    </div>
                    <div class="opt-img-panel-upload hidden">
                        <div class="border border-dashed border-purple-300 rounded p-2 text-center cursor-pointer hover:bg-purple-50 text-xs text-purple-500" onclick="this.nextElementSibling.click()">üìÅ Pilih gambar...</div>
                        <input type="file" class="opt-img-file hidden" accept="image/*" onchange="window.handleOptImgUpload(this)">
                    </div>
                    <input type="hidden" class="opt-image-data" value="${imgValue ? imgValue.replace(/"/g,'&quot;') : ''}">
                    <div class="opt-img-preview hidden mt-2 flex items-center gap-2">
                        <img src="${imgValue || ''}" class="max-h-20 rounded border border-purple-200 object-contain bg-white" ${imgValue ? '' : 'style="display:none"'}>
                        <button type="button" onclick="window.clearOptImg(this)" class="text-xs text-red-400 hover:underline shrink-0">‚úï Hapus</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
            // Tampilkan preview jika ada gambar awal
            if (imgValue) {
                const preview = div.querySelector('.opt-img-preview');
                const img = preview.querySelector('img');
                preview.classList.remove('hidden');
                img.style.display = '';
                img.src = imgValue;
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.reindexOptions = function() {
            const labels = ['A','B','C','D','E'];
            document.querySelectorAll('#q-options-container > div').forEach((div, i) => {
                const badge = div.querySelector('span.bg-blue-600');
                if (badge) badge.textContent = labels[i] || i;
            });
        };

        window.switchOptImgTab = function(btn, tab) {
            const wrapper = btn.closest('.opt-img-wrapper');
            const urlPanel    = wrapper.querySelector('.opt-img-panel-url');
            const uploadPanel = wrapper.querySelector('.opt-img-panel-upload');
            const tabUrl      = wrapper.querySelector('.opt-img-tab-url');
            const tabUpload   = wrapper.querySelector('.opt-img-tab-upload');
            if (tab === 'url') {
                urlPanel.classList.remove('hidden');
                uploadPanel.classList.add('hidden');
                tabUrl.className    = 'opt-img-tab-url px-2 py-1 text-xs font-bold rounded bg-purple-600 text-white';
                tabUpload.className = 'opt-img-tab-upload px-2 py-1 text-xs font-bold rounded bg-white text-purple-600 border border-purple-300 hover:bg-purple-50';
            } else {
                urlPanel.classList.add('hidden');
                uploadPanel.classList.remove('hidden');
                tabUrl.className    = 'opt-img-tab-url px-2 py-1 text-xs font-bold rounded bg-white text-purple-600 border border-purple-300 hover:bg-purple-50';
                tabUpload.className = 'opt-img-tab-upload px-2 py-1 text-xs font-bold rounded bg-purple-600 text-white';
            }
        };

        window.previewOptImg = function(input) {
            const wrapper = input.closest('.opt-img-wrapper');
            const url = window.convertGDriveUrl(input.value.trim());
            const preview = wrapper.querySelector('.opt-img-preview');
            const img = preview.querySelector('img');
            const dataEl = wrapper.querySelector('.opt-image-data');
            if (url) {
                img.src = url; img.style.display = '';
                preview.classList.remove('hidden');
                dataEl.value = url;
            } else {
                img.style.display = 'none';
                preview.classList.add('hidden');
                dataEl.value = '';
            }
        };

        window.handleOptImgUpload = function(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 900 * 1024) { alert('Gambar terlalu besar (maks 800KB)!'); input.value=''; return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = input.closest('.opt-img-wrapper');
                const preview = wrapper.querySelector('.opt-img-preview');
                const img = preview.querySelector('img');
                const dataEl = wrapper.querySelector('.opt-image-data');
                img.src = e.target.result; img.style.display = '';
                preview.classList.remove('hidden');
                dataEl.value = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        window.saveQuestionSubmit = async (e) => {
            e.preventDefault();
            if(!window.isFirebaseReady) return alert("Mode Offline: Tidak bisa menyimpan soal.");

            const id      = document.getElementById('q-id').value;
            const paketId = document.getElementById('q-packet').value;
            const text    = document.getElementById('q-text').value;
            const correct = parseInt(document.getElementById('q-correct').value);
            const image   = document.getElementById('q-image-data').value || '';
            const aktif   = document.getElementById('q-aktif').checked;

            // Derive packet letter from paket data
            const paket = window.allPaketDB.find(p => p.id === paketId);
            const packet = paket ? (paket.jenis !== 'nonpaket' ? paket.jenis : 'A') : 'A';
            const token  = paket ? paket.token : '';

            const optRows = document.querySelectorAll('#q-options-container > div');
            const options = [], optionImages = [];
            optRows.forEach(row => {
                const textInput = row.querySelector('input[name="options[]"]');
                const imgData   = row.querySelector('.opt-image-data');
                options.push(textInput ? textInput.value : '');
                optionImages.push(imgData ? imgData.value : '');
            });

            if (!text && !image) return alert("Soal harus memiliki teks pertanyaan atau gambar soal!");
            if (options.every(o => !o) && optionImages.every(i => !i)) return alert("Minimal satu pilihan jawaban harus diisi!");

            const data = { paketId, packet, text, options, optionImages, correct, image, token, aktif, updatedAt: Date.now() };

            try {
                if (id) {
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'questions', id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'), data);
                }
                window.closeQuestionModal();
            } catch (err) { alert("Gagal menyimpan: " + err.message); }
        };

        window.setupRealtimeListener = () => {
            if (!window.isFirebaseReady || !window.db) {
                // Jangan loop selamanya jika offline
                return;
            }
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));
            let isInitialLoad = true;

            onSnapshot(q, (snapshot) => {
                const results = [];
                snapshot.forEach((doc) => {
                    results.push({ id: doc.id, ...doc.data() });
                });
                
                if (!isInitialLoad && window.currentUserRole === 'teacher') {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "modified" || change.type === "added") {
                            const data = change.doc.data();
                            if (data.violations > 0 || (data.status && data.status.includes("DISKUALIFIKASI"))) {
                                if(window.triggerCheatAlert) window.triggerCheatAlert(data);
                            }
                        }
                    });
                }
                isInitialLoad = false;

                results.sort((a, b) => b.timestamp - a.timestamp);
                if(window.updateDashboardTable) window.updateDashboardTable(results);
            });
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; user-select: none; }
        .hidden-section { display: none !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .no-copy { user-select: none; -webkit-user-select: none; }
        #exam-sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(100%); }
        .sidebar-open { transform: translateX(0); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #modal-confirm { transition: opacity 0.2s ease-out; }
        #modal-confirm.show { opacity: 1; }
        #modal-content { transition: transform 0.2s ease-out; }
        #modal-confirm.show #modal-content { transform: scale(100%); }

        /* ===== ANTI-CHEAT ENGINE STYLES ===== */
        #watermark-canvas { pointer-events: none; }
        #modal-warning-student, #modal-dq-final { backdrop-filter: blur(6px); }
        #modal-warning-student h1 { text-shadow: 0 0 40px rgba(239,68,68,0.9); }
        @keyframes siren-ring {
            0%   { box-shadow: 0 0 0 0   rgba(239,68,68,0.9); }
            70%  { box-shadow: 0 0 0 28px rgba(239,68,68,0);  }
            100% { box-shadow: 0 0 0 0   rgba(239,68,68,0);  }
        }
        .siren-ring { animation: siren-ring 1.1s ease-out infinite; }
    </style>
</head>
<body>

    <!-- SECTION: LOGIN (REDESIGNED) -->
    <div id="section-login" class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden bg-slate-900">
        <!-- Background Effects -->
        <div class="absolute inset-0 z-0">
             <!-- Cyber Grid Background -->
            <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-slate-900 via-[#0f172a] to-[#1e1b4b]"></div>
            
            <!-- Animated Globs -->
            <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-600/20 rounded-full blur-[100px] animate-pulse"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-purple-600/20 rounded-full blur-[100px] animate-pulse" style="animation-delay: 2s;"></div>
            <div class="absolute top-[30%] right-[20%] w-64 h-64 bg-cyan-500/10 rounded-full blur-[80px]"></div>
        </div>

        <!-- Glass Card Container -->
        <div class="w-full max-w-md bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden border border-white/20 z-10 transform transition-all duration-500 hover:shadow-blue-500/20">
            
            <!-- Header Section -->
            <div class="bg-gradient-to-r from-blue-700 via-blue-600 to-indigo-700 p-8 text-center relative overflow-hidden group">
                <!-- Decorative pattern -->
                <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
                
                <div class="absolute top-4 right-4 z-20">
                    <span id="connection-status" class="text-[10px] font-bold text-white/90 bg-white/20 px-3 py-1 rounded-full border border-white/30 backdrop-blur-sm shadow-sm flex items-center gap-2">
                        <span class="inline-block w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span> Connecting...
                    </span>
                </div>

                <div class="relative z-10 flex flex-col items-center">
                    <div class="w-24 h-24 bg-white p-1.5 rounded-full shadow-lg mb-4 transform transition-all duration-500 hover:rotate-[360deg] hover:scale-105 ring-4 ring-white/30 relative">
                        <div class="absolute inset-0 rounded-full bg-gradient-to-tr from-blue-400 to-purple-400 opacity-0 group-hover:opacity-20 transition-opacity"></div>
                        <img src="images/logotkj.png" onerror="this.src='https://via.placeholder.com/150?text=TKJ'" alt="Logo TKJ" class="w-full h-full object-contain rounded-full bg-white">
                    </div>
                    <h1 id="login-header-judul" class="text-3xl font-black text-white tracking-tight drop-shadow-md">
                        SI UJIAN TKJ
                    </h1>
                    <div class="h-1 w-20 bg-blue-400/50 rounded-full my-2"></div>
                    <p id="login-header-sub" class="text-blue-100 text-sm font-medium tracking-wide">Computer Network Engineering Exam</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-100 bg-gray-50/50">
                <button id="tab-student" onclick="window.switchLoginTab('student')" class="flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-white transition-all hover:bg-blue-50/50 relative">
                    <div class="flex items-center justify-center gap-2">
                        <i data-lucide="user" class="w-4 h-4"></i> Login Siswa
                    </div>
                </button>
                <button id="tab-teacher" onclick="window.switchLoginTab('teacher')" class="flex-1 py-4 text-sm font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent transition-all hover:bg-gray-50/50">
                    <div class="flex items-center justify-center gap-2">
                         <i data-lucide="shield" class="w-4 h-4"></i> Login Guru
                    </div>
                </button>
            </div>

            <!-- Content Area -->
            <div class="p-8 bg-white">
                <form id="form-student" onsubmit="window.handleStudentLogin(event)" class="space-y-5">
                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Nama Lengkap</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="user-circle" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                            </div>
                            <input type="text" id="student-name" required class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium placeholder-gray-400" placeholder="Ketik nama lengkap...">
                        </div>
                    </div>
					
					 <!-- 2. TAMBAHAN BARU: Input NISN -->
                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">NISN</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="id-card" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                            </div>
                            <input type="number" id="student-nisn" required class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium placeholder-gray-400" placeholder="Ketik NISN...">
                        </div>
                    </div>

                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Kelas</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="users" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                            </div>
                            <select id="student-class" required class="w-full pl-10 pr-8 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium appearance-none">
                                <option value="">-- Pilih Kelas --</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-400">
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>

                    <!-- RUANG UJIAN -->
                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Ruang Ujian</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="door-open" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                            </div>
                            <select id="student-room" required class="w-full pl-10 pr-8 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium appearance-none">
                                <option value="">-- Pilih Ruang Ujian --</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-400">
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1 ml-1">* Pilih ruang sesuai tempat duduk kamu. Tanya pengawas jika ragu.</p>
                    </div>

                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Token Ujian</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="key" class="h-5 w-5 text-gray-400 group-focus-within:text-yellow-500 transition-colors"></i>
                            </div>
                            <input type="text" id="student-token" required
                                class="w-full pl-10 pr-4 py-3.5 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white text-center font-mono font-bold tracking-[0.3em] text-blue-700 placeholder-gray-300 uppercase text-base"
                                placeholder="MASUKKAN TOKEN">
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1 ml-1">* Token ujian diberikan oleh guru/pengawas.</p>
                    </div>

                    <!-- Hidden: paket dipilih otomatis di halaman selamat datang -->
                    <input type="hidden" id="selected-packet" value="">

                    <button type="submit" id="btn-student-submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30 transform transition-all hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-3 group text-base">
                        <i data-lucide="log-in" class="w-5 h-5"></i>
                        <span>MASUK</span>
                        <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                    </button>

                    <div class="flex items-center justify-center gap-1.5 text-[10px] text-gray-400">
                        <i data-lucide="maximize-2" class="w-3 h-3"></i>
                        <span>Aplikasi otomatis masuk mode layar penuh saat login.</span>
                    </div>
                </form>

                <div id="form-teacher" class="hidden-section">
                    <!-- Sub-tab: Admin vs Pengawas -->
                    <div class="flex gap-2 mb-5 bg-gray-100 p-1 rounded-xl">
                        <button id="subtab-admin" onclick="window.switchTeacherSubTab('admin')" class="flex-1 py-2 text-xs font-bold rounded-lg bg-white text-gray-800 shadow-sm flex items-center justify-center gap-1.5">
                            <i data-lucide="shield-check" class="w-3.5 h-3.5 text-indigo-600"></i> Admin / Koordinator
                        </button>
                        <button id="subtab-pengawas" onclick="window.switchTeacherSubTab('pengawas')" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1.5">
                            <i data-lucide="eye" class="w-3.5 h-3.5"></i> Pengawas Ruang
                        </button>
                    </div>

                    <!-- FORM ADMIN -->
                    <form id="form-admin-login" onsubmit="window.handleAdminLogin(event)" class="space-y-4">
                        <div class="p-3 bg-indigo-50 rounded-xl border border-indigo-200 flex items-start gap-3">
                            <i data-lucide="lock" class="w-4 h-4 text-indigo-600 mt-0.5 shrink-0"></i>
                            <p class="text-xs text-indigo-700">Login Admin memberi akses ke seluruh data, pengaturan, dan semua ruang ujian.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Username</label>
                            <input type="text" id="admin-user" placeholder="Username Admin" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Password Admin</label>
                            <input type="password" id="admin-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium">
                        </div>
                        <button type="submit" class="w-full bg-indigo-700 hover:bg-indigo-800 text-white font-bold py-3.5 rounded-xl shadow-lg transform transition-all hover:scale-[1.02] flex items-center justify-center gap-2">
                            <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Masuk Sebagai Admin
                        </button>
                    </form>

                    <!-- FORM PENGAWAS RUANG -->
                    <form id="form-pengawas-login" onsubmit="window.handlePengawasLogin(event)" class="space-y-4 hidden-section">
                        <div class="p-3 bg-amber-50 rounded-xl border border-amber-200 flex items-start gap-3">
                            <i data-lucide="eye" class="w-4 h-4 text-amber-600 mt-0.5 shrink-0"></i>
                            <p class="text-xs text-amber-700">Login Pengawas hanya memberi akses monitoring siswa di ruang yang ditentukan.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Ruang Ujian</label>
                            <div class="relative">
                                <i data-lucide="door-open" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                <select id="pengawas-room-select" class="w-full pl-10 pr-8 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-amber-500/10 focus:border-amber-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium appearance-none">
                                    <option value="">-- Pilih Ruang --</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Password Ruang</label>
                            <input type="password" id="pengawas-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-amber-500/10 focus:border-amber-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium">
                            <p class="text-[10px] text-gray-400 mt-1 ml-1">* Password berbeda tiap ruang, ditetapkan oleh Admin.</p>
                        </div>
                        <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3.5 rounded-xl shadow-lg transform transition-all hover:scale-[1.02] flex items-center justify-center gap-2">
                            <i data-lucide="eye" class="w-4 h-4"></i> Masuk Monitoring Ruang
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50/80 p-4 text-center border-t border-gray-100 backdrop-blur-sm">
                <p class="text-[10px] text-gray-400 font-medium flex items-center justify-center gap-1">
                    &copy; 2026 Nailul Authar <span class="text-gray-300">‚Ä¢</span> SMK Negeri 1 Brondong
                </p>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WATERMARK OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="watermark-overlay" class="fixed inset-0 pointer-events-none z-[25] hidden select-none overflow-hidden" aria-hidden="true">
        <canvas id="watermark-canvas" class="w-full h-full" style="opacity:0.07"></canvas>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL PERINGATAN SISWA ‚Äî FULLSCREEN (countdown, tidak bisa ditutup paksa) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="modal-warning-student" class="fixed inset-0 z-[999] hidden" style="background:rgba(0,0,0,0.96)">
        <!-- Flash merah kilat -->
        <div id="warning-flash" class="absolute inset-0 bg-red-600 opacity-0 pointer-events-none transition-opacity duration-100"></div>
        <div class="relative z-10 h-full flex flex-col items-center justify-center p-6 text-center overflow-y-auto">
            <!-- Ikon sirine -->
            <div class="relative mb-6 shrink-0">
                <div class="w-32 h-32 rounded-full bg-red-600 siren-ring flex items-center justify-center shadow-2xl shadow-red-500/60">
                    <div class="w-24 h-24 rounded-full bg-red-700 border-4 border-red-400 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-14 h-14 text-white animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    </div>
                </div>
            </div>
            <!-- Badge pelanggaran -->
            <div class="inline-flex items-center gap-2 bg-red-700 text-white px-6 py-2 rounded-full font-black uppercase tracking-widest shadow-lg mb-5 text-sm md:text-base">
                ‚ö†Ô∏è PELANGGARAN <span id="ws-vcount" class="text-yellow-300 text-2xl mx-1">1</span> / 3
            </div>
            <!-- Judul -->
            <h1 id="ws-title" class="text-3xl md:text-5xl font-black text-white uppercase tracking-wider mb-2 leading-tight">TERDETEKSI CURANG!</h1>
            <p id="ws-name" class="text-red-300 font-bold text-base md:text-lg mb-5"></p>
            <!-- Detail kotak -->
            <div class="bg-red-900/80 border-2 border-red-500 rounded-2xl p-5 max-w-lg w-full mb-5">
                <p id="ws-detail" class="text-red-100 font-semibold text-sm md:text-base leading-relaxed"></p>
                <div class="mt-3 pt-3 border-t border-red-700">
                    <p id="ws-consequence" class="font-bold text-sm"></p>
                </div>
            </div>
            <!-- Countdown -->
            <div id="ws-cd-wrapper" class="mb-5">
                <p class="text-gray-400 text-xs mb-1">Tombol aktif dalam:</p>
                <div id="ws-cd" class="text-5xl font-black text-white tabular-nums">5</div>
            </div>
            <!-- Tombol tutup (disabled sampai countdown) -->
            <button id="ws-close-btn" onclick="window.closeWarningModal()" disabled
                class="w-full max-w-sm py-4 rounded-2xl font-black text-lg uppercase tracking-widest bg-gray-700 text-gray-500 cursor-not-allowed transition-all duration-500">
                MENGERTI ‚Äî LANJUTKAN UJIAN
            </button>
            <p class="text-gray-600 text-xs mt-5 max-w-sm">Sistem merekam semua aktivitas secara real-time. Pengawas melihat pelanggaran ini langsung di dashboard.</p>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL DISKUALIFIKASI FINAL (otomatis redirect ke hasil) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="modal-dq-final" class="fixed inset-0 z-[1000] hidden" style="background:rgba(0,0,0,0.99)">
        <div class="h-full flex flex-col items-center justify-center p-6 text-center">
            <div class="w-36 h-36 rounded-full bg-red-700 border-8 border-red-500 flex items-center justify-center mb-8 shadow-2xl shadow-red-500/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-20 h-20 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
            </div>
            <h1 class="text-5xl md:text-6xl font-black text-red-500 uppercase tracking-widest mb-4">DISKUALIFIKASI</h1>
            <p id="dq-name" class="text-white text-xl font-bold mb-2"></p>
            <p class="text-gray-400 text-base mb-8">3 pelanggaran terdeteksi. Ujian dihentikan secara otomatis oleh sistem.</p>
            <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 max-w-md w-full mb-8">
                <p class="text-gray-300 text-sm">Hasil ujian telah dikirim ke server dengan status <span class="text-red-400 font-bold">DISKUALIFIKASI</span>. Pengawas mendapat notifikasi secara langsung.</p>
            </div>
            <p class="text-gray-500 text-sm">Mengarahkan ke halaman hasil dalam <span id="dq-cd" class="text-white font-bold text-xl">5</span> detik...</p>
        </div>
    </div>

    <!-- SECTION: SELAMAT DATANG -->
    <div id="section-welcome" class="hidden-section min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden bg-slate-900">
        <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-[#0f172a] to-[#1e1b4b]"></div>
        <div class="absolute top-[-15%] left-[-10%] w-[480px] h-[480px] bg-blue-600/20 rounded-full blur-[120px] animate-pulse pointer-events-none"></div>
        <div class="absolute bottom-[-15%] right-[-10%] w-[480px] h-[480px] bg-purple-600/20 rounded-full blur-[120px] animate-pulse pointer-events-none" style="animation-delay:2s"></div>

        <div class="relative z-10 w-full max-w-lg">
            <div class="bg-white/5 backdrop-blur-2xl rounded-3xl border border-white/10 shadow-2xl overflow-hidden">

                <!-- Header strip -->
                <div class="bg-gradient-to-r from-blue-600 via-blue-500 to-indigo-600 px-8 py-7 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                    <div class="relative z-10">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-white/20 rounded-2xl mb-3 border border-white/30 shadow-lg">
                            <i data-lucide="graduation-cap" class="w-9 h-9 text-white"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white tracking-tight">Selamat Datang! üëã</h2>
                        <p class="text-blue-200 text-sm mt-1">Sistem Informasi Ujian ‚Äî SI UJIAN TKJ</p>
                    </div>
                </div>

                <div class="p-7">
                    <!-- Info peserta -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <div class="bg-white/8 border border-white/10 rounded-2xl p-4 text-center">
                            <i data-lucide="user-circle" class="w-5 h-5 text-blue-300 mx-auto mb-2"></i>
                            <p class="text-[10px] text-white/40 uppercase font-bold tracking-wider mb-1">Nama</p>
                            <p id="welcome-name" class="text-white font-bold text-xs leading-tight break-words">‚Äî</p>
                        </div>
                        <div class="bg-white/8 border border-white/10 rounded-2xl p-4 text-center">
                            <i data-lucide="hash" class="w-5 h-5 text-purple-300 mx-auto mb-2"></i>
                            <p class="text-[10px] text-white/40 uppercase font-bold tracking-wider mb-1">NISN</p>
                            <p id="welcome-nisn" class="text-white font-bold text-xs leading-tight">‚Äî</p>
                        </div>
                        <div class="bg-white/8 border border-white/10 rounded-2xl p-4 text-center">
                            <i data-lucide="school" class="w-5 h-5 text-cyan-300 mx-auto mb-2"></i>
                            <p class="text-[10px] text-white/40 uppercase font-bold tracking-wider mb-1">Kelas</p>
                            <p id="welcome-kelas" class="text-white font-bold text-xs leading-tight">‚Äî</p>
                        </div>
                    </div>

                    <!-- Narasi motivasi -->
                    <div class="bg-yellow-500/10 border border-yellow-400/20 rounded-2xl px-5 py-4 mb-6">
                        <div class="flex items-start gap-3">
                            <i data-lucide="star" class="w-5 h-5 text-yellow-300 shrink-0 mt-0.5"></i>
                            <p id="welcome-motivasi-text" class="text-yellow-100/90 text-sm leading-relaxed italic">
                                Kerjakan dengan <strong class="text-yellow-300 not-italic">jujur</strong> dan <strong class="text-yellow-300 not-italic">penuh semangat</strong>. Hasil terbaik lahir dari usaha yang sungguh-sungguh. Percayalah pada kemampuanmu ‚Äî <strong class="text-yellow-200 not-italic">sukses menantimu!</strong>
                            </p>
                        </div>
                    </div>

                    <!-- Pilih mata pelajaran -->
                    <div class="mb-6">
                        <p class="text-white/70 text-sm font-semibold mb-3 flex items-center gap-2">
                            <i data-lucide="book-open" class="w-4 h-4 text-blue-300"></i>
                            Silakan klik mata pelajaran yang akan kamu kerjakan:
                        </p>
                        <div id="welcome-paket-list" class="space-y-2 min-h-[60px]">
                            <div class="text-center py-6">
                                <i data-lucide="loader-2" class="w-6 h-6 text-white/30 animate-spin mx-auto mb-2"></i>
                                <p class="text-white/30 text-sm">Memuat daftar ujian...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Footer badges -->
                    <div class="grid grid-cols-2 gap-2 pt-5 border-t border-white/10 text-[11px] text-white/35">
                        <span class="flex items-center gap-1.5"><i data-lucide="maximize-2" class="w-3 h-3 text-blue-400"></i> Mode Layar Penuh Aktif</span>
                        <span class="flex items-center gap-1.5"><i data-lucide="shield-check" class="w-3 h-3 text-green-400"></i> Sistem Anti-Kecurangan ON</span>
                        <span class="flex items-center gap-1.5"><i data-lucide="wifi" class="w-3 h-3 text-cyan-400"></i> Koneksi Terverifikasi</span>
                        <span class="flex items-center gap-1.5"><i data-lucide="clock" class="w-3 h-3 text-yellow-400"></i> Timer mulai saat soal dibuka</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION: EXAM -->
    <div id="section-exam" class="hidden-section min-h-screen bg-slate-100 flex flex-col no-copy relative overflow-hidden">
        <header class="bg-white shadow-sm border-b sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="images/logotkj.png" onerror="this.src='https://via.placeholder.com/50?text=TKJ'" alt="Logo TKJ" class="w-10 h-10 object-contain">
                    <div>
                        <h2 class="font-bold text-gray-800" id="header-name">Nama Siswa</h2>
                        <p class="text-xs text-gray-500" id="header-detail">Kelas ‚Ä¢ Paket A (Kelas XI)</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="timer-box" class="flex items-center gap-2 px-4 py-2 rounded-lg font-mono font-bold text-lg bg-blue-50 text-blue-600">
                        <i data-lucide="clock" class="w-5 h-5"></i> <span id="timer-display">--:--</span>
                    </div>
                    <button onclick="window.toggleSidebar()" class="ml-2 p-2 rounded-lg hover:bg-slate-100 border border-slate-200 text-slate-700 flex items-center gap-2">
                        <i data-lucide="grid-3x3" class="w-5 h-5"></i> <span class="hidden md:inline text-sm font-semibold">Daftar Soal</span>
                    </button>
                </div>
            </div>
        </header>
        <main class="flex-1 w-full max-w-4xl mx-auto p-4 md:p-8 flex flex-col h-[calc(100vh-64px)] overflow-y-auto">
            <div id="question-area" class="flex-1"></div>
            <div class="mt-6 pt-4 border-t flex justify-between items-center bg-slate-100 sticky bottom-0 z-20 pb-4">
                <button id="btn-prev" onclick="window.changeQuestion(-1)" class="px-6 py-2 rounded-lg font-semibold bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="chevron-left" class="w-4 h-4 inline mr-1"></i> Sebelumnya
                </button>
                <button id="btn-next" onclick="window.changeQuestion(1)" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 shadow-sm flex items-center">
                    Selanjutnya <i data-lucide="chevron-right" class="w-4 h-4 inline ml-1"></i>
                </button>
                 <button id="btn-finish-main" onclick="window.confirmFinishExam()" class="hidden px-6 py-2 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-700 shadow-sm flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-4 h-4"></i> Selesai
                </button>
            </div>
        </main>
        <div id="exam-sidebar" class="fixed top-16 right-0 bottom-0 w-80 bg-white shadow-2xl border-l border-slate-200 z-40 sidebar-closed flex flex-col">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">Navigasi Soal</h3>
                <button onclick="window.toggleSidebar()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div id="question-grid" class="grid grid-cols-5 gap-3"></div>
            </div>
            <div class="p-4 border-t bg-slate-50">
                <div class="flex gap-2 text-xs mb-4 justify-center">
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-500 rounded-full"></div> Dijawab</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-slate-200 border rounded-full"></div> Belum</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 border-2 border-blue-500 rounded-full"></div> Aktif</div>
                </div>
                <button onclick="window.confirmFinishExam()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow flex items-center justify-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Hentikan Ujian
                </button>
            </div>
        </div>
        <div id="sidebar-overlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/20 z-30 hidden" style="top: 64px;"></div>
    </div>

    <!-- MODAL CONFIRMATION -->
    <div id="modal-confirm" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-90 transition-transform duration-300" id="modal-content">
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Selesai Ujian?</h3>
                <p class="text-gray-500 text-sm mb-6" id="modal-desc">Waktu masih ada. Apakah Anda yakin ingin mengakhiri ujian ini sekarang?</p>
                <div class="flex gap-3">
                    <button onclick="window.closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition-colors">Batal</button>
                    <button onclick="window.finalFinish()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all active:scale-95">Ya, Selesai</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ADD/EDIT QUESTION (REDESIGNED) -->
    <div id="modal-question" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-y-auto max-h-[94vh] flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50 rounded-t-2xl shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded-lg"><i data-lucide="file-edit" class="w-5 h-5 text-blue-600"></i></div>
                    <div>
                        <h3 id="modal-q-title" class="text-base font-bold text-gray-800">Tambah Soal Baru</h3>
                        <p id="modal-q-subtitle" class="text-xs text-gray-500">Dalam paket: <span id="modal-q-paket-label" class="font-semibold text-blue-600">‚Äî</span></p>
                    </div>
                </div>
                <button onclick="window.closeQuestionModal()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <form id="form-question" onsubmit="window.saveQuestionSubmit(event)" class="flex-1 overflow-y-auto">
                <input type="hidden" id="q-id">
                <input type="hidden" id="q-packet">

                <div class="px-6 py-5 space-y-5">

                    <!-- SECTION 1: STATUS & KUNCI -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Status aktif -->
                        <div class="bg-gray-50 rounded-xl border p-4">
                            <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3 flex items-center gap-1.5">
                                <i data-lucide="eye" class="w-3.5 h-3.5"></i> Status Soal
                            </p>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <div class="relative shrink-0">
                                    <input type="checkbox" id="q-aktif" class="sr-only peer" checked>
                                    <div class="w-12 h-6 bg-gray-300 rounded-full peer peer-checked:bg-green-500 transition-colors"></div>
                                    <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform peer-checked:translate-x-6"></div>
                                </div>
                                <span id="q-aktif-label" class="text-sm font-bold text-green-600">Aktif</span>
                            </label>
                            <p class="text-xs text-gray-400 mt-2">Soal nonaktif tidak muncul di ujian siswa.</p>
                        </div>
                        <!-- Kunci jawaban -->
                        <div class="bg-gray-50 rounded-xl border p-4">
                            <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3 flex items-center gap-1.5">
                                <i data-lucide="check-square" class="w-3.5 h-3.5"></i> Kunci Jawaban
                            </p>
                            <select id="q-correct" class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-sm font-semibold bg-white" required>
                                <option value="0">A (Pilihan ke-1)</option>
                                <option value="1">B (Pilihan ke-2)</option>
                                <option value="2">C (Pilihan ke-3)</option>
                                <option value="3">D (Pilihan ke-4)</option>
                                <option value="4">E (Pilihan ke-5)</option>
                            </select>
                            <p class="text-xs text-gray-400 mt-2">Pilih jawaban yang benar.</p>
                        </div>
                    </div>

                    <!-- SECTION 2: PERTANYAAN -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 flex items-center gap-1.5">
                            <i data-lucide="message-square" class="w-3.5 h-3.5"></i> Teks Pertanyaan
                        </label>
                        <textarea id="q-text" rows="4" class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm resize-none bg-gray-50 focus:bg-white transition-colors" placeholder="Tulis pertanyaan di sini... Boleh dikosongkan jika soal hanya berupa gambar."></textarea>
                    </div>

                    <!-- SECTION 3: GAMBAR SOAL -->
                    <div class="border rounded-xl overflow-hidden">
                        <div class="bg-blue-50 px-4 py-2.5 border-b flex items-center justify-between">
                            <span class="text-xs font-bold text-blue-800 flex items-center gap-1.5"><i data-lucide="image" class="w-3.5 h-3.5"></i> Gambar Soal <span class="font-normal text-blue-500">(Opsional)</span></span>
                            <div class="flex gap-1">
                                <button type="button" onclick="window.switchImgTab('q','url')" id="q-img-tab-url" class="px-2.5 py-1 text-xs font-bold rounded-lg bg-blue-600 text-white">üîó URL</button>
                                <button type="button" onclick="window.switchImgTab('q','upload')" id="q-img-tab-upload" class="px-2.5 py-1 text-xs font-bold rounded-lg bg-white text-blue-600 border border-blue-200">üìÅ Upload</button>
                            </div>
                        </div>
                        <div class="p-4">
                            <div id="q-img-panel-url">
                                <input type="text" id="q-image-url" placeholder="Paste URL gambar atau link Google Drive..." class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-white" oninput="window.previewImg('q', this.value)">
                                <p class="text-xs text-blue-500 mt-1.5">üí° Google Drive: klik kanan ‚Üí Bagikan ‚Üí Salin link ‚Üí paste di sini</p>
                            </div>
                            <div id="q-img-panel-upload" class="hidden">
                                <div class="border-2 border-dashed border-blue-300 rounded-lg p-5 text-center cursor-pointer hover:bg-blue-50" onclick="document.getElementById('q-img-file').click()">
                                    <i data-lucide="upload-cloud" class="w-6 h-6 text-blue-400 mx-auto mb-1.5"></i>
                                    <p class="text-xs text-blue-600 font-medium">Klik untuk pilih gambar</p>
                                    <p class="text-xs text-blue-400">JPG, PNG, GIF ‚Äì maks 800KB</p>
                                </div>
                                <input type="file" id="q-img-file" accept="image/*" class="hidden" onchange="window.handleImgUpload('q', this)">
                            </div>
                            <input type="hidden" id="q-image-data">
                            <div id="q-img-preview" class="hidden mt-3 flex items-center gap-3">
                                <img id="q-img-preview-img" src="" class="max-h-32 rounded-lg border object-contain bg-white">
                                <button type="button" onclick="window.clearImg('q')" class="text-xs text-red-500 hover:underline flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> Hapus</button>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 4: PILIHAN JAWABAN -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide flex items-center gap-1.5">
                                <i data-lucide="list" class="w-3.5 h-3.5"></i> Pilihan Jawaban
                            </label>
                            <button type="button" onclick="window.addOptionInput()" class="text-xs text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1 bg-blue-50 hover:bg-blue-100 px-2.5 py-1.5 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-3.5 h-3.5"></i> Tambah Opsi
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mb-3">Teks boleh kosong jika pilihan berupa gambar saja. Pastikan kunci jawaban sudah dipilih di atas.</p>
                        <div id="q-options-container" class="space-y-2"></div>
                    </div>

                </div>

                <!-- Footer Actions -->
                <div class="flex justify-end gap-3 px-6 py-4 border-t bg-gray-50 rounded-b-2xl shrink-0">
                    <button type="button" onclick="window.closeQuestionModal()" class="px-5 py-2.5 border rounded-xl text-gray-700 hover:bg-gray-100 text-sm font-semibold transition-colors">Batal</button>
                    <button type="submit" class="px-6 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold text-sm flex items-center gap-2 shadow-md active:scale-95 transition-all">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan Soal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL BUAT / EDIT PAKET SOAL -->
    <div id="modal-paket" class="fixed inset-0 z-50 flex items-start justify-center bg-black/60 backdrop-blur-sm hidden overflow-y-auto py-6 px-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg my-auto">
            <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50 rounded-t-2xl sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-100 p-2 rounded-lg"><i data-lucide="layers" class="w-5 h-5 text-indigo-600"></i></div>
                    <h3 id="modal-paket-title" class="text-base font-bold text-gray-800">Buat Paket Soal Baru</h3>
                </div>
                <button onclick="window.closePaketModal()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="form-paket" onsubmit="window.savePaket(event)" class="p-6 pb-8 space-y-4">
                <input type="hidden" id="paket-id">
                <!-- Nama Paket -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Nama Paket <span class="text-red-500">*</span></label>
                    <input type="text" id="paket-nama" placeholder="Contoh: Informatika Kelas X" required class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 text-sm bg-gray-50 focus:bg-white transition-colors font-medium">
                    <p class="text-xs text-gray-400 mt-1">Nama mata pelajaran dan kelas, misal "Informatika Kelas XI TKJ 1".</p>
                </div>
                <!-- Mata Pelajaran / Keterangan -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Mata Pelajaran / Keterangan</label>
                    <input type="text" id="paket-mapel" placeholder="Contoh: Ujian Tengah Semester Genap 2025" class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 text-sm bg-gray-50 focus:bg-white transition-colors">
                </div>
                <!-- Jenis Paket -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Jenis Paket</label>
                    <div class="flex flex-wrap gap-2" id="paket-jenis-options">
                        <label class="paket-jenis-label cursor-pointer">
                            <input type="radio" name="paket-jenis" value="nonpaket" class="sr-only" checked>
                            <span class="paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold border-indigo-500 bg-indigo-50 text-indigo-700">Non Paket</span>
                        </label>
                        <label class="paket-jenis-label cursor-pointer">
                            <input type="radio" name="paket-jenis" value="A" class="sr-only">
                            <span class="paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold border-gray-200 bg-white text-gray-500">Paket A</span>
                        </label>
                        <label class="paket-jenis-label cursor-pointer">
                            <input type="radio" name="paket-jenis" value="B" class="sr-only">
                            <span class="paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold border-gray-200 bg-white text-gray-500">Paket B</span>
                        </label>
                        <label class="paket-jenis-label cursor-pointer">
                            <input type="radio" name="paket-jenis" value="C" class="sr-only">
                            <span class="paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold border-gray-200 bg-white text-gray-500">Paket C</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-400 mt-1.5">Paket A/B/C jika soal dibagi grup. Non Paket jika semua siswa mengerjakan soal yang sama.</p>
                </div>
                <!-- Kelas -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Kelas yang Mengerjakan</label>
                    <div id="paket-kelas-checks" class="flex flex-wrap gap-2">
                        <span class="text-xs text-gray-400 italic">Memuat daftar kelas...</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1.5">Kosongkan = semua kelas bisa mengerjakan paket ini.</p>
                </div>
                <!-- Token -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5 flex items-center gap-1.5">
                        <i data-lucide="key" class="w-4 h-4 text-yellow-500"></i> Token Akses Paket <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="paket-token" placeholder="Contoh: INFO2025" required class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-yellow-400 text-sm font-mono uppercase bg-yellow-50 focus:bg-yellow-50 tracking-widest font-bold">
                    <p class="text-xs text-gray-400 mt-1">Siswa harus memasukkan token ini untuk bisa memulai ujian paket ini.</p>
                </div>
                <!-- Status -->
                <div class="flex items-center justify-between bg-gray-50 rounded-xl border px-4 py-3">
                    <div>
                        <p class="text-sm font-semibold text-gray-700">Status Paket</p>
                        <p class="text-xs text-gray-400">Paket nonaktif tidak bisa dikerjakan siswa.</p>
                    </div>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="paket-aktif" class="sr-only peer" checked>
                            <div class="w-12 h-6 bg-gray-300 rounded-full peer peer-checked:bg-green-500 transition-colors"></div>
                            <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform peer-checked:translate-x-6"></div>
                        </div>
                        <span id="paket-aktif-label" class="text-sm font-bold text-green-600">Aktif</span>
                    </label>
                </div>

                <div class="flex justify-end gap-3 pt-2 border-t">
                    <button type="button" onclick="window.closePaketModal()" class="px-5 py-2.5 border rounded-xl text-gray-700 hover:bg-gray-100 text-sm font-semibold">Batal</button>
                    <button type="submit" class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold text-sm flex items-center gap-2 shadow-md">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan Paket
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL: KELOLA SESI UJIAN -->
    <div id="modal-sesi" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 animate-fade-in max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50 rounded-t-2xl shrink-0">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="layers" class="w-5 h-5 text-indigo-600"></i> Manajemen Sesi Ujian
                </h3>
                <button onclick="window.closeSesiModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Info cara kerja -->
                <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4 mb-5 text-sm text-indigo-800">
                    <strong>üí° Cara kerja Sesi:</strong> Setiap sesi ujian (misal: Sesi 1 pukul 08.00, Sesi 2 pukul 10.00) punya ID unik. Siswa hanya muncul di sesi yang aktif saat mereka login. Data sesi lama tetap tersimpan sebagai histori dan bisa dilihat kapan saja dengan filter "Semua Sesi".
                </div>

                <!-- Buat Sesi Baru -->
                <div class="bg-white border-2 border-dashed border-indigo-300 rounded-xl p-5 mb-5">
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4 text-indigo-600"></i> Buat Sesi Baru & Jadikan Aktif</h4>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Nama Sesi <span class="text-red-500">*</span></label>
                            <input type="text" id="new-sesi-nama" placeholder="Contoh: Sesi 1 - Senin 08.00" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Keterangan (Opsional)</label>
                            <input type="text" id="new-sesi-ket" placeholder="Contoh: Kelas XI TKJ 1 & 2" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                        </div>
                    </div>
                    <button onclick="window.createAndActivateSesi()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-md active:scale-95 transition-all">
                        <i data-lucide="zap" class="w-4 h-4"></i> Buat & Aktifkan Sesi Ini
                    </button>
                    <p class="text-xs text-gray-400 mt-2">‚ö†Ô∏è Mengaktifkan sesi baru akan menyebabkan siswa yang login berikutnya masuk ke sesi ini. Data sesi sebelumnya tidak terhapus.</p>
                </div>

                <!-- Daftar Sesi -->
                <div>
                    <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i data-lucide="history" class="w-4 h-4 text-gray-500"></i> Semua Sesi
                    </h4>
                    <div id="sesi-list-container" class="space-y-2">
                        <p class="text-sm text-gray-400 text-center py-4">Memuat daftar sesi...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CHEATING ALERT -->
    <div id="modal-cheat-alert" class="fixed inset-0 z-[60] flex items-center justify-center bg-red-900/90 backdrop-blur-sm hidden animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 text-center border-4 border-red-600 relative overflow-hidden">
            <!-- Background pulse effect -->
            <div class="absolute inset-0 bg-red-50 animate-pulse -z-10"></div>
            
            <div class="w-24 h-24 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-red-200">
                <i data-lucide="siren" class="w-12 h-12 animate-bounce"></i>
            </div>
            
            <h2 class="text-3xl font-extrabold text-red-700 mb-2 uppercase tracking-wider">PERINGATAN BAHAYA!</h2>
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="cheat-student-name">Nama Siswa</h3>
            
            <div class="bg-red-100 border border-red-200 p-4 rounded-xl mb-6">
                <p class="text-red-800 font-semibold text-lg" id="cheat-message">Terdeteksi melakukan kecurangan!</p>
                <div class="mt-2 text-sm text-red-600">
                    Status: <span id="cheat-status" class="font-bold">DISKUALIFIKASI</span> | 
                    Pelanggaran: <span id="cheat-count" class="font-bold">3x</span>
                </div>
            </div>
            
            <button onclick="window.closeCheatAlert()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-red-500/50 transition-all active:scale-95 text-lg uppercase tracking-wide">
                MENGERTI & TUTUP
            </button>
        </div>
    </div>
    
    <!-- MODAL VIOLATION DETAILS (NEW) -->
    <div id="modal-violation-details" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-red-600 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i> Detail Pelanggaran
                </h3>
                <button onclick="document.getElementById('modal-violation-details').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">Siswa: <span id="violation-student-name" class="font-bold text-gray-800">Nama Siswa</span></p>
                <div class="bg-red-50 p-2 rounded text-xs text-red-600 mb-2 border border-red-100 flex items-start gap-2">
                    <i data-lucide="info" class="w-4 h-4 shrink-0 mt-0.5"></i>
                    <span>Log ini mencatat waktu dan alasan sistem mendeteksi ketidakjujuran selama ujian berlangsung.</span>
                </div>
                <div id="violation-list" class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                    <!-- Logs go here -->
                </div>
            </div>
            <div class="flex justify-end">
                <button onclick="document.getElementById('modal-violation-details').classList.add('hidden')" class="px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-bold shadow hover:bg-gray-900">Tutup</button>
            </div>
        </div>
    </div>

    <!-- SECTION: DASHBOARD GURU -->
    <div id="section-dashboard" class="hidden-section min-h-screen bg-slate-50 flex flex-col">
        <header class="bg-slate-900 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="dash-header-icon" class="bg-blue-500 p-2 rounded-lg"><i data-lucide="monitor" class="w-6 h-6 text-white"></i></div>
                    <div>
                        <h1 id="dash-header-title" class="font-bold text-lg">Panel Guru / Admin</h1>
                        <p id="dash-header-subtitle" class="text-xs text-slate-400">Monitoring & Bank Soal</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div id="pengawas-room-badge" class="hidden items-center gap-2 bg-amber-500/20 border border-amber-400/30 px-3 py-1.5 rounded-full">
                        <i data-lucide="door-open" class="w-4 h-4 text-amber-300"></i>
                        <span id="pengawas-room-label" class="text-sm font-bold text-amber-200">Ruang 1</span>
                    </div>
                    <button onclick="window.logout()" class="text-slate-300 hover:text-white flex items-center gap-2 text-sm"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar</button>
                </div>
            </div>
        </header>
        <main class="flex-1 max-w-7xl mx-auto w-full p-6">
            
            <!-- TABS DASHBOARD -->
            <div class="flex gap-4 mb-6 border-b overflow-x-auto">
                <button onclick="window.switchDashTab('nilai')" id="tab-dash-nilai" class="pb-3 border-b-2 border-blue-600 font-bold text-blue-600 px-4 whitespace-nowrap flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Monitoring Nilai
                </button>
                <button onclick="window.switchDashTab('kelas')" id="tab-dash-kelas" class="pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-bold px-4 whitespace-nowrap flex items-center gap-2">
                    <i data-lucide="school" class="w-4 h-4"></i> Manajemen Kelas
                </button>
                <button onclick="window.switchDashTab('soal')" id="tab-dash-soal" class="pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-bold px-4 whitespace-nowrap flex items-center gap-2">
                    <i data-lucide="layers" class="w-4 h-4"></i> Manajemen Soal
                </button>
                <button onclick="window.switchDashTab('ruang')" id="tab-dash-ruang" class="admin-only-tab pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-bold px-4 whitespace-nowrap flex items-center gap-2">
                    <i data-lucide="door-open" class="w-4 h-4"></i> Manajemen Ruang
                </button>
                <button onclick="window.switchDashTab('tampilan')" id="tab-dash-tampilan" class="admin-only-tab pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-bold px-4 whitespace-nowrap flex items-center gap-2">
                    <i data-lucide="palette" class="w-4 h-4"></i> Setting Tampilan
                </button>
            </div>

            <!-- PANEL 1: MONITORING NILAI -->
            <div id="panel-nilai">
                <!-- MODIFIED: PENGATURAN TOKEN DAN DURASI -->
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-gray-600"></i> Pengaturan Ujian</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                        <!-- Input Token -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Token Akses</label>
                            <div class="flex gap-2">
                                <div class="bg-blue-50 p-2 rounded border border-blue-200 flex items-center justify-center">
                                    <i data-lucide="key" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <input type="text" id="teacher-token-input" class="w-full px-4 py-2 border rounded-lg font-mono text-xl font-bold tracking-widest text-center uppercase text-blue-600 bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="LOADING..." value="TKJ2025">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Token wajib diisi siswa untuk login.</p>
                        </div>
                        
                        <!-- Input Durasi -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Durasi Ujian (Menit)</label>
                            <div class="flex gap-2">
                                <div class="bg-orange-50 p-2 rounded border border-orange-200 flex items-center justify-center">
                                    <i data-lucide="clock" class="w-5 h-5 text-orange-600"></i>
                                </div>
                                <input type="number" id="teacher-duration-input" min="1" class="w-full px-4 py-2 border rounded-lg font-bold text-center text-orange-600 bg-gray-50 focus:ring-2 focus:ring-orange-500 outline-none" placeholder="60" value="60">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Waktu hitung mundur otomatis.</p>
                        </div>
                        
                        <!-- Input Min Duration -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Min. Submit (Menit)</label>
                            <div class="flex gap-2">
                                <div class="bg-red-50 p-2 rounded border border-red-200 flex items-center justify-center">
                                    <i data-lucide="hourglass" class="w-5 h-5 text-red-600"></i>
                                </div>
                                <input type="number" id="teacher-min-duration-input" min="0" class="w-full px-4 py-2 border rounded-lg font-bold text-center text-red-600 bg-gray-50 focus:ring-2 focus:ring-red-500 outline-none" placeholder="0" value="0">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Siswa tidak bisa submit sebelum waktu ini.</p>
                        </div>

                        <!-- Cooldown Device - MENIT -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cooldown Device <span class="text-purple-500 font-semibold">(Menit)</span></label>
                            <div class="flex gap-2">
                                <div class="bg-purple-50 p-2 rounded border border-purple-200 flex items-center justify-center">
                                    <i data-lucide="shield-alert" class="w-5 h-5 text-purple-600"></i>
                                </div>
                                <input type="number" id="teacher-cooldown-input" min="10" step="5" class="w-full px-4 py-2 border rounded-lg font-bold text-center text-purple-600 bg-gray-50 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="30" value="30">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Min. 10 menit. Perangkat terkunci setelah ujian selesai.</p>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                         <button onclick="window.saveSettings()" class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-2 rounded-lg font-bold shadow-md active:scale-95 transition-transform flex items-center gap-2">
                             <i data-lucide="save" class="w-4 h-4"></i> Simpan Pengaturan
                         </button>
                    </div>
                </div>

                <!-- ‚ïê‚ïê STAT CARDS ‚ïê‚ïê -->
                <div id="stat-cards-area" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-8 gap-3 mb-6">
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center shrink-0">
                            <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Total Peserta</p>
                            <p id="sc-total" class="text-2xl font-black text-gray-800">0</p>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center shrink-0">
                            <i data-lucide="check-circle-2" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Selesai</p>
                            <div class="flex items-baseline gap-2">
                                <p id="sc-selesai" class="text-2xl font-black text-green-600">0</p>
                                <p id="sc-selesai-pct" class="text-sm font-bold text-green-400">0%</p>
                            </div>
                            <div class="h-1.5 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                                <div id="sc-bar-selesai" class="h-full bg-green-500 rounded-full transition-all duration-700" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-sky-100 flex items-center justify-center shrink-0">
                            <i data-lucide="loader-2" class="w-6 h-6 text-sky-600 animate-spin"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Sedang Ujian</p>
                            <div class="flex items-baseline gap-2">
                                <p id="sc-ongoing" class="text-2xl font-black text-sky-600">0</p>
                                <p id="sc-ongoing-pct" class="text-sm font-bold text-sky-400">0%</p>
                            </div>
                            <div class="h-1.5 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                                <div id="sc-bar-ongoing" class="h-full bg-sky-400 rounded-full transition-all duration-700" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center shrink-0">
                            <i data-lucide="shield-x" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Curang / DQ</p>
                            <div class="flex items-baseline gap-2">
                                <p id="sc-dq" class="text-2xl font-black text-red-600">0</p>
                                <p id="sc-dq-pct" class="text-sm font-bold text-red-400">0%</p>
                            </div>
                            <div class="h-1.5 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                                <div id="sc-bar-dq" class="h-full bg-red-500 rounded-full transition-all duration-700" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-yellow-100 flex items-center justify-center shrink-0">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Ada Pelanggaran</p>
                            <div class="flex items-baseline gap-2">
                                <p id="sc-violations" class="text-2xl font-black text-yellow-600">0</p>
                                <p id="sc-violations-pct" class="text-sm font-bold text-yellow-400">0%</p>
                            </div>
                            <div class="h-1.5 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                                <div id="sc-bar-violations" class="h-full bg-yellow-400 rounded-full transition-all duration-700" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center shrink-0">
                            <i data-lucide="bar-chart-3" class="w-6 h-6 text-purple-600"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Rata-rata Nilai</p>
                            <p id="sc-avg" class="text-2xl font-black text-purple-600">‚Äî</p>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center shrink-0">
                            <i data-lucide="trending-up" class="w-6 h-6 text-emerald-600"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Lulus (‚â•75)</p>
                            <div class="flex items-baseline gap-2">
                                <p id="sc-lulus" class="text-2xl font-black text-emerald-600">0</p>
                                <p id="sc-lulus-pct" class="text-sm font-bold text-emerald-400">0%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <div class="p-6 border-b flex flex-col gap-4">
                        <div class="flex justify-between items-center flex-wrap gap-3">
                            <div class="flex items-center gap-3 flex-wrap">
                                <h2 class="text-lg font-bold text-gray-800">Data Hasil Ujian</h2>
                                <!-- SESI BADGE -->
                                <span id="active-sesi-badge" class="hidden items-center gap-1.5 bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold border border-indigo-200">
                                    <i data-lucide="layers" class="w-3 h-3"></i>
                                    <span id="active-sesi-label">Sesi Aktif</span>
                                </span>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="window.openSesiModal()" class="admin-only-el bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm">
                                    <i data-lucide="layers" class="w-4 h-4"></i> Kelola Sesi
                                </button>
                                <button id="btn-reset-all" onclick="window.resetAllExamData()" class="admin-only-el bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm transition hover:scale-105"><i data-lucide="trash-2" class="w-4 h-4"></i> Reset Sesi Ini</button>
                                <button onclick="window.exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-md transition hover:scale-105 hover:shadow-emerald-500/30">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Export Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">üìÖ Sesi Ujian</label>
                                <select id="filter-sesi" onchange="if(window._pg)window._pg.monitoring.page=1; window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option value="active">Sesi Aktif</option>
                                    <option value="all">Semua Sesi (History)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Ruang Ujian</label>
                                <select id="filter-ruang" onchange="if(window._pg)window._pg.monitoring.page=1; window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="all">Semua Ruang</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Paket Soal</label>
                                <select id="filter-session" onchange="if(window._pg)window._pg.monitoring.page=1; window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="all">Semua Paket</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Kelas</label>
                                <select id="filter-class" onchange="if(window._pg)window._pg.monitoring.page=1; window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="all">Semua Kelas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Tanggal</label>
                                <input type="date" id="filter-date" onchange="if(window._pg)window._pg.monitoring.page=1; window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-900 font-semibold border-b sticky top-0 z-10">
                                    <th class="px-6 py-4">Nama Siswa</th>
									<th class="px-6 py-4">NISN</th>
                                    <th class="px-6 py-4">Kelas</th>
                                    <th class="px-6 py-4">Ruang</th>
                                    <th class="px-6 py-4">Paket</th>
                                    <th class="px-6 py-4 text-center">Nilai</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-center">Pelanggaran</th>
                                    <th class="px-6 py-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="10" class="px-6 py-12 text-center text-gray-400">Menunggu data ujian...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="pager-monitoring-wrap"></div>
                </div>
            </div>

            <!-- PANEL 2: MANAJEMEN SOAL (BANK SOAL) -->
            <!-- PANEL 2: BANK SOAL (REDESIGNED) -->
            <!-- PANEL 2: MANAJEMEN SOAL (REDESIGNED - PAKET FIRST) -->
            <div id="panel-soal" class="hidden-section">
                
                <!-- STEP 1: DAFTAR PAKET SOAL -->
                <div id="view-paket-list">
                    <!-- Info Banner -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-5 mb-5 text-white shadow-lg">
                        <div class="flex items-start gap-4">
                            <div class="bg-white/20 p-3 rounded-xl shrink-0">
                                <i data-lucide="layers" class="w-7 h-7"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold mb-1">Manajemen Soal</h2>
                                <p class="text-blue-100 text-sm leading-relaxed">
                                    <strong class="text-white">Cara kerja:</strong> Buat <strong class="text-white">Paket Soal</strong> terlebih dahulu (contoh: "Informatika Kelas X"), lalu masukkan soal-soal ke dalam paket tersebut. Setiap paket memiliki token akses, kelas, dan pengaturan sendiri.
                                </p>
                                <div class="flex flex-wrap gap-3 mt-3 text-xs">
                                    <span class="bg-white/20 px-3 py-1 rounded-full flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> 1. Buat Paket Soal</span>
                                    <span class="text-blue-300">‚Üí</span>
                                    <span class="bg-white/20 px-3 py-1 rounded-full flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> 2. Klik "Kelola Soal"</span>
                                    <span class="text-blue-300">‚Üí</span>
                                    <span class="bg-white/20 px-3 py-1 rounded-full flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> 3. Tambah / Import Soal</span>
                                </div>
                                <!-- Download template - langsung di sini -->
                                <div class="mt-4 pt-4 border-t border-white/20 flex flex-wrap items-center gap-3">
                                    <span class="text-white/80 text-xs font-semibold flex items-center gap-1.5"><i data-lucide="download" class="w-3.5 h-3.5"></i> Download Template Import Soal:</span>
                                    <button onclick="window.downloadExcelTemplate()" type="button" class="flex items-center gap-1.5 bg-white/20 hover:bg-white/30 text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-colors border border-white/30">
                                        <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i> Excel (.xlsx)
                                    </button>
                                    <button onclick="window.downloadWordTemplate()" type="button" class="flex items-center gap-1.5 bg-white/20 hover:bg-white/30 text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-colors border border-white/30">
                                        <i data-lucide="file-text" class="w-3.5 h-3.5"></i> Word (.docx)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Header + Tombol Buat Paket -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Daftar Paket Soal</h3>
                            <p id="paket-count-info" class="text-sm text-gray-500">Memuat paket...</p>
                        </div>
                        <button onclick="window.openPaketModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 shadow-md active:scale-95 transition-all">
                            <i data-lucide="plus" class="w-4 h-4"></i> Buat Paket Soal Baru
                        </button>
                    </div>

                    <!-- Grid Paket -->
                    <div id="paket-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 pr-1">
                        <div class="col-span-full bg-white rounded-2xl border p-10 text-center shadow-sm">
                            <i data-lucide="loader-2" class="w-8 h-8 mx-auto mb-3 text-blue-400 animate-spin"></i>
                            <p class="text-gray-400 text-sm">Memuat paket soal...</p>
                        </div>
                    </div>
                    <div id="pager-paket-wrap" class="mt-2"></div>

                    <!-- Tombol seed legacy -->
                    <div class="mt-4 border-t pt-4">
                        <button id="btn-seed-db" onclick="window.seedDatabase()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload Soal Bawaan ke DB (+ Buat Paket A/B/C)
                        </button>
                    </div>
                </div>

                <!-- STEP 2: DETAIL SOAL DALAM PAKET (hidden by default) -->
                <div id="view-soal-in-paket" class="hidden">
                    <!-- Breadcrumb / Back -->
                    <div class="flex items-center gap-2 mb-4">
                        <button onclick="window.backToPaketList()" class="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-semibold text-sm bg-blue-50 hover:bg-blue-100 px-3 py-2 rounded-lg transition-colors">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Daftar Paket
                        </button>
                        <span class="text-gray-400">/</span>
                        <span id="breadcrumb-paket-nama" class="text-gray-700 font-semibold text-sm"></span>
                    </div>

                    <!-- Info Paket Aktif -->
                    <div id="active-paket-info-card" class="bg-white rounded-2xl border shadow-sm p-5 mb-5">
                        <div class="flex flex-col md:flex-row justify-between gap-4">
                            <div class="flex items-start gap-4">
                                <div id="active-paket-icon" class="w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold text-lg shrink-0 bg-blue-500">A</div>
                                <div>
                                    <h3 id="active-paket-nama" class="text-lg font-bold text-gray-800">Nama Paket</h3>
                                    <p id="active-paket-mapel" class="text-sm text-gray-500"></p>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <span class="bg-yellow-100 text-yellow-700 px-2.5 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                            <i data-lucide="key" class="w-3 h-3"></i> Token: <span id="active-paket-token">-</span>
                                        </span>
                                        <span id="active-paket-kelas-tags" class="flex flex-wrap gap-1"></span>
                                        <span id="active-paket-status-badge" class="px-2.5 py-1 rounded-full text-xs font-bold"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 shrink-0">
                                <button onclick="window.openPaketModal(window.activePaketId)" class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-xl text-sm font-medium flex items-center gap-2">
                                    <i data-lucide="settings" class="w-4 h-4"></i> Edit Paket
                                </button>
                                <button onclick="window.openQuestionModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-sm">
                                    <i data-lucide="plus" class="w-4 h-4"></i> Tambah Soal
                                </button>
                                <button onclick="window.toggleImportSection()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-sm">
                                    <i data-lucide="upload" class="w-4 h-4"></i> Import Soal
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filter & Search di dalam paket -->
                    <div class="bg-white rounded-xl border shadow-sm p-4 mb-4">
                        <div class="flex flex-wrap gap-3 items-end">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Cari Soal</label>
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input type="text" id="search-bank-soal" oninput="if(window._pg)window._pg.soal.page=1; window.filterQuestionBank()" placeholder="Ketik kata kunci soal..." class="w-full pl-9 pr-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Status</label>
                                <select id="filter-bank-status" onchange="if(window._pg)window._pg.soal.page=1; window.filterQuestionBank()" class="px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="all">Semua Status</option>
                                    <option value="aktif">Aktif</option>
                                    <option value="nonaktif">Nonaktif</option>
                                </select>
                            </div>
                            <div class="flex gap-2 items-center text-xs text-gray-500 bg-gray-50 px-3 py-2 rounded-lg border">
                                <span id="stat-total" class="font-semibold text-gray-700">Total: 0</span>
                                <span>‚Ä¢</span>
                                <span id="stat-aktif" class="text-green-600 font-semibold">Aktif: 0</span>
                                <span>‚Ä¢</span>
                                <span id="stat-nonaktif" class="text-red-500 font-semibold">Nonaktif: 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Soal List -->
                    <div id="bank-soal-list" class="space-y-3 pr-1">
                        <div class="bg-white rounded-xl p-8 text-center text-gray-400 border shadow-sm">
                            <i data-lucide="loader-2" class="w-8 h-8 mx-auto mb-2 animate-spin text-blue-400"></i>
                            <p>Memuat soal...</p>
                        </div>
                    </div>
                    <div id="pager-soal-wrap" class="mt-2"></div>

                    <!-- SECTION IMPORT (inline, collapsible) -->
                    <div id="section-import-inline" class="hidden mt-6 space-y-4">
                        <!-- Header -->
                        <div class="flex items-center justify-between">
                            <h3 class="text-base font-bold text-gray-700 flex items-center gap-2">
                                <i data-lucide="upload-cloud" class="w-5 h-5 text-green-600"></i> Import Soal ke Paket Ini
                            </h3>
                            <button onclick="window.toggleImportSection()" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-100">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <!-- Format info -->
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-sm text-blue-800">
                            <div class="flex items-start gap-2">
                                <i data-lucide="info" class="w-4 h-4 mt-0.5 shrink-0 text-blue-500"></i>
                                <div>
                                    <p class="font-bold mb-1">Format kolom yang diperlukan:</p>
                                    <div class="font-mono text-xs bg-white/70 p-2 rounded border border-blue-100 overflow-x-auto whitespace-nowrap">
                                        <span class="text-purple-700 font-bold">question</span> | <span class="text-green-700 font-bold">question_image</span> | <span class="text-orange-700 font-bold">option_a</span> | <span class="text-green-600 font-bold">image_a</span> | <span class="text-orange-700 font-bold">option_b</span> | ... | <span class="text-red-700 font-bold">correct</span>
                                    </div>
                                    <div class="mt-2 grid grid-cols-2 gap-1 text-xs">
                                        <span>‚úÖ <strong>correct</strong>: huruf A/B/C/D/E</span>
                                        <span>üñºÔ∏è image_*: URL Google Drive (opsional)</span>
                                    </div>
                                    <div class="mt-3 flex gap-2 flex-wrap">
                                        <span class="text-xs text-blue-600 font-semibold">Download template:</span>
                                        <button onclick="window.downloadExcelTemplate()" type="button" class="flex items-center gap-1 bg-green-600 hover:bg-green-700 text-white text-xs font-bold px-2.5 py-1 rounded-lg">
                                            <i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Excel
                                        </button>
                                        <button onclick="window.downloadWordTemplate()" type="button" class="flex items-center gap-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-2.5 py-1 rounded-lg">
                                            <i data-lucide="file-text" class="w-3 h-3"></i> Word
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Import Excel -->
                        <div class="bg-white rounded-xl border shadow-sm p-5">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-emerald-100 p-2 rounded-lg"><i data-lucide="file-spreadsheet" class="w-5 h-5 text-emerald-600"></i></div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Import dari Excel (.xlsx / .xls)</h4>
                                    <p class="text-xs text-gray-500">Upload file Excel yang sudah diisi sesuai template.</p>
                                </div>
                            </div>
                            <div id="excel-drop-zone"
                                 ondragover="event.preventDefault(); this.classList.add('border-green-500','bg-green-50')"
                                 ondragleave="this.classList.remove('border-green-500','bg-green-50')"
                                 ondrop="window.handleExcelDrop(event)"
                                 class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-green-400 hover:bg-green-50/50 transition-all"
                                 onclick="document.getElementById('excel-file-input').click()">
                                <i data-lucide="upload-cloud" class="w-10 h-10 text-gray-400 mx-auto mb-2"></i>
                                <p class="font-semibold text-gray-600 text-sm">Klik atau drag & drop file Excel</p>
                                <p class="text-xs text-gray-400 mt-1">Mendukung .xlsx dan .xls</p>
                                <input type="file" id="excel-file-input" accept=".xlsx,.xls" class="hidden" onchange="window.handleExcelFile(this.files[0])">
                            </div>
                            <div id="excel-preview" class="hidden mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h5 class="font-bold text-gray-700 text-sm flex items-center gap-2">
                                        <i data-lucide="eye" class="w-4 h-4 text-green-600"></i> Preview: <span id="excel-count" class="text-green-600 font-extrabold">0</span> soal terdeteksi
                                    </h5>
                                    <button onclick="document.getElementById('excel-preview').classList.add('hidden'); document.getElementById('excel-file-input').value=''" class="text-xs text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                                </div>
                                <div id="excel-preview-table" class="overflow-x-auto border rounded-lg max-h-52 overflow-y-auto text-xs"></div>
                                <div class="mt-3 flex gap-2 justify-end">
                                    <button onclick="document.getElementById('excel-preview').classList.add('hidden'); document.getElementById('excel-file-input').value=''" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50 text-sm">Batal</button>
                                    <button onclick="window.uploadParsedQuestions()" id="btn-upload-excel" class="px-5 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-sm flex items-center gap-2 shadow-sm">
                                        <i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload ke Paket
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Import Word -->
                        <div class="bg-white rounded-xl border shadow-sm p-5">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-sky-100 p-2 rounded-lg"><i data-lucide="file-text" class="w-5 h-5 text-sky-600"></i></div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Import dari Word (.docx)</h4>
                                    <p class="text-xs text-gray-500">Upload file Word yang tabelnya sesuai format template.</p>
                                </div>
                            </div>
                            <div id="word-drop-zone"
                                 ondragover="event.preventDefault(); this.classList.add('border-blue-500','bg-blue-50')"
                                 ondragleave="this.classList.remove('border-blue-500','bg-blue-50')"
                                 ondrop="window.handleWordDrop(event)"
                                 class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/50 transition-all"
                                 onclick="document.getElementById('word-file-input').click()">
                                <i data-lucide="upload-cloud" class="w-10 h-10 text-gray-400 mx-auto mb-2"></i>
                                <p class="font-semibold text-gray-600 text-sm">Klik atau drag & drop file Word</p>
                                <p class="text-xs text-gray-400 mt-1">Format .docx</p>
                                <input type="file" id="word-file-input" accept=".docx" class="hidden" onchange="window.handleWordFile(this.files[0])">
                            </div>
                            <div id="word-preview" class="hidden mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h5 class="font-bold text-gray-700 text-sm flex items-center gap-2">
                                        <i data-lucide="eye" class="w-4 h-4 text-blue-600"></i> Preview: <span id="word-count" class="text-blue-600 font-extrabold">0</span> soal terdeteksi
                                    </h5>
                                    <button onclick="document.getElementById('word-preview').classList.add('hidden'); document.getElementById('word-file-input').value=''" class="text-xs text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                                </div>
                                <div id="word-preview-table" class="overflow-x-auto border rounded-lg max-h-52 overflow-y-auto text-xs"></div>
                                <div class="mt-3 flex gap-2 justify-end">
                                    <button onclick="document.getElementById('word-preview').classList.add('hidden'); document.getElementById('word-file-input').value=''" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50 text-sm">Batal</button>
                                    <button onclick="window.uploadParsedWordQuestions()" id="btn-upload-word" class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm flex items-center gap-2 shadow-sm">
                                        <i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload ke Paket
                                    </button>
                                </div>
                            </div>
                            <div id="word-log" class="hidden mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800"></div>
                        </div>

                        <!-- Status -->
                        <div id="import-status" class="hidden p-4 rounded-xl border text-sm font-medium"></div>
                    </div>
                </div>
            </div>


                        <!-- PANEL 4: MANAJEMEN KELAS -->
            <div id="panel-kelas" class="hidden-section">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Manajemen Kelas</h2>
                            <p class="text-gray-500 text-sm">Tambah, edit, dan hapus daftar kelas yang tersedia.</p>
                        </div>
                        <button onclick="window.openKelasModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i> Tambah Kelas
                        </button>
                    </div>

                    <div class="overflow-x-auto border rounded-xl">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-900 font-semibold border-b sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-4 w-12">No</th>
                                    <th class="px-6 py-4">Nama Kelas</th>
                                    <th class="px-6 py-4">Keterangan</th>
                                    <th class="px-6 py-4 text-center w-32">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="kelas-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">Memuat data kelas...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="pager-kelas-wrap"></div>

                    <div id="kelas-offline-warn" class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-700 flex items-center gap-2">
                        <i data-lucide="wifi-off" class="w-4 h-4 shrink-0"></i>
                        Mode Offline ‚Äî perubahan kelas tidak tersimpan ke server.
                    </div>
                </div>
            </div>

            <!-- PANEL: MANAJEMEN RUANG -->
            <div id="panel-ruang" class="hidden-section admin-only-panel">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Manajemen Ruang Ujian</h2>
                            <p class="text-gray-500 text-sm">Atur ruang ujian beserta password pengawas per ruang.</p>
                        </div>
                        <button onclick="window.openRuangModal()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i> Tambah Ruang
                        </button>
                    </div>

                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-5 flex items-start gap-3">
                        <i data-lucide="info" class="w-5 h-5 text-amber-600 shrink-0 mt-0.5"></i>
                        <div class="text-sm text-amber-800">
                            <strong>Cara kerja sistem ruang:</strong> Siswa memilih ruang saat login ‚Üí datanya otomatis masuk ke ruang tersebut. Pengawas login dengan password ruangnya ‚Üí hanya bisa melihat siswa di ruangnya. Admin bisa melihat semua ruang.
                        </div>
                    </div>

                    <div class="overflow-x-auto border rounded-xl">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-900 font-semibold border-b sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-4 w-12">No</th>
                                    <th class="px-6 py-4">Nama Ruang</th>
                                    <th class="px-6 py-4">Password Pengawas</th>
                                    <th class="px-6 py-4">Keterangan</th>
                                    <th class="px-6 py-4 text-center w-32">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="ruang-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="px-6 py-10 text-center text-gray-400">Memuat data ruang...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="pager-ruang-wrap"></div>
                </div>
            </div>

            <!-- PANEL: SETTING TAMPILAN -->
            <div id="panel-tampilan" class="hidden-section admin-only-panel">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">

                    <!-- KARTU: Identitas Ujian -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
                            <i data-lucide="file-badge" class="w-5 h-5 text-blue-600"></i> Identitas Ujian
                        </h2>
                        <p class="text-sm text-gray-400 mb-5">Teks yang muncul di halaman login dan halaman selamat datang siswa.</p>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Nama / Jenis Ujian <span class="text-blue-500">(Header Utama)</span></label>
                                <input type="text" id="setting-judul-ujian" oninput="window.updateTampilanPreview()" class="w-full px-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-gray-800" placeholder="Contoh: Sumatif Akhir Sekolah">
                                <p class="text-[11px] text-gray-400 mt-1">Tampil sebagai judul besar di halaman login dan welcome.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Nama Sekolah / Sub-Judul</label>
                                <input type="text" id="setting-sub-judul" oninput="window.updateTampilanPreview()" class="w-full px-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none text-gray-700" placeholder="Contoh: SMK Negeri 1 Brondong">
                                <p class="text-[11px] text-gray-400 mt-1">Tampil di bawah judul utama sebagai keterangan institusi.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">URL Logo <span class="text-gray-400 font-normal">(opsional)</span></label>
                                <input type="url" id="setting-logo-url" oninput="window.updateTampilanPreview()" class="w-full px-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-xs text-gray-600" placeholder="https://... (URL gambar logo)">
                                <p class="text-[11px] text-gray-400 mt-1">Ganti logo di halaman login. Bisa pakai link Google Drive, CDN, dll.</p>
                            </div>
                        </div>
                    </div>

                    <!-- KARTU: Teks Sambutan -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
                            <i data-lucide="message-square-quote" class="w-5 h-5 text-yellow-500"></i> Teks Sambutan & Motivasi
                        </h2>
                        <p class="text-sm text-gray-400 mb-5">Teks yang muncul di kotak kuning halaman selamat datang siswa.</p>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Kalimat Motivasi Siswa</label>
                                <textarea id="setting-motivasi" rows="4" oninput="window.updateTampilanPreview()" class="w-full px-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-yellow-400 outline-none text-gray-700 resize-none leading-relaxed" placeholder="Kerjakan dengan jujur dan penuh semangat. Hasil terbaik lahir dari usaha yang sungguh-sungguh. Percayalah pada kemampuanmu ‚Äî sukses menantimu!"></textarea>
                                <p class="text-[11px] text-gray-400 mt-1">Tampil di kotak kuning halaman selamat datang. Gunakan kalimat singkat yang memotivasi.</p>
                            </div>
                        </div>
                    </div>

                    <!-- PREVIEW LIVE -->
                    <div class="xl:col-span-2 bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <h3 class="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2">
                            <i data-lucide="eye" class="w-4 h-4 text-blue-400"></i> Preview Halaman Login
                        </h3>
                        <div class="bg-gradient-to-r from-blue-600 via-blue-500 to-indigo-600 rounded-2xl px-8 py-6 text-center max-w-sm mx-auto shadow-2xl">
                            <div class="w-16 h-16 bg-white rounded-full mx-auto mb-3 flex items-center justify-center shadow">
                                <img id="preview-logo" src="images/logotkj.png" onerror="this.src='https://via.placeholder.com/64?text=LOGO'" class="w-12 h-12 object-contain rounded-full">
                            </div>
                            <h1 id="preview-judul" class="text-xl font-black text-white">SI UJIAN TKJ</h1>
                            <div class="h-0.5 w-14 bg-blue-300/50 rounded-full my-2 mx-auto"></div>
                            <p id="preview-sub" class="text-blue-100 text-xs font-medium">Computer Network Engineering Exam</p>
                        </div>
                        <div class="mt-4 bg-yellow-500/10 border border-yellow-400/20 rounded-xl px-5 py-3 max-w-sm mx-auto">
                            <div class="flex items-start gap-2">
                                <i data-lucide="star" class="w-4 h-4 text-yellow-300 shrink-0 mt-0.5"></i>
                                <p id="preview-motivasi" class="text-yellow-100/90 text-xs leading-relaxed italic">Kerjakan dengan jujur dan penuh semangat. Percayalah pada kemampuanmu ‚Äî sukses menantimu!</p>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Tombol simpan -->
                <div class="mt-6 flex justify-end">
                    <button onclick="window.saveSettings()" class="bg-gray-800 hover:bg-gray-900 text-white px-8 py-3 rounded-xl font-bold shadow-md active:scale-95 transition-transform flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan Semua Pengaturan
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: TAMBAH / EDIT RUANG -->
    <div id="modal-ruang" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 id="modal-ruang-title" class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="door-open" class="w-5 h-5 text-amber-600"></i> Tambah Ruang Ujian
                </h3>
                <button onclick="window.closeRuangModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form onsubmit="window.saveRuang(event)" class="space-y-4">
                <input type="hidden" id="ruang-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Ruang <span class="text-red-500">*</span></label>
                    <input type="text" id="ruang-nama" placeholder="Contoh: Ruang 1" required
                        class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-amber-500 bg-gray-50 text-sm font-medium">
                    <p class="text-xs text-gray-400 mt-1">Nama ini akan muncul di pilihan siswa saat login.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Pengawas <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="text" id="ruang-password" placeholder="Contoh: GURU1" required
                            class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-amber-500 bg-gray-50 text-sm font-bold tracking-widest uppercase">
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Password ini dipakai pengawas untuk login ke halaman monitoring ruang ini.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Opsional)</label>
                    <input type="text" id="ruang-keterangan" placeholder="Contoh: Lab Komputer 1, Lantai 2"
                        class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-amber-500 bg-gray-50 text-sm">
                </div>
                <div class="flex justify-end gap-2 pt-2 border-t">
                    <button type="button" onclick="window.closeRuangModal()" class="px-4 py-2 border rounded-xl text-gray-700 hover:bg-gray-50 text-sm font-medium">Batal</button>
                    <button type="submit" class="px-5 py-2 bg-amber-600 text-white rounded-xl hover:bg-amber-700 font-bold text-sm flex items-center gap-2 shadow-sm">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: TAMBAH / EDIT KELAS -->
    <div id="modal-kelas" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 id="modal-kelas-title" class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="school" class="w-5 h-5 text-blue-600"></i> Tambah Kelas Baru
                </h3>
                <button onclick="window.closeKelasModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form onsubmit="window.saveKelas(event)" class="space-y-4">
                <input type="hidden" id="kelas-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas <span class="text-red-500">*</span></label>
                    <input type="text" id="kelas-nama" placeholder="Contoh: XI TKJ 1" required
                        class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 text-sm font-medium">
                    <p class="text-xs text-gray-400 mt-1">Nama kelas akan muncul di pilihan saat siswa login & di filter monitoring.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Opsional)</label>
                    <input type="text" id="kelas-keterangan" placeholder="Contoh: Kelas XI Teknik Komputer Jaringan 1"
                        class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 text-sm">
                </div>
                <div class="flex justify-end gap-2 pt-2 border-t">
                    <button type="button" onclick="window.closeKelasModal()" class="px-4 py-2 border rounded-xl text-gray-700 hover:bg-gray-50 text-sm font-medium">Batal</button>
                    <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold text-sm flex items-center gap-2 shadow-sm">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- SECTION: RESULT -->
    <div id="section-result" class="hidden-section min-h-screen bg-slate-900 flex flex-col items-center justify-start pt-10 p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full text-center relative mb-8">
            <div id="result-icon-container" class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="check-circle" class="w-10 h-10"></i></div>
            <h2 id="result-title" class="text-2xl font-bold text-gray-800 mb-2">Ujian Selesai!</h2>
            <p id="result-message" class="text-gray-500 mb-6">Jawaban telah terkirim ke server.</p>
            <div class="bg-slate-50 rounded-xl p-6 mb-4 border border-slate-200">
                <p class="text-sm text-gray-500 uppercase tracking-wider font-semibold mb-1">Nilai Anda</p>
                <p id="final-score-display" class="text-5xl font-extrabold text-blue-600">0</p>
            </div>
            <div id="motivational-message" class="mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4"></div>
            <div class="flex flex-col gap-3">
                <button onclick="window.toggleReview()" id="btn-review" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                    <i data-lucide="book-open" class="w-5 h-5"></i> Lihat Pembahasan
                </button>
                <button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg transition-transform active:scale-95">Kembali ke Login</button>
            </div>
        </div>
        <div id="review-container" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 hidden mb-10">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2">
                <i data-lucide="file-check" class="w-6 h-6 text-blue-600"></i> Pembahasan Soal
            </h3>
            <div id="review-list" class="space-y-6"></div>
            <div class="mt-8 pt-6 border-t border-gray-100">
                <button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                    <i data-lucide="log-out" class="w-5 h-5"></i> Selesai Belajar & Keluar
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script>
        // Definisikan convertGDriveUrl di sini agar tersedia sebelum parseRows
        window.convertGDriveUrl = function(url) {
            if (!url) return '';
            const matchFile = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (matchFile) return `https://drive.google.com/uc?export=view&id=${matchFile[1]}`;
            const matchOpen = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (matchOpen) return `https://drive.google.com/uc?export=view&id=${matchOpen[1]}`;
            return url;
        };
        // --- DATA SOAL STATIC (FALLBACK & SEED) ---
        window.questionBank = {
            A: [
                // LITERASI
                { id: 1, text: "Rizki adalah siswa kelas XI TKJ di SMKN 1 Brondong. Gurunya memberi tugas membuat project jaringan komputer, namun Rizki selalu gagal dalam konfigurasi router. Ia merasa dirinya tidak berbakat di bidang networking dan menyerah. \"Saya memang tidak punya bakat jadi teknisi jaringan,\" katanya. Berdasarkan cerita di atas, pola pikir yang dimiliki Rizki adalah...", options: ["Growth mindset karena mau mencoba mengerjakan tugas", "Fixed mindset karena menganggap kemampuannya sudah terbatas dan tidak bisa berkembang", "Pola pikir inovatif dalam networking", "Pola pikir kreatif dalam pemrograman", "Pola pikir pantang menyerah"], correct: 1 },
                { id: 2, text: "Fahrul, lulusan TKJ SMKN 1 Brondong, membuka usaha service komputer. Ia melihat banyak warga kesulitan akses internet. Fahrul berinovasi menawarkan jasa instalasi jaringan RT/RW Net dengan harga terjangkau. Usahanya berkembang pesat. Karakter wirausaha yang paling menonjol ditunjukkan Fahrul adalah...", options: ["Jujur dalam memberikan pelayanan", "Inovatif dan kreatif melihat peluang bisnis", "Berani mengambil risiko saja", "Rasa ingin tahu terhadap teknologi saja", "Pantang menyerah dalam bekerja"], correct: 1 },
                { id: 3, text: "Devi, siswi kelas XII TKJ SMKN 1 Brondong, membuat website untuk UMKM lokal. Awalnya sepi dan teman-temannya pesimis. Devi tidak menyerah, belajar SEO dan digital marketing, hingga kini websitenya ramai. Sikap Devi menunjukkan ia memiliki...", options: ["Fixed mindset karena awalnya gagal", "Growth mindset karena terus belajar dan tidak menyerah mengembangkan kemampuannya", "Sikap mudah terpengaruh pendapat orang", "Kemampuan yang terbatas dalam web development", "Bakat alami dalam bisnis digital"], correct: 1 },
                { id: 4, text: "Pak Hendra, guru produktif TKJ di SMKN 1 Brondong, selalu mendorong siswa memiliki rasa ingin tahu tinggi terhadap teknologi baru (Cloud, IoT, Cybersecurity). Rasa ingin tahu yang tinggi penting bagi wirausaha karena...", options: ["Membuat seseorang selalu ikut campur urusan bisnis orang lain", "Membantu menemukan peluang bisnis baru dan solusi inovatif di bidang teknologi", "Membuat seseorang tidak fokus pada satu bidang usaha", "Agar bisa mengetahui rahasia kompetitor secara ilegal", "Supaya terlihat pintar di depan pelanggan"], correct: 1 },
                { id: 5, text: "Andi membuka jasa instalasi CCTV di Brondong. Ia mengklaim \"Menggunakan kamera CCTV berteknologi AI dari Jepang\" padahal menggunakan kamera lokal biasa. Pelanggan kecewa. Karakter wirausaha yang TIDAK dimiliki Andi adalah...", options: ["Inovatif dalam pemasaran", "Berani mengambil risiko bisnis", "Jujur dalam berbisnis", "Rasa ingin tahu terhadap produk", "Kreatif dalam promosi"], correct: 2 },
                { id: 6, text: "Siswa TKJ SMKN 1 Brondong sedang belajar tentang kreativitas. Kreativitas dalam kewirausahaan dapat didefinisikan sebagai...", options: ["Kemampuan meniru bisnis kompetitor dengan sempurna", "Bakat alami yang hanya dimiliki orang-orang tertentu sejak lahir", "Kemampuan menghasilkan ide-ide baru dan solusi unik untuk memecahkan masalah", "Keterampilan menjual produk teknologi dengan harga setinggi-tingginya", "Kemampuan menghasilkan uang sebanyak-banyaknya tanpa peduli cara"], correct: 2 },
                { id: 7, text: "Siti, lulusan TKJ SMKN 1 Brondong, ingin membuka warnet gaming. Ia sudah buat proposal dan hitung modal Rp 50 juta. Namun karena takut gagal dan merugi, ia membatalkan rencananya dan memilih jadi karyawan. Karakter wirausaha yang belum dimiliki Siti adalah...", options: ["Jujur dalam perencanaan", "Inovatif membuat proposal", "Berani mengambil risiko dalam berbisnis", "Rasa ingin tahu terhadap peluang", "Kreatif dalam perencanaan bisnis"], correct: 2 },
                { id: 8, text: "Dalam pembelajaran PKK di kelas TKJ SMKN 1 Brondong, guru menjelaskan perbedaan pola pikir. Perbedaan utama antara growth mindset dan fixed mindset dalam kewirausahaan adalah...", options: ["Growth mindset percaya kemampuan bisa berkembang dengan usaha, fixed mindset percaya kemampuan sudah tetap sejak lahir", "Growth mindset hanya untuk orang kaya, fixed mindset untuk orang miskin", "Growth mindset tidak pernah mengalami kegagalan, fixed mindset selalu gagal", "Growth mindset tidak perlu belajar lagi, fixed mindset harus terus belajar", "Keduanya sama saja tidak ada bedanya dalam berwirausaha"], correct: 0 },
                { id: 9, text: "Bayu, alumni TKJ SMKN 1 Brondong, 3 kali gagal bisnis (aksesoris, jasa setting, pulsa). Ia tidak menyerah, belajar dari kesalahan, dan mencoba lagi konsep baru hingga sukses di jasa website. Karakter wirausaha yang paling menonjol dari Bayu adalah...", options: ["Jujur kepada pelanggan", "Pantang menyerah dan terus berusaha", "Rasa ingin tahu tentang teknologi", "Inovatif membuat produk baru", "Berani mengambil risiko besar"], correct: 1 },
                { id: 10, text: "Di laboratorium TKJ SMKN 1 Brondong, siswa diajarkan menerapkan kreativitas. Kreativitas dalam kehidupan sehari-hari khususnya bidang TKJ dapat diterapkan dengan cara...", options: ["Hanya mengikuti tutorial yang ada di internet tanpa modifikasi", "Selalu menunggu guru memberikan solusi untuk setiap masalah", "Mencari solusi unik dan berbeda untuk masalah teknis yang dihadapi", "Menghindari hal-hal baru yang belum pernah dipelajari di sekolah", "Hanya fokus mengerjakan tugas rutin yang sudah diajarkan"], correct: 2 },
                
                // NUMERASI
                { id: 11, text: "Rina, siswi kelas XI TKJ, mengikuti pelatihan 5 hari dengan materi berbeda tiap hari. Jika ia harus memilih kombinasi 3 karakter paling tepat untuk membuka usaha service komputer baru, kombinasi mana yang paling diperlukan?", options: ["Rasa ingin tahu, Berani mengambil risiko, Jujur", "Pantang menyerah, Inovatif, Jujur", "Berani mengambil risiko, Pantang menyerah, Inovatif", "Rasa ingin tahu, Inovatif, Pantang menyerah", "Semua karakter sama pentingnya (5 karakter)"], correct: 2 },
                { id: 12, text: "Pak Hendra memberikan 4 pernyataan tentang mindset. (1) Tidak berbakat, (2) Kegagalan adalah belajar, (3) Kemampuan sudah maksimal, (4) Dengan latihan bisa lebih baik. Berapa jumlah pernyataan yang menunjukkan growth mindset?", options: ["1 pernyataan", "2 pernyataan", "3 pernyataan", "4 pernyataan", "Tidak ada yang menunjukkan growth mindset"], correct: 1 },
                { id: 13, text: "Dimas ikut lomba LKS. Tahun 1: Gagal penyisihan. Tahun 2: Semifinal. Tahun 3: Juara 2 Provinsi. Ini menunjukkan konsep mindset apa dan berapa tingkat peningkatan prestasinya (jumlah tahap)?", options: ["Fixed mindset, peningkatan 1 tahap", "Growth mindset, peningkatan 2 tahap", "Growth mindset, peningkatan 3 tahap", "Fixed mindset, peningkatan 3 tahap", "Growth mindset, tidak ada peningkatan"], correct: 1 },
                { id: 14, text: "Siswa kelas X TKJ membuat project kreatif barang bekas. Hasil: 6 sangat inovatif, 12 cukup kreatif, 8 biasa, 4 tidak mengumpulkan. Berapa persen siswa yang menunjukkan kreativitas tinggi (sangat inovatif dan cukup kreatif)?", options: ["40%", "50%", "60%", "70%", "80%"], correct: 2 },
                { id: 15, text: "Fahrul merencanakan target pelanggan: Bulan 1-2 (10 pelanggan), Bulan 3-4 (5 pelanggan), Bulan 5-6 (8 pelanggan). Karakter apa yang ditunjukkan dan berapa total target 6 bulan?", options: ["Berani mengambil risiko, 20 pelanggan", "Rasa ingin tahu, 23 pelanggan", "Inovatif dan terencana, 23 pelanggan", "Pantang menyerah, 25 pelanggan", "Jujur, 30 pelanggan"], correct: 2 },
                { id: 16, text: "Siti menghadapi 5 kegagalan dalam mengembangkan aplikasi, namun terus belajar. Pada percobaan ke-6, aplikasinya berhasil. Sikap ini menunjukkan karakter apa dan berapa kali total ia mencoba?", options: ["Jujur, 5 kali", "Inovatif, 5 kali", "Pantang menyerah, 6 kali", "Berani mengambil risiko, 6 kali", "Rasa ingin tahu, 7 kali"], correct: 2 },
                { id: 17, text: "Skor kreativitas: Meniru=1, Modifikasi=2, Inovasi=3. Reza membuat 4 ide: 1 meniru, 2 modifikasi, 1 inovasi. Berapa total skor kreativitas Reza?", options: ["6", "7", "8", "9", "10"], correct: 2 },
                { id: 18, text: "Bayu ingin mengembangkan 5 karakter wirausaha. Ada 2 karakter dasar (rasa ingin tahu & berani ambil risiko) yang harus dikuasai pertama. Jika tiap karakter butuh 2 bulan, berapa bulan untuk menguasai 2 karakter dasar tersebut?", options: ["2 bulan", "4 bulan", "6 bulan", "8 bulan", "10 bulan"], correct: 1 },
                { id: 19, text: "Dari 24 siswa, 18 memilih bangkit dan coba lagi (growth mindset), 6 memilih menyerah (fixed mindset). Berapa persentase siswa yang menunjukkan growth mindset?", options: ["25%", "50%", "65%", "75%", "80%"], correct: 3 },
                { id: 20, text: "Andi memilih ide bisnis: Riset 5 ide -> Pilih 3 -> Uji coba 2 -> Luncurkan 1. Berapa total ide yang diriset dan berapa yang diluncurkan?", options: ["Riset 5 ide, luncurkan 3 ide", "Riset 5 ide, luncurkan 2 ide", "Riset 5 ide, luncurkan 1 ide", "Riset 3 ide, luncurkan 1 ide", "Riset 3 ide, luncurkan 2 ide"], correct: 2 }
            ],
            B: [
                // LITERASI
                { id: 1, text: "Ahmad, siswa kelas XII TKJ SMKN 1 Brondong, mendapat nilai jelek saat ujian praktik instalasi server. Ia berkata kepada temannya, \"Saya memang bodoh, tidak akan pernah bisa menguasai materi server. Lebih baik saya fokus ke hal lain saja.\" Ahmad pun tidak mau belajar lagi tentang server. Pola pikir yang ditunjukkan Ahmad adalah...", options: ["Growth mindset karena mau mencari fokus baru", "Growth mindset karena realistis dengan kemampuan", "Fixed mindset karena percaya kemampuannya tidak bisa berkembang", "Pola pikir inovatif dalam belajar", "Pola pikir kreatif dalam menyelesaikan masalah"], correct: 2 },
                { id: 2, text: "Ibu Zahra, alumni TKJ SMKN 1 Brondong, membuka usaha fotocopy dan print di dekat sekolah. Ia melihat banyak siswa yang kesulitan mengedit dokumen. Ibu Zahra kemudian menambah layanan jasa pengetikan, editing dokumen, dan desain grafis sederhana. Kini usahanya menjadi one-stop service untuk kebutuhan siswa dan tidak hanya bergantung pada fotocopy saja. Karakter wirausaha yang paling dominan ditunjukkan Ibu Zahra adalah...", options: ["Jujur dalam memberikan layanan terbaik", "Pantang menyerah menghadapi persaingan", "Kreatif dan inovatif mengembangkan layanan bisnis", "Berani mengambil risiko membuka usaha", "Rasa ingin tahu tentang kebutuhan pasar"], correct: 2 },
                { id: 3, text: "Yoga, siswa kelas XI TKJ, membuat aplikasi mobile untuk mencatat tugas sekolah. Aplikasi pertamanya crash terus dan tidak ada yang mau pakai. Teman-temannya bilang \"kamu tidak cocok jadi programmer.\" Namun Yoga tidak putus asa. Ia bertanya ke kakak kelasnya, menonton tutorial YouTube, belajar dari forum online, dan terus memperbaiki coding-nya. Setelah 3 bulan, aplikasinya berhasil dan digunakan 100 siswa TKJ. Sikap Yoga menunjukkan ia memiliki...", options: ["Fixed mindset karena awalnya gagal membuat aplikasi", "Bakat alami sebagai programmer sejak lahir", "Growth mindset karena percaya kemampuan bisa berkembang dengan belajar", "Sikap mudah terpengaruh pendapat negatif orang lain", "Kemampuan yang terbatas dalam programming"], correct: 2 },
                { id: 4, text: "Pak Arif, guru produktif TKJ di SMKN 1 Brondong, selalu mengajarkan pentingnya karakter \"berani mengambil risiko\" bagi wirausahawan muda. Yang dimaksud dengan \"berani mengambil risiko\" dalam kewirausahaan adalah...", options: ["Nekat melakukan bisnis tanpa perhitungan yang matang", "Meminjam uang sebanyak-banyaknya untuk modal usaha", "Berani memulai usaha baru meski ada kemungkinan gagal, dengan perhitungan dan persiapan yang baik", "Meniru bisnis orang lain agar tidak rugi", "Hanya memulai bisnis yang sudah pasti untung 100%"], correct: 2 },
                { id: 5, text: "Budi membuka jasa pembuatan website untuk UMKM. Dalam promosi, ia klaim \"website akan selesai dalam 3 hari\" padahal kenyataannya butuh waktu 2 minggu. Banyak klien yang kecewa karena janji tidak ditepati, meskipun hasil websitenya bagus. Reputasi usaha Budi mulai menurun. Karakter wirausaha yang TIDAK dimiliki Budi adalah...", options: ["Inovatif membuat website berkualitas", "Kreatif dalam desain website", "Jujur dalam berbisnis dan menepati janji", "Berani mengambil risiko bisnis", "Memiliki keterampilan teknis yang baik"], correct: 2 },
                { id: 6, text: "Dalam pembelajaran kewirausahaan, guru menjelaskan bahwa kreativitas bukan hanya tentang seni atau desain, tetapi juga tentang cara berpikir dalam memecahkan masalah bisnis. Penerapan kreativitas dalam bisnis teknologi dapat berupa...", options: ["Selalu menggunakan cara yang sudah terbukti berhasil tanpa perubahan", "Menunggu orang lain membuat inovasi baru lalu menirunya", "Menciptakan solusi baru atau cara berbeda untuk memecahkan masalah pelanggan", "Fokus hanya pada satu produk tanpa variasi", "Mengikuti semua tren tanpa analisis kebutuhan pasar"], correct: 2 },
                { id: 7, text: "Lia ingin membuka toko komputer online. Ia sudah riset pasar, punya supplier terpercaya, dan modal cukup. Namun ia khawatir \"bagaimana kalau tidak laku?\" dan \"bagaimana kalau rugi?\". Karena terlalu takut, akhirnya Lia membatalkan niatnya dan memilih menjadi karyawan di toko komputer orang lain dengan gaji pas-pasan. Karakter wirausaha yang belum dimiliki Lia adalah...", options: ["Kreatif dalam merencanakan bisnis", "Jujur dalam menjalankan usaha", "Rasa ingin tahu tentang peluang bisnis", "Berani mengambil risiko dalam berwirausaha", "Inovatif dalam mencari supplier"], correct: 3 },
                { id: 8, text: "Di kelas PKK, guru menjelaskan perbedaan cara berpikir antara growth mindset dan fixed mindset saat menghadapi kegagalan dalam bisnis. Perbedaan respons terhadap kegagalan antara growth mindset dan fixed mindset adalah...", options: ["Growth mindset melihat kegagalan sebagai pembelajaran, fixed mindset melihat kegagalan sebagai bukti ketidakmampuan", "Growth mindset tidak pernah gagal, fixed mindset selalu gagal", "Growth mindset untuk orang pintar, fixed mindset untuk orang bodoh", "Keduanya sama-sama takut gagal dalam bisnis", "Growth mindset langsung menyerah, fixed mindset terus mencoba"], correct: 0 },
                { id: 9, text: "Hasan, alumni TKJ SMKN 1 Brondong, sudah 4 kali mencoba berbagai bisnis teknologi namun gagal: warnet tutup, jual aksesoris komputer sepi, jasa instalasi jaringan tidak berkembang, dan rental PS bangkrut. Namun ia tidak menyerah. Di percobaan kelima, ia membuka kursus komputer untuk anak-anak dan berhasil dengan 30 siswa tetap. Hasan berkata, \"Setiap kegagalan mengajarkan saya sesuatu yang berharga.\" Karakter wirausaha yang paling menonjol dari Hasan adalah...", options: ["Jujur kepada diri sendiri", "Inovatif menciptakan produk baru", "Pantang menyerah dan terus berusaha", "Berani mengambil risiko besar", "Rasa ingin tahu yang tinggi"], correct: 2 },
                { id: 10, text: "Siswa TKJ SMKN 1 Brondong belajar bahwa kreativitas adalah keterampilan yang bisa dilatih dan dikembangkan dalam kehidupan sehari-hari. Cara melatih kreativitas dalam kehidupan sehari-hari sebagai siswa TKJ adalah...", options: ["Selalu mengerjakan tugas dengan cara yang sama seperti contoh guru", "Menghindari hal-hal baru karena takut salah", "Mencoba berbagai cara berbeda untuk menyelesaikan masalah teknis", "Hanya fokus pada teori tanpa praktik", "Meniru pekerjaan teman tanpa modifikasi"], correct: 2 },
                
                // NUMERASI
                { id: 11, text: "Kelas XII TKJ SMKN 1 Brondong mengadakan workshop kewirausahaan selama 6 hari. Materi yang diajarkan adalah: Hari 1: Pentingnya kreativitas (2 jam), Hari 2: Growth mindset vs Fixed mindset (3 jam), Hari 3: Karakter jujur dan berani mengambil risiko (2 jam), Hari 4: Karakter inovatif dan pantang menyerah (3 jam), Hari 5: Karakter rasa ingin tahu (2 jam), Hari 6: Praktik membuat business plan (4 jam). Berapa total jam pembelajaran tentang karakter wirausaha (hari 3, 4, dan 5)?", options: ["5 jam", "6 jam", "7 jam", "8 jam", "9 jam"], correct: 2 },
                { id: 12, text: "Dalam diskusi kelompok, guru memberikan 6 pernyataan dan meminta siswa mengidentifikasi mana yang termasuk growth mindset: 1. \"Saya belum bisa, tapi saya akan terus belajar\", 2. \"Ini terlalu sulit untuk saya\", 3. \"Kesalahan membantu saya belajar\", 4. \"Saya tidak berbakat di bidang ini\", 5. \"Usaha saya akan membuat saya lebih baik\", 6. \"Kemampuan saya sudah mentok\". Berapa jumlah pernyataan yang menunjukkan growth mindset?", options: ["1 pernyataan", "2 pernyataan", "3 pernyataan", "4 pernyataan", "5 pernyataan"], correct: 2 },
                { id: 13, text: "Fitri mengikuti kompetisi web design tingkat nasional selama 4 tahun berturut-turut dengan hasil: Tahun 1: Tidak lolos seleksi awal (skor 0), Tahun 2: Lolos seleksi, masuk 20 besar (skor 2), Tahun 3: Masuk 10 besar (skor 3), Tahun 4: Juara 3 nasional (skor 4). Jika kita beri nilai untuk setiap pencapaian (tidak lolos = 0, lolos = 1, 20 besar = 2, 10 besar = 3, juara 3 = 4), berapa total nilai pencapaian Fitri dalam 4 tahun?", options: ["7", "8", "9", "10", "11"], correct: 2 },
                { id: 14, text: "Guru PKK memberikan tugas membuat inovasi produk teknologi. Dari 40 siswa TKJ, hasil kreativitas mereka dinilai: 8 siswa sangat inovatif, 16 siswa cukup kreatif, 10 siswa kurang kreatif, 6 siswa tidak mengumpulkan. Berapa persen siswa yang menunjukkan kreativitas baik (sangat inovatif + cukup kreatif)?", options: ["40%", "50%", "60%", "70%", "80%"], correct: 2 },
                { id: 15, text: "Andi merencanakan strategi bisnis instalasi WiFi dengan target bertahap: Fase 1 (bulan 1-3): Fokus ke 15 rumah warga di dekat sekolah, Fase 2 (bulan 4-6): Tambah 10 warung dan toko kecil, Fase 3 (bulan 7-9): Tambah 12 kantor dan klinik. Karakter apa yang ditunjukkan dengan perencanaan bertahap ini, dan berapa total target pelanggan dalam 9 bulan?", options: ["Pantang menyerah, 30 pelanggan", "Jujur, 35 pelanggan", "Inovatif dan terencana, 37 pelanggan", "Berani mengambil risiko, 40 pelanggan", "Rasa ingin tahu, 45 pelanggan"], correct: 2 },
                { id: 16, text: "Dini mencoba membuat game edukasi untuk anak SD. Ia mengalami kegagalan dan terus belajar: Percobaan 1-3: Gagal (game tidak menarik), Percobaan 4-6: Gagal (terlalu sulit untuk anak), Percobaan 7-8: Gagal (terlalu mudah, anak bosan), Percobaan 9: Berhasil (balance antara fun dan edukatif). Sikap Dini menunjukkan karakter apa, dan berapa total percobaan yang ia lakukan?", options: ["Jujur, 7 kali", "Inovatif, 8 kali", "Berani mengambil risiko, 8 kali", "Pantang menyerah, 9 kali", "Rasa ingin tahu, 10 kali"], correct: 3 },
                { id: 17, text: "Dalam penilaian project kewirausahaan, guru memberikan bobot untuk 5 karakter wirausaha: Jujur (bobot 3), Berani mengambil risiko (bobot 4), Pantang menyerah (bobot 5), Inovatif (bobot 5), Rasa ingin tahu (bobot 3). Toni dalam project-nya menunjukkan 3 karakter: jujur, pantang menyerah, dan inovatif. Berapa total skor Toni?", options: ["10", "11", "12", "13", "15"], correct: 3 },
                { id: 18, text: "Program pengembangan mindset wirausaha di SMKN 1 Brondong berlangsung 12 bulan. Fokus pembelajaran setiap kuartal: Kuartal 1 (3 bulan): Membangun growth mindset, Kuartal 2 (3 bulan): Melatih kreativitas dan inovasi, Kuartal 3 (3 bulan): Mengembangkan karakter wirausaha, Kuartal 4 (3 bulan): Praktik membuat dan menjalankan bisnis. Jika seorang siswa ingin fokus mempelajari tentang growth mindset dan kreativitas, berapa bulan waktu yang dialokasikan untuk kedua topik tersebut?", options: ["3 bulan", "4 bulan", "5 bulan", "6 bulan", "9 bulan"], correct: 3 },
                { id: 19, text: "Dalam survei tentang pola pikir di kelas XII TKJ (36 siswa), hasilnya: 27 siswa setuju bahwa \"kemampuan bisa berkembang dengan usaha keras\", 9 siswa percaya bahwa \"kemampuan sudah ditentukan sejak lahir\". Berapa persentase siswa yang memiliki growth mindset?", options: ["25%", "50%", "65%", "75%", "85%"], correct: 3 },
                { id: 20, text: "Riko melatih kreativitasnya dengan mengembangkan ide bisnis teknologi secara bertahap: Tahap 1: Brainstorming 8 ide bisnis, Tahap 2: Seleksi menjadi 5 ide potensial, Tahap 3: Riset mendalam untuk 3 ide terbaik, Tahap 4: Prototype untuk 2 ide teratas, Tahap 5: Launching 1 ide terbaik. Dari proses kreatif Riko, berapa total ide yang ia kumpulkan di awal, dan berapa ide yang akhirnya dijalankan?", options: ["Kumpulkan 5 ide, jalankan 1 ide", "Kumpulkan 6 ide, jalankan 2 ide", "Kumpulkan 8 ide, jalankan 1 ide", "Kumpulkan 8 ide, jalankan 2 ide", "Kumpulkan 10 ide, jalankan 1 ide"], correct: 2 }
            ],
            C: [
                // SOAL HOTS KEAMANAN JARINGAN (LITERASI 1-10)
                { id: 1, text: "Sebuah server sekolah mengalami kelambatan luar biasa. Tim IT menemukan log yang menunjukkan jutaan request dari ribuan alamat IP berbeda dalam waktu bersamaan, menyebabkan CPU server mencapai 100%. Serangan ini dikategorikan sebagai...", options: ["Phishing", "Man in the Middle", "DDoS (Distributed Denial of Service)", "SQL Injection", "Ransomware"], correct: 2 },
                { id: 2, text: "Admin jaringan sedang mengkonfigurasi Firewall untuk Web Server. Ia ingin memastikan server bisa diakses publik untuk website, tetapi tidak ingin orang asing bisa mengakses remote SSH. Konfigurasi aturan firewall mana yang paling efektif dan aman?", options: ["Allow All Traffic", "Block All Traffic", "Allow Port 80 & 443 Only, Block Others", "Allow Port 21 (FTP) & 22 (SSH) Only", "Allow ICMP Ping Only"], correct: 2 },
                { id: 3, text: "Dalam Vulnerability Assessment, ditemukan bahwa server menggunakan versi Apache yang sudah usang (outdated) dan memiliki celah keamanan CVE-2023-XXXX. Risiko terbesar jika hal ini dibiarkan adalah...", options: ["Internet menjadi lambat", "Kerusakan hardware server", "Penyerang bisa mengeksploitasi celah (Exploit) untuk mengambil alih sistem", "Server akan mati otomatis karena lisensi habis", "Tidak ada risiko karena server masih berjalan normal"], correct: 2 },
                { id: 4, text: "Seorang teknisi diminta mengamankan jaringan Wi-Fi sekolah. Pilihan enkripsi mana yang paling direkomendasikan saat ini untuk memberikan keamanan maksimal terhadap serangan brute force?", options: ["WEP (Wired Equivalent Privacy)", "WPA3-AES (Wi-Fi Protected Access 3)", "WPA (Wi-Fi Protected Access)", "TKIP (Temporal Key Integrity Protocol)", "Open System (Tanpa Password)"], correct: 1 },
                { id: 5, text: "Guru menerima email yang terlihat resmi dari 'Kepala Sekolah' meminta transfer pulsa segera dengan bahasa yang sedikit kaku dan mendesak. Setelah dicek, alamat email pengirim ternyata 'kepalasekolah123@gmail.com', bukan email resmi sekolah. Teknik serangan ini disebut...", options: ["Spamming", "Phishing / Social Engineering", "Virus", "Worm", "Adware"], correct: 1 },
                { id: 6, text: "Banyak siswa menggunakan password '123456' atau 'password' untuk akun e-learning mereka. Kebijakan keamanan (Password Policy) terbaik untuk mengatasi masalah ini adalah...", options: ["Membiarkan saja agar siswa tidak lupa", "Mewajibkan kombinasi huruf, angka, simbol, dan menerapkan MFA (Multi-Factor Authentication)", "Mewajibkan ganti password setiap hari", "Menulis password di kertas dan ditempel di monitor", "Meminta siswa saling bertukar password agar bisa saling mengingatkan"], correct: 1 },
                { id: 7, text: "Sebuah komputer di lab komputer tiba-tiba menampilkan layar merah dengan pesan 'File Anda telah dienkripsi. Bayar $500 dalam Bitcoin untuk mendapatkan kuncinya'. Serangan malware jenis ini disebut...", options: ["Spyware", "Adware", "Trojan", "Ransomware", "Rootkit"], correct: 3 },
                { id: 8, text: "Untuk mengantisipasi bencana alam atau serangan siber yang merusak data server utama, strategi backup data yang paling direkomendasikan menurut standar industri adalah...", options: ["Simpan backup di folder C: komputer yang sama", "Copy file ke satu Flashdisk dan dibawa pulang", "Strategi 3-2-1 (3 salinan data, 2 media berbeda, 1 disimpan di lokasi berbeda/cloud)", "Upload ke Google Drive saja tanpa backup lokal", "Print semua dokumen penting sebagai arsip"], correct: 2 },
                { id: 9, text: "Jaringan Wi-Fi tamu (Guest) di sekolah seringkali menyebabkan jaringan utama (Admin/Guru) menjadi lambat dan berisiko terkena virus dari perangkat tamu. Solusi jaringan terbaik untuk masalah ini adalah...", options: ["Mematikan Wi-Fi tamu selamanya", "Membeli router yang lebih mahal", "Menerapkan VLAN (Virtual Local Area Network) untuk memisahkan segmentasi jaringan", "Meminta tamu tidak menggunakan internet", "Menggunakan Hub agar semua terhubung jadi satu"], correct: 2 },
                { id: 10, text: "Jika terjadi insiden peretasan pada server sekolah, langkah pertama yang harus dilakukan menurut prosedur Incident Response adalah...", options: ["Format ulang semua komputer segera", "Panik dan mematikan listrik gedung", "Containment (Isolasi sistem yang terdampak agar serangan tidak menyebar)", "Membayar uang tebusan kepada peretas", "Membiarkan saja sampai peretas bosan"], correct: 2 },
                
                // SOAL HOTS KEAMANAN JARINGAN (NUMERASI 11-20)
                { id: 11, text: "Sebuah password hash sederhana membutuhkan waktu 54.000 detik untuk dipecahkan menggunakan teknik Brute Force dengan hardware standar. Berapa jam waktu yang dibutuhkan penyerang untuk menembus password tersebut?", options: ["10 Jam", "15 Jam", "20 Jam", "24 Jam", "12 Jam"], correct: 1 },
                { id: 12, text: "Sistem firewall baru berhasil memblokir serangan siber secara signifikan. Dari rata-rata 1.000 percobaan serangan per hari, setelah firewall dipasang, hanya tersisa 127 serangan yang lolos atau terdeteksi sebagai anomali. Berapa persen tingkat keberhasilan pengurangan (reduction) serangan tersebut?", options: ["80%", "85%", "87.3%", "90%", "75.5%"], correct: 2 },
                { id: 13, text: "Traffic normal sebuah jaringan kantor adalah 110 Mbps. Tiba-tiba terjadi serangan DDoS sehingga total traffic melonjak menjadi 500 Mbps. Berapa besar traffic anomali (serangan) yang membanjiri jaringan tersebut?", options: ["390 Mbps", "400 Mbps", "500 Mbps", "610 Mbps", "110 Mbps"], correct: 0 },
                { id: 14, text: "Sebuah server log keamanan menghasilkan data log sebesar 100 MB per hari. Jika kebijakan retensi data mengharuskan log disimpan selama 30 hari, berapa kapasitas penyimpanan minimal yang dibutuhkan?", options: ["1 GB", "2 GB", "3 GB", "30 GB", "100 GB"], correct: 2 },
                { id: 15, text: "Sebuah file rahasia berukuran 1.024 MB dicuri (exfiltration) oleh peretas melalui jaringan dengan kecepatan upload 8 Mbps (Megabit per second). Berapa detik waktu yang dibutuhkan peretas untuk mengambil file tersebut? (Ingat: 1 Byte = 8 bit)", options: ["128 detik", "512 detik", "1024 detik", "100 detik", "60 detik"], correct: 2 },
                { id: 16, text: "Dalam audit keamanan, ditemukan 5 celah keamanan (vulnerability) dengan skor risiko: 8, 9, 4, 2, dan 7. Jika perusahaan menetapkan bahwa hanya celah dengan skor di atas 6 yang wajib ditambal segera (High Risk), berapa jumlah celah yang harus segera diperbaiki?", options: ["1 Celah", "2 Celah", "3 Celah", "4 Celah", "5 Celah"], correct: 2 },
                { id: 17, text: "Perusahaan menginvestasikan Rp 100 Juta untuk sistem keamanan baru. Sistem ini berhasil mencegah kerugian akibat serangan siber senilai Rp 450 Juta. Berapa nilai penghematan bersih (Net Savings) yang didapatkan perusahaan?", options: ["Rp 100 Juta", "Rp 250 Juta", "Rp 350 Juta", "Rp 450 Juta", "Rp 550 Juta"], correct: 2 },
                { id: 18, text: "Seorang admin membagi jaringan menggunakan subnet mask /27 (255.255.255.224). Berapa jumlah host (IP Address) yang valid dan bisa digunakan untuk perangkat dalam satu subnet tersebut?", options: ["254 Host", "126 Host", "30 Host", "62 Host", "14 Host"], correct: 2 },
                { id: 19, text: "Analisis risiko menggunakan rumus: Risk = Impact x Probability. Jika dampak (Impact) kebocoran data bernilai 5 (Sangat Tinggi) dan kemungkinan (Probability) terjadinya bernilai 4 (Tinggi), berapa skor risiko keamanan tersebut?", options: ["9", "1", "20", "54", "10"], correct: 2 },
                { id: 20, text: "Akibat serangan Ransomware, sebuah e-commerce mati total (downtime) selama 24 jam. Jika rata-rata pendapatan per jam adalah Rp 10 Juta, berapa total kerugian finansial langsung akibat serangan tersebut?", options: ["Rp 100 Juta", "Rp 120 Juta", "Rp 200 Juta", "Rp 240 Juta", "Rp 10 Juta"], correct: 3 }
            ]
        };

        // --- STATE ---
        let currentStudent = {};
        let examTimer = null;
        let timeLeft = 3600; 
        let violations = 0;
        let violationLogs = []; 
        let userAnswers = {};
        let dashboardData = [];
        let currentFilteredData = [];
        let currentQuestionList = [];
        let currentQuestionIndex = 0;
        let isWarningActive = false; 
        
        // --- NEW: STATE UNTUK MENCEGAH FALSE POSITIVE SAAT ROTASI ---
        let isRotating = false;

        // ==================== MANAJEMEN RUANG UJIAN ====================
        window.ruangList = [];

        // ==================== MANAJEMEN SESI UJIAN ====================
        window.allSesiDB = [];

        // ==================== SETTING TAMPILAN ====================

        // Data default tampilan
        window.appearanceDefaults = {
            judulUjian : 'SI UJIAN TKJ',
            subJudul   : 'Computer Network Engineering Exam',
            motivasi   : 'Kerjakan dengan jujur dan penuh semangat. Hasil terbaik lahir dari usaha yang sungguh-sungguh. Percayalah pada kemampuanmu ‚Äî sukses menantimu!',
            logoUrl    : 'images/logotkj.png'
        };

        // Terapkan pengaturan tampilan ke semua elemen UI
        window.applyAppearanceSettings = function(s) {
            if (!s) return;
            const judul   = (s.judulUjian || '').trim();
            const sub     = (s.subJudul   || '').trim();
            const mot     = (s.motivasi   || '').trim();
            const logo    = (s.logoUrl    || '').trim();

            // Halaman Login header (pakai id)
            const loginH1  = document.getElementById('login-header-judul');
            const loginSub = document.getElementById('login-header-sub');
            if (loginH1  && judul) loginH1.textContent  = judul;
            if (loginSub && sub)   loginSub.textContent  = sub;

            // Logo di login
            const loginLogo = document.querySelector('#section-login img[alt="Logo TKJ"]');
            if (loginLogo && logo) loginLogo.src = logo;

            // Halaman Welcome header
            const welcomeTitle = document.querySelector('#section-welcome h2');
            const welcomeSub   = document.querySelector('#section-welcome p.text-blue-200');
            if (welcomeTitle && judul) welcomeTitle.textContent = '‚ú® ' + judul;
            if (welcomeSub   && sub)   welcomeSub.textContent   = sub;

            // Teks motivasi di welcome
            const motEl = document.getElementById('welcome-motivasi-text');
            if (motEl && mot) motEl.innerHTML = mot;

            // Preview di panel tampilan
            const set = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
            if (judul) set('preview-judul', judul);
            if (sub)   set('preview-sub',   sub);
            if (mot)   set('preview-motivasi', mot);
            const pLogo = document.getElementById('preview-logo');
            if (pLogo && logo) pLogo.src = logo;
        };

        // Isi form panel tampilan dari pengaturan tersimpan
        window.loadTampilanFields = function() {
            const s = window._savedAppearance || {};
            const setVal = (id, v) => { const el = document.getElementById(id); if(el && v) el.value = v; };
            setVal('setting-judul-ujian', s.judulUjian);
            setVal('setting-sub-judul',   s.subJudul);
            setVal('setting-motivasi',    s.motivasi);
            setVal('setting-logo-url',    s.logoUrl);
            // update preview
            window.updateTampilanPreview();
        };

        // Live preview saat mengetik
        window.updateTampilanPreview = function() {
            const g = (id) => (document.getElementById(id)?.value || '').trim();
            const judul = g('setting-judul-ujian') || window.appearanceDefaults.judulUjian;
            const sub   = g('setting-sub-judul')   || window.appearanceDefaults.subJudul;
            const mot   = g('setting-motivasi')    || window.appearanceDefaults.motivasi;
            const logo  = g('setting-logo-url')    || window.appearanceDefaults.logoUrl;
            const set = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
            set('preview-judul', judul);
            set('preview-sub', sub);
            set('preview-motivasi', mot);
            const pLogo = document.getElementById('preview-logo');
            if (pLogo) pLogo.src = logo;
        };

        // ==================== END SETTING TAMPILAN ====================

        window.listenForActiveSesi = function() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'sesi_ujian'));
            onSnapshot(q, (snapshot) => {
                window.allSesiDB = [];
                snapshot.forEach((d) => window.allSesiDB.push({ id: d.id, ...d.data() }));
                window.allSesiDB.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
                
                // Cari sesi aktif
                const activeSesi = window.allSesiDB.find(s => s.isActive === true);
                if (activeSesi) {
                    window.currentSesiId = activeSesi.id;
                    window.currentSesiName = activeSesi.nama;
                } else if (window.allSesiDB.length > 0) {
                    window.currentSesiId = window.allSesiDB[0].id;
                    window.currentSesiName = window.allSesiDB[0].nama;
                }

                // Update badge di monitoring
                const badge = document.getElementById('active-sesi-badge');
                const label = document.getElementById('active-sesi-label');
                if (badge && label) {
                    if (activeSesi) {
                        badge.classList.remove('hidden');
                        badge.classList.add('flex');
                        label.textContent = activeSesi.nama;
                    } else {
                        badge.classList.add('hidden');
                    }
                }

                // Update filter sesi dropdown
                window.updateSesiFilter();
                // Re-render sesi list jika modal terbuka
                const modal = document.getElementById('modal-sesi');
                if (modal && !modal.classList.contains('hidden')) {
                    window.renderSesiList();
                }
            });
        };

        window.updateSesiFilter = function() {
            const sel = document.getElementById('filter-sesi');
            if (!sel) return;
            // Simpan pilihan saat ini
            const current = sel.value;
            sel.innerHTML = '<option value="active">Sesi Aktif</option><option value="all">Semua Sesi (History)</option>';
            window.allSesiDB.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                const aktifLabel = s.isActive ? ' ‚ö°' : '';
                opt.textContent = s.nama + aktifLabel;
                sel.appendChild(opt);
            });
            // Restore pilihan
            if (current) sel.value = current;
        };

        window.openSesiModal = function() {
            document.getElementById('modal-sesi').classList.remove('hidden');
            window.renderSesiList();
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };
        window.closeSesiModal = function() {
            document.getElementById('modal-sesi').classList.add('hidden');
        };

        window.createAndActivateSesi = async function() {
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            const nama = document.getElementById('new-sesi-nama').value.trim();
            const ket  = document.getElementById('new-sesi-ket').value.trim();
            if (!nama) return alert("Nama sesi tidak boleh kosong!");

            const confirmed = confirm(
                `Buat & aktifkan sesi baru: "${nama}"?\n\n` +
                `Data sesi sebelumnya TIDAK terhapus dan masih bisa dilihat di histori.\n` +
                `Siswa yang login berikutnya akan masuk ke sesi ini.`
            );
            if (!confirmed) return;

            try {
                // 1. Nonaktifkan semua sesi lama
                const deactivatePromises = window.allSesiDB
                    .filter(s => s.isActive)
                    .map(s => updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'sesi_ujian', s.id), { isActive: false }));
                await Promise.all(deactivatePromises);

                // 2. Buat sesi baru dengan isActive = true
                await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'sesi_ujian'), {
                    nama, keterangan: ket, isActive: true, createdAt: Date.now()
                });

                document.getElementById('new-sesi-nama').value = '';
                document.getElementById('new-sesi-ket').value = '';
                alert(`‚úÖ Sesi "${nama}" berhasil dibuat dan diaktifkan!`);
            } catch(e) { alert("Gagal: " + e.message); }
        };

        window.activateSesi = async function(id, nama) {
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            if (!confirm(`Aktifkan sesi "${nama}"?\n\nSiswa yang login berikutnya akan masuk ke sesi ini.`)) return;
            try {
                const deactivatePromises = window.allSesiDB
                    .filter(s => s.isActive)
                    .map(s => updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'sesi_ujian', s.id), { isActive: false }));
                await Promise.all(deactivatePromises);
                await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'sesi_ujian', id), { isActive: true });
            } catch(e) { alert("Gagal: " + e.message); }
        };

        window.deleteSesi = async function(id, nama) {
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            if (!confirm(`Hapus sesi "${nama}"?\n\nData hasil ujian siswa di sesi ini TIDAK akan terhapus, namun tidak akan bisa difilter berdasarkan sesi ini.`)) return;
            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'sesi_ujian', id));
            } catch(e) { alert("Gagal hapus: " + e.message); }
        };

        window.renderSesiList = function() {
            const container = document.getElementById('sesi-list-container');
            if (!container) return;
            if (window.allSesiDB.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400 text-center py-6 bg-gray-50 rounded-xl border border-dashed">Belum ada sesi. Buat sesi baru di atas.</p>';
                return;
            }
            container.innerHTML = window.allSesiDB.map(s => {
                const tanggal = new Date(s.createdAt).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' });
                return `
                <div class="flex items-center gap-3 p-3.5 rounded-xl border ${s.isActive ? 'bg-indigo-50 border-indigo-300' : 'bg-white border-gray-200'}">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-sm text-gray-800 truncate">${s.nama}</span>
                            ${s.isActive ? '<span class="shrink-0 bg-indigo-600 text-white text-[10px] font-black px-2 py-0.5 rounded-full uppercase tracking-wide">‚ö° Aktif</span>' : ''}
                        </div>
                        <p class="text-xs text-gray-400 mt-0.5">${s.keterangan ? s.keterangan + ' ¬∑ ' : ''}Dibuat: ${tanggal}</p>
                    </div>
                    <div class="flex gap-1.5 shrink-0">
                        ${!s.isActive ? `<button onclick="window.activateSesi('${s.id}','${s.nama.replace(/'/g,"\\'")}') " class="text-xs font-bold text-indigo-600 hover:bg-indigo-50 border border-indigo-200 px-3 py-1.5 rounded-lg transition-colors">Aktifkan</button>` : ''}
                        <button onclick="window.deleteSesi('${s.id}','${s.nama.replace(/'/g,"\\'")}') " class="text-red-500 hover:bg-red-50 p-1.5 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`;
            }).join('');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };
        // ==================== END MANAJEMEN SESI ====================

        window.listenForRuang = function() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ruang_ujian'));
            onSnapshot(q, (snapshot) => {
                window.ruangList = [];
                snapshot.forEach((d) => {
                    window.ruangList.push({ id: d.id, ...d.data() });
                });
                window.ruangList.sort((a,b) => (a.nama||'').localeCompare(b.nama||''));
                window.renderRuangList();
                window.updateRuangDropdowns();
            });
        };

        window.renderRuangList = function() {
            const tbody = document.getElementById('ruang-table-body');
            if (!tbody) return;
            const pw = document.getElementById('pager-ruang-wrap');
            const total = window.ruangList.length;
            if (total === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-400">Belum ada ruang ujian. Tambah ruang baru.</td></tr>';
                if (pw) pw.innerHTML = '';
                return;
            }
            const pgR = window._pg.ruang;
            pgR.page = Math.max(1, Math.min(pgR.page, Math.ceil(total / pgR.perPage)));
            const sliceStart = (pgR.page - 1) * pgR.perPage;
            const pageItems = window.ruangList.slice(sliceStart, sliceStart + pgR.perPage);
            tbody.innerHTML = pageItems.map((r, i) => {
                const globalIdx = sliceStart + i;
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 text-sm text-gray-500">${globalIdx + 1}</td>
                    <td class="px-6 py-4 font-semibold text-gray-800">
                        <span class="inline-flex items-center gap-2">
                            <span class="w-8 h-8 bg-amber-100 text-amber-700 rounded-lg flex items-center justify-center text-xs font-black">${globalIdx + 1}</span>
                            ${r.nama}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <code class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-sm font-mono font-bold">${r.password || '‚Äî'}</code>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${r.keterangan || '-'}</td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex gap-2 justify-center">
                            <button onclick="window.openRuangModal('${r.id}')" class="text-amber-600 hover:bg-amber-50 p-2 rounded-lg" title="Edit"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="window.deleteRuang('${r.id}','${r.nama}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg" title="Hapus"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            if (pw) pw.innerHTML = renderPagerHTML('ruang', total, pgR.page, pgR.perPage);
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.updateRuangDropdowns = function() {
            const filterRuang = document.getElementById('filter-ruang');
            if (filterRuang && !filterRuang.disabled) {
                const current = filterRuang.value;
                filterRuang.innerHTML = '<option value="all">Semua Ruang</option>';
                window.ruangList.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.nama;
                    opt.textContent = r.nama;
                    filterRuang.appendChild(opt);
                });
                if (current) filterRuang.value = current;
            }
            window.updateStudentRoomDropdown();
            window.updatePengawasRoomDropdown();
        };

        window.updateStudentRoomDropdown = function() {
            const sel = document.getElementById('student-room');
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">-- Pilih Ruang Ujian --</option>';
            window.ruangList.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.nama;
                opt.textContent = r.nama;
                sel.appendChild(opt);
            });
            if (current) sel.value = current;
        };

        window.openRuangModal = function(id = null) {
            const modal = document.getElementById('modal-ruang');
            document.getElementById('ruang-id').value = '';
            document.getElementById('ruang-nama').value = '';
            document.getElementById('ruang-password').value = '';
            document.getElementById('ruang-keterangan').value = '';
            if (id) {
                const r = window.ruangList.find(x => x.id === id);
                if (r) {
                    document.getElementById('ruang-id').value = r.id;
                    document.getElementById('ruang-nama').value = r.nama || '';
                    document.getElementById('ruang-password').value = r.password || '';
                    document.getElementById('ruang-keterangan').value = r.keterangan || '';
                }
            }
            modal.classList.remove('hidden');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closeRuangModal = function() {
            document.getElementById('modal-ruang').classList.add('hidden');
        };

        window.saveRuang = async function(e) {
            e.preventDefault();
            if (!window.isFirebaseReady) return alert("Mode Offline: Tidak bisa menyimpan.");
            const id   = document.getElementById('ruang-id').value;
            const nama = document.getElementById('ruang-nama').value.trim();
            const pass = document.getElementById('ruang-password').value.trim().toUpperCase();
            const ket  = document.getElementById('ruang-keterangan').value.trim();
            if (!nama) return alert("Nama ruang tidak boleh kosong!");
            if (!pass) return alert("Password pengawas tidak boleh kosong!");
            const data = { nama, password: pass, keterangan: ket, updatedAt: Date.now() };
            try {
                if (id) {
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ruang_ujian', id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ruang_ujian'), data);
                }
                window.closeRuangModal();
            } catch(err) { alert("Gagal menyimpan: " + err.message); }
        };

        window.deleteRuang = async function(id, nama) {
            if (!confirm(`Hapus ruang "${nama}"?\n\nData siswa di ruang ini tidak akan terhapus.`)) return;
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ruang_ujian', id));
            } catch(err) { alert("Gagal hapus: " + err.message); }
        };
        // ==================== END MANAJEMEN RUANG ====================

        window.switchLoginTab = function(type) {
            const btnStudent = document.getElementById('tab-student');
            const btnTeacher = document.getElementById('tab-teacher');
            const formStudent = document.getElementById('form-student');
            const formTeacher = document.getElementById('form-teacher');

            if (type === 'student') {
                btnStudent.className = "flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-white transition-all hover:bg-blue-50/50";
                btnTeacher.className = "flex-1 py-4 text-sm font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent transition-all hover:bg-gray-50/50";
                formStudent.classList.remove('hidden-section');
                formTeacher.classList.add('hidden-section');
            } else {
                btnStudent.className = "flex-1 py-4 text-sm font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent transition-all hover:bg-gray-50/50";
                btnTeacher.className = "flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-white transition-all hover:bg-blue-50/50";
                formStudent.classList.add('hidden-section');
                formTeacher.classList.remove('hidden-section');
            }
        };

        window.selectPacket = function(pkt) {
            // Reset styles for packet selection logic manually to match new design
            document.querySelectorAll('.pkt-btn').forEach(btn => {
                // Default unselected state
                btn.className = "pkt-btn relative w-full p-2.5 rounded-xl border transition-all duration-200 text-left bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50 text-gray-500 group";
                // Inner reset
                const title = btn.querySelector('.font-bold');
                if(title) title.className = "font-bold text-xs group-hover:text-gray-700";
                
                // Remove icon if present
                const iconDiv = btn.querySelector('.h-6');
                if(iconDiv) iconDiv.remove();
                
                // Adjust layout if it was the large A button
                if(btn.id === 'pkt-A') {
                     btn.className = "pkt-btn relative w-full p-3 rounded-xl border transition-all duration-200 text-left bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50 text-gray-500 group";
                     btn.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-bold text-xs group-hover:text-gray-700">STS PKWU - Paket A</div>
                                <div class="text-[10px] uppercase mt-0.5">Kelas XI TKJ 1</div>
                            </div>
                        </div>`;
                }
            });

            // Set Selected State
            const selectedBtn = document.getElementById('pkt-' + pkt);
            if(selectedBtn) {
                 if(pkt === 'A') {
                    selectedBtn.className = "pkt-btn relative w-full p-3 rounded-xl border-2 transition-all duration-200 text-left bg-blue-50 border-blue-600 ring-2 ring-blue-200/50 shadow-sm group";
                    selectedBtn.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-bold text-blue-700 text-sm">STS PKWU - Paket A</div>
                                <div class="text-[10px] font-semibold text-blue-500 uppercase mt-0.5">Kelas XI TKJ 1</div>
                            </div>
                            <div class="h-6 w-6 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-sm"><i data-lucide="check" class="w-3 h-3"></i></div>
                        </div>`;
                 } else {
                    selectedBtn.className = "pkt-btn relative w-full p-2.5 rounded-xl border-2 transition-all duration-200 text-left bg-blue-50 border-blue-600 text-blue-700 ring-2 ring-blue-200/50 shadow-sm group";
                    const title = selectedBtn.querySelector('.font-bold');
                    if(title) title.className = "font-bold text-xs text-blue-700";
                 }
                 
                document.getElementById('selected-packet').value = pkt;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
        };

        // --- DASHBOARD UI LOGIC ---
        window.switchDashTab = function(tab) {
            const activeClass   = "pb-3 border-b-2 border-blue-600 font-bold text-blue-600 px-4 whitespace-nowrap flex items-center gap-2";
            const inactiveClass = "pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-bold px-4 whitespace-nowrap flex items-center gap-2";
            const tabs   = ['nilai','kelas','soal','ruang','tampilan'];
            const panels = { nilai:'panel-nilai', soal:'panel-soal', kelas:'panel-kelas', ruang:'panel-ruang', tampilan:'panel-tampilan' };
            const btnIds = { nilai:'tab-dash-nilai', soal:'tab-dash-soal', kelas:'tab-dash-kelas', ruang:'tab-dash-ruang', tampilan:'tab-dash-tampilan' };
            tabs.forEach(t => {
                const btn = document.getElementById(btnIds[t]);
                const pnl = document.getElementById(panels[t]);
                if (btn) btn.className = (t === tab ? activeClass : inactiveClass) + (btn.classList.contains('admin-only-tab') ? ' admin-only-tab' : '');
                if (pnl) { if (t === tab) pnl.classList.remove('hidden-section'); else pnl.classList.add('hidden-section'); }
            });
            if (tab === 'soal') { window.backToPaketList(); window.renderPaketGrid(); }
            if (tab === 'kelas') window.renderKelasList();
            if (tab === 'ruang') window.renderRuangList();
            if (tab === 'tampilan') window.loadTampilanFields();
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        // Toggle import section di dalam panel soal
        window.toggleImportSection = function() {
            const sec = document.getElementById('section-import-inline');
            if (!sec) return;
            const isHidden = sec.classList.contains('hidden');
            sec.classList.toggle('hidden', !isHidden);
            if (isHidden) {
                setTimeout(() => sec.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        // ==================== PAKET SOAL MANAGEMENT ====================
        window.allPaketDB = [];
        window.activePaketId = null;

        window.listenForPaket = function() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal'));
            onSnapshot(q, (snapshot) => {
                window.allPaketDB = [];
                snapshot.forEach((d) => window.allPaketDB.push({ id: d.id, ...d.data() }));
                window.allPaketDB.sort((a,b) => (a.createdAt||0) - (b.createdAt||0));
                window.renderPaketGrid();
                window.updatePaketFilter();
                if (window.activePaketId) window.refreshActivePaketInfo();
            });
        };

        // ‚îÄ‚îÄ Update dropdown filter paket soal di monitoring ‚îÄ‚îÄ
        window.updatePaketFilter = function() {
            const sel = document.getElementById('filter-session');
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="all">Semua Paket</option>';
            (window.allPaketDB || []).forEach(p => {
                const opt = document.createElement('option');
                // packetType di exam_results memakai field 'jenis' (A/B/C) dari paket
                opt.value = p.jenis && p.jenis !== 'nonpaket' ? p.jenis : p.nama;
                opt.textContent = p.nama + (p.jenis && p.jenis !== 'nonpaket' ? ` (Paket ${p.jenis})` : '');
                sel.appendChild(opt);
            });
            if (current) sel.value = current;
        };

        const PAKET_COLORS = [
            'bg-blue-500','bg-indigo-500','bg-purple-500','bg-pink-500',
            'bg-rose-500','bg-orange-500','bg-amber-500','bg-teal-500',
            'bg-cyan-500','bg-emerald-500','bg-green-500','bg-lime-500'
        ];

        window.renderPaketGrid = function() {
            const grid = document.getElementById('paket-grid');
            if (!grid) return;
            const total = window.allPaketDB.length;
            const info = document.getElementById('paket-count-info');
            if (info) info.textContent = `${total} paket tersedia`;

            if (total === 0) {
                grid.innerHTML = `
                    <div class="col-span-full bg-white rounded-2xl border-2 border-dashed border-gray-200 p-14 text-center">
                        <div class="inline-flex p-4 bg-indigo-50 rounded-2xl mb-4"><i data-lucide="layers" class="w-10 h-10 text-indigo-400"></i></div>
                        <h3 class="text-lg font-bold text-gray-700 mb-2">Belum Ada Paket Soal</h3>
                        <p class="text-gray-400 text-sm mb-5 max-w-xs mx-auto">Buat paket soal pertama Anda. Paket adalah wadah yang berisi kumpulan soal ujian.</p>
                        <button onclick="window.openPaketModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 mx-auto shadow-md">
                            <i data-lucide="plus" class="w-4 h-4"></i> Buat Paket Pertama
                        </button>
                    </div>`;
                const pw = document.getElementById('pager-paket-wrap');
                if (pw) pw.innerHTML = '';
                if(typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // Pagination
            const pgP = window._pg.paket;
            pgP.page = Math.max(1, Math.min(pgP.page, Math.ceil(total / pgP.perPage)));
            const sliceStart = (pgP.page - 1) * pgP.perPage;
            const pageItems = window.allPaketDB.slice(sliceStart, sliceStart + pgP.perPage);

            grid.innerHTML = pageItems.map((p, i) => {
                const globalIdx = sliceStart + i;
                const color  = PAKET_COLORS[globalIdx % PAKET_COLORS.length];
                const isAktif = p.aktif !== false;
                const soalCount = window.allQuestionsDB.filter(q => q.paketId === p.id).length;
                const kelasTags = (p.kelas && p.kelas.length > 0)
                    ? p.kelas.slice(0,3).map(k => `<span class="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-md text-xs font-medium">${k}</span>`).join('')
                      + (p.kelas.length > 3 ? `<span class="text-xs text-gray-400">+${p.kelas.length-3}</span>` : '')
                    : `<span class="text-xs text-gray-400">Semua Kelas</span>`;
                const jenisLabel = p.jenis === 'nonpaket' || !p.jenis ? 'Non Paket' : `Paket ${p.jenis}`;

                return `
                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden hover:shadow-md transition-shadow group">
                    <div class="${color} px-5 pt-5 pb-4 text-white relative">
                        <div class="flex justify-between items-start">
                            <div class="bg-white/20 w-11 h-11 rounded-xl flex items-center justify-center text-xl font-black">
                                ${p.nama.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex items-center gap-1.5">
                                <span class="${isAktif ? 'bg-white/30 text-white' : 'bg-black/20 text-white/70'} text-xs font-bold px-2.5 py-1 rounded-full">
                                    ${isAktif ? '‚óè Aktif' : '‚óã Nonaktif'}
                                </span>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="event.stopPropagation(); window.openPaketModal('${p.id}')" class="bg-white/20 hover:bg-white/30 p-1.5 rounded-lg" title="Edit"><i data-lucide="settings" class="w-3.5 h-3.5"></i></button>
                                    <button onclick="event.stopPropagation(); window.deletePaket('${p.id}','${p.nama.replace(/'/g,"\\'")}') " class="bg-white/20 hover:bg-red-400/60 p-1.5 rounded-lg" title="Hapus"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            </div>
                        </div>
                        <h4 class="text-base font-bold mt-3 leading-tight">${p.nama}</h4>
                        <p class="text-white/80 text-xs mt-0.5">${p.mapel || '‚Äî'}</p>
                    </div>
                    <div class="px-5 py-4">
                        <div class="flex flex-wrap gap-1.5 mb-3">${kelasTags}</div>
                        <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                            <span class="bg-gray-100 px-2.5 py-1 rounded-lg font-semibold">${jenisLabel}</span>
                            <span class="flex items-center gap-1"><i data-lucide="key" class="w-3 h-3 text-yellow-500"></i> ${p.token || '‚Äî'}</span>
                        </div>
                        <div class="flex items-center justify-between border-t pt-3">
                            <span class="text-sm font-semibold text-gray-700">${soalCount} Soal</span>
                            <button onclick="window.openPaketSoal('${p.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1.5 shadow-sm active:scale-95 transition-all">
                                <i data-lucide="book-open" class="w-3.5 h-3.5"></i> Kelola Soal
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            const pw = document.getElementById('pager-paket-wrap');
            if (pw) pw.innerHTML = renderPagerHTML('paket', total, pgP.page, pgP.perPage);

            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.openPaketSoal = function(paketId) {
            window.activePaketId = paketId;
            const paket = window.allPaketDB.find(p => p.id === paketId);
            if (!paket) return;

            // Reset soal page to 1 when switching paket
            if (window._pg && window._pg.soal) window._pg.soal.page = 1;

            // Switch view
            document.getElementById('view-paket-list').classList.add('hidden');
            document.getElementById('view-soal-in-paket').classList.remove('hidden');

            // Update breadcrumb & info card
            window.refreshActivePaketInfo();
            window.filterQuestionBank();
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.refreshActivePaketInfo = function() {
            const paket = window.allPaketDB.find(p => p.id === window.activePaketId);
            if (!paket) return;
            const COLORS = PAKET_COLORS;
            const idx = window.allPaketDB.indexOf(paket);
            const color = COLORS[idx % COLORS.length];
            const isAktif = paket.aktif !== false;

            document.getElementById('breadcrumb-paket-nama').textContent = paket.nama;
            document.getElementById('active-paket-nama').textContent = paket.nama;
            document.getElementById('active-paket-mapel').textContent = paket.mapel || '';
            document.getElementById('active-paket-token').textContent = paket.token || '‚Äî';

            const iconEl = document.getElementById('active-paket-icon');
            iconEl.className = `w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold text-lg shrink-0 ${color}`;
            iconEl.textContent = paket.nama.charAt(0).toUpperCase();

            const statusBadge = document.getElementById('active-paket-status-badge');
            statusBadge.className = `px-2.5 py-1 rounded-full text-xs font-bold ${isAktif ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'}`;
            statusBadge.textContent = isAktif ? '‚óè Aktif' : '‚óã Nonaktif';

            const kelasTags = document.getElementById('active-paket-kelas-tags');
            kelasTags.innerHTML = (paket.kelas && paket.kelas.length > 0)
                ? paket.kelas.map(k => `<span class="bg-indigo-100 text-indigo-700 px-2.5 py-0.5 rounded-full text-xs font-semibold">${k}</span>`).join('')
                : `<span class="text-xs text-gray-400">Semua Kelas</span>`;
        };

        window.backToPaketList = function() {
            window.activePaketId = null;
            const v1 = document.getElementById('view-paket-list');
            const v2 = document.getElementById('view-soal-in-paket');
            if (v1) v1.classList.remove('hidden');
            if (v2) v2.classList.add('hidden');
        };

        // -- Modal Paket --
        window.openPaketModal = function(id = null) {
            const modal = document.getElementById('modal-paket');
            document.getElementById('form-paket').reset();
            document.getElementById('paket-id').value = '';
            document.getElementById('paket-aktif').checked = true;
            document.getElementById('paket-aktif-label').textContent = 'Aktif';
            document.getElementById('paket-aktif-label').className = 'text-sm font-bold text-green-600';
            window.rebuildPaketKelasChecks([]);
            // Reset jenis radio
            document.querySelectorAll('[name="paket-jenis"]').forEach(r => {
                r.checked = r.value === 'nonpaket';
                const span = r.nextElementSibling;
                if(span) span.className = `paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold ${r.checked ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-gray-200 bg-white text-gray-500'}`;
            });
            document.getElementById('modal-paket-title').textContent = id ? 'Edit Paket Soal' : 'Buat Paket Soal Baru';

            if (id) {
                const p = window.allPaketDB.find(x => x.id === id);
                if (p) {
                    document.getElementById('paket-id').value = p.id;
                    document.getElementById('paket-nama').value = p.nama || '';
                    document.getElementById('paket-mapel').value = p.mapel || '';
                    document.getElementById('paket-token').value = p.token || '';
                    const isAktif = p.aktif !== false;
                    document.getElementById('paket-aktif').checked = isAktif;
                    document.getElementById('paket-aktif-label').textContent = isAktif ? 'Aktif' : 'Nonaktif';
                    document.getElementById('paket-aktif-label').className = `text-sm font-bold ${isAktif ? 'text-green-600' : 'text-gray-400'}`;
                    window.rebuildPaketKelasChecks(p.kelas || []);
                    // Set jenis
                    const jenis = p.jenis || 'nonpaket';
                    document.querySelectorAll('[name="paket-jenis"]').forEach(r => {
                        r.checked = r.value === jenis;
                        const span = r.nextElementSibling;
                        if(span) span.className = `paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold ${r.checked ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-gray-200 bg-white text-gray-500'}`;
                    });
                }
            }

            // Jenis radio click handler
            document.querySelectorAll('[name="paket-jenis"]').forEach(r => {
                r.onclick = function() {
                    document.querySelectorAll('[name="paket-jenis"]').forEach(x => {
                        const span = x.nextElementSibling;
                        if(span) span.className = `paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold ${x.checked ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-gray-200 bg-white text-gray-500'}`;
                    });
                };
            });
            // aktif toggle label
            document.getElementById('paket-aktif').onchange = function() {
                const lbl = document.getElementById('paket-aktif-label');
                lbl.textContent = this.checked ? 'Aktif' : 'Nonaktif';
                lbl.className = `text-sm font-bold ${this.checked ? 'text-green-600' : 'text-gray-400'}`;
            };

            modal.classList.remove('hidden');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closePaketModal = function() { document.getElementById('modal-paket').classList.add('hidden'); };

        window.rebuildPaketKelasChecks = function(checkedArr = []) {
            const container = document.getElementById('paket-kelas-checks');
            if (!container) return;
            if (window.kelasList.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-400 italic">Tambahkan kelas di tab Manajemen Kelas terlebih dahulu.</span>';
                return;
            }
            container.innerHTML = window.kelasList.map(k => `
                <label class="flex items-center gap-1.5 cursor-pointer bg-white border-2 hover:border-indigo-400 px-3 py-1.5 rounded-xl transition-colors ${checkedArr.includes(k.nama) ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}">
                    <input type="checkbox" value="${k.nama}" class="w-3.5 h-3.5 accent-indigo-600" ${checkedArr.includes(k.nama) ? 'checked' : ''} onchange="this.closest('label').className=this.closest('label').className.replace(this.checked?'border-gray-200':'border-indigo-500 bg-indigo-50',this.checked?'border-indigo-500 bg-indigo-50':'border-gray-200')">
                    <span class="text-sm font-semibold text-gray-700">${k.nama}</span>
                </label>
            `).join('');
        };

        window.savePaket = async function(e) {
            e.preventDefault();
            if (!window.isFirebaseReady) return alert("Mode Offline: Tidak bisa menyimpan.");
            const id    = document.getElementById('paket-id').value;
            const nama  = document.getElementById('paket-nama').value.trim();
            const mapel = document.getElementById('paket-mapel').value.trim();
            const token = document.getElementById('paket-token').value.trim().toUpperCase();
            const aktif = document.getElementById('paket-aktif').checked;
            const jenis = document.querySelector('[name="paket-jenis"]:checked')?.value || 'nonpaket';
            const kelas = Array.from(document.querySelectorAll('#paket-kelas-checks input:checked')).map(c => c.value);

            if (!nama) return alert("Nama paket tidak boleh kosong!");
            if (!token) return alert("Token paket tidak boleh kosong!");

            const data = { nama, mapel, token, aktif, jenis, kelas, updatedAt: Date.now() };
            try {
                if (id) {
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal', id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal'), data);
                }
                window.closePaketModal();
            } catch(err) { alert("Gagal menyimpan: " + err.message); }
        };

        window.deletePaket = async function(id, nama) {
            if (!confirm(`Hapus paket "${nama}"?\n\nSemua soal dalam paket ini TIDAK akan ikut terhapus, tetapi akan kehilangan referensi paket.`)) return;
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal', id));
                if (window.activePaketId === id) window.backToPaketList();
            } catch(err) { alert("Gagal hapus: " + err.message); }
        };
        // ==================== END PAKET MANAGEMENT ====================

        // ==================== MANAJEMEN KELAS ====================
        window.kelasList = [];

        window.listenForKelas = function() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'kelas'));
            onSnapshot(q, (snapshot) => {
                window.kelasList = [];
                snapshot.forEach((d) => {
                    window.kelasList.push({ id: d.id, ...d.data() });
                });
                window.kelasList.sort((a,b) => (a.nama||'').localeCompare(b.nama||''));
                window.renderKelasList();
                window.updateKelasFilter();
                window.updateStudentKelasDropdown();
            });
        };

        window.updateKelasFilter = function() {
            // Update monitoring nilai filter
            const sel = document.getElementById('filter-class');
            if (sel) {
                const current = sel.value;
                sel.innerHTML = '<option value="all">Semua Kelas</option>';
                window.kelasList.forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k.nama;
                    opt.textContent = k.nama;
                    sel.appendChild(opt);
                });
                sel.value = current;
            }
            // Update bank soal filter kelas
            const selBank = document.getElementById('filter-bank-kelas');
            if (selBank) {
                const currentBank = selBank.value;
                selBank.innerHTML = '<option value="all">Semua Kelas</option>';
                window.kelasList.forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k.nama;
                    opt.textContent = k.nama;
                    selBank.appendChild(opt);
                });
                selBank.value = currentBank;
            }
            // Update modal kelas checkboxes
            window.rebuildKelasChecks();
            window.rebuildPaketKelasChecks();
        };

        window.rebuildKelasChecks = function(checkedArr = []) {
            const container = document.getElementById('q-kelas-checks');
            if (!container) return;
            if (window.kelasList.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-400 italic">Belum ada kelas. Tambahkan di tab Manajemen Kelas.</span>';
                return;
            }
            container.innerHTML = window.kelasList.map(k => `
                <label class="flex items-center gap-1.5 cursor-pointer bg-white border border-indigo-200 hover:border-indigo-400 px-3 py-1.5 rounded-lg transition-colors">
                    <input type="checkbox" value="${k.nama}" class="w-3.5 h-3.5 accent-indigo-600" ${checkedArr.includes(k.nama) ? 'checked' : ''}>
                    <span class="text-sm font-medium text-gray-700">${k.nama}</span>
                </label>
            `).join('');
        };

        window.updateStudentKelasDropdown = function() {
            const sel = document.getElementById('student-class');
            if (!sel || window.kelasList.length === 0) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">Pilih Kelas</option>';
            window.kelasList.forEach(k => {
                const opt = document.createElement('option');
                opt.value = k.nama;
                opt.textContent = k.nama;
                sel.appendChild(opt);
            });
            if (current) sel.value = current;
        };

        window.renderKelasList = function() {
            const tbody = document.getElementById('kelas-table-body');
            if (!tbody) return;
            const pw = document.getElementById('pager-kelas-wrap');
            const total = window.kelasList.length;
            if (total === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">Belum ada kelas. Tambah kelas baru.</td></tr>';
                if (pw) pw.innerHTML = '';
                return;
            }
            const pgK = window._pg.kelas;
            pgK.page = Math.max(1, Math.min(pgK.page, Math.ceil(total / pgK.perPage)));
            const sliceStart = (pgK.page - 1) * pgK.perPage;
            const pageItems = window.kelasList.slice(sliceStart, sliceStart + pgK.perPage);
            tbody.innerHTML = pageItems.map((k, i) => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 text-sm text-gray-500">${sliceStart + i + 1}</td>
                    <td class="px-6 py-4 font-semibold text-gray-800">${k.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${k.keterangan || '-'}</td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex gap-2 justify-center">
                            <button onclick="window.openKelasModal('${k.id}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg" title="Edit"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="window.deleteKelas('${k.id}','${k.nama}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg" title="Hapus"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
            if (pw) pw.innerHTML = renderPagerHTML('kelas', total, pgK.page, pgK.perPage);
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.openKelasModal = function(id = null) {
            const modal = document.getElementById('modal-kelas');
            const titleEl = document.getElementById('modal-kelas-title');
            document.getElementById('kelas-id').value = '';
            document.getElementById('kelas-nama').value = '';
            document.getElementById('kelas-keterangan').value = '';

            if (id) {
                const k = window.kelasList.find(x => x.id === id);
                if (k) {
                    titleEl.textContent = 'Edit Kelas';
                    document.getElementById('kelas-id').value = k.id;
                    document.getElementById('kelas-nama').value = k.nama;
                    document.getElementById('kelas-keterangan').value = k.keterangan || '';
                }
            } else {
                titleEl.textContent = 'Tambah Kelas Baru';
            }
            modal.classList.remove('hidden');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closeKelasModal = function() {
            document.getElementById('modal-kelas').classList.add('hidden');
        };

        window.saveKelas = async function(e) {
            e.preventDefault();
            if (!window.isFirebaseReady) return alert("Mode Offline: Tidak bisa menyimpan ke database.");
            const id = document.getElementById('kelas-id').value;
            const nama = document.getElementById('kelas-nama').value.trim();
            const keterangan = document.getElementById('kelas-keterangan').value.trim();
            if (!nama) return alert("Nama kelas tidak boleh kosong!");

            const data = { nama, keterangan, updatedAt: Date.now() };
            try {
                if (id) {
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'kelas', id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'kelas'), data);
                }
                window.closeKelasModal();
            } catch(err) {
                alert("Gagal menyimpan: " + err.message);
            }
        };

        window.deleteKelas = async function(id, nama) {
            if (!confirm(`Hapus kelas "${nama}"? Tindakan ini tidak bisa dibatalkan.`)) return;
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'kelas', id));
            } catch(err) {
                alert("Gagal hapus: " + err.message);
            }
        };
        // ==================== END MANAJEMEN KELAS ====================
        
        // --- CHEAT ALERT LOGIC ---
        window.triggerCheatAlert = function(data) {
            if (document.getElementById('section-dashboard').classList.contains('hidden-section')) return;

            const modal = document.getElementById('modal-cheat-alert');
            const nameEl = document.getElementById('cheat-student-name');
            const msgEl = document.getElementById('cheat-message');
            const statusEl = document.getElementById('cheat-status');
            const countEl = document.getElementById('cheat-count');

            nameEl.innerText = data.studentName + " (" + data.className + ")";
            statusEl.innerText = data.status;
            countEl.innerText = data.violations + "x";

            if (data.status.includes('DISKUALIFIKASI')) {
                 msgEl.innerText = "SISWA INI TELAH DIDISKUALIFIKASI OLEH SISTEM!";
            } else {
                 msgEl.innerText = "Terdeteksi melakukan kecurangan (Pindah Tab/Split Screen)!";
            }

            modal.classList.remove('hidden');
            
            try {
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                audio.volume = 0.5;
                audio.play().catch(() => {}); 
            } catch(e) {}
        };

        window.closeCheatAlert = function() {
            document.getElementById('modal-cheat-alert').classList.add('hidden');
        };
        
        window.showViolationDetails = (id) => {
            const item = dashboardData.find(x => x.id === id);
            if (!item) return;

            document.getElementById('violation-student-name').innerText = item.studentName;
            const list = document.getElementById('violation-list');
            list.innerHTML = '';

            if (!item.violationLogs || item.violationLogs.length === 0) {
                list.innerHTML = '<p class="text-xs text-gray-400 italic text-center py-4">Tidak ada log detail tercatat.<br> (Sistem versi lama atau deteksi manual).</p>';
            } else {
                item.violationLogs.forEach((log) => {
                    const time = new Date(log.time).toLocaleTimeString('id-ID');
                    list.innerHTML += `
                        <div class="text-xs border-b last:border-0 pb-2 mb-2 bg-white p-2 rounded shadow-sm">
                            <span class="font-bold text-red-600 bg-red-50 px-1 rounded border border-red-100 mr-1">[${time}]</span> 
                            <span class="text-gray-700 font-medium">${log.message}</span>
                        </div>
                    `;
                });
            }
            document.getElementById('modal-violation-details').classList.remove('hidden');
        };

        window.filterQuestionBank = function() {
            const filterStatus = (document.getElementById('filter-bank-status') || {}).value || 'all';
            const searchVal    = ((document.getElementById('search-bank-soal') || {}).value || '').toLowerCase();
            const container    = document.getElementById('bank-soal-list');
            if (!container) return;

            // Filter by active paket
            let filtered = window.allQuestionsDB.filter(q => {
                if (window.activePaketId && q.paketId !== window.activePaketId) return false;
                if (filterStatus === 'aktif'    && q.aktif === false) return false;
                if (filterStatus === 'nonaktif' && q.aktif !== false) return false;
                if (searchVal && !(q.text||'').toLowerCase().includes(searchVal)) return false;
                return true;
            });
            filtered.sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));

            // Stats
            const total    = filtered.length;
            const aktifCnt = filtered.filter(q => q.aktif !== false).length;
            const nonAktif = total - aktifCnt;
            const s = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
            s('stat-total', `Total: ${total}`);
            s('stat-aktif', `Aktif: ${aktifCnt}`);
            s('stat-nonaktif', `Nonaktif: ${nonAktif}`);

            const pw = document.getElementById('pager-soal-wrap');

            if (filtered.length === 0) {
                const paket = window.allPaketDB.find(p => p.id === window.activePaketId);
                container.innerHTML = `
                    <div class="bg-white rounded-xl border shadow-sm p-12 text-center">
                        <div class="inline-flex p-4 bg-blue-50 rounded-2xl mb-4"><i data-lucide="file-plus" class="w-10 h-10 text-blue-400"></i></div>
                        <h3 class="text-lg font-bold text-gray-700 mb-2">Belum Ada Soal</h3>
                        <p class="text-gray-400 text-sm mb-5">Paket <strong>${paket ? paket.nama : ''}</strong> belum memiliki soal.<br>Tambahkan soal manual atau import dari Excel/Word.</p>
                        <div class="flex gap-3 justify-center flex-wrap">
                            <button onclick="window.openQuestionModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-md">
                                <i data-lucide="plus" class="w-4 h-4"></i> Tambah Soal Manual
                            </button>
                            <button onclick="window.switchDashTab('import')" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-md">
                                <i data-lucide="upload" class="w-4 h-4"></i> Import dari Excel/Word
                            </button>
                        </div>
                    </div>`;
                if (pw) pw.innerHTML = '';
                if(typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // Pagination
            const pgS = window._pg.soal;
            pgS.page = Math.max(1, Math.min(pgS.page, Math.ceil(total / pgS.perPage)));
            const sliceStart = (pgS.page - 1) * pgS.perPage;
            const pageItems = filtered.slice(sliceStart, sliceStart + pgS.perPage);

            const labels = ['A','B','C','D','E'];
            container.innerHTML = pageItems.map((q, idx) => {
                const globalIdx = sliceStart + idx;
                const isAktif   = q.aktif !== false;
                const optionsHtml = (q.options || []).map((opt, i) => {
                    const isCorrect = i === q.correct;
                    return `<div class="flex items-start gap-2 py-1.5 px-3 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-100'}">
                        <span class="shrink-0 w-6 h-6 rounded-full ${isCorrect ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600'} text-xs font-bold flex items-center justify-center">${labels[i]||i}</span>
                        <span class="text-sm ${isCorrect ? 'text-green-800 font-semibold' : 'text-gray-700'} flex-1">${opt || '<em class="text-gray-400 text-xs">Gambar</em>'}</span>
                        ${isCorrect ? '<span class="text-xs font-bold text-green-600 shrink-0">‚úì Kunci</span>' : ''}
                    </div>`;
                }).join('');
                const imgHtml = q.image ? `<div class="mt-3"><img src="${q.image}" class="max-h-32 rounded-xl border object-contain bg-gray-50 p-1"></div>` : '';

                return `
                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden ${!isAktif ? 'opacity-60' : ''}" id="soal-card-${q.id}">
                    <div class="flex items-center gap-3 px-5 py-3.5 cursor-pointer hover:bg-gray-50 transition-colors" onclick="window.toggleSoalCard('${q.id}')">
                        <span class="text-xs font-bold text-gray-300 w-7 shrink-0 text-center">${globalIdx+1}</span>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-800 truncate">${q.text || '<em class="text-gray-400 font-normal">Soal Gambar</em>'}</p>
                            <p class="text-xs text-gray-400 mt-0.5">${(q.options||[]).length} pilihan ‚Ä¢ Kunci: ${labels[q.correct]||q.correct}</p>
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                            <label class="flex items-center gap-1.5 cursor-pointer" onclick="event.stopPropagation()">
                                <div class="relative">
                                    <input type="checkbox" class="sr-only peer" ${isAktif ? 'checked' : ''} onchange="window.toggleAktifSoal('${q.id}', this.checked)">
                                    <div class="w-9 h-5 bg-gray-200 rounded-full peer peer-checked:bg-green-500 transition-colors"></div>
                                    <div class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform peer-checked:translate-x-4"></div>
                                </div>
                                <span class="text-xs font-semibold ${isAktif ? 'text-green-600' : 'text-gray-400'}">${isAktif ? 'Aktif' : 'Nonaktif'}</span>
                            </label>
                            <button onclick="event.stopPropagation(); window.openQuestionModal('${q.id}')" class="p-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button onclick="event.stopPropagation(); window.deleteQuestion('${q.id}')" class="p-1.5 bg-red-50 text-red-500 rounded-lg hover:bg-red-100" title="Hapus"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-300 soal-chevron transition-transform shrink-0"></i>
                        </div>
                    </div>
                    <div class="soal-detail hidden border-t bg-slate-50 px-6 py-4">
                        <div class="mb-3">
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1.5">Pertanyaan</p>
                            <p class="text-sm text-gray-800 leading-relaxed">${q.text || '<em class="text-gray-400">Tidak ada teks</em>'}</p>
                            ${imgHtml}
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Pilihan Jawaban</p>
                            <div class="space-y-1.5">${optionsHtml}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            if (pw) pw.innerHTML = renderPagerHTML('soal', total, pgS.page, pgS.perPage);
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.toggleSoalCard = function(id) {
            const card = document.getElementById(`soal-card-${id}`);
            if (!card) return;
            const detail  = card.querySelector('.soal-detail');
            const chevron = card.querySelector('.soal-chevron');
            const isOpen  = !detail.classList.contains('hidden');
            detail.classList.toggle('hidden', isOpen);
            if (chevron) chevron.style.transform = isOpen ? '' : 'rotate(180deg)';
        };

        window.toggleAktifSoal = async function(id, aktif) {
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            try {
                await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'questions', id), { aktif, updatedAt: Date.now() });
            } catch(e) { alert("Gagal update: " + e.message); }
        };

        // --- STUDENT LOGIN (UPDATED WITH OFFLINE SUPPORT) ---
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // HANDLE STUDENT LOGIN  (alur baru: Login ‚Üí Welcome ‚Üí Ujian)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.handleStudentLogin = async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('btn-student-submit');
            try {
                const name        = document.getElementById('student-name').value.trim();
                const studentNisn = document.getElementById('student-nisn').value.trim();
                const cls         = document.getElementById('student-class').value;
                const room        = document.getElementById('student-room').value;
                const tokenInput  = document.getElementById('student-token').value.trim().toUpperCase();

                if (!name || !studentNisn || !cls || !room || !tokenInput) {
                    alert("Mohon lengkapi semua kolom: Nama, NISN, Kelas, Ruang Ujian, dan Token!");
                    return;
                }

                // ‚îÄ‚îÄ 1. FULLSCREEN segera saat tombol ditekan ‚îÄ‚îÄ
                try {
                    const el = document.documentElement;
                    if (el.requestFullscreen) await el.requestFullscreen().catch(() => {});
                    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                    else if (el.msRequestFullscreen) el.msRequestFullscreen();
                } catch(fsErr) { console.log("FS:", fsErr); }

                // ‚îÄ‚îÄ 2. Cari paket yang cocok dengan token + kelas siswa ‚îÄ‚îÄ
                const paketCocok = (window.allPaketDB || []).filter(p => {
                    if (p.aktif === false) return false;
                    if (!p.token || p.token.toUpperCase() !== tokenInput) return false;
                    // jika paket punya filter kelas, siswa harus masuk salah satunya
                    if (p.kelas && p.kelas.length > 0) {
                        return p.kelas.some(k => k.toLowerCase() === cls.toLowerCase());
                    }
                    return true; // paket terbuka untuk semua kelas
                });

                // ‚îÄ‚îÄ 3. Fallback: token cocok dengan global token ujian ‚îÄ‚îÄ
                if (paketCocok.length === 0 && tokenInput !== window.currentExamToken) {
                    alert("TOKEN SALAH atau tidak ada ujian tersedia untuk kelas " + cls + ".\nMinta token yang benar kepada pengawas.");
                    return;
                }

                // ‚îÄ‚îÄ 4. Cek incognito ‚îÄ‚îÄ
                const isPrivate = await detectPrivateMode();
                if (isPrivate) {
                    const lanjut = confirm(
                        "‚ö†Ô∏è PERINGATAN: BROWSER PRIVATE/INCOGNITO TERDETEKSI\n\n" +
                        "Mode ini DILARANG karena dapat melewati sistem keamanan.\n\n" +
                        "Tekan OK untuk tetap lanjut (TERDATA pelanggaran),\n" +
                        "atau Batal ‚Üí tutup dan buka browser normal."
                    );
                    if (!lanjut) return;
                    violationLogs.push({ time: Date.now(), message: "Login via mode Private/Incognito" });
                }

                // ‚îÄ‚îÄ 5. Cek local session cooldown ‚îÄ‚îÄ
                const localSession = localStorage.getItem('ukktkj_session_done');
                if (localSession) {
                    try {
                        const sd = JSON.parse(localSession);
                        const diffMinutes = (Date.now() - new Date(sd.date).getTime()) / 60000;
                        if (diffMinutes < window.deviceCooldownHours) {   // deviceCooldownHours sekarang = menit
                            const remaining = Math.ceil(window.deviceCooldownHours - diffMinutes);
                            alert(`‚õî PERANGKAT TERKUNCI\n\nBaru digunakan: "${sd.name}" (NISN: ${sd.nisn || '-'}).\nSisa cooldown: ${remaining} menit lagi.`);
                            return;
                        } else { localStorage.removeItem('ukktkj_session_done'); }
                    } catch(_) { localStorage.removeItem('ukktkj_session_done'); }
                }

                if (submitBtn) { submitBtn.disabled = true; submitBtn.querySelector('span').textContent = "Memeriksa..."; }

                // ‚îÄ‚îÄ 6. Cek duplikat / device block di Firebase ‚îÄ‚îÄ
                let isDuplicateName = false, isDeviceBlocked = false, blockedByWho = "";
                if (window.isFirebaseReady && window.db) {
                    try {
                        const fp = getDeviceFingerprint();
                        const qSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));
                        const now = Date.now();
                        qSnap.forEach(ds => {
                            const d = ds.data();
                            if ((now - d.timestamp) / 60000 > window.deviceCooldownHours) return; // deviceCooldownHours = menit
                            const nisnMatch = d.studentNisn && studentNisn && d.studentNisn.toString().trim() === studentNisn.toString().trim();
                            const nameFb   = !d.studentNisn && d.studentName.toLowerCase() === name.toLowerCase() && d.className === cls;
                            if (nisnMatch || nameFb) {
                                if (d.status.includes('SELESAI') || d.status.includes('DISKUALIFIKASI')) isDuplicateName = true;
                            }
                            if (d.deviceFingerprint === fp && (d.status.includes('SELESAI') || d.status.includes('DISKUALIFIKASI'))) {
                                const beda = d.studentNisn && studentNisn ? d.studentNisn.toString() !== studentNisn.toString() : d.studentName.toLowerCase() !== name.toLowerCase();
                                if (beda) { isDeviceBlocked = true; blockedByWho = d.studentName + (d.studentNisn ? ' (NISN: '+d.studentNisn+')' : ''); }
                            }
                        });
                    } catch(dbErr) { console.warn("DB check offline:", dbErr); }
                }

                if (submitBtn) { submitBtn.disabled = false; submitBtn.querySelector('span').textContent = "MASUK"; }

                if (isDuplicateName) {
                    alert(`‚õî AKSES DITOLAK\n\n"${name}" sudah menyelesaikan atau didiskualifikasi.\nLogin ulang tidak diizinkan.`);
                    return;
                }
                if (isDeviceBlocked) {
                    alert(`‚õî PERANGKAT DIBLOKIR\n\nBaru dipakai oleh: "${blockedByWho}".\nGunakan perangkat sendiri. Terkunci ${window.deviceCooldownHours} menit.`);
                    return;
                }

                // ‚îÄ‚îÄ 7. Simpan data login ke global untuk dipakai saat klik paket ‚îÄ‚îÄ
                window._loginData = { name, studentNisn, cls, room, tokenInput, paketCocok };

                // ‚îÄ‚îÄ 8. Tampilkan halaman SELAMAT DATANG ‚îÄ‚îÄ
                document.getElementById('welcome-name').textContent  = name;
                document.getElementById('welcome-nisn').textContent  = studentNisn;
                document.getElementById('welcome-kelas').textContent = cls;
                window.renderWelcomePaketList(paketCocok, cls, tokenInput);

                document.getElementById('section-login').classList.add('hidden-section');
                document.getElementById('section-welcome').classList.remove('hidden-section');
                if (typeof lucide !== 'undefined') lucide.createIcons();

            } catch(err) {
                console.error(err);
                alert("Gagal login: " + err.message);
                if (submitBtn) { submitBtn.disabled = false; submitBtn.querySelector('span').textContent = "MASUK"; }
            }
        };

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Render daftar paket di halaman selamat datang
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.renderWelcomePaketList = function(paketCocok, cls, tokenInput) {
            const container = document.getElementById('welcome-paket-list');
            if (!container) return;

            // Fallback jika tidak ada paket di Firebase tapi token global cocok
            if (paketCocok.length === 0 && tokenInput === window.currentExamToken) {
                const aktifPaket = (window.allPaketDB || []).filter(p => p.aktif !== false);
                paketCocok = aktifPaket.length > 0
                    ? aktifPaket
                    : [{ id: '__fallback_A', nama: 'Ujian Umum', mapel: '', jenis: 'A', token: tokenInput }];
            }

            if (paketCocok.length === 0) {
                container.innerHTML = '<div class="text-center py-6 text-white/40 text-sm">Tidak ada ujian tersedia untuk kelasmu. Hubungi pengawas.</div>';
                return;
            }

            const colors = [
                'from-blue-500 to-blue-700', 'from-indigo-500 to-indigo-700',
                'from-purple-500 to-purple-700', 'from-emerald-500 to-emerald-700',
                'from-rose-500 to-rose-700', 'from-amber-500 to-amber-700',
            ];

            container.innerHTML = paketCocok.map((p, i) => {
                const grad = colors[i % colors.length];
                const jenisLabel = (p.jenis && p.jenis !== 'nonpaket') ? `Paket ${p.jenis}` : 'Ujian';
                return `
                <button onclick="window.startExamFromWelcome('${p.id}')"
                    class="w-full text-left bg-white/6 hover:bg-white/12 border border-white/10 hover:border-white/30 rounded-2xl px-5 py-4 transition-all duration-200 group active:scale-[0.98]">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gradient-to-br ${grad} rounded-xl flex items-center justify-center shrink-0 shadow-lg group-hover:scale-105 transition-transform">
                            <i data-lucide="book-open" class="w-6 h-6 text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-bold text-sm leading-tight truncate">${p.nama}</p>
                            <p class="text-white/45 text-xs mt-0.5">${p.mapel ? p.mapel + ' ¬∑ ' : ''}${jenisLabel}</p>
                        </div>
                        <i data-lucide="arrow-right" class="w-5 h-5 text-white/25 group-hover:text-white group-hover:translate-x-1 transition-all shrink-0"></i>
                    </div>
                </button>`;
            }).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Mulai ujian setelah klik paket di halaman welcome
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.startExamFromWelcome = async function(paketId) {
            try {
                const { name, studentNisn, cls, room, tokenInput } = window._loginData || {};
                if (!name) { alert("Sesi habis. Silakan login ulang."); return; }

                // Cari paket
                const paket = (window.allPaketDB || []).find(p => p.id === paketId);
                const pkt   = paket ? (paket.jenis && paket.jenis !== 'nonpaket' ? paket.jenis : 'A') : 'A';

                // Load soal: utamakan paketId, fallback ke packet letter
                let dbQuestions = paketId.startsWith('__fallback')
                    ? window.allQuestionsDB.filter(q => q.packet === pkt && q.aktif !== false)
                    : window.allQuestionsDB.filter(q => q.paketId === paketId && q.aktif !== false);

                if (dbQuestions.length === 0)
                    dbQuestions = window.allQuestionsDB.filter(q => q.packet === pkt && q.aktif !== false);
                if (dbQuestions.length === 0)
                    dbQuestions = window.allQuestionsDB.filter(q => q.packet === pkt);
                if (dbQuestions.length === 0 && window.questionBank && window.questionBank[pkt])
                    dbQuestions = [...window.questionBank[pkt]];
                if (dbQuestions.length === 0) {
                    alert("Belum ada soal untuk ujian ini. Hubungi pengawas!");
                    return;
                }

                currentStudent = { name, cls, pkt };
                document.getElementById('header-name').innerText   = name;
                document.getElementById('header-detail').innerText = `${cls} ¬∑ ${paket ? paket.nama : 'Paket '+pkt}`;

                currentQuestionList = [...dbQuestions];
                shuffleArray(currentQuestionList);
                violationLogs = [];
                violations    = 0;

                // Simpan/resume sesi Firebase
                let existingActiveDocId = null;
                if (window.isFirebaseReady && window.db) {
                    try {
                        const qSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));
                        qSnap.forEach(ds => {
                            const d = ds.data();
                            const nisnMatch = d.studentNisn && studentNisn && d.studentNisn.toString().trim() === studentNisn.toString().trim();
                            if (nisnMatch && !d.status.includes('SELESAI') && !d.status.includes('DISKUALIFIKASI')) {
                                existingActiveDocId = ds.id; window.examStartTime = d.timestamp;
                            }
                        });
                    } catch(_) {}

                    if (existingActiveDocId) {
                        window.currentExamDocId = existingActiveDocId;
                        await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', existingActiveDocId), {
                            status: "MELANJUTKAN (Re-Login)", packetType: pkt, paketId,
                            ruangUjian: room || '-',
                            deviceFingerprint: getDeviceFingerprint()
                        });
                    } else {
                        const startData = {
                            timestamp: Date.now(), studentName: name, studentNisn,
                            className: cls, ruangUjian: room || '-', packetType: pkt, paketId,
                            sesiId: window.currentSesiId || 'default',
                            sesiName: window.currentSesiName || 'Sesi Default',
                            score: '-', status: "SEDANG MENGERJAKAN",
                            violations: 0, violationLogs: [],
                            deviceFingerprint: getDeviceFingerprint()
                        };
                        window.examStartTime = startData.timestamp;
                        await window.saveExamStart(startData);
                    }
                } else {
                    window.examStartTime = Date.now();
                }

                currentQuestionIndex = 0;
                renderQuestion();
                renderSidebarButtons();

                document.getElementById('section-welcome').classList.add('hidden-section');
                document.getElementById('section-exam').classList.remove('hidden-section');

                window.renderWatermark(name);
                startExamLogic();

            } catch(err) {
                console.error(err);
                alert("Gagal memulai ujian: " + err.message);
            }
        };

        window.switchTeacherSubTab = function(tab) {
            const adminForm = document.getElementById('form-admin-login');
            const pengawasForm = document.getElementById('form-pengawas-login');
            const btnAdmin = document.getElementById('subtab-admin');
            const btnPengawas = document.getElementById('subtab-pengawas');

            if (tab === 'admin') {
                adminForm.classList.remove('hidden-section');
                pengawasForm.classList.add('hidden-section');
                btnAdmin.className = 'flex-1 py-2 text-xs font-bold rounded-lg bg-white text-gray-800 shadow-sm flex items-center justify-center gap-1.5';
                btnPengawas.className = 'flex-1 py-2 text-xs font-bold rounded-lg text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1.5';
            } else {
                adminForm.classList.add('hidden-section');
                pengawasForm.classList.remove('hidden-section');
                btnAdmin.className = 'flex-1 py-2 text-xs font-bold rounded-lg text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1.5';
                btnPengawas.className = 'flex-1 py-2 text-xs font-bold rounded-lg bg-white text-gray-800 shadow-sm flex items-center justify-center gap-1.5';
                // Populate ruang dropdown untuk pengawas
                window.updatePengawasRoomDropdown();
            }
        };

        window.updatePengawasRoomDropdown = function() {
            const sel = document.getElementById('pengawas-room-select');
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Pilih Ruang --</option>';
            (window.ruangList || []).forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = r.nama;
                sel.appendChild(opt);
            });
        };

        window.handleAdminLogin = function(e) {
            e.preventDefault();
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;

            if (u === 'authar' && p === 'Sedayu@123') {
                window.currentUserRole = 'teacher';
                window.currentPengawasRuang = null; // null = semua ruang (admin)
                if(window.setupRealtimeListener) window.setupRealtimeListener();
                if(window.listenForKelas) window.listenForKelas();
                if(window.listenForPaket) window.listenForPaket();
                if(window.listenForRuang) window.listenForRuang();
                if(window.listenForActiveSesi) window.listenForActiveSesi();

                // Update header
                document.getElementById('dash-header-title').textContent = 'Panel Admin / Koordinator';
                document.getElementById('dash-header-subtitle').textContent = 'Akses Penuh ‚Äî Semua Ruang';
                document.getElementById('dash-header-icon').className = 'bg-indigo-600 p-2 rounded-lg';
                document.getElementById('pengawas-room-badge').classList.add('hidden');

                // Tampilkan semua tab (termasuk Ruang)
                document.querySelectorAll('.admin-only-tab').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('.admin-only-panel').forEach(el => {}); // panel tetap hidden, buka via tab

                document.getElementById('section-login').classList.add('hidden-section');
                document.getElementById('section-dashboard').classList.remove('hidden-section');

                const teacherInput = document.getElementById('teacher-token-input');
                if(teacherInput) teacherInput.value = window.currentExamToken;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            } else {
                alert("Username atau Password Admin Salah!");
            }
        };

        window.handlePengawasLogin = function(e) {
            e.preventDefault();
            const ruangId = document.getElementById('pengawas-room-select').value;
            const passInput = document.getElementById('pengawas-pass').value.trim().toUpperCase();

            if (!ruangId) { alert("Silakan pilih ruang ujian terlebih dahulu!"); return; }

            const ruang = (window.ruangList || []).find(r => r.id === ruangId);
            if (!ruang) { alert("Ruang tidak ditemukan. Hubungi Admin."); return; }

            if (!ruang.password || passInput !== ruang.password.trim().toUpperCase()) {
                alert("‚ùå Password Ruang Salah!\n\nPastikan kamu memasukkan password yang benar untuk " + ruang.nama);
                return;
            }

            // Login berhasil sebagai pengawas
            window.currentUserRole = 'teacher';
            window.currentPengawasRuang = ruang; // simpan info ruang yang dijaga

            if(window.setupRealtimeListener) window.setupRealtimeListener();
            if(window.listenForKelas) window.listenForKelas();
            if(window.listenForPaket) window.listenForPaket();

            // Update header untuk pengawas
            document.getElementById('dash-header-title').textContent = 'Monitoring Ruang';
            document.getElementById('dash-header-subtitle').textContent = `Pengawas ${ruang.nama}`;
            document.getElementById('dash-header-icon').className = 'bg-amber-500 p-2 rounded-lg';
            const badge = document.getElementById('pengawas-room-badge');
            badge.classList.remove('hidden');
            badge.classList.add('flex');
            document.getElementById('pengawas-room-label').textContent = ruang.nama;

            // Sembunyikan tab & elemen yang hanya untuk admin
            document.querySelectorAll('.admin-only-tab').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.admin-only-el').forEach(el => el.classList.add('hidden'));

            // Load sesi aktif untuk pengawas
            if(window.listenForActiveSesi) window.listenForActiveSesi();
            if(window.setupRealtimeListener) window.setupRealtimeListener();
            if(window.listenForKelas) window.listenForKelas();
            if(window.listenForPaket) window.listenForPaket();

            // Set filter ruang otomatis ke ruang pengawas
            const filterRuang = document.getElementById('filter-ruang');
            if (filterRuang) {
                setTimeout(() => {
                    filterRuang.value = ruang.nama;
                    if (!filterRuang.value) filterRuang.value = ruangId;
                    window.filterDashboard();
                }, 900);
            }

            document.getElementById('section-login').classList.add('hidden-section');
            document.getElementById('section-dashboard').classList.remove('hidden-section');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.handleTeacherLogin = function(e) {
            // Wrapper lama, sekarang diarahkan ke admin login
            e.preventDefault();
            window.handleAdminLogin(e);
        };

        window.changeQuestion = function(delta) {
            const newIndex = currentQuestionIndex + delta;
            if (newIndex >= 0 && newIndex < currentQuestionList.length) {
                currentQuestionIndex = newIndex;
                renderQuestion();
            }
        };

        window.toggleSidebar = function() {
            const sidebar = document.getElementById('exam-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('sidebar-closed')) {
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.remove('sidebar-open');
                sidebar.classList.add('sidebar-closed');
                overlay.classList.add('hidden');
            }
        };

        // --- CONFIRM FINISH EXAM WITH ANTI-SUBMIT CHECK ---
        window.confirmFinishExam = function() {
            // NEW: Anti-Submit Check
            if (window.currentMinExamDuration > 0 && window.examStartTime) {
                const elapsedMs = Date.now() - window.examStartTime;
                const elapsedMin = elapsedMs / 60000;
                
                if (elapsedMin < window.currentMinExamDuration) {
                    const remaining = Math.ceil(window.currentMinExamDuration - elapsedMin);
                    alert(`‚õî BELUM BISA SUBMIT\n\nAnda baru bisa mengumpulkan jawaban setelah ${window.currentMinExamDuration} menit.\n\nSisa waktu tunggu: ${remaining} menit lagi.\nSilakan periksa kembali jawaban Anda.`);
                    return;
                }
            }

            const answeredCount = Object.keys(userAnswers).length;
            const total = currentQuestionList.length;
            
            let msg = "Apakah Anda yakin ingin menyelesaikan ujian?";
            if (answeredCount < total) {
                msg = `PERHATIAN: Masih ada ${total - answeredCount} soal yang belum dijawab! Yakin mau selesai?`;
            }
            
            document.getElementById('modal-desc').innerText = msg;
            
            const modal = document.getElementById('modal-confirm');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        };

        window.closeModal = function() {
            const modal = document.getElementById('modal-confirm');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        };

        window.finalFinish = function() {
            window.closeModal();
            finishExam();
        };

        window.logout = function() {
            location.reload();
        };
        
        // ====================================================
        // PAGINATION ENGINE ‚Äî shared across all sections
        // ====================================================
        window._pg = {
            monitoring: { page: 1, perPage: 15 },
            paket:      { page: 1, perPage: 9  },
            soal:       { page: 1, perPage: 10 },
            kelas:      { page: 1, perPage: 15 },
            ruang:      { page: 1, perPage: 15 },
        };

        // Render a pager control into a wrapper element
        function renderPagerHTML(section, total, page, perPage) {
            const totalPages = Math.max(1, Math.ceil(total / perPage));
            page = Math.max(1, Math.min(page, totalPages));
            if (total === 0) return '';

            const start = (page - 1) * perPage + 1;
            const end   = Math.min(page * perPage, total);

            const mkBtn = (label, p, disabled, active) =>
                `<button onclick="window.goPage('${section}',${p})"
                    class="min-w-[32px] h-8 px-2 text-xs font-bold rounded-lg border transition-all
                    ${active   ? 'bg-blue-600 text-white border-blue-600 shadow-sm' :
                      disabled ? 'bg-gray-50 text-gray-300 border-gray-100 cursor-default pointer-events-none' :
                                 'bg-white text-gray-600 border-gray-300 hover:bg-blue-50 hover:border-blue-400'}"
                    ${disabled ? 'disabled' : ''}>${label}</button>`;

            let pages = '';
            for (let p = 1; p <= totalPages; p++) {
                const near = p >= page - 2 && p <= page + 2;
                const edge = p === 1 || p === totalPages;
                if (edge || near) {
                    pages += mkBtn(p, p, false, p === page);
                } else if (p === page - 3 || p === page + 3) {
                    pages += `<span class="text-gray-400 text-xs px-1">‚Ä¶</span>`;
                }
            }

            return `<div class="flex items-center justify-between px-5 py-3 bg-gray-50 border-t rounded-b-xl text-sm">
                <span class="text-xs text-gray-500">
                    Data <span class="font-bold text-gray-700">${start}‚Äì${end}</span> dari <span class="font-bold text-gray-700">${total}</span>
                </span>
                <div class="flex items-center gap-1">
                    ${mkBtn('‚Äπ Prev', page-1, page<=1, false)}
                    ${pages}
                    ${mkBtn('Next ‚Ä∫', page+1, page>=totalPages, false)}
                </div>
            </div>`;
        }

        // Called by pager buttons
        window.goPage = function(section, p) {
            if (!window._pg[section]) return;
            window._pg[section].page = p;
            const map = {
                monitoring: () => filterDashboardInternal(),
                paket:      () => window.renderPaketGrid(),
                soal:       () => window.filterQuestionBank(),
                kelas:      () => window.renderKelasList(),
                ruang:      () => window.renderRuangList(),
            };
            if (map[section]) map[section]();
        };
        // ====================================================

        window.filterDashboard = function() {
            filterDashboardInternal();
        };

        window.exportToCSV = function() {
            exportToExcelInternal(); // legacy alias
        };
        window.exportToExcel = function() {
            exportToExcelInternal();
        };

        window.toggleReview = function() {
            const reviewContainer = document.getElementById('review-container');
            const btn = document.getElementById('btn-review');
            
            if(reviewContainer.classList.contains('hidden')) {
                reviewContainer.classList.remove('hidden');
                btn.innerHTML = `<i data-lucide="eye-off" class="w-5 h-5"></i> Tutup Pembahasan`;
                setTimeout(() => {
                    reviewContainer.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            } else {
                reviewContainer.classList.add('hidden');
                btn.innerHTML = `<i data-lucide="book-open" class="w-5 h-5"></i> Lihat Pembahasan`;
                document.getElementById('section-result').scrollTo({ top: 0, behavior: 'smooth' });
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function renderQuestion() {
            if(!currentQuestionList || !currentQuestionList[currentQuestionIndex]) return;
            const q = currentQuestionList[currentQuestionIndex];
            const container = document.getElementById('question-area');
            const total = currentQuestionList.length;
            const labels = ['A','B','C','D','E'];

            let optionsHTML = '';
            q.options.forEach((opt, optIdx) => {
                const isSelected  = userAnswers[q.id] === optIdx;
                const activeClass = isSelected
                    ? "border-blue-500 bg-blue-50 ring-2 ring-blue-400"
                    : "border-gray-200 hover:bg-gray-50 hover:border-gray-300";

                const indicatorClass = isSelected
                    ? "w-7 h-7 rounded-full bg-blue-600 flex items-center justify-center shrink-0 text-white font-bold text-sm shadow"
                    : "w-7 h-7 rounded-full border-2 border-gray-300 flex items-center justify-center shrink-0 text-gray-400 font-bold text-sm";

                const optImg = (q.optionImages && q.optionImages[optIdx]) ? q.optionImages[optIdx] : '';
                const imgHtml = optImg
                    ? `<img src="${optImg}" alt="Gambar pilihan ${labels[optIdx]}" class="mt-2 max-h-28 rounded-lg border object-contain bg-white w-full" onerror="this.style.display='none'">`
                    : '';

                // Layout: jika ada gambar ‚Üí vertikal, jika tidak ‚Üí horizontal
                const innerLayout = optImg
                    ? `<div class="flex flex-col w-full">
                            <div class="flex items-center gap-3">
                                <div class="${indicatorClass}">${labels[optIdx]}</div>
                                ${opt ? `<span class="text-gray-700 text-sm md:text-base font-medium">${opt}</span>` : ''}
                            </div>
                            ${imgHtml}
                       </div>`
                    : `<div class="${indicatorClass}">${labels[optIdx]}</div>
                       <span class="text-gray-700 text-base md:text-lg ml-3">${opt}</span>`;

                optionsHTML += `
                    <label class="flex items-center p-4 rounded-xl border-2 cursor-pointer transition-all mb-3 ${activeClass}" onclick="saveAnswer('${q.id}', ${optIdx}, this)">
                        ${innerLayout}
                    </label>
                `;
            });

            // Gambar soal
            const qImgHtml = q.image
                ? `<div class="my-4 flex justify-center">
                       <img src="${q.image}" alt="Gambar soal" class="max-h-64 rounded-xl border border-gray-200 shadow-sm object-contain bg-white cursor-zoom-in" onclick="window.openImgZoom(this.src)" onerror="this.parentElement.remove()">
                       <p class="text-xs text-gray-400 text-center mt-1">Klik gambar untuk perbesar</p>
                   </div>`
                : '';

            const questionText = q.text
                ? `<p class="text-lg md:text-xl text-gray-800 font-medium leading-relaxed">${q.text}</p>`
                : '';

            const html = `
                <div class="bg-white rounded-xl shadow-sm border p-6 md:p-8 animate-fade-in">
                    <div class="flex flex-col gap-4">
                        <div class="flex justify-between items-start border-b pb-4 mb-2">
                            <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded text-sm font-bold">Soal No. ${currentQuestionIndex + 1}</span>
                            <span class="text-xs text-gray-400">Dari ${total} soal</span>
                        </div>
                        ${questionText}
                        ${qImgHtml}
                        <div class="space-y-1 option-group" id="opts-${q.id}">
                            ${optionsHTML}
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            updateNavButtons();
            renderSidebarButtons();
        }

        // Zoom gambar soal
        window.openImgZoom = function(src) {
            let overlay = document.getElementById('img-zoom-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'img-zoom-overlay';
                overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm cursor-zoom-out';
                overlay.onclick = () => overlay.remove();
                overlay.innerHTML = `<img src="" class="max-w-[90vw] max-h-[90vh] rounded-xl shadow-2xl object-contain" id="img-zoom-img">`;
                document.body.appendChild(overlay);
            }
            document.getElementById('img-zoom-img').src = src;
            overlay.classList.remove('hidden');
        };

        function updateNavButtons() {
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const btnFinish = document.getElementById('btn-finish-main');

            if(btnPrev) btnPrev.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === currentQuestionList.length - 1) {
                if(btnNext) btnNext.classList.add('hidden');
                if(btnFinish) btnFinish.classList.remove('hidden');
            } else {
                if(btnNext) btnNext.classList.remove('hidden');
                if(btnFinish) btnFinish.classList.add('hidden');
            }
        }

        function jumpToQuestion(idx) {
            currentQuestionIndex = idx;
            renderQuestion();
            if (window.innerWidth < 768) {
                window.toggleSidebar();
            }
        }

        window.saveAnswer = function(qId, optIdx, element) {
            userAnswers[qId] = optIdx;
            renderQuestion();
        };

        function renderSidebarButtons() {
            const grid = document.getElementById('question-grid');
            if(!grid) return;
            grid.innerHTML = '';
            
            currentQuestionList.forEach((q, idx) => {
                const isAnswered = userAnswers[q.id] !== undefined;
                const isActive = idx === currentQuestionIndex;
                
                let btnClass = "h-10 w-full rounded font-bold text-sm flex items-center justify-center transition-colors ";
                
                if (isActive) {
                    btnClass += "border-2 border-blue-600 bg-white text-blue-600";
                } else if (isAnswered) {
                    btnClass += "bg-green-500 text-white hover:bg-green-600";
                } else {
                    btnClass += "bg-slate-200 text-slate-600 hover:bg-slate-300";
                }

                const btn = document.createElement('button');
                btn.className = btnClass;
                btn.innerText = idx + 1;
                btn.onclick = () => jumpToQuestion(idx);
                grid.appendChild(btn);
            });
        }

        function startExamLogic() {
            timeLeft = (window.currentExamDuration || 60) * 60;
            
            examTimer = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                const timerDisplay = document.getElementById('timer-display');
                if(timerDisplay) timerDisplay.innerText = `${m}:${s}`;
                
                if (timeLeft < 300) { 
                    const timerBox = document.getElementById('timer-box');
                    if(timerBox) timerBox.className = "flex items-center gap-2 px-4 py-2 rounded-lg font-mono font-bold text-lg bg-red-100 text-red-600";
                }

                if (timeLeft <= 0) {
                    finishExam();
                }
            }, 1000);

            // --- LISTENERS ---
            document.addEventListener("visibilitychange", handleVisibility);
            window.addEventListener("blur", handleBlur); 
            
            // --- NEW: TOLERANSI ROTASI LAYAR ---
            // Saat HP diputar (resize), matikan deteksi blur sebentar
            window.addEventListener("resize", handleResizeToleransi);
            
            document.addEventListener("contextmenu", e => e.preventDefault());

            history.pushState(null, null, location.href);
            window.onpopstate = function () {
                history.go(1);
            };
            window.onbeforeunload = function() {
                return "PERINGATAN: Ujian sedang berlangsung.";
            };
        }

        // --- NEW: FUNGSI HANDLER ROTASI ---
        function handleResizeToleransi() {
            isRotating = true;
            // Beri waktu 1.5 detik toleransi setelah layar diputar
            setTimeout(() => {
                isRotating = false;
            }, 1500);
        }

        function handleVisibility() {
            // Visibility change (pindah tab total/minimize) tetap dianggap curang
            // meski sedang rotasi, karena pindah tab != rotasi
            if (document.hidden) {
                registerViolation("Anda meninggalkan tab ujian!");
            }
        }

        function handleBlur() {
            // JIKA SEDANG ROTASI (isRotating = true), JANGAN ANGGAP CURANG
            if (isRotating) return;

            if (!document.hidden) {
                registerViolation("Terdeteksi interaksi di luar layar ujian (Aplikasi Mengambang/Notifikasi)!");
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ANTI-CHEAT ENGINE ‚Äî VERSI LENGKAP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ‚îÄ‚îÄ ALARM AUDIO 3 LAPIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _audioCtx = null;
        function playAlarm() {
            // Layer 1: Audio URL eksternal
            try {
                const a = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                a.volume = 1.0;
                a.play().catch(() => {});
            } catch(e) {}

            // Layer 2: Web Audio API ‚Äî sirine buatan sendiri (tidak bisa diblokir)
            try {
                if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const ctx = _audioCtx;
                const playTone = (freq, t0, dur) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(freq, t0);
                    osc.frequency.linearRampToValueAtTime(freq * 1.6, t0 + dur * 0.5);
                    osc.frequency.linearRampToValueAtTime(freq, t0 + dur);
                    gain.gain.setValueAtTime(0.45, t0);
                    gain.gain.exponentialRampToValueAtTime(0.001, t0 + dur);
                    osc.start(t0); osc.stop(t0 + dur);
                };
                const now = ctx.currentTime;
                playTone(880, now,       0.28);
                playTone(660, now + 0.30, 0.28);
                playTone(880, now + 0.60, 0.28);
                playTone(440, now + 0.90, 0.50);
            } catch(e) {}

            // Layer 3: Getaran HP Android (Vibrate API)
            try {
                if (navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 600]);
            } catch(e) {}
        }

        // ‚îÄ‚îÄ FLASH LAYAR MERAH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function flashScreen() {
            const flash = document.getElementById('warning-flash');
            if (!flash) return;
            let n = 0;
            const iv = setInterval(() => {
                flash.style.opacity = n % 2 === 0 ? '0.45' : '0';
                if (++n >= 8) { clearInterval(iv); flash.style.opacity = '0'; }
            }, 110);
        }

        // ‚îÄ‚îÄ WATERMARK NAMA SISWA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.renderWatermark = function(name) {
            const overlay = document.getElementById('watermark-overlay');
            const canvas  = document.getElementById('watermark-canvas');
            if (!overlay || !canvas) return;
            overlay.classList.remove('hidden');
            canvas.width  = window.innerWidth;
            canvas.height = window.innerHeight;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#1e3a5f';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            const text = `${name} ‚Ä¢ SI UJIAN TKJ ‚Ä¢ SMKN 1 BRONDONG`;
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(-28 * Math.PI / 180);
            for (let y = -canvas.height * 1.5; y < canvas.height * 1.5; y += 200) {
                for (let x = -canvas.width * 1.5; x < canvas.width * 1.5; x += 380) {
                    ctx.fillText(text, x, y);
                }
            }
            ctx.restore();
        };
        window.clearWatermark = function() {
            const o = document.getElementById('watermark-overlay');
            if (o) o.classList.add('hidden');
        };
        // Redraw saat resize / rotasi layar
        window.addEventListener('resize', () => {
            const nm = document.getElementById('header-name');
            if (nm && nm.innerText && nm.innerText !== 'Nama Siswa')
                window.renderWatermark(nm.innerText);
        });

        // ‚îÄ‚îÄ DETEKSI PRIVATE / INCOGNITO MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function detectPrivateMode() {
            return new Promise(resolve => {
                try {
                    const req = indexedDB.open('__priv_chk__');
                    req.onerror = () => resolve(true); // private mode = IndexedDB error
                    req.onsuccess = (e) => {
                        e.target.result.close();
                        indexedDB.deleteDatabase('__priv_chk__');
                        if (navigator.storage && navigator.storage.estimate) {
                            navigator.storage.estimate().then(est => {
                                // Private mode biasanya quota < 120 MB
                                resolve(est.quota !== undefined && est.quota < 120 * 1024 * 1024);
                            }).catch(() => resolve(false));
                        } else { resolve(false); }
                    };
                } catch(e) { resolve(false); }
            });
        }

        // ‚îÄ‚îÄ MODAL PERINGATAN FULLSCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _warnCdInterval = null;
        window.showWarningModal = function(vNum, message, isDQ) {
            const modal = document.getElementById('modal-warning-student');
            if (!modal) return;
            const studentNm = (document.getElementById('header-name') || {}).innerText || '';
            document.getElementById('ws-name').textContent = studentNm;
            document.getElementById('ws-vcount').textContent = vNum;

            // Judul & warna badge sesuai level
            if (isDQ) {
                document.getElementById('ws-title').textContent = 'DISKUALIFIKASI!';
                document.getElementById('ws-consequence').textContent = 'üíÄ Ujian dihentikan. Nilai dikirim dengan status DISKUALIFIKASI.';
                document.getElementById('ws-consequence').style.color = '#fca5a5';
            } else {
                document.getElementById('ws-title').textContent = 'TERDETEKSI CURANG!';
                if (vNum === 2) {
                    document.getElementById('ws-consequence').textContent = 'üö® PERINGATAN TERAKHIR! Satu lagi = DISKUALIFIKASI OTOMATIS!';
                    document.getElementById('ws-consequence').style.color = '#fbbf24';
                } else {
                    document.getElementById('ws-consequence').textContent = '‚ö° Pelanggaran ke-3 = DISKUALIFIKASI OTOMATIS!';
                    document.getElementById('ws-consequence').style.color = '#fca5a5';
                }
            }

            // Pesan detail sesuai jenis pelanggaran
            const detailMap = {
                'Anda meninggalkan tab ujian!':
                    'üìµ Kamu terdeteksi berpindah tab atau meminimalkan browser!\nIni melanggar aturan ujian yang berlaku.',
                'Terdeteksi interaksi di luar layar ujian (Aplikasi Mengambang/Notifikasi)!':
                    'üì± Terdeteksi ada interaksi di luar layar ujian!\nPastikan tidak ada aplikasi lain yang aktif di atas browser.'
            };
            document.getElementById('ws-detail').textContent = detailMap[message] || message;

            modal.classList.remove('hidden');
            flashScreen();

            // Countdown 5 detik ‚Äî tombol baru aktif setelah hitungan selesai
            let secs = 5;
            const cdEl  = document.getElementById('ws-cd');
            const cdWr  = document.getElementById('ws-cd-wrapper');
            const btn   = document.getElementById('ws-close-btn');
            cdWr.classList.remove('hidden');
            btn.disabled = true;
            btn.className = 'w-full max-w-sm py-4 rounded-2xl font-black text-lg uppercase tracking-widest bg-gray-700 text-gray-500 cursor-not-allowed transition-all duration-500';
            cdEl.textContent = secs;

            if (_warnCdInterval) clearInterval(_warnCdInterval);
            _warnCdInterval = setInterval(() => {
                secs--;
                cdEl.textContent = secs;
                if (secs <= 0) {
                    clearInterval(_warnCdInterval);
                    btn.disabled = false;
                    btn.className = 'w-full max-w-sm py-4 rounded-2xl font-black text-lg uppercase tracking-widest bg-red-600 hover:bg-red-700 text-white cursor-pointer shadow-xl shadow-red-500/50 active:scale-95 transition-all duration-300';
                    cdWr.classList.add('hidden');
                }
            }, 1000);
        };

        window.closeWarningModal = function() {
            const modal = document.getElementById('modal-warning-student');
            if (modal) modal.classList.add('hidden');
            document.getElementById('ws-cd-wrapper').classList.remove('hidden');
            isWarningActive = false;
            if (violations >= 3) _showDQModal();
        };

        function _showDQModal() {
            const modal = document.getElementById('modal-dq-final');
            if (!modal) { finishExam(true); return; }
            modal.classList.remove('hidden');
            const nm = (document.getElementById('header-name') || {}).innerText || '';
            document.getElementById('dq-name').textContent = nm;
            let secs = 5;
            const cdEl = document.getElementById('dq-cd');
            cdEl.textContent = secs;
            const iv = setInterval(() => {
                secs--;
                cdEl.textContent = secs;
                if (secs <= 0) { clearInterval(iv); finishExam(true); }
            }, 1000);
        }

        // ‚îÄ‚îÄ REGISTER VIOLATION (engine utama) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function registerViolation(message) {
            if (isWarningActive) return;
            if (violations >= 3) return;

            isWarningActive = true;
            violations++;
            playAlarm();
            violationLogs.push({ time: Date.now(), message });

            if (window.isFirebaseReady && window.currentExamDocId && window.db) {
                const statusUpdate = violations >= 3 ? "DISKUALIFIKASI (Kecurangan)" : "SEDANG MENGERJAKAN";
                updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', window.currentExamDocId), {
                    violations, violationLogs, status: statusUpdate
                }).catch(console.error);
            }

            // Tampilkan modal fullscreen (bukan alert biasa)
            setTimeout(() => {
                window.showWarningModal(violations, message, violations >= 3);
            }, 150);
        }

        function finishExam(forced = false) {
            clearInterval(examTimer);
            
            // Hapus semua listener saat ujian selesai
            document.removeEventListener("visibilitychange", handleVisibility);
            window.removeEventListener("blur", handleBlur);
            window.removeEventListener("resize", handleResizeToleransi);
            window.onpopstate = null;
            window.onbeforeunload = null;

            // Matikan watermark & tutup modal anti-cheat siswa
            window.clearWatermark();
            const mw = document.getElementById('modal-warning-student');
            if (mw) mw.classList.add('hidden');

            let correctCount = 0;
            currentQuestionList.forEach(q => {
                if (typeof q.correct === 'undefined') return;
                if (userAnswers[q.id] === q.correct) correctCount++;
            });
            const score = Math.round((correctCount / currentQuestionList.length) * 100);

            const resultData = {
                timestamp: Date.now(),
                studentName: currentStudent.name,
				studentNisn: currentStudent.nisn,
                className: currentStudent.cls,
                packetType: currentStudent.pkt,
                score: score,
                status: forced ? "DISKUALIFIKASI (Kecurangan)" : "SELESAI",
                violations: forced ? 3 : violations,
                violationLogs: violationLogs
            };

            if(window.saveExamResult) window.saveExamResult(resultData);

            localStorage.setItem('ukktkj_session_done', JSON.stringify({
                name: currentStudent.name,
                date: new Date().toISOString()
            }));

            const resultIcon = document.getElementById('result-icon-container');
            const resultTitle = document.getElementById('result-title');
            const resultMsg = document.getElementById('result-message');
            const scoreEl = document.getElementById('final-score-display');
            const motivationalEl = document.getElementById('motivational-message');
            const btnReview = document.getElementById('btn-review');
            
            scoreEl.innerText = score;

            if (forced) {
                playAlarm();
                
                resultIcon.className = "w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse";
                resultIcon.innerHTML = `<i data-lucide="alert-octagon" class="w-10 h-10"></i>`;
                
                resultTitle.innerText = "ANDA DIDISKUALIFIKASI";
                resultTitle.className = "text-2xl font-bold text-red-600 mb-2";
                
                resultMsg.innerText = "Setiap kecurangan akan terdeteksi di sistem. Ingat, kejujuran adalah hal terpenting.";
                resultMsg.className = "text-red-500 mb-6 font-bold text-lg";
                
                scoreEl.className = "text-5xl font-extrabold text-red-600";
                
                motivationalEl.innerHTML = `Sistem mencatat 3x pelanggaran. Kejujuran adalah hal terpenting dalam ujian ini.`;
                motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-red-100 text-red-800 border-red-500";
                
                btnReview.style.display = 'none';

            } else {
                resultIcon.className = "w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6";
                resultIcon.innerHTML = `<i data-lucide="check-circle" class="w-10 h-10"></i>`;
                
                resultTitle.innerText = "Ujian Selesai!";
                resultTitle.className = "text-2xl font-bold text-gray-800 mb-2";
                
                resultMsg.innerText = "Jawaban telah terkirim ke server.";
                resultMsg.className = "text-gray-500 mb-6";
                
                if (score < 50) {
                    scoreEl.className = "text-5xl font-extrabold text-red-600";
                    motivationalEl.innerHTML = `üì¢ "Waduh, Monitor Ketua! Sinyal otak sepertinya lagi RTO nih. Jangan panik, remidi adalah jalan ninjaku! Semangat belajar lagi ya! üöÄ"`;
                    motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-red-100 text-red-800 border-red-500";
                } else if (score < 80) {
                    scoreEl.className = "text-5xl font-extrabold text-yellow-600";
                    motivationalEl.innerHTML = `üî• "Lumayan! Dikit lagi jadi sepuh TKJ. Tingkatin lagi belajarnya biar nggak cuma jadi user, tapi jadi admin masa depan!"`;
                    motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-yellow-100 text-yellow-800 border-yellow-500";
                } else {
                    scoreEl.className = "text-5xl font-extrabold text-green-600";
                    motivationalEl.innerHTML = `üëë "Menyala Abangku! üî• Nilai di atas rata-rata. Pertahankan prestasimu, masa depan cerah menanti! Server aman, hati tenang."`;
                    motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-green-100 text-green-800 border-green-500";
                }

                const reviewListEl = document.getElementById('review-list');
                reviewListEl.innerHTML = '';
                
                currentQuestionList.forEach((q, idx) => {
                    if (!q || !q.options) return;

                    const userAnsIdx = userAnswers[q.id];
                    const isCorrect = userAnsIdx === q.correct;
                    const isSkipped = userAnsIdx === undefined;
                    
                    let statusClass = isCorrect ? "bg-green-50 border-green-200" : "bg-red-50 border-red-200";
                    let icon = isCorrect ? `<i data-lucide="check" class="text-green-600 w-5 h-5"></i>` : `<i data-lucide="x" class="text-red-600 w-5 h-5"></i>`;
                    
                    let userAnsText = isSkipped ? "<span class='text-gray-500 italic'>Tidak dijawab</span>" : q.options[userAnsIdx];
                    if (userAnsIdx !== undefined && !userAnsText) userAnsText = "Opsi Tidak Valid";

                    let correctAnsText = q.options[q.correct] || "Kunci Jawaban Tidak Valid";

                    const reviewItem = `
                        <div class="p-4 rounded-lg border ${statusClass}">
                            <div class="flex items-start gap-3">
                                <div class="mt-1 min-w-[20px]">${icon}</div>
                                <div class="w-full">
                                    <p class="font-semibold text-gray-800 mb-2 text-sm md:text-base">
                                        <span class="text-gray-500 mr-1">${idx + 1}.</span> ${q.text}
                                    </p>
                                    
                                    <div class="mt-3 text-sm space-y-1">
                                        <div class="flex flex-col sm:flex-row gap-1 sm:gap-2">
                                            <span class="font-bold text-gray-600 w-24">Jawabanmu:</span>
                                            <span class="${isCorrect ? 'text-green-700 font-medium' : 'text-red-600 font-medium'}">${userAnsText}</span>
                                        </div>
                                        ${!isCorrect ? `
                                        <div class="flex flex-col sm:flex-row gap-1 sm:gap-2">
                                            <span class="font-bold text-gray-600 w-24">Kunci:</span>
                                            <span class="text-green-700 font-bold">${correctAnsText}</span>
                                        </div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    reviewListEl.innerHTML += reviewItem;
                });
                
                btnReview.style.display = 'flex'; 
            }
            
            if(typeof lucide !== 'undefined') lucide.createIcons();

            document.getElementById('section-exam').classList.add('hidden-section');
            document.getElementById('section-result').classList.remove('hidden-section');
        }

        window.updateDashboardTable = function(data) {
            dashboardData = data;
            filterDashboardInternal();
        };

        function filterDashboardInternal() {
            const filterPkt  = document.getElementById('filter-session').value;
            const filterCls  = document.getElementById('filter-class').value;
            const filterDate = document.getElementById('filter-date').value;
            const filterRuangEl = document.getElementById('filter-ruang');
            const filterSesiEl  = document.getElementById('filter-sesi');
            let filterRuang  = filterRuangEl ? filterRuangEl.value : 'all';
            let filterSesi   = filterSesiEl  ? filterSesiEl.value  : 'active';

            // Jika login sebagai pengawas, paksa filter ke ruang mereka
            if (window.currentPengawasRuang) {
                filterRuang = window.currentPengawasRuang.nama;
                if (filterRuangEl) {
                    filterRuangEl.value = filterRuang;
                    filterRuangEl.disabled = true;
                }
                // Pengawas juga hanya lihat sesi aktif (tidak bisa lihat history)
                filterSesi = 'active';
                if (filterSesiEl) { filterSesiEl.value = 'active'; filterSesiEl.disabled = true; }
            } else {
                if (filterRuangEl) filterRuangEl.disabled = false;
                if (filterSesiEl)  filterSesiEl.disabled  = false;
            }

            const tbody = document.getElementById('dashboard-table-body');
            tbody.innerHTML = '';

            window.currentFilteredData = dashboardData.filter(item => {
                // ‚îÄ‚îÄ Filter Sesi ‚îÄ‚îÄ
                let matchSesi = true;
                if (filterSesi === 'active') {
                    // Tampilkan hanya data sesi aktif
                    const activeSesiId = window.currentSesiId || 'default';
                    matchSesi = (item.sesiId === activeSesiId) || 
                                (!item.sesiId && activeSesiId === 'default');
                } else if (filterSesi !== 'all') {
                    // Filter ke sesi spesifik berdasarkan ID
                    matchSesi = item.sesiId === filterSesi;
                }
                // filterSesi === 'all' ‚Üí tampilkan semua

                const matchPkt   = filterPkt === 'all' || item.packetType === filterPkt;
                const matchCls   = filterCls === 'all' || item.className === filterCls;
                const matchRuang = filterRuang === 'all' || (item.ruangUjian || '-') === filterRuang;
                let matchDate = true;
                if (filterDate) {
                    const itemDate = new Date(item.timestamp);
                    const y = itemDate.getFullYear();
                    const m = String(itemDate.getMonth() + 1).padStart(2, '0');
                    const d = String(itemDate.getDate()).padStart(2, '0');
                    const itemDateStr = `${y}-${m}-${d}`;
                    matchDate = itemDateStr === filterDate;
                }
                return matchSesi && matchPkt && matchCls && matchRuang && matchDate;
            });

            // ‚îÄ‚îÄ Update Stat Cards ‚îÄ‚îÄ
            updateStatCards(window.currentFilteredData);

            if (window.currentFilteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-12 text-center text-gray-400">
                    <div class="flex flex-col items-center gap-2">
                        <i data-lucide="inbox" class="w-10 h-10 text-gray-300"></i>
                        <p class="font-semibold">Belum ada peserta</p>
                        <p class="text-xs text-gray-300">${filterSesi === 'active' ? 'Belum ada siswa login di sesi aktif ini.' : 'Tidak ada data yang cocok dengan filter.'}</p>
                    </div>
                </td></tr>`;
                const pw = document.getElementById('pager-monitoring-wrap');
                if (pw) pw.innerHTML = '';
                if(typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ
            const pgM = window._pg.monitoring;
            const totalM = window.currentFilteredData.length;
            pgM.page = Math.max(1, Math.min(pgM.page, Math.ceil(totalM / pgM.perPage)));
            const sliceStart = (pgM.page - 1) * pgM.perPage;
            const pageData = window.currentFilteredData.slice(sliceStart, sliceStart + pgM.perPage);

            pageData.forEach(item => {
                const date = new Date(item.timestamp).toLocaleTimeString('id-ID');

                const isCheating = item.status.includes('DISKUALIFIKASI');
                const isDoing = item.status === 'SEDANG MENGERJAKAN';

                let statusColor = isCheating ? 'text-red-600 font-extrabold flex items-center gap-1' : 'text-green-600 font-bold';
                let rowClass = isCheating ? 'bg-red-50 border-red-200' : 'hover:bg-slate-50 border-b';
                let statusIcon = isCheating ? `<i data-lucide="alert-circle" class="w-4 h-4"></i>` : '';

                if (isDoing) {
                    statusColor = 'text-blue-600 font-bold flex items-center gap-1';
                    rowClass = 'bg-blue-50/50 border-blue-100 hover:bg-blue-50 border-b animate-pulse';
                    statusIcon = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
                }

                const violationDisplay = item.violations > 0
                    ? `<button onclick="window.showViolationDetails('${item.id}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-xs font-bold flex items-center gap-1 mx-auto transition-colors shadow-sm">
                         ${item.violations}x <i data-lucide="info" class="w-3 h-3"></i>
                       </button>`
                    : '-';

                const pktColor = item.packetType === 'A' ? 'bg-blue-100 text-blue-700' : item.packetType === 'B' ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700';
                const ruangLabel = item.ruangUjian || '-';
                const ruangColor = ruangLabel !== '-' ? 'bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs font-bold' : 'text-gray-400 text-xs';
                const sesiInfo = filterSesi === 'all' && item.sesiName
                    ? `<div class="text-[10px] text-indigo-500 font-semibold mt-0.5">${item.sesiName}</div>` : '';

                const row = `
                    <tr class="${rowClass} transition-colors">
                        <td class="px-6 py-4">
                            <div>${date}</div>
                            ${sesiInfo}
                        </td>
                        <td class="px-6 py-4 font-medium text-gray-900">${item.studentName}</td>
                        <td class="px-6 py-4 text-gray-500">${item.studentNisn || '-'}</td>
                        <td class="px-6 py-4 text-gray-500">${item.className}</td>
                        <td class="px-6 py-4"><span class="${ruangColor}">${ruangLabel}</span></td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${pktColor}">Paket ${item.packetType}</span></td>
                        <td class="px-6 py-4 text-center text-lg font-bold text-gray-800">${item.score}</td>
                        <td class="px-6 py-4 ${statusColor}">${statusIcon} ${item.status}</td>
                        <td class="px-6 py-4 text-center">${violationDisplay}</td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="window.deleteExamResult('${item.id}')" class="text-red-500 hover:bg-red-100 p-2 rounded transition-colors" title="Hapus Data">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Render pager
            const pw = document.getElementById('pager-monitoring-wrap');
            if (pw) pw.innerHTML = renderPagerHTML('monitoring', totalM, pgM.page, pgM.perPage);

            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updateStatCards(data) {
            const total    = data.length;
            const selesai  = data.filter(d => d.status === 'SELESAI').length;
            const ongoing  = data.filter(d => d.status === 'SEDANG MENGERJAKAN' || d.status.includes('MELANJUTKAN')).length;
            const dq       = data.filter(d => d.status.includes('DISKUALIFIKASI')).length;
            const withViol = data.filter(d => (d.violations||0) > 0 && !d.status.includes('DISKUALIFIKASI')).length;
            const scores   = data.map(d => typeof d.score === 'number' ? d.score : parseFloat(d.score)).filter(s => !isNaN(s) && s >= 0);
            const avg      = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : null;
            const lulus    = scores.filter(s => s >= 75).length;

            const pct = (n) => total > 0 ? Math.round(n/total*100) : 0;
            const set = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
            const setBar = (id, pctVal) => { const el = document.getElementById(id); if(el) el.style.width = pctVal + '%'; };

            set('sc-total', total);
            set('sc-selesai', selesai);    set('sc-selesai-pct', pct(selesai)+'%');    setBar('sc-bar-selesai', pct(selesai));
            set('sc-ongoing', ongoing);    set('sc-ongoing-pct', pct(ongoing)+'%');    setBar('sc-bar-ongoing', pct(ongoing));
            set('sc-dq', dq);              set('sc-dq-pct', pct(dq)+'%');              setBar('sc-bar-dq', pct(dq));
            set('sc-violations', withViol);set('sc-violations-pct', pct(withViol)+'%');setBar('sc-bar-violations', pct(withViol));
            set('sc-avg', avg !== null ? avg : '‚Äî');
            set('sc-lulus', lulus);        set('sc-lulus-pct', scores.length > 0 ? Math.round(lulus/scores.length*100)+'%' : '0%');
        }

        // ============================================================
        // EXPORT EXCEL PROFESIONAL
        // ============================================================
        function exportToExcelInternal() {
            if (typeof XLSX === 'undefined') { alert("Library XLSX belum siap, coba refresh halaman."); return; }

            const dataToExport = window.currentFilteredData && window.currentFilteredData.length > 0
                ? window.currentFilteredData : dashboardData;

            if (!dataToExport || dataToExport.length === 0) return alert("Belum ada data untuk diexport");

            // --- Info filter untuk judul ---
            const filterPkt  = document.getElementById('filter-session').value;
            const filterCls  = document.getElementById('filter-class').value;
            const filterDate = document.getElementById('filter-date').value;

            const labelPkt  = filterPkt  !== 'all' ? `Paket ${filterPkt}` : 'Semua Paket';
            const labelCls  = filterCls  !== 'all' ? filterCls : 'Semua Kelas';
            const labelDate = filterDate ? filterDate : new Date().toLocaleDateString('id-ID');

            // --- Nama file ---
            let filename = 'Rekap_Nilai';
            if (filterCls  !== 'all') filename += `_${filterCls.replace(/\s+/g,'-')}`;
            if (filterPkt  !== 'all') filename += `_Paket-${filterPkt}`;
            if (filterDate)           filename += `_${filterDate}`;
            filename += '.xlsx';

            // ================================================================
            // KALKULASI STATISTIK
            // ================================================================
            const scores = dataToExport.map(r => typeof r.score === 'number' ? r.score : parseFloat(r.score)).filter(s => !isNaN(s));
            const total      = dataToExport.length;
            const totalSelesai  = dataToExport.filter(r => r.status === 'SELESAI').length;
            const totalDQ       = dataToExport.filter(r => (r.status||'').includes('DISKUALIFIKASI')).length;
            const totalOngoing  = dataToExport.filter(r => r.status === 'SEDANG MENGERJAKAN').length;
            const avgScore   = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0) / scores.length) : 0;
            const maxScore   = scores.length ? Math.max(...scores) : 0;
            const minScore   = scores.length ? Math.min(...scores) : 0;
            const lulus      = scores.filter(s => s >= 75).length;
            const tLulus     = scores.filter(s => s < 75).length;
            const pctLulus   = scores.length ? Math.round((lulus / scores.length) * 100) : 0;

            // ================================================================
            // SHEET 1: REKAP NILAI (utama)
            // ================================================================
            const wb = XLSX.utils.book_new();

            // Baris header dokumen (baris 1-7 = info sekolah + judul)
            const headerRows = [
                ['SMK NEGERI 1 BRONDONG'],                          // R1
                ['Sistem Informasi Ujian (SI UJIAN) - TKJ'],         // R2
                [''],                                                 // R3
                [`Laporan Rekap Nilai Ujian`],                        // R4
                [`Kelas: ${labelCls}  |  Paket: ${labelPkt}  |  Tanggal: ${labelDate}`], // R5
                [`Dicetak: ${new Date().toLocaleString('id-ID')}`],  // R6
                [''],                                                 // R7
            ];

            // Baris kolom tabel
            const colHeaders = [
                'No.', 'Tanggal', 'Jam', 'Nama Siswa', 'NISN', 'Kelas', 'Ruang',
                'Paket', 'Nilai', 'Predikat', 'Status', 'Pelanggaran'
            ];

            // Data baris
            const dataRows = dataToExport.map((row, i) => {
                const dateObj = new Date(row.timestamp);
                const dateStr = dateObj.toLocaleDateString('id-ID');
                const timeStr = dateObj.toLocaleTimeString('id-ID');
                const sc = typeof row.score === 'number' ? row.score : parseFloat(row.score);
                let predikat = '-';
                if (!isNaN(sc)) {
                    if (sc >= 90)      predikat = 'A (Sangat Baik)';
                    else if (sc >= 80) predikat = 'B (Baik)';
                    else if (sc >= 70) predikat = 'C (Cukup)';
                    else if (sc >= 60) predikat = 'D (Kurang)';
                    else               predikat = 'E (Sangat Kurang)';
                }
                return [
                    i + 1,
                    dateStr,
                    timeStr,
                    row.studentName  || '-',
                    row.studentNisn  || '-',
                    row.className    || '-',
                    row.ruangUjian   || '-',
                    `Paket ${row.packetType || '-'}`,
                    isNaN(sc) ? row.score : sc,
                    predikat,
                    row.status       || '-',
                    row.violations   || 0,
                ];
            });

            // Gabungkan semua ke dalam AOA
            const aoa = [
                ...headerRows,
                colHeaders,
                ...dataRows,
                [''], // baris kosong pemisah
            ];

            // Baris statistik di bagian bawah
            const statsStartRow = aoa.length + 1;
            aoa.push(['RINGKASAN STATISTIK']);
            aoa.push(['Total Peserta',     total]);
            aoa.push(['Selesai',           totalSelesai]);
            aoa.push(['Diskualifikasi',    totalDQ]);
            aoa.push(['Sedang Mengerjakan',totalOngoing]);
            aoa.push(['Nilai Rata-rata',   avgScore]);
            aoa.push(['Nilai Tertinggi',   maxScore]);
            aoa.push(['Nilai Terendah',    minScore]);
            aoa.push(['Lulus (‚â•75)',        lulus]);
            aoa.push(['Tidak Lulus (<75)', tLulus]);
            aoa.push(['Persentase Lulus',  `${pctLulus}%`]);

            const ws = XLSX.utils.aoa_to_sheet(aoa);

            // ---- Lebar kolom ----
            ws['!cols'] = [
                {wch: 5},   // No
                {wch: 13},  // Tanggal
                {wch: 10},  // Jam
                {wch: 28},  // Nama
                {wch: 14},  // NISN
                {wch: 12},  // Kelas
                {wch: 10},  // Paket
                {wch: 8},   // Nilai
                {wch: 20},  // Predikat
                {wch: 28},  // Status
                {wch: 12},  // Pelanggaran
            ];

            // ---- Baris header info (merge cells) ----
            // Judul sekolah merge A1:K1
            const lastCol = 10; // index K
            ws['!merges'] = [
                { s:{r:0,c:0}, e:{r:0,c:lastCol} }, // Nama sekolah
                { s:{r:1,c:0}, e:{r:1,c:lastCol} }, // Sistem
                { s:{r:3,c:0}, e:{r:3,c:lastCol} }, // Judul laporan
                { s:{r:4,c:0}, e:{r:4,c:lastCol} }, // Info filter
                { s:{r:5,c:0}, e:{r:5,c:lastCol} }, // Dicetak
                { s:{r:statsStartRow-1,c:0}, e:{r:statsStartRow-1,c:lastCol} }, // Ringkasan header
            ];

            // ---- STYLING menggunakan SheetJS style object ----
            // Helper: set cell style
            function sc_(ws, addr, style) {
                if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                ws[addr].s = style;
            }
            function cellAddr(r, c) {
                return XLSX.utils.encode_cell({r, c});
            }

            // Style definitions
            const styleTitleSchool = {
                font: { bold: true, sz: 16, color: { rgb: '1E3A5F' } },
                alignment: { horizontal: 'center', vertical: 'center' },
                fill: { fgColor: { rgb: 'DBEAFE' } },
            };
            const styleSubtitle = {
                font: { bold: false, sz: 11, color: { rgb: '374151' } },
                alignment: { horizontal: 'center' },
                fill: { fgColor: { rgb: 'DBEAFE' } },
            };
            const styleLaporan = {
                font: { bold: true, sz: 14, color: { rgb: 'FFFFFF' } },
                alignment: { horizontal: 'center', vertical: 'center' },
                fill: { fgColor: { rgb: '1D4ED8' } },
            };
            const styleFilter = {
                font: { sz: 10, color: { rgb: '374151' } },
                alignment: { horizontal: 'center' },
                fill: { fgColor: { rgb: 'EFF6FF' } },
            };
            const stylePrinted = {
                font: { italic: true, sz: 9, color: { rgb: '9CA3AF' } },
                alignment: { horizontal: 'center' },
                fill: { fgColor: { rgb: 'EFF6FF' } },
            };
            const styleColHeader = {
                font: { bold: true, sz: 10, color: { rgb: 'FFFFFF' } },
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                fill: { fgColor: { rgb: '1E40AF' } },
                border: {
                    top:    { style: 'thin', color: { rgb: '93C5FD' } },
                    bottom: { style: 'thin', color: { rgb: '93C5FD' } },
                    left:   { style: 'thin', color: { rgb: '93C5FD' } },
                    right:  { style: 'thin', color: { rgb: '93C5FD' } },
                }
            };
            const styleDataEven = {
                font: { sz: 10 },
                alignment: { vertical: 'center' },
                border: {
                    top:    { style: 'thin', color: { rgb: 'E5E7EB' } },
                    bottom: { style: 'thin', color: { rgb: 'E5E7EB' } },
                    left:   { style: 'thin', color: { rgb: 'E5E7EB' } },
                    right:  { style: 'thin', color: { rgb: 'E5E7EB' } },
                }
            };
            const styleDataOdd = {
                font: { sz: 10 },
                alignment: { vertical: 'center' },
                fill: { fgColor: { rgb: 'F0F9FF' } },
                border: {
                    top:    { style: 'thin', color: { rgb: 'E5E7EB' } },
                    bottom: { style: 'thin', color: { rgb: 'E5E7EB' } },
                    left:   { style: 'thin', color: { rgb: 'E5E7EB' } },
                    right:  { style: 'thin', color: { rgb: 'E5E7EB' } },
                }
            };
            const styleCenter = { alignment: { horizontal: 'center', vertical: 'center' } };
            const styleStatsHeader = {
                font: { bold: true, sz: 11, color: { rgb: 'FFFFFF' } },
                fill: { fgColor: { rgb: '059669' } },
                alignment: { horizontal: 'center' },
            };
            const styleStatsLabel = {
                font: { bold: true, sz: 10, color: { rgb: '065F46' } },
                fill: { fgColor: { rgb: 'D1FAE5' } },
                alignment: { horizontal: 'left' },
                border: { bottom: { style: 'thin', color: { rgb: 'A7F3D0' } } }
            };
            const styleStatsValue = {
                font: { bold: true, sz: 10, color: { rgb: '1D4ED8' } },
                fill: { fgColor: { rgb: 'EFF6FF' } },
                alignment: { horizontal: 'center' },
                border: { bottom: { style: 'thin', color: { rgb: 'BFDBFE' } } }
            };

            // Apply header styles
            for (let c = 0; c <= lastCol; c++) {
                sc_(ws, cellAddr(0, c), styleTitleSchool);
                sc_(ws, cellAddr(1, c), styleSubtitle);
                sc_(ws, cellAddr(3, c), styleLaporan);
                sc_(ws, cellAddr(4, c), styleFilter);
                sc_(ws, cellAddr(5, c), stylePrinted);
            }

            // Row heights (in points)
            ws['!rows'] = [];
            ws['!rows'][0] = { hpt: 30 }; // sekolah
            ws['!rows'][1] = { hpt: 18 };
            ws['!rows'][3] = { hpt: 26 }; // judul laporan
            ws['!rows'][4] = { hpt: 18 };
            ws['!rows'][5] = { hpt: 15 };
            ws['!rows'][7] = { hpt: 22 }; // col headers (row index 7)

            // Apply column header styles (row 7 = index 7)
            const colHeaderRow = 7;
            for (let c = 0; c <= lastCol; c++) {
                sc_(ws, cellAddr(colHeaderRow, c), styleColHeader);
            }

            // Apply data row styles
            dataRows.forEach((row, i) => {
                const r = colHeaderRow + 1 + i;
                const baseStyle = i % 2 === 0 ? styleDataEven : styleDataOdd;
                const sc = row[7]; // nilai (index 7)

                for (let c = 0; c <= lastCol; c++) {
                    let style = JSON.parse(JSON.stringify(baseStyle));

                    // Kolom No, Tanggal, Jam, Paket, Nilai, Predikat, Pelanggaran ‚Üí center
                    if ([0, 1, 2, 6, 7, 8, 10].includes(c)) {
                        style.alignment = { ...style.alignment, horizontal: 'center' };
                    }

                    // Kolom Nilai ‚Äî warnai sesuai nilai
                    if (c === 7 && typeof sc === 'number') {
                        style.font = { bold: true, sz: 11 };
                        if (sc >= 80)      style.font.color = { rgb: '16A34A' };
                        else if (sc >= 75) style.font.color = { rgb: 'D97706' };
                        else               style.font.color = { rgb: 'DC2626' };
                    }

                    // Kolom Status ‚Äî warnai
                    if (c === 9) {
                        const status = row[9] || '';
                        if (status.includes('DISKUALIFIKASI')) {
                            style.font = { bold: true, sz: 10, color: { rgb: 'DC2626' } };
                            style.fill = { fgColor: { rgb: 'FEE2E2' } };
                        } else if (status === 'SELESAI') {
                            style.font = { bold: true, sz: 10, color: { rgb: '16A34A' } };
                        } else if (status === 'SEDANG MENGERJAKAN') {
                            style.font = { bold: false, sz: 10, color: { rgb: '2563EB' } };
                        }
                    }

                    // Kolom Pelanggaran
                    if (c === 10 && row[10] > 0) {
                        style.font = { bold: true, sz: 10, color: { rgb: 'DC2626' } };
                    }

                    sc_(ws, cellAddr(r, c), style);
                }
            });

            // Apply statistik styles
            const statsLabelRow = statsStartRow; // row index di AOA (0-based)
            sc_(ws, cellAddr(statsLabelRow - 1, 0), styleStatsHeader); // "RINGKASAN STATISTIK"
            for (let c = 1; c <= lastCol; c++) sc_(ws, cellAddr(statsLabelRow - 1, c), styleStatsHeader);

            for (let i = 0; i < 11; i++) {
                sc_(ws, cellAddr(statsLabelRow + i, 0), styleStatsLabel);
                sc_(ws, cellAddr(statsLabelRow + i, 1), styleStatsValue);
            }

            XLSX.utils.book_append_sheet(wb, ws, 'Rekap Nilai');

            // ================================================================
            // SHEET 2: ANALISIS PER KELAS
            // ================================================================
            const wsAnalysis = buildAnalysisSheet(dataToExport);
            if (wsAnalysis) XLSX.utils.book_append_sheet(wb, wsAnalysis, 'Analisis Per Kelas');

            // ================================================================
            // SHEET 3: DETAIL PELANGGARAN
            // ================================================================
            const wsPelanggaran = buildPelanggaranSheet(dataToExport);
            if (wsPelanggaran) XLSX.utils.book_append_sheet(wb, wsPelanggaran, 'Detail Pelanggaran');

            // Tulis file
            XLSX.writeFile(wb, filename);
        }

        function buildAnalysisSheet(data) {
            if (!data || data.length === 0) return null;

            // Group by kelas
            const byKelas = {};
            data.forEach(row => {
                const cls = row.className || 'Tidak Diketahui';
                if (!byKelas[cls]) byKelas[cls] = [];
                byKelas[cls].push(row);
            });

            const aoa = [
                ['ANALISIS NILAI PER KELAS'],
                [`Dicetak: ${new Date().toLocaleString('id-ID')}`],
                [''],
                ['Kelas', 'Jumlah Peserta', 'Rata-rata Nilai', 'Nilai Tertinggi', 'Nilai Terendah', 'Lulus (‚â•75)', 'Tidak Lulus', '% Lulus'],
            ];

            Object.entries(byKelas).sort().forEach(([kelas, rows]) => {
                const scores = rows.map(r => typeof r.score === 'number' ? r.score : parseFloat(r.score)).filter(s => !isNaN(s));
                const avg    = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
                const max    = scores.length ? Math.max(...scores) : '-';
                const min    = scores.length ? Math.min(...scores) : '-';
                const lulus  = scores.filter(s => s >= 75).length;
                const tLulus = scores.filter(s => s < 75).length;
                const pct    = scores.length ? Math.round((lulus/scores.length)*100) : 0;
                aoa.push([kelas, rows.length, avg, max, min, lulus, tLulus, `${pct}%`]);
            });

            // Baris total
            aoa.push(['']);
            const allScores = data.map(r => typeof r.score === 'number' ? r.score : parseFloat(r.score)).filter(s => !isNaN(s));
            const totalLulus = allScores.filter(s => s >= 75).length;
            aoa.push([
                'TOTAL / KESELURUHAN',
                data.length,
                allScores.length ? Math.round(allScores.reduce((a,b)=>a+b,0)/allScores.length) : 0,
                allScores.length ? Math.max(...allScores) : '-',
                allScores.length ? Math.min(...allScores) : '-',
                totalLulus,
                allScores.filter(s => s < 75).length,
                allScores.length ? `${Math.round((totalLulus/allScores.length)*100)}%` : '-',
            ]);

            const ws = XLSX.utils.aoa_to_sheet(aoa);
            ws['!cols'] = [{wch:18},{wch:16},{wch:16},{wch:16},{wch:16},{wch:12},{wch:12},{wch:10}];
            ws['!merges'] = [
                { s:{r:0,c:0}, e:{r:0,c:7} },
                { s:{r:1,c:0}, e:{r:1,c:7} },
            ];
            return ws;
        }

        function buildPelanggaranSheet(data) {
            const cheaters = data.filter(r => r.violations > 0 || (r.status||'').includes('DISKUALIFIKASI'));
            if (cheaters.length === 0) return null;

            const aoa = [
                ['LAPORAN DETAIL PELANGGARAN'],
                [`Dicetak: ${new Date().toLocaleString('id-ID')}`],
                [''],
                ['No.', 'Nama Siswa', 'NISN', 'Kelas', 'Paket', 'Nilai', 'Status', 'Jml Pelanggaran', 'Log Pelanggaran'],
            ];

            cheaters.forEach((row, i) => {
                const logs = (row.violationLogs || []).map((l, li) => {
                    const t = new Date(l.time).toLocaleTimeString('id-ID');
                    return `${li+1}. [${t}] ${l.message}`;
                }).join('\n');
                aoa.push([
                    i + 1,
                    row.studentName  || '-',
                    row.studentNisn  || '-',
                    row.className    || '-',
                    `Paket ${row.packetType || '-'}`,
                    row.score,
                    row.status       || '-',
                    row.violations   || 0,
                    logs || 'Tidak ada log',
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(aoa);
            ws['!cols'] = [{wch:5},{wch:28},{wch:14},{wch:12},{wch:10},{wch:8},{wch:28},{wch:15},{wch:60}];
            ws['!merges'] = [
                { s:{r:0,c:0}, e:{r:0,c:8} },
                { s:{r:1,c:0}, e:{r:1,c:8} },
            ];
            return ws;
        }

        // ==========================================
        // IMPORT SOAL - EXCEL & WORD + DOWNLOAD TEMPLATE
        // ==========================================

        // Variabel global untuk menyimpan soal yang sudah di-parse
        window.parsedExcelQuestions = [];
        window.parsedWordQuestions  = [];


        // ---------- DOWNLOAD TEMPLATE EXCEL ----------
        window.downloadExcelTemplate = function() {
            if (typeof XLSX === 'undefined') { alert("Library XLSX belum siap, coba refresh halaman."); return; }

            const wb = XLSX.utils.book_new();

            // Sheet 1: Template kosong
            const header = [['packet','question','question_image','option_a','image_a','option_b','image_b','option_c','image_c','option_d','image_d','option_e','image_e','correct']];
            const contoh = [
                ['A','Apa kepanjangan dari TKJ?','','Teknik Komputer dan Jaringan','','Teknologi Komunikasi Jaringan','','Teknik Komunikasi dan Jaringan','','Teknologi Komputer dan Jaringan','','','','A'],
                ['A','Protokol untuk mengirim email adalah...','','SMTP','','HTTP','','FTP','','SSH','','DNS','','A'],
                ['B','Perhatikan topologi jaringan berikut!','https://drive.google.com/file/d/GANTI_ID_GAMBAR_SOAL/view','Star','','Bus','','Ring','','Mesh','','','','A'],
                ['C','Pilih gambar yang menunjukkan kabel UTP!','','','https://drive.google.com/file/d/GANTI_ID_GAMBAR_A/view','','https://drive.google.com/file/d/GANTI_ID_GAMBAR_B/view','','','','','','','','A'],
            ];
            const wsData = [...header, ...contoh];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Set lebar kolom
            ws['!cols'] = [
                {wch:8},{wch:50},{wch:45},{wch:28},{wch:45},{wch:28},{wch:45},{wch:28},{wch:45},{wch:28},{wch:45},{wch:28},{wch:45},{wch:10}
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Template Soal');

            // Sheet 2: Petunjuk
            const petunjuk = [
                ['PETUNJUK PENGISIAN TEMPLATE SOAL (dengan dukungan gambar)'],
                [''],
                ['Kolom','Keterangan','Contoh'],
                ['packet','Paket soal: A, B, atau C','A'],
                ['question','Teks pertanyaan (boleh kosong jika soal hanya berupa gambar)','Perhatikan gambar topologi berikut!'],
                ['question_image','[OPSIONAL] URL gambar soal dari Google Drive atau URL langsung','https://drive.google.com/file/d/ID_FILE/view'],
                ['option_a','Teks pilihan jawaban A (boleh kosong jika pilihan berupa gambar)','Star Topology'],
                ['image_a','[OPSIONAL] URL gambar untuk pilihan A','https://drive.google.com/file/d/ID_FILE_A/view'],
                ['option_b','Teks pilihan jawaban B','Bus Topology'],
                ['image_b','[OPSIONAL] URL gambar untuk pilihan B',''],
                ['option_c','Teks pilihan jawaban C','Ring Topology'],
                ['image_c','[OPSIONAL] URL gambar untuk pilihan C',''],
                ['option_d','Teks pilihan jawaban D','Mesh Topology'],
                ['image_d','[OPSIONAL] URL gambar untuk pilihan D',''],
                ['option_e','Teks pilihan jawaban E (opsional)',''],
                ['image_e','[OPSIONAL] URL gambar untuk pilihan E',''],
                ['correct','Huruf jawaban benar: A, B, C, D, atau E (WAJIB huruf kapital)','A'],
                [''],
                ['CARA MENDAPATKAN LINK GOOGLE DRIVE:'],
                ['1. Upload gambar ke Google Drive'],
                ['2. Klik kanan file gambar ‚Üí pilih "Bagikan" atau "Share"'],
                ['3. Ubah akses menjadi "Siapa pun yang memiliki link"'],
                ['4. Salin link dan paste di kolom question_image atau image_a/b/c/d/e'],
                ['5. Sistem akan otomatis mengkonversi link ke format yang bisa ditampilkan'],
                [''],
                ['CATATAN PENTING:'],
                ['- Kolom gambar semuanya OPSIONAL, boleh dikosongkan'],
                ['- question + question_image tidak boleh keduanya kosong'],
                ['- Minimal 4 pilihan jawaban (A-D) harus ada, option_e opsional'],
                ['- correct HARUS huruf kapital: A, B, C, D, atau E'],
                ['- Paket harus huruf kapital: A, B, atau C'],
            ];
            const wsPetunjuk = XLSX.utils.aoa_to_sheet(petunjuk);
            wsPetunjuk['!cols'] = [{wch:12},{wch:50},{wch:40}];
            XLSX.utils.book_append_sheet(wb, wsPetunjuk, 'Petunjuk');

            XLSX.writeFile(wb, 'Template_Soal_SIUJIAN.xlsx');
        };

        // ---------- DOWNLOAD TEMPLATE WORD (sebagai HTML yang dibuka Word) ----------
        window.downloadWordTemplate = function() {
            const html = `
<html xmlns:o='urn:schemas-microsoft-com:office:office'
      xmlns:w='urn:schemas-microsoft-com:office:word'
      xmlns='http://www.w3.org/TR/REC-html40'>
<head>
<meta charset='utf-8'>
<title>Template Soal SI UJIAN</title>
<style>
body { font-family: Arial, sans-serif; font-size: 11pt; }
h1 { font-size: 14pt; color: #1d4ed8; }
h2 { font-size: 12pt; color: #374151; }
table { border-collapse: collapse; width: 100%; }
th { background: #1d4ed8; color: white; padding: 8px; border: 1px solid #93c5fd; font-size: 10pt; }
td { padding: 8px; border: 1px solid #d1d5db; font-size: 10pt; vertical-align: top; }
tr:nth-child(even) { background: #eff6ff; }
.note { background: #fef3c7; border: 1px solid #f59e0b; padding: 10px; margin: 10px 0; border-radius: 4px; }
.correct { color: #16a34a; font-weight: bold; }
</style>
</head>
<body>
<h1>Template Soal - SI UJIAN TKJ</h1>
<div class="note">
<strong>&#9888; PETUNJUK PENTING:</strong><br>
&bull; Jangan ubah nama kolom pada baris pertama tabel<br>
&bull; Kolom <b>packet</b>: isi dengan A, B, atau C (huruf kapital)<br>
&bull; Kolom <b>correct</b>: isi dengan huruf kapital A, B, C, D, atau E<br>
&bull; Kolom gambar (<b>question_image, image_a, image_b</b> dst): isi URL Google Drive &mdash; klik kanan file di Drive &rarr; Bagikan &rarr; Salin link<br>
&bull; Kolom gambar boleh dikosongkan (opsional)<br>
&bull; Soal boleh hanya berupa gambar tanpa teks, atau gambar + teks<br>
&bull; Simpan file dalam format .docx sebelum diimport
</div>

<h2>Tabel Soal (isi di bawah baris header)</h2>
<table>
<tr>
<th>packet</th>
<th>question</th>
<th>question_image</th>
<th>option_a</th>
<th>image_a</th>
<th>option_b</th>
<th>image_b</th>
<th>option_c</th>
<th>image_c</th>
<th>option_d</th>
<th>image_d</th>
<th>option_e</th>
<th>image_e</th>
<th>correct</th>
</tr>
<tr>
<td>A</td>
<td>Apa kepanjangan dari TKJ?</td>
<td></td>
<td>Teknik Komputer dan Jaringan</td><td></td>
<td>Teknologi Komunikasi Jaringan</td><td></td>
<td>Teknik Komunikasi dan Jaringan</td><td></td>
<td>Teknologi Komputer dan Jaringan</td><td></td>
<td>Teknik Komputer dan Jasa</td><td></td>
<td class="correct">A</td>
</tr>
<tr>
<td>B</td>
<td>Perhatikan topologi jaringan berikut ini!</td>
<td>https://drive.google.com/file/d/GANTI_ID_GAMBAR_SOAL/view</td>
<td>Star Topology</td><td></td>
<td>Bus Topology</td><td></td>
<td>Ring Topology</td><td></td>
<td>Mesh Topology</td><td></td>
<td></td><td></td>
<td class="correct">A</td>
</tr>
<tr>
<td>C</td>
<td>Pilih gambar yang menunjukkan kabel UTP!</td>
<td></td>
<td></td><td>https://drive.google.com/file/d/ID_GAMBAR_A/view</td>
<td></td><td>https://drive.google.com/file/d/ID_GAMBAR_B/view</td>
<td></td><td>https://drive.google.com/file/d/ID_GAMBAR_C/view</td>
<td></td><td>https://drive.google.com/file/d/ID_GAMBAR_D/view</td>
<td></td><td></td>
<td class="correct">A</td>
</tr>
</table>
<br>
<p><i>Tambahkan soal baru dengan menambah baris di bawah contoh di atas. Hapus baris contoh sebelum diimport jika tidak diperlukan.</i></p>
</body></html>`;

            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Template_Soal_SIUJIAN.doc';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // ---------- HELPER: Build preview table HTML ----------
        function buildPreviewTable(questions) {
            if (!questions || questions.length === 0) return '<p class="p-4 text-gray-400">Tidak ada soal valid yang terdeteksi.</p>';
            const rows = questions.slice(0, 10).map((q, i) => {
                const hasQImg  = q.image ? 'üñºÔ∏è' : '';
                const hasOptImg = (q.optionImages || []).some(x => x) ? 'üñºÔ∏è' : '';
                const pktColor = q.packet==='A'?'bg-blue-100 text-blue-700':q.packet==='B'?'bg-purple-100 text-purple-700':'bg-orange-100 text-orange-700';
                return `<tr class="${i%2===0?'bg-white':'bg-gray-50'}">
                    <td class="px-3 py-2 text-center font-bold text-xs">${i+1}</td>
                    <td class="px-3 py-2"><span class="inline-block px-2 py-0.5 rounded text-xs font-bold ${pktColor}">${q.packet}</span></td>
                    <td class="px-3 py-2 text-xs text-gray-700 max-w-xs truncate">${hasQImg} ${q.text || '<em class="text-gray-400">hanya gambar</em>'}</td>
                    <td class="px-3 py-2 text-xs text-gray-500 text-center">${q.options.length} ${hasOptImg}</td>
                    <td class="px-3 py-2 text-center"><span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">${['A','B','C','D','E'][q.correct]}</span></td>
                </tr>`;
            }).join('');
            const extra = questions.length > 10 ? `<tr><td colspan="5" class="px-3 py-2 text-center text-gray-400 text-xs">... dan ${questions.length-10} soal lainnya</td></tr>` : '';
            return `<table class="w-full text-sm">
                <thead class="bg-gray-100 text-gray-700 text-xs font-bold">
                    <tr><th class="px-3 py-2">#</th><th class="px-3 py-2">Paket</th><th class="px-3 py-2 text-left">Pertanyaan</th><th class="px-3 py-2 text-center">Opsi</th><th class="px-3 py-2">Kunci</th></tr>
                </thead>
                <tbody>${rows}${extra}</tbody>
            </table>`;
        }

        // ---------- HELPER: Parse rows jadi format soal (dengan dukungan gambar) ----------
        function parseRows(rows) {
            const questions  = [];
            const correctMap = { A:0, B:1, C:2, D:3, E:4 };
            rows.forEach((row) => {
                const g = (keys) => { for(const k of keys) { const v = row[k]; if(v !== undefined && v !== null) return v.toString().trim(); } return ''; };

                const packet  = g(['packet','Packet','PACKET']).toUpperCase();
                const text    = g(['question','Question','QUESTION','pertanyaan','soal']);
                const optA    = g(['option_a','Option_A','option_A','a','A','pilihan_a']);
                const optB    = g(['option_b','Option_B','option_B','b','B','pilihan_b']);
                const optC    = g(['option_c','Option_C','option_C','c','C','pilihan_c']);
                const optD    = g(['option_d','Option_D','option_D','d','D','pilihan_d']);
                const optE    = g(['option_e','Option_E','option_E','e','E','pilihan_e']);
                const correct = g(['correct','Correct','CORRECT','kunci','jawaban']).toUpperCase();

                // Gambar soal & gambar tiap opsi (URL Google Drive atau URL biasa)
                const qImg  = g(['question_image','image','gambar_soal','img']);
                const imgA  = g(['image_a','img_a','gambar_a']);
                const imgB  = g(['image_b','img_b','gambar_b']);
                const imgC  = g(['image_c','img_c','gambar_c']);
                const imgD  = g(['image_d','img_d','gambar_d']);
                const imgE  = g(['image_e','img_e','gambar_e']);

                if (!packet || !['A','B','C'].includes(packet)) return;
                if (!text && !qImg) return;  // Boleh hanya gambar tanpa teks
                if (!optA || !optB || !optC || !optD) return;
                if (!(correct in correctMap)) return;

                const options      = [optA, optB, optC, optD];
                const optionImages = [
                    window.convertGDriveUrl(imgA),
                    window.convertGDriveUrl(imgB),
                    window.convertGDriveUrl(imgC),
                    window.convertGDriveUrl(imgD),
                ];
                if (optE) { options.push(optE); optionImages.push(window.convertGDriveUrl(imgE)); }

                questions.push({
                    packet,
                    text,
                    image: window.convertGDriveUrl(qImg),
                    options,
                    optionImages,
                    correct: correctMap[correct],
                    createdAt: Date.now()
                });
            });
            return questions;
        }

        // ---------- EXCEL IMPORT ----------
        window.handleExcelDrop = function(e) {
            e.preventDefault();
            document.getElementById('excel-drop-zone').classList.remove('border-green-500','bg-green-50');
            const file = e.dataTransfer.files[0];
            if (file) window.handleExcelFile(file);
        };

        window.handleExcelFile = function(file) {
            if (!file) return;
            if (typeof XLSX === 'undefined') { alert("Library XLSX belum siap."); return; }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const wb = XLSX.read(e.target.result, { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

                    const questions = parseRows(rows);
                    window.parsedExcelQuestions = questions;

                    document.getElementById('excel-count').innerText = questions.length;
                    document.getElementById('excel-preview-table').innerHTML = buildPreviewTable(questions);
                    document.getElementById('excel-preview').classList.remove('hidden');

                    if (questions.length === 0) {
                        document.getElementById('excel-preview-table').innerHTML = `<div class="p-4 text-red-600 text-sm"><strong>Tidak ada soal valid ditemukan.</strong> Pastikan format kolom sesuai template dan minimal ada 4 pilihan jawaban (A-D).</div>`;
                    }
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                } catch(err) {
                    alert("Gagal membaca file Excel: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.uploadParsedQuestions = async function() {
            if (!window.isFirebaseReady) { alert("Mode Offline: Tidak bisa upload ke database."); return; }
            const questions = window.parsedExcelQuestions;
            if (!questions || questions.length === 0) { alert("Tidak ada soal untuk diupload."); return; }

            const btn = document.getElementById('btn-upload-excel');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Mengupload...`;
            if(typeof lucide !== 'undefined') lucide.createIcons();

            showImportStatus('info', `Mengupload ${questions.length} soal ke database...`);
            let uploaded = 0, skipped = 0;

            try {
                for (const q of questions) {
                    const exists = window.allQuestionsDB.some(dbQ => dbQ.text === q.text && dbQ.packet === q.packet);
                    if (!exists) {
                        await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'), q);
                        uploaded++;
                    } else {
                        skipped++;
                    }
                }
                showImportStatus('success', `‚úÖ Berhasil upload ${uploaded} soal baru! (${skipped} soal duplikat dilewati)`);
                document.getElementById('excel-preview').classList.add('hidden');
                document.getElementById('excel-file-input').value = '';
                window.parsedExcelQuestions = [];
            } catch(err) {
                showImportStatus('error', `‚ùå Gagal upload: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload ke Database`;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
        };

        // ---------- WORD IMPORT ----------
        window.handleWordDrop = function(e) {
            e.preventDefault();
            document.getElementById('word-drop-zone').classList.remove('border-blue-500','bg-blue-50');
            const file = e.dataTransfer.files[0];
            if (file) window.handleWordFile(file);
        };

        window.handleWordFile = function(file) {
            if (!file) return;
            if (!file.name.endsWith('.docx')) { alert("Hanya file .docx yang didukung!"); return; }
            if (typeof mammoth === 'undefined') { alert("Library mammoth belum siap."); return; }

            const logEl = document.getElementById('word-log');
            logEl.classList.remove('hidden');
            logEl.innerText = '‚è≥ Membaca file Word...';

            const reader = new FileReader();
            reader.onload = function(e) {
                mammoth.convertToHtml({ arrayBuffer: e.target.result })
                    .then(result => {
                        const parser = new DOMParser();
                        const docHtml = parser.parseFromString(result.value, 'text/html');
                        const tables = docHtml.querySelectorAll('table');
                        
                        if (tables.length === 0) {
                            logEl.innerText = '‚ö†Ô∏è Tidak ditemukan tabel di dalam file Word. Pastikan soal diformat dalam tabel sesuai template.';
                            return;
                        }

                        // Ambil tabel pertama yang valid
                        let allRows = [];
                        tables.forEach(table => {
                            const rows = table.querySelectorAll('tr');
                            if (rows.length < 2) return;

                            // Cek apakah ini tabel soal (ada header 'packet' atau 'question')
                            const headerCells = rows[0].querySelectorAll('th, td');
                            const headerTexts = Array.from(headerCells).map(c => c.innerText.trim().toLowerCase());
                            if (!headerTexts.includes('packet') && !headerTexts.includes('question')) return;

                            // Parse rows
                            Array.from(rows).slice(1).forEach(row => {
                                const cells = row.querySelectorAll('td, th');
                                if (cells.length < 8) return;
                                const rowData = {};
                                headerTexts.forEach((h, i) => { rowData[h] = cells[i] ? cells[i].innerText.trim() : ''; });
                                allRows.push(rowData);
                            });
                        });

                        const questions = parseRows(allRows);
                        window.parsedWordQuestions = questions;

                        document.getElementById('word-count').innerText = questions.length;
                        document.getElementById('word-preview-table').innerHTML = buildPreviewTable(questions);
                        document.getElementById('word-preview').classList.remove('hidden');

                        if (questions.length === 0) {
                            document.getElementById('word-preview-table').innerHTML = `<div class="p-4 text-red-600 text-sm"><strong>Tidak ada soal valid.</strong> Pastikan tabel di Word sesuai format template (ada header: packet, question, option_a, ..., correct)</div>`;
                            logEl.innerText = `‚ö†Ô∏è ${allRows.length} baris ditemukan tapi tidak ada yang valid. Cek format kolom.`;
                        } else {
                            logEl.classList.add('hidden');
                        }
                        if(typeof lucide !== 'undefined') lucide.createIcons();
                    })
                    .catch(err => {
                        logEl.innerText = '‚ùå Gagal membaca Word: ' + err.message;
                    });
            };
            reader.readAsArrayBuffer(file);
        };

        window.uploadParsedWordQuestions = async function() {
            if (!window.isFirebaseReady) { alert("Mode Offline: Tidak bisa upload ke database."); return; }
            const questions = window.parsedWordQuestions;
            if (!questions || questions.length === 0) { alert("Tidak ada soal untuk diupload."); return; }

            const btn = document.getElementById('btn-upload-word');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Mengupload...`;
            if(typeof lucide !== 'undefined') lucide.createIcons();

            showImportStatus('info', `Mengupload ${questions.length} soal ke database...`);
            let uploaded = 0, skipped = 0;

            try {
                for (const q of questions) {
                    const exists = window.allQuestionsDB.some(dbQ => dbQ.text === q.text && dbQ.packet === q.packet);
                    if (!exists) {
                        await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'), q);
                        uploaded++;
                    } else {
                        skipped++;
                    }
                }
                showImportStatus('success', `‚úÖ Berhasil upload ${uploaded} soal baru dari Word! (${skipped} duplikat dilewati)`);
                document.getElementById('word-preview').classList.add('hidden');
                document.getElementById('word-file-input').value = '';
                document.getElementById('word-log').classList.add('hidden');
                window.parsedWordQuestions = [];
            } catch(err) {
                showImportStatus('error', `‚ùå Gagal upload: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload ke Database`;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
        };

        function showImportStatus(type, msg) {
            const el = document.getElementById('import-status');
            el.classList.remove('hidden', 'bg-blue-50', 'border-blue-200', 'text-blue-800',
                                'bg-green-50', 'border-green-200', 'text-green-800',
                                'bg-red-50', 'border-red-200', 'text-red-800');
            const styles = {
                info:    ['bg-blue-50','border-blue-200','text-blue-800'],
                success: ['bg-green-50','border-green-200','text-green-800'],
                error:   ['bg-red-50','border-red-200','text-red-800'],
            };
            el.classList.add(...(styles[type] || styles.info));
            el.innerText = msg;
            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        if(typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</body>
</html>
