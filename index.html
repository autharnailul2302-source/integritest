<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTEGRITEST</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            if(message.includes("ResizeObserver")) return;
            console.error(message, lineno);
        };

        // ‚îÄ‚îÄ DETEKSI HP KENTANG (Low-end Device) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Aktifkan "perf-mode" untuk HP dengan RAM rendah / CPU lambat
        // Gunakan Navigator deviceMemory + hardwareConcurrency sebagai sinyal
        (function detectLowEndDevice() {
            const mem    = navigator.deviceMemory || 4;       // GB RAM, default 4 jika tidak ada
            const cores  = navigator.hardwareConcurrency || 4; // jumlah CPU core
            const ua     = navigator.userAgent;
            const isOldAndroid = /Android [1-6]\./.test(ua);
            const isLowRam = mem <= 2;
            const isFewCores = cores <= 2;

            if (isOldAndroid || isLowRam || isFewCores) {
                // Tandai body agar CSS perf-mode aktif
                document.addEventListener('DOMContentLoaded', () => {
                    document.body.classList.add('perf-mode');
                    window._perfMode = true;
                    console.log('[PerfMode] HP Kentang terdeteksi ‚Äî animasi dinonaktifkan.');
                });
            } else {
                window._perfMode = false;
            }
        })();
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SheetJS for Excel import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Mammoth.js for Word import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- EXPOSE FIREBASE FUNCTIONS ---
        window.getDocs = getDocs;
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;

        window.db = null;
        window.auth = null;
        window.appId = 'ukktkj'; 
        window.isFirebaseReady = false;
        
        // --- GLOBAL SETTINGS ---
        window.currentExamToken = "TKJ2025"; 
        window.currentExamDuration = 60; 
        window.currentMinExamDuration = 0; 
        window.deviceCooldownHours = 30; // Default 30 Menit (bukan jam)
        window.currentSesiId = null;      // Kompatibilitas mundur (jadwal aktif pertama)
        window.currentSesiName = "Jadwal Aktif"; // Kompatibilitas mundur
        
        window.allQuestionsDB = []; 
        window.currentExamDocId = null; 
        window.examStartTime = null;
        
        // ‚òÖ PEMBAHASAN SETTINGS (NEW) ‚òÖ
        // Admin dapat mengatur kapan siswa boleh melihat pembahasan
        window.showDiscussionAfterExam = true;      // Aktifkan/nonaktifkan pembahasan
        window.discussionVisibility = 'after-exam'; // after-exam | after-deadline | manual | never
        window.manualDiscussionOpen = false;        // Kontrol manual pembukaan pembahasan oleh admin 
        
        // ‚òÖ RECOVERY: Ambil currentExamDocId dari sessionStorage jika ada (untuk handle refresh)
        try {
            const savedDocId = sessionStorage.getItem('ukktkj_current_exam_doc_id');
            if (savedDocId) {
                window.currentExamDocId = savedDocId;
                console.log('[Recovery Init] Memulihkan exam doc ID dari sessionStorage:', savedDocId);
            }
        } catch(e) {}

        // --- DEVICE FINGERPRINTING (REVISED V2) ---
        // UPDATE: Menggunakan key 'v2' untuk mereset ID lama yang mungkin duplikat pada HP sejenis (Oppo/Vivo/Xiaomi)
        function getDeviceFingerprint() {
            // Kita ganti nama key storage agar semua device membuat ID baru yang benar-benar unik
            const STORAGE_KEY = 'ukktkj_device_v2'; 
            let deviceId = localStorage.getItem(STORAGE_KEY);
            
            if (!deviceId) {
                // Generate ID yang dijamin unik menggunakan Timestamp + Math.random
                // Meskipun tipe HP sama persis, Math.random() akan membedakannya
                const timestamp = Date.now().toString(36);
                const randomPart = Math.random().toString(36).substring(2, 10);
                const randomPart2 = Math.random().toString(36).substring(2, 10);
                
                // Format: V2-TIMESTAMP-RANDOM-RANDOM
                deviceId = `V2-${timestamp}-${randomPart}-${randomPart2}`;
                
                // Simpan permanen di HP ini
                try {
                    localStorage.setItem(STORAGE_KEY, deviceId);
                } catch (e) {
                    console.warn("Gagal menyimpan device ID ke local storage (Private Mode?)");
                }
            }
            
            return deviceId;
        }
        // Expose ke global agar bisa diakses dari script non-module
        window.getDeviceFingerprint = getDeviceFingerprint;

        async function initFirebase() {
            // TIME LIMIT FOR CONNECTION
            const connectionTimeout = new Promise((_, reject) => 
                setTimeout(() => reject(new Error("Koneksi Timeout")), 5000)
            );

            try {
                let firebaseConfig;
                const customConfig = {
                    apiKey: "AIzaSyAdqApOvuUXrZUO19NfiqZCLSyUYR74w5M",
                    authDomain: "waliq-ded98.firebaseapp.com",
                    projectId: "waliq-ded98",
                    storageBucket: "waliq-ded98.firebasestorage.app",
                    messagingSenderId: "915222555864",
                    appId: "1:915222555864:web:25320841c97661172e3bad",
                    measurementId: "G-K51RW0YQ0M"
                };

                if (customConfig.apiKey && customConfig.apiKey !== "GANTI_DENGAN_API_KEY_ANDA") {
                    firebaseConfig = customConfig;
                } else if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else {
                    throw new Error("Config Kosong");
                }

                if (typeof __app_id !== 'undefined') window.appId = __app_id;

                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);

                // Race between connection and timeout
                await Promise.race([
                    (async () => {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(window.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    })(),
                    connectionTimeout
                ]);
                
                window.isFirebaseReady = true;
                console.log("Firebase Connected");
                updateConnectionStatus(true, "Terhubung ke Server");
                
                listenForSettings(); 
                listenForQuestions();
                setTimeout(() => { if(window.ensureAdminCredentials) window.ensureAdminCredentials(); }, 1500);
                // Load ruang ujian & sesi aktif untuk dropdown siswa (deferred ke setelah LOGIC SCRIPT dimuat)
                setTimeout(() => { 
                    if (window.listenForRuang) window.listenForRuang();
                    if (window.listenForActiveSesi) window.listenForActiveSesi();
                    // FIX: Kelas harus dimuat untuk SEMUA user (siswa butuh dropdown kelas saat login)
                    if (window.listenForKelas) window.listenForKelas();
                    // FIX KRITIS: Paket harus dimuat untuk SEMUA user ‚Äî tanpa ini allPaketDB kosong untuk siswa
                    // sehingga welcome page selalu kosong atau fallback ke Paket A hardcode
                    if (window.listenForPaket) window.listenForPaket();
                    // Jadwal ujian otomatis
                    if (window.listenForJadwal) window.listenForJadwal();
                    setTimeout(() => {
                        if (window.startJadwalScheduler) window.startJadwalScheduler();
                        if (window.initJadwalForm) window.initJadwalForm();
                    }, 1000);
                }, 500);
                
                if (window.isStaff()) {
                    setupRealtimeListener();
                    window.listenForKelas();
                    window.listenForPaket();
                    window.listenForRuang();
                }

                // ‚òÖ RESTORE SESSION ‚Äî cek sesi admin/pengawas yang tersimpan, delay agar
                // semua listener & data Firestore sudah siap sebelum UI di-restore
                setTimeout(() => {
                    if (window.restoreStaffSession) window.restoreStaffSession();
                }, 900);

            } catch (error) {
                console.warn("Firebase Init Error/Timeout:", error);
                window.isFirebaseReady = false;
                // Tetap izinkan aplikasi berjalan dalam mode offline
                updateConnectionStatus(false, "Mode Offline (Lokal)");
            }
        }
        
        function updateConnectionStatus(isOnline, text) {
            const el = document.getElementById('connection-status');
            if(el) {
                el.innerText = text;
                // Updated styles for better visibility on new background
                el.innerHTML = isOnline 
                    ? `<span class="inline-block w-2 h-2 rounded-full bg-green-400 mr-1 animate-pulse"></span> ${text}`
                    : `<span class="inline-block w-2 h-2 rounded-full bg-red-400 mr-1"></span> ${text}`;
                
                el.className = isOnline 
                    ? "text-[10px] font-bold text-white/90 bg-green-500/20 px-3 py-1 rounded-full border border-green-400/30 backdrop-blur-sm" 
                    : "text-[10px] font-bold text-white/90 bg-red-500/20 px-3 py-1 rounded-full border border-red-400/30 backdrop-blur-sm";
            }
        }

        initFirebase();

        // Listeners
        function listenForSettings() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'app_settings'));
            onSnapshot(q, (snapshot) => {
                let latestTime = 0;
                let latestAppearance = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.timestamp > latestTime) {
                        latestTime = data.timestamp;
                        if (data.token) window.currentExamToken = data.token;
                        if (data.examDuration) window.currentExamDuration = parseInt(data.examDuration);
                        if (data.minDuration) window.currentMinExamDuration = parseInt(data.minDuration); 
                        if (data.deviceCooldown) window.deviceCooldownHours = Math.max(10, parseInt(data.deviceCooldown)); // menit, minimal 10
                        // Appearance ‚Äî gunakan 'in' agar nilai null (dikosongkan user) ikut ter-apply
                        if ('judulUjian' in data) latestAppearance.judulUjian = data.judulUjian ?? '';
                        if ('subJudul'   in data) latestAppearance.subJudul   = data.subJudul   ?? '';
                        if ('motivasi'   in data) latestAppearance.motivasi   = data.motivasi   ?? '';
                        if ('logoUrl'    in data) latestAppearance.logoUrl    = data.logoUrl    ?? '';
                        if (data.nomorIdMode !== undefined) latestAppearance.nomorIdMode = data.nomorIdMode;
                    }
                });
                
                const teacherInput = document.getElementById('teacher-token-input');
                const durationInput = document.getElementById('teacher-duration-input');
                const minDurationInput = document.getElementById('teacher-min-duration-input'); 
                const cooldownInput = document.getElementById('teacher-cooldown-input');
                
                if(teacherInput && document.activeElement !== teacherInput) teacherInput.value = window.currentExamToken;
                if(durationInput && document.activeElement !== durationInput) durationInput.value = window.currentExamDuration;
                if(minDurationInput && document.activeElement !== minDurationInput) minDurationInput.value = window.currentMinExamDuration;
                if(cooldownInput && document.activeElement !== cooldownInput) cooldownInput.value = window.deviceCooldownHours;
                // Selalu update tampilan token di panel pengawas
                if (window.updatePengawasTokenDisplay) window.updatePengawasTokenDisplay();

                // Terapkan pengaturan tampilan ‚Äî selalu apply termasuk saat semua field dikosongkan
                if (latestTime > 0) {
                    window._savedAppearance = latestAppearance;
                    if (window.applyAppearanceSettings) window.applyAppearanceSettings(latestAppearance);
                }
            }, (error) => {
                console.log("Offline mode triggered by snapshot error");
                window.isFirebaseReady = false;
                updateConnectionStatus(false, "Mode Offline (Lokal)");
            });
        }

        function listenForQuestions() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'));
            onSnapshot(q, (snapshot) => {
                window.allQuestionsDB = [];
                snapshot.forEach((doc) => {
                    window.allQuestionsDB.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${window.allQuestionsDB.length} questions from DB`);
                
                if (typeof window.filterQuestionBank === 'function' && !document.getElementById('section-dashboard').classList.contains('hidden-section')) {
                    window.filterQuestionBank();
                }
            }, (err) => {});
        }

        // --- START EXAM LOG ---
        window.saveExamStart = async (data) => {
            if (window.isFirebaseReady && window.db) {
                try {
                    data.deviceFingerprint = getDeviceFingerprint();
                    const docRef = await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'), data);
                    window.currentExamDocId = docRef.id;
                    // Simpan ke sessionStorage agar tidak hilang saat refresh
                    try {
                        sessionStorage.setItem('ukktkj_current_exam_doc_id', docRef.id);
                        sessionStorage.setItem('ukktkj_student_data', JSON.stringify({
                            name: data.studentName,
                            nisn: data.studentNisn,
                            cls: data.className
                        }));
                    } catch(e) {}
                } catch (e) {
                    console.error("Failed to log start", e);
                }
            } else {
                console.log("Offline: Exam start stored locally only");
            }
        }

        // --- SAVE RESULT ---
        window.saveExamResult = async (data) => {
            // ‚òÖ Selalu simpan ke localStorage sebagai backup terlebih dahulu
            try {
                localStorage.setItem('integritest_result_backup', JSON.stringify({...data, savedAt: Date.now()}));
            } catch(e) {}

            const doSave = async () => {
                // Coba ambil currentExamDocId dari sessionStorage jika null
                if (!window.currentExamDocId) {
                    try {
                        const savedDocId = sessionStorage.getItem('ukktkj_current_exam_doc_id');
                        if (savedDocId) {
                            console.log('[Recovery] Menggunakan exam doc ID dari sessionStorage:', savedDocId);
                            window.currentExamDocId = savedDocId;
                        }
                    } catch(e) {}
                }
                
                // Jika masih null, cari dokumen yang sesuai dengan siswa ini
                if (!window.currentExamDocId && window.isFirebaseReady && window.db) {
                    try {
                        console.log('[Recovery] Mencari dokumen exam yang sesuai...');
                        const studentData = data.studentName ? data : 
                            JSON.parse(sessionStorage.getItem('ukktkj_student_data') || '{}');
                        
                        if (studentData.studentName || studentData.name) {
                            const qSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));
                            
                            // Cari dokumen SEDANG MENGERJAKAN/MELANJUTKAN dengan NISN atau nama+kelas yang sama
                            qSnap.forEach(ds => {
                                const d = ds.data();
                                const nisnMatch = d.studentNisn && studentData.studentNisn && 
                                    d.studentNisn.toString().trim() === studentData.studentNisn.toString().trim();
                                const nameMatch = !nisnMatch && 
                                    d.studentName && d.studentName.toLowerCase() === (studentData.studentName || studentData.name).toLowerCase() &&
                                    d.className === studentData.className;
                                
                                if ((nisnMatch || nameMatch) && 
                                    (d.status === 'SEDANG MENGERJAKAN' || d.status.includes('MELANJUTKAN'))) {
                                    window.currentExamDocId = ds.id;
                                    console.log('[Recovery] Ditemukan dokumen exam:', ds.id);
                                }
                            });
                        }
                    } catch(e) {
                        console.error('[Recovery] Gagal mencari dokumen:', e);
                    }
                }
                
                if (window.currentExamDocId) {
                    console.log('[Save] Updating dokumen exam:', window.currentExamDocId);
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', window.currentExamDocId), data);
                } else {
                    console.warn('[Save] currentExamDocId masih null, membuat dokumen baru');
                    const ref = await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'), data);
                    window.currentExamDocId = ref.id;
                    try {
                        sessionStorage.setItem('ukktkj_current_exam_doc_id', ref.id);
                    } catch(e) {}
                }
            };

            if (window.isFirebaseReady && window.db) {
                try {
                    await doSave();
                    console.log('[IntegriTest] Nilai tersimpan ke server.');
                    // Hapus dari sessionStorage setelah berhasil
                    try {
                        sessionStorage.removeItem('ukktkj_current_exam_doc_id');
                    } catch(e) {}
                } catch (e) {
                    console.warn('[IntegriTest] Gagal simpan, retry dalam 3 detik...', e);
                    // Tampilkan banner offline
                    const ob = document.getElementById('offline-result-banner');
                    if (ob) ob.style.display = '';
                    // Retry 1x setelah 3 detik
                    setTimeout(async () => {
                        try {
                            if (window.isFirebaseReady && window.db) {
                                await doSave();
                                console.log('[IntegriTest] Retry berhasil.');
                                const ob2 = document.getElementById('offline-result-banner');
                                if (ob2) { ob2.innerHTML = '<span style="color:#16a34a">‚úÖ Nilai berhasil dikirim ke server!</span>'; }
                                // Hapus dari sessionStorage setelah berhasil
                                try {
                                    sessionStorage.removeItem('ukktkj_current_exam_doc_id');
                                } catch(e) {}
                            }
                        } catch(e2) { console.error('[IntegriTest] Retry gagal.', e2); }
                    }, 3000);
                }
            } else {
                // Mode offline total
                const ob = document.getElementById('offline-result-banner');
                if (ob) ob.style.display = '';
            }
        }

                // --- SAVE SETTINGS (Pengaturan Sistem Ujian SAJA ‚Äî Token, Durasi, Cooldown) ---
        window.saveSettings = async () => {
            const newToken = document.getElementById('teacher-token-input').value.trim().toUpperCase();
            const newDuration = parseInt(document.getElementById('teacher-duration-input').value);
            const newMinDuration = parseInt(document.getElementById('teacher-min-duration-input').value) || 0; 
            const newCooldown = parseInt(document.getElementById('teacher-cooldown-input').value) || 30;

            if(!newToken) return alert("Token tidak boleh kosong!");
            if(!newDuration || newDuration < 1) return alert("Durasi tidak valid (minimal 1 menit)!");
            if(newMinDuration > newDuration) return alert("Durasi minimal tidak boleh lebih besar dari durasi ujian!");
            if(newCooldown < 10) return alert("Cooldown device minimal 10 menit!");

            // Ambil nilai tampilan yang sudah tersimpan agar tidak terhapus
            const savedApp = window._savedAppearance || {};

            if (window.isFirebaseReady && window.db) {
                try {
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'app_settings'), {
                        token: newToken,
                        examDuration: newDuration,
                        minDuration: newMinDuration,
                        deviceCooldown: newCooldown,
                        // Sertakan nilai tampilan yang sudah ada agar tidak tertimpa null
                        judulUjian:   savedApp.judulUjian  ?? null,
                        subJudul:     savedApp.subJudul    ?? null,
                        motivasi:     savedApp.motivasi    ?? null,
                        logoUrl:      savedApp.logoUrl     ?? null,
                        nomorIdMode:  savedApp.nomorIdMode ?? 'nisn',
                        timestamp: Date.now()
                    });
                    alert(`‚úÖ Pengaturan sistem disimpan!\nToken: ${newToken} | Durasi: ${newDuration} mnt | Cooldown: ${newCooldown} mnt`);
                } catch(saveErr) {
                    alert(`‚ùå Gagal simpan ke server: ${saveErr.message}\n\nCek koneksi internet dan coba lagi.`);
                }
            } else {
                alert("Mode Offline: Pengaturan sistem tidak tersimpan ke server.");
            }
        };

        // ‚òÖ PEMBAHASAN SETTINGS FUNCTIONS (NEW) ‚òÖ
        window.saveDiscussionSettings = function() {
            const toggle = document.getElementById('toggle-discussion');
            const mode = document.querySelector('input[name="discussion-mode"]:checked')?.value || 'after-exam';
            
            window.showDiscussionAfterExam = toggle.checked;
            window.discussionVisibility = mode;

            // Update UI status
            window.updateDiscussionUIStatus();

            // Simpan ke localStorage untuk persistensi
            try {
                localStorage.setItem('ukktkj_discussion_settings', JSON.stringify({
                    enabled: window.showDiscussionAfterExam,
                    visibility: window.discussionVisibility,
                    manualOpen: window.manualDiscussionOpen
                }));
            } catch(e) {
                console.warn("Gagal menyimpan discussion settings ke localStorage");
            }

            // Simpan ke Firestore jika available
            if (window.isFirebaseReady && window.currentExamDocId) {
                window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exams', window.currentExamDocId), {
                    discussionEnabled: window.showDiscussionAfterExam,
                    discussionVisibility: window.discussionVisibility,
                }).catch(err => console.warn('Gagal update discussion settings di server:', err));
            }

            alert('‚úÖ Pengaturan pembahasan disimpan!');
        };

        window.updateDiscussionUIStatus = function() {
            const toggle = document.getElementById('toggle-discussion');
            const manualArea = document.getElementById('manual-control-area');
            const statusText = document.getElementById('discussion-status-text');
            const modeRadios = document.querySelectorAll('input[name="discussion-mode"]');
            const selectedMode = document.querySelector('input[name="discussion-mode"]:checked')?.value || 'after-exam';

            // Update visibility manual control area
            if (selectedMode === 'manual') {
                manualArea.classList.remove('hidden');
            } else {
                manualArea.classList.add('hidden');
            }

            // Update status text
            if (!toggle.checked) {
                statusText.innerHTML = '‚ùå Dinonaktifkan - Pembahasan tidak tersedia';
                statusText.className = 'text-red-600 font-bold';
            } else if (selectedMode === 'never') {
                statusText.innerHTML = '‚ùå Jangan Tampilkan - Pembahasan tidak tersedia';
                statusText.className = 'text-red-600 font-bold';
            } else if (selectedMode === 'manual') {
                const isOpen = window.manualDiscussionOpen ? '‚úÖ Dibuka' : '‚è≥ Ditutup';
                statusText.innerHTML = `üîß Manual - ${isOpen}`;
                statusText.className = 'text-amber-600 font-bold';
            } else {
                statusText.innerHTML = '‚úÖ Aktif - Setelah Ujian Selesai';
                statusText.className = 'text-indigo-600 font-bold';
            }
        };

        window.toggleDiscussionManually = function() {
            window.manualDiscussionOpen = !window.manualDiscussionOpen;
            const btn = document.getElementById('btn-toggle-manual-discussion');

            if (window.manualDiscussionOpen) {
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                btn.innerHTML = '<i data-lucide="lock" class="w-5 h-5"></i> Tutup Pembahasan untuk Siswa';
            } else {
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btn.innerHTML = '<i data-lucide="unlock" class="w-5 h-5"></i> Buka Pembahasan untuk Siswa';
            }

            if(typeof lucide !== 'undefined') lucide.createIcons();
            window.updateDiscussionUIStatus();
            
            // Broadcast ke Firestore (untuk update real-time di tab lain)
            if (window.isFirebaseReady && window.currentExamDocId) {
                window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exams', window.currentExamDocId), {
                    manualDiscussionOpen: window.manualDiscussionOpen,
                    discussionOpenedAt: new Date().toISOString()
                }).catch(err => console.warn('Gagal update manual discussion status:', err));
            }

            alert(window.manualDiscussionOpen ? '‚úÖ Pembahasan dibuka!' : 'üîí Pembahasan ditutup!');
        };

        // Load discussion settings dari localStorage saat init
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const saved = localStorage.getItem('ukktkj_discussion_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    window.showDiscussionAfterExam = settings.enabled !== false;
                    window.discussionVisibility = settings.visibility || 'after-exam';
                    window.manualDiscussionOpen = settings.manualOpen || false;

                    // Update UI elements
                    const toggle = document.getElementById('toggle-discussion');
                    if (toggle) {
                        toggle.checked = window.showDiscussionAfterExam;
                    }

                    const modeRadio = document.querySelector(`input[name="discussion-mode"][value="${window.discussionVisibility}"]`);
                    if (modeRadio) {
                        modeRadio.checked = true;
                    }

                    // Add event listeners
                    if (toggle) {
                        toggle.addEventListener('change', window.updateDiscussionUIStatus);
                    }

                    document.querySelectorAll('input[name="discussion-mode"]').forEach(radio => {
                        radio.addEventListener('change', window.updateDiscussionUIStatus);
                    });

                    window.updateDiscussionUIStatus();
                }
            } catch(e) {
                console.warn("Gagal load discussion settings dari localStorage:", e);
            }
        });

        // --- SAVE APPEARANCE ONLY (Pengaturan Tampilan SAJA ‚Äî dari tab Setting Tampilan) ---
        window.saveAppearanceOnly = async () => {
            const savedApp = window._savedAppearance || {};
            const newJudulUjian   = (document.getElementById('setting-judul-ujian')?.value  ?? '').trim();
            const newSubJudul     = (document.getElementById('setting-sub-judul')?.value    ?? '').trim();
            const newMotivasi     = (document.getElementById('setting-motivasi')?.value     ?? '').trim();
            const newLogoUrl      = (document.getElementById('setting-logo-url')?.value     ?? '').trim();
            const newNomorIdMode  = document.getElementById('setting-nomor-id-mode')?.value || savedApp.nomorIdMode || 'nisn';

            if (window.isFirebaseReady && window.db) {
                try {
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'app_settings'), {
                        // Sertakan nilai sistem yang sudah ada agar tidak tertimpa
                        token:        window.currentExamToken       || 'TKJ2025',
                        examDuration: window.currentExamDuration    || 60,
                        minDuration:  window.currentMinExamDuration || 0,
                        deviceCooldown: window.deviceCooldownHours  || 30,
                        judulUjian:   newJudulUjian || null,
                        subJudul:     newSubJudul   || null,
                        motivasi:     newMotivasi   || null,
                        logoUrl:      newLogoUrl    || null,
                        nomorIdMode:  newNomorIdMode,
                        timestamp: Date.now()
                    });
                    // Update cache lokal
                    window._savedAppearance = { judulUjian: newJudulUjian, subJudul: newSubJudul, motivasi: newMotivasi, logoUrl: newLogoUrl, nomorIdMode: newNomorIdMode };
                    // Terapkan ke UI langsung
                    window.applyAppearanceSettings(window._savedAppearance);
                    alert(`‚úÖ Pengaturan tampilan disimpan!`);
                } catch(saveErr) {
                    alert(`‚ùå Gagal simpan ke server: ${saveErr.message}\n\nCek koneksi internet dan coba lagi.`);
                    window.applyAppearanceSettings({ judulUjian: newJudulUjian, subJudul: newSubJudul, motivasi: newMotivasi, logoUrl: newLogoUrl, nomorIdMode: newNomorIdMode });
                }
            } else {
                // Offline ‚Äî terapkan ke UI saja
                window.applyAppearanceSettings({ judulUjian: newJudulUjian, subJudul: newSubJudul, motivasi: newMotivasi, logoUrl: newLogoUrl, nomorIdMode: newNomorIdMode });
                alert("Mode Offline: Pengaturan tampilan diterapkan sementara, tidak tersimpan ke server.");
            }
        };

        window.seedDatabase = async () => {
            if(!window.isFirebaseReady) return alert("Fitur ini butuh koneksi internet (Firebase).");

            // Pastikan questionBank sudah tersedia (didefinisikan di script terpisah)
            const qBank = window.questionBank;
            if (!qBank) return alert("Data soal belum siap, coba refresh halaman.");

            if (!confirm(
                "Upload Soal Bawaan ke Database?\n\n" +
                "Ini akan:\n" +
                "1. Membuat 3 Paket Soal (A, B, C) jika belum ada\n" +
                "2. Mengupload soal ke masing-masing paket\n\n" +
                "Soal duplikat akan dilewati secara otomatis."
            )) return;

            const btn = document.getElementById('btn-seed-db');
            if(btn) { btn.disabled = true; btn.innerText = "‚è≥ Sedang Upload... Jangan tutup halaman ini"; }

            try {
                // ‚îÄ‚îÄ STEP 1: Fetch paket SEGAR dari Firestore (hindari cache stale) ‚îÄ‚îÄ
                const paketSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal'));
                const freshPaket = [];
                paketSnap.forEach(d => freshPaket.push({ id: d.id, ...d.data() }));

                const paketDefs = [
                    { jenis: 'A', nama: 'Paket A - PKK (PKWU)', mapel: 'Produk Kreatif dan Kewirausahaan', token: window.currentExamToken || 'TKJ2025' },
                    { jenis: 'B', nama: 'Paket B - PKK (PKWU)', mapel: 'Produk Kreatif dan Kewirausahaan', token: window.currentExamToken || 'TKJ2025' },
                    { jenis: 'C', nama: 'Paket C - Keamanan Jaringan', mapel: 'Keamanan Jaringan', token: window.currentExamToken || 'TKJ2025' },
                ];

                const paketMap = {}; // jenis -> paketId
                let paketBaru = 0;

                for (const def of paketDefs) {
                    const existing = freshPaket.find(p => p.jenis === def.jenis);
                    if (existing) {
                        paketMap[def.jenis] = existing.id;
                    } else {
                        const ref = await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal'), {
                            ...def, aktif: true, kelas: [], createdAt: Date.now(), updatedAt: Date.now()
                        });
                        paketMap[def.jenis] = ref.id;
                        paketBaru++;
                    }
                }

                // ‚îÄ‚îÄ STEP 2: Fetch soal SEGAR dari Firestore (hindari cache stale) ‚îÄ‚îÄ
                const soalSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'));
                const freshSoal = [];
                soalSnap.forEach(d => freshSoal.push({ id: d.id, ...d.data() }));

                // ‚îÄ‚îÄ STEP 3: Upload soal ke masing-masing paket ‚îÄ‚îÄ
                let count = 0, skipped = 0;

                for (const pkt of ['A', 'B', 'C']) {
                    const questions = qBank[pkt];
                    if (!questions || !questions.length) continue;
                    const paketId = paketMap[pkt];

                    for (const q of questions) {
                        // Cek duplikat berdasarkan teks soal + paketId
                        const duplikat = freshSoal.some(dbQ =>
                            dbQ.paketId === paketId && dbQ.text === q.text
                        );
                        if (duplikat) { skipped++; continue; }

                        await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'), {
                            paketId,
                            packet: pkt,
                            text: q.text,
                            options: q.options,
                            correct: q.correct,
                            aktif: true,
                            createdAt: Date.now(),
                            updatedAt: Date.now()
                        });
                        count++;
                        // Update label progres
                        if(btn) btn.innerText = `‚è≥ Upload soal... (${count} soal)`;
                    }
                }

                alert(`‚úÖ Selesai!\n\nPaket baru dibuat: ${paketBaru}\nPaket diverifikasi: ${3 - paketBaru}\nSoal baru diupload: ${count}\nSoal duplikat dilewati: ${skipped}`);
            } catch (e) {
                console.error(e);
                alert("‚ùå Gagal upload: " + e.message);
            } finally {
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = `<i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload Soal Bawaan ke DB (+ Buat Paket A/B/C)`;
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                }
            }
        };

        window.deleteQuestion = async (id) => {
            if(!window.isFirebaseReady) return alert("Mode Offline.");
            if(!confirm("Hapus soal ini?")) return;
            try { await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'questions', id)); } catch(e) { alert("Gagal hapus: " + e.message); }
        };
        
        window.deleteExamResult = async (id) => {
            if(!window.isFirebaseReady) return alert("Mode Offline.");
            if(!confirm("Apakah Anda yakin ingin MENGHAPUS data ujian siswa ini?\n\nTindakan ini tidak dapat dibatalkan.")) return;
            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', id));
            } catch(e) {
                alert("Gagal menghapus: " + e.message);
            }
        };

        // ‚òÖ FUNGSI BARU: Paksa Selesaikan Ujian Siswa (untuk siswa yang masih "SEDANG MENGERJAKAN")
        window.forceFinishStudent = async (id) => {
            if(!window.isFirebaseReady) return alert("Mode Offline.");
            
            // Cari data siswa
            const studentData = dashboardData.find(item => item.id === id);
            if (!studentData) return alert("Data siswa tidak ditemukan.");
            
            const confirmMsg = `‚ö†Ô∏è PAKSA SELESAIKAN UJIAN\n\n` +
                `Siswa: ${studentData.studentName}\n` +
                `Kelas: ${studentData.className}\n` +
                `Status: ${studentData.status}\n\n` +
                `Tindakan ini akan:\n` +
                `‚Ä¢ Mengubah status menjadi "SELESAI (Paksa oleh Pengawas)"\n` +
                `‚Ä¢ Ujian siswa langsung berakhir\n\n` +
                `Lanjutkan?`;
            
            if(!confirm(confirmMsg)) return;
            
            // Tanya nilai yang akan diberikan
            const scoreInput = prompt(
                `Masukkan nilai untuk ${studentData.studentName}:\n\n` +
                `Ketik angka 0-100, atau ketik "0" jika siswa tidak mengerjakan sama sekali.\n` +
                `Tekan Cancel untuk membatalkan.`,
                "0"
            );
            
            if (scoreInput === null) return; // User cancel
            
            const score = parseInt(scoreInput);
            if (isNaN(score) || score < 0 || score > 100) {
                return alert("‚ùå Nilai tidak valid!\n\nNilai harus berupa angka antara 0-100.");
            }
            
            try {
                const updateData = {
                    status: "SELESAI (Paksa oleh Pengawas)",
                    score: score,
                    scoreNonEssay: score,
                    timestamp: Date.now(), // Update timestamp ke waktu sekarang
                    forcedFinishBy: window.currentPengawasName || window.currentStaffName || 'Admin',
                    forcedFinishAt: Date.now(),
                    note: (studentData.note || '') + `\n[${new Date().toLocaleString('id-ID')}] Ujian dipaksa selesai oleh ${window.currentPengawasName || window.currentStaffName || 'Admin'}. Nilai diberikan manual: ${score}.`
                };
                
                await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', id), updateData);
                
                alert(`‚úÖ Ujian ${studentData.studentName} telah dipaksa selesai.\n\nStatus: SELESAI (Paksa oleh Pengawas)\nNilai: ${score}`);
            } catch(e) {
                alert("Gagal memaksa selesai ujian: " + e.message);
            }
        };

        window.resetAllExamData = async () => {
            if(!window.isFirebaseReady) return alert("Mode Offline.");
            const sesiNama = window.currentSesiName || 'Jadwal Aktif';
            const key = prompt(
                `‚ö†Ô∏è HAPUS DATA SESI INI\n\n` +
                `Anda akan menghapus semua data hasil ujian di "${sesiNama}".\n` +
                `Data sesi lain TIDAK akan terhapus.\n\n` +
                `Ketik 'HAPUS SESI' untuk konfirmasi:`
            );
            
            if (key !== 'HAPUS SESI') {
                return alert("Penghapusan dibatalkan.");
            }

            const btn = document.getElementById('btn-reset-all');
            if(btn) { btn.disabled = true; btn.innerText = "Sedang Menghapus..."; }

            try {
                const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) { alert("Data sudah kosong."); return; }

                const activeSesiId = window.currentSesiId || 'default';
                const jadwalAktifIds = (window.allJadwalDB || []).filter(j => j.isActive).map(j => j.id);
                const toDelete = [];
                snapshot.forEach((d) => {
                    const data = d.data();
                    // Hapus data dari jadwal aktif saat ini
                    const matchSesi = jadwalAktifIds.includes(data.sesiId)
                        || (data.sesiId === activeSesiId)
                        || (!data.sesiId && activeSesiId === 'default');
                    if (matchSesi) toDelete.push(deleteDoc(d.ref));
                });
                
                await Promise.all(toDelete);
                alert(`‚úÖ Berhasil menghapus ${toDelete.length} data ujian dari "${sesiNama}".`);
                
            } catch(e) {
                console.error(e);
                alert("Gagal mereset data: " + e.message);
            } finally {
                if(btn) { btn.disabled = false; btn.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i> Reset Jadwal Ini`; if(typeof lucide !== 'undefined') lucide.createIcons(); }
            }
        };

        // ---- HELPER: Konversi URL Google Drive ke direct link ----
        window.convertGDriveUrl = function(url) {
            if (!url) return '';
            // Format: https://drive.google.com/file/d/FILE_ID/view?...
            const matchFile = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (matchFile) return `https://drive.google.com/uc?export=view&id=${matchFile[1]}`;
            // Format: https://drive.google.com/open?id=FILE_ID
            const matchOpen = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (matchOpen) return `https://drive.google.com/uc?export=view&id=${matchOpen[1]}`;
            // Format lain (langsung URL gambar) - kembalikan apa adanya
            return url;
        };

        // ---- HELPER: Switch tab URL/Upload di editor soal ----
        window.switchImgTab = function(prefix, tab) {
            const urlPanel    = document.getElementById(`${prefix}-img-panel-url`);
            const uploadPanel = document.getElementById(`${prefix}-img-panel-upload`);
            const tabUrl      = document.getElementById(`${prefix}-img-tab-url`);
            const tabUpload   = document.getElementById(`${prefix}-img-tab-upload`);
            if (tab === 'url') {
                urlPanel.classList.remove('hidden');
                uploadPanel.classList.add('hidden');
                tabUrl.className    = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-blue-600 text-white';
                tabUpload.className = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-white text-blue-600 border border-blue-300 hover:bg-blue-50';
            } else {
                urlPanel.classList.add('hidden');
                uploadPanel.classList.remove('hidden');
                tabUrl.className    = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-white text-blue-600 border border-blue-300 hover:bg-blue-50';
                tabUpload.className = 'px-3 py-1.5 text-xs font-bold rounded-lg bg-blue-600 text-white';
            }
        };

        // ---- HELPER: Preview gambar dari URL ----
        window.previewImg = function(prefix, url) {
            const finalUrl = window.convertGDriveUrl(url.trim());
            const preview  = document.getElementById(`${prefix}-img-preview`);
            const img      = document.getElementById(`${prefix}-img-preview-img`);
            const dataEl   = document.getElementById(`${prefix}-image-data`);
            if (finalUrl) {
                img.src = finalUrl;
                preview.classList.remove('hidden');
                dataEl.value = finalUrl;
            } else {
                preview.classList.add('hidden');
                dataEl.value = '';
            }
        };

        // ---- HELPER: Upload gambar ‚Üí Base64 ----
        window.handleImgUpload = function(prefix, input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 900 * 1024) {
                alert('Ukuran gambar terlalu besar (maks 800KB). Kompres dulu gambarnya ya!');
                input.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                const preview = document.getElementById(`${prefix}-img-preview`);
                const img     = document.getElementById(`${prefix}-img-preview-img`);
                const dataEl  = document.getElementById(`${prefix}-image-data`);
                img.src = base64;
                preview.classList.remove('hidden');
                dataEl.value = base64;
            };
            reader.readAsDataURL(file);
        };

        // ---- HELPER: Hapus gambar ----
        window.clearImg = function(prefix) {
            document.getElementById(`${prefix}-img-preview`).classList.add('hidden');
            document.getElementById(`${prefix}-img-preview-img`).src = '';
            document.getElementById(`${prefix}-image-data`).value = '';
            const urlInput = document.getElementById(`${prefix}-image-url`);
            if (urlInput) urlInput.value = '';
            const fileInput = document.getElementById(`${prefix}-img-file`);
            if (fileInput) fileInput.value = '';
        };

        // ---- HELPER: hapus gambar opsi ----
        window.clearOptImg = function(btn) {
            const wrapper = btn.closest('.opt-img-wrapper');
            if (!wrapper) return;
            wrapper.querySelector('.opt-img-preview').classList.add('hidden');
            wrapper.querySelector('.opt-img-preview img').src = '';
            wrapper.querySelector('.opt-image-data').value = '';
            const urlInput = wrapper.querySelector('.opt-image-url');
            if (urlInput) urlInput.value = '';
            const fileInput = wrapper.querySelector('.opt-img-file');
            if (fileInput) fileInput.value = '';
        };

        // ‚îÄ‚îÄ TIPE SOAL TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.setQuestionType = function(tipe) {
            document.getElementById('q-tipe').value = tipe;
            const singleWrap   = document.getElementById('q-correct-single-wrap');
            const multiWrap    = document.getElementById('q-correct-multiple-wrap');
            const tfWrap       = document.getElementById('q-correct-truefalse-wrap');
            const essayWrap    = document.getElementById('q-correct-essay-wrap');
            const singleBtn    = document.getElementById('q-tipe-single-btn');
            const multiBtn     = document.getElementById('q-tipe-multiple-btn');
            const tfBtn        = document.getElementById('q-tipe-truefalse-btn');
            const essayBtn     = document.getElementById('q-tipe-essay-btn');
            const hint         = document.getElementById('q-tipe-hint');
            const optSection   = document.getElementById('q-options-section');
            const tfInfo       = document.getElementById('q-truefalse-info');
            const essayInfo    = document.getElementById('q-essay-info');

            const inactiveClass = 'py-2.5 px-3 rounded-xl border-2 border-gray-200 bg-white text-gray-500 font-bold text-sm flex items-center justify-center gap-2 transition-all';

            // Reset all ‚Äî gunakan null-check agar tidak crash jika elemen tidak ada di HTML
            if (singleWrap) singleWrap.classList.add('hidden');
            if (multiWrap)  multiWrap.classList.add('hidden');
            if (tfWrap)     tfWrap.classList.add('hidden');
            if (essayWrap)  essayWrap.classList.add('hidden');
            if (singleBtn)  singleBtn.className = inactiveClass;
            if (multiBtn)   multiBtn.className  = inactiveClass;
            if (tfBtn)      tfBtn.className     = inactiveClass;
            if (essayBtn)   essayBtn.className  = inactiveClass;
            if (optSection) optSection.classList.remove('hidden');
            if (tfInfo)     tfInfo.classList.add('hidden');
            if (essayInfo)  essayInfo.classList.add('hidden');

            if (tipe === 'multiple') {
                if (multiWrap) multiWrap.classList.remove('hidden');
                if (multiBtn)  multiBtn.className = 'py-2.5 px-3 rounded-xl border-2 border-emerald-500 bg-emerald-50 text-emerald-700 font-bold text-sm flex items-center justify-center gap-2 transition-all';
                if (hint) { hint.textContent = 'Jawaban ganda: siswa harus memilih SEMUA pilihan yang benar.'; hint.className = 'text-xs text-emerald-600 mt-2'; }
            } else if (tipe === 'truefalse') {
                if (tfWrap)  tfWrap.classList.remove('hidden');
                if (tfBtn)   tfBtn.className = 'py-2.5 px-3 rounded-xl border-2 border-amber-500 bg-amber-50 text-amber-700 font-bold text-sm flex items-center justify-center gap-2 transition-all';
                if (hint) { hint.textContent = 'Benar/Salah: siswa memilih apakah pernyataan benar atau salah.'; hint.className = 'text-xs text-amber-600 mt-2'; }
                if (optSection) optSection.classList.add('hidden');
                if (tfInfo)     tfInfo.classList.remove('hidden');
            } else if (tipe === 'essay') {
                if (essayWrap) essayWrap.classList.remove('hidden');
                if (essayBtn)  essayBtn.className = 'py-2.5 px-3 rounded-xl border-2 border-purple-500 bg-purple-50 text-purple-700 font-bold text-sm flex items-center justify-center gap-2 transition-all';
                if (hint) { hint.textContent = 'Esai: siswa menjawab dengan uraian. Dikoreksi AI atau manual guru setelah ujian.'; hint.className = 'text-xs text-purple-600 mt-2'; }
                if (optSection) optSection.classList.add('hidden');
                if (essayInfo)  essayInfo.classList.remove('hidden');
            } else {
                if (singleWrap) singleWrap.classList.remove('hidden');
                if (singleBtn)  singleBtn.className = 'py-2.5 px-3 rounded-xl border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold text-sm flex items-center justify-center gap-2 transition-all';
                if (hint) { hint.textContent = 'Pilihan tunggal: hanya 1 jawaban benar.'; hint.className = 'text-xs text-gray-400 mt-2'; }
            }
        };

        window.openQuestionModal = (id = null) => {
            const modal = document.getElementById('modal-question');
            const form  = document.getElementById('form-question');
            form.reset();
            document.getElementById('q-id').value = id || '';
            document.getElementById('q-options-container').innerHTML = '';
            document.getElementById('q-aktif').checked = true;
            document.getElementById('q-aktif-label').textContent = 'Aktif';
            document.getElementById('q-aktif-label').className = 'text-sm font-bold text-green-600';
            // Reset tipe ke single
            window.setQuestionType('single');
            // Uncheck semua kunci ganda
            document.querySelectorAll('#q-correct-multi-checks input[type=checkbox]').forEach(c => c.checked = false);
            // Uncheck kunci benar/salah
            document.querySelectorAll('input[name="correct-tf"]').forEach(r => r.checked = false);
            // Reset essay fields
            const essayRubrikEl = document.getElementById('q-essay-rubrik');
            const essaySkorEl = document.getElementById('q-essay-skor-maks');
            if (essayRubrikEl) essayRubrikEl.value = '';
            if (essaySkorEl) essaySkorEl.value = '10';

            // Set paket context
            const paket = (window.allPaketDB || []).find(p => p.id === window.activePaketId);
            document.getElementById('q-packet').value = window.activePaketId || '';
            document.getElementById('modal-q-paket-label').textContent = paket ? paket.nama : '‚Äî';

            // Reset gambar soal
            window.clearImg('q');
            window.switchImgTab('q', 'url');

            // aktif toggle
            document.getElementById('q-aktif').onchange = function() {
                const lbl = document.getElementById('q-aktif-label');
                lbl.textContent = this.checked ? 'Aktif' : 'Nonaktif';
                lbl.className = `text-sm font-bold ${this.checked ? 'text-green-600' : 'text-gray-400'}`;
            };

            if (id) {
                document.getElementById('modal-q-title').textContent = 'Edit Soal';
                const q = window.allQuestionsDB.find(x => x.id === id);
                if (q) {
                    // Set tipe soal
                    const tipe = q.tipe || 'single';
                    window.setQuestionType(tipe);
                    if (tipe === 'multiple' && Array.isArray(q.correct)) {
                        document.querySelectorAll('#q-correct-multi-checks input[type=checkbox]').forEach(c => {
                            c.checked = q.correct.includes(parseInt(c.value));
                        });
                    } else if (tipe === 'truefalse') {
                        const tfVal = q.correct === true || q.correct === 'true' ? 'true' : 'false';
                        const tfRadio = document.querySelector(`input[name="correct-tf"][value="${tfVal}"]`);
                        if (tfRadio) tfRadio.checked = true;
                    } else if (tipe === 'essay') {
                        const rubrikEl = document.getElementById('q-essay-rubrik');
                        const skorEl = document.getElementById('q-essay-skor-maks');
                        if (rubrikEl) rubrikEl.value = q.essayRubrik || '';
                        if (skorEl) skorEl.value = q.essaySkorMaks || 10;
                    } else {
                        document.getElementById('q-correct').value = Array.isArray(q.correct) ? q.correct[0] : q.correct;
                    }
                    document.getElementById('q-text').value = q.text || '';
                    const isAktif = q.aktif !== false;
                    document.getElementById('q-aktif').checked = isAktif;
                    document.getElementById('q-aktif-label').textContent = isAktif ? 'Aktif' : 'Nonaktif';
                    document.getElementById('q-aktif-label').className = `text-sm font-bold ${isAktif ? 'text-green-600' : 'text-gray-400'}`;
                    if (q.image) {
                        document.getElementById('q-image-data').value = q.image;
                        const img = document.getElementById('q-img-preview-img');
                        img.src = q.image;
                        document.getElementById('q-img-preview').classList.remove('hidden');
                        if (!q.image.startsWith('data:')) document.getElementById('q-image-url').value = q.image;
                    }
                    q.options.forEach((opt, i) => addOptionInput(opt, q.optionImages ? q.optionImages[i] : ''));
                }
            } else {
                document.getElementById('modal-q-title').textContent = 'Tambah Soal Baru';
                for(let i=0; i<5; i++) addOptionInput('', '');
            }
            modal.classList.remove('hidden');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closeQuestionModal = () => { document.getElementById('modal-question').classList.add('hidden'); };

        window.addOptionInput = (value = '', imgValue = '') => {
            const container = document.getElementById('q-options-container');
            const idx = container.children.length;
            const labels = ['A','B','C','D','E'];
            const div = document.createElement('div');
            div.className = "mb-3 border rounded-xl p-3 bg-gray-50";
            div.innerHTML = `
                <div class="flex gap-2 mb-2 items-center">
                    <span class="py-1.5 px-3 bg-blue-600 text-white rounded-lg text-sm font-bold min-w-[32px] text-center">${labels[idx]||idx}</span>
                    <input type="text" name="options[]" value="${value.replace(/"/g,'&quot;')}" class="flex-1 px-3 py-2 border rounded-lg outline-none focus:ring-1 focus:ring-blue-500 bg-white text-sm" placeholder="Teks pilihan (boleh kosong jika pakai gambar)">
                    <button type="button" onclick="this.closest('.mb-3').remove(); window.reindexOptions()" class="text-red-400 hover:bg-red-50 p-2 rounded-lg shrink-0"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
                <div class="opt-img-wrapper">
                    <div class="flex gap-2 mb-1">
                        <button type="button" onclick="window.switchOptImgTab(this,'url')" class="opt-img-tab-url px-2 py-1 text-xs font-bold rounded bg-purple-600 text-white">üîó URL/Drive</button>
                        <button type="button" onclick="window.switchOptImgTab(this,'upload')" class="opt-img-tab-upload px-2 py-1 text-xs font-bold rounded bg-white text-purple-600 border border-purple-300 hover:bg-purple-50">üìÅ Upload</button>
                        <span class="text-xs text-gray-400 self-center">Gambar pilihan (opsional)</span>
                    </div>
                    <div class="opt-img-panel-url">
                        <input type="text" class="opt-image-url w-full px-2 py-1.5 border rounded text-xs outline-none focus:ring-1 focus:ring-purple-400 bg-white" placeholder="URL gambar atau link Google Drive..." value="${imgValue && !imgValue.startsWith('data:') ? imgValue.replace(/"/g,'&quot;') : ''}" oninput="window.previewOptImg(this)">
                    </div>
                    <div class="opt-img-panel-upload hidden">
                        <div class="border border-dashed border-purple-300 rounded p-2 text-center cursor-pointer hover:bg-purple-50 text-xs text-purple-500" onclick="this.nextElementSibling.click()">üìÅ Pilih gambar...</div>
                        <input type="file" class="opt-img-file hidden" accept="image/*" onchange="window.handleOptImgUpload(this)">
                    </div>
                    <input type="hidden" class="opt-image-data" value="${imgValue ? imgValue.replace(/"/g,'&quot;') : ''}">
                    <div class="opt-img-preview hidden mt-2 flex items-center gap-2">
                        <img src="${imgValue || ''}" class="max-h-20 rounded border border-purple-200 object-contain bg-white" ${imgValue ? '' : 'style="display:none"'}>
                        <button type="button" onclick="window.clearOptImg(this)" class="text-xs text-red-400 hover:underline shrink-0">‚úï Hapus</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
            // Tampilkan preview jika ada gambar awal
            if (imgValue) {
                const preview = div.querySelector('.opt-img-preview');
                const img = preview.querySelector('img');
                preview.classList.remove('hidden');
                img.style.display = '';
                img.src = imgValue;
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.reindexOptions = function() {
            const labels = ['A','B','C','D','E'];
            document.querySelectorAll('#q-options-container > div').forEach((div, i) => {
                const badge = div.querySelector('span.bg-blue-600');
                if (badge) badge.textContent = labels[i] || i;
            });
        };

        window.switchOptImgTab = function(btn, tab) {
            const wrapper = btn.closest('.opt-img-wrapper');
            const urlPanel    = wrapper.querySelector('.opt-img-panel-url');
            const uploadPanel = wrapper.querySelector('.opt-img-panel-upload');
            const tabUrl      = wrapper.querySelector('.opt-img-tab-url');
            const tabUpload   = wrapper.querySelector('.opt-img-tab-upload');
            if (tab === 'url') {
                urlPanel.classList.remove('hidden');
                uploadPanel.classList.add('hidden');
                tabUrl.className    = 'opt-img-tab-url px-2 py-1 text-xs font-bold rounded bg-purple-600 text-white';
                tabUpload.className = 'opt-img-tab-upload px-2 py-1 text-xs font-bold rounded bg-white text-purple-600 border border-purple-300 hover:bg-purple-50';
            } else {
                urlPanel.classList.add('hidden');
                uploadPanel.classList.remove('hidden');
                tabUrl.className    = 'opt-img-tab-url px-2 py-1 text-xs font-bold rounded bg-white text-purple-600 border border-purple-300 hover:bg-purple-50';
                tabUpload.className = 'opt-img-tab-upload px-2 py-1 text-xs font-bold rounded bg-purple-600 text-white';
            }
        };

        window.previewOptImg = function(input) {
            const wrapper = input.closest('.opt-img-wrapper');
            const url = window.convertGDriveUrl(input.value.trim());
            const preview = wrapper.querySelector('.opt-img-preview');
            const img = preview.querySelector('img');
            const dataEl = wrapper.querySelector('.opt-image-data');
            if (url) {
                img.src = url; img.style.display = '';
                preview.classList.remove('hidden');
                dataEl.value = url;
            } else {
                img.style.display = 'none';
                preview.classList.add('hidden');
                dataEl.value = '';
            }
        };

        window.handleOptImgUpload = function(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 900 * 1024) { alert('Gambar terlalu besar (maks 800KB)!'); input.value=''; return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                const wrapper = input.closest('.opt-img-wrapper');
                const preview = wrapper.querySelector('.opt-img-preview');
                const img = preview.querySelector('img');
                const dataEl = wrapper.querySelector('.opt-image-data');
                img.src = e.target.result; img.style.display = '';
                preview.classList.remove('hidden');
                dataEl.value = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        window.saveQuestionSubmit = async (e) => {
            e.preventDefault();
            if(!window.isFirebaseReady) return alert("Mode Offline: Tidak bisa menyimpan soal.");

            const id      = document.getElementById('q-id').value;
            const paketId = document.getElementById('q-packet').value;
            const text    = document.getElementById('q-text').value;
            const tipe    = document.getElementById('q-tipe').value || 'single';
            const image   = document.getElementById('q-image-data').value || '';
            const aktif   = document.getElementById('q-aktif').checked;

            // Derive correct answer(s)
            let correct;
            let essayRubrik = '';
            let essaySkorMaks = 10;
            if (tipe === 'multiple') {
                const checked = Array.from(document.querySelectorAll('#q-correct-multi-checks input[type=checkbox]:checked')).map(c => parseInt(c.value));
                if (checked.length === 0) return alert("Jawaban ganda: centang minimal 1 jawaban yang benar!");
                correct = checked.sort();
            } else if (tipe === 'truefalse') {
                const tfRadio = document.querySelector('input[name="correct-tf"]:checked');
                if (!tfRadio) return alert("Pilih kunci jawaban: BENAR atau SALAH!");
                correct = tfRadio.value === 'true'; // boolean
            } else if (tipe === 'essay') {
                const rubrikEl = document.getElementById('q-essay-rubrik');
                const skorEl = document.getElementById('q-essay-skor-maks');
                essayRubrik = rubrikEl ? rubrikEl.value.trim() : '';
                essaySkorMaks = skorEl ? parseInt(skorEl.value) || 10 : 10;
                if (!essayRubrik) return alert("Soal esai harus memiliki rubrik/kunci jawaban untuk koreksi!");
                correct = null; // essay tidak punya correct index
            } else {
                correct = parseInt(document.getElementById('q-correct').value);
            }

            // Derive packet letter from paket data
            const paket = (window.allPaketDB || []).find(p => p.id === paketId);
            const packet = paket ? (paket.jenis !== 'nonpaket' ? paket.jenis : 'A') : 'A';
            const token  = paket ? paket.token : '';

            const optRows = document.querySelectorAll('#q-options-container > div');
            const options = [], optionImages = [];
            optRows.forEach(row => {
                const textInput = row.querySelector('input[name="options[]"]');
                const imgData   = row.querySelector('.opt-image-data');
                options.push(textInput ? textInput.value : '');
                optionImages.push(imgData ? imgData.value : '');
            });

            if (!text && !image) return alert("Soal harus memiliki teks pertanyaan atau gambar soal!");
            if (tipe !== 'truefalse' && tipe !== 'essay' && options.every(o => !o) && optionImages.every(i => !i)) return alert("Minimal satu pilihan jawaban harus diisi!");

            const data = { paketId, packet, text, options, optionImages, correct, tipe, image, token, aktif, updatedAt: Date.now() };
            if (tipe === 'essay') { data.essayRubrik = essayRubrik; data.essaySkorMaks = essaySkorMaks; }

            try {
                if (id) {
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'questions', id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'), data);
                }
                window.closeQuestionModal();
            } catch (err) { alert("Gagal menyimpan: " + err.message); }
        };

        // ‚îÄ‚îÄ ROLE HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.isAdmin    = () => window.currentUserRole === 'admin';
        window.isPengawas = () => window.currentUserRole === 'pengawas';
        window.isStaff    = () => ['admin','pengawas'].includes(window.currentUserRole);
        window.isSiswa    = () => window.currentUserRole === 'siswa';

        // ‚îÄ‚îÄ UPDATE TOKEN DISPLAY DI UI PENGAWAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.updatePengawasTokenDisplay = function() {
            const container = document.getElementById('pengawas-token-list');
            if (!container) return;

            // Kumpulkan semua jadwal yang sedang aktif bersamaan
            const jadwalAktifList = (window.allJadwalDB || []).filter(j => j.isActive === true);

            if (jadwalAktifList.length > 0) {
                // Tampilkan semua jadwal aktif ‚Äî bisa lebih dari satu di jam yang sama
                container.innerHTML = jadwalAktifList.map(function(jadwal) {
                    const paketJadwal = (window.allPaketDB || []).find(p => p.id === jadwal.paketId);
                    const token = jadwal.tokenCustom
                        ? jadwal.tokenCustom.toUpperCase()
                        : (paketJadwal ? (paketJadwal.token || window.currentExamToken || '‚Äî') : (window.currentExamToken || '‚Äî'));
                    const namaJadwal = jadwal.nama || (paketJadwal ? paketJadwal.nama : '‚Äî');
                    const kelasInfo  = jadwal.kelasArr && jadwal.kelasArr.length
                        ? jadwal.kelasArr.join(', ')
                        : (jadwal.kelas || '');
                    return '<div class="flex flex-col items-center bg-white border-2 border-amber-300 rounded-xl px-5 py-3 min-w-[140px]">' +
                        '<span class="font-mono font-black text-2xl tracking-[0.25em] text-amber-800">' + token + '</span>' +
                        '<span class="text-[10px] text-amber-600 font-bold mt-1 text-center leading-tight">' + namaJadwal + '</span>' +
                        (kelasInfo ? '<span class="text-[9px] text-gray-400 text-center">' + kelasInfo + '</span>' : '') +
                        '<span class="text-[9px] text-green-600 font-bold mt-0.5">‚ö° Aktif ' + jadwal.jamMulai + '‚Äì' + jadwal.jamSelesai + '</span>' +
                    '</div>';
                }).join('');
                return;
            }

            // Tidak ada jadwal aktif ‚Üí cek jadwal hari ini yang belum mulai
            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
            const jadwalHariIni = (window.allJadwalDB || []).filter(j =>
                j.tanggal === todayStr && timeStr < j.jamSelesai && !j.sudahDijalankan
            );

            if (jadwalHariIni.length > 0) {
                const berikutnya = jadwalHariIni.sort((a,b) => a.jamMulai.localeCompare(b.jamMulai))[0];
                container.innerHTML =
                    '<div class="flex flex-col items-center bg-gray-50 border-2 border-gray-200 rounded-xl px-5 py-3 min-w-[140px] text-center">' +
                        '<span class="text-xs font-bold text-gray-400">‚è≥ Menunggu Jadwal</span>' +
                        '<span class="text-sm font-black text-gray-600 mt-1">' + (berikutnya.nama || '‚Äî') + '</span>' +
                        '<span class="text-[10px] text-gray-400 mt-0.5">Mulai pukul ' + berikutnya.jamMulai + '</span>' +
                    '</div>';
                return;
            }

            // Tidak ada jadwal ‚Üí fallback token global
            const globalToken = window.currentExamToken || '‚Äî';
            container.innerHTML =
                '<div class="flex items-center gap-3 bg-white border border-amber-200 rounded-xl px-4 py-2.5">' +
                    '<span class="font-mono font-black text-2xl tracking-[0.25em] text-amber-800">' + globalToken + '</span>' +
                    '<span class="text-[10px] text-amber-400 font-semibold">(Token Global)</span>' +
                '</div>';
        };

        window.setupRealtimeListener = () => {
            if (!window.isFirebaseReady || !window.db) return;

            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));

            // FIX 1: Tandai dokumen yang sudah ada saat listener pertama kali aktif.
            // Dengan menyimpan set ID awal, kita bisa membedakan data LAMA vs data BARU
            // sehingga alert hanya muncul untuk kejadian yang benar-benar baru terjadi,
            // tapi tabel monitoring tetap langsung menampilkan SEMUA data (termasuk SEDANG MENGERJAKAN).
            let knownIds = null;

            onSnapshot(q, (snapshot) => {
                const results = [];
                snapshot.forEach((docSnap) => {
                    results.push({ id: docSnap.id, ...docSnap.data() });
                });

                // Pertama kali snapshot tiba ‚Üí catat semua ID yang sudah ada, jangan alert
                if (knownIds === null) {
                    knownIds = new Set(results.map(r => r.id));
                } else if (window.isStaff()) {
                    // FIX 2: Hanya alert untuk perubahan pada data di RUANG PENGAWAS SENDIRI.
                    // Admin (tidak ada currentPengawasRuang) mendapat alert semua ruang.
                    const pgRuang = window.currentPengawasRuang
                        ? (window.currentPengawasRuang.nama || '').trim().toLowerCase()
                        : null; // null = admin, tidak difilter

                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "modified" || change.type === "added") {
                            const data = change.doc.data();
                            const isNew = !knownIds.has(change.doc.id);
                            knownIds.add(change.doc.id);

                            // Cek apakah kejadian ini relevan untuk pengawas yang login
                            if (pgRuang !== null) {
                                // Pengawas: hanya alert jika siswa di ruangnya sendiri
                                const siswaRuang = (data.ruangUjian || '').trim().toLowerCase();
                                if (siswaRuang !== pgRuang) return; // ‚Üê beda ruang, skip
                            }

                            // Trigger alert hanya jika ada pelanggaran BARU (bukan data lama)
                            const hasViolation = data.violations > 0 || (data.status && data.status.includes("DISKUALIFIKASI"));
                            if (hasViolation && !isNew) {
                                // modified dengan pelanggaran = siswa baru melanggar
                                if(window.triggerCheatAlert) window.triggerCheatAlert(data);
                            } else if (hasViolation && isNew && data.violations > 0) {
                                // doc baru langsung punya violations (edge case re-login)
                                if(window.triggerCheatAlert) window.triggerCheatAlert(data);
                            }
                        }
                    });
                }

                results.sort((a, b) => b.timestamp - a.timestamp);
                if(window.updateDashboardTable) window.updateDashboardTable(results);
            });
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; user-select: none; }
        .hidden-section { display: none !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .no-copy { user-select: none; -webkit-user-select: none; }
        #exam-sidebar { transition: transform 0.3s ease-in-out; }

        /* ===== MOBILE BOTTOM NAV ===== */
        #mobile-bottom-nav {
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
        #mobile-bottom-nav button {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        #mobile-bottom-nav button:active {
            transform: scale(0.92);
        }
        /* Active indicator dot */
        #mobile-bottom-nav button.text-blue-600::after {
            content: '';
            display: block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #2563eb;
            margin: 0 auto;
            margin-top: 1px;
        }
        .sidebar-closed { transform: translateX(100%); }
        .sidebar-open { transform: translateX(0); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #modal-confirm { transition: opacity 0.2s ease-out; opacity: 0; }
        #modal-confirm.show { opacity: 1; }
        #modal-content { transition: transform 0.2s ease-out; }
        #modal-confirm.show #modal-content { transform: scale(100%); }

        /* ===== ANTI-CHEAT ENGINE STYLES ===== */
        #watermark-canvas { pointer-events: none; }
        #modal-warning-student, #modal-dq-final { backdrop-filter: blur(6px); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* ===== HP KENTANG MODE (low-end device) ===== */
        /* Diterapkan otomatis via JS bila device lambat */
        body.perf-mode * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            transition-delay: 0ms !important;
        }
        body.perf-mode .animate-pulse { animation: none !important; }
        body.perf-mode .animate-spin  { animation: none !important; }
        body.perf-mode .animate-bounce { animation: none !important; }
        body.perf-mode .animate-ping  { animation: none !important; }
        body.perf-mode .animate-fade-in { animation: none !important; opacity: 1 !important; transform: none !important; }

        /* Hapus semua blur/filter berat */
        body.perf-mode .blur-\[100px\],
        body.perf-mode .blur-\[80px\],
        body.perf-mode .blur-xl,
        body.perf-mode .blur-2xl,
        body.perf-mode .backdrop-blur-xl,
        body.perf-mode .backdrop-blur-sm,
        body.perf-mode .backdrop-blur-md { 
            filter: none !important; 
            backdrop-filter: none !important; 
            -webkit-backdrop-filter: none !important;
        }

        /* Hapus gradient berat ‚Äî pakai warna solid */
        body.perf-mode .bg-gradient-to-r,
        body.perf-mode .bg-gradient-to-br,
        body.perf-mode .bg-gradient-to-b { background-image: none !important; }

        /* Sembunyikan elemen dekoratif yang tidak penting (blob/glow) */
        body.perf-mode #section-login .absolute.rounded-full { display: none !important; }
        body.perf-mode .welcome-blob { display: none !important; }
        body.perf-mode .bg-\[url\(\'https\:\/\/grainy-gradients\.vercel\.app\/noise\.svg\'\)\],
        body.perf-mode .bg-\[url\(\'https\:\/\/www\.transparenttextures\.com\/patterns\/carbon-fibre\.png\'\)\] {
            display: none !important;
        }
        /* Welcome section perf-mode: pakai warna solid, tanpa animasi */
        body.perf-mode #section-welcome {
            background: #6366f1 !important;
        }
        body.perf-mode #section-welcome [class*="animate-spin"] {
            animation: none !important;
            border-top-color: #6366f1 !important;
        }

        /* Modal: tidak ada blur */
        body.perf-mode #modal-warning-student,
        body.perf-mode #modal-dq-final { backdrop-filter: none !important; background: rgba(0,0,0,0.85) !important; }

        /* Kurangi shadow berat */
        body.perf-mode .shadow-lg,
        body.perf-mode .shadow-xl,
        body.perf-mode .shadow-2xl { box-shadow: 0 2px 6px rgba(0,0,0,0.12) !important; }
        body.perf-mode .drop-shadow-md { filter: none !important; }
        body.perf-mode #section-welcome { background: #1e40af !important; }
        body.perf-mode .welcome-blob { display: none !important; }

        /* Nonaktifkan hover:scale / hover:shadow karena lambat di HP kentang */
        body.perf-mode *:hover { transform: none !important; box-shadow: inherit !important; }

        /* Scroll lebih ringan */
        body.perf-mode { scroll-behavior: auto !important; }

        /* Indikator kecil di pojok bahwa perf-mode aktif (opsional, bisa dihapus) */
        body.perf-mode::after {
            content: '‚ö° Mode Hemat';
            position: fixed;
            bottom: 6px;
            right: 8px;
            font-size: 10px;
            color: #94a3b8;
            z-index: 9999;
            pointer-events: none;
        }
        #modal-warning-student h1 { text-shadow: 0 0 40px rgba(239,68,68,0.9); }
        @keyframes siren-ring {
            0%   { box-shadow: 0 0 0 0   rgba(239,68,68,0.9); }
            70%  { box-shadow: 0 0 0 28px rgba(239,68,68,0);  }
            100% { box-shadow: 0 0 0 0   rgba(239,68,68,0);  }
        }
        .siren-ring { animation: siren-ring 1.1s ease-out infinite; }

        /* ===== MOBILE FRIENDLY (HP semua spesifikasi) ===== */
        /* Cegah auto-zoom saat fokus input di iOS/Android */
        @media (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important; /* iOS tidak zoom jika font >= 16px */
            }
            /* Tombol ujian lebih mudah di-tap (min 44px) */
            #btn-prev, #btn-next, #btn-finish-main {
                min-height: 48px;
                padding-left: 1rem;
                padding-right: 1rem;
                font-size: 14px;
            }
            /* Pilihan jawaban soal lebih tinggi agar mudah di-tap */
            .option-group label {
                min-height: 52px;
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
            }
            /* Sidebar soal lebih lebar di layar kecil */
            #exam-sidebar { width: 88vw; max-width: 320px; }
            /* Login form lebih padat di HP */
            #section-login .bg-white { padding: 1.25rem !important; }
            /* Timer lebih kecil di HP agar tidak makan tempat */
            #timer-box { font-size: 1rem; padding: 0.35rem 0.7rem; }
        }
        /* Layar sangat kecil (HP kecil <380px) */
        @media (max-width: 380px) {
            #btn-prev span, #btn-next span { display: none; }
            #timer-display { font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <!-- SECTION: LOGIN (REDESIGNED) -->
    <div id="section-login" class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden bg-slate-900">
        <!-- Background Effects -->
        <div class="absolute inset-0 z-0">
             <!-- Cyber Grid Background -->
            <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-slate-900 via-[#0f172a] to-[#1e1b4b]"></div>
            
            <!-- Animated Globs -->
            <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-600/20 rounded-full blur-[100px] animate-pulse"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-purple-600/20 rounded-full blur-[100px] animate-pulse" style="animation-delay: 2s;"></div>
            <div class="absolute top-[30%] right-[20%] w-64 h-64 bg-cyan-500/10 rounded-full blur-[80px]"></div>
        </div>

        <!-- Glass Card Container -->
        <div class="w-full max-w-md bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden border border-white/20 z-10 transform transition-all duration-500 hover:shadow-blue-500/20">
            
            <!-- Header Section -->
            <div class="bg-gradient-to-r from-blue-700 via-blue-600 to-indigo-700 p-8 text-center relative overflow-hidden group">
                <!-- Decorative pattern -->
                <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
                
                <div class="absolute top-4 right-4 z-20">
                    <span id="connection-status" class="text-[10px] font-bold text-white/90 bg-white/20 px-3 py-1 rounded-full border border-white/30 backdrop-blur-sm shadow-sm flex items-center gap-2">
                        <span class="inline-block w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span> Connecting...
                    </span>
                </div>

                <div class="relative z-10 flex flex-col items-center">
                    <div class="relative mb-4 transform transition-all duration-500 hover:scale-105">
                        <!-- Lingkaran putih tipis sebagai ring dekoratif -->
                        <div class="w-28 h-28 rounded-full bg-white/15 ring-4 ring-white/30 shadow-lg flex items-center justify-center">
                            <img src="images/integritest.png" onerror="this.src='https://via.placeholder.com/150?text=TKJ'" alt="Logo TKJ" class="w-24 h-24 object-contain drop-shadow-md">
                        </div>
                    </div>
                    <!-- INTEGRITEST ‚Äî branding tetap, tidak hilang walau setting diubah -->
                    <h1 class="text-3xl font-black tracking-tight drop-shadow-md">
                        <span class="text-white">INTEGRI</span><span style="color:#38bdf8;text-shadow:0 0 18px rgba(56,189,248,0.55)">TEST</span>
                    </h1>
                    <p class="text-blue-200/70 text-[10px] font-semibold tracking-[0.2em] uppercase mt-0.5 mb-0">Digitalyzing Integrity, Empowering Honestly</p>
                    <!-- Nama ujian custom dari setting (muncul jika admin isi di pengaturan) -->
                    <div id="login-exam-name-wrap" class="hidden mt-2 flex-col items-center gap-0">
                        <div class="h-px w-28 bg-white/20 mb-2"></div>
                        <h2 id="login-header-judul" class="text-base font-extrabold text-yellow-300 tracking-wide drop-shadow-sm text-center leading-tight px-4" style="text-shadow:0 0 14px rgba(253,224,71,0.5)"></h2>
                        <p id="login-header-sub" class="text-blue-100/80 text-[11px] font-medium tracking-wide text-center px-4 mt-0.5"></p>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-100 bg-gray-50/50">
                <button id="tab-student" onclick="window.switchLoginTab('student')" class="flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-white transition-all hover:bg-blue-50/50 relative">
                    <div class="flex items-center justify-center gap-2">
                        <i data-lucide="user" class="w-4 h-4"></i> Login Siswa
                    </div>
                </button>
                <button id="tab-teacher" onclick="window.switchLoginTab('teacher')" class="flex-1 py-4 text-sm font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent transition-all hover:bg-gray-50/50">
                    <div class="flex items-center justify-center gap-2">
                         <i data-lucide="shield" class="w-4 h-4"></i> Login Guru
                    </div>
                </button>
            </div>

            <!-- Content Area -->
            <div class="p-8 bg-white">
                <form id="form-student" onsubmit="window.handleStudentLogin(event)" class="space-y-5">
                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Nama Lengkap</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="user-circle" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                            </div>
                            <input type="text" id="student-name" required class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium placeholder-gray-400" placeholder="Ketik nama lengkap...">
                        </div>
                    </div>
					
					 <!-- 2. TAMBAHAN BARU: Input NISN -->
                    <div class="group">
                        <label id="label-nomor-id" class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">NISN</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="id-card" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                            </div>
                            <input type="number" id="student-nisn" required class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium placeholder-gray-400" placeholder="Ketik NISN...">
                        </div>
                    </div>

                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Kelas</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="users" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                            </div>
                            <select id="student-class" required class="w-full pl-10 pr-8 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium appearance-none">
                                <option value="">-- Pilih Kelas --</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-400">
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>

                    <!-- RUANG UJIAN -->
                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Ruang Ujian</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="door-open" class="h-5 w-5 text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                            </div>
                            <select id="student-room" required class="w-full pl-10 pr-8 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium appearance-none">
                                <option value="">-- Pilih Ruang Ujian --</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-400">
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1 ml-1">* Pilih ruang sesuai tempat duduk kamu. Tanya pengawas jika ragu.</p>
                    </div>

                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Token Ujian</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="key" class="h-5 w-5 text-gray-400 group-focus-within:text-yellow-500 transition-colors"></i>
                            </div>
                            <input type="text" id="student-token" required
                                class="w-full pl-10 pr-4 py-3.5 border border-gray-200 rounded-xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all bg-gray-50 focus:bg-white text-center font-mono font-bold tracking-[0.3em] text-blue-700 placeholder-gray-300 uppercase text-base"
                                placeholder="MASUKKAN TOKEN">
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1 ml-1">* Token ujian diberikan oleh guru/pengawas.</p>
                    </div>

                    <!-- Hidden: paket dipilih otomatis di halaman selamat datang -->
                    <input type="hidden" id="selected-packet" value="">

                    <button type="submit" id="btn-student-submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30 transform transition-all hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-3 group text-base">
                        <i data-lucide="log-in" class="w-5 h-5"></i>
                        <span>MASUK</span>
                        <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                    </button>

                    <div class="flex items-center justify-center gap-1.5 text-[10px] text-gray-400">
                        <i data-lucide="maximize-2" class="w-3 h-3"></i>
                        <span>Aplikasi otomatis masuk mode layar penuh saat login.</span>
                    </div>
                </form>

                <div id="form-teacher" class="hidden-section">
                    <!-- Sub-tab: Admin vs Pengawas -->
                    <div class="flex gap-2 mb-5 bg-gray-100 p-1 rounded-xl">
                        <button id="subtab-admin" onclick="window.switchTeacherSubTab('admin')" class="flex-1 py-2 text-xs font-bold rounded-lg bg-white text-gray-800 shadow-sm flex items-center justify-center gap-1.5">
                            <i data-lucide="shield-check" class="w-3.5 h-3.5 text-indigo-600"></i> Admin / Koordinator
                        </button>
                        <button id="subtab-pengawas" onclick="window.switchTeacherSubTab('pengawas')" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1.5">
                            <i data-lucide="eye" class="w-3.5 h-3.5"></i> Pengawas Ruang
                        </button>
                    </div>

                    <!-- FORM ADMIN -->
                    <form id="form-admin-login" onsubmit="window.handleAdminLogin(event)" class="space-y-4">
                        <div class="p-3 bg-indigo-50 rounded-xl border border-indigo-200 flex items-start gap-3">
                            <i data-lucide="lock" class="w-4 h-4 text-indigo-600 mt-0.5 shrink-0"></i>
                            <p class="text-xs text-indigo-700">Login Admin memberi akses ke seluruh data, pengaturan, dan semua ruang ujian.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Username</label>
                            <input type="text" id="admin-user" placeholder="Username Admin" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Password Admin</label>
                            <input type="password" id="admin-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium">
                        </div>
                        <button type="submit" class="w-full bg-indigo-700 hover:bg-indigo-800 text-white font-bold py-3.5 rounded-xl shadow-lg transform transition-all hover:scale-[1.02] flex items-center justify-center gap-2">
                            <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Masuk Sebagai Admin
                        </button>
                    </form>

                    <!-- FORM PENGAWAS RUANG -->
                    <form id="form-pengawas-login" onsubmit="window.handlePengawasLogin(event)" class="space-y-4 hidden-section">
                        <div class="p-3 bg-amber-50 rounded-xl border border-amber-200 flex items-start gap-3">
                            <i data-lucide="eye" class="w-4 h-4 text-amber-600 mt-0.5 shrink-0"></i>
                            <p class="text-xs text-amber-700">Login Pengawas hanya memberi akses monitoring siswa di ruang yang ditentukan.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Ruang Ujian</label>
                            <div class="relative">
                                <i data-lucide="door-open" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                <select id="pengawas-room-select" class="w-full pl-10 pr-8 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-amber-500/10 focus:border-amber-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium appearance-none">
                                    <option value="">-- Pilih Ruang --</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 ml-1">Password Ruang</label>
                            <input type="password" id="pengawas-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-4 focus:ring-amber-500/10 focus:border-amber-500 outline-none transition-all bg-gray-50 focus:bg-white text-gray-800 font-medium">
                            <p class="text-[10px] text-gray-400 mt-1 ml-1">* Password berbeda tiap ruang, ditetapkan oleh Admin.</p>
                        </div>
                        <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3.5 rounded-xl shadow-lg transform transition-all hover:scale-[1.02] flex items-center justify-center gap-2">
                            <i data-lucide="eye" class="w-4 h-4"></i> Masuk Monitoring Ruang
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50/80 p-4 text-center border-t border-gray-100 backdrop-blur-sm">
                <p class="text-[10px] text-gray-400 font-medium flex items-center justify-center gap-1">
                    &copy; 2026 Nailul Authar <span class="text-gray-300">‚Ä¢</span> SMK Negeri 1 Brondong
                </p>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WATERMARK OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="watermark-overlay" class="fixed inset-0 pointer-events-none z-[25] hidden select-none overflow-hidden" aria-hidden="true">
        <canvas id="watermark-canvas" class="w-full h-full" style="opacity:0.07"></canvas>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL PERINGATAN SISWA ‚Äî FULLSCREEN (countdown, tidak bisa ditutup paksa) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="modal-warning-student" class="fixed inset-0 z-[999] hidden" style="background:rgba(0,0,0,0.93)">
        <!-- Flash merah kilat -->
        <div id="warning-flash" class="absolute inset-0 bg-red-600 opacity-0 pointer-events-none transition-opacity duration-100"></div>

        <div class="relative z-10 h-full flex flex-col items-center justify-center p-6 text-center overflow-y-auto">

            <!-- Ikon sirine -->
            <div class="relative mb-5 shrink-0">
                <div class="w-28 h-28 rounded-full bg-red-600 siren-ring flex items-center justify-center shadow-2xl shadow-red-500/60">
                    <div class="w-20 h-20 rounded-full bg-red-700 border-4 border-red-400 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-white animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    </div>
                </div>
            </div>

            <!-- Badge pelanggaran -->
            <div class="inline-flex items-center gap-2 bg-red-700 text-white px-5 py-1.5 rounded-full font-black uppercase tracking-widest shadow-lg mb-4 text-sm">
                ‚ö†Ô∏è PELANGGARAN <span id="ws-vcount" class="text-yellow-300 text-xl mx-1">1</span> / 3
            </div>

            <!-- Judul -->
            <h1 id="ws-title" class="text-3xl md:text-4xl font-black text-white uppercase tracking-wider mb-1 leading-tight">TERDETEKSI CURANG!</h1>
            <p id="ws-name" class="text-red-300 font-bold text-sm mb-4"></p>

            <!-- Detail -->
            <div class="bg-red-900/70 border border-red-600 rounded-2xl p-4 max-w-md w-full mb-4">
                <p id="ws-detail" class="text-red-100 font-semibold text-sm leading-relaxed"></p>
                <div class="mt-3 pt-3 border-t border-red-700">
                    <p id="ws-consequence" class="font-bold text-sm"></p>
                </div>
            </div>

            <!-- NASIHAT BOX -->
            <div id="ws-nasihat-box" class="bg-white/8 border border-white/15 rounded-2xl p-4 max-w-md w-full mb-4 text-left">
                <p class="text-[10px] font-black uppercase tracking-widest text-yellow-400 mb-2 flex items-center gap-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    Renungkan ini
                </p>
                <p id="ws-nasihat" class="text-white/80 text-sm leading-relaxed italic"></p>
            </div>

            <!-- Countdown -->
            <div id="ws-cd-wrapper" class="mb-4">
                <p class="text-gray-500 text-xs mb-1">Tombol aktif dalam:</p>
                <div id="ws-cd" class="text-5xl font-black text-white tabular-nums">5</div>
            </div>

            <!-- Tombol lanjutkan -->
            <button id="ws-close-btn" onclick="window.closeWarningModal()" disabled
                class="w-full max-w-sm py-4 rounded-2xl font-black text-base uppercase tracking-widest bg-gray-700 text-gray-500 cursor-not-allowed transition-all duration-500">
                MENGERTI ‚Äî LANJUTKAN UJIAN
            </button>
            <p class="text-gray-600 text-xs mt-4 max-w-sm">Sistem merekam semua aktivitas secara real-time. Pengawas melihat pelanggaran ini di dashboard.</p>
        </div>
    </div>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL DISKUALIFIKASI FINAL (otomatis redirect ke hasil) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="modal-dq-final" class="fixed inset-0 z-[1000] hidden" style="background:rgba(0,0,0,0.97)">
        <div class="h-full flex flex-col items-center justify-center px-5 py-8 text-center overflow-y-auto">

            <!-- Ikon X merah -->
            <div class="w-24 h-24 rounded-full bg-red-700 border-4 border-red-500 flex items-center justify-center mb-5 shadow-2xl shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-14 h-14 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
            </div>

            <!-- Judul responsif ‚Äî tidak terpotong di HP kecil -->
            <h1 class="font-black text-red-500 uppercase mb-1 leading-tight px-2"
                style="font-size:clamp(1.6rem,7vw,3.5rem);letter-spacing:0.04em;word-break:break-word;max-width:100%;">
                DISKUALIFIKASI
            </h1>
            <p id="dq-name" class="text-white text-sm font-bold mb-5 opacity-70"></p>

            <!-- Info box -->
            <div class="bg-white/5 border border-red-900 rounded-2xl p-4 max-w-sm w-full mb-6">
                <p class="text-gray-300 text-sm leading-relaxed">
                    <span class="text-red-400 font-black">3 pelanggaran</span> terdeteksi.<br>
                    Ujian dihentikan otomatis oleh sistem.<br>
                    Pengawas mendapat notifikasi langsung.
                </p>
            </div>

            <!-- Countdown -->
            <p class="text-gray-500 text-xs mb-1">Menuju halaman hasil dalam</p>
            <div class="flex items-baseline gap-2">
                <span id="dq-cd" class="text-6xl font-black text-white tabular-nums">5</span>
                <span class="text-gray-500 text-sm">detik</span>
            </div>

        </div>
    </div>

    <!-- SECTION: SELAMAT DATANG -->
    <div id="section-welcome" class="hidden-section min-h-screen flex flex-col" style="background:#f0f6ff;">

        <!-- BG blob (disembunyikan perf-mode) -->
        <div class="welcome-blob pointer-events-none" style="position:absolute;top:-120px;right:-120px;width:350px;height:350px;border-radius:50%;background:radial-gradient(circle,rgba(59,130,246,0.12) 0%,transparent 70%);"></div>
        <div class="welcome-blob pointer-events-none" style="position:absolute;bottom:-80px;left:-80px;width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,rgba(99,102,241,0.10) 0%,transparent 70%);"></div>

        <!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
        <div style="background:linear-gradient(135deg,#1d4ed8 0%,#2563eb 60%,#3b82f6 100%);" class="px-6 pt-10 pb-8 text-center relative overflow-hidden">
            <!-- subtle grid pattern -->
            <div class="absolute inset-0 opacity-[0.06]" style="background-image:linear-gradient(rgba(255,255,255,0.5) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.5) 1px,transparent 1px);background-size:24px 24px;"></div>
            <div class="relative z-10">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl mb-4 border border-white/20" style="background:rgba(255,255,255,0.15);">
                    <i data-lucide="graduation-cap" class="w-8 h-8 text-white"></i>
                </div>
                <h2 class="text-2xl font-black text-white tracking-tight mb-1">Selamat Datang</h2>
                <p class="text-blue-100 text-xs font-semibold tracking-widest uppercase opacity-80">
                    <span class="text-white font-black">INTEGRI</span><span style="color:#bfdbfe">TEST</span>
                    &nbsp;¬∑&nbsp; Ujian Berbasis Komputer
                </p>
                <!-- Judul & sub judul ujian dari pengaturan admin -->
                <div id="welcome-judul-ujian-wrap" class="mt-3 bg-white/15 rounded-xl px-4 py-2.5 border border-white/20 backdrop-blur-sm" style="display:none">
                    <p id="welcome-judul-ujian" class="text-white font-black text-sm leading-snug"></p>
                    <p id="welcome-sub-judul" class="text-blue-100 text-[11px] font-semibold mt-0.5 opacity-90"></p>
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ IDENTITY CARD ‚îÄ‚îÄ -->
        <div class="mx-4 -mt-4 relative z-10">
            <div class="bg-white rounded-2xl shadow-lg border border-blue-100 overflow-hidden">
                <div class="grid grid-cols-3 divide-x divide-blue-50">
                    <div class="flex flex-col items-center py-4 px-2 text-center">
                        <div class="w-8 h-8 rounded-xl flex items-center justify-center mb-2" style="background:#dbeafe;">
                            <i data-lucide="user" class="w-4 h-4 text-blue-600"></i>
                        </div>
                        <p class="text-[9px] font-bold uppercase tracking-widest text-blue-400 mb-1">Nama</p>
                        <p id="welcome-name" class="text-gray-800 font-black text-xs leading-tight break-all">‚Äî</p>
                    </div>
                    <div class="flex flex-col items-center py-4 px-2 text-center">
                        <div class="w-8 h-8 rounded-xl flex items-center justify-center mb-2" style="background:#ede9fe;">
                            <i data-lucide="hash" class="w-4 h-4 text-indigo-600"></i>
                        </div>
                        <p id="welcome-nisn-label" class="text-[9px] font-bold uppercase tracking-widest text-indigo-400 mb-1">NISN</p>
                        <p id="welcome-nisn" class="text-gray-800 font-black text-xs leading-tight">‚Äî</p>
                    </div>
                    <div class="flex flex-col items-center py-4 px-2 text-center">
                        <div class="w-8 h-8 rounded-xl flex items-center justify-center mb-2" style="background:#dcfce7;">
                            <i data-lucide="school" class="w-4 h-4 text-emerald-600"></i>
                        </div>
                        <p class="text-[9px] font-bold uppercase tracking-widest text-emerald-400 mb-1">Kelas</p>
                        <p id="welcome-kelas" class="text-gray-800 font-black text-xs leading-tight">‚Äî</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ BODY ‚îÄ‚îÄ -->
        <div class="flex-1 px-4 pt-4 pb-6 space-y-4">

            <!-- Motivasi -->
            <div class="bg-white rounded-2xl border border-blue-100 shadow-sm p-4 flex items-start gap-3">
                <div class="w-8 h-8 rounded-xl flex items-center justify-center shrink-0 mt-0.5" style="background:#dbeafe;">
                    <i data-lucide="star" class="w-4 h-4 text-blue-500"></i>
                </div>
                <p id="welcome-motivasi-text" class="text-gray-700 text-sm leading-relaxed">
                    Kerjakan dengan <strong class="text-blue-600">jujur</strong> dan <strong class="text-blue-600">penuh semangat</strong>. Hasil terbaik lahir dari usaha yang sungguh-sungguh. Percayalah pada kemampuanmu ‚Äî <strong class="text-indigo-600">sukses menantimu!</strong>
                </p>
            </div>

            <!-- Pilih Mata Pelajaran -->
            <div class="bg-white rounded-2xl border border-blue-100 shadow-sm overflow-hidden">
                <div class="px-4 py-3 border-b border-blue-50 flex items-center gap-2">
                    <div class="w-1 h-4 rounded-full" style="background:linear-gradient(180deg,#2563eb,#6366f1)"></div>
                    <p class="text-gray-800 text-sm font-black">Pilih Mata Pelajaran</p>
                </div>
                <div id="welcome-paket-list" class="p-3 space-y-2 min-h-[80px]">
                    <div class="flex items-center justify-center gap-2 py-5 text-gray-400">
                        <div class="w-5 h-5 rounded-full border-2 border-blue-200 border-t-blue-500 animate-spin"></div>
                        <span class="text-sm">Memuat ujian...</span>
                    </div>
                </div>
            </div>

            <!-- Keunggulan Sistem ‚Äî 13 Fitur Utama (sesuai proposal EJIES 2026) -->
            <div class="bg-white rounded-2xl border border-blue-100 shadow-sm overflow-hidden">
                <div class="px-4 py-3 border-b border-blue-50 flex items-center gap-2">
                    <div class="w-1 h-4 rounded-full" style="background:linear-gradient(180deg,#2563eb,#6366f1)"></div>
                    <p class="text-gray-800 text-sm font-black">Keunggulan Sistem</p>
                </div>
                <div class="p-4 grid grid-cols-2 gap-3">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#dcfce7;">
                            <i data-lucide="shield-check" class="w-3 h-3 text-emerald-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Anti-Cheat Engine 7-Lapis</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#ede9fe;">
                            <i data-lucide="bar-chart-2" class="w-3 h-3 text-indigo-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Skor Integritas Adaptif</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#dbeafe;">
                            <i data-lucide="maximize-2" class="w-3 h-3 text-blue-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Fullscreen Lock Aktif</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#fef9c3;">
                            <i data-lucide="fingerprint" class="w-3 h-3 text-yellow-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Device Fingerprint Verified</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#fee2e2;">
                            <i data-lucide="eye-off" class="w-3 h-3 text-red-500"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Deteksi Mode Incognito</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#ecfeff;">
                            <i data-lucide="layers" class="w-3 h-3 text-cyan-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Canvas Watermark Dinamis</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#dcfce7;">
                            <i data-lucide="monitor" class="w-3 h-3 text-green-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Monitoring Real-Time</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#fef3c7;">
                            <i data-lucide="wifi-off" class="w-3 h-3 text-amber-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Mode Offline &amp; Auto-Recovery</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#dbeafe;">
                            <i data-lucide="copy" class="w-3 h-3 text-blue-500"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Sistem Paket Soal A/B/C</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#ede9fe;">
                            <i data-lucide="brain" class="w-3 h-3 text-purple-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Multi-Tipe Soal + Koreksi AI</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#d1fae5;">
                            <i data-lucide="calendar-check" class="w-3 h-3 text-emerald-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Jadwal Ujian Otomatis</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#fee2e2;">
                            <i data-lucide="file-text" class="w-3 h-3 text-rose-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Laporan PDF Individual</span>
                    </div>
                    <div class="flex items-center gap-2 col-span-2">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center shrink-0" style="background:#fef9c3;">
                            <i data-lucide="smartphone" class="w-3 h-3 text-yellow-600"></i>
                        </div>
                        <span class="text-[10px] font-semibold text-gray-600 leading-tight">Low-End Device Optimization ‚Äî HP Entry-Level Ready</span>
                    </div>
                </div>
            </div>

            <!-- Notifikasi fullscreen untuk desktop -->
            <div class="bg-blue-600 rounded-2xl px-4 py-3 flex items-center gap-3">
                <div class="w-8 h-8 rounded-xl bg-white/20 flex items-center justify-center shrink-0">
                    <i data-lucide="maximize" class="w-4 h-4 text-white"></i>
                </div>
                <div class="flex-1">
                    <p class="text-white text-xs font-black leading-tight">Ujian akan otomatis masuk mode Layar Penuh</p>
                    <p class="text-blue-200 text-[10px] mt-0.5">Klik mata pelajaran di atas untuk memulai. Jangan tutup / keluar dari layar penuh selama ujian.</p>
                </div>
            </div>

        </div>
    </div>    <!-- SECTION: EXAM -->
    <div id="section-exam" class="hidden-section min-h-screen bg-slate-100 flex flex-col no-copy relative overflow-hidden">
        <header class="bg-white shadow-sm border-b sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="images/integritest.png" onerror="this.src='https://via.placeholder.com/50?text=TKJ'" alt="Logo TKJ" class="w-10 h-10 object-contain">
                    <div>
                        <h2 class="font-bold text-gray-800" id="header-name">Nama Siswa</h2>
                        <p class="text-xs text-gray-500" id="header-detail">Kelas ‚Ä¢ Paket A (Kelas XI)</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="timer-box" class="flex items-center gap-2 px-4 py-2 rounded-lg font-mono font-bold text-lg bg-blue-50 text-blue-600">
                        <i data-lucide="clock" class="w-5 h-5"></i> <span id="timer-display">--:--</span>
                    </div>
                    <button onclick="window.toggleSidebar()" class="ml-2 p-2 rounded-lg hover:bg-slate-100 border border-slate-200 text-slate-700 flex items-center gap-2">
                        <i data-lucide="grid-3x3" class="w-5 h-5"></i> <span class="hidden md:inline text-sm font-semibold">Daftar Soal</span>
                    </button>
                </div>
            </div>
        </header>
        <main class="flex-1 w-full max-w-4xl mx-auto p-4 md:p-8 flex flex-col h-[calc(100vh-64px)] overflow-y-auto">
            <div id="question-area" class="flex-1"></div>
            <div class="mt-6 pt-4 border-t flex justify-between items-center bg-slate-100 sticky bottom-0 z-20 pb-4">
                <button id="btn-prev" onclick="window.changeQuestion(-1)" class="px-6 py-2 rounded-lg font-semibold bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="chevron-left" class="w-4 h-4 inline mr-1"></i> Sebelumnya
                </button>
                <button id="btn-next" onclick="window.changeQuestion(1)" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 shadow-sm flex items-center">
                    Selanjutnya <i data-lucide="chevron-right" class="w-4 h-4 inline ml-1"></i>
                </button>
                 <button id="btn-finish-main" onclick="window.confirmFinishExam()" class="hidden px-6 py-2 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-700 shadow-sm flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-4 h-4"></i> Selesai
                </button>
            </div>
        </main>
        <div id="exam-sidebar" class="fixed top-16 right-0 bottom-0 w-80 bg-white shadow-2xl border-l border-slate-200 z-40 sidebar-closed flex flex-col">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">Navigasi Soal</h3>
                <button onclick="window.toggleSidebar()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div id="question-grid" class="grid grid-cols-5 gap-3"></div>
            </div>
            <div class="p-4 border-t bg-slate-50">
                <div class="flex gap-2 text-xs mb-4 justify-center">
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-500 rounded-full"></div> Dijawab</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-slate-200 border rounded-full"></div> Belum</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 border-2 border-blue-500 rounded-full"></div> Aktif</div>
                </div>
                <button onclick="window.confirmFinishExam()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow flex items-center justify-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Hentikan Ujian
                </button>
            </div>
        </div>
        <div id="sidebar-overlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/20 z-30 hidden" style="top: 64px;"></div>
    </div>

    <!-- MODAL CONFIRMATION -->
    <div id="modal-confirm" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-90 transition-transform duration-300" id="modal-content">
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Selesai Ujian?</h3>
                <p class="text-gray-500 text-sm mb-6" id="modal-desc">Waktu masih ada. Apakah Anda yakin ingin mengakhiri ujian ini sekarang?</p>
                <div class="flex gap-3">
                    <button onclick="window.closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition-colors">Batal</button>
                    <button onclick="window.finalFinish()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all active:scale-95">Ya, Selesai</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL BELUM WAKTUNYA SUBMIT (Menggantikan alert() agar tidak trigger anti-cheat) -->
    <div id="modal-early-submit" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 text-center animate-fade-in">
            <div class="w-16 h-16 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="clock" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">‚õî Belum Bisa Submit</h3>
            <p class="text-gray-600 text-sm mb-2" id="early-submit-msg">Anda belum bisa mengumpulkan jawaban saat ini.</p>
            <p class="text-orange-600 font-bold text-sm mb-6" id="early-submit-remaining"></p>
            <button onclick="document.getElementById('modal-early-submit').classList.add('hidden'); window._suppressCheat = false;" 
                class="w-full px-4 py-2.5 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold shadow-md transition-all active:scale-95">
                Oke, Periksa Jawaban Dulu
            </button>
        </div>
    </div>

    <!-- MODAL ADD/EDIT QUESTION (REDESIGNED) -->
    <div id="modal-question" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-y-auto max-h-[94vh] flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50 rounded-t-2xl shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded-lg"><i data-lucide="file-edit" class="w-5 h-5 text-blue-600"></i></div>
                    <div>
                        <h3 id="modal-q-title" class="text-base font-bold text-gray-800">Tambah Soal Baru</h3>
                        <p id="modal-q-subtitle" class="text-xs text-gray-500">Dalam paket: <span id="modal-q-paket-label" class="font-semibold text-blue-600">‚Äî</span></p>
                    </div>
                </div>
                <button onclick="window.closeQuestionModal()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <form id="form-question" onsubmit="window.saveQuestionSubmit(event)" class="flex-1 overflow-y-auto">
                <input type="hidden" id="q-id">
                <input type="hidden" id="q-packet">

                <div class="px-6 py-5 space-y-5">

                    <!-- SECTION 1: STATUS, TIPE & KUNCI -->
                    <div class="grid grid-cols-1 gap-4">
                        <!-- Tipe Soal -->
                        <div class="bg-gray-50 rounded-xl border p-4">
                            <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3 flex items-center gap-1.5">
                                <i data-lucide="layers" class="w-3.5 h-3.5"></i> Tipe Soal
                            </p>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" id="q-tipe-single-btn" onclick="window.setQuestionType('single')"
                                    class="py-2.5 px-3 rounded-xl border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold text-sm flex items-center justify-center gap-2 transition-all">
                                    <i data-lucide="circle-dot" class="w-4 h-4"></i> Pilihan Tunggal
                                </button>
                                <button type="button" id="q-tipe-multiple-btn" onclick="window.setQuestionType('multiple')"
                                    class="py-2.5 px-3 rounded-xl border-2 border-gray-200 bg-white text-gray-500 font-bold text-sm flex items-center justify-center gap-2 transition-all">
                                    <i data-lucide="check-square" class="w-4 h-4"></i> Jawaban Ganda
                                </button>
                                <button type="button" id="q-tipe-truefalse-btn" onclick="window.setQuestionType('truefalse')"
                                    class="py-2.5 px-3 rounded-xl border-2 border-gray-200 bg-white text-gray-500 font-bold text-sm flex items-center justify-center gap-2 transition-all">
                                    <i data-lucide="toggle-left" class="w-4 h-4"></i> Benar / Salah
                                </button>
                                <button type="button" id="q-tipe-essay-btn" onclick="window.setQuestionType('essay')"
                                    class="py-2.5 px-3 rounded-xl border-2 border-gray-200 bg-white text-gray-500 font-bold text-sm flex items-center justify-center gap-2 transition-all">
                                    <i data-lucide="pencil-line" class="w-4 h-4"></i> Esai / Uraian
                                </button>
                            </div>
                            <input type="hidden" id="q-tipe" value="single">
                            <p id="q-tipe-hint" class="text-xs text-gray-400 mt-2">Pilihan tunggal: hanya 1 jawaban benar.</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Status aktif -->
                            <div class="bg-gray-50 rounded-xl border p-4">
                                <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3 flex items-center gap-1.5">
                                    <i data-lucide="eye" class="w-3.5 h-3.5"></i> Status Soal
                                </p>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <div class="relative shrink-0">
                                        <input type="checkbox" id="q-aktif" class="sr-only peer" checked>
                                        <div class="w-12 h-6 bg-gray-300 rounded-full peer peer-checked:bg-green-500 transition-colors"></div>
                                        <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform peer-checked:translate-x-6"></div>
                                    </div>
                                    <span id="q-aktif-label" class="text-sm font-bold text-green-600">Aktif</span>
                                </label>
                                <p class="text-xs text-gray-400 mt-2">Soal nonaktif tidak muncul di ujian siswa.</p>
                            </div>
                            <!-- Kunci jawaban (single) -->
                            <div id="q-correct-single-wrap" class="bg-gray-50 rounded-xl border p-4">
                                <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3 flex items-center gap-1.5">
                                    <i data-lucide="check-square" class="w-3.5 h-3.5"></i> Kunci Jawaban
                                </p>
                                <select id="q-correct" class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-sm font-semibold bg-white">
                                    <option value="0">A (Pilihan ke-1)</option>
                                    <option value="1">B (Pilihan ke-2)</option>
                                    <option value="2">C (Pilihan ke-3)</option>
                                    <option value="3">D (Pilihan ke-4)</option>
                                    <option value="4">E (Pilihan ke-5)</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-2">Pilih jawaban yang benar.</p>
                            </div>
                        </div>
                        <!-- Kunci jawaban (multiple) -->
                        <div id="q-correct-multiple-wrap" class="hidden bg-emerald-50 rounded-xl border border-emerald-200 p-4">
                            <p class="text-xs font-bold text-emerald-700 uppercase tracking-wide mb-3 flex items-center gap-1.5">
                                <i data-lucide="check-square" class="w-3.5 h-3.5"></i> Kunci Jawaban Ganda
                                <span class="ml-auto text-[10px] font-normal text-emerald-500">Centang semua jawaban yang benar</span>
                            </p>
                            <div id="q-correct-multi-checks" class="flex flex-wrap gap-2">
                                <label class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-emerald-400 transition-all has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                                    <input type="checkbox" name="correct-multi[]" value="0" class="w-4 h-4 accent-emerald-600"> <span class="font-bold text-sm text-gray-700">A</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-emerald-400 transition-all has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                                    <input type="checkbox" name="correct-multi[]" value="1" class="w-4 h-4 accent-emerald-600"> <span class="font-bold text-sm text-gray-700">B</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-emerald-400 transition-all has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                                    <input type="checkbox" name="correct-multi[]" value="2" class="w-4 h-4 accent-emerald-600"> <span class="font-bold text-sm text-gray-700">C</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-emerald-400 transition-all has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                                    <input type="checkbox" name="correct-multi[]" value="3" class="w-4 h-4 accent-emerald-600"> <span class="font-bold text-sm text-gray-700">D</span>
                                </label>
                                <label class="flex items-center gap-2 px-3 py-2 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-emerald-400 transition-all has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                                    <input type="checkbox" name="correct-multi[]" value="4" class="w-4 h-4 accent-emerald-600"> <span class="font-bold text-sm text-gray-700">E</span>
                                </label>
                            </div>
                            <p class="text-xs text-emerald-600 mt-2 font-medium">‚ö†Ô∏è Siswa harus memilih SEMUA jawaban yang benar untuk mendapat poin penuh.</p>
                        </div>

                        <!-- Kunci jawaban (essay) -->
                        <div id="q-correct-essay-wrap" class="hidden bg-purple-50 rounded-xl border border-purple-200 p-4">
                            <p class="text-xs font-bold text-purple-700 uppercase tracking-wide mb-3 flex items-center gap-1.5">
                                <i data-lucide="pencil-line" class="w-3.5 h-3.5"></i> Kunci Jawaban / Rubrik Penilaian
                                <span class="ml-auto text-[10px] font-normal text-purple-500">Digunakan AI & guru untuk menilai</span>
                            </p>
                            <textarea id="q-essay-rubrik" rows="5" class="w-full px-3 py-2 border border-purple-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-purple-400 bg-white resize-none" placeholder="Tulis kunci jawaban model / rubrik penilaian di sini...&#10;&#10;Contoh:&#10;- Sebutkan 3 poin utama: (1) ..., (2) ..., (3) ...&#10;- Nilai penuh jika menjawab minimal 2 poin dengan benar"></textarea>
                            <div class="flex items-center justify-between mt-2.5 flex-wrap gap-2">
                                <p class="text-xs text-purple-600 font-medium">‚ö†Ô∏è Jawaban siswa akan dikoreksi AI berdasarkan rubrik ini, atau guru bisa koreksi manual.</p>
                                <div class="flex items-center gap-2">
                                    <label class="text-xs font-bold text-purple-700">Skor maks:</label>
                                    <input type="number" id="q-essay-skor-maks" min="1" max="100" value="10" class="w-20 px-2 py-1 border border-purple-200 rounded-lg text-sm outline-none focus:ring-1 focus:ring-purple-400 bg-white font-bold text-purple-700">
                                </div>
                            </div>
                        </div>
                        <!-- Kunci jawaban (benar/salah) -->
                        <div id="q-correct-truefalse-wrap" class="hidden bg-amber-50 rounded-xl border border-amber-200 p-4">
                            <p class="text-xs font-bold text-amber-700 uppercase tracking-wide mb-3 flex items-center gap-1.5">
                                <i data-lucide="toggle-left" class="w-3.5 h-3.5"></i> Kunci Jawaban
                                <span class="ml-auto text-[10px] font-normal text-amber-500">Pilih mana yang benar</span>
                            </p>
                            <div class="flex gap-3">
                                <label id="q-tf-benar-label" class="flex-1 flex items-center justify-center gap-2 py-3 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-green-400 transition-all font-bold text-gray-600 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 has-[:checked]:text-green-700">
                                    <input type="radio" name="correct-tf" value="true" id="q-tf-benar" class="sr-only">
                                    <span class="text-xl">‚úì</span> BENAR
                                </label>
                                <label id="q-tf-salah-label" class="flex-1 flex items-center justify-center gap-2 py-3 bg-white border-2 border-gray-200 rounded-xl cursor-pointer hover:border-red-400 transition-all font-bold text-gray-600 has-[:checked]:border-red-500 has-[:checked]:bg-red-50 has-[:checked]:text-red-700">
                                    <input type="radio" name="correct-tf" value="false" id="q-tf-salah" class="sr-only">
                                    <span class="text-xl">‚úó</span> SALAH
                                </label>
                            </div>
                            <p class="text-xs text-amber-600 mt-2 font-medium">Pilih apakah pernyataan di atas adalah BENAR atau SALAH.</p>
                        </div>
                    </div>

                    <!-- SECTION 2: PERTANYAAN -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 flex items-center gap-1.5">
                            <i data-lucide="message-square" class="w-3.5 h-3.5"></i> Teks Pertanyaan
                        </label>
                        <textarea id="q-text" rows="4" class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm resize-none bg-gray-50 focus:bg-white transition-colors" placeholder="Tulis pertanyaan di sini... Boleh dikosongkan jika soal hanya berupa gambar."></textarea>
                    </div>

                    <!-- SECTION 3: GAMBAR SOAL -->
                    <div class="border rounded-xl overflow-hidden">
                        <div class="bg-blue-50 px-4 py-2.5 border-b flex items-center justify-between">
                            <span class="text-xs font-bold text-blue-800 flex items-center gap-1.5"><i data-lucide="image" class="w-3.5 h-3.5"></i> Gambar Soal <span class="font-normal text-blue-500">(Opsional)</span></span>
                            <div class="flex gap-1">
                                <button type="button" onclick="window.switchImgTab('q','url')" id="q-img-tab-url" class="px-2.5 py-1 text-xs font-bold rounded-lg bg-blue-600 text-white">üîó URL</button>
                                <button type="button" onclick="window.switchImgTab('q','upload')" id="q-img-tab-upload" class="px-2.5 py-1 text-xs font-bold rounded-lg bg-white text-blue-600 border border-blue-200">üìÅ Upload</button>
                            </div>
                        </div>
                        <div class="p-4">
                            <div id="q-img-panel-url">
                                <input type="text" id="q-image-url" placeholder="Paste URL gambar atau link Google Drive..." class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-white" oninput="window.previewImg('q', this.value)">
                                <p class="text-xs text-blue-500 mt-1.5">üí° Google Drive: klik kanan ‚Üí Bagikan ‚Üí Salin link ‚Üí paste di sini</p>
                            </div>
                            <div id="q-img-panel-upload" class="hidden">
                                <div class="border-2 border-dashed border-blue-300 rounded-lg p-5 text-center cursor-pointer hover:bg-blue-50" onclick="document.getElementById('q-img-file').click()">
                                    <i data-lucide="upload-cloud" class="w-6 h-6 text-blue-400 mx-auto mb-1.5"></i>
                                    <p class="text-xs text-blue-600 font-medium">Klik untuk pilih gambar</p>
                                    <p class="text-xs text-blue-400">JPG, PNG, GIF ‚Äì maks 800KB</p>
                                </div>
                                <input type="file" id="q-img-file" accept="image/*" class="hidden" onchange="window.handleImgUpload('q', this)">
                            </div>
                            <input type="hidden" id="q-image-data">
                            <div id="q-img-preview" class="hidden mt-3 flex items-center gap-3">
                                <img id="q-img-preview-img" src="" class="max-h-32 rounded-lg border object-contain bg-white">
                                <button type="button" onclick="window.clearImg('q')" class="text-xs text-red-500 hover:underline flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> Hapus</button>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 4: PILIHAN JAWABAN -->
                    <div id="q-options-section">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide flex items-center gap-1.5">
                                <i data-lucide="list" class="w-3.5 h-3.5"></i> Pilihan Jawaban
                            </label>
                            <button type="button" onclick="window.addOptionInput()" class="text-xs text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1 bg-blue-50 hover:bg-blue-100 px-2.5 py-1.5 rounded-lg transition-colors">
                                <i data-lucide="plus" class="w-3.5 h-3.5"></i> Tambah Opsi
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mb-3">Teks boleh kosong jika pilihan berupa gambar saja. Pastikan kunci jawaban sudah dipilih di atas.</p>
                        <div id="q-options-container" class="space-y-2"></div>
                    </div>

                    <!-- Info box untuk tipe benar/salah (menggantikan pilihan jawaban) -->
                    <div id="q-truefalse-info" class="hidden bg-amber-50 rounded-xl border border-amber-200 p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="info" class="w-4 h-4 text-amber-600 shrink-0"></i>
                            <p class="text-sm font-bold text-amber-800">Soal Benar / Salah</p>
                        </div>
                        <p class="text-xs text-amber-700 leading-relaxed">Tipe soal ini otomatis menampilkan dua pilihan: <strong>‚úì BENAR</strong> dan <strong>‚úó SALAH</strong>. Tidak perlu mengisi pilihan jawaban secara manual ‚Äî cukup tulis pernyataannya di atas dan pilih kunci jawaban yang tepat.</p>
                    </div>

                    <!-- Info box untuk tipe esai -->
                    <div id="q-essay-info" class="hidden bg-purple-50 rounded-xl border border-purple-200 p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="pencil-line" class="w-4 h-4 text-purple-600 shrink-0"></i>
                            <p class="text-sm font-bold text-purple-800">Soal Esai / Uraian</p>
                        </div>
                        <p class="text-xs text-purple-700 leading-relaxed">Siswa akan menulis jawaban uraian bebas. Koreksi dilakukan setelah ujian: <strong>otomatis oleh AI</strong> berdasarkan rubrik, atau <strong>manual oleh guru</strong> dengan override nilai.</p>
                    </div>

                </div>

                <!-- Footer Actions -->
                <div class="flex justify-end gap-3 px-6 py-4 border-t bg-gray-50 rounded-b-2xl shrink-0">
                    <button type="button" onclick="window.closeQuestionModal()" class="px-5 py-2.5 border rounded-xl text-gray-700 hover:bg-gray-100 text-sm font-semibold transition-colors">Batal</button>
                    <button type="submit" class="px-6 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold text-sm flex items-center gap-2 shadow-md active:scale-95 transition-all">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan Soal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL KOREKSI ESAI -->
    <div id="modal-koreksi-essay" class="fixed inset-0 z-50 flex items-start justify-center bg-black/60 backdrop-blur-sm hidden overflow-y-auto py-6 px-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl my-auto">
            <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50 rounded-t-2xl sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-purple-100 p-2 rounded-lg"><i data-lucide="pencil-line" class="w-5 h-5 text-purple-600"></i></div>
                    <div>
                        <h3 class="text-base font-bold text-gray-800">Koreksi Soal Esai</h3>
                        <p class="text-xs text-gray-500">Siswa: <span id="ke-student-name" class="font-semibold text-purple-600">‚Äî</span></p>
                    </div>
                </div>
                <button onclick="window.closeKoreksiEssay()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-200 rounded-lg transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <!-- Summary bar -->
            <div class="px-6 py-3 bg-purple-50 border-b flex items-center gap-4 flex-wrap">
                <div class="text-sm text-purple-800">
                    Skor pilihan: <strong id="ke-score-mc">‚Äî</strong>
                    &nbsp;¬∑&nbsp; Skor esai: <strong id="ke-score-essay">0</strong>
                    &nbsp;¬∑&nbsp; Total: <strong id="ke-score-total" class="text-lg text-purple-700">‚Äî</strong>
                </div>
                <div class="ml-auto flex gap-2 flex-wrap">
                    <button onclick="window.koreksiAISemua()" id="ke-btn-ai" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition-all active:scale-95 shadow-sm">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> Koreksi Semua dengan AI
                    </button>
                    <button onclick="window.simpanKoreksiEssay()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition-all active:scale-95 shadow-sm">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan Semua
                    </button>
                </div>
            </div>

            <!-- Essay questions list -->
            <div id="ke-questions-list" class="px-6 py-5 space-y-6 max-h-[65vh] overflow-y-auto">
                <p class="text-sm text-gray-400 text-center py-8">Memuat soal esai...</p>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT JADWAL -->
    <div id="modal-edit-jadwal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
            <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="bg-violet-100 p-2 rounded-lg"><i data-lucide="calendar-days" class="w-5 h-5 text-violet-600"></i></div>
                    <h3 class="text-base font-bold text-gray-800">Edit Jadwal Sesi</h3>
                </div>
                <button onclick="window.closeEditJadwal()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="px-6 py-5 space-y-4 overflow-y-auto max-h-[75vh]">
                <input type="hidden" id="edit-jdwl-id">

                <!-- Paket Soal -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Paket Soal <span class="text-red-500">*</span></label>
                    <select id="edit-jdwl-paket" onchange="window.onEditJadwalPaketChange()" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-violet-500 bg-white">
                        <option value="">‚Äî Pilih Paket Soal ‚Äî</option>
                    </select>
                    <input type="hidden" id="edit-jdwl-paket-id">
                </div>

                <!-- Kelas info -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Kelas <span class="text-gray-400 font-normal">(otomatis dari paket)</span></label>
                    <div id="edit-jdwl-kelas-info" class="w-full px-3 py-2 border border-dashed border-gray-300 rounded-lg text-sm bg-gray-50 text-gray-400 italic min-h-[38px] flex items-center flex-wrap gap-1">‚Äî</div>
                    <input type="hidden" id="edit-jdwl-kelas">
                    <input type="hidden" id="edit-jdwl-kelas-arr">
                </div>

                <!-- Nama Sesi -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Nama Sesi <span class="text-red-500">*</span></label>
                    <input type="text" id="edit-jdwl-nama" placeholder="Nama sesi ujian..." class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-violet-500 bg-white">
                </div>

                <!-- Tanggal + Jam -->
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Tanggal <span class="text-red-500">*</span></label>
                        <input type="date" id="edit-jdwl-tanggal" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-violet-500 bg-white">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Jam Mulai <span class="text-red-500">*</span></label>
                        <input type="time" id="edit-jdwl-mulai" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-violet-500 bg-white">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Jam Selesai <span class="text-red-500">*</span></label>
                        <input type="time" id="edit-jdwl-selesai" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-violet-500 bg-white">
                    </div>
                </div>

                <!-- Token & Durasi -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Token Ujian <span class="text-violet-500 font-normal italic">(dari paket)</span></label>
                        <input type="text" id="edit-jdwl-token" class="w-full px-3 py-2 border rounded-lg text-sm outline-none bg-violet-50 font-mono font-bold tracking-widest text-violet-700" readonly>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Durasi (menit) <span class="text-violet-500 font-normal italic">(dari paket)</span></label>
                        <input type="number" id="edit-jdwl-durasi" min="1" max="300" class="w-full px-3 py-2 border rounded-lg text-sm outline-none bg-violet-50" readonly>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 px-6 py-4 border-t bg-gray-50">
                <button onclick="window.closeEditJadwal()" class="px-5 py-2.5 border rounded-xl text-gray-700 hover:bg-gray-100 text-sm font-semibold transition-colors">Batal</button>
                <button onclick="window.simpanEditJadwal()" class="px-6 py-2.5 bg-violet-600 text-white rounded-xl hover:bg-violet-700 font-bold text-sm flex items-center gap-2 shadow-md active:scale-95 transition-all">
                    <i data-lucide="save" class="w-4 h-4"></i> Simpan Perubahan
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL BUAT / EDIT PAKET SOAL -->
    <div id="modal-paket" class="fixed inset-0 z-50 flex items-start justify-center bg-black/60 backdrop-blur-sm hidden overflow-y-auto py-6 px-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg my-auto">
            <div class="flex justify-between items-center px-6 py-4 border-b bg-gray-50 rounded-t-2xl sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-100 p-2 rounded-lg"><i data-lucide="layers" class="w-5 h-5 text-indigo-600"></i></div>
                    <h3 id="modal-paket-title" class="text-base font-bold text-gray-800">Buat Paket Soal Baru</h3>
                </div>
                <button onclick="window.closePaketModal()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="form-paket" onsubmit="window.savePaket(event)" class="p-6 pb-8 space-y-4">
                <input type="hidden" id="paket-id">
                <!-- Nama Paket -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Nama Paket <span class="text-red-500">*</span></label>
                    <input type="text" id="paket-nama" placeholder="Contoh: Informatika Kelas X" required class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 text-sm bg-gray-50 focus:bg-white transition-colors font-medium">
                    <p class="text-xs text-gray-400 mt-1">Nama mata pelajaran dan kelas, misal "Informatika Kelas XI TKJ 1".</p>
                </div>
                <!-- Mata Pelajaran / Keterangan -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Mata Pelajaran / Keterangan</label>
                    <input type="text" id="paket-mapel" placeholder="Contoh: Ujian Tengah Semester Genap 2025" class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 text-sm bg-gray-50 focus:bg-white transition-colors">
                </div>
                <!-- Jenis Paket -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Jenis Paket</label>
                    <div class="flex flex-wrap gap-2" id="paket-jenis-options">
                        <label class="paket-jenis-label cursor-pointer">
                            <input type="radio" name="paket-jenis" value="nonpaket" class="sr-only" checked>
                            <span class="paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold border-indigo-500 bg-indigo-50 text-indigo-700">Non Paket</span>
                        </label>
                        <label class="paket-jenis-label cursor-pointer">
                            <input type="radio" name="paket-jenis" value="A" class="sr-only">
                            <span class="paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold border-gray-200 bg-white text-gray-500">Paket A</span>
                        </label>
                        <label class="paket-jenis-label cursor-pointer">
                            <input type="radio" name="paket-jenis" value="B" class="sr-only">
                            <span class="paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold border-gray-200 bg-white text-gray-500">Paket B</span>
                        </label>
                        <label class="paket-jenis-label cursor-pointer">
                            <input type="radio" name="paket-jenis" value="C" class="sr-only">
                            <span class="paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold border-gray-200 bg-white text-gray-500">Paket C</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-400 mt-1.5">Paket A/B/C jika soal dibagi grup. Non Paket jika semua siswa mengerjakan soal yang sama.</p>
                </div>
                <!-- Kelas -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Kelas yang Mengerjakan</label>
                    <div id="paket-kelas-checks" class="flex flex-wrap gap-2">
                        <span class="text-xs text-gray-400 italic">Memuat daftar kelas...</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1.5">Kosongkan = semua kelas bisa mengerjakan paket ini.</p>
                </div>
                <!-- Token -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5 flex items-center gap-1.5">
                        <i data-lucide="key" class="w-4 h-4 text-yellow-500"></i> Token Akses Paket <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="paket-token" placeholder="Contoh: INFO2025" required class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-yellow-400 text-sm font-mono uppercase bg-yellow-50 focus:bg-yellow-50 tracking-widest font-bold">
                    <p class="text-xs text-gray-400 mt-1">Siswa harus memasukkan token ini untuk bisa memulai ujian paket ini.</p>
                </div>
                <!-- Jumlah Soal -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5 flex items-center gap-1.5">
                        <i data-lucide="list-ordered" class="w-4 h-4 text-blue-500"></i> Jumlah Soal yang Ditampilkan
                    </label>
                    <input type="number" id="paket-jumlah-soal" placeholder="Contoh: 20" min="1" class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-blue-400 text-sm bg-blue-50 focus:bg-blue-50 font-bold text-gray-800">
                    <p class="text-xs text-gray-400 mt-1">Kosongkan = tampilkan semua soal dalam paket. Isi angka untuk membatasi jumlah soal yang diambil secara acak.</p>
                </div>
                <!-- Nilai Maksimal -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5 flex items-center gap-1.5">
                        <i data-lucide="trophy" class="w-4 h-4 text-emerald-500"></i> Nilai Maksimal
                    </label>
                    <input type="number" id="paket-nilai-maks" placeholder="Default: 100" min="1" max="10000" class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm bg-emerald-50 focus:bg-emerald-50 font-bold text-gray-800">
                    <div class="mt-2 p-3 bg-gray-50 rounded-xl border border-gray-200">
                        <p class="text-xs text-gray-500 font-semibold mb-1">üí° Cara penghitungan nilai:</p>
                        <p class="text-xs text-gray-500">Nilai = (Jawaban Benar √∑ Total Soal) √ó Nilai Maksimal</p>
                        <p class="text-xs text-gray-400 mt-1">Contoh: 40 soal, nilai maks 100 ‚Üí tiap soal bernilai <strong>2,5 poin</strong>. Jika benar 30 soal ‚Üí nilai = (30√∑40)√ó100 = <strong>75</strong></p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Kosongkan = nilai maksimal 100 (default).</p>
                </div>
                <!-- Status -->
                <div class="flex items-center justify-between bg-gray-50 rounded-xl border px-4 py-3">
                    <div>
                        <p class="text-sm font-semibold text-gray-700">Status Paket</p>
                        <p class="text-xs text-gray-400">Paket nonaktif tidak bisa dikerjakan siswa.</p>
                    </div>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="paket-aktif" class="sr-only peer" checked>
                            <div class="w-12 h-6 bg-gray-300 rounded-full peer peer-checked:bg-green-500 transition-colors"></div>
                            <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform peer-checked:translate-x-6"></div>
                        </div>
                        <span id="paket-aktif-label" class="text-sm font-bold text-green-600">Aktif</span>
                    </label>
                </div>

                <div class="flex justify-end gap-3 pt-2 border-t">
                    <button type="button" onclick="window.closePaketModal()" class="px-5 py-2.5 border rounded-xl text-gray-700 hover:bg-gray-100 text-sm font-semibold">Batal</button>
                    <button type="submit" class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold text-sm flex items-center gap-2 shadow-md">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan Paket
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL CHEATING ALERT -->
    <div id="modal-cheat-alert" class="fixed inset-0 z-[60] flex items-center justify-center bg-red-900/90 backdrop-blur-sm hidden animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 text-center border-4 border-red-600 relative overflow-hidden">
            <!-- Background pulse effect -->
            <div class="absolute inset-0 bg-red-50 animate-pulse -z-10"></div>
            
            <div class="w-24 h-24 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-red-200">
                <i data-lucide="siren" class="w-12 h-12 animate-bounce"></i>
            </div>
            
            <h2 class="text-3xl font-extrabold text-red-700 mb-2 uppercase tracking-wider">PERINGATAN BAHAYA!</h2>
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="cheat-student-name">Nama Siswa</h3>
            
            <div class="bg-red-100 border border-red-200 p-4 rounded-xl mb-6">
                <p class="text-red-800 font-semibold text-lg" id="cheat-message">Terdeteksi melakukan kecurangan!</p>
                <div class="mt-2 text-sm text-red-600">
                    Status: <span id="cheat-status" class="font-bold">DISKUALIFIKASI</span> | 
                    Pelanggaran: <span id="cheat-count" class="font-bold">3x</span>
                </div>
            </div>
            
            <button onclick="window.closeCheatAlert()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-red-500/50 transition-all active:scale-95 text-lg uppercase tracking-wide">
                MENGERTI & TUTUP
            </button>
        </div>
    </div>
    
    <!-- MODAL VIOLATION DETAILS (NEW) -->
    <div id="modal-violation-details" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-red-600 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i> Detail Pelanggaran
                </h3>
                <button onclick="document.getElementById('modal-violation-details').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">Siswa: <span id="violation-student-name" class="font-bold text-gray-800">Nama Siswa</span></p>
                <div class="bg-red-50 p-2 rounded text-xs text-red-600 mb-2 border border-red-100 flex items-start gap-2">
                    <i data-lucide="info" class="w-4 h-4 shrink-0 mt-0.5"></i>
                    <span>Log ini mencatat waktu dan alasan sistem mendeteksi ketidakjujuran selama ujian berlangsung.</span>
                </div>
                <div id="violation-list" class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                    <!-- Logs go here -->
                </div>
            </div>
            <div class="flex justify-end">
                <button onclick="document.getElementById('modal-violation-details').classList.add('hidden')" class="px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-bold shadow hover:bg-gray-900">Tutup</button>
            </div>
        </div>
    </div>

    <!-- SECTION: DASHBOARD GURU -->
    <div id="section-dashboard" class="hidden-section min-h-screen bg-slate-50 flex flex-col">
        <header class="bg-slate-900 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="dash-header-icon" class="bg-blue-500 p-2 rounded-lg"><i data-lucide="monitor" class="w-6 h-6 text-white"></i></div>
                    <div>
                        <h1 id="dash-header-title" class="font-bold text-lg">Panel Guru / Admin</h1>
                        <p id="dash-header-subtitle" class="text-xs text-slate-400">Monitoring & Bank Soal</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Info Ujian ‚Äî hanya muncul saat login sebagai Pengawas -->
                    <div id="pengawas-exam-info" class="hidden flex-col items-end text-right">
                        <p id="pengawas-exam-judul" class="text-sm font-black text-white leading-tight"></p>
                        <p id="pengawas-exam-sub" class="text-[11px] text-amber-300 font-semibold leading-tight"></p>
                    </div>
                    <div id="pengawas-room-badge" class="hidden items-center gap-2 bg-amber-500/20 border border-amber-400/30 px-3 py-1.5 rounded-full">
                        <i data-lucide="door-open" class="w-4 h-4 text-amber-300"></i>
                        <span id="pengawas-room-label" class="text-sm font-bold text-amber-200">Ruang 1</span>
                    </div>
                    <!-- Info Ujian ‚Äî hanya muncul saat login sebagai Admin -->
                    <div id="admin-exam-info" class="hidden flex-col items-end text-right">
                        <p id="admin-exam-judul" class="text-sm font-black text-white leading-tight"></p>
                        <p id="admin-exam-sub" class="text-[11px] text-blue-300 font-semibold leading-tight"></p>
                    </div>
                    <button onclick="window.logout()" class="text-slate-300 hover:text-white flex items-center gap-2 text-sm"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar</button>
                </div>
            </div>
        </header>
        <main class="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 pb-24 md:pb-6">
            
            <!-- TABS DASHBOARD ‚Äî Desktop: horizontal pill tabs | Mobile: dihapus (pakai bottom nav) -->
            <div class="hidden md:flex gap-2 mb-6 bg-white rounded-2xl shadow-sm border border-gray-100 p-1.5">
                <button onclick="window.switchDashTab('welcome')" id="tab-dash-welcome" class="admin-only-tab flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl text-gray-500 hover:bg-gray-100 font-bold text-sm transition-all">
                    <i data-lucide="home" class="w-4 h-4"></i><span class="hidden lg:inline">Beranda</span>
                </button>
                <button onclick="window.switchDashTab('nilai')" id="tab-dash-nilai" class="flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl bg-blue-600 text-white font-bold text-sm transition-all">
                    <i data-lucide="bar-chart-2" class="w-4 h-4"></i><span class="hidden lg:inline">Monitoring</span> Nilai
                </button>
                <button onclick="window.switchDashTab('analitik')" id="tab-dash-analitik" class="flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl text-gray-500 hover:bg-gray-100 font-bold text-sm transition-all">
                    <i data-lucide="shield-check" class="w-4 h-4"></i><span class="hidden lg:inline">Analitik</span><span class="lg:hidden">Analitik</span>
                </button>
                <button onclick="window.switchDashTab('kelas')" id="tab-dash-kelas" class="admin-only-tab flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl text-gray-500 hover:bg-gray-100 font-bold text-sm transition-all">
                    <i data-lucide="school" class="w-4 h-4"></i><span class="hidden lg:inline">Manajemen</span> Kelas
                </button>
                <button onclick="window.switchDashTab('soal')" id="tab-dash-soal" class="admin-only-tab flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl text-gray-500 hover:bg-gray-100 font-bold text-sm transition-all">
                    <i data-lucide="layers" class="w-4 h-4"></i><span class="hidden lg:inline">Manajemen</span> Soal
                </button>
                <button onclick="window.switchDashTab('ruang')" id="tab-dash-ruang" class="admin-only-tab flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl text-gray-500 hover:bg-gray-100 font-bold text-sm transition-all">
                    <i data-lucide="door-open" class="w-4 h-4"></i><span class="hidden lg:inline">Manajemen</span> Ruang
                </button>
                <button onclick="window.switchDashTab('jadwal')" id="tab-dash-jadwal" class="admin-only-tab flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl text-gray-500 hover:bg-gray-100 font-bold text-sm transition-all">
                    <i data-lucide="calendar-clock" class="w-4 h-4"></i><span class="hidden lg:inline">Jadwal</span>
                </button>
                <button onclick="window.switchDashTab('tampilan')" id="tab-dash-tampilan" class="admin-only-tab flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl text-gray-500 hover:bg-gray-100 font-bold text-sm transition-all">
                    <i data-lucide="palette" class="w-4 h-4"></i><span class="hidden lg:inline">Setting</span> Tampilan
                </button>
            </div>

            <!-- PANEL 0: BERANDA / WELCOME ADMIN -->
            <div id="panel-welcome" class="hidden-section admin-only-panel">

                <!-- Hero Card -->
                <div class="relative overflow-hidden rounded-3xl mb-6 p-8 md:p-10" style="background:linear-gradient(135deg,#1e3a8a 0%,#2563eb 50%,#6366f1 100%);">
                    <!-- Background decorations -->
                    <div class="pointer-events-none absolute -top-16 -right-16 w-64 h-64 rounded-full" style="background:rgba(255,255,255,0.05)"></div>
                    <div class="pointer-events-none absolute -bottom-10 -left-10 w-48 h-48 rounded-full" style="background:rgba(255,255,255,0.04)"></div>
                    <div class="pointer-events-none absolute top-4 right-32 w-20 h-20 rounded-full" style="background:rgba(255,255,255,0.06)"></div>
                    <div class="relative z-10 flex flex-col md:flex-row md:items-center gap-6">
                        <div class="w-16 h-16 md:w-20 md:h-20 rounded-2xl flex items-center justify-center shrink-0" style="background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)">
                            <i data-lucide="shield-check" class="w-8 h-8 md:w-10 md:h-10 text-white"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold px-3 py-1 rounded-full text-blue-100 border border-blue-300/30" style="background:rgba(255,255,255,0.1)">Platform CBT Terpadu</span>
                            </div>
                            <h1 class="text-2xl md:text-4xl font-black text-white leading-tight mb-2">Selamat Datang di <span style="color:#93c5fd">INTEGRITEST</span></h1>
                            <p class="text-blue-100 text-sm md:text-base leading-relaxed max-w-2xl">Sistem Computer Based Test (CBT) modern dengan keamanan integritas ujian terdepan. Dirancang khusus untuk pengelolaan ujian sekolah yang efisien, transparan, dan dapat dipercaya.</p>
                        </div>
                        <div class="shrink-0 hidden md:flex flex-col items-end gap-2">
                            <div class="text-right">
                                <p class="text-blue-200 text-xs font-semibold uppercase tracking-widest">Versi</p>
                                <p class="text-white font-black text-2xl">2025</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Apa itu INTEGRITEST -->
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-9 h-9 rounded-xl flex items-center justify-center" style="background:#dbeafe"><i data-lucide="info" class="w-5 h-5 text-blue-600"></i></div>
                        <h2 class="text-lg font-black text-gray-800">Apa itu INTEGRITEST?</h2>
                    </div>
                    <p class="text-gray-600 text-sm leading-relaxed mb-4">
                        <strong class="text-gray-800">INTEGRITEST</strong> adalah platform ujian berbasis komputer (<em>Computer Based Test</em>) yang dikembangkan untuk memfasilitasi penyelenggaraan ujian sekolah secara digital ‚Äî mulai dari manajemen soal, pelaksanaan ujian real-time, hingga analisis hasil ujian dan integritas siswa secara menyeluruh.
                    </p>
                    <p class="text-gray-600 text-sm leading-relaxed">
                        Nama <strong class="text-blue-700">INTEGRI</strong>TEST berasal dari kata <em>Integritas</em> + <em>Test</em>, mencerminkan komitmen platform ini terhadap kejujuran dan keadilan dalam setiap proses ujian.
                    </p>
                </div>

                <!-- Fitur Unggulan -->
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-9 h-9 rounded-xl flex items-center justify-center" style="background:#dcfce7"><i data-lucide="zap" class="w-5 h-5 text-emerald-600"></i></div>
                        <h2 class="text-lg font-black text-gray-800">Fitur Lengkap dalam Satu Platform</h2>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5 hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-xl mb-3 flex items-center justify-center" style="background:#eff6ff"><i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-600"></i></div>
                            <h3 class="font-bold text-gray-800 text-sm mb-1">Monitoring Real-Time</h3>
                            <p class="text-gray-500 text-xs leading-relaxed">Pantau progres seluruh siswa secara langsung ‚Äî siapa yang sudah selesai, sedang mengerjakan, atau belum login.</p>
                        </div>
                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5 hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-xl mb-3 flex items-center justify-center" style="background:#f0fdf4"><i data-lucide="shield-alert" class="w-5 h-5 text-emerald-600"></i></div>
                            <h3 class="font-bold text-gray-800 text-sm mb-1">Anti-Kecurangan Otomatis</h3>
                            <p class="text-gray-500 text-xs leading-relaxed">Deteksi perpindahan tab, minimalisasi layar, dan pelanggaran lainnya secara otomatis dengan sistem skor integritas.</p>
                        </div>
                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5 hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-xl mb-3 flex items-center justify-center" style="background:#fff7ed"><i data-lucide="layers" class="w-5 h-5 text-orange-500"></i></div>
                            <h3 class="font-bold text-gray-800 text-sm mb-1">Bank Soal Multi-Paket</h3>
                            <p class="text-gray-500 text-xs leading-relaxed">Kelola soal dalam paket A, B, C, atau non-paket. Upload massal via Excel/Word. Soal diacak otomatis per siswa.</p>
                        </div>
                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5 hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-xl mb-3 flex items-center justify-center" style="background:#fdf4ff"><i data-lucide="calendar-clock" class="w-5 h-5 text-purple-600"></i></div>
                            <h3 class="font-bold text-gray-800 text-sm mb-1">Jadwal Otomatis</h3>
                            <p class="text-gray-500 text-xs leading-relaxed">Atur jadwal ujian per hari dan sesi. Token aktif dan nonaktif otomatis sesuai waktu yang dijadwalkan.</p>
                        </div>
                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5 hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-xl mb-3 flex items-center justify-center" style="background:#f0f9ff"><i data-lucide="users" class="w-5 h-5 text-cyan-600"></i></div>
                            <h3 class="font-bold text-gray-800 text-sm mb-1">Multi-Role & Multi-Ruang</h3>
                            <p class="text-gray-500 text-xs leading-relaxed">Admin koordinator dan pengawas ruang dengan akses berbeda. Setiap pengawas hanya melihat siswa di ruangnya.</p>
                        </div>
                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5 hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-xl mb-3 flex items-center justify-center" style="background:#fff1f2"><i data-lucide="file-text" class="w-5 h-5 text-rose-500"></i></div>
                            <h3 class="font-bold text-gray-800 text-sm mb-1">Laporan PDF Otomatis</h3>
                            <p class="text-gray-500 text-xs leading-relaxed">Cetak laporan integritas individual siswa lengkap dengan log pelanggaran, skor, predikat, dan kesimpulan otomatis.</p>
                        </div>
                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5 hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-xl mb-3 flex items-center justify-center" style="background:#f0fdf4"><i data-lucide="cloud" class="w-5 h-5 text-green-600"></i></div>
                            <h3 class="font-bold text-gray-800 text-sm mb-1">Cloud Real-Time (Firebase)</h3>
                            <p class="text-gray-500 text-xs leading-relaxed">Data tersimpan di cloud Firebase. Jawaban siswa terkirim real-time, aman meski koneksi terputus sesaat.</p>
                        </div>
                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5 hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-xl mb-3 flex items-center justify-center" style="background:#fffbeb"><i data-lucide="smartphone" class="w-5 h-5 text-amber-500"></i></div>
                            <h3 class="font-bold text-gray-800 text-sm mb-1">Responsif di Semua Perangkat</h3>
                            <p class="text-gray-500 text-xs leading-relaxed">Tampilan optimal di HP, tablet, maupun komputer. Admin bisa monitoring dari smartphone kapan saja.</p>
                        </div>
                        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-5 hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-xl mb-3 flex items-center justify-center" style="background:#f0f9ff"><i data-lucide="trophy" class="w-5 h-5 text-blue-500"></i></div>
                            <h3 class="font-bold text-gray-800 text-sm mb-1">Nilai Fleksibel per Paket</h3>
                            <p class="text-gray-500 text-xs leading-relaxed">Atur nilai maksimal per paket soal. Sistem menghitung otomatis nilai tiap soal dan total nilai akhir siswa.</p>
                        </div>
                    </div>
                </div>

                <!-- Keunggulan vs CBT Lain -->
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6 mb-6">
                    <div class="flex items-center gap-3 mb-5">
                        <div class="w-9 h-9 rounded-xl flex items-center justify-center" style="background:#fef9c3"><i data-lucide="award" class="w-5 h-5 text-yellow-600"></i></div>
                        <h2 class="text-lg font-black text-gray-800">Keunggulan INTEGRITEST vs CBT Lainnya</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-separate border-spacing-0">
                            <thead>
                                <tr>
                                    <th class="text-left px-4 py-3 bg-gray-50 rounded-tl-xl text-gray-600 font-bold text-xs border-b border-gray-100">Fitur</th>
                                    <th class="px-4 py-3 bg-blue-600 text-white font-bold text-xs text-center">INTEGRITEST</th>
                                    <th class="px-4 py-3 bg-gray-100 text-gray-500 font-bold text-xs text-center rounded-tr-xl">CBT Umum</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-gray-50">
                                    <td class="px-4 py-3 text-gray-700 font-medium text-xs">Anti-kecurangan real-time</td>
                                    <td class="px-4 py-3 text-center"><span class="text-emerald-600 font-bold">‚úì Otomatis</span></td>
                                    <td class="px-4 py-3 text-center text-gray-400 text-xs">Terbatas</td>
                                </tr>
                                <tr class="border-b border-gray-50 bg-gray-50/50">
                                    <td class="px-4 py-3 text-gray-700 font-medium text-xs">Skor integritas siswa</td>
                                    <td class="px-4 py-3 text-center"><span class="text-emerald-600 font-bold">‚úì Ada</span></td>
                                    <td class="px-4 py-3 text-center text-gray-400 text-xs">Tidak ada</td>
                                </tr>
                                <tr class="border-b border-gray-50">
                                    <td class="px-4 py-3 text-gray-700 font-medium text-xs">Monitoring real-time multi-ruang</td>
                                    <td class="px-4 py-3 text-center"><span class="text-emerald-600 font-bold">‚úì Ada</span></td>
                                    <td class="px-4 py-3 text-center text-gray-400 text-xs">Jarang</td>
                                </tr>
                                <tr class="border-b border-gray-50 bg-gray-50/50">
                                    <td class="px-4 py-3 text-gray-700 font-medium text-xs">Jadwal ujian otomatis</td>
                                    <td class="px-4 py-3 text-center"><span class="text-emerald-600 font-bold">‚úì Ada</span></td>
                                    <td class="px-4 py-3 text-center text-gray-400 text-xs">Tidak ada</td>
                                </tr>
                                <tr class="border-b border-gray-50">
                                    <td class="px-4 py-3 text-gray-700 font-medium text-xs">Laporan integritas PDF</td>
                                    <td class="px-4 py-3 text-center"><span class="text-emerald-600 font-bold">‚úì Otomatis</span></td>
                                    <td class="px-4 py-3 text-center text-gray-400 text-xs">Tidak ada</td>
                                </tr>
                                <tr class="border-b border-gray-50 bg-gray-50/50">
                                    <td class="px-4 py-3 text-gray-700 font-medium text-xs">Nilai maksimal fleksibel per paket</td>
                                    <td class="px-4 py-3 text-center"><span class="text-emerald-600 font-bold">‚úì Ada</span></td>
                                    <td class="px-4 py-3 text-center text-gray-400 text-xs">Jarang</td>
                                </tr>
                                <tr class="border-b border-gray-50">
                                    <td class="px-4 py-3 text-gray-700 font-medium text-xs">Upload soal via Excel/Word</td>
                                    <td class="px-4 py-3 text-center"><span class="text-emerald-600 font-bold">‚úì Ada</span></td>
                                    <td class="px-4 py-3 text-center text-gray-400 text-xs">Terbatas</td>
                                </tr>
                                <tr class="bg-gray-50/50">
                                    <td class="px-4 py-3 text-gray-700 font-medium text-xs rounded-bl-xl">Responsif di HP & PC</td>
                                    <td class="px-4 py-3 text-center"><span class="text-emerald-600 font-bold">‚úì Penuh</span></td>
                                    <td class="px-4 py-3 text-center text-gray-400 text-xs rounded-br-xl">Sebagian</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Panduan Penggunaan -->
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6 mb-6">
                    <div class="flex items-center gap-3 mb-5">
                        <div class="w-9 h-9 rounded-xl flex items-center justify-center" style="background:#ede9fe"><i data-lucide="book-open" class="w-5 h-5 text-purple-600"></i></div>
                        <h2 class="text-lg font-black text-gray-800">Panduan Singkat Penggunaan</h2>
                    </div>
                    <div class="space-y-4">
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-black text-sm text-white" style="background:linear-gradient(135deg,#2563eb,#6366f1)">1</div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">Buat Kelas & Ruang Ujian</p>
                                <p class="text-gray-500 text-xs mt-0.5 leading-relaxed">Masuk ke tab <strong>Kelas</strong> untuk mendaftarkan kelas peserta. Lalu ke tab <strong>Ruang</strong> untuk membuat ruang ujian dan menugaskan pengawas ke tiap ruang.</p>
                            </div>
                        </div>
                        <div class="w-px h-4 bg-gradient-to-b from-blue-200 to-indigo-200 ml-4"></div>
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-black text-sm text-white" style="background:linear-gradient(135deg,#2563eb,#6366f1)">2</div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">Buat Paket Soal</p>
                                <p class="text-gray-500 text-xs mt-0.5 leading-relaxed">Di tab <strong>Soal ‚Üí Paket</strong>, buat paket ujian baru (isi nama, mapel, token, jumlah soal, nilai maksimal, dan kelas yang mengerjakan). Paket bisa dibedakan A/B/C untuk mengurangi contekan.</p>
                            </div>
                        </div>
                        <div class="w-px h-4 bg-gradient-to-b from-blue-200 to-indigo-200 ml-4"></div>
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-black text-sm text-white" style="background:linear-gradient(135deg,#2563eb,#6366f1)">3</div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">Input / Upload Soal</p>
                                <p class="text-gray-500 text-xs mt-0.5 leading-relaxed">Tambahkan soal secara manual satu per satu, atau upload massal via file <strong>Excel (.xlsx)</strong> maupun <strong>Word (.docx)</strong> sesuai template yang tersedia. Soal bisa disertai gambar.</p>
                            </div>
                        </div>
                        <div class="w-px h-4 bg-gradient-to-b from-blue-200 to-indigo-200 ml-4"></div>
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-black text-sm text-white" style="background:linear-gradient(135deg,#2563eb,#6366f1)">4</div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">Atur Jadwal (Opsional)</p>
                                <p class="text-gray-500 text-xs mt-0.5 leading-relaxed">Gunakan tab <strong>Jadwal</strong> untuk menjadwalkan ujian per sesi. Sistem akan otomatis mengaktifkan token ujian tepat waktu dan menonaktifkannya saat sesi selesai.</p>
                            </div>
                        </div>
                        <div class="w-px h-4 bg-gradient-to-b from-blue-200 to-indigo-200 ml-4"></div>
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-black text-sm text-white" style="background:linear-gradient(135deg,#2563eb,#6366f1)">5</div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">Bagikan Token ke Siswa</p>
                                <p class="text-gray-500 text-xs mt-0.5 leading-relaxed">Sampaikan token ujian kepada siswa. Siswa login dengan nama, NISN, kelas, ruang, dan token. Sistem langsung menampilkan paket ujian yang sesuai kelasnya.</p>
                            </div>
                        </div>
                        <div class="w-px h-4 bg-gradient-to-b from-blue-200 to-indigo-200 ml-4"></div>
                        <div class="flex gap-4 items-start">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 font-black text-sm text-white" style="background:linear-gradient(135deg,#2563eb,#6366f1)">6</div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">Monitor & Evaluasi Hasil</p>
                                <p class="text-gray-500 text-xs mt-0.5 leading-relaxed">Pantau ujian real-time di tab <strong>Monitoring Nilai</strong>. Setelah ujian selesai, analisis distribusi nilai dan skor integritas di tab <strong>Analitik</strong>. Export hasil ke CSV atau cetak laporan PDF.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Access Buttons -->
                <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl border border-blue-100 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-9 h-9 rounded-xl flex items-center justify-center" style="background:#dbeafe"><i data-lucide="rocket" class="w-5 h-5 text-blue-600"></i></div>
                        <h2 class="text-base font-black text-gray-800">Mulai Sekarang</h2>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button onclick="window.switchDashTab('nilai')" class="flex flex-col items-center gap-2 p-4 bg-white rounded-xl border border-blue-100 hover:border-blue-400 hover:shadow-md transition-all active:scale-95">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:#eff6ff"><i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-600"></i></div>
                            <span class="text-xs font-bold text-gray-700">Monitoring</span>
                        </button>
                        <button onclick="window.switchDashTab('soal')" class="flex flex-col items-center gap-2 p-4 bg-white rounded-xl border border-orange-100 hover:border-orange-400 hover:shadow-md transition-all active:scale-95">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:#fff7ed"><i data-lucide="layers" class="w-5 h-5 text-orange-500"></i></div>
                            <span class="text-xs font-bold text-gray-700">Kelola Soal</span>
                        </button>
                        <button onclick="window.switchDashTab('jadwal')" class="flex flex-col items-center gap-2 p-4 bg-white rounded-xl border border-purple-100 hover:border-purple-400 hover:shadow-md transition-all active:scale-95">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:#fdf4ff"><i data-lucide="calendar-clock" class="w-5 h-5 text-purple-600"></i></div>
                            <span class="text-xs font-bold text-gray-700">Jadwal</span>
                        </button>
                        <button onclick="window.switchDashTab('analitik')" class="flex flex-col items-center gap-2 p-4 bg-white rounded-xl border border-emerald-100 hover:border-emerald-400 hover:shadow-md transition-all active:scale-95">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:#f0fdf4"><i data-lucide="shield-check" class="w-5 h-5 text-emerald-600"></i></div>
                            <span class="text-xs font-bold text-gray-700">Analitik</span>
                        </button>
                    </div>
                </div>

            </div>

            <!-- PANEL 1: MONITORING NILAI -->
            <div id="panel-nilai">
                <!-- TOKEN INFO CARD ‚Äî hanya muncul untuk pengawas, tersembunyi untuk admin -->
                <div id="pengawas-token-card" class="hidden mb-4 bg-amber-50 border border-amber-300 rounded-xl px-5 py-4">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="bg-amber-500 p-1.5 rounded-lg">
                            <i data-lucide="key" class="w-4 h-4 text-white"></i>
                        </div>
                        <p class="text-xs font-bold text-amber-600 uppercase tracking-wider">Token Ujian Siswa</p>
                        <p class="text-[10px] text-amber-400 ml-auto">Sampaikan ke siswa agar bisa masuk ujian</p>
                    </div>
                    <div id="pengawas-token-list" class="flex flex-wrap gap-3"></div>
                </div>
                <!-- INFO: Penjelasan Monitoring vs Analitik -->
                <div class="mb-4 bg-blue-50 border border-blue-200 rounded-xl px-4 py-3 flex flex-col md:flex-row md:items-center gap-2 md:gap-6 text-xs">
                    <div class="flex items-start gap-2">
                        <i data-lucide="eye" class="w-4 h-4 text-blue-500 shrink-0 mt-0.5"></i>
                        <div>
                            <span class="font-bold text-blue-800">Tab Monitoring (tab ini):</span>
                            <span class="text-blue-600"> Menampilkan <strong>SEMUA siswa secara real-time</strong> ‚Äî termasuk yang sedang mengerjakan. Data diperbarui otomatis. Gunakan untuk <em>memantau ujian berlangsung</em> dan export rekap.</span>
                        </div>
                    </div>
                    <div class="hidden md:block w-px h-8 bg-blue-200 shrink-0"></div>
                    <div class="flex items-start gap-2">
                        <i data-lucide="shield-check" class="w-4 h-4 text-indigo-500 shrink-0 mt-0.5"></i>
                        <div>
                            <span class="font-bold text-indigo-800">Tab Analitik:</span>
                            <span class="text-indigo-600"> Hanya <strong>siswa yang sudah SELESAI/DQ</strong>. Dilengkapi grafik distribusi nilai, skor integritas per siswa, dan laporan PDF individual. Gunakan untuk <em>evaluasi pasca ujian</em>.</span>
                        </div>
                    </div>
                </div>
                <!-- MODIFIED: PENGATURAN TOKEN DAN DURASI -->
                <div class="admin-only-el bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-gray-600"></i> Pengaturan Ujian</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                        <!-- Input Token -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Token Akses</label>
                            <div class="flex gap-2">
                                <div class="bg-blue-50 p-2 rounded border border-blue-200 flex items-center justify-center">
                                    <i data-lucide="key" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <input type="text" id="teacher-token-input" class="w-full px-4 py-2 border rounded-lg font-mono text-xl font-bold tracking-widest text-center uppercase text-blue-600 bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="LOADING..." value="TKJ2025">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Token wajib diisi siswa untuk login.</p>
                        </div>
                        
                        <!-- Input Durasi -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Durasi Ujian (Menit)</label>
                            <div class="flex gap-2">
                                <div class="bg-orange-50 p-2 rounded border border-orange-200 flex items-center justify-center">
                                    <i data-lucide="clock" class="w-5 h-5 text-orange-600"></i>
                                </div>
                                <input type="number" id="teacher-duration-input" min="1" class="w-full px-4 py-2 border rounded-lg font-bold text-center text-orange-600 bg-gray-50 focus:ring-2 focus:ring-orange-500 outline-none" placeholder="60" value="60">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Waktu hitung mundur otomatis.</p>
                        </div>
                        
                        <!-- Input Min Duration -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Min. Submit (Menit)</label>
                            <div class="flex gap-2">
                                <div class="bg-red-50 p-2 rounded border border-red-200 flex items-center justify-center">
                                    <i data-lucide="hourglass" class="w-5 h-5 text-red-600"></i>
                                </div>
                                <input type="number" id="teacher-min-duration-input" min="0" class="w-full px-4 py-2 border rounded-lg font-bold text-center text-red-600 bg-gray-50 focus:ring-2 focus:ring-red-500 outline-none" placeholder="0" value="0">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Siswa tidak bisa submit sebelum waktu ini.</p>
                        </div>

                        <!-- Cooldown Device - MENIT -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cooldown Device <span class="text-purple-500 font-semibold">(Menit)</span></label>
                            <div class="flex gap-2">
                                <div class="bg-purple-50 p-2 rounded border border-purple-200 flex items-center justify-center">
                                    <i data-lucide="shield-alert" class="w-5 h-5 text-purple-600"></i>
                                </div>
                                <input type="number" id="teacher-cooldown-input" min="10" step="5" class="w-full px-4 py-2 border rounded-lg font-bold text-center text-purple-600 bg-gray-50 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="30" value="30">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Min. 10 menit. Perangkat terkunci setelah ujian selesai.</p>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                         <button onclick="window.saveSettings()" class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-2 rounded-lg font-bold shadow-md active:scale-95 transition-transform flex items-center gap-2">
                             <i data-lucide="save" class="w-4 h-4"></i> Simpan Pengaturan
                         </button>
                    </div>
                </div>

                <!-- ‚òÖ PANEL KONTROL PEMBAHASAN (NEW) ‚òÖ -->
                <div class="admin-only-el bg-gradient-to-br from-indigo-50 to-blue-50 rounded-xl shadow-sm border border-indigo-200 p-6 mb-6">
                    <h2 class="text-lg font-bold text-indigo-900 mb-4 flex items-center gap-2">
                        <i data-lucide="book-open" class="w-5 h-5 text-indigo-600"></i> Kontrol Pembahasan Soal
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Toggle Pembahasan -->
                        <div class="flex items-center justify-between bg-white rounded-lg p-4 border border-indigo-200">
                            <div>
                                <p class="font-semibold text-gray-800">Aktifkan Pembahasan</p>
                                <p class="text-sm text-gray-600">Siswa dapat melihat kunci jawaban setelah selesai ujian</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggle-discussion" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>

                        <!-- Mode Pembahasan -->
                        <div class="bg-white rounded-lg p-4 border border-indigo-200">
                            <p class="font-semibold text-gray-800 mb-3">Mode Pembahasan</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 transition">
                                    <input type="radio" name="discussion-mode" value="after-exam" checked class="w-4 h-4 text-indigo-600">
                                    <span class="ml-3">
                                        <p class="font-medium text-gray-800">Setelah Ujian Selesai</p>
                                        <p class="text-xs text-gray-600">Siswa langsung bisa lihat pembahasan</p>
                                    </span>
                                </label>
                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 transition">
                                    <input type="radio" name="discussion-mode" value="manual" class="w-4 h-4 text-indigo-600">
                                    <span class="ml-3">
                                        <p class="font-medium text-gray-800">Buka Manual</p>
                                        <p class="text-xs text-gray-600">Admin kontrol kapan pembahasan dibuka</p>
                                    </span>
                                </label>
                                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-red-50 transition">
                                    <input type="radio" name="discussion-mode" value="never" class="w-4 h-4 text-red-600">
                                    <span class="ml-3">
                                        <p class="font-medium text-gray-800">Jangan Tampilkan</p>
                                        <p class="text-xs text-gray-600">Pembahasan tidak tersedia</p>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Tombol Buka Pembahasan (untuk mode manual) -->
                        <div id="manual-control-area" class="hidden bg-white rounded-lg p-4 border border-amber-300 bg-amber-50">
                            <p class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600"></i> Kontrol Manual
                            </p>
                            <button onclick="window.toggleDiscussionManually()" id="btn-toggle-manual-discussion" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 rounded-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                                <i data-lucide="unlock" class="w-5 h-5"></i> Buka Pembahasan untuk Siswa
                            </button>
                            <p class="text-xs text-gray-600 mt-2">Klik tombol di atas untuk membuka akses pembahasan ke semua siswa yang sudah selesai ujian.</p>
                        </div>

                        <!-- Info Status -->
                        <div id="discussion-info-box" class="bg-white rounded-lg p-4 border border-indigo-200">
                            <p class="text-sm">
                                <span class="font-semibold">Status Pembahasan:</span>
                                <span id="discussion-status-text" class="text-indigo-600 font-bold">‚úÖ Aktif (Setelah Ujian Selesai)</span>
                            </p>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-end gap-2">
                        <button onclick="window.saveDiscussionSettings()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow-md active:scale-95 transition-transform flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i> Simpan Pengaturan Pembahasan
                        </button>
                    </div>
                </div>

                <!-- ‚ïê‚ïê STAT CARDS ‚ïê‚ïê -->
                <div id="stat-cards-area" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-8 gap-3 mb-6">
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center shrink-0">
                            <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Total Peserta</p>
                            <p id="sc-total" class="text-2xl font-black text-gray-800">0</p>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center shrink-0">
                            <i data-lucide="check-circle-2" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Selesai</p>
                            <div class="flex items-baseline gap-2">
                                <p id="sc-selesai" class="text-2xl font-black text-green-600">0</p>
                                <p id="sc-selesai-pct" class="text-sm font-bold text-green-400">0%</p>
                            </div>
                            <div class="h-1.5 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                                <div id="sc-bar-selesai" class="h-full bg-green-500 rounded-full transition-all duration-700" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-sky-100 flex items-center justify-center shrink-0">
                            <i data-lucide="loader-2" class="w-6 h-6 text-sky-600 animate-spin"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Sedang Ujian</p>
                            <div class="flex items-baseline gap-2">
                                <p id="sc-ongoing" class="text-2xl font-black text-sky-600">0</p>
                                <p id="sc-ongoing-pct" class="text-sm font-bold text-sky-400">0%</p>
                            </div>
                            <div class="h-1.5 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                                <div id="sc-bar-ongoing" class="h-full bg-sky-400 rounded-full transition-all duration-700" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center shrink-0">
                            <i data-lucide="shield-x" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Curang / DQ</p>
                            <div class="flex items-baseline gap-2">
                                <p id="sc-dq" class="text-2xl font-black text-red-600">0</p>
                                <p id="sc-dq-pct" class="text-sm font-bold text-red-400">0%</p>
                            </div>
                            <div class="h-1.5 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                                <div id="sc-bar-dq" class="h-full bg-red-500 rounded-full transition-all duration-700" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-yellow-100 flex items-center justify-center shrink-0">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Ada Pelanggaran</p>
                            <div class="flex items-baseline gap-2">
                                <p id="sc-violations" class="text-2xl font-black text-yellow-600">0</p>
                                <p id="sc-violations-pct" class="text-sm font-bold text-yellow-400">0%</p>
                            </div>
                            <div class="h-1.5 bg-gray-100 rounded-full mt-1.5 overflow-hidden">
                                <div id="sc-bar-violations" class="h-full bg-yellow-400 rounded-full transition-all duration-700" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center shrink-0">
                            <i data-lucide="bar-chart-3" class="w-6 h-6 text-purple-600"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Rata-rata Nilai</p>
                            <p id="sc-avg" class="text-2xl font-black text-purple-600">‚Äî</p>
                        </div>
                    </div>
                    <div class="col-span-2 md:col-span-2 xl:col-span-2 bg-white rounded-xl border shadow-sm p-4 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center shrink-0">
                            <i data-lucide="trending-up" class="w-6 h-6 text-emerald-600"></i>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Lulus (‚â•75)</p>
                            <div class="flex items-baseline gap-2">
                                <p id="sc-lulus" class="text-2xl font-black text-emerald-600">0</p>
                                <p id="sc-lulus-pct" class="text-sm font-bold text-emerald-400">0%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <div class="p-6 border-b flex flex-col gap-4">
                        <div class="flex justify-between items-center flex-wrap gap-3">
                            <div class="flex items-center gap-3 flex-wrap">
                                <h2 class="text-lg font-bold text-gray-800">Data Hasil Ujian</h2>
                                <!-- SESI BADGE -->
                                </span>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="window.showKelasStatistikModal()" class="bg-violet-600 hover:bg-violet-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm transition hover:scale-105">
                                    <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Statistik Kelas
                                </button>
                                <button id="btn-reset-all" onclick="window.resetAllExamData()" class="admin-only-el bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm transition hover:scale-105"><i data-lucide="trash-2" class="w-4 h-4"></i> Reset Jadwal Ini</button>
                                <button onclick="window.exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-md transition hover:scale-105 hover:shadow-emerald-500/30">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Export Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">üìÖ Jadwal Ujian</label>
                                <select id="filter-sesi" onchange="if(window._pg)window._pg.monitoring.page=1; window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option value="active">Jadwal Aktif</option>
                                    <option value="all">Semua Jadwal (History)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Ruang Ujian</label>
                                <select id="filter-ruang" onchange="if(window._pg)window._pg.monitoring.page=1; window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="all">Semua Ruang</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Paket Soal</label>
                                <select id="filter-session" onchange="if(window._pg)window._pg.monitoring.page=1; window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="all">Semua Paket</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Kelas</label>
                                <select id="filter-class" onchange="if(window._pg)window._pg.monitoring.page=1; window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="all">Semua Kelas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Tanggal</label>
                                <input type="date" id="filter-date" onchange="if(window._pg)window._pg.monitoring.page=1; window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-900 font-semibold border-b sticky top-0 z-10">
                                    <th class="px-6 py-4">Nama Siswa</th>
									<th id="th-nisn" class="px-6 py-4">NISN</th>
                                    <th class="px-6 py-4">Kelas</th>
                                    <th class="px-6 py-4">Ruang</th>
                                    <th class="px-6 py-4">Paket</th>
                                    <th class="px-6 py-4 text-center">Nilai</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-center">Pelanggaran</th>
                                    <th class="px-6 py-4 text-center">Integritas</th>
                                    <th class="px-6 py-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="10" class="px-6 py-12 text-center text-gray-400">Menunggu data ujian...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="pager-monitoring-wrap"></div>
                </div>

                <!-- ‚ïê‚ïê MODAL STATISTIK KELAS ‚ïê‚ïê -->
                <div id="modal-kelas-statistik" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden" onclick="if(event.target===this)window.closeKelasStatistikModal()">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl mx-4 overflow-hidden max-h-[90vh] flex flex-col">
                        <div class="bg-gradient-to-r from-violet-700 to-indigo-700 px-6 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="bg-white/15 p-2 rounded-lg"><i data-lucide="bar-chart-2" class="w-5 h-5 text-white"></i></div>
                                <div>
                                    <h3 class="text-white font-bold text-base">Statistik Nilai Per Kelas</h3>
                                    <p class="text-violet-200 text-xs mt-0.5">Data real-time dari sesi aktif (siswa selesai ujian)</p>
                                </div>
                            </div>
                            <button onclick="window.closeKelasStatistikModal()" class="text-white/70 hover:text-white transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="overflow-y-auto flex-1 p-6">
                            <div id="kelas-statistik-content">
                                <div class="text-center py-8 text-gray-400"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i><p>Memuat data...</p></div>
                            </div>
                        </div>
                        <div class="p-4 border-t bg-gray-50 flex justify-end gap-2">
                            <button onclick="window.closeKelasStatistikModal()" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold transition-colors">Tutup</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PANEL 2: MANAJEMEN SOAL (BANK SOAL) -->
            <!-- PANEL 2: BANK SOAL (REDESIGNED) -->
            <!-- PANEL 2: MANAJEMEN SOAL (REDESIGNED - PAKET FIRST) -->
            <div id="panel-soal" class="hidden-section admin-only-panel">

                <!-- ‚ïê‚ïê STEP 1: DAFTAR PAKET SOAL ‚ïê‚ïê -->
                <div id="view-paket-list">

                    <!-- Banner header ‚Äî slate gelap, bukan biru terang -->
                    <div class="rounded-2xl mb-5 overflow-hidden shadow-lg border border-gray-200">
                        <!-- Stripe atas berwarna -->
                        <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-6 pt-5 pb-4 text-white">
                            <div class="flex items-start gap-4">
                                <div class="bg-white/10 border border-white/20 p-2.5 rounded-xl shrink-0">
                                    <i data-lucide="layers" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <h2 class="text-lg font-bold mb-0.5">Manajemen Soal</h2>
                                    <p class="text-gray-300 text-sm leading-relaxed">
                                        Buat <strong class="text-white">Paket Soal</strong> terlebih dahulu, lalu masukkan soal ke dalamnya. Setiap paket memiliki token akses, kelas, dan pengaturan sendiri.
                                    </p>
                                    <!-- Alur kerja -->
                                    <div class="flex flex-wrap gap-2 mt-3 text-xs">
                                        <span class="bg-white/10 border border-white/20 px-2.5 py-1 rounded-full flex items-center gap-1.5">
                                            <span class="w-4 h-4 bg-white/20 rounded-full flex items-center justify-center font-bold text-[10px]">1</span> Buat Paket
                                        </span>
                                        <span class="text-gray-500 self-center">‚Ä∫</span>
                                        <span class="bg-white/10 border border-white/20 px-2.5 py-1 rounded-full flex items-center gap-1.5">
                                            <span class="w-4 h-4 bg-white/20 rounded-full flex items-center justify-center font-bold text-[10px]">2</span> Kelola Soal
                                        </span>
                                        <span class="text-gray-500 self-center">‚Ä∫</span>
                                        <span class="bg-white/10 border border-white/20 px-2.5 py-1 rounded-full flex items-center gap-1.5">
                                            <span class="w-4 h-4 bg-white/20 rounded-full flex items-center justify-center font-bold text-[10px]">3</span> Tambah / Import
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Strip bawah: download template dengan warna khas masing-masing format -->
                        <div class="bg-gray-50 border-t border-gray-200 px-6 py-3 flex flex-wrap items-center gap-3">
                            <span class="text-xs font-semibold text-gray-500 flex items-center gap-1.5">
                                <i data-lucide="download" class="w-3.5 h-3.5"></i> Download Template:
                            </span>
                            <!-- Excel: hijau khas Microsoft Excel -->
                            <button onclick="window.downloadExcelTemplate()" type="button"
                                class="flex items-center gap-2 bg-[#217346] hover:bg-[#1a5c38] text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-colors shadow-sm">
                                <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i>
                                Excel (.xlsx)
                            </button>
                            <!-- Word: biru khas Microsoft Word -->
                            <button onclick="window.downloadWordTemplate()" type="button"
                                class="flex items-center gap-2 bg-[#2B579A] hover:bg-[#1f4178] text-white text-xs font-bold px-3 py-1.5 rounded-lg transition-colors shadow-sm">
                                <i data-lucide="file-text" class="w-3.5 h-3.5"></i>
                                Word (.docx)
                            </button>
                            <span class="text-xs text-gray-400 ml-1">Gunakan template ini agar format kolom sudah sesuai otomatis.</span>
                        </div>
                    </div>

                    <!-- ‚òÖ INFO: Cara Menggunakan Sistem Paket Acak Otomatis -->
                    <div class="rounded-2xl border border-blue-200 bg-blue-50 overflow-hidden mb-5">
                        <!-- Header info -->
                        <div class="flex items-center gap-3 px-5 py-3.5 border-b border-blue-200 bg-blue-100/60">
                            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shrink-0">
                                <i data-lucide="shuffle" class="w-4 h-4 text-white"></i>
                            </div>
                            <div>
                                <p class="text-sm font-black text-blue-900">Sistem Paket Acak Otomatis</p>
                                <p class="text-[11px] text-blue-600 font-medium">Satu kelas bisa mengerjakan paket berbeda ‚Äî tanpa perlu pengawas mengarahkan manual</p>
                            </div>
                        </div>
                        <!-- Langkah-langkah -->
                        <div class="px-5 py-4 space-y-3">
                            <p class="text-xs font-bold text-blue-800 uppercase tracking-wide">Cara Setup:</p>
                            <div class="space-y-2">
                                <div class="flex items-start gap-3">
                                    <div class="w-5 h-5 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px] font-black shrink-0 mt-0.5">1</div>
                                    <p class="text-xs text-blue-900 leading-relaxed">Buat <strong>2 atau lebih paket</strong> (misal: Paket A, Paket B, Paket C) dengan soal yang berbeda.</p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-5 h-5 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px] font-black shrink-0 mt-0.5">2</div>
                                    <p class="text-xs text-blue-900 leading-relaxed">Assign <strong>kelas yang sama</strong> ke semua paket tersebut (misal: XI TKJ 1 di Paket A, B, dan C).</p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-5 h-5 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px] font-black shrink-0 mt-0.5">3</div>
                                    <p class="text-xs text-blue-900 leading-relaxed">Gunakan <strong>token yang sama</strong> untuk semua paket agar siswa cukup login 1x.</p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-5 h-5 rounded-full bg-emerald-600 text-white flex items-center justify-center text-[10px] font-black shrink-0 mt-0.5">‚úì</div>
                                    <p class="text-xs text-blue-900 leading-relaxed">Saat siswa login, <strong>sistem otomatis memilihkan 1 paket secara acak</strong> ‚Äî setiap siswa bisa dapat paket yang berbeda tanpa campur tangan pengawas.</p>
                                </div>
                            </div>
                            <!-- Contoh visual -->
                            <div class="mt-3 rounded-xl bg-white border border-blue-200 px-4 py-3">
                                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-2">Contoh:</p>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <div class="flex items-center gap-1.5 bg-blue-100 text-blue-800 px-2.5 py-1 rounded-lg text-xs font-bold">
                                        <i data-lucide="book-open" class="w-3 h-3"></i> Paket A ‚Äî XI TKJ 1
                                    </div>
                                    <span class="text-gray-400 text-xs">+</span>
                                    <div class="flex items-center gap-1.5 bg-indigo-100 text-indigo-800 px-2.5 py-1 rounded-lg text-xs font-bold">
                                        <i data-lucide="book-open" class="w-3 h-3"></i> Paket B ‚Äî XI TKJ 1
                                    </div>
                                    <span class="text-gray-400 text-xs">+</span>
                                    <div class="flex items-center gap-1.5 bg-purple-100 text-purple-800 px-2.5 py-1 rounded-lg text-xs font-bold">
                                        <i data-lucide="book-open" class="w-3 h-3"></i> Paket C ‚Äî XI TKJ 1
                                    </div>
                                    <span class="text-gray-400 text-xs">‚Üí</span>
                                    <div class="flex items-center gap-1.5 bg-emerald-100 text-emerald-800 px-2.5 py-1 rounded-lg text-xs font-bold">
                                        <i data-lucide="shuffle" class="w-3 h-3"></i> Tiap siswa dapat paket acak
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-start gap-2 mt-1">
                                <i data-lucide="info" class="w-3.5 h-3.5 text-blue-500 shrink-0 mt-0.5"></i>
                                <p class="text-[11px] text-blue-700">Jika hanya ada 1 paket untuk kelas tersebut, siswa tetap bisa memilih paket seperti biasa.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Header + Tombol Buat Paket -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Daftar Paket Soal</h3>
                            <p id="paket-count-info" class="text-sm text-gray-500">Memuat paket...</p>
                        </div>
                        <button onclick="window.openPaketModal()"
                            class="bg-gray-800 hover:bg-gray-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 shadow-md active:scale-95 transition-all">
                            <i data-lucide="plus" class="w-4 h-4"></i> Buat Paket Soal Baru
                        </button>
                    </div>

                    <!-- Grid Paket -->
                    <div id="paket-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 pr-1">
                        <div class="col-span-full bg-white rounded-2xl border p-10 text-center shadow-sm">
                            <i data-lucide="loader-2" class="w-8 h-8 mx-auto mb-3 text-gray-400 animate-spin"></i>
                            <p class="text-gray-400 text-sm">Memuat paket soal...</p>
                        </div>
                    </div>
                    <div id="pager-paket-wrap" class="mt-2"></div>

                    <!-- Tombol seed legacy -->
                    <div class="mt-4 border-t pt-4">
                        <button id="btn-seed-db" onclick="window.seedDatabase()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload Soal Bawaan ke DB (+ Buat Paket A/B/C)
                        </button>
                    </div>
                </div>

                <!-- ‚ïê‚ïê STEP 2: DETAIL SOAL DALAM PAKET ‚ïê‚ïê -->
                <div id="view-soal-in-paket" class="hidden">

                    <!-- Breadcrumb / Back -->
                    <div class="flex items-center gap-2 mb-4">
                        <button onclick="window.backToPaketList()"
                            class="flex items-center gap-2 text-gray-600 hover:text-gray-900 font-semibold text-sm bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg transition-colors">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Daftar Paket
                        </button>
                        <span class="text-gray-300">/</span>
                        <span id="breadcrumb-paket-nama" class="text-gray-700 font-semibold text-sm"></span>
                    </div>

                    <!-- Info Paket Aktif -->
                    <div id="active-paket-info-card" class="bg-white rounded-2xl border shadow-sm p-5 mb-5">
                        <div class="flex flex-col md:flex-row justify-between gap-4">
                            <div class="flex items-start gap-4">
                                <div id="active-paket-icon" class="w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold text-lg shrink-0 bg-gray-700">A</div>
                                <div>
                                    <h3 id="active-paket-nama" class="text-lg font-bold text-gray-800">Nama Paket</h3>
                                    <p id="active-paket-mapel" class="text-sm text-gray-500"></p>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <span class="bg-amber-100 text-amber-700 px-2.5 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                            <i data-lucide="key" class="w-3 h-3"></i> Token: <span id="active-paket-token">-</span>
                                        </span>
                                        <span id="active-paket-kelas-tags" class="flex flex-wrap gap-1"></span>
                                        <span id="active-paket-status-badge" class="px-2.5 py-1 rounded-full text-xs font-bold"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 shrink-0 flex-wrap">
                                <button onclick="window.openPaketModal(window.activePaketId)"
                                    class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-xl text-sm font-medium flex items-center gap-2">
                                    <i data-lucide="settings" class="w-4 h-4"></i> Edit Paket
                                </button>
                                <!-- Tambah Soal: ungu/violet ‚Äî berbeda dari impor -->
                                <button onclick="window.openQuestionModal()"
                                    class="bg-violet-600 hover:bg-violet-700 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-sm">
                                    <i data-lucide="plus" class="w-4 h-4"></i> Tambah Soal
                                </button>
                                <!-- Import Soal: teal/cyan ‚Äî berbeda dari tambah manual -->
                                <button onclick="window.toggleImportSection()"
                                    class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-sm">
                                    <i data-lucide="upload" class="w-4 h-4"></i> Import Soal
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filter & Search -->
                    <div class="bg-white rounded-xl border shadow-sm p-4 mb-4">
                        <div class="flex flex-wrap gap-3 items-end">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Cari Soal</label>
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input type="text" id="search-bank-soal"
                                        oninput="if(window._pg)window._pg.soal.page=1; window.filterQuestionBank()"
                                        placeholder="Ketik kata kunci soal..."
                                        class="w-full pl-9 pr-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-gray-400 outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Status</label>
                                <select id="filter-bank-status"
                                    onchange="if(window._pg)window._pg.soal.page=1; window.filterQuestionBank()"
                                    class="px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-gray-400 outline-none">
                                    <option value="all">Semua Status</option>
                                    <option value="aktif">Aktif</option>
                                    <option value="nonaktif">Nonaktif</option>
                                </select>
                            </div>
                            <div class="flex gap-2 items-center text-xs text-gray-500 bg-gray-50 px-3 py-2 rounded-lg border">
                                <span id="stat-total" class="font-semibold text-gray-700">Total: 0</span>
                                <span>‚Ä¢</span>
                                <span id="stat-aktif" class="text-emerald-600 font-semibold">Aktif: 0</span>
                                <span>‚Ä¢</span>
                                <span id="stat-nonaktif" class="text-red-500 font-semibold">Nonaktif: 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Soal List -->
                    <div id="bank-soal-list" class="space-y-3 pr-1">
                        <div class="bg-white rounded-xl p-8 text-center text-gray-400 border shadow-sm">
                            <i data-lucide="loader-2" class="w-8 h-8 mx-auto mb-2 animate-spin text-gray-400"></i>
                            <p>Memuat soal...</p>
                        </div>
                    </div>
                    <div id="pager-soal-wrap" class="mt-2"></div>

                    <!-- ‚ïê‚ïê SECTION IMPORT (collapsible) ‚ïê‚ïê -->
                    <div id="section-import-inline" class="hidden mt-6">

                        <!-- Header section import -->
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-base font-bold text-gray-800 flex items-center gap-2">
                                <i data-lucide="upload-cloud" class="w-5 h-5 text-teal-600"></i>
                                Import Soal ke Paket Ini
                            </h3>
                            <button onclick="window.toggleImportSection()"
                                class="text-gray-400 hover:text-gray-600 p-1.5 rounded-lg hover:bg-gray-100 transition-colors">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <!-- Kotak format info ‚Äî abu netral, bukan biru -->
                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mb-4">
                            <div class="flex items-start gap-3">
                                <i data-lucide="info" class="w-4 h-4 mt-0.5 shrink-0 text-gray-500"></i>
                                <div class="w-full">
                                    <p class="font-bold text-sm text-gray-700 mb-2">Format kolom yang diperlukan:</p>
                                    <div class="font-mono text-xs bg-white border border-gray-200 rounded-lg p-2.5 overflow-x-auto whitespace-nowrap">
                                        <span class="text-purple-700 font-bold">question</span>
                                        <span class="text-gray-400"> | </span>
                                        <span class="text-emerald-700 font-bold">question_image</span>
                                        <span class="text-gray-400"> | </span>
                                        <span class="text-orange-600 font-bold">option_a</span>
                                        <span class="text-gray-400"> | </span>
                                        <span class="text-emerald-600 font-bold">image_a</span>
                                        <span class="text-gray-400"> | </span>
                                        <span class="text-orange-600 font-bold">option_b ... option_e</span>
                                        <span class="text-gray-400"> | </span>
                                        <span class="text-red-600 font-bold">correct</span>
                                    </div>
                                    <div class="mt-2.5 grid grid-cols-2 gap-1 text-xs text-gray-500">
                                        <span>‚úÖ <strong class="text-gray-700">correct</strong>: huruf A / B / C / D / E</span>
                                        <span>üñºÔ∏è <strong class="text-gray-700">image_*</strong>: URL Google Drive (opsional)</span>
                                    </div>
                                    <!-- Download dalam kotak format -->
                                    <div class="mt-3 pt-3 border-t border-gray-200 flex flex-wrap gap-2 items-center">
                                        <span class="text-xs text-gray-500 font-medium">Download template siap pakai:</span>
                                        <button onclick="window.downloadExcelTemplate()" type="button"
                                            class="flex items-center gap-1.5 bg-[#217346] hover:bg-[#1a5c38] text-white text-xs font-bold px-2.5 py-1.5 rounded-lg shadow-sm transition-colors">
                                            <i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Excel
                                        </button>
                                        <button onclick="window.downloadWordTemplate()" type="button"
                                            class="flex items-center gap-1.5 bg-[#2B579A] hover:bg-[#1f4178] text-white text-xs font-bold px-2.5 py-1.5 rounded-lg shadow-sm transition-colors">
                                            <i data-lucide="file-text" class="w-3 h-3"></i> Word
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Grid 2 kolom: Excel | Word -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                            <!-- ‚îÄ‚îÄ EXCEL CARD (tema hijau Excel) ‚îÄ‚îÄ -->
                            <div class="bg-white rounded-xl border-2 border-emerald-100 shadow-sm overflow-hidden">
                                <!-- Header card Excel -->
                                <div class="bg-[#217346] px-4 py-3 flex items-center gap-3">
                                    <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                                        <i data-lucide="file-spreadsheet" class="w-4 h-4 text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-white text-sm">Import dari Excel</h4>
                                        <p class="text-white/70 text-[11px]">.xlsx &nbsp;/&nbsp; .xls</p>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <div id="excel-drop-zone"
                                        ondragover="event.preventDefault(); this.classList.add('border-emerald-400','bg-emerald-50')"
                                        ondragleave="this.classList.remove('border-emerald-400','bg-emerald-50')"
                                        ondrop="window.handleExcelDrop(event)"
                                        onclick="document.getElementById('excel-file-input').click()"
                                        class="border-2 border-dashed border-emerald-200 rounded-xl p-6 text-center cursor-pointer hover:border-emerald-400 hover:bg-emerald-50/60 transition-all">
                                        <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                                            <i data-lucide="upload-cloud" class="w-5 h-5 text-emerald-700"></i>
                                        </div>
                                        <p class="font-semibold text-gray-600 text-sm">Klik atau drag & drop file Excel</p>
                                        <p class="text-xs text-gray-400 mt-1">Mendukung .xlsx dan .xls</p>
                                        <input type="file" id="excel-file-input" accept=".xlsx,.xls" class="hidden"
                                            onchange="window.handleExcelFile(this.files[0])">
                                    </div>
                                    <div id="excel-preview" class="hidden mt-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <h5 class="font-bold text-gray-700 text-sm flex items-center gap-1.5">
                                                <i data-lucide="eye" class="w-3.5 h-3.5 text-emerald-600"></i>
                                                Preview: <span id="excel-count" class="text-emerald-600 font-extrabold">0</span> soal
                                            </h5>
                                            <button onclick="document.getElementById('excel-preview').classList.add('hidden'); document.getElementById('excel-file-input').value=''"
                                                class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                                        </div>
                                        <div id="excel-preview-table" class="overflow-x-auto border rounded-lg max-h-48 overflow-y-auto text-xs"></div>
                                        <div class="mt-3 flex gap-2 justify-end">
                                            <button onclick="document.getElementById('excel-preview').classList.add('hidden'); document.getElementById('excel-file-input').value=''"
                                                class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50 text-sm">Batal</button>
                                            <button onclick="window.uploadParsedQuestions()" id="btn-upload-excel"
                                                class="px-5 py-2 bg-[#217346] hover:bg-[#1a5c38] text-white rounded-lg font-bold text-sm flex items-center gap-2 shadow-sm">
                                                <i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload ke Paket
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ‚îÄ‚îÄ WORD CARD (tema biru Word) ‚îÄ‚îÄ -->
                            <div class="bg-white rounded-xl border-2 border-blue-100 shadow-sm overflow-hidden">
                                <!-- Header card Word -->
                                <div class="bg-[#2B579A] px-4 py-3 flex items-center gap-3">
                                    <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                                        <i data-lucide="file-text" class="w-4 h-4 text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-white text-sm">Import dari Word</h4>
                                        <p class="text-white/70 text-[11px]">.docx</p>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <div id="word-drop-zone"
                                        ondragover="event.preventDefault(); this.classList.add('border-blue-400','bg-blue-50')"
                                        ondragleave="this.classList.remove('border-blue-400','bg-blue-50')"
                                        ondrop="window.handleWordDrop(event)"
                                        onclick="document.getElementById('word-file-input').click()"
                                        class="border-2 border-dashed border-blue-200 rounded-xl p-6 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/60 transition-all">
                                        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                                            <i data-lucide="upload-cloud" class="w-5 h-5 text-[#2B579A]"></i>
                                        </div>
                                        <p class="font-semibold text-gray-600 text-sm">Klik atau drag & drop file Word</p>
                                        <p class="text-xs text-gray-400 mt-1">Format .docx</p>
                                        <input type="file" id="word-file-input" accept=".docx" class="hidden"
                                            onchange="window.handleWordFile(this.files[0])">
                                    </div>
                                    <div id="word-preview" class="hidden mt-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <h5 class="font-bold text-gray-700 text-sm flex items-center gap-1.5">
                                                <i data-lucide="eye" class="w-3.5 h-3.5 text-[#2B579A]"></i>
                                                Preview: <span id="word-count" class="text-[#2B579A] font-extrabold">0</span> soal
                                            </h5>
                                            <button onclick="document.getElementById('word-preview').classList.add('hidden'); document.getElementById('word-file-input').value=''"
                                                class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                                        </div>
                                        <div id="word-preview-table" class="overflow-x-auto border rounded-lg max-h-48 overflow-y-auto text-xs"></div>
                                        <div class="mt-3 flex gap-2 justify-end">
                                            <button onclick="document.getElementById('word-preview').classList.add('hidden'); document.getElementById('word-file-input').value=''"
                                                class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50 text-sm">Batal</button>
                                            <button onclick="window.uploadParsedWordQuestions()" id="btn-upload-word"
                                                class="px-5 py-2 bg-[#2B579A] hover:bg-[#1f4178] text-white rounded-lg font-bold text-sm flex items-center gap-2 shadow-sm">
                                                <i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload ke Paket
                                            </button>
                                        </div>
                                    </div>
                                    <div id="word-log" class="hidden mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800"></div>
                                </div>
                            </div>

                        </div><!-- end grid -->

                        <!-- Status upload -->
                        <div id="import-status" class="hidden mt-4 p-4 rounded-xl border text-sm font-medium"></div>

                    </div><!-- end section-import-inline -->
                </div><!-- end view-soal-in-paket -->
            </div><!-- end panel-soal -->


                        <!-- PANEL 4: MANAJEMEN KELAS -->
            <div id="panel-kelas" class="hidden-section admin-only-panel">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Manajemen Kelas</h2>
                            <p class="text-gray-500 text-sm">Tambah, edit, dan hapus daftar kelas yang tersedia.</p>
                        </div>
                        <button onclick="window.openKelasModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i> Tambah Kelas
                        </button>
                    </div>

                    <div class="overflow-x-auto border rounded-xl">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-900 font-semibold border-b sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-4 w-12">No</th>
                                    <th class="px-6 py-4">Nama Kelas</th>
                                    <th class="px-6 py-4">Keterangan</th>
                                    <th class="px-6 py-4 text-center w-32">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="kelas-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">Memuat data kelas...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="pager-kelas-wrap"></div>

                    <div id="kelas-offline-warn" class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-700 flex items-center gap-2">
                        <i data-lucide="wifi-off" class="w-4 h-4 shrink-0"></i>
                        Mode Offline ‚Äî perubahan kelas tidak tersimpan ke server.
                    </div>
                </div>
            </div>

            <!-- PANEL: MANAJEMEN RUANG -->
            <div id="panel-ruang" class="hidden-section admin-only-panel">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Manajemen Ruang Ujian</h2>
                            <p class="text-gray-500 text-sm">Atur ruang ujian beserta password pengawas per ruang.</p>
                        </div>
                        <button onclick="window.openRuangModal()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i> Tambah Ruang
                        </button>
                    </div>

                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-5 flex items-start gap-3">
                        <i data-lucide="info" class="w-5 h-5 text-amber-600 shrink-0 mt-0.5"></i>
                        <div class="text-sm text-amber-800">
                            <strong>Cara kerja sistem ruang:</strong> Siswa memilih ruang saat login ‚Üí datanya otomatis masuk ke ruang tersebut. Pengawas login dengan password ruangnya ‚Üí hanya bisa melihat siswa di ruangnya. Admin bisa melihat semua ruang.
                        </div>
                    </div>

                    <div class="overflow-x-auto border rounded-xl">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-900 font-semibold border-b sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-4 w-12">No</th>
                                    <th class="px-6 py-4">Nama Ruang</th>
                                    <th class="px-6 py-4">Password Pengawas</th>
                                    <th class="px-6 py-4">Keterangan</th>
                                    <th class="px-6 py-4 text-center w-32">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="ruang-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="px-6 py-10 text-center text-gray-400">Memuat data ruang...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="pager-ruang-wrap"></div>
                </div>
            </div>

            <!-- PANEL: SETTING TAMPILAN -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- PANEL: ANALITIK INTEGRITAS (BARU)                     -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="panel-analitik" class="hidden-section">

                <!-- ‚ïê‚ïê HEADER HALAMAN ‚ïê‚ïê -->
                <div class="flex flex-col md:flex-row md:items-start justify-between gap-4 mb-6">
                    <div>
                        <h2 class="text-xl font-black text-gray-800 flex items-center gap-2">
                            <i data-lucide="shield-check" class="w-6 h-6 text-emerald-600"></i>
                            Analitik Integritas Ujian
                        </h2>
                        <p class="text-sm text-gray-400 mt-1">Sistem pengukuran kejujuran digital berbasis data perilaku siswa secara real-time.</p>
                    </div>
                    <button onclick="window.generateIntegrityReport()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-md active:scale-95 transition-transform shrink-0">
                        <i data-lucide="download" class="w-4 h-4"></i> Export Laporan PDF
                    </button>
                </div>

                <!-- ‚ïê‚ïê FILTER BAR ‚ïê‚ïê -->
                <div class="bg-white rounded-xl border shadow-sm p-4 mb-6">
                    <div class="flex flex-wrap items-center gap-3">
                        <div class="flex items-center gap-2 text-sm font-bold text-gray-600 shrink-0">
                            <i data-lucide="filter" class="w-4 h-4 text-emerald-500"></i> Filter:
                        </div>
                        <!-- Filter Sesi -->
                        <div class="flex-1 min-w-[160px]">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Jadwal Ujian</label>
                            <select id="analitik-filter-sesi" onchange="window._pg.analitik.page=1; window.renderIntegrityDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-emerald-500 outline-none">
                                <option value="all">Semua Jadwal</option>
                            </select>
                        </div>
                        <!-- Filter Ruang (admin only) -->
                        <div class="flex-1 min-w-[160px] admin-only-el" id="analitik-filter-ruang-wrap">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Ruang Ujian</label>
                            <select id="analitik-filter-ruang" onchange="window._pg.analitik.page=1; window.renderIntegrityDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-emerald-500 outline-none">
                                <option value="all">Semua Ruang</option>
                            </select>
                        </div>
                        <!-- Filter Kelas -->
                        <div class="flex-1 min-w-[160px]">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Kelas</label>
                            <select id="analitik-filter-kelas" onchange="window._pg.analitik.page=1; window.renderIntegrityDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-emerald-500 outline-none">
                                <option value="all">Semua Kelas</option>
                            </select>
                        </div>
                        <!-- Filter Predikat -->
                        <div class="flex-1 min-w-[140px]">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Predikat</label>
                            <select id="analitik-filter-predikat" onchange="window._pg.analitik.page=1; window.renderIntegrityDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-emerald-500 outline-none">
                                <option value="all">Semua</option>
                                <option value="teladan">üèÜ Teladan (100)</option>
                                <option value="baik">‚úÖ Baik (80‚Äì99)</option>
                                <option value="cukup">‚ö†Ô∏è Cukup (60‚Äì79)</option>
                                <option value="evaluasi">‚õî Evaluasi (&lt;60)</option>
                                <option value="dq">‚ùå Diskualifikasi</option>
                            </select>
                        </div>
                        <!-- Reset -->
                        <div class="shrink-0 pt-4">
                            <button onclick="window.resetAnalitikFilter()" class="px-3 py-2 border rounded-lg text-xs font-bold text-gray-500 hover:bg-gray-50 flex items-center gap-1">
                                <i data-lucide="x-circle" class="w-3.5 h-3.5"></i> Reset
                            </button>
                        </div>
                        <!-- Info jumlah hasil -->
                        <div class="shrink-0 pt-4 text-xs text-gray-400 hidden" id="analitik-filter-info"></div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê BANNER KOSONG ‚Äî muncul sebelum ada data ujian ‚ïê‚ïê -->
                <div id="analitik-empty-banner" class="mb-6">
                    <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 shadow-xl p-6 md:p-8">
                        <!-- dekor background -->
                        <div class="absolute -top-8 -right-8 w-48 h-48 rounded-full bg-emerald-500/10 pointer-events-none"></div>
                        <div class="absolute -bottom-6 -left-6 w-36 h-36 rounded-full bg-blue-500/10 pointer-events-none"></div>
                        <div class="relative z-10 flex flex-col md:flex-row items-start md:items-center gap-6">
                            <!-- Ikon besar -->
                            <div class="shrink-0 w-16 h-16 rounded-2xl bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center shadow-lg shadow-emerald-500/10">
                                <i data-lucide="shield-check" class="w-8 h-8 text-emerald-400"></i>
                            </div>
                            <!-- Teks penjelasan -->
                            <div class="flex-1">
                                <p class="text-xs font-bold text-emerald-400 uppercase tracking-widest mb-1">üìä Menunggu Data Pertama</p>
                                <h3 class="text-lg font-black text-white mb-2">Dashboard ini akan aktif setelah ujian pertama berlangsung</h3>
                                <p class="text-sm text-slate-300 leading-relaxed">
                                    Saat siswa mulai mengerjakan ujian, seluruh data integritas ‚Äî mulai dari skor, grafik distribusi, hingga ranking kejujuran ‚Äî akan muncul di sini secara <strong class="text-white">otomatis dan real-time</strong> tanpa perlu me-refresh halaman.
                                </p>
                                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div class="bg-white/5 border border-white/10 rounded-xl p-3 text-center">
                                        <i data-lucide="activity" class="w-5 h-5 text-blue-400 mx-auto mb-1"></i>
                                        <p class="text-[11px] text-slate-400">Skor integritas per siswa dihitung otomatis</p>
                                    </div>
                                    <div class="bg-white/5 border border-white/10 rounded-xl p-3 text-center">
                                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-purple-400 mx-auto mb-1"></i>
                                        <p class="text-[11px] text-slate-400">Grafik & distribusi skor muncul langsung</p>
                                    </div>
                                    <div class="bg-white/5 border border-white/10 rounded-xl p-3 text-center">
                                        <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-400 mx-auto mb-1"></i>
                                        <p class="text-[11px] text-slate-400">Setiap pelanggaran tercatat beserta waktunya</p>
                                    </div>
                                    <div class="bg-white/5 border border-white/10 rounded-xl p-3 text-center">
                                        <i data-lucide="file-text" class="w-5 h-5 text-emerald-400 mx-auto mb-1"></i>
                                        <p class="text-[11px] text-slate-400">Laporan PDF siap dicetak per siswa</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê KOTAK PENJELASAN UTAMA (gaya konsisten dengan tab lain) ‚ïê‚ïê -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-6">
                    <div class="flex items-start gap-3">
                        <i data-lucide="info" class="w-5 h-5 text-blue-500 shrink-0 mt-0.5"></i>
                        <div>
                            <p class="font-bold text-blue-800 mb-2">Apa itu Analitik Integritas & Bagaimana Cara Kerjanya?</p>
                            <p class="text-sm text-blue-700 leading-relaxed mb-3">
                                Tab ini secara otomatis menganalisis <strong>tingkat kejujuran setiap siswa</strong> berdasarkan data perilaku yang direkam sistem selama ujian berlangsung ‚Äî tanpa perlu input manual dari guru.
                                Setiap kali siswa mencoba berpindah tab, membuka aplikasi lain, atau meninggalkan layar ujian, sistem mencatat kejadian tersebut sebagai <strong>pelanggaran</strong> dan mengurangi skor integritasnya secara otomatis.
                            </p>
                            <!-- Alur cara kerja -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
                                <div class="bg-white border border-blue-100 rounded-xl p-3">
                                    <div class="flex items-center gap-2 mb-1.5">
                                        <span class="w-6 h-6 bg-blue-600 text-white rounded-full text-xs font-black flex items-center justify-center shrink-0">1</span>
                                        <span class="text-xs font-bold text-blue-800">Siswa Mulai Ujian</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Sensor anti-cheat aktif otomatis. Sistem mulai memantau layar, fokus window, dan perpindahan tab.</p>
                                </div>
                                <div class="bg-white border border-blue-100 rounded-xl p-3">
                                    <div class="flex items-center gap-2 mb-1.5">
                                        <span class="w-6 h-6 bg-amber-500 text-white rounded-full text-xs font-black flex items-center justify-center shrink-0">2</span>
                                        <span class="text-xs font-bold text-amber-800">Pelanggaran Terdeteksi</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Jika siswa pindah tab/aplikasi, sistem mencatat waktu kejadian dan memberi peringatan. Skor integritas dikurangi sesuai bobot.</p>
                                </div>
                                <div class="bg-white border border-blue-100 rounded-xl p-3">
                                    <div class="flex items-center gap-2 mb-1.5">
                                        <span class="w-6 h-6 bg-red-600 text-white rounded-full text-xs font-black flex items-center justify-center shrink-0">3</span>
                                        <span class="text-xs font-bold text-red-800">Batas Maksimal</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Jika pelanggaran mencapai 3√ó, ujian dihentikan otomatis dan siswa didiskualifikasi. Skor integritas = 0.</p>
                                </div>
                                <div class="bg-white border border-blue-100 rounded-xl p-3">
                                    <div class="flex items-center gap-2 mb-1.5">
                                        <span class="w-6 h-6 bg-emerald-600 text-white rounded-full text-xs font-black flex items-center justify-center shrink-0">4</span>
                                        <span class="text-xs font-bold text-emerald-800">Laporan Otomatis</span>
                                    </div>
                                    <p class="text-xs text-gray-500">Setelah ujian selesai, data langsung muncul di tab ini. Export PDF per siswa tersedia dengan 1 klik.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê FORMULA & CARA BACA SKOR ‚ïê‚ïê -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-5 mb-6">

                    <!-- Formula Perhitungan -->
                    <div class="bg-white border rounded-xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <i data-lucide="calculator" class="w-4 h-4 text-indigo-500"></i>
                            Formula Skor Integritas
                        </h3>
                        <!-- Formula visual -->
                        <div class="bg-slate-900 rounded-xl p-4 font-mono text-sm mb-4">
                            <div class="text-slate-400 text-xs mb-2">// Dihitung otomatis setelah ujian selesai</div>
                            <div class="text-emerald-400">Skor <span class="text-white">=</span> <span class="text-yellow-300">max</span><span class="text-white">(</span><span class="text-blue-300">0</span><span class="text-white">,</span> <span class="text-blue-300">100</span> <span class="text-red-400">‚àí</span> bobot_pelanggaran<span class="text-white">)</span></div>
                            <div class="mt-3 text-xs space-y-1 text-slate-300">
                                <div><span class="text-amber-300">Pelanggaran 1√ó</span> <span class="text-slate-500">‚Üí</span> <span class="text-red-400">‚àí20 poin</span> <span class="text-slate-500">‚Üí Skor:</span> <span class="text-white font-bold">80</span></div>
                                <div><span class="text-amber-300">Pelanggaran 2√ó</span> <span class="text-slate-500">‚Üí</span> <span class="text-red-400">‚àí60 poin total</span> <span class="text-slate-500">‚Üí Skor:</span> <span class="text-white font-bold">40</span></div>
                                <div><span class="text-red-400">Pelanggaran 3√ó</span> <span class="text-slate-500">‚Üí</span> <span class="text-red-400">DISKUALIFIKASI</span> <span class="text-slate-500">‚Üí Skor:</span> <span class="text-white font-bold">0</span></div>
                            </div>
                        </div>
                        <div class="bg-amber-50 border border-amber-200 rounded-lg px-3 py-2.5 flex items-start gap-2">
                            <i data-lucide="lightbulb" class="w-4 h-4 text-amber-500 shrink-0 mt-0.5"></i>
                            <p class="text-xs text-amber-700">Bobot pelanggaran <strong>progresif</strong> ‚Äî pelanggaran kedua lebih berat dari yang pertama untuk mencerminkan niat yang lebih jelas.</p>
                        </div>
                    </div>

                    <!-- Kategori & Predikat -->
                    <div class="bg-white border rounded-xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <i data-lucide="tag" class="w-4 h-4 text-gray-400"></i>
                            Kategori & Predikat Integritas
                        </h3>
                        <div class="space-y-2">
                            <div class="flex items-center gap-3 bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-2.5">
                                <span class="text-lg shrink-0">üèÜ</span>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span class="font-black text-emerald-700 text-sm">Skor 100</span>
                                        <span class="bg-emerald-200 text-emerald-800 text-[10px] font-bold px-1.5 py-0.5 rounded">TELADAN</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-0.5">Tidak ada pelanggaran sama sekali ‚Äî ujian berjalan 100% bersih</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2.5">
                                <span class="text-lg shrink-0">‚ö†Ô∏è</span>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span class="font-black text-amber-700 text-sm">Skor 70‚Äì99</span>
                                        <span class="bg-amber-200 text-amber-800 text-[10px] font-bold px-1.5 py-0.5 rounded">CUKUP</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-0.5">1 pelanggaran terdeteksi ‚Äî butuh pembinaan fokus digital</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 bg-red-50 border border-red-200 rounded-lg px-3 py-2.5">
                                <span class="text-lg shrink-0">‚õî</span>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span class="font-black text-red-700 text-sm">Skor &lt;70</span>
                                        <span class="bg-red-200 text-red-800 text-[10px] font-bold px-1.5 py-0.5 rounded">EVALUASI</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-0.5">2 pelanggaran ‚Äî perlu pendampingan khusus dan dialog guru</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 bg-rose-50 border border-rose-200 rounded-lg px-3 py-2.5">
                                <span class="text-lg shrink-0">‚ùå</span>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span class="font-black text-rose-700 text-sm">Skor 0</span>
                                        <span class="bg-rose-200 text-rose-800 text-[10px] font-bold px-1.5 py-0.5 rounded">DISKUALIFIKASI</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-0.5">‚â•3 pelanggaran ‚Äî ujian dihentikan otomatis oleh sistem</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê APA YANG DIDETEKSI SISTEM ‚ïê‚ïê -->
                <div class="bg-white border rounded-xl p-5 shadow-sm mb-6">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i data-lucide="radar" class="w-4 h-4 text-red-500"></i>
                        Apa Saja yang Dideteksi Sistem sebagai Pelanggaran?
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="border border-gray-100 rounded-xl p-3 bg-gray-50">
                            <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mb-2">
                                <i data-lucide="layout-grid" class="w-4 h-4 text-red-600"></i>
                            </div>
                            <p class="font-bold text-xs text-gray-700 mb-1">Pindah Tab / Browser</p>
                            <p class="text-[11px] text-gray-400">Buka tab baru atau pindah ke website lain saat ujian berlangsung</p>
                        </div>
                        <div class="border border-gray-100 rounded-xl p-3 bg-gray-50">
                            <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mb-2">
                                <i data-lucide="app-window" class="w-4 h-4 text-orange-600"></i>
                            </div>
                            <p class="font-bold text-xs text-gray-700 mb-1">Buka Aplikasi Lain</p>
                            <p class="text-[11px] text-gray-400">Alt+Tab ke WhatsApp, kalkulator, atau aplikasi lainnya</p>
                        </div>
                        <div class="border border-gray-100 rounded-xl p-3 bg-gray-50">
                            <div class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center mb-2">
                                <i data-lucide="minimize-2" class="w-4 h-4 text-amber-600"></i>
                            </div>
                            <p class="font-bold text-xs text-gray-700 mb-1">Minimize Browser</p>
                            <p class="text-[11px] text-gray-400">Mengecilkan atau menyembunyikan jendela ujian</p>
                        </div>
                        <div class="border border-gray-100 rounded-xl p-3 bg-gray-50">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mb-2">
                                <i data-lucide="scan-line" class="w-4 h-4 text-purple-600"></i>
                            </div>
                            <p class="font-bold text-xs text-gray-700 mb-1">Mode Incognito</p>
                            <p class="text-[11px] text-gray-400">Login menggunakan browser mode private/incognito</p>
                        </div>
                    </div>
                    <div class="mt-3 bg-green-50 border border-green-200 rounded-lg px-3 py-2.5 flex items-start gap-2">
                        <i data-lucide="shield" class="w-4 h-4 text-green-600 shrink-0 mt-0.5"></i>
                        <p class="text-xs text-green-700"><strong>Yang TIDAK dianggap pelanggaran:</strong> scroll halaman, klik pilihan jawaban, meluangkan waktu berpikir lama di satu soal, atau gangguan teknis perangkat yang terjadi 1 kali.</p>
                    </div>
                </div>

                <!-- ‚ïê‚ïê PANDUAN FITUR PDF & CATATAN ‚ïê‚ïê -->
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6 flex items-start gap-3">
                    <i data-lucide="file-text" class="w-5 h-5 text-amber-600 shrink-0 mt-0.5"></i>
                    <div class="text-sm text-amber-800">
                        <strong>Fitur Export PDF & Catatan Pengawas:</strong> Di tabel hasil ujian (tab Monitoring), setiap siswa memiliki tombol
                        <span class="inline-flex items-center gap-1 bg-emerald-100 text-emerald-700 font-bold text-xs px-2 py-0.5 rounded mx-0.5"><i data-lucide="file-text" class="w-3 h-3"></i> PDF</span>
                        untuk cetak laporan karakter per-siswa, dan tombol
                        <span class="inline-flex items-center gap-1 bg-blue-100 text-blue-700 font-bold text-xs px-2 py-0.5 rounded mx-0.5"><i data-lucide="pencil" class="w-3 h-3"></i> Catatan</span>
                        untuk menambah catatan manual pengawas sebelum dicetak. Laporan PDF berisi: identitas siswa, log insiden dengan timestamp, skor integritas, predikat karakter, dan kesimpulan otomatis sistem.
                    </div>
                </div>

                <!-- ‚ïê‚ïê SEPARATOR: DATA REAL-TIME ‚ïê‚ïê -->
                <div class="flex items-center gap-3 mb-5">
                    <div class="flex-1 h-px bg-gray-200"></div>
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest px-2">Data Real-Time</span>
                    <div class="flex-1 h-px bg-gray-200"></div>
                </div>
                <p class="text-xs text-gray-400 mb-5 -mt-2">Data di bawah ini terisi otomatis setelah siswa menyelesaikan ujian. Tidak perlu refresh manual ‚Äî halaman ini memperbarui diri sendiri secara langsung.</p>

                <!-- Integrity Score Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-5 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold opacity-90 uppercase tracking-wide">Rata-rata Integritas</span>
                            <i data-lucide="shield" class="w-5 h-5 opacity-80"></i>
                        </div>
                        <p id="avg-integrity-score" class="text-4xl font-black">‚Äî</p>
                        <p class="text-xs opacity-75 mt-1">dari 100 poin maksimal</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold opacity-90 uppercase tracking-wide">Siswa Skor 100</span>
                            <i data-lucide="user-check" class="w-5 h-5 opacity-80"></i>
                        </div>
                        <p id="honest-count" class="text-4xl font-black">0</p>
                        <p id="honest-pct" class="text-xs opacity-75 mt-1">0% integritas sempurna</p>
                    </div>
                    <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold opacity-90 uppercase tracking-wide">Pelanggaran Ringan</span>
                            <i data-lucide="alert-triangle" class="w-5 h-5 opacity-80"></i>
                        </div>
                        <p id="minor-viol-count" class="text-4xl font-black">0</p>
                        <p class="text-xs opacity-75 mt-1">1‚Äì2√ó pelanggaran terdeteksi</p>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-rose-600 rounded-2xl p-5 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold opacity-90 uppercase tracking-wide">Diskualifikasi</span>
                            <i data-lucide="shield-x" class="w-5 h-5 opacity-80"></i>
                        </div>
                        <p id="dq-count-analitik" class="text-4xl font-black">0</p>
                        <p class="text-xs opacity-75 mt-1">‚â•3 pelanggaran, ujian gugur</p>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-2xl border shadow-sm p-6">
                        <h3 class="font-bold text-gray-700 mb-1 flex items-center gap-2">
                            <i data-lucide="bar-chart-3" class="w-4 h-4 text-blue-500"></i>
                            Distribusi Skor Integritas
                        </h3>
                        <p class="text-xs text-gray-400 mb-4">Berapa siswa di setiap rentang skor ‚Äî dari Teladan sampai Diskualifikasi.</p>
                        <div id="chart-integrity-dist" class="space-y-3">
                            <div class="flex flex-col items-center justify-center py-10 gap-2 text-gray-300">
                                <i data-lucide="bar-chart-2" class="w-10 h-10"></i>
                                <p class="text-sm font-semibold text-gray-400">Menunggu data ujian...</p>
                                <p class="text-xs text-gray-300">Terisi otomatis setelah siswa menyelesaikan ujian</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl border shadow-sm p-6">
                        <h3 class="font-bold text-gray-700 mb-1 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-4 h-4 text-purple-500"></i>
                            Tingkat Pelanggaran per Kelas
                        </h3>
                        <p class="text-xs text-gray-400 mb-4">Perbandingan jumlah pelanggaran antar kelas ‚Äî berguna untuk evaluasi per rombel.</p>
                        <div id="chart-viol-per-class" class="space-y-3">
                            <div class="flex flex-col items-center justify-center py-10 gap-2 text-gray-300">
                                <i data-lucide="users" class="w-10 h-10"></i>
                                <p class="text-sm font-semibold text-gray-400">Menunggu data ujian...</p>
                                <p class="text-xs text-gray-300">Terisi otomatis setelah siswa menyelesaikan ujian</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabel Ranking -->
                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
                    <div class="p-5 border-b bg-gray-50 flex flex-col md:flex-row md:items-center justify-between gap-2">
                        <div>
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                <i data-lucide="list-ordered" class="w-4 h-4 text-gray-500"></i>
                                Ranking Integritas Siswa
                            </h3>
                            <p class="text-xs text-gray-400 mt-0.5">Diurutkan dari skor tertinggi ke terendah. Makin tinggi skor = makin jujur selama ujian.</p>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <span class="bg-emerald-100 text-emerald-700 text-xs font-bold px-3 py-1 rounded-full">üèÜ 100 Teladan</span>
                            <span class="bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full">‚úÖ 80‚Äì99 Baik</span>
                            <span class="bg-amber-100 text-amber-700 text-xs font-bold px-3 py-1 rounded-full">‚ö†Ô∏è 60‚Äì79 Cukup</span>
                            <span class="bg-red-100 text-red-700 text-xs font-bold px-3 py-1 rounded-full">‚õî &lt;60 Evaluasi</span>
                            <span class="bg-rose-100 text-rose-700 text-xs font-bold px-3 py-1 rounded-full">‚ùå 0 DQ</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wide">
                                <tr>
                                    <th class="px-4 py-3 text-left">Rank</th>
                                    <th class="px-4 py-3 text-left">Nama Siswa</th>
                                    <th class="px-4 py-3 text-left">Kelas</th>
                                    <th class="px-4 py-3 text-left">Ruang</th>
                                    <th class="px-4 py-3 text-center">Nilai</th>
                                    <th class="px-4 py-3 text-center">Pelanggaran</th>
                                    <th class="px-4 py-3 text-center">Skor Integritas</th>
                                    <th class="px-4 py-3 text-center">Predikat</th>
                                    <th class="px-4 py-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="integrity-table-body">
                                <tr>
                                    <td colspan="9" class="text-center py-14">
                                        <div class="flex flex-col items-center gap-2 text-gray-300">
                                            <i data-lucide="clipboard-list" class="w-12 h-12"></i>
                                            <p class="font-bold text-gray-400 text-base">Belum ada data integritas</p>
                                            <p class="text-sm text-gray-300 max-w-xs">Tabel terisi otomatis setelah siswa menyelesaikan ujian. Tidak perlu refresh halaman.</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pager Analitik -->
                    <div id="analitik-pager"></div>
                </div>

            </div>
            <!-- ‚ïê‚ïê END PANEL ANALITIK ‚ïê‚ïê -->

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- PANEL: JADWAL UJIAN OTOMATIS                          -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="panel-jadwal" class="hidden-section admin-only-panel">
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <i data-lucide="calendar-clock" class="w-6 h-6 text-violet-600"></i>
                                Jadwal Ujian Otomatis
                            </h2>
                            <p class="text-gray-500 text-sm mt-1">Atur jadwal ujian per hari & sesi. Token aktif otomatis sesuai jam yang ditentukan, dan mati otomatis saat waktu habis.</p>
                        </div>
                        <div id="jadwal-scheduler-status" class="flex items-center gap-2 bg-green-50 border border-green-200 text-green-700 px-4 py-2 rounded-xl text-sm font-bold shrink-0">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse inline-block"></span>
                            Scheduler Aktif
                        </div>
                    </div>

                    <!-- INFO BOX -->
                    <div class="bg-violet-50 border border-violet-200 rounded-xl p-4 mb-6 flex items-start gap-3">
                        <i data-lucide="info" class="w-5 h-5 text-violet-600 shrink-0 mt-0.5"></i>
                        <div class="text-sm text-violet-800">
                            <strong>Cara kerja:</strong> Setiap sesi yang sudah dijadwalkan akan <strong>otomatis aktif</strong> tepat pada jam mulai, dan <strong>otomatis nonaktif</strong> saat jam selesai. Sistem mengecek jadwal setiap menit. Pastikan waktu perangkat admin sudah tepat.
                        </div>
                    </div>

                    <!-- FORM TAMBAH JADWAL -->
                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-5 mb-6">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4 text-violet-600"></i> Tambah Jadwal Sesi</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Paket Soal dari database (UTAMA) -->
                            <div class="md:col-span-2 lg:col-span-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">Paket Soal <span class="text-red-500">*</span></label>
                                <select id="jdwl-paket" onchange="window.onJadwalPaketChange()" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-violet-500 bg-white">
                                    <option value="">‚Äî Pilih Paket Soal ‚Äî</option>
                                </select>
                            </div>
                            <!-- Info Kelas otomatis dari paket -->
                            <div class="md:col-span-2 lg:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 mb-1">Kelas <span class="text-gray-400 font-normal">(otomatis dari paket)</span></label>
                                <div id="jdwl-kelas-info" class="w-full px-3 py-2 border border-dashed border-gray-300 rounded-lg text-sm bg-gray-50 text-gray-400 italic min-h-[38px] flex items-center flex-wrap gap-1">
                                    Pilih paket soal terlebih dahulu...
                                </div>
                                <input type="hidden" id="jdwl-kelas">
                            </div>
                            <!-- Nama Sesi: auto-generate atau custom -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1">Nama Sesi <span class="text-red-500">*</span> <span class="text-gray-400 font-normal">(otomatis, bisa diubah)</span></label>
                                <input type="text" id="jdwl-nama" placeholder="Otomatis terisi saat pilih paket..." class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-violet-500 bg-white">
                            </div>
                            <!-- Tanggal -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Hari / Tanggal <span class="text-red-500">*</span></label>
                                <input type="date" id="jdwl-tanggal" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-violet-500 bg-white">
                            </div>
                            <!-- Jam Mulai -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Jam Mulai <span class="text-red-500">*</span></label>
                                <input type="time" id="jdwl-mulai" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-violet-500 bg-white">
                            </div>
                            <!-- Jam Selesai -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Jam Selesai <span class="text-red-500">*</span></label>
                                <input type="time" id="jdwl-selesai" class="w-full px-3 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-violet-500 bg-white">
                            </div>
                            <!-- Token: otomatis dari paket -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">
                                    Token Ujian <span id="jdwl-token-hint" class="text-violet-500 font-normal italic">(otomatis dari paket)</span>
                                </label>
                                <input type="text" id="jdwl-token" placeholder="Otomatis dari paket soal" class="w-full px-3 py-2 border rounded-lg text-sm outline-none bg-violet-50 font-mono font-bold tracking-widest text-violet-700" readonly>
                            </div>
                            <!-- Durasi: otomatis dari paket -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">
                                    Durasi (menit) <span class="text-violet-500 font-normal italic">(dari paket)</span>
                                </label>
                                <input type="number" id="jdwl-durasi" placeholder="Dari paket soal" min="1" max="300" class="w-full px-3 py-2 border rounded-lg text-sm outline-none bg-violet-50" readonly>
                            </div>
                            <!-- Hidden fields -->
                            <input type="hidden" id="jdwl-paket-id">
                            <input type="hidden" id="jdwl-kelas-arr">
                        </div>
                        <div class="mt-4 flex items-center gap-3 flex-wrap">
                            <button onclick="window.tambahJadwal()" class="bg-violet-600 hover:bg-violet-700 text-white px-6 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm transition active:scale-95">
                                <i data-lucide="save" class="w-4 h-4"></i> Simpan Jadwal
                            </button>
                            <p class="text-xs text-gray-400 italic">Kelas, token & durasi diambil otomatis dari pengaturan paket soal.</p>
                        </div>
                    </div>

                    <!-- DAFTAR JADWAL -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-gray-700 flex items-center gap-2"><i data-lucide="list" class="w-4 h-4 text-violet-600"></i> Daftar Jadwal</h3>
                            <div class="flex items-center gap-2">
                                <select id="jdwl-filter-tanggal" onchange="window.renderJadwalList()" class="px-3 py-1.5 border rounded-lg text-xs bg-white outline-none focus:ring-2 focus:ring-violet-500">
                                    <option value="all">Semua Tanggal</option>
                                </select>
                            </div>
                        </div>
                        <div id="jadwal-list-container" class="space-y-3">
                            <p class="text-sm text-gray-400 text-center py-8 bg-gray-50 rounded-xl border border-dashed">Memuat jadwal...</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ‚ïê‚ïê END PANEL JADWAL ‚ïê‚ïê -->

            <div id="panel-tampilan" class="hidden-section admin-only-panel">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">

                    <!-- KARTU: Identitas Ujian -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
                            <i data-lucide="file-badge" class="w-5 h-5 text-blue-600"></i> Identitas Ujian
                        </h2>
                        <p class="text-sm text-gray-400 mb-5">Teks yang muncul di halaman login dan halaman selamat datang siswa.</p>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Nama / Jenis Ujian <span class="text-blue-500">(Header Utama)</span></label>
                                <input type="text" id="setting-judul-ujian" oninput="window.updateTampilanPreview()" class="w-full px-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-gray-800" placeholder="Contoh: Sumatif Akhir Sekolah">
                                <p class="text-[11px] text-gray-400 mt-1">Tampil sebagai judul besar di halaman login dan welcome.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Nama Sekolah / Sub-Judul</label>
                                <input type="text" id="setting-sub-judul" oninput="window.updateTampilanPreview()" class="w-full px-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none text-gray-700" placeholder="Contoh: SMK Negeri 1 Brondong">
                                <p class="text-[11px] text-gray-400 mt-1">Tampil di bawah judul utama sebagai keterangan institusi.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">URL Logo <span class="text-gray-400 font-normal">(opsional)</span></label>
                                <input type="url" id="setting-logo-url" oninput="window.updateTampilanPreview()" class="w-full px-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-xs text-gray-600" placeholder="https://... (URL gambar logo)">
                                <p class="text-[11px] text-gray-400 mt-1">Ganti logo di halaman login. Bisa pakai link Google Drive, CDN, dll.</p>
                            </div>

                            <!-- ‚îÄ‚îÄ SETTING LABEL NOMOR ID ‚îÄ‚îÄ -->
                            <div class="border-t pt-4">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">
                                    Label Kolom Identitas Siswa
                                    <span class="ml-1 text-indigo-500 normal-case font-normal">(Form Login)</span>
                                </label>
                                <select id="setting-nomor-id-mode" onchange="window.applyAppearanceSettings({...(window._savedAppearance||{}), nomorIdMode: this.value})" class="w-full px-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none text-gray-800 font-semibold">
                                    <option value="nisn">NISN (Nomor Induk Siswa Nasional)</option>
                                    <option value="kartu">No. Kartu Ujian</option>
                                </select>
                                <p class="text-[11px] text-gray-400 mt-1">Pilih jenis nomor identitas yang diminta saat siswa login. Perubahan langsung terlihat di form login.</p>
                                <!-- Live preview label -->
                                <div class="mt-2 flex items-center gap-2 bg-indigo-50 border border-indigo-100 rounded-lg px-3 py-2">
                                    <i data-lucide="id-card" class="w-4 h-4 text-indigo-400 shrink-0"></i>
                                    <span class="text-xs text-indigo-600">Kolom di form login akan tampil sebagai: <strong id="preview-nomor-id-label">NISN</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- KARTU: Teks Sambutan -->
                    <div class="bg-white rounded-xl shadow-sm border p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
                            <i data-lucide="message-square-quote" class="w-5 h-5 text-yellow-500"></i> Teks Sambutan & Motivasi
                        </h2>
                        <p class="text-sm text-gray-400 mb-5">Teks yang muncul di kotak kuning halaman selamat datang siswa.</p>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Kalimat Motivasi Siswa</label>
                                <textarea id="setting-motivasi" rows="4" oninput="window.updateTampilanPreview()" class="w-full px-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-yellow-400 outline-none text-gray-700 resize-none leading-relaxed" placeholder="Kerjakan dengan jujur dan penuh semangat. Hasil terbaik lahir dari usaha yang sungguh-sungguh. Percayalah pada kemampuanmu ‚Äî sukses menantimu!"></textarea>
                                <p class="text-[11px] text-gray-400 mt-1">Tampil di kotak kuning halaman selamat datang. Gunakan kalimat singkat yang memotivasi.</p>
                            </div>
                        </div>
                    </div>

                    <!-- PREVIEW LIVE -->
                    <div class="xl:col-span-2 bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <h3 class="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2">
                            <i data-lucide="eye" class="w-4 h-4 text-blue-400"></i> Preview Halaman Login
                        </h3>
                        <div class="bg-gradient-to-r from-blue-600 via-blue-500 to-indigo-600 rounded-2xl px-8 py-6 text-center max-w-sm mx-auto shadow-2xl">
                            <div class="w-16 h-16 bg-white rounded-full mx-auto mb-3 flex items-center justify-center shadow">
                                <img id="preview-logo" src="images/integritest.png" onerror="this.src='https://via.placeholder.com/64?text=LOGO'" class="w-12 h-12 object-contain rounded-full">
                            </div>
                            <h1 id="preview-judul" class="text-xl font-black"><span class="text-white">INTEGRI</span><span style="color:#7dd3fc">TEST</span></h1>
                            <div class="h-0.5 w-14 bg-blue-300/50 rounded-full my-2 mx-auto"></div>
                            <p id="preview-sub" class="text-blue-100 text-xs font-medium">Digitalyzing Integrity, Empowering Honestly</p>
                        </div>
                        <div class="mt-4 bg-yellow-500/10 border border-yellow-400/20 rounded-xl px-5 py-3 max-w-sm mx-auto">
                            <div class="flex items-start gap-2">
                                <i data-lucide="star" class="w-4 h-4 text-yellow-300 shrink-0 mt-0.5"></i>
                                <p id="preview-motivasi" class="text-yellow-100/90 text-xs leading-relaxed italic">Kerjakan dengan jujur dan penuh semangat. Percayalah pada kemampuanmu ‚Äî sukses menantimu!</p>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- KARTU: Keamanan Akun Admin -->
                <div class="mt-6 bg-white rounded-xl shadow-sm border border-red-100 p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-5 h-5 text-red-500"></i> Keamanan Akun Admin
                    </h2>
                    <p class="text-sm text-gray-400 mb-5">Ubah username dan password login admin. Wajib isi <span class="font-semibold text-gray-600">Password Lama</span> untuk konfirmasi identitas. Password baru bersifat opsional (kosongkan jika tidak ingin ganti).</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <!-- Kolom Kiri: Username & Display Name -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">
                                    Username Login <span class="text-red-400">*</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i data-lucide="at-sign" class="w-4 h-4"></i></span>
                                    <input type="text" id="setting-admin-user" autocomplete="off"
                                        class="w-full pl-9 pr-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-red-400 outline-none font-mono font-semibold text-gray-800"
                                        placeholder="Username untuk login admin">
                                </div>
                                <p class="text-[11px] text-gray-400 mt-1">Minimal 4 karakter. Digunakan saat login admin.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">
                                    Nama Tampil (Display Name)
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i data-lucide="user" class="w-4 h-4"></i></span>
                                    <input type="text" id="setting-admin-display" autocomplete="off"
                                        class="w-full pl-9 pr-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-red-400 outline-none text-gray-800"
                                        placeholder="Contoh: Admin Utama / Bu Sari">
                                </div>
                                <p class="text-[11px] text-gray-400 mt-1">Muncul di header dashboard setelah login.</p>
                            </div>
                        </div>

                        <!-- Kolom Kanan: Password -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">
                                    Password Lama <span class="text-red-400">*</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i data-lucide="lock" class="w-4 h-4"></i></span>
                                    <input type="password" id="setting-admin-old-pass" autocomplete="current-password"
                                        class="w-full pl-9 pr-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-red-400 outline-none"
                                        placeholder="Password yang sekarang dipakai">
                                </div>
                                <p class="text-[11px] text-gray-400 mt-1">Wajib diisi untuk memverifikasi identitas.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">
                                    Password Baru <span class="text-gray-400 font-normal">(opsional)</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i data-lucide="key-round" class="w-4 h-4"></i></span>
                                    <input type="password" id="setting-admin-new-pass" autocomplete="new-password"
                                        class="w-full pl-9 pr-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-red-400 outline-none"
                                        placeholder="Kosongkan jika tidak ingin ganti">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">
                                    Konfirmasi Password Baru
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i data-lucide="key-round" class="w-4 h-4"></i></span>
                                    <input type="password" id="setting-admin-conf-pass" autocomplete="new-password"
                                        class="w-full pl-9 pr-4 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-red-400 outline-none"
                                        placeholder="Ulangi password baru">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Peringatan keamanan -->
                    <div class="mt-4 flex items-start gap-2 bg-amber-50 border border-amber-200 rounded-xl px-4 py-3">
                        <i data-lucide="triangle-alert" class="w-4 h-4 text-amber-500 shrink-0 mt-0.5"></i>
                        <p class="text-xs text-amber-700 leading-relaxed">
                            <span class="font-bold">Perhatian:</span> Simpan username dan password baru di tempat yang aman. Jika lupa password, data hanya bisa dipulihkan langsung melalui Firebase Console.
                        </p>
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button onclick="window.saveAdminCredentials()"
                            class="px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-sm flex items-center gap-2 shadow-sm transition active:scale-95">
                            <i data-lucide="shield-check" class="w-4 h-4"></i> Perbarui Kredensial Admin
                        </button>
                    </div>
                </div>

                <!-- Tombol simpan -->
                <div class="mt-6 flex items-center justify-between gap-4">
                    <!-- Info Perf Mode -->
                    <div id="perf-mode-info" class="hidden flex items-center gap-2 bg-amber-50 border border-amber-200 rounded-xl px-4 py-2.5 text-xs text-amber-700">
                        <i data-lucide="zap" class="w-4 h-4 text-amber-500 shrink-0"></i>
                        <span><strong>Mode Performa Aktif</strong> ‚Äî Animasi dinonaktifkan otomatis karena HP terdeteksi sebagai perangkat rendah spesifikasi.</span>
                    </div>
                    <div class="flex-1"></div>
                    <button onclick="window.saveAppearanceOnly()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold shadow-md active:scale-95 transition-transform flex items-center gap-2">
                        <i data-lucide="palette" class="w-4 h-4"></i> Simpan Pengaturan Tampilan
                    </button>
                </div>
            </div>

        </main>
        <!-- Footer Dashboard Guru -->
        <footer class="bg-slate-900 border-t border-slate-700 mt-auto">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <p class="text-[11px] text-slate-500 flex items-center gap-1.5">
                    <span class="inline-block w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                    &copy; 2026 <span class="text-slate-400 font-semibold">Nailul Authar</span> <span class="text-slate-600">‚Ä¢</span> SMK Negeri 1 Brondong
                </p>
                <p class="text-[10px] text-slate-600 font-mono hidden md:block">
                    <span class="text-white font-black">INTEGRI</span><span style="color:#38bdf8" class="font-black">TEST</span> &nbsp;v2.0
                </p>
            </div>
        </footer>

        <!-- MOBILE BOTTOM NAV ‚Äî hanya tampil di HP (md ke atas disembunyikan) -->
        <nav id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 z-40 bg-white/95 backdrop-blur-xl border-t border-gray-200 shadow-2xl shadow-black/10">
            <!-- Safe area untuk iPhone dengan home indicator -->
            <div class="flex items-stretch h-16 px-1 overflow-x-auto scrollbar-hide" style="padding-bottom: env(safe-area-inset-bottom, 0px); -webkit-overflow-scrolling: touch; scrollbar-width: none;">
                <button onclick="window.switchDashTab('welcome')" id="mob-tab-welcome"
                    class="admin-only-tab min-w-[56px] flex-1 flex flex-col items-center justify-center gap-0.5 rounded-xl mx-0.5 my-1.5 transition-all duration-200 text-gray-400">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span class="text-[9px] font-bold tracking-wide">BERANDA</span>
                </button>
                <button onclick="window.switchDashTab('nilai')" id="mob-tab-nilai"
                    class="min-w-[56px] flex-1 flex flex-col items-center justify-center gap-0.5 rounded-xl mx-0.5 my-1.5 transition-all duration-200 text-gray-400">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                    <span class="text-[9px] font-bold tracking-wide">NILAI</span>
                </button>
                <button onclick="window.switchDashTab('analitik')" id="mob-tab-analitik"
                    class="min-w-[56px] flex-1 flex flex-col items-center justify-center gap-0.5 rounded-xl mx-0.5 my-1.5 transition-all duration-200 text-gray-400">
                    <i data-lucide="shield-check" class="w-5 h-5"></i>
                    <span class="text-[9px] font-bold tracking-wide">ANALITIK</span>
                </button>
                <button onclick="window.switchDashTab('kelas')" id="mob-tab-kelas"
                    class="admin-only-tab min-w-[56px] flex-1 flex flex-col items-center justify-center gap-0.5 rounded-xl mx-0.5 my-1.5 transition-all duration-200 text-gray-400">
                    <i data-lucide="school" class="w-5 h-5"></i>
                    <span class="text-[9px] font-bold tracking-wide">KELAS</span>
                </button>
                <button onclick="window.switchDashTab('soal')" id="mob-tab-soal"
                    class="admin-only-tab min-w-[56px] flex-1 flex flex-col items-center justify-center gap-0.5 rounded-xl mx-0.5 my-1.5 transition-all duration-200 text-gray-400">
                    <i data-lucide="layers" class="w-5 h-5"></i>
                    <span class="text-[9px] font-bold tracking-wide">SOAL</span>
                </button>
                <button onclick="window.switchDashTab('ruang')" id="mob-tab-ruang"
                    class="admin-only-tab min-w-[56px] flex-1 flex flex-col items-center justify-center gap-0.5 rounded-xl mx-0.5 my-1.5 transition-all duration-200 text-gray-400">
                    <i data-lucide="door-open" class="w-5 h-5"></i>
                    <span class="text-[9px] font-bold tracking-wide">RUANG</span>
                </button>
                <button onclick="window.switchDashTab('jadwal')" id="mob-tab-jadwal"
                    class="admin-only-tab min-w-[56px] flex-1 flex flex-col items-center justify-center gap-0.5 rounded-xl mx-0.5 my-1.5 transition-all duration-200 text-gray-400">
                    <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                    <span class="text-[9px] font-bold tracking-wide">JADWAL</span>
                </button>
                <button onclick="window.switchDashTab('tampilan')" id="mob-tab-tampilan"
                    class="admin-only-tab min-w-[56px] flex-1 flex flex-col items-center justify-center gap-0.5 rounded-xl mx-0.5 my-1.5 transition-all duration-200 text-gray-400">
                    <i data-lucide="palette" class="w-5 h-5"></i>
                    <span class="text-[9px] font-bold tracking-wide">SETTING</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- MODAL: CATATAN PENGAWAS PER SISWA -->
    <div id="modal-note" class="fixed inset-0 z-[90] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="pencil" class="w-5 h-5 text-blue-600"></i>
                    Catatan Pengawas
                </h3>
                <button onclick="document.getElementById('modal-note').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <input type="hidden" id="note-student-id">
            <div class="mb-2">
                <p class="text-sm font-semibold text-gray-700" id="note-student-name">Nama Siswa</p>
                <p class="text-xs text-gray-400" id="note-auto-text">Catatan otomatis sistem...</p>
            </div>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5">Catatan Tambahan Pengawas <span class="text-gray-400 font-normal">(opsional)</span></label>
                <textarea id="note-custom-input" rows="4" placeholder='Contoh: "Siswa sempat izin ke toilet" atau "Laptop siswa sempat nge-lag namun tetap jujur."' class="w-full px-3 py-2.5 border rounded-xl text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none resize-none text-gray-700"></textarea>
                <p class="text-xs text-gray-400 mt-1">Catatan ini akan muncul di PDF laporan integritas siswa ini.</p>
            </div>
            <div class="flex gap-2 justify-end">
                <button onclick="document.getElementById('modal-note').classList.add('hidden')" class="px-4 py-2 border rounded-xl text-gray-600 text-sm font-medium hover:bg-gray-50">Batal</button>
                <button onclick="window.saveStudentNote()" class="px-5 py-2 bg-blue-600 text-white rounded-xl font-bold text-sm flex items-center gap-2 shadow-sm hover:bg-blue-700">
                    <i data-lucide="save" class="w-4 h-4"></i> Simpan Catatan
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: TAMBAH / EDIT RUANG -->
    <div id="modal-ruang" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 id="modal-ruang-title" class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="door-open" class="w-5 h-5 text-amber-600"></i> Tambah Ruang Ujian
                </h3>
                <button onclick="window.closeRuangModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form onsubmit="window.saveRuang(event)" class="space-y-4">
                <input type="hidden" id="ruang-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Ruang <span class="text-red-500">*</span></label>
                    <input type="text" id="ruang-nama" placeholder="Contoh: Ruang 1" required
                        class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-amber-500 bg-gray-50 text-sm font-medium">
                    <p class="text-xs text-gray-400 mt-1">Nama ini akan muncul di pilihan siswa saat login.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password Pengawas <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="text" id="ruang-password" placeholder="Contoh: GURU1" required
                            class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-amber-500 bg-gray-50 text-sm font-bold tracking-widest uppercase">
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Password ini dipakai pengawas untuk login ke halaman monitoring ruang ini.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Opsional)</label>
                    <input type="text" id="ruang-keterangan" placeholder="Contoh: Lab Komputer 1, Lantai 2"
                        class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-amber-500 bg-gray-50 text-sm">
                </div>
                <div class="flex justify-end gap-2 pt-2 border-t">
                    <button type="button" onclick="window.closeRuangModal()" class="px-4 py-2 border rounded-xl text-gray-700 hover:bg-gray-50 text-sm font-medium">Batal</button>
                    <button type="submit" class="px-5 py-2 bg-amber-600 text-white rounded-xl hover:bg-amber-700 font-bold text-sm flex items-center gap-2 shadow-sm">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: TAMBAH / EDIT KELAS -->
    <div id="modal-kelas" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 id="modal-kelas-title" class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="school" class="w-5 h-5 text-blue-600"></i> Tambah Kelas Baru
                </h3>
                <button onclick="window.closeKelasModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form onsubmit="window.saveKelas(event)" class="space-y-4">
                <input type="hidden" id="kelas-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas <span class="text-red-500">*</span></label>
                    <input type="text" id="kelas-nama" placeholder="Contoh: XI TKJ 1" required
                        class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 text-sm font-medium">
                    <p class="text-xs text-gray-400 mt-1">Nama kelas akan muncul di pilihan saat siswa login & di filter monitoring.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Opsional)</label>
                    <input type="text" id="kelas-keterangan" placeholder="Contoh: Kelas XI Teknik Komputer Jaringan 1"
                        class="w-full px-4 py-2.5 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 text-sm">
                </div>
                <div class="flex justify-end gap-2 pt-2 border-t">
                    <button type="button" onclick="window.closeKelasModal()" class="px-4 py-2 border rounded-xl text-gray-700 hover:bg-gray-50 text-sm font-medium">Batal</button>
                    <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold text-sm flex items-center gap-2 shadow-sm">
                        <i data-lucide="save" class="w-4 h-4"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- SECTION: RESULT -->
    <div id="section-result" class="hidden-section min-h-screen bg-slate-900 flex flex-col items-center justify-start pt-10 p-4 overflow-y-auto">
        <!-- BANNER OFFLINE -->
        <div id="offline-result-banner" class="w-full max-w-2xl mb-3 rounded-2xl border-2 border-orange-300 bg-orange-50 px-5 py-3 flex items-start gap-3 text-left" style="display:none;">
            <span style="font-size:1.3rem;line-height:1.2">&#9888;&#65039;</span>
            <div>
                <p class="text-orange-800 font-black text-sm">Mode Offline ‚Äî Nilai Belum Tersimpan ke Server</p>
                <p class="text-orange-700 text-xs mt-0.5">Koneksi terputus. Nilai tersimpan sementara di perangkat. Sistem mencoba kirim ulang otomatis. Jika gagal, tunjukkan layar ini ke pengawas dan <strong>jangan tutup halaman.</strong></p>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full text-center relative mb-8">
            <div id="result-icon-container" class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="check-circle" class="w-10 h-10"></i></div>
            <h2 id="result-title" class="text-2xl font-bold text-gray-800 mb-2">Ujian Selesai!</h2>
            <p id="result-message" class="text-gray-500 mb-6">Jawaban telah terkirim ke server.</p>
            <div class="bg-slate-50 rounded-xl p-6 mb-4 border border-slate-200">
                <p class="text-sm text-gray-500 uppercase tracking-wider font-semibold mb-1">Nilai Anda</p>
                <p id="final-score-display" class="text-5xl font-extrabold text-blue-600">0</p>
                <p id="final-score-detail" class="text-xs text-gray-400 mt-2"></p>
            </div>
            <div id="motivational-message" class="mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4"></div>
            <div class="flex flex-col gap-3">
                <button onclick="window.toggleReview()" id="btn-review" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                    <i data-lucide="book-open" class="w-5 h-5"></i> Lihat Pembahasan
                </button>
                <div id="discussion-status" class="hidden px-4 py-2 bg-amber-50 border border-amber-300 rounded-lg text-sm text-amber-700">
                    ‚è≥ Pembahasan akan dibuka oleh admin
                </div>
                <button onclick="if(document.exitFullscreen&&document.fullscreenElement)document.exitFullscreen().then(()=>location.reload()).catch(()=>location.reload());else location.reload();" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg transition-transform active:scale-95">Kembali ke Login</button>
            </div>
        </div>
        <div id="review-container" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 hidden mb-10">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2">
                <i data-lucide="file-check" class="w-6 h-6 text-blue-600"></i> Pembahasan Soal
            </h3>
            <div id="review-list" class="space-y-6"></div>
            <div class="mt-8 pt-6 border-t border-gray-100">
                <button onclick="if(document.exitFullscreen&&document.fullscreenElement)document.exitFullscreen().then(()=>location.reload()).catch(()=>location.reload());else location.reload();" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                    <i data-lucide="log-out" class="w-5 h-5"></i> Selesai Belajar & Keluar
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script>
        // ‚îÄ‚îÄ LUCIDE DEBOUNCE untuk HP Kentang ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Pada perf-mode, kumpulkan panggilan createIcons dan jalankan sekali per frame
        (function() {
            let _lucideTimer = null;
            window._createIconsSafe = function() {
                if (typeof lucide === 'undefined') return;
                if (window._perfMode) {
                    clearTimeout(_lucideTimer);
                    _lucideTimer = setTimeout(() => lucide.createIcons(), 80);
                } else {
                    lucide.createIcons();
                }
            };
        })();

        // Definisikan convertGDriveUrl di sini agar tersedia sebelum parseRows
        window.convertGDriveUrl = function(url) {
            if (!url) return '';
            const matchFile = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (matchFile) return `https://drive.google.com/uc?export=view&id=${matchFile[1]}`;
            const matchOpen = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (matchOpen) return `https://drive.google.com/uc?export=view&id=${matchOpen[1]}`;
            return url;
        };
        // --- DATA SOAL STATIC (FALLBACK & SEED) ---
        window.questionBank = {
            A: [
                // LITERASI
                { id: 1, text: "Rizki adalah siswa kelas XI TKJ di SMKN 1 Brondong. Gurunya memberi tugas membuat project jaringan komputer, namun Rizki selalu gagal dalam konfigurasi router. Ia merasa dirinya tidak berbakat di bidang networking dan menyerah. \"Saya memang tidak punya bakat jadi teknisi jaringan,\" katanya. Berdasarkan cerita di atas, pola pikir yang dimiliki Rizki adalah...", options: ["Growth mindset karena mau mencoba mengerjakan tugas", "Fixed mindset karena menganggap kemampuannya sudah terbatas dan tidak bisa berkembang", "Pola pikir inovatif dalam networking", "Pola pikir kreatif dalam pemrograman", "Pola pikir pantang menyerah"], correct: 1 },
                { id: 2, text: "Fahrul, lulusan TKJ SMKN 1 Brondong, membuka usaha service komputer. Ia melihat banyak warga kesulitan akses internet. Fahrul berinovasi menawarkan jasa instalasi jaringan RT/RW Net dengan harga terjangkau. Usahanya berkembang pesat. Karakter wirausaha yang paling menonjol ditunjukkan Fahrul adalah...", options: ["Jujur dalam memberikan pelayanan", "Inovatif dan kreatif melihat peluang bisnis", "Berani mengambil risiko saja", "Rasa ingin tahu terhadap teknologi saja", "Pantang menyerah dalam bekerja"], correct: 1 },
                { id: 3, text: "Devi, siswi kelas XII TKJ SMKN 1 Brondong, membuat website untuk UMKM lokal. Awalnya sepi dan teman-temannya pesimis. Devi tidak menyerah, belajar SEO dan digital marketing, hingga kini websitenya ramai. Sikap Devi menunjukkan ia memiliki...", options: ["Fixed mindset karena awalnya gagal", "Growth mindset karena terus belajar dan tidak menyerah mengembangkan kemampuannya", "Sikap mudah terpengaruh pendapat orang", "Kemampuan yang terbatas dalam web development", "Bakat alami dalam bisnis digital"], correct: 1 },
                { id: 4, text: "Pak Hendra, guru produktif TKJ di SMKN 1 Brondong, selalu mendorong siswa memiliki rasa ingin tahu tinggi terhadap teknologi baru (Cloud, IoT, Cybersecurity). Rasa ingin tahu yang tinggi penting bagi wirausaha karena...", options: ["Membuat seseorang selalu ikut campur urusan bisnis orang lain", "Membantu menemukan peluang bisnis baru dan solusi inovatif di bidang teknologi", "Membuat seseorang tidak fokus pada satu bidang usaha", "Agar bisa mengetahui rahasia kompetitor secara ilegal", "Supaya terlihat pintar di depan pelanggan"], correct: 1 },
                { id: 5, text: "Andi membuka jasa instalasi CCTV di Brondong. Ia mengklaim \"Menggunakan kamera CCTV berteknologi AI dari Jepang\" padahal menggunakan kamera lokal biasa. Pelanggan kecewa. Karakter wirausaha yang TIDAK dimiliki Andi adalah...", options: ["Inovatif dalam pemasaran", "Berani mengambil risiko bisnis", "Jujur dalam berbisnis", "Rasa ingin tahu terhadap produk", "Kreatif dalam promosi"], correct: 2 },
                { id: 6, text: "Siswa TKJ SMKN 1 Brondong sedang belajar tentang kreativitas. Kreativitas dalam kewirausahaan dapat didefinisikan sebagai...", options: ["Kemampuan meniru bisnis kompetitor dengan sempurna", "Bakat alami yang hanya dimiliki orang-orang tertentu sejak lahir", "Kemampuan menghasilkan ide-ide baru dan solusi unik untuk memecahkan masalah", "Keterampilan menjual produk teknologi dengan harga setinggi-tingginya", "Kemampuan menghasilkan uang sebanyak-banyaknya tanpa peduli cara"], correct: 2 },
                { id: 7, text: "Siti, lulusan TKJ SMKN 1 Brondong, ingin membuka warnet gaming. Ia sudah buat proposal dan hitung modal Rp 50 juta. Namun karena takut gagal dan merugi, ia membatalkan rencananya dan memilih jadi karyawan. Karakter wirausaha yang belum dimiliki Siti adalah...", options: ["Jujur dalam perencanaan", "Inovatif membuat proposal", "Berani mengambil risiko dalam berbisnis", "Rasa ingin tahu terhadap peluang", "Kreatif dalam perencanaan bisnis"], correct: 2 },
                { id: 8, text: "Dalam pembelajaran PKK di kelas TKJ SMKN 1 Brondong, guru menjelaskan perbedaan pola pikir. Perbedaan utama antara growth mindset dan fixed mindset dalam kewirausahaan adalah...", options: ["Growth mindset percaya kemampuan bisa berkembang dengan usaha, fixed mindset percaya kemampuan sudah tetap sejak lahir", "Growth mindset hanya untuk orang kaya, fixed mindset untuk orang miskin", "Growth mindset tidak pernah mengalami kegagalan, fixed mindset selalu gagal", "Growth mindset tidak perlu belajar lagi, fixed mindset harus terus belajar", "Keduanya sama saja tidak ada bedanya dalam berwirausaha"], correct: 0 },
                { id: 9, text: "Bayu, alumni TKJ SMKN 1 Brondong, 3 kali gagal bisnis (aksesoris, jasa setting, pulsa). Ia tidak menyerah, belajar dari kesalahan, dan mencoba lagi konsep baru hingga sukses di jasa website. Karakter wirausaha yang paling menonjol dari Bayu adalah...", options: ["Jujur kepada pelanggan", "Pantang menyerah dan terus berusaha", "Rasa ingin tahu tentang teknologi", "Inovatif membuat produk baru", "Berani mengambil risiko besar"], correct: 1 },
                { id: 10, text: "Di laboratorium TKJ SMKN 1 Brondong, siswa diajarkan menerapkan kreativitas. Kreativitas dalam kehidupan sehari-hari khususnya bidang TKJ dapat diterapkan dengan cara...", options: ["Hanya mengikuti tutorial yang ada di internet tanpa modifikasi", "Selalu menunggu guru memberikan solusi untuk setiap masalah", "Mencari solusi unik dan berbeda untuk masalah teknis yang dihadapi", "Menghindari hal-hal baru yang belum pernah dipelajari di sekolah", "Hanya fokus mengerjakan tugas rutin yang sudah diajarkan"], correct: 2 },
                
                // NUMERASI
                { id: 11, text: "Rina, siswi kelas XI TKJ, mengikuti pelatihan 5 hari dengan materi berbeda tiap hari. Jika ia harus memilih kombinasi 3 karakter paling tepat untuk membuka usaha service komputer baru, kombinasi mana yang paling diperlukan?", options: ["Rasa ingin tahu, Berani mengambil risiko, Jujur", "Pantang menyerah, Inovatif, Jujur", "Berani mengambil risiko, Pantang menyerah, Inovatif", "Rasa ingin tahu, Inovatif, Pantang menyerah", "Semua karakter sama pentingnya (5 karakter)"], correct: 2 },
                { id: 12, text: "Pak Hendra memberikan 4 pernyataan tentang mindset. (1) Tidak berbakat, (2) Kegagalan adalah belajar, (3) Kemampuan sudah maksimal, (4) Dengan latihan bisa lebih baik. Berapa jumlah pernyataan yang menunjukkan growth mindset?", options: ["1 pernyataan", "2 pernyataan", "3 pernyataan", "4 pernyataan", "Tidak ada yang menunjukkan growth mindset"], correct: 1 },
                { id: 13, text: "Dimas ikut lomba LKS. Tahun 1: Gagal penyisihan. Tahun 2: Semifinal. Tahun 3: Juara 2 Provinsi. Ini menunjukkan konsep mindset apa dan berapa tingkat peningkatan prestasinya (jumlah tahap)?", options: ["Fixed mindset, peningkatan 1 tahap", "Growth mindset, peningkatan 2 tahap", "Growth mindset, peningkatan 3 tahap", "Fixed mindset, peningkatan 3 tahap", "Growth mindset, tidak ada peningkatan"], correct: 1 },
                { id: 14, text: "Siswa kelas X TKJ membuat project kreatif barang bekas. Hasil: 6 sangat inovatif, 12 cukup kreatif, 8 biasa, 4 tidak mengumpulkan. Berapa persen siswa yang menunjukkan kreativitas tinggi (sangat inovatif dan cukup kreatif)?", options: ["40%", "50%", "60%", "70%", "80%"], correct: 2 },
                { id: 15, text: "Fahrul merencanakan target pelanggan: Bulan 1-2 (10 pelanggan), Bulan 3-4 (5 pelanggan), Bulan 5-6 (8 pelanggan). Karakter apa yang ditunjukkan dan berapa total target 6 bulan?", options: ["Berani mengambil risiko, 20 pelanggan", "Rasa ingin tahu, 23 pelanggan", "Inovatif dan terencana, 23 pelanggan", "Pantang menyerah, 25 pelanggan", "Jujur, 30 pelanggan"], correct: 2 },
                { id: 16, text: "Siti menghadapi 5 kegagalan dalam mengembangkan aplikasi, namun terus belajar. Pada percobaan ke-6, aplikasinya berhasil. Sikap ini menunjukkan karakter apa dan berapa kali total ia mencoba?", options: ["Jujur, 5 kali", "Inovatif, 5 kali", "Pantang menyerah, 6 kali", "Berani mengambil risiko, 6 kali", "Rasa ingin tahu, 7 kali"], correct: 2 },
                { id: 17, text: "Skor kreativitas: Meniru=1, Modifikasi=2, Inovasi=3. Reza membuat 4 ide: 1 meniru, 2 modifikasi, 1 inovasi. Berapa total skor kreativitas Reza?", options: ["6", "7", "8", "9", "10"], correct: 2 },
                { id: 18, text: "Bayu ingin mengembangkan 5 karakter wirausaha. Ada 2 karakter dasar (rasa ingin tahu & berani ambil risiko) yang harus dikuasai pertama. Jika tiap karakter butuh 2 bulan, berapa bulan untuk menguasai 2 karakter dasar tersebut?", options: ["2 bulan", "4 bulan", "6 bulan", "8 bulan", "10 bulan"], correct: 1 },
                { id: 19, text: "Dari 24 siswa, 18 memilih bangkit dan coba lagi (growth mindset), 6 memilih menyerah (fixed mindset). Berapa persentase siswa yang menunjukkan growth mindset?", options: ["25%", "50%", "65%", "75%", "80%"], correct: 3 },
                { id: 20, text: "Andi memilih ide bisnis: Riset 5 ide -> Pilih 3 -> Uji coba 2 -> Luncurkan 1. Berapa total ide yang diriset dan berapa yang diluncurkan?", options: ["Riset 5 ide, luncurkan 3 ide", "Riset 5 ide, luncurkan 2 ide", "Riset 5 ide, luncurkan 1 ide", "Riset 3 ide, luncurkan 1 ide", "Riset 3 ide, luncurkan 2 ide"], correct: 2 }
            ],
            B: [
                // LITERASI
                { id: 1, text: "Ahmad, siswa kelas XII TKJ SMKN 1 Brondong, mendapat nilai jelek saat ujian praktik instalasi server. Ia berkata kepada temannya, \"Saya memang bodoh, tidak akan pernah bisa menguasai materi server. Lebih baik saya fokus ke hal lain saja.\" Ahmad pun tidak mau belajar lagi tentang server. Pola pikir yang ditunjukkan Ahmad adalah...", options: ["Growth mindset karena mau mencari fokus baru", "Growth mindset karena realistis dengan kemampuan", "Fixed mindset karena percaya kemampuannya tidak bisa berkembang", "Pola pikir inovatif dalam belajar", "Pola pikir kreatif dalam menyelesaikan masalah"], correct: 2 },
                { id: 2, text: "Ibu Zahra, alumni TKJ SMKN 1 Brondong, membuka usaha fotocopy dan print di dekat sekolah. Ia melihat banyak siswa yang kesulitan mengedit dokumen. Ibu Zahra kemudian menambah layanan jasa pengetikan, editing dokumen, dan desain grafis sederhana. Kini usahanya menjadi one-stop service untuk kebutuhan siswa dan tidak hanya bergantung pada fotocopy saja. Karakter wirausaha yang paling dominan ditunjukkan Ibu Zahra adalah...", options: ["Jujur dalam memberikan layanan terbaik", "Pantang menyerah menghadapi persaingan", "Kreatif dan inovatif mengembangkan layanan bisnis", "Berani mengambil risiko membuka usaha", "Rasa ingin tahu tentang kebutuhan pasar"], correct: 2 },
                { id: 3, text: "Yoga, siswa kelas XI TKJ, membuat aplikasi mobile untuk mencatat tugas sekolah. Aplikasi pertamanya crash terus dan tidak ada yang mau pakai. Teman-temannya bilang \"kamu tidak cocok jadi programmer.\" Namun Yoga tidak putus asa. Ia bertanya ke kakak kelasnya, menonton tutorial YouTube, belajar dari forum online, dan terus memperbaiki coding-nya. Setelah 3 bulan, aplikasinya berhasil dan digunakan 100 siswa TKJ. Sikap Yoga menunjukkan ia memiliki...", options: ["Fixed mindset karena awalnya gagal membuat aplikasi", "Bakat alami sebagai programmer sejak lahir", "Growth mindset karena percaya kemampuan bisa berkembang dengan belajar", "Sikap mudah terpengaruh pendapat negatif orang lain", "Kemampuan yang terbatas dalam programming"], correct: 2 },
                { id: 4, text: "Pak Arif, guru produktif TKJ di SMKN 1 Brondong, selalu mengajarkan pentingnya karakter \"berani mengambil risiko\" bagi wirausahawan muda. Yang dimaksud dengan \"berani mengambil risiko\" dalam kewirausahaan adalah...", options: ["Nekat melakukan bisnis tanpa perhitungan yang matang", "Meminjam uang sebanyak-banyaknya untuk modal usaha", "Berani memulai usaha baru meski ada kemungkinan gagal, dengan perhitungan dan persiapan yang baik", "Meniru bisnis orang lain agar tidak rugi", "Hanya memulai bisnis yang sudah pasti untung 100%"], correct: 2 },
                { id: 5, text: "Budi membuka jasa pembuatan website untuk UMKM. Dalam promosi, ia klaim \"website akan selesai dalam 3 hari\" padahal kenyataannya butuh waktu 2 minggu. Banyak klien yang kecewa karena janji tidak ditepati, meskipun hasil websitenya bagus. Reputasi usaha Budi mulai menurun. Karakter wirausaha yang TIDAK dimiliki Budi adalah...", options: ["Inovatif membuat website berkualitas", "Kreatif dalam desain website", "Jujur dalam berbisnis dan menepati janji", "Berani mengambil risiko bisnis", "Memiliki keterampilan teknis yang baik"], correct: 2 },
                { id: 6, text: "Dalam pembelajaran kewirausahaan, guru menjelaskan bahwa kreativitas bukan hanya tentang seni atau desain, tetapi juga tentang cara berpikir dalam memecahkan masalah bisnis. Penerapan kreativitas dalam bisnis teknologi dapat berupa...", options: ["Selalu menggunakan cara yang sudah terbukti berhasil tanpa perubahan", "Menunggu orang lain membuat inovasi baru lalu menirunya", "Menciptakan solusi baru atau cara berbeda untuk memecahkan masalah pelanggan", "Fokus hanya pada satu produk tanpa variasi", "Mengikuti semua tren tanpa analisis kebutuhan pasar"], correct: 2 },
                { id: 7, text: "Lia ingin membuka toko komputer online. Ia sudah riset pasar, punya supplier terpercaya, dan modal cukup. Namun ia khawatir \"bagaimana kalau tidak laku?\" dan \"bagaimana kalau rugi?\". Karena terlalu takut, akhirnya Lia membatalkan niatnya dan memilih menjadi karyawan di toko komputer orang lain dengan gaji pas-pasan. Karakter wirausaha yang belum dimiliki Lia adalah...", options: ["Kreatif dalam merencanakan bisnis", "Jujur dalam menjalankan usaha", "Rasa ingin tahu tentang peluang bisnis", "Berani mengambil risiko dalam berwirausaha", "Inovatif dalam mencari supplier"], correct: 3 },
                { id: 8, text: "Di kelas PKK, guru menjelaskan perbedaan cara berpikir antara growth mindset dan fixed mindset saat menghadapi kegagalan dalam bisnis. Perbedaan respons terhadap kegagalan antara growth mindset dan fixed mindset adalah...", options: ["Growth mindset melihat kegagalan sebagai pembelajaran, fixed mindset melihat kegagalan sebagai bukti ketidakmampuan", "Growth mindset tidak pernah gagal, fixed mindset selalu gagal", "Growth mindset untuk orang pintar, fixed mindset untuk orang bodoh", "Keduanya sama-sama takut gagal dalam bisnis", "Growth mindset langsung menyerah, fixed mindset terus mencoba"], correct: 0 },
                { id: 9, text: "Hasan, alumni TKJ SMKN 1 Brondong, sudah 4 kali mencoba berbagai bisnis teknologi namun gagal: warnet tutup, jual aksesoris komputer sepi, jasa instalasi jaringan tidak berkembang, dan rental PS bangkrut. Namun ia tidak menyerah. Di percobaan kelima, ia membuka kursus komputer untuk anak-anak dan berhasil dengan 30 siswa tetap. Hasan berkata, \"Setiap kegagalan mengajarkan saya sesuatu yang berharga.\" Karakter wirausaha yang paling menonjol dari Hasan adalah...", options: ["Jujur kepada diri sendiri", "Inovatif menciptakan produk baru", "Pantang menyerah dan terus berusaha", "Berani mengambil risiko besar", "Rasa ingin tahu yang tinggi"], correct: 2 },
                { id: 10, text: "Siswa TKJ SMKN 1 Brondong belajar bahwa kreativitas adalah keterampilan yang bisa dilatih dan dikembangkan dalam kehidupan sehari-hari. Cara melatih kreativitas dalam kehidupan sehari-hari sebagai siswa TKJ adalah...", options: ["Selalu mengerjakan tugas dengan cara yang sama seperti contoh guru", "Menghindari hal-hal baru karena takut salah", "Mencoba berbagai cara berbeda untuk menyelesaikan masalah teknis", "Hanya fokus pada teori tanpa praktik", "Meniru pekerjaan teman tanpa modifikasi"], correct: 2 },
                
                // NUMERASI
                { id: 11, text: "Kelas XII TKJ SMKN 1 Brondong mengadakan workshop kewirausahaan selama 6 hari. Materi yang diajarkan adalah: Hari 1: Pentingnya kreativitas (2 jam), Hari 2: Growth mindset vs Fixed mindset (3 jam), Hari 3: Karakter jujur dan berani mengambil risiko (2 jam), Hari 4: Karakter inovatif dan pantang menyerah (3 jam), Hari 5: Karakter rasa ingin tahu (2 jam), Hari 6: Praktik membuat business plan (4 jam). Berapa total jam pembelajaran tentang karakter wirausaha (hari 3, 4, dan 5)?", options: ["5 jam", "6 jam", "7 jam", "8 jam", "9 jam"], correct: 2 },
                { id: 12, text: "Dalam diskusi kelompok, guru memberikan 6 pernyataan dan meminta siswa mengidentifikasi mana yang termasuk growth mindset: 1. \"Saya belum bisa, tapi saya akan terus belajar\", 2. \"Ini terlalu sulit untuk saya\", 3. \"Kesalahan membantu saya belajar\", 4. \"Saya tidak berbakat di bidang ini\", 5. \"Usaha saya akan membuat saya lebih baik\", 6. \"Kemampuan saya sudah mentok\". Berapa jumlah pernyataan yang menunjukkan growth mindset?", options: ["1 pernyataan", "2 pernyataan", "3 pernyataan", "4 pernyataan", "5 pernyataan"], correct: 2 },
                { id: 13, text: "Fitri mengikuti kompetisi web design tingkat nasional selama 4 tahun berturut-turut dengan hasil: Tahun 1: Tidak lolos seleksi awal (skor 0), Tahun 2: Lolos seleksi, masuk 20 besar (skor 2), Tahun 3: Masuk 10 besar (skor 3), Tahun 4: Juara 3 nasional (skor 4). Jika kita beri nilai untuk setiap pencapaian (tidak lolos = 0, lolos = 1, 20 besar = 2, 10 besar = 3, juara 3 = 4), berapa total nilai pencapaian Fitri dalam 4 tahun?", options: ["7", "8", "9", "10", "11"], correct: 2 },
                { id: 14, text: "Guru PKK memberikan tugas membuat inovasi produk teknologi. Dari 40 siswa TKJ, hasil kreativitas mereka dinilai: 8 siswa sangat inovatif, 16 siswa cukup kreatif, 10 siswa kurang kreatif, 6 siswa tidak mengumpulkan. Berapa persen siswa yang menunjukkan kreativitas baik (sangat inovatif + cukup kreatif)?", options: ["40%", "50%", "60%", "70%", "80%"], correct: 2 },
                { id: 15, text: "Andi merencanakan strategi bisnis instalasi WiFi dengan target bertahap: Fase 1 (bulan 1-3): Fokus ke 15 rumah warga di dekat sekolah, Fase 2 (bulan 4-6): Tambah 10 warung dan toko kecil, Fase 3 (bulan 7-9): Tambah 12 kantor dan klinik. Karakter apa yang ditunjukkan dengan perencanaan bertahap ini, dan berapa total target pelanggan dalam 9 bulan?", options: ["Pantang menyerah, 30 pelanggan", "Jujur, 35 pelanggan", "Inovatif dan terencana, 37 pelanggan", "Berani mengambil risiko, 40 pelanggan", "Rasa ingin tahu, 45 pelanggan"], correct: 2 },
                { id: 16, text: "Dini mencoba membuat game edukasi untuk anak SD. Ia mengalami kegagalan dan terus belajar: Percobaan 1-3: Gagal (game tidak menarik), Percobaan 4-6: Gagal (terlalu sulit untuk anak), Percobaan 7-8: Gagal (terlalu mudah, anak bosan), Percobaan 9: Berhasil (balance antara fun dan edukatif). Sikap Dini menunjukkan karakter apa, dan berapa total percobaan yang ia lakukan?", options: ["Jujur, 7 kali", "Inovatif, 8 kali", "Berani mengambil risiko, 8 kali", "Pantang menyerah, 9 kali", "Rasa ingin tahu, 10 kali"], correct: 3 },
                { id: 17, text: "Dalam penilaian project kewirausahaan, guru memberikan bobot untuk 5 karakter wirausaha: Jujur (bobot 3), Berani mengambil risiko (bobot 4), Pantang menyerah (bobot 5), Inovatif (bobot 5), Rasa ingin tahu (bobot 3). Toni dalam project-nya menunjukkan 3 karakter: jujur, pantang menyerah, dan inovatif. Berapa total skor Toni?", options: ["10", "11", "12", "13", "15"], correct: 3 },
                { id: 18, text: "Program pengembangan mindset wirausaha di SMKN 1 Brondong berlangsung 12 bulan. Fokus pembelajaran setiap kuartal: Kuartal 1 (3 bulan): Membangun growth mindset, Kuartal 2 (3 bulan): Melatih kreativitas dan inovasi, Kuartal 3 (3 bulan): Mengembangkan karakter wirausaha, Kuartal 4 (3 bulan): Praktik membuat dan menjalankan bisnis. Jika seorang siswa ingin fokus mempelajari tentang growth mindset dan kreativitas, berapa bulan waktu yang dialokasikan untuk kedua topik tersebut?", options: ["3 bulan", "4 bulan", "5 bulan", "6 bulan", "9 bulan"], correct: 3 },
                { id: 19, text: "Dalam survei tentang pola pikir di kelas XII TKJ (36 siswa), hasilnya: 27 siswa setuju bahwa \"kemampuan bisa berkembang dengan usaha keras\", 9 siswa percaya bahwa \"kemampuan sudah ditentukan sejak lahir\". Berapa persentase siswa yang memiliki growth mindset?", options: ["25%", "50%", "65%", "75%", "85%"], correct: 3 },
                { id: 20, text: "Riko melatih kreativitasnya dengan mengembangkan ide bisnis teknologi secara bertahap: Tahap 1: Brainstorming 8 ide bisnis, Tahap 2: Seleksi menjadi 5 ide potensial, Tahap 3: Riset mendalam untuk 3 ide terbaik, Tahap 4: Prototype untuk 2 ide teratas, Tahap 5: Launching 1 ide terbaik. Dari proses kreatif Riko, berapa total ide yang ia kumpulkan di awal, dan berapa ide yang akhirnya dijalankan?", options: ["Kumpulkan 5 ide, jalankan 1 ide", "Kumpulkan 6 ide, jalankan 2 ide", "Kumpulkan 8 ide, jalankan 1 ide", "Kumpulkan 8 ide, jalankan 2 ide", "Kumpulkan 10 ide, jalankan 1 ide"], correct: 2 }
            ],
            C: [
                // SOAL HOTS KEAMANAN JARINGAN (LITERASI 1-10)
                { id: 1, text: "Sebuah server sekolah mengalami kelambatan luar biasa. Tim IT menemukan log yang menunjukkan jutaan request dari ribuan alamat IP berbeda dalam waktu bersamaan, menyebabkan CPU server mencapai 100%. Serangan ini dikategorikan sebagai...", options: ["Phishing", "Man in the Middle", "DDoS (Distributed Denial of Service)", "SQL Injection", "Ransomware"], correct: 2 },
                { id: 2, text: "Admin jaringan sedang mengkonfigurasi Firewall untuk Web Server. Ia ingin memastikan server bisa diakses publik untuk website, tetapi tidak ingin orang asing bisa mengakses remote SSH. Konfigurasi aturan firewall mana yang paling efektif dan aman?", options: ["Allow All Traffic", "Block All Traffic", "Allow Port 80 & 443 Only, Block Others", "Allow Port 21 (FTP) & 22 (SSH) Only", "Allow ICMP Ping Only"], correct: 2 },
                { id: 3, text: "Dalam Vulnerability Assessment, ditemukan bahwa server menggunakan versi Apache yang sudah usang (outdated) dan memiliki celah keamanan CVE-2023-XXXX. Risiko terbesar jika hal ini dibiarkan adalah...", options: ["Internet menjadi lambat", "Kerusakan hardware server", "Penyerang bisa mengeksploitasi celah (Exploit) untuk mengambil alih sistem", "Server akan mati otomatis karena lisensi habis", "Tidak ada risiko karena server masih berjalan normal"], correct: 2 },
                { id: 4, text: "Seorang teknisi diminta mengamankan jaringan Wi-Fi sekolah. Pilihan enkripsi mana yang paling direkomendasikan saat ini untuk memberikan keamanan maksimal terhadap serangan brute force?", options: ["WEP (Wired Equivalent Privacy)", "WPA3-AES (Wi-Fi Protected Access 3)", "WPA (Wi-Fi Protected Access)", "TKIP (Temporal Key Integrity Protocol)", "Open System (Tanpa Password)"], correct: 1 },
                { id: 5, text: "Guru menerima email yang terlihat resmi dari 'Kepala Sekolah' meminta transfer pulsa segera dengan bahasa yang sedikit kaku dan mendesak. Setelah dicek, alamat email pengirim ternyata 'kepalasekolah123@gmail.com', bukan email resmi sekolah. Teknik serangan ini disebut...", options: ["Spamming", "Phishing / Social Engineering", "Virus", "Worm", "Adware"], correct: 1 },
                { id: 6, text: "Banyak siswa menggunakan password '123456' atau 'password' untuk akun e-learning mereka. Kebijakan keamanan (Password Policy) terbaik untuk mengatasi masalah ini adalah...", options: ["Membiarkan saja agar siswa tidak lupa", "Mewajibkan kombinasi huruf, angka, simbol, dan menerapkan MFA (Multi-Factor Authentication)", "Mewajibkan ganti password setiap hari", "Menulis password di kertas dan ditempel di monitor", "Meminta siswa saling bertukar password agar bisa saling mengingatkan"], correct: 1 },
                { id: 7, text: "Sebuah komputer di lab komputer tiba-tiba menampilkan layar merah dengan pesan 'File Anda telah dienkripsi. Bayar $500 dalam Bitcoin untuk mendapatkan kuncinya'. Serangan malware jenis ini disebut...", options: ["Spyware", "Adware", "Trojan", "Ransomware", "Rootkit"], correct: 3 },
                { id: 8, text: "Untuk mengantisipasi bencana alam atau serangan siber yang merusak data server utama, strategi backup data yang paling direkomendasikan menurut standar industri adalah...", options: ["Simpan backup di folder C: komputer yang sama", "Copy file ke satu Flashdisk dan dibawa pulang", "Strategi 3-2-1 (3 salinan data, 2 media berbeda, 1 disimpan di lokasi berbeda/cloud)", "Upload ke Google Drive saja tanpa backup lokal", "Print semua dokumen penting sebagai arsip"], correct: 2 },
                { id: 9, text: "Jaringan Wi-Fi tamu (Guest) di sekolah seringkali menyebabkan jaringan utama (Admin/Guru) menjadi lambat dan berisiko terkena virus dari perangkat tamu. Solusi jaringan terbaik untuk masalah ini adalah...", options: ["Mematikan Wi-Fi tamu selamanya", "Membeli router yang lebih mahal", "Menerapkan VLAN (Virtual Local Area Network) untuk memisahkan segmentasi jaringan", "Meminta tamu tidak menggunakan internet", "Menggunakan Hub agar semua terhubung jadi satu"], correct: 2 },
                { id: 10, text: "Jika terjadi insiden peretasan pada server sekolah, langkah pertama yang harus dilakukan menurut prosedur Incident Response adalah...", options: ["Format ulang semua komputer segera", "Panik dan mematikan listrik gedung", "Containment (Isolasi sistem yang terdampak agar serangan tidak menyebar)", "Membayar uang tebusan kepada peretas", "Membiarkan saja sampai peretas bosan"], correct: 2 },
                
                // SOAL HOTS KEAMANAN JARINGAN (NUMERASI 11-20)
                { id: 11, text: "Sebuah password hash sederhana membutuhkan waktu 54.000 detik untuk dipecahkan menggunakan teknik Brute Force dengan hardware standar. Berapa jam waktu yang dibutuhkan penyerang untuk menembus password tersebut?", options: ["10 Jam", "15 Jam", "20 Jam", "24 Jam", "12 Jam"], correct: 1 },
                { id: 12, text: "Sistem firewall baru berhasil memblokir serangan siber secara signifikan. Dari rata-rata 1.000 percobaan serangan per hari, setelah firewall dipasang, hanya tersisa 127 serangan yang lolos atau terdeteksi sebagai anomali. Berapa persen tingkat keberhasilan pengurangan (reduction) serangan tersebut?", options: ["80%", "85%", "87.3%", "90%", "75.5%"], correct: 2 },
                { id: 13, text: "Traffic normal sebuah jaringan kantor adalah 110 Mbps. Tiba-tiba terjadi serangan DDoS sehingga total traffic melonjak menjadi 500 Mbps. Berapa besar traffic anomali (serangan) yang membanjiri jaringan tersebut?", options: ["390 Mbps", "400 Mbps", "500 Mbps", "610 Mbps", "110 Mbps"], correct: 0 },
                { id: 14, text: "Sebuah server log keamanan menghasilkan data log sebesar 100 MB per hari. Jika kebijakan retensi data mengharuskan log disimpan selama 30 hari, berapa kapasitas penyimpanan minimal yang dibutuhkan?", options: ["1 GB", "2 GB", "3 GB", "30 GB", "100 GB"], correct: 2 },
                { id: 15, text: "Sebuah file rahasia berukuran 1.024 MB dicuri (exfiltration) oleh peretas melalui jaringan dengan kecepatan upload 8 Mbps (Megabit per second). Berapa detik waktu yang dibutuhkan peretas untuk mengambil file tersebut? (Ingat: 1 Byte = 8 bit)", options: ["128 detik", "512 detik", "1024 detik", "100 detik", "60 detik"], correct: 2 },
                { id: 16, text: "Dalam audit keamanan, ditemukan 5 celah keamanan (vulnerability) dengan skor risiko: 8, 9, 4, 2, dan 7. Jika perusahaan menetapkan bahwa hanya celah dengan skor di atas 6 yang wajib ditambal segera (High Risk), berapa jumlah celah yang harus segera diperbaiki?", options: ["1 Celah", "2 Celah", "3 Celah", "4 Celah", "5 Celah"], correct: 2 },
                { id: 17, text: "Perusahaan menginvestasikan Rp 100 Juta untuk sistem keamanan baru. Sistem ini berhasil mencegah kerugian akibat serangan siber senilai Rp 450 Juta. Berapa nilai penghematan bersih (Net Savings) yang didapatkan perusahaan?", options: ["Rp 100 Juta", "Rp 250 Juta", "Rp 350 Juta", "Rp 450 Juta", "Rp 550 Juta"], correct: 2 },
                { id: 18, text: "Seorang admin membagi jaringan menggunakan subnet mask /27 (255.255.255.224). Berapa jumlah host (IP Address) yang valid dan bisa digunakan untuk perangkat dalam satu subnet tersebut?", options: ["254 Host", "126 Host", "30 Host", "62 Host", "14 Host"], correct: 2 },
                { id: 19, text: "Analisis risiko menggunakan rumus: Risk = Impact x Probability. Jika dampak (Impact) kebocoran data bernilai 5 (Sangat Tinggi) dan kemungkinan (Probability) terjadinya bernilai 4 (Tinggi), berapa skor risiko keamanan tersebut?", options: ["9", "1", "20", "54", "10"], correct: 2 },
                { id: 20, text: "Akibat serangan Ransomware, sebuah e-commerce mati total (downtime) selama 24 jam. Jika rata-rata pendapatan per jam adalah Rp 10 Juta, berapa total kerugian finansial langsung akibat serangan tersebut?", options: ["Rp 100 Juta", "Rp 120 Juta", "Rp 200 Juta", "Rp 240 Juta", "Rp 10 Juta"], correct: 3 }
            ]
        };

        // --- STATE ---
        let currentStudent = {};
        let examTimer = null;
        let timeLeft = 3600; 
        let violations = 0;
        let violationLogs = []; 
        let userAnswers = {};
        let dashboardData = [];
        let currentFilteredData = [];
        let currentQuestionList = [];
        let currentQuestionIndex = 0;
        let isWarningActive = false; 
        
        // --- NEW: STATE UNTUK MENCEGAH FALSE POSITIVE SAAT ROTASI ---
        let isRotating = false;

        // ==================== MANAJEMEN RUANG UJIAN ====================
        window.ruangList = [];


        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // JADWAL UJIAN OTOMATIS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window.allJadwalDB = [];
        window._jadwalSchedulerTimer = null;

        // Listen jadwal dari Firestore
        window.appearanceDefaults = {
            judulUjian : 'INTEGRITEST',
            subJudul   : 'Digitalyzing Integrity, Empowering Honestly',
            motivasi   : 'Kerjakan dengan jujur dan penuh semangat. Hasil terbaik lahir dari usaha yang sungguh-sungguh. Percayalah pada kemampuanmu ‚Äî sukses menantimu!',
            logoUrl    : 'images/integritest.png'
        };

        // Terapkan pengaturan tampilan ke semua elemen UI
        window.applyAppearanceSettings = function(s) {
            if (!s) return;
            const judul   = (s.judulUjian || '').trim();
            const sub     = (s.subJudul   || '').trim();
            const mot     = (s.motivasi   || '').trim();
            const logo    = (s.logoUrl    || '').trim();
            const mode    = s.nomorIdMode || 'nisn'; // 'nisn' | 'kartu'

            // Halaman Login header (nama ujian custom)
            const loginH1  = document.getElementById('login-header-judul');
            const loginSub = document.getElementById('login-header-sub');
            const loginExamWrap = document.getElementById('login-exam-name-wrap');
            if (loginH1 && judul) { loginH1.textContent = judul; }
            if (loginSub && sub)  { loginSub.textContent = sub; }
            // Tampilkan blok nama ujian hanya kalau ada isinya
            if (loginExamWrap) {
                if (judul || sub) { loginExamWrap.classList.remove('hidden'); loginExamWrap.style.display = 'flex'; }
                else              { loginExamWrap.classList.add('hidden'); loginExamWrap.style.display = ''; }
            }

            // Logo di login
            const loginLogo = document.querySelector('#section-login img[alt="Logo TKJ"]');
            if (loginLogo && logo) loginLogo.src = logo;

            // Halaman Welcome header
            const welcomeTitle = document.querySelector('#section-welcome h2');
            // Tampilkan judulUjian di welcome (bukan hardcode 'Halo! üëã')
            const welcomeJudulEl = document.getElementById('welcome-judul-ujian');
            const welcomeSubEl   = document.getElementById('welcome-sub-judul');
            const welcomeJudulWrap = document.getElementById('welcome-judul-ujian-wrap');
            if (welcomeJudulEl && judul) {
                welcomeJudulEl.textContent = judul;
                if (welcomeJudulWrap) welcomeJudulWrap.style.display = '';
            }
            if (welcomeSubEl && sub) welcomeSubEl.textContent = sub;

            // Teks motivasi di welcome
            const motEl = document.getElementById('welcome-motivasi-text');
            if (motEl && mot) motEl.innerHTML = mot;

            // Preview di panel tampilan
            const set = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
            if (judul) set('preview-judul', judul);
            if (sub)   set('preview-sub',   sub);
            if (mot)   set('preview-motivasi', mot);
            const pLogo = document.getElementById('preview-logo');
            if (pLogo && logo) pLogo.src = logo;

            // ‚îÄ‚îÄ Ubah label & placeholder kolom ID siswa di form login ‚îÄ‚îÄ
            window._nomorIdMode = mode;
            const labelEl = document.getElementById('label-nomor-id');
            const inputEl = document.getElementById('student-nisn');
            const welcomeNisnLabel = document.getElementById('welcome-nisn-label');
            const dashHeaderEl = document.getElementById('th-nisn');
            if (mode === 'kartu') {
                if (labelEl)  labelEl.textContent = 'No. Kartu Ujian';
                if (inputEl)  { inputEl.placeholder = 'Ketik No. Kartu Ujian...'; inputEl.setAttribute('type', 'text'); }
                if (welcomeNisnLabel) welcomeNisnLabel.textContent = 'NO. KARTU';
                if (dashHeaderEl) dashHeaderEl.textContent = 'No. Kartu';
            } else {
                if (labelEl)  labelEl.textContent = 'NISN';
                if (inputEl)  { inputEl.placeholder = 'Ketik NISN...'; inputEl.setAttribute('type', 'number'); }
                if (welcomeNisnLabel) welcomeNisnLabel.textContent = 'NISN';
                if (dashHeaderEl) dashHeaderEl.textContent = 'NISN';
            }

            // Sinkron dropdown setting
            const modeSelect = document.getElementById('setting-nomor-id-mode');
            if (modeSelect && document.activeElement !== modeSelect) modeSelect.value = mode;

            // Update info ujian di header pengawas (jika sedang login sebagai pengawas)
            const _pjEl  = document.getElementById('pengawas-exam-judul');
            const _psEl  = document.getElementById('pengawas-exam-sub');
            const _piWrap = document.getElementById('pengawas-exam-info');
            if (_pjEl) _pjEl.textContent = judul;
            if (_psEl) _psEl.textContent = sub;
            if (_piWrap) {
                if (judul || sub) _piWrap.classList.remove('hidden');
                else _piWrap.classList.add('hidden');
            }

            // Update judul + nama SMK di header dashboard saat login Admin
            const _adJudulEl  = document.getElementById('admin-exam-judul');
            const _adSubEl    = document.getElementById('admin-exam-sub');
            const _adInfoWrap = document.getElementById('admin-exam-info');
            if (_adJudulEl) _adJudulEl.textContent = judul;
            if (_adSubEl)   _adSubEl.textContent   = sub;
            // Tampilkan hanya jika sedang login sebagai admin (bukan pengawas) dan ada isinya
            if (_adInfoWrap) {
                const isAdmin = document.getElementById('pengawas-exam-info')?.classList.contains('hidden') ?? true;
                if ((judul || sub) && isAdmin) { _adInfoWrap.classList.remove('hidden'); _adInfoWrap.style.display = 'flex'; }
                else { _adInfoWrap.classList.add('hidden'); _adInfoWrap.style.display = ''; }
            }
        };

        // Isi form panel tampilan dari pengaturan tersimpan
        window.loadTampilanFields = function() {
            const s = window._savedAppearance || {};
            const setVal = (id, v) => { const el = document.getElementById(id); if(el && v !== undefined) el.value = v; };
            setVal('setting-judul-ujian', s.judulUjian);
            setVal('setting-sub-judul',   s.subJudul);
            setVal('setting-motivasi',    s.motivasi);
            setVal('setting-logo-url',    s.logoUrl);
            setVal('setting-nomor-id-mode', s.nomorIdMode || 'nisn');
            window.updateTampilanPreview();
            if (window.loadAdminCredentialFields) window.loadAdminCredentialFields();
        };

        // Live preview saat mengetik
        window.updateTampilanPreview = function() {
            const g = (id) => (document.getElementById(id)?.value || '').trim();
            const judul = g('setting-judul-ujian') || window.appearanceDefaults.judulUjian;
            const sub   = g('setting-sub-judul')   || window.appearanceDefaults.subJudul;
            const mot   = g('setting-motivasi')    || window.appearanceDefaults.motivasi;
            const logo  = g('setting-logo-url')    || window.appearanceDefaults.logoUrl;
            const mode  = document.getElementById('setting-nomor-id-mode')?.value || 'nisn';
            const set = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
            set('preview-judul', judul);
            set('preview-sub', sub);
            set('preview-motivasi', mot);
            set('preview-nomor-id-label', mode === 'kartu' ? 'No. Kartu Ujian' : 'NISN');
            const pLogo = document.getElementById('preview-logo');
            if (pLogo) pLogo.src = logo;
        };

        // ==================== END SETTING TAMPILAN ====================

        // Sinkronisasi currentSesiId/Name dari jadwal aktif
        window._syncSesiFromJadwal = function() {
            const jadwalAktifList = (window.allJadwalDB || []).filter(j => j.isActive === true);
            const jadwalAktif = jadwalAktifList[0] || null;
            if (jadwalAktif) {
                window.currentSesiId   = jadwalAktif.id;
                window.currentSesiName = jadwalAktif.nama;
            } else {
                const sorted = (window.allJadwalDB || []).slice().sort((a,b) => (b.createdAt||0)-(a.createdAt||0));
                if (sorted.length > 0) {
                    window.currentSesiId   = sorted[0].id;
                    window.currentSesiName = sorted[0].nama;
                } else {
                    window.currentSesiId   = 'default';
                    window.currentSesiName = 'Sesi Default';
                }
            }
            const badge = document.getElementById('active-sesi-badge');
            const label = document.getElementById('active-sesi-label');
            if (badge && label) {
                if (jadwalAktif) {
                    const nama = jadwalAktifList.length > 1 ? jadwalAktifList.map(j => j.nama).join(', ') : jadwalAktif.nama;
                    badge.classList.remove('hidden'); badge.classList.add('flex');
                    label.textContent = nama;
                } else { badge.classList.add('hidden'); }
            }
            if (window.updateSesiFilter) window.updateSesiFilter();
        };

        // Update dropdown filter jadwal di monitoring
        window.updateSesiFilter = function() {
            const sel = document.getElementById('filter-sesi');
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="active">Jadwal Aktif</option><option value="all">Semua Jadwal (History)</option>';
            (window.allJadwalDB || []).slice()
                .sort((a,b) => a.tanggal !== b.tanggal ? (b.tanggal > a.tanggal ? 1 : -1) : (b.jamMulai > a.jamMulai ? 1 : -1))
                .forEach(j => {
                    const opt = document.createElement('option');
                    opt.value = j.id;
                    opt.textContent = (j.nama || j.id) + (j.isActive ? ' ‚ö°' : '') + (j.tanggal ? ' ¬∑ ' + j.tanggal : '');
                    sel.appendChild(opt);
                });
            if (current && sel.querySelector('option[value="' + current + '"]')) sel.value = current;
        };

        // listenForActiveSesi: stub kompatibilitas ‚Äî sesi kini otomatis dari jadwal
        window.listenForActiveSesi = function() {
            if (window._syncSesiFromJadwal) window._syncSesiFromJadwal();
        };

        window.listenForJadwal = function() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'jadwal_ujian'));
            onSnapshot(q, (snapshot) => {
                window.allJadwalDB = [];
                snapshot.forEach(d => window.allJadwalDB.push({ id: d.id, ...d.data() }));
                // Sort: tanggal asc, jamMulai asc
                window.allJadwalDB.sort((a,b) => {
                    if (a.tanggal !== b.tanggal) return a.tanggal > b.tanggal ? 1 : -1;
                    return a.jamMulai > b.jamMulai ? 1 : -1;
                });
                window.renderJadwalList();
                window.updateJadwalTanggalFilter();
                // Update tampilan token di panel pengawas setiap kali status jadwal berubah
                if (window.updatePengawasTokenDisplay) window.updatePengawasTokenDisplay();
                // Sync currentSesiId dari jadwal aktif
                if (window._syncSesiFromJadwal) window._syncSesiFromJadwal();
            });
        };

        // Tambah jadwal baru
        window.tambahJadwal = async function() {
            if (!window.isFirebaseReady) return alert('Mode Offline ‚Äî tidak bisa menyimpan jadwal.');
            const nama     = document.getElementById('jdwl-nama').value.trim();
            const tanggal  = document.getElementById('jdwl-tanggal').value;
            const mulai    = document.getElementById('jdwl-mulai').value;
            const selesai  = document.getElementById('jdwl-selesai').value;
            const paket    = document.getElementById('jdwl-paket').value.trim();
            const paketId  = document.getElementById('jdwl-paket-id').value.trim();
            const token    = document.getElementById('jdwl-token').value.trim();
            const durasi   = document.getElementById('jdwl-durasi').value;
            const kelasStr = document.getElementById('jdwl-kelas').value.trim();
            // Array kelas dari paket
            let kelasArr = [];
            try { kelasArr = JSON.parse(document.getElementById('jdwl-kelas-arr').value || '[]'); } catch(e) {}

            if (!paket)   return alert('Pilih paket soal terlebih dahulu!');
            if (!nama)    return alert('Nama sesi tidak boleh kosong!');
            if (!tanggal) return alert('Tanggal harus dipilih!');
            if (!mulai)   return alert('Jam mulai harus diisi!');
            if (!selesai) return alert('Jam selesai harus diisi!');
            if (mulai >= selesai) return alert('Jam selesai harus lebih besar dari jam mulai!');

            try {
                await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'jadwal_ujian'), {
                    nama, tanggal, jamMulai: mulai, jamSelesai: selesai,
                    paket, paketId: paketId || '',
                    kelas: kelasStr, kelasArr: kelasArr,   // simpan keduanya
                    tokenCustom: token || '',
                    durasiCustom: durasi ? parseInt(durasi) : 0,
                    isActive: false, sudahDijalankan: false,
                    createdAt: Date.now()
                });
                // Reset form
                document.getElementById('jdwl-paket').value = '';
                document.getElementById('jdwl-paket-id').value = '';
                document.getElementById('jdwl-kelas').value = '';
                document.getElementById('jdwl-kelas-arr').value = '';
                document.getElementById('jdwl-nama').value = '';
                document.getElementById('jdwl-token').value = '';
                document.getElementById('jdwl-durasi').value = '';
                const ki = document.getElementById('jdwl-kelas-info');
                if (ki) ki.innerHTML = 'Pilih paket soal terlebih dahulu...';
                const hint = document.getElementById('jdwl-token-hint');
                if (hint) hint.textContent = '(otomatis dari paket)';
                alert(`‚úÖ Jadwal "${nama}" berhasil disimpan!\n\nOtomatis aktif: ${tanggal} pukul ${mulai}\nOtomatis mati: pukul ${selesai}`);
            } catch(e) { alert('Gagal menyimpan: ' + e.message); }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // KOREKSI SOAL ESAI
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let _keCurrentResultId = null;
        let _keEssayData = {}; // { qId: {...} }
        let _keScoreMC = 0;
        let _keNilaiMaks = 100;

        window.openKoreksiEssay = function(resultId) {
            const item = dashboardData.find(x => x.id === resultId);
            if (!item) return alert('Data tidak ditemukan.');
            if (!item.essayAnswers || Object.keys(item.essayAnswers).length === 0) return alert('Tidak ada soal esai pada data ini.');

            _keCurrentResultId = resultId;
            _keEssayData = JSON.parse(JSON.stringify(item.essayAnswers)); // deep copy
            _keScoreMC = item.scoreNonEssay || item.score || 0;
            const paket = (window.allPaketDB || []).find(p => p.id === item.paketId);
            _keNilaiMaks = (paket && paket.nilaiMaksimal > 0) ? paket.nilaiMaksimal : 100;

            document.getElementById('ke-student-name').textContent = item.studentName || '‚Äî';
            document.getElementById('ke-score-mc').textContent = _keScoreMC;
            window._keUpdateScoreSummary();
            window._keRenderQuestions();

            document.getElementById('modal-koreksi-essay').classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closeKoreksiEssay = function() {
            document.getElementById('modal-koreksi-essay').classList.add('hidden');
        };

        window._keUpdateScoreSummary = function() {
            let essayTotal = 0;
            Object.values(_keEssayData).forEach(e => {
                const skor = e.skorGuru !== null && e.skorGuru !== undefined ? e.skorGuru : (e.skorAI !== null ? e.skorAI : 0);
                essayTotal += Number(skor) || 0;
            });

            // Hitung total skor esai dalam skala poin
            const totalRawEssay = essayTotal;
            // Total skor gabungan (MC + esai proporsional)
            const totalEssaySkorMaks = Object.values(_keEssayData).reduce((s, e) => s + (e.skorMaks || 10), 0);
            const qTotal = (window.allQuestionsDB || []).filter(q => q.paketId === (_keCurrentResultId && (dashboardData.find(x=>x.id===_keCurrentResultId)||{}).paketId)).length;
            // Tampilkan skor esai raw
            document.getElementById('ke-score-essay').textContent = totalRawEssay.toFixed(1);
            // Hitung total final (proporsional dari nilaiMaksimal)
            // Ini simplified: MC skor sudah dalam skala final, tambah esai proporsional
            const essayRatio = totalEssaySkorMaks > 0 ? (totalRawEssay / totalEssaySkorMaks) : 0;
            const essayContrib = Math.round(essayRatio * _keNilaiMaks * (Object.keys(_keEssayData).length / Math.max(1, qTotal || Object.keys(_keEssayData).length)));
            const total = Math.min(_keNilaiMaks, _keScoreMC + essayContrib);
            document.getElementById('ke-score-total').textContent = total;
        };

        window._keRenderQuestions = function() {
            const container = document.getElementById('ke-questions-list');
            let html = '';
            let qNum = 1;
            Object.entries(_keEssayData).forEach(([qId, e]) => {
                const skorFinal = e.skorGuru !== null && e.skorGuru !== undefined ? e.skorGuru : (e.skorAI !== null ? e.skorAI : '');
                const statusColor = e.status === 'dikoreksi' ? 'border-green-300 bg-green-50' : e.status === 'ai_done' ? 'border-purple-200 bg-purple-50' : 'border-gray-200 bg-white';

                html += `
                <div class="rounded-xl border-2 ${statusColor} overflow-hidden" id="ke-card-${qId}">
                    <div class="px-4 py-3 border-b bg-gray-50 flex items-center justify-between gap-3">
                        <div class="flex items-center gap-2">
                            <span class="bg-purple-600 text-white text-xs font-black px-2 py-0.5 rounded-full">Esai ${qNum}</span>
                            <span class="text-xs font-semibold text-gray-600">Skor maks: ${e.skorMaks || 10}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${e.status === 'dikoreksi' ? '<span class="text-xs text-green-600 font-bold flex items-center gap-1"><i data-lucide="check-circle" class="w-3.5 h-3.5"></i> Selesai</span>' : e.status === 'ai_done' ? '<span class="text-xs text-purple-600 font-bold flex items-center gap-1"><i data-lucide="sparkles" class="w-3.5 h-3.5"></i> AI Selesai</span>' : '<span class="text-xs text-amber-600 font-bold flex items-center gap-1"><i data-lucide="clock" class="w-3.5 h-3.5"></i> Pending</span>'}
                            <button onclick="window.koreksiAISatu('${qId}')" class="text-purple-600 hover:bg-purple-100 px-2 py-1 rounded-lg text-xs font-bold border border-purple-200 flex items-center gap-1 transition-all" id="ke-ai-btn-${qId}">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> AI
                            </button>
                        </div>
                    </div>
                    <div class="p-4 space-y-3">
                        <div>
                            <p class="text-xs font-bold text-gray-500 uppercase mb-1.5">Soal</p>
                            <p class="text-sm text-gray-800 leading-relaxed">${e.qText || '‚Äî'}</p>
                        </div>
                        <div class="bg-blue-50 rounded-xl p-3 border border-blue-100">
                            <p class="text-xs font-bold text-blue-600 uppercase mb-1.5">Kunci / Rubrik Guru</p>
                            <p class="text-sm text-blue-900 leading-relaxed whitespace-pre-line">${e.rubrik || '‚Äî'}</p>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-3 border">
                            <p class="text-xs font-bold text-gray-500 uppercase mb-1.5">Jawaban Siswa</p>
                            <p class="text-sm text-gray-800 leading-relaxed whitespace-pre-line">${e.jawabanSiswa || '<em class="text-gray-400">Tidak dijawab</em>'}</p>
                        </div>
                        ${e.komentarAI ? `<div class="bg-purple-50 rounded-xl p-3 border border-purple-100">
                            <p class="text-xs font-bold text-purple-600 uppercase mb-1.5 flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> Analisis AI</p>
                            <p class="text-sm text-purple-900 leading-relaxed">${e.komentarAI}</p>
                        </div>` : ''}
                        <div class="flex items-center gap-3 pt-1 flex-wrap">
                            <label class="text-xs font-bold text-gray-600">Skor AI:</label>
                            <span class="text-sm font-bold text-purple-600 w-10">${e.skorAI !== null && e.skorAI !== undefined ? e.skorAI : '‚Äî'}</span>
                            <label class="text-xs font-bold text-gray-600">Override Guru:</label>
                            <input type="number" min="0" max="${e.skorMaks || 10}" step="0.5" value="${e.skorGuru !== null && e.skorGuru !== undefined ? e.skorGuru : ''}"
                                class="w-20 px-2 py-1.5 border-2 border-gray-200 focus:border-green-400 rounded-lg text-sm font-bold text-green-700 outline-none"
                                placeholder="0‚Äì${e.skorMaks || 10}"
                                oninput="window._keUpdateGuru('${qId}', this.value)"
                                id="ke-guru-input-${qId}">
                            <span class="text-xs text-gray-400">/ ${e.skorMaks || 10}</span>
                            <span class="ml-auto text-sm font-black ${skorFinal !== '' && Number(skorFinal) >= (e.skorMaks||10)*0.6 ? 'text-green-600' : 'text-amber-600'}">
                                Final: <span id="ke-final-${qId}">${skorFinal !== '' ? Number(skorFinal).toFixed(1) : '‚Äî'}</span>
                            </span>
                        </div>
                    </div>
                </div>`;
                qNum++;
            });
            container.innerHTML = html || '<p class="text-center text-gray-400 py-8">Tidak ada soal esai.</p>';
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window._keUpdateGuru = function(qId, val) {
            const numVal = val === '' ? null : parseFloat(val);
            if (_keEssayData[qId]) {
                _keEssayData[qId].skorGuru = numVal;
                _keEssayData[qId].status = 'dikoreksi';
                const finalEl = document.getElementById('ke-final-' + qId);
                if (finalEl) finalEl.textContent = numVal !== null ? Number(numVal).toFixed(1) : '‚Äî';
            }
            window._keUpdateScoreSummary();
        };

        // ‚îÄ‚îÄ INTEGRITES AI ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Mesin koreksi esai mandiri tanpa API eksternal.
        // Algoritma: keyword matching (bobot 70%) + panjang jawaban (bobot 30%)
        // Threshold skor penuh: 60% kata kunci rubrik ditemukan di jawaban siswa.
        window._integritesAI = function(rubrik, jawabanSiswa, skorMaks) {
            skorMaks = parseFloat(skorMaks) || 10;

            const jawaban = (jawabanSiswa || '').trim();
            if (!jawaban || jawaban === '(tidak dijawab)') {
                return { skor: 0, komentar: 'Siswa tidak memberikan jawaban.' };
            }

            function tokenize(text) {
                return text
                    .toLowerCase()
                    .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?'"]/g, ' ')
                    .split(/\s+/)
                    .filter(w => w.length > 2);
            }

            const STOPWORDS = new Set([
                'dan','atau','yang','di','ke','dari','untuk','dengan','ini','itu',
                'adalah','ada','pada','oleh','dalam','juga','sudah','belum','akan',
                'bisa','dapat','harus','perlu','saat','jika','maka','agar','karena',
                'namun','tetapi','tapi','sehingga','setelah','sebelum','ketika',
                'bahwa','seperti','antara','bagi','secara','lebih','sangat','yaitu',
                'tersebut','mereka','kami','kita','saya','kamu','dia','nya','pun',
                'hal','cara','jenis','setiap','semua','salah','satu','dua','tiga'
            ]);

            function extractKeywords(text) {
                return tokenize(text).filter(w => !STOPWORDS.has(w));
            }

            const rubrikTokens  = extractKeywords(rubrik);
            const jawabanTokens = extractKeywords(jawaban);
            const jawabanSet    = new Set(jawabanTokens);

            if (rubrikTokens.length === 0) {
                const panjangSkor = Math.min(1, jawaban.length / 200);
                const skor = parseFloat((panjangSkor * skorMaks).toFixed(1));
                return { skor, komentar: 'Rubrik tidak memiliki kata kunci spesifik. Skor diberikan berdasarkan kelengkapan jawaban.' };
            }

            let matched = 0;
            const matchedWords = [];
            const missedWords  = [];

            rubrikTokens.forEach(kw => {
                const exactMatch   = jawabanSet.has(kw);
                const partialMatch = !exactMatch && jawabanTokens.some(jw =>
                    jw.includes(kw) || kw.includes(jw)
                );
                if (exactMatch || partialMatch) {
                    matched++;
                    matchedWords.push(kw);
                } else {
                    missedWords.push(kw);
                }
            });

            const matchRatio  = matched / rubrikTokens.length;
            const THRESHOLD   = 0.6;
            const keywordScore = Math.min(1, matchRatio / THRESHOLD);
            const idealLen    = Math.max(100, rubrik.length * 1.2);
            const lengthScore = Math.min(1, jawaban.length / idealLen);
            const combined    = (keywordScore * 0.70) + (lengthScore * 0.30);
            const skor        = parseFloat((combined * skorMaks).toFixed(1));

            const persen = Math.round(matchRatio * 100);
            let komentar = '';

            if (matchRatio >= 0.8) {
                komentar = `Jawaban sangat baik! ${persen}% kata kunci rubrik ditemukan (${matchedWords.slice(0,4).join(', ')}${matchedWords.length > 4 ? ', ...' : ''}).`;
            } else if (matchRatio >= 0.6) {
                komentar = `Jawaban cukup baik. ${persen}% kata kunci rubrik terpenuhi.`;
                if (missedWords.length > 0) komentar += ` Kurang: ${missedWords.slice(0,3).join(', ')}.`;
            } else if (matchRatio >= 0.3) {
                komentar = `Jawaban kurang lengkap. Hanya ${persen}% kata kunci terpenuhi.`;
                if (missedWords.length > 0) komentar += ` Kata kunci yang terlewat: ${missedWords.slice(0,4).join(', ')}.`;
            } else {
                komentar = `Jawaban belum menjawab inti soal. Hanya ${persen}% kata kunci rubrik ditemukan.`;
                if (missedWords.length > 0) komentar += ` Perlu membahas: ${missedWords.slice(0,4).join(', ')}.`;
            }

            if (lengthScore < 0.4) komentar += ' Jawaban terlalu singkat.';
            else if (lengthScore >= 1.0) komentar += ' Jawaban cukup panjang dan detail.';

            return { skor, komentar };
        };
        // ‚îÄ‚îÄ END INTEGRITES AI ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        window.koreksiAISatu = async function(qId) {
            const e = _keEssayData[qId];
            if (!e) return;
            const btn = document.getElementById('ke-ai-btn-' + qId);
            if (btn) { btn.disabled = true; btn.innerHTML = '<svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Menilai...'; }

            try {
                const result = window._integritesAI(
                    e.rubrik       || '',
                    e.jawabanSiswa || '',
                    e.skorMaks     || 10
                );
                _keEssayData[qId].skorAI    = result.skor;
                _keEssayData[qId].komentarAI = result.komentar;
                _keEssayData[qId].status     = 'ai_done';
            } catch(err) {
                _keEssayData[qId].komentarAI = 'Gagal koreksi: ' + (err.message || 'error');
                _keEssayData[qId].skorAI = 0;
                _keEssayData[qId].status = 'ai_done';
            }

            window._keRenderQuestions();
            window._keUpdateScoreSummary();
        };

        window.koreksiAISemua = async function() {
            const btn = document.getElementById('ke-btn-ai');
            if (btn) { btn.disabled = true; btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Memproses...'; }
            for (const qId of Object.keys(_keEssayData)) {
                await window.koreksiAISatu(qId);
            }
            if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> Koreksi Semua dengan AI'; if (typeof lucide !== 'undefined') lucide.createIcons(); }
        };

        window.simpanKoreksiEssay = async function() {
            if (!_keCurrentResultId || !window.isFirebaseReady) return alert('Tidak bisa menyimpan.');

            // Hitung total skor esai
            let essayTotalSkor = 0;
            let totalEssaySkorMaks = 0;
            Object.values(_keEssayData).forEach(e => {
                const skor = e.skorGuru !== null && e.skorGuru !== undefined ? e.skorGuru : (e.skorAI !== null && e.skorAI !== undefined ? e.skorAI : 0);
                essayTotalSkor += Number(skor) || 0;
                totalEssaySkorMaks += Number(e.skorMaks) || 10;
            });

            const item = dashboardData.find(x => x.id === _keCurrentResultId);
            const paket = (window.allPaketDB || []).find(p => p.id === (item || {}).paketId);
            const nilaiMaks = (paket && paket.nilaiMaksimal > 0) ? paket.nilaiMaksimal : 100;
            const totalQ = (window.allQuestionsDB || []).filter(q => q.paketId === (item || {}).paketId).length || 1;
            const essayQ = Object.keys(_keEssayData).length;

            // Proporsi esai dari total soal
            const essayRatio = totalEssaySkorMaks > 0 ? (essayTotalSkor / totalEssaySkorMaks) : 0;
            const essayContrib = Math.round(essayRatio * nilaiMaks * (essayQ / totalQ));
            const finalScore = Math.min(nilaiMaks, (_keScoreMC || 0) + essayContrib);

            try {
                await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', _keCurrentResultId), {
                    essayAnswers: _keEssayData,
                    essayPending: false,
                    essayTotalSkor: essayTotalSkor,
                    score: finalScore,
                    status: 'SELESAI',
                    updatedAt: Date.now()
                });
                window.closeKoreksiEssay();
                alert(`‚úÖ Koreksi esai disimpan!\n\nSkor pilihan: ${_keScoreMC}\nSkor esai: ${essayTotalSkor.toFixed(1)}\nNilai akhir: ${finalScore}`);
            } catch(e) { alert('Gagal menyimpan: ' + e.message); }
        };
        // ‚îÄ‚îÄ END KOREKSI ESAI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


        window.editJadwal = function(id) {
            const j = window.allJadwalDB.find(x => x.id === id);
            if (!j) return alert('Jadwal tidak ditemukan.');

            document.getElementById('edit-jdwl-id').value = id;
            document.getElementById('edit-jdwl-nama').value = j.nama || '';
            document.getElementById('edit-jdwl-tanggal').value = j.tanggal || '';
            document.getElementById('edit-jdwl-mulai').value = j.jamMulai || '';
            document.getElementById('edit-jdwl-selesai').value = j.jamSelesai || '';
            document.getElementById('edit-jdwl-token').value = j.tokenCustom || '';
            document.getElementById('edit-jdwl-durasi').value = j.durasiCustom || '';
            document.getElementById('edit-jdwl-kelas').value = j.kelas || '';
            document.getElementById('edit-jdwl-kelas-arr').value = JSON.stringify(j.kelasArr || []);

            // Populate paket dropdown
            const sel = document.getElementById('edit-jdwl-paket');
            sel.innerHTML = '<option value="">‚Äî Pilih Paket Soal ‚Äî</option>';
            (window.allPaketDB || []).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.nama || '';
                opt.dataset.id = p.id;
                opt.dataset.token = p.token || '';
                opt.dataset.durasi = p.durasi || '';
                opt.dataset.kelas = JSON.stringify(p.kelas || []);
                opt.textContent = p.nama + (p.jenis && p.jenis !== 'nonpaket' ? ` (Paket ${p.jenis})` : '');
                if (p.id === j.paketId || p.nama === j.paket) opt.selected = true;
                sel.appendChild(opt);
            });
            document.getElementById('edit-jdwl-paket-id').value = j.paketId || '';

            // Populate kelas info from saved data
            const kelasArrJ = j.kelasArr && j.kelasArr.length ? j.kelasArr : (j.kelas ? [j.kelas] : []);
            const ki = document.getElementById('edit-jdwl-kelas-info');
            if (kelasArrJ.length) {
                ki.innerHTML = kelasArrJ.map(k => `<span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-bold text-xs">${k}</span>`).join('');
            } else {
                ki.innerHTML = '<span class="text-gray-400 italic text-xs">Tidak ada kelas</span>';
            }

            document.getElementById('modal-edit-jadwal').classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closeEditJadwal = function() {
            document.getElementById('modal-edit-jadwal').classList.add('hidden');
        };

        window.onEditJadwalPaketChange = function() {
            const sel = document.getElementById('edit-jdwl-paket');
            const opt = sel.options[sel.selectedIndex];
            if (!opt || !opt.value) return;

            const paketId = opt.dataset.id || '';
            const token   = opt.dataset.token || '';
            const durasi  = opt.dataset.durasi || '';
            let kelasArr  = [];
            try { kelasArr = JSON.parse(opt.dataset.kelas || '[]'); } catch(e) {}

            document.getElementById('edit-jdwl-paket-id').value = paketId;
            document.getElementById('edit-jdwl-token').value = token;
            document.getElementById('edit-jdwl-durasi').value = durasi;
            document.getElementById('edit-jdwl-kelas').value = kelasArr.join(', ');
            document.getElementById('edit-jdwl-kelas-arr').value = JSON.stringify(kelasArr);

            const ki = document.getElementById('edit-jdwl-kelas-info');
            if (kelasArr.length) {
                ki.innerHTML = kelasArr.map(k => `<span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-bold text-xs">${k}</span>`).join('');
                ki.className = 'w-full px-3 py-2 border border-dashed border-gray-300 rounded-lg text-sm bg-gray-50 min-h-[38px] flex items-center flex-wrap gap-1';
            } else {
                ki.innerHTML = '<span class="text-gray-400 italic text-xs">Tidak ada kelas terdaftar di paket ini</span>';
            }

            // Auto-fill nama sesi jika masih default
            const namaEl = document.getElementById('edit-jdwl-nama');
            if (!namaEl.value || namaEl.value.startsWith('Sesi')) {
                const paketNama = opt.value;
                namaEl.value = `Sesi ${paketNama}`;
            }
        };

        window.simpanEditJadwal = async function() {
            if (!window.isFirebaseReady) return alert('Mode Offline ‚Äî tidak bisa menyimpan.');
            const id      = document.getElementById('edit-jdwl-id').value;
            const nama    = document.getElementById('edit-jdwl-nama').value.trim();
            const tanggal = document.getElementById('edit-jdwl-tanggal').value;
            const mulai   = document.getElementById('edit-jdwl-mulai').value;
            const selesai = document.getElementById('edit-jdwl-selesai').value;
            const paket   = document.getElementById('edit-jdwl-paket').value.trim();
            const paketId = document.getElementById('edit-jdwl-paket-id').value.trim();
            const token   = document.getElementById('edit-jdwl-token').value.trim();
            const durasi  = document.getElementById('edit-jdwl-durasi').value;
            const kelasStr = document.getElementById('edit-jdwl-kelas').value.trim();
            let kelasArr = [];
            try { kelasArr = JSON.parse(document.getElementById('edit-jdwl-kelas-arr').value || '[]'); } catch(e) {}

            if (!paket)   return alert('Pilih paket soal!');
            if (!nama)    return alert('Nama sesi tidak boleh kosong!');
            if (!tanggal) return alert('Tanggal harus dipilih!');
            if (!mulai)   return alert('Jam mulai harus diisi!');
            if (!selesai) return alert('Jam selesai harus diisi!');
            if (mulai >= selesai) return alert('Jam selesai harus lebih besar dari jam mulai!');

            try {
                await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'jadwal_ujian', id), {
                    nama, tanggal, jamMulai: mulai, jamSelesai: selesai,
                    paket, paketId: paketId || '',
                    kelas: kelasStr, kelasArr: kelasArr,
                    tokenCustom: token || '',
                    durasiCustom: durasi ? parseInt(durasi) : 0,
                    updatedAt: Date.now()
                });
                window.closeEditJadwal();
            } catch(e) { alert('Gagal menyimpan: ' + e.message); }
        };

        // Hapus jadwal
        window.hapusJadwal = async function(id, nama) {
            if (!confirm(`Hapus jadwal "${nama}"?\n\nJika jadwal sedang aktif, sesi akan tetap aktif sampai Anda menonaktifkan secara manual.`)) return;
            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'jadwal_ujian', id));
            } catch(e) { alert('Gagal hapus: ' + e.message); }
        };

        // Toggle aktif/nonaktif manual
        window.toggleJadwalManual = async function(id, currentState, nama) {
            if (!window.isFirebaseReady) return alert('Mode Offline.');
            const action = currentState ? 'Nonaktifkan' : 'Aktifkan';
            if (!confirm(`${action} jadwal "${nama}" secara manual?`)) return;
            try {
                if (!currentState) {
                    // Aktifkan: nonaktifkan semua sesi ujian dulu, lalu aktifkan jadwal ini
                    const j = window.allJadwalDB.find(x => x.id === id);
                    if (j) await window._aktifkanJadwal(j, true);
                } else {
                    await window._nonaktifkanJadwal(id);
                }
            } catch(e) { alert('Gagal: ' + e.message); }
        };

        // Internal: aktifkan sesi berdasarkan jadwal
        window._aktifkanJadwal = async function(jadwal, manual = false) {
            if (!window.isFirebaseReady || !window.db) return;
            try {
                // Buat sesi baru khusus untuk jadwal ini (TIDAK nonaktifkan sesi lain)
                // Sehingga banyak jadwal bisa aktif bersamaan di jam yang sama (beda kelas/mapel)
                const docRef = await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'sesi_ujian'), {
                    nama: jadwal.nama,
                    keterangan: [jadwal.paket, (jadwal.kelasArr && jadwal.kelasArr.length ? jadwal.kelasArr.join(', ') : jadwal.kelas)].filter(Boolean).join(' ¬∑ '),
                    jadwalId: jadwal.id,   // referensi ke jadwal
                    paketId:  jadwal.paketId || '',
                    isActive: true,
                    createdAt: Date.now()
                });

                // Update token custom jika ada (per-jadwal, tidak global)
                // Token disimpan di jadwal itu sendiri, bukan overwrite global

                // Update durasi jika ada custom durasi
                if (jadwal.durasiCustom && jadwal.durasiCustom > 0) {
                    window.currentExamDuration = jadwal.durasiCustom;
                }

                // Tandai jadwal sudah dijalankan & aktif
                await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'jadwal_ujian', jadwal.id), {
                    isActive: true, sudahDijalankan: true, sesiRefId: docRef.id
                });

                console.log(`[Jadwal] ‚úÖ Sesi "${jadwal.nama}" diaktifkan ${manual ? 'manual' : 'otomatis'}`);
            } catch(e) { console.error('[Jadwal] Gagal aktifkan:', e); }
        };

        // Internal: nonaktifkan sesi milik jadwal ini saja
        window._nonaktifkanJadwal = async function(jadwalId) {
            if (!window.isFirebaseReady || !window.db) return;
            try {
                const jadwal = (window.allJadwalDB || []).find(j => j.id === jadwalId);
                // Hanya nonaktifkan sesi yang terkait jadwal ini (via jadwalId atau sesiRefId)
                // Sesi ujian tidak lagi dikelola manual - jadwal langsung jadi acuan
                // Update jadwal
                if (jadwal) {
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'jadwal_ujian', jadwalId), {
                        isActive: false
                    });
                }
                console.log(`[Jadwal] üî¥ Jadwal "${jadwal ? jadwal.nama : jadwalId}" dinonaktifkan`);
            } catch(e) { console.error('[Jadwal] Gagal nonaktifkan:', e); }
        };

        // ‚îÄ‚îÄ SCHEDULER ‚Äî dicek tiap menit ‚îÄ‚îÄ
        window.startJadwalScheduler = function() {
            if (window._jadwalSchedulerTimer) clearInterval(window._jadwalSchedulerTimer);
            const check = () => {
                if (!window.isAdmin || !window.isAdmin()) return; // hanya admin yang menjalankan scheduler
                if (!window.allJadwalDB || !window.isFirebaseReady) return;

                const now = new Date();
                const todayStr = now.toISOString().slice(0,10); // YYYY-MM-DD
                const timeStr  = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0'); // HH:MM

                window.allJadwalDB.forEach(async j => {
                    if (j.tanggal !== todayStr) return; // bukan hari ini

                    const tepat_mulai = (timeStr === j.jamMulai);
                    const sudah_lewat_selesai = (timeStr > j.jamSelesai);
                    const sedang_berjalan = (timeStr >= j.jamMulai && timeStr <= j.jamSelesai);

                    // Aktifkan tepat pada jam mulai
                    if (tepat_mulai && !j.isActive) {
                        await window._aktifkanJadwal(j);
                        return;
                    }

                    // Nonaktifkan saat melewati jam selesai
                    if (sudah_lewat_selesai && j.isActive) {
                        await window._nonaktifkanJadwal(j.id);
                        return;
                    }
                });
            };
            check(); // cek langsung saat mulai
            window._jadwalSchedulerTimer = setInterval(check, 60000); // cek tiap menit
            console.log('[Jadwal] Scheduler dimulai, cek tiap menit.');
        };

        // Render list jadwal
        window.renderJadwalList = function() {
            const container = document.getElementById('jadwal-list-container');
            if (!container) return;

            const filterEl = document.getElementById('jdwl-filter-tanggal');
            const filterVal = filterEl ? filterEl.value : 'all';

            let list = window.allJadwalDB;
            if (filterVal && filterVal !== 'all') {
                list = list.filter(j => j.tanggal === filterVal);
            }

            if (list.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400 text-center py-8 bg-gray-50 rounded-xl border border-dashed">Belum ada jadwal. Tambah jadwal di atas.</p>';
                return;
            }

            // Group by tanggal
            const groups = {};
            list.forEach(j => {
                if (!groups[j.tanggal]) groups[j.tanggal] = [];
                groups[j.tanggal].push(j);
            });

            const now = new Date();
            const todayStr = now.toISOString().slice(0,10);
            const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');

            container.innerHTML = Object.entries(groups).map(([tgl, jadwals]) => {
                const d = new Date(tgl + 'T00:00:00');
                const hariNama = d.toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
                const isToday = tgl === todayStr;

                const rows = jadwals.map(j => {
                    const sudahLewat = tgl < todayStr || (isToday && timeStr > j.jamSelesai);
                    const sedangAktif = j.isActive || (isToday && timeStr >= j.jamMulai && timeStr <= j.jamSelesai);
                    const belumMulai = !sudahLewat && !sedangAktif;

                    let statusBadge = '';
                    if (j.isActive || sedangAktif) {
                        statusBadge = '<span class="shrink-0 bg-green-600 text-white text-[10px] font-black px-2 py-0.5 rounded-full uppercase tracking-wide animate-pulse">‚ö° Aktif</span>';
                    } else if (sudahLewat) {
                        statusBadge = '<span class="shrink-0 bg-gray-300 text-gray-600 text-[10px] font-black px-2 py-0.5 rounded-full uppercase tracking-wide">‚úì Selesai</span>';
                    } else {
                        statusBadge = '<span class="shrink-0 bg-amber-100 text-amber-700 text-[10px] font-black px-2 py-0.5 rounded-full uppercase tracking-wide">‚è≥ Menunggu</span>';
                    }

                    // Kelas dari array (lebih akurat) atau fallback ke string
                    const kelasArrJ = j.kelasArr && j.kelasArr.length ? j.kelasArr : (j.kelas ? [j.kelas] : []);
                    const kelasBadges = kelasArrJ.length
                        ? kelasArrJ.map(k => `<span class="bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded text-[10px] font-bold">${k}</span>`).join(' ')
                        : '<span class="text-[10px] text-gray-400">Semua kelas</span>';
                    const paketInfo = j.paket ? `<span class="text-xs font-medium text-gray-600">${j.paket}</span>` : '';
                    const tokenInfo = j.tokenCustom ? `<span class="text-xs text-indigo-600 font-mono">Token: ${j.tokenCustom}</span>` : '';
                    const durasiInfo = j.durasiCustom ? `<span class="text-xs text-gray-400">${j.durasiCustom} mnt</span>` : '';

                    return `
                    <div class="flex items-center gap-3 p-4 rounded-xl border ${j.isActive ? 'bg-green-50 border-green-300' : sudahLewat ? 'bg-gray-50 border-gray-200 opacity-70' : 'bg-white border-gray-200'}">
                        <div class="flex flex-col items-center justify-center bg-violet-100 text-violet-700 rounded-xl p-2.5 text-xs font-black shrink-0 w-16 text-center leading-tight">
                            <span>${j.jamMulai}</span>
                            <span class="text-gray-400 font-normal">‚Üì</span>
                            <span>${j.jamSelesai}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="font-bold text-sm text-gray-800">${j.nama}</span>
                                ${statusBadge}
                            </div>
                            <div class="flex items-center gap-2 mt-0.5 flex-wrap">
                                ${paketInfo || kelasBadges ? `<div class="flex items-center gap-1.5 flex-wrap mt-0.5">${paketInfo}${paketInfo && kelasBadges ? '<span class="text-gray-300">¬∑</span>' : ''}${kelasBadges}</div>` : ''}
                                ${tokenInfo}
                                ${durasiInfo}
                            </div>
                        </div>
                        <div class="flex gap-1.5 shrink-0">
                            ${!sudahLewat ? `<button onclick="window.toggleJadwalManual('${j.id}',${!!j.isActive},'${j.nama.replace(/'/g,"\\'")}') " title="${j.isActive ? 'Nonaktifkan' : 'Aktifkan'} manual" class="text-xs font-bold ${j.isActive ? 'text-red-600 hover:bg-red-50 border-red-200' : 'text-green-600 hover:bg-green-50 border-green-200'} border px-3 py-1.5 rounded-lg transition-colors">${j.isActive ? '‚èπ Stop' : '‚ñ∂ Mulai'}</button>` : ''}
                            <button onclick="window.editJadwal('${j.id}')" title="Edit jadwal" class="text-violet-500 hover:bg-violet-50 p-1.5 rounded-lg transition-colors border border-transparent hover:border-violet-200"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button onclick="window.hapusJadwal('${j.id}','${j.nama.replace(/'/g,"\\'")}') " title="Hapus jadwal" class="text-red-400 hover:bg-red-50 p-1.5 rounded-lg transition-colors border border-transparent hover:border-red-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                }).join('');

                return `
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-bold text-sm ${isToday ? 'text-violet-700' : 'text-gray-600'}">${hariNama}</span>
                        ${isToday ? '<span class="text-[10px] bg-violet-600 text-white px-2 py-0.5 rounded-full font-bold">HARI INI</span>' : ''}
                    </div>
                    <div class="space-y-2 ml-1 pl-3 border-l-2 ${isToday ? 'border-violet-300' : 'border-gray-200'}">
                        ${rows}
                    </div>
                </div>`;
            }).join('');

            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        // Update filter tanggal dropdown
        window.updateJadwalTanggalFilter = function() {
            const sel = document.getElementById('jdwl-filter-tanggal');
            if (!sel) return;
            const cur = sel.value;
            sel.innerHTML = '<option value="all">Semua Tanggal</option>';
            const datesSet = new Set(window.allJadwalDB.map(j => j.tanggal));
            [...datesSet].sort().forEach(tgl => {
                const opt = document.createElement('option');
                opt.value = tgl;
                const d = new Date(tgl + 'T00:00:00');
                opt.textContent = d.toLocaleDateString('id-ID', { weekday:'short', day:'numeric', month:'short' });
                sel.appendChild(opt);
            });
            if (cur) sel.value = cur;
        };

        // ‚îÄ‚îÄ Populate dropdown paket dari database (kelas tidak perlu dropdown lagi) ‚îÄ‚îÄ
        window.populateJadwalDropdowns = function() {
            const selPaket = document.getElementById('jdwl-paket');
            if (selPaket) {
                const cur = selPaket.value;
                selPaket.innerHTML = '<option value="">‚Äî Pilih Paket Soal ‚Äî</option>';
                (window.allPaketDB || []).forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.nama;
                    opt.dataset.paketId  = p.id;
                    opt.dataset.token    = p.token || window.currentExamToken || '';
                    opt.dataset.durasi   = p.durasi || p.duration || '';
                    // Simpan kelas sebagai JSON string di dataset
                    opt.dataset.kelasArr = JSON.stringify(p.kelas || []);
                    opt.dataset.mapel    = p.mapel || '';
                    const kelasTxt = (p.kelas && p.kelas.length) ? ` [${p.kelas.join(', ')}]` : '';
                    opt.textContent = p.nama + (p.jenis && p.jenis !== 'nonpaket' ? ` (Paket ${p.jenis})` : '') + kelasTxt;
                    selPaket.appendChild(opt);
                });
                if (cur) selPaket.value = cur;
            }
        };

        // Tidak lagi dibutuhkan, tapi dijaga agar tidak error jika dipanggil
        window.onJadwalKelasChange = function() {};

        // Saat paket dipilih ‚Üí isi kelas, token, durasi, nama sesi otomatis
        window.onJadwalPaketChange = function() {
            const selPaket  = document.getElementById('jdwl-paket');
            const selOpt    = selPaket ? selPaket.options[selPaket.selectedIndex] : null;
            const tokenEl   = document.getElementById('jdwl-token');
            const durasiEl  = document.getElementById('jdwl-durasi');
            const paketIdEl = document.getElementById('jdwl-paket-id');
            const kelasEl   = document.getElementById('jdwl-kelas');
            const kelasArrEl= document.getElementById('jdwl-kelas-arr');
            const kelasInfo = document.getElementById('jdwl-kelas-info');

            if (selOpt && selOpt.value) {
                const token    = selOpt.dataset.token    || window.currentExamToken || '';
                const durasi   = selOpt.dataset.durasi   || '';
                const pid      = selOpt.dataset.paketId  || '';
                const kelasArr = JSON.parse(selOpt.dataset.kelasArr || '[]');

                if (tokenEl)    { tokenEl.value  = token; }
                if (durasiEl)   { durasiEl.value = durasi; }
                if (paketIdEl)  { paketIdEl.value = pid; }
                if (kelasEl)    { kelasEl.value   = kelasArr.join(', '); }
                if (kelasArrEl) { kelasArrEl.value = JSON.stringify(kelasArr); }

                // Tampilkan kelas sebagai badge-badge
                if (kelasInfo) {
                    if (kelasArr.length > 0) {
                        kelasInfo.innerHTML = kelasArr.map(k =>
                            `<span class="bg-indigo-100 text-indigo-700 px-2.5 py-0.5 rounded-lg text-xs font-bold">${k}</span>`
                        ).join('');
                        kelasInfo.classList.remove('text-gray-400','italic');
                    } else {
                        kelasInfo.innerHTML = '<span class="text-gray-400 italic text-xs">Semua kelas (tidak dibatasi di paket ini)</span>';
                        kelasInfo.classList.add('text-gray-400','italic');
                    }
                }

                const hint = document.getElementById('jdwl-token-hint');
                if (hint) hint.textContent = token ? `(Token: ${token})` : '(otomatis dari paket)';
            } else {
                // Reset semua
                if (tokenEl)    { tokenEl.value  = ''; }
                if (durasiEl)   { durasiEl.value = ''; }
                if (paketIdEl)  { paketIdEl.value = ''; }
                if (kelasEl)    { kelasEl.value   = ''; }
                if (kelasArrEl) { kelasArrEl.value = ''; }
                if (kelasInfo)  { kelasInfo.innerHTML = 'Pilih paket soal terlebih dahulu...'; kelasInfo.classList.add('text-gray-400','italic'); }
                const hint = document.getElementById('jdwl-token-hint');
                if (hint) hint.textContent = '(otomatis dari paket)';
            }
            window._autoGenerateNamaSesi();
        };

        // Auto-generate nama sesi dari paket + kelas + urutan hari ini
        window._autoGenerateNamaSesi = function() {
            const paketEl  = document.getElementById('jdwl-paket');
            const paket    = paketEl ? paketEl.value : '';
            const tgl      = document.getElementById('jdwl-tanggal') ? document.getElementById('jdwl-tanggal').value : '';
            if (!paket) return;
            const countSameTgl = tgl ? (window.allJadwalDB || []).filter(j => j.tanggal === tgl).length : 0;
            const sesiKe = countSameTgl + 1;
            // Ambil kelas dari hidden field
            const kelasArr = JSON.parse((document.getElementById('jdwl-kelas-arr') || {value:'[]'}).value || '[]');
            const kelasTxt = kelasArr.length ? kelasArr.join(' & ') : '';
            const parts = [`Sesi ${sesiKe}`, paket];
            if (kelasTxt) parts.push(kelasTxt);
            const namaEl = document.getElementById('jdwl-nama');
            if (namaEl) namaEl.value = parts.join(' - ');
        };

        // Set default tanggal & populate dropdown paket
        window.initJadwalForm = function() {
            const tglInput = document.getElementById('jdwl-tanggal');
            if (tglInput) {
                if (!tglInput.value) tglInput.value = new Date().toISOString().slice(0,10);
                // Pastikan event listener tidak double
                tglInput.onchange = window._autoGenerateNamaSesi;
            }
            window.populateJadwalDropdowns();
        };
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // END JADWAL UJIAN OTOMATIS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


        // ADMIN CREDENTIALS MANAGEMENT (Firebase-based)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Seed credentials default ke Firebase (pertama kali)
        window.ensureAdminCredentials = async function() {
            if (!window.isFirebaseReady || !window.db) return;
            try {
                const snap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'admin_credentials'));
                if (snap.empty) {
                    await setDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'admin_credentials', 'main_admin'), {
                        username: 'authar', password: 'Sedayu@123',
                        displayName: 'Admin Utama', createdAt: Date.now()
                    });
                }
            } catch(e) { console.warn('ensureAdminCredentials:', e); }
        };

        // Simpan perubahan username & password admin
        window.saveAdminCredentials = async function() {
            if (!window.isFirebaseReady || !window.db) {
                alert('Fitur ini memerlukan koneksi internet (Firebase).');
                return;
            }
            const newUser    = (document.getElementById('setting-admin-user')?.value || '').trim();
            const newDisplay = (document.getElementById('setting-admin-display')?.value || '').trim();
            const oldPass    = document.getElementById('setting-admin-old-pass')?.value || '';
            const newPass    = document.getElementById('setting-admin-new-pass')?.value || '';
            const confPass   = document.getElementById('setting-admin-conf-pass')?.value || '';

            if (!newUser || newUser.length < 4) { alert('Username minimal 4 karakter!'); return; }
            if (!oldPass) { alert('Masukkan password lama untuk konfirmasi identitas!'); return; }

            // Verifikasi password lama
            let docId = null;
            try {
                const snap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'admin_credentials'));
                snap.forEach(ds => { if (ds.data().password === oldPass) docId = ds.id; });
            } catch(e) { alert('Gagal memverifikasi: ' + e.message); return; }

            if (!docId) { alert('\u274C Password lama salah! Perubahan dibatalkan.'); return; }

            // Validasi password baru (opsional ‚Äî hanya jika diisi)
            let finalPass = oldPass;
            if (newPass) {
                if (newPass.length < 6) { alert('Password baru minimal 6 karakter!'); return; }
                if (newPass !== confPass) { alert('Konfirmasi password baru tidak cocok!'); return; }
                finalPass = newPass;
            }

            try {
                await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'admin_credentials', docId), {
                    username: newUser, password: finalPass,
                    displayName: newDisplay || newUser, updatedAt: Date.now()
                });
                ['setting-admin-old-pass','setting-admin-new-pass','setting-admin-conf-pass'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.value = '';
                });
                alert('\u2705 Kredensial admin berhasil diperbarui!\n\nUsername: ' + newUser + '\nPassword: ' + (newPass ? '(diperbarui)' : '(tidak berubah)') + '\n\nGunakan data baru saat login berikutnya.');
            } catch(e) { alert('Gagal menyimpan: ' + e.message); }
        };

        // Load data kredensial ke form saat panel dibuka
        window.loadAdminCredentialFields = async function() {
            if (!window.isFirebaseReady || !window.db) return;
            try {
                const snap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'admin_credentials'));
                snap.forEach(ds => {
                    const d = ds.data();
                    const el1 = document.getElementById('setting-admin-user');
                    const el2 = document.getElementById('setting-admin-display');
                    if (el1) el1.value = d.username || '';
                    if (el2) el2.value = d.displayName || '';
                });
            } catch(e) { console.warn('loadAdminCredentialFields:', e); }
        };

                window.listenForRuang = function() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ruang_ujian'));
            onSnapshot(q, (snapshot) => {
                window.ruangList = [];
                snapshot.forEach((d) => {
                    window.ruangList.push({ id: d.id, ...d.data() });
                });
                window.ruangList.sort((a,b) => (a.nama||'').localeCompare(b.nama||''));
                window.renderRuangList();
                window.updateRuangDropdowns();
            });
        };

        window.renderRuangList = function() {
            const tbody = document.getElementById('ruang-table-body');
            if (!tbody) return;
            const pw = document.getElementById('pager-ruang-wrap');
            const total = window.ruangList.length;
            if (total === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-400">Belum ada ruang ujian. Tambah ruang baru.</td></tr>';
                if (pw) pw.innerHTML = '';
                return;
            }
            const pgR = window._pg.ruang;
            pgR.page = Math.max(1, Math.min(pgR.page, Math.ceil(total / pgR.perPage)));
            const sliceStart = (pgR.page - 1) * pgR.perPage;
            const pageItems = window.ruangList.slice(sliceStart, sliceStart + pgR.perPage);
            tbody.innerHTML = pageItems.map((r, i) => {
                const globalIdx = sliceStart + i;
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 text-sm text-gray-500">${globalIdx + 1}</td>
                    <td class="px-6 py-4 font-semibold text-gray-800">
                        <span class="inline-flex items-center gap-2">
                            <span class="w-8 h-8 bg-amber-100 text-amber-700 rounded-lg flex items-center justify-center text-xs font-black">${globalIdx + 1}</span>
                            ${r.nama}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <code class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-sm font-mono font-bold">${r.password || '‚Äî'}</code>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${r.keterangan || '-'}</td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex gap-2 justify-center">
                            <button onclick="window.openRuangModal('${r.id}')" class="text-amber-600 hover:bg-amber-50 p-2 rounded-lg" title="Edit"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="window.deleteRuang('${r.id}','${r.nama}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg" title="Hapus"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            if (pw) pw.innerHTML = renderPagerHTML('ruang', total, pgR.page, pgR.perPage);
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.updateRuangDropdowns = function() {
            const filterRuang = document.getElementById('filter-ruang');
            if (filterRuang && !filterRuang.disabled) {
                const current = filterRuang.value;
                filterRuang.innerHTML = '<option value="all">Semua Ruang</option>';
                window.ruangList.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.nama;
                    opt.textContent = r.nama;
                    filterRuang.appendChild(opt);
                });
                if (current) filterRuang.value = current;
            }
            window.updateStudentRoomDropdown();
            window.updatePengawasRoomDropdown();
            // Refresh dropdown analitik agar ikut terupdate dari data master ruang
            if (window.renderIntegrityDashboard && document.getElementById('panel-analitik') && !document.getElementById('panel-analitik').classList.contains('hidden-section')) {
                window.renderIntegrityDashboard();
            }
        };

        window.updateStudentRoomDropdown = function() {
            const sel = document.getElementById('student-room');
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">-- Pilih Ruang Ujian --</option>';
            window.ruangList.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.nama;
                opt.textContent = r.nama;
                sel.appendChild(opt);
            });
            if (current) sel.value = current;
        };

        window.openRuangModal = function(id = null) {
            const modal = document.getElementById('modal-ruang');
            document.getElementById('ruang-id').value = '';
            document.getElementById('ruang-nama').value = '';
            document.getElementById('ruang-password').value = '';
            document.getElementById('ruang-keterangan').value = '';
            if (id) {
                const r = window.ruangList.find(x => x.id === id);
                if (r) {
                    document.getElementById('ruang-id').value = r.id;
                    document.getElementById('ruang-nama').value = r.nama || '';
                    document.getElementById('ruang-password').value = r.password || '';
                    document.getElementById('ruang-keterangan').value = r.keterangan || '';
                }
            }
            modal.classList.remove('hidden');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closeRuangModal = function() {
            document.getElementById('modal-ruang').classList.add('hidden');
        };

        window.saveRuang = async function(e) {
            e.preventDefault();
            if (!window.isFirebaseReady) return alert("Mode Offline: Tidak bisa menyimpan.");
            const id   = document.getElementById('ruang-id').value;
            const nama = document.getElementById('ruang-nama').value.trim();
            const pass = document.getElementById('ruang-password').value.trim().toUpperCase();
            const ket  = document.getElementById('ruang-keterangan').value.trim();
            if (!nama) return alert("Nama ruang tidak boleh kosong!");
            if (!pass) return alert("Password pengawas tidak boleh kosong!");
            const data = { nama, password: pass, keterangan: ket, updatedAt: Date.now() };
            try {
                if (id) {
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ruang_ujian', id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'ruang_ujian'), data);
                }
                window.closeRuangModal();
            } catch(err) { alert("Gagal menyimpan: " + err.message); }
        };

        window.deleteRuang = async function(id, nama) {
            if (!confirm(`Hapus ruang "${nama}"?\n\nData siswa di ruang ini tidak akan terhapus.`)) return;
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'ruang_ujian', id));
            } catch(err) { alert("Gagal hapus: " + err.message); }
        };
        // ==================== END MANAJEMEN RUANG ====================

        window.switchLoginTab = function(type) {
            const btnStudent = document.getElementById('tab-student');
            const btnTeacher = document.getElementById('tab-teacher');
            const formStudent = document.getElementById('form-student');
            const formTeacher = document.getElementById('form-teacher');

            if (type === 'student') {
                btnStudent.className = "flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-white transition-all hover:bg-blue-50/50";
                btnTeacher.className = "flex-1 py-4 text-sm font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent transition-all hover:bg-gray-50/50";
                formStudent.classList.remove('hidden-section');
                formTeacher.classList.add('hidden-section');
            } else {
                btnStudent.className = "flex-1 py-4 text-sm font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent transition-all hover:bg-gray-50/50";
                btnTeacher.className = "flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-white transition-all hover:bg-blue-50/50";
                formStudent.classList.add('hidden-section');
                formTeacher.classList.remove('hidden-section');
            }
        };

        window.selectPacket = function(pkt) {
            // Reset styles for packet selection logic manually to match new design
            document.querySelectorAll('.pkt-btn').forEach(btn => {
                // Default unselected state
                btn.className = "pkt-btn relative w-full p-2.5 rounded-xl border transition-all duration-200 text-left bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50 text-gray-500 group";
                // Inner reset
                const title = btn.querySelector('.font-bold');
                if(title) title.className = "font-bold text-xs group-hover:text-gray-700";
                
                // Remove icon if present
                const iconDiv = btn.querySelector('.h-6');
                if(iconDiv) iconDiv.remove();
                
                // Adjust layout if it was the large A button
                if(btn.id === 'pkt-A') {
                     btn.className = "pkt-btn relative w-full p-3 rounded-xl border transition-all duration-200 text-left bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50 text-gray-500 group";
                     btn.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-bold text-xs group-hover:text-gray-700">STS PKWU - Paket A</div>
                                <div class="text-[10px] uppercase mt-0.5">Kelas XI TKJ 1</div>
                            </div>
                        </div>`;
                }
            });

            // Set Selected State
            const selectedBtn = document.getElementById('pkt-' + pkt);
            if(selectedBtn) {
                 if(pkt === 'A') {
                    selectedBtn.className = "pkt-btn relative w-full p-3 rounded-xl border-2 transition-all duration-200 text-left bg-blue-50 border-blue-600 ring-2 ring-blue-200/50 shadow-sm group";
                    selectedBtn.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-bold text-blue-700 text-sm">STS PKWU - Paket A</div>
                                <div class="text-[10px] font-semibold text-blue-500 uppercase mt-0.5">Kelas XI TKJ 1</div>
                            </div>
                            <div class="h-6 w-6 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-sm"><i data-lucide="check" class="w-3 h-3"></i></div>
                        </div>`;
                 } else {
                    selectedBtn.className = "pkt-btn relative w-full p-2.5 rounded-xl border-2 transition-all duration-200 text-left bg-blue-50 border-blue-600 text-blue-700 ring-2 ring-blue-200/50 shadow-sm group";
                    const title = selectedBtn.querySelector('.font-bold');
                    if(title) title.className = "font-bold text-xs text-blue-700";
                 }
                 
                document.getElementById('selected-packet').value = pkt;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
        };

        // --- DASHBOARD UI LOGIC ---
        window.switchDashTab = function(tab) {
            // ‚îÄ‚îÄ Role Guard: pengawas hanya boleh akses tab yang diizinkan ‚îÄ‚îÄ
            const PENGAWAS_TABS = ['nilai', 'analitik'];
            if (window.currentPengawasRuang && !PENGAWAS_TABS.includes(tab)) {
                console.warn(`[GUARD] Pengawas tidak diizinkan akses tab: ${tab}`);
                return;
            }

            // ‚îÄ‚îÄ Desktop tab styles ‚îÄ‚îÄ
            const activeClass   = "flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl bg-blue-600 text-white font-bold text-sm transition-all";
            const inactiveClass = "flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl text-gray-500 hover:bg-gray-100 font-bold text-sm transition-all";

            // ‚îÄ‚îÄ Mobile tab styles ‚îÄ‚îÄ
            const mobActive   = "flex-1 flex flex-col items-center justify-center gap-0.5 rounded-xl mx-0.5 my-1.5 transition-all duration-200 bg-blue-50 text-blue-600";
            const mobInactive = "flex-1 flex flex-col items-center justify-center gap-0.5 rounded-xl mx-0.5 my-1.5 transition-all duration-200 text-gray-400";

            const tabs   = ['welcome','nilai','kelas','soal','ruang','analitik','jadwal','tampilan'];
            const panels = { welcome:'panel-welcome', nilai:'panel-nilai', soal:'panel-soal', kelas:'panel-kelas', ruang:'panel-ruang', analitik:'panel-analitik', jadwal:'panel-jadwal', tampilan:'panel-tampilan' };
            const btnIds = { welcome:'tab-dash-welcome', nilai:'tab-dash-nilai', soal:'tab-dash-soal', kelas:'tab-dash-kelas', ruang:'tab-dash-ruang', analitik:'tab-dash-analitik', jadwal:'tab-dash-jadwal', tampilan:'tab-dash-tampilan' };
            const mobIds = { welcome:'mob-tab-welcome', nilai:'mob-tab-nilai', soal:'mob-tab-soal', kelas:'mob-tab-kelas', ruang:'mob-tab-ruang', analitik:'mob-tab-analitik', jadwal:'mob-tab-jadwal', tampilan:'mob-tab-tampilan' };

            tabs.forEach(t => {
                // Desktop tab
                const btn = document.getElementById(btnIds[t]);
                const pnl = document.getElementById(panels[t]);
                if (btn) {
                    const isAdminOnly = btn.classList.contains('admin-only-tab');
                    const isHidden    = btn.classList.contains('hidden');
                    btn.className = (t === tab ? activeClass : inactiveClass)
                        + (isAdminOnly ? ' admin-only-tab' : '')
                        + (isHidden    ? ' hidden'         : '');
                }
                // Mobile bottom nav tab
                const mobBtn = document.getElementById(mobIds[t]);
                if (mobBtn) {
                    const isAdminOnly = mobBtn.classList.contains('admin-only-tab');
                    const isHidden    = mobBtn.classList.contains('hidden');
                    mobBtn.className = (t === tab ? mobActive : mobInactive)
                        + (isAdminOnly ? ' admin-only-tab' : '')
                        + (isHidden    ? ' hidden'         : '');
                }
                if (pnl) { if (t === tab) pnl.classList.remove('hidden-section'); else pnl.classList.add('hidden-section'); }
            });

            if (tab === 'analitik') { setTimeout(() => window.renderIntegrityDashboard(), 300); }
            if (tab === 'soal') { window.backToPaketList(); window.renderPaketGrid(); }
            if (tab === 'kelas') window.renderKelasList();
            if (tab === 'ruang') window.renderRuangList();
            if (tab === 'tampilan') window.loadTampilanFields();
            if (tab === 'jadwal') { window.renderJadwalList(); window.initJadwalForm(); }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        // Toggle import section di dalam panel soal
        window.toggleImportSection = function() {
            const sec = document.getElementById('section-import-inline');
            if (!sec) return;
            const isHidden = sec.classList.contains('hidden');
            sec.classList.toggle('hidden', !isHidden);
            if (isHidden) {
                setTimeout(() => sec.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        // ==================== PAKET SOAL MANAGEMENT ====================
        window.allPaketDB = [];
        window.activePaketId = null;

        window.listenForPaket = function() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal'));
            onSnapshot(q, (snapshot) => {
                window.allPaketDB = [];
                snapshot.forEach((d) => window.allPaketDB.push({ id: d.id, ...d.data() }));
                window.allPaketDB.sort((a,b) => (a.createdAt||0) - (b.createdAt||0));
                window.renderPaketGrid();
                window.updatePaketFilter();
                if (window.activePaketId) window.refreshActivePaketInfo();
                // Update token pengawas setiap kali data paket berubah (real-time)
                if (window.isPengawas && window.isPengawas() && window.updatePengawasTokenDisplay) {
                    window.updatePengawasTokenDisplay();
                }
                // Refresh jadwal dropdown paket jika panel jadwal sedang terbuka
                if (window.populateJadwalDropdowns) window.populateJadwalDropdowns();
            });
        };

        // ‚îÄ‚îÄ Update dropdown filter paket soal di monitoring ‚îÄ‚îÄ
        window.updatePaketFilter = function() {
            const sel = document.getElementById('filter-session');
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="all">Semua Paket</option>';
            (window.allPaketDB || []).forEach(p => {
                const opt = document.createElement('option');
                // packetType di exam_results memakai field 'jenis' (A/B/C) dari paket
                opt.value = p.jenis && p.jenis !== 'nonpaket' ? p.jenis : p.nama;
                opt.textContent = p.nama + (p.jenis && p.jenis !== 'nonpaket' ? ` (Paket ${p.jenis})` : '');
                sel.appendChild(opt);
            });
            if (current) sel.value = current;
        };

        const PAKET_COLORS = [
            'bg-blue-500','bg-indigo-500','bg-purple-500','bg-pink-500',
            'bg-rose-500','bg-orange-500','bg-amber-500','bg-teal-500',
            'bg-cyan-500','bg-emerald-500','bg-green-500','bg-lime-500'
        ];

        window.renderPaketGrid = function() {
            const grid = document.getElementById('paket-grid');
            if (!grid) return;
            const total = window.allPaketDB.length;
            const info = document.getElementById('paket-count-info');
            if (info) info.textContent = `${total} paket tersedia`;

            if (total === 0) {
                grid.innerHTML = `
                    <div class="col-span-full bg-white rounded-2xl border-2 border-dashed border-gray-200 p-14 text-center">
                        <div class="inline-flex p-4 bg-indigo-50 rounded-2xl mb-4"><i data-lucide="layers" class="w-10 h-10 text-indigo-400"></i></div>
                        <h3 class="text-lg font-bold text-gray-700 mb-2">Belum Ada Paket Soal</h3>
                        <p class="text-gray-400 text-sm mb-5 max-w-xs mx-auto">Buat paket soal pertama Anda. Paket adalah wadah yang berisi kumpulan soal ujian.</p>
                        <button onclick="window.openPaketModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 mx-auto shadow-md">
                            <i data-lucide="plus" class="w-4 h-4"></i> Buat Paket Pertama
                        </button>
                    </div>`;
                const pw = document.getElementById('pager-paket-wrap');
                if (pw) pw.innerHTML = '';
                if(typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // Pagination
            const pgP = window._pg.paket;
            pgP.page = Math.max(1, Math.min(pgP.page, Math.ceil(total / pgP.perPage)));
            const sliceStart = (pgP.page - 1) * pgP.perPage;
            const pageItems = window.allPaketDB.slice(sliceStart, sliceStart + pgP.perPage);

            grid.innerHTML = pageItems.map((p, i) => {
                const globalIdx = sliceStart + i;
                const color  = PAKET_COLORS[globalIdx % PAKET_COLORS.length];
                const isAktif = p.aktif !== false;
                const soalCount = window.allQuestionsDB.filter(q => q.paketId === p.id).length;
                const kelasTags = (p.kelas && p.kelas.length > 0)
                    ? p.kelas.slice(0,3).map(k => `<span class="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-md text-xs font-medium">${k}</span>`).join('')
                      + (p.kelas.length > 3 ? `<span class="text-xs text-gray-400">+${p.kelas.length-3}</span>` : '')
                    : `<span class="text-xs text-gray-400">Semua Kelas</span>`;
                const jenisLabel = p.jenis === 'nonpaket' || !p.jenis ? 'Non Paket' : `Paket ${p.jenis}`;

                return `
                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden hover:shadow-md transition-shadow group">
                    <div class="${color} px-5 pt-5 pb-4 text-white relative">
                        <div class="flex justify-between items-start">
                            <div class="bg-white/20 w-11 h-11 rounded-xl flex items-center justify-center text-xl font-black">
                                ${p.nama.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex items-center gap-1.5">
                                <span class="${isAktif ? 'bg-white/30 text-white' : 'bg-black/20 text-white/70'} text-xs font-bold px-2.5 py-1 rounded-full">
                                    ${isAktif ? '‚óè Aktif' : '‚óã Nonaktif'}
                                </span>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="event.stopPropagation(); window.openPaketModal('${p.id}')" class="bg-white/20 hover:bg-white/30 p-1.5 rounded-lg" title="Edit"><i data-lucide="settings" class="w-3.5 h-3.5"></i></button>
                                    <button onclick="event.stopPropagation(); window.deletePaket('${p.id}','${p.nama.replace(/'/g,"\\'")}') " class="bg-white/20 hover:bg-red-400/60 p-1.5 rounded-lg" title="Hapus"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            </div>
                        </div>
                        <h4 class="text-base font-bold mt-3 leading-tight">${p.nama}</h4>
                        <p class="text-white/80 text-xs mt-0.5">${p.mapel || '‚Äî'}</p>
                    </div>
                    <div class="px-5 py-4">
                        <div class="flex flex-wrap gap-1.5 mb-3">${kelasTags}</div>
                        <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                            <span class="bg-gray-100 px-2.5 py-1 rounded-lg font-semibold">${jenisLabel}</span>
                            <span class="flex items-center gap-1"><i data-lucide="key" class="w-3 h-3 text-yellow-500"></i> ${p.token || '‚Äî'}</span>
                        </div>
                        <div class="flex items-center justify-between border-t pt-3">
                            <span class="text-sm font-semibold text-gray-700">${soalCount} Soal</span>
                            <button onclick="window.openPaketSoal('${p.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1.5 shadow-sm active:scale-95 transition-all">
                                <i data-lucide="book-open" class="w-3.5 h-3.5"></i> Kelola Soal
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            const pw = document.getElementById('pager-paket-wrap');
            if (pw) pw.innerHTML = renderPagerHTML('paket', total, pgP.page, pgP.perPage);

            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.openPaketSoal = function(paketId) {
            window.activePaketId = paketId;
            const paket = (window.allPaketDB || []).find(p => p.id === paketId);
            if (!paket) return;

            // Reset soal page to 1 when switching paket
            if (window._pg && window._pg.soal) window._pg.soal.page = 1;

            // Switch view
            document.getElementById('view-paket-list').classList.add('hidden');
            document.getElementById('view-soal-in-paket').classList.remove('hidden');

            // Update breadcrumb & info card
            window.refreshActivePaketInfo();
            window.filterQuestionBank();
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.refreshActivePaketInfo = function() {
            const paket = (window.allPaketDB || []).find(p => p.id === window.activePaketId);
            if (!paket) return;
            const COLORS = PAKET_COLORS;
            const idx = window.allPaketDB.indexOf(paket);
            const color = COLORS[idx % COLORS.length];
            const isAktif = paket.aktif !== false;

            document.getElementById('breadcrumb-paket-nama').textContent = paket.nama;
            document.getElementById('active-paket-nama').textContent = paket.nama;
            document.getElementById('active-paket-mapel').textContent = paket.mapel || '';
            document.getElementById('active-paket-token').textContent = paket.token || '‚Äî';

            const iconEl = document.getElementById('active-paket-icon');
            iconEl.className = `w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold text-lg shrink-0 ${color}`;
            iconEl.textContent = paket.nama.charAt(0).toUpperCase();

            const statusBadge = document.getElementById('active-paket-status-badge');
            statusBadge.className = `px-2.5 py-1 rounded-full text-xs font-bold ${isAktif ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'}`;
            statusBadge.textContent = isAktif ? '‚óè Aktif' : '‚óã Nonaktif';

            const kelasTags = document.getElementById('active-paket-kelas-tags');
            kelasTags.innerHTML = (paket.kelas && paket.kelas.length > 0)
                ? paket.kelas.map(k => `<span class="bg-indigo-100 text-indigo-700 px-2.5 py-0.5 rounded-full text-xs font-semibold">${k}</span>`).join('')
                : `<span class="text-xs text-gray-400">Semua Kelas</span>`;
        };

        window.backToPaketList = function() {
            window.activePaketId = null;
            const v1 = document.getElementById('view-paket-list');
            const v2 = document.getElementById('view-soal-in-paket');
            if (v1) v1.classList.remove('hidden');
            if (v2) v2.classList.add('hidden');
        };

        // -- Modal Paket --
        window.openPaketModal = function(id = null) {
            const modal = document.getElementById('modal-paket');
            document.getElementById('form-paket').reset();
            document.getElementById('paket-id').value = '';
            document.getElementById('paket-aktif').checked = true;
            document.getElementById('paket-aktif-label').textContent = 'Aktif';
            document.getElementById('paket-aktif-label').className = 'text-sm font-bold text-green-600';
            window.rebuildPaketKelasChecks([]);
            // Reset jenis radio
            document.querySelectorAll('[name="paket-jenis"]').forEach(r => {
                r.checked = r.value === 'nonpaket';
                const span = r.nextElementSibling;
                if(span) span.className = `paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold ${r.checked ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-gray-200 bg-white text-gray-500'}`;
            });
            document.getElementById('modal-paket-title').textContent = id ? 'Edit Paket Soal' : 'Buat Paket Soal Baru';

            if (id) {
                const p = (window.allPaketDB || []).find(x => x.id === id);
                if (p) {
                    document.getElementById('paket-id').value = p.id;
                    document.getElementById('paket-nama').value = p.nama || '';
                    document.getElementById('paket-mapel').value = p.mapel || '';
                    document.getElementById('paket-token').value = p.token || '';
                    document.getElementById('paket-jumlah-soal').value = p.jumlahSoal || '';
                    document.getElementById('paket-nilai-maks').value = (p.nilaiMaksimal && p.nilaiMaksimal !== 100) ? p.nilaiMaksimal : '';
                    const isAktif = p.aktif !== false;
                    document.getElementById('paket-aktif').checked = isAktif;
                    document.getElementById('paket-aktif-label').textContent = isAktif ? 'Aktif' : 'Nonaktif';
                    document.getElementById('paket-aktif-label').className = `text-sm font-bold ${isAktif ? 'text-green-600' : 'text-gray-400'}`;
                    window.rebuildPaketKelasChecks(p.kelas || []);
                    // Set jenis
                    const jenis = p.jenis || 'nonpaket';
                    document.querySelectorAll('[name="paket-jenis"]').forEach(r => {
                        r.checked = r.value === jenis;
                        const span = r.nextElementSibling;
                        if(span) span.className = `paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold ${r.checked ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-gray-200 bg-white text-gray-500'}`;
                    });
                }
            }

            // Jenis radio click handler
            document.querySelectorAll('[name="paket-jenis"]').forEach(r => {
                r.onclick = function() {
                    document.querySelectorAll('[name="paket-jenis"]').forEach(x => {
                        const span = x.nextElementSibling;
                        if(span) span.className = `paket-jenis-btn px-4 py-2 rounded-xl border-2 text-sm font-bold ${x.checked ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-gray-200 bg-white text-gray-500'}`;
                    });
                };
            });
            // aktif toggle label
            document.getElementById('paket-aktif').onchange = function() {
                const lbl = document.getElementById('paket-aktif-label');
                lbl.textContent = this.checked ? 'Aktif' : 'Nonaktif';
                lbl.className = `text-sm font-bold ${this.checked ? 'text-green-600' : 'text-gray-400'}`;
            };

            modal.classList.remove('hidden');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closePaketModal = function() { document.getElementById('modal-paket').classList.add('hidden'); };

        window.rebuildPaketKelasChecks = function(checkedArr = []) {
            const container = document.getElementById('paket-kelas-checks');
            if (!container) return;
            if (window.kelasList.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-400 italic">Tambahkan kelas di tab Manajemen Kelas terlebih dahulu.</span>';
                return;
            }
            container.innerHTML = window.kelasList.map(k => `
                <label class="flex items-center gap-1.5 cursor-pointer bg-white border-2 hover:border-indigo-400 px-3 py-1.5 rounded-xl transition-colors ${checkedArr.includes(k.nama) ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}">
                    <input type="checkbox" value="${k.nama}" class="w-3.5 h-3.5 accent-indigo-600" ${checkedArr.includes(k.nama) ? 'checked' : ''} onchange="this.closest('label').className=this.closest('label').className.replace(this.checked?'border-gray-200':'border-indigo-500 bg-indigo-50',this.checked?'border-indigo-500 bg-indigo-50':'border-gray-200')">
                    <span class="text-sm font-semibold text-gray-700">${k.nama}</span>
                </label>
            `).join('');
        };

        window.savePaket = async function(e) {
            e.preventDefault();
            if (!window.isFirebaseReady) return alert("Mode Offline: Tidak bisa menyimpan.");
            const id    = document.getElementById('paket-id').value;
            const nama  = document.getElementById('paket-nama').value.trim();
            const mapel = document.getElementById('paket-mapel').value.trim();
            const token = document.getElementById('paket-token').value.trim().toUpperCase();
            const aktif = document.getElementById('paket-aktif').checked;
            const jenis = document.querySelector('[name="paket-jenis"]:checked')?.value || 'nonpaket';
            const kelas = Array.from(document.querySelectorAll('#paket-kelas-checks input:checked')).map(c => c.value);
            const jumlahSoalRaw = document.getElementById('paket-jumlah-soal').value.trim();
            const jumlahSoal = jumlahSoalRaw ? parseInt(jumlahSoalRaw) : 0;
            const nilaiMaksRaw = document.getElementById('paket-nilai-maks').value.trim();
            const nilaiMaksimal = nilaiMaksRaw ? parseInt(nilaiMaksRaw) : 100;

            if (!nama) return alert("Nama paket tidak boleh kosong!");
            if (!token) return alert("Token paket tidak boleh kosong!");

            const data = { nama, mapel, token, aktif, jenis, kelas, jumlahSoal, nilaiMaksimal, updatedAt: Date.now() };
            try {
                if (id) {
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal', id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal'), data);
                }
                window.closePaketModal();
            } catch(err) { alert("Gagal menyimpan: " + err.message); }
        };

        window.deletePaket = async function(id, nama) {
            if (!confirm(`Hapus paket "${nama}"?\n\nSemua soal dalam paket ini TIDAK akan ikut terhapus, tetapi akan kehilangan referensi paket.`)) return;
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'paket_soal', id));
                if (window.activePaketId === id) window.backToPaketList();
            } catch(err) { alert("Gagal hapus: " + err.message); }
        };
        // ==================== END PAKET MANAGEMENT ====================

        // ==================== MANAJEMEN KELAS ====================
        window.kelasList = [];

        window.listenForKelas = function() {
            if (!window.db || !window.isFirebaseReady) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'kelas'));
            onSnapshot(q, (snapshot) => {
                window.kelasList = [];
                snapshot.forEach((d) => {
                    window.kelasList.push({ id: d.id, ...d.data() });
                });
                window.kelasList.sort((a,b) => (a.nama||'').localeCompare(b.nama||''));
                window.renderKelasList();
                window.updateKelasFilter();
                window.updateStudentKelasDropdown();
                // Refresh jadwal dropdown kelas jika panel jadwal sedang terbuka
                if (window.populateJadwalDropdowns) window.populateJadwalDropdowns();
            });
        };

        window.updateKelasFilter = function() {
            // Update monitoring nilai filter
            const sel = document.getElementById('filter-class');
            if (sel) {
                const current = sel.value;
                sel.innerHTML = '<option value="all">Semua Kelas</option>';
                window.kelasList.forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k.nama;
                    opt.textContent = k.nama;
                    sel.appendChild(opt);
                });
                sel.value = current;
            }
            // Update bank soal filter kelas
            const selBank = document.getElementById('filter-bank-kelas');
            if (selBank) {
                const currentBank = selBank.value;
                selBank.innerHTML = '<option value="all">Semua Kelas</option>';
                window.kelasList.forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k.nama;
                    opt.textContent = k.nama;
                    selBank.appendChild(opt);
                });
                selBank.value = currentBank;
            }
            // Update modal kelas checkboxes
            window.rebuildKelasChecks();
            window.rebuildPaketKelasChecks();
            // Refresh dropdown analitik agar ikut terupdate dari data master kelas
            if (window.renderIntegrityDashboard && document.getElementById('panel-analitik') && !document.getElementById('panel-analitik').classList.contains('hidden-section')) {
                window.renderIntegrityDashboard();
            }
        };

        window.rebuildKelasChecks = function(checkedArr = []) {
            const container = document.getElementById('q-kelas-checks');
            if (!container) return;
            if (window.kelasList.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-400 italic">Belum ada kelas. Tambahkan di tab Manajemen Kelas.</span>';
                return;
            }
            container.innerHTML = window.kelasList.map(k => `
                <label class="flex items-center gap-1.5 cursor-pointer bg-white border border-indigo-200 hover:border-indigo-400 px-3 py-1.5 rounded-lg transition-colors">
                    <input type="checkbox" value="${k.nama}" class="w-3.5 h-3.5 accent-indigo-600" ${checkedArr.includes(k.nama) ? 'checked' : ''}>
                    <span class="text-sm font-medium text-gray-700">${k.nama}</span>
                </label>
            `).join('');
        };

        window.updateStudentKelasDropdown = function() {
            const sel = document.getElementById('student-class');
            if (!sel || window.kelasList.length === 0) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">Pilih Kelas</option>';
            window.kelasList.forEach(k => {
                const opt = document.createElement('option');
                opt.value = k.nama;
                opt.textContent = k.nama;
                sel.appendChild(opt);
            });
            if (current) sel.value = current;
        };

        window.renderKelasList = function() {
            const tbody = document.getElementById('kelas-table-body');
            if (!tbody) return;
            const pw = document.getElementById('pager-kelas-wrap');
            const total = window.kelasList.length;
            if (total === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">Belum ada kelas. Tambah kelas baru.</td></tr>';
                if (pw) pw.innerHTML = '';
                return;
            }
            const pgK = window._pg.kelas;
            pgK.page = Math.max(1, Math.min(pgK.page, Math.ceil(total / pgK.perPage)));
            const sliceStart = (pgK.page - 1) * pgK.perPage;
            const pageItems = window.kelasList.slice(sliceStart, sliceStart + pgK.perPage);
            tbody.innerHTML = pageItems.map((k, i) => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 text-sm text-gray-500">${sliceStart + i + 1}</td>
                    <td class="px-6 py-4 font-semibold text-gray-800">${k.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${k.keterangan || '-'}</td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex gap-2 justify-center">
                            <button onclick="window.openKelasModal('${k.id}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg" title="Edit"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="window.deleteKelas('${k.id}','${k.nama}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg" title="Hapus"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
            if (pw) pw.innerHTML = renderPagerHTML('kelas', total, pgK.page, pgK.perPage);
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.openKelasModal = function(id = null) {
            const modal = document.getElementById('modal-kelas');
            const titleEl = document.getElementById('modal-kelas-title');
            document.getElementById('kelas-id').value = '';
            document.getElementById('kelas-nama').value = '';
            document.getElementById('kelas-keterangan').value = '';

            if (id) {
                const k = window.kelasList.find(x => x.id === id);
                if (k) {
                    titleEl.textContent = 'Edit Kelas';
                    document.getElementById('kelas-id').value = k.id;
                    document.getElementById('kelas-nama').value = k.nama;
                    document.getElementById('kelas-keterangan').value = k.keterangan || '';
                }
            } else {
                titleEl.textContent = 'Tambah Kelas Baru';
            }
            modal.classList.remove('hidden');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closeKelasModal = function() {
            document.getElementById('modal-kelas').classList.add('hidden');
        };

        window.saveKelas = async function(e) {
            e.preventDefault();
            if (!window.isFirebaseReady) return alert("Mode Offline: Tidak bisa menyimpan ke database.");
            const id = document.getElementById('kelas-id').value;
            const nama = document.getElementById('kelas-nama').value.trim();
            const keterangan = document.getElementById('kelas-keterangan').value.trim();
            if (!nama) return alert("Nama kelas tidak boleh kosong!");

            const data = { nama, keterangan, updatedAt: Date.now() };
            try {
                if (id) {
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'kelas', id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'kelas'), data);
                }
                window.closeKelasModal();
            } catch(err) {
                alert("Gagal menyimpan: " + err.message);
            }
        };

        window.deleteKelas = async function(id, nama) {
            if (!confirm(`Hapus kelas "${nama}"? Tindakan ini tidak bisa dibatalkan.`)) return;
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            try {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'kelas', id));
            } catch(err) {
                alert("Gagal hapus: " + err.message);
            }
        };
        // ==================== END MANAJEMEN KELAS ====================
        
        // --- CHEAT ALERT LOGIC ---
        window.triggerCheatAlert = function(data) {
            if (document.getElementById('section-dashboard').classList.contains('hidden-section')) return;

            const modal = document.getElementById('modal-cheat-alert');
            const nameEl = document.getElementById('cheat-student-name');
            const msgEl = document.getElementById('cheat-message');
            const statusEl = document.getElementById('cheat-status');
            const countEl = document.getElementById('cheat-count');

            nameEl.innerText = data.studentName + " (" + data.className + ")";
            statusEl.innerText = data.status;
            countEl.innerText = data.violations + "x";

            if (data.status.includes('DISKUALIFIKASI')) {
                 msgEl.innerText = "SISWA INI TELAH DIDISKUALIFIKASI OLEH SISTEM!";
            } else {
                 msgEl.innerText = "Terdeteksi melakukan kecurangan (Pindah Tab/Split Screen)!";
            }

            modal.classList.remove('hidden');
            
            try {
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                audio.volume = 0.5;
                audio.play().catch(() => {}); 
            } catch(e) {}
        };

        window.closeCheatAlert = function() {
            document.getElementById('modal-cheat-alert').classList.add('hidden');
        };
        
        window.showViolationDetails = (id) => {
            const item = dashboardData.find(x => x.id === id);
            if (!item) return;

            document.getElementById('violation-student-name').innerText = item.studentName;
            const list = document.getElementById('violation-list');
            list.innerHTML = '';

            if (!item.violationLogs || item.violationLogs.length === 0) {
                list.innerHTML = '<p class="text-xs text-gray-400 italic text-center py-4">Tidak ada log detail tercatat.<br> (Sistem versi lama atau deteksi manual).</p>';
            } else {
                item.violationLogs.forEach((log) => {
                    const time = new Date(log.time).toLocaleTimeString('id-ID');
                    list.innerHTML += `
                        <div class="text-xs border-b last:border-0 pb-2 mb-2 bg-white p-2 rounded shadow-sm">
                            <span class="font-bold text-red-600 bg-red-50 px-1 rounded border border-red-100 mr-1">[${time}]</span> 
                            <span class="text-gray-700 font-medium">${log.message}</span>
                        </div>
                    `;
                });
            }
            document.getElementById('modal-violation-details').classList.remove('hidden');
        };

        window.filterQuestionBank = function() {
            const filterStatus = (document.getElementById('filter-bank-status') || {}).value || 'all';
            const searchVal    = ((document.getElementById('search-bank-soal') || {}).value || '').toLowerCase();
            const container    = document.getElementById('bank-soal-list');
            if (!container) return;

            // Filter by active paket
            let filtered = window.allQuestionsDB.filter(q => {
                if (window.activePaketId && q.paketId !== window.activePaketId) return false;
                if (filterStatus === 'aktif'    && q.aktif === false) return false;
                if (filterStatus === 'nonaktif' && q.aktif !== false) return false;
                if (searchVal && !(q.text||'').toLowerCase().includes(searchVal)) return false;
                return true;
            });
            filtered.sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));

            // Stats
            const total    = filtered.length;
            const aktifCnt = filtered.filter(q => q.aktif !== false).length;
            const nonAktif = total - aktifCnt;
            const s = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
            s('stat-total', `Total: ${total}`);
            s('stat-aktif', `Aktif: ${aktifCnt}`);
            s('stat-nonaktif', `Nonaktif: ${nonAktif}`);

            const pw = document.getElementById('pager-soal-wrap');

            if (filtered.length === 0) {
                const paket = (window.allPaketDB || []).find(p => p.id === window.activePaketId);
                container.innerHTML = `
                    <div class="bg-white rounded-xl border shadow-sm p-12 text-center">
                        <div class="inline-flex p-4 bg-blue-50 rounded-2xl mb-4"><i data-lucide="file-plus" class="w-10 h-10 text-blue-400"></i></div>
                        <h3 class="text-lg font-bold text-gray-700 mb-2">Belum Ada Soal</h3>
                        <p class="text-gray-400 text-sm mb-5">Paket <strong>${paket ? paket.nama : ''}</strong> belum memiliki soal.<br>Tambahkan soal manual atau import dari Excel/Word.</p>
                        <div class="flex gap-3 justify-center flex-wrap">
                            <button onclick="window.openQuestionModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-md">
                                <i data-lucide="plus" class="w-4 h-4"></i> Tambah Soal Manual
                            </button>
                            <button onclick="window.switchDashTab('import')" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-md">
                                <i data-lucide="upload" class="w-4 h-4"></i> Import dari Excel/Word
                            </button>
                        </div>
                    </div>`;
                if (pw) pw.innerHTML = '';
                if(typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // Pagination
            const pgS = window._pg.soal;
            pgS.page = Math.max(1, Math.min(pgS.page, Math.ceil(total / pgS.perPage)));
            const sliceStart = (pgS.page - 1) * pgS.perPage;
            const pageItems = filtered.slice(sliceStart, sliceStart + pgS.perPage);

            const labels = ['A','B','C','D','E'];
            container.innerHTML = pageItems.map((q, idx) => {
                const globalIdx = sliceStart + idx;
                const isAktif   = q.aktif !== false;
                const isMultiple = q.tipe === 'multiple';
                const isTrueFalse = q.tipe === 'truefalse';
                const isEssayQ = q.tipe === 'essay';
                const optionsHtml = isEssayQ
                    ? `<div class="bg-purple-50 border border-purple-200 rounded-xl p-3">
                            <p class="text-xs font-bold text-purple-700 mb-1.5 flex items-center gap-1"><i data-lucide="pencil-line" class="w-3.5 h-3.5"></i> Rubrik / Kunci Jawaban</p>
                            <p class="text-sm text-purple-900 whitespace-pre-line leading-relaxed">${q.essayRubrik || '‚Äî'}</p>
                            <p class="text-xs text-purple-500 mt-2 font-medium">Skor maks: ${q.essaySkorMaks || 10} poin</p>
                       </div>`
                    : isTrueFalse
                    ? `<div class="flex gap-2">
                            <div class="flex items-center gap-2 px-4 py-2 rounded-lg ${q.correct === true || q.correct === 'true' ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-100'}">
                                <span class="w-6 h-6 rounded-full ${q.correct === true || q.correct === 'true' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'} text-xs font-bold flex items-center justify-center">‚úì</span>
                                <span class="text-sm font-semibold ${q.correct === true || q.correct === 'true' ? 'text-green-700' : 'text-gray-500'}">BENAR ${q.correct === true || q.correct === 'true' ? '<span class="text-xs text-green-500">‚úì Kunci</span>' : ''}</span>
                            </div>
                            <div class="flex items-center gap-2 px-4 py-2 rounded-lg ${q.correct === false || q.correct === 'false' ? 'bg-red-50 border border-red-200' : 'bg-gray-50 border border-gray-100'}">
                                <span class="w-6 h-6 rounded-full ${q.correct === false || q.correct === 'false' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-500'} text-xs font-bold flex items-center justify-center">‚úó</span>
                                <span class="text-sm font-semibold ${q.correct === false || q.correct === 'false' ? 'text-red-700' : 'text-gray-500'}">SALAH ${q.correct === false || q.correct === 'false' ? '<span class="text-xs text-red-500">‚úì Kunci</span>' : ''}</span>
                            </div>
                       </div>`
                    : (q.options || []).map((opt, i) => {
                    const isCorrect = isMultiple
                        ? (Array.isArray(q.correct) && q.correct.includes(i))
                        : i === (Array.isArray(q.correct) ? q.correct[0] : q.correct);
                    return `<div class="flex items-start gap-2 py-1.5 px-3 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-100'}">
                        <span class="shrink-0 w-6 h-6 rounded-${isMultiple ? 'md' : 'full'} ${isCorrect ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600'} text-xs font-bold flex items-center justify-center">${labels[i]||i}</span>
                        <span class="text-sm ${isCorrect ? 'text-green-800 font-semibold' : 'text-gray-700'} flex-1">${opt || '<em class="text-gray-400 text-xs">Gambar</em>'}</span>
                        ${isCorrect ? '<span class="text-xs font-bold text-green-600 shrink-0">‚úì Kunci</span>' : ''}
                    </div>`;
                }).join('');
                const imgHtml = q.image ? `<div class="mt-3"><img src="${q.image}" class="max-h-32 rounded-xl border object-contain bg-gray-50 p-1"></div>` : '';

                // Build kunci label for card header
                const kunciLabel = isEssayQ
                    ? `<i>Esai (skor maks: ${q.essaySkorMaks || 10})</i>`
                    : isTrueFalse
                        ? (q.correct === true || q.correct === 'true' ? '‚úì Benar' : '‚úó Salah')
                        : isMultiple && Array.isArray(q.correct)
                            ? q.correct.map(i => labels[i]||i).join(', ')
                            : labels[Array.isArray(q.correct) ? q.correct[0] : q.correct] || q.correct;

                const tipeBadge = isEssayQ
                    ? `<span class="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded font-bold">Esai</span>`
                    : isTrueFalse
                        ? `<span class="text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-bold">B/S</span>`
                        : isMultiple
                            ? `<span class="text-[10px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded font-bold">Ganda</span>`
                            : '';

                return `
                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden ${!isAktif ? 'opacity-60' : ''}" id="soal-card-${q.id}">
                    <div class="flex items-center gap-3 px-5 py-3.5 cursor-pointer hover:bg-gray-50 transition-colors" onclick="window.toggleSoalCard('${q.id}')">
                        <span class="text-xs font-bold text-gray-300 w-7 shrink-0 text-center">${globalIdx+1}</span>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <p class="text-sm font-semibold text-gray-800 truncate">${q.text || '<em class="text-gray-400 font-normal">Soal Gambar</em>'}</p>
                                ${tipeBadge}
                            </div>
                            <p class="text-xs text-gray-400 mt-0.5">${(q.options||[]).length} pilihan ‚Ä¢ Kunci: ${kunciLabel}</p>
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                            <label class="flex items-center gap-1.5 cursor-pointer" onclick="event.stopPropagation()">
                                <div class="relative">
                                    <input type="checkbox" class="sr-only peer" ${isAktif ? 'checked' : ''} onchange="window.toggleAktifSoal('${q.id}', this.checked)">
                                    <div class="w-9 h-5 bg-gray-200 rounded-full peer peer-checked:bg-green-500 transition-colors"></div>
                                    <div class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform peer-checked:translate-x-4"></div>
                                </div>
                                <span class="text-xs font-semibold ${isAktif ? 'text-green-600' : 'text-gray-400'}">${isAktif ? 'Aktif' : 'Nonaktif'}</span>
                            </label>
                            <button onclick="event.stopPropagation(); window.openQuestionModal('${q.id}')" class="p-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            <button onclick="event.stopPropagation(); window.deleteQuestion('${q.id}')" class="p-1.5 bg-red-50 text-red-500 rounded-lg hover:bg-red-100" title="Hapus"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-300 soal-chevron transition-transform shrink-0"></i>
                        </div>
                    </div>
                    <div class="soal-detail hidden border-t bg-slate-50 px-6 py-4">
                        <div class="mb-3">
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1.5">Pertanyaan</p>
                            <p class="text-sm text-gray-800 leading-relaxed">${q.text || '<em class="text-gray-400">Tidak ada teks</em>'}</p>
                            ${imgHtml}
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Pilihan Jawaban ${isMultiple ? '<span class="text-emerald-600">(Jawaban Ganda ‚Äî ‚úì = Kunci)</span>' : isTrueFalse ? '<span class="text-amber-600">(Benar/Salah)</span>' : ''}</p>
                            <div class="space-y-1.5">${optionsHtml}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            if (pw) pw.innerHTML = renderPagerHTML('soal', total, pgS.page, pgS.perPage);
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.toggleSoalCard = function(id) {
            const card = document.getElementById(`soal-card-${id}`);
            if (!card) return;
            const detail  = card.querySelector('.soal-detail');
            const chevron = card.querySelector('.soal-chevron');
            const isOpen  = !detail.classList.contains('hidden');
            detail.classList.toggle('hidden', isOpen);
            if (chevron) chevron.style.transform = isOpen ? '' : 'rotate(180deg)';
        };

        window.toggleAktifSoal = async function(id, aktif) {
            if (!window.isFirebaseReady) return alert("Mode Offline.");
            try {
                await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'questions', id), { aktif, updatedAt: Date.now() });
            } catch(e) { alert("Gagal update: " + e.message); }
        };

        // --- STUDENT LOGIN (UPDATED WITH OFFLINE SUPPORT) ---
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // HANDLE STUDENT LOGIN  (alur baru: Login ‚Üí Welcome ‚Üí Ujian)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.handleStudentLogin = async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('btn-student-submit');
            try {
                const name        = document.getElementById('student-name').value.trim();
                const studentNisn = document.getElementById('student-nisn').value.trim();
                const cls         = document.getElementById('student-class').value;
                const room        = document.getElementById('student-room').value;
                const tokenInput  = document.getElementById('student-token').value.trim().toUpperCase();

                if (!name || !studentNisn || !cls || !room || !tokenInput) {
                    alert("Mohon lengkapi semua kolom: Nama, NISN, Kelas, Ruang Ujian, dan Token!");
                    return;
                }

                // ‚îÄ‚îÄ 1. FULLSCREEN segera saat tombol ditekan ‚îÄ‚îÄ
                try {
                    const el = document.documentElement;
                    if (el.requestFullscreen) await el.requestFullscreen().catch(() => {});
                    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                    else if (el.msRequestFullscreen) el.msRequestFullscreen();
                } catch(fsErr) { console.log("FS:", fsErr); }

                // ‚îÄ‚îÄ 2. Cari paket yang cocok dengan token + kelas siswa ‚îÄ‚îÄ
                const paketCocok = (window.allPaketDB || []).filter(p => {
                    if (p.aktif === false) return false;
                    if (!p.token || p.token.toUpperCase() !== tokenInput) return false;
                    // jika paket punya filter kelas, siswa harus masuk salah satunya
                    if (p.kelas && p.kelas.length > 0) {
                        return p.kelas.some(k => k.toLowerCase() === cls.toLowerCase());
                    }
                    return true; // paket terbuka untuk semua kelas
                });

                // ‚îÄ‚îÄ 3. Fallback: token cocok dengan global token ujian ‚îÄ‚îÄ
                if (paketCocok.length === 0 && tokenInput !== window.currentExamToken) {
                    alert("TOKEN SALAH atau tidak ada ujian tersedia untuk kelas " + cls + ".\nMinta token yang benar kepada pengawas.");
                    return;
                }

                // ‚îÄ‚îÄ 4. Cek incognito ‚îÄ‚îÄ
                const isPrivate = await detectPrivateMode();
                if (isPrivate) {
                    const lanjut = confirm(
                        "‚ö†Ô∏è PERINGATAN: BROWSER PRIVATE/INCOGNITO TERDETEKSI\n\n" +
                        "Mode ini DILARANG karena dapat melewati sistem keamanan.\n\n" +
                        "Tekan OK untuk tetap lanjut (TERDATA pelanggaran),\n" +
                        "atau Batal ‚Üí tutup dan buka browser normal."
                    );
                    if (!lanjut) return;
                    violationLogs.push({ time: Date.now(), message: "Login via mode Private/Incognito" });
                }

                // ‚îÄ‚îÄ 5. Cek local session cooldown ‚îÄ‚îÄ
                const localSession = localStorage.getItem('ukktkj_session_done');
                if (localSession) {
                    try {
                        const sd = JSON.parse(localSession);
                        const diffMinutes = (Date.now() - new Date(sd.date).getTime()) / 60000;
                        if (diffMinutes < window.deviceCooldownHours) {   // deviceCooldownHours sekarang = menit
                            const remaining = Math.ceil(window.deviceCooldownHours - diffMinutes);
                            alert(`‚õî PERANGKAT TERKUNCI\n\nBaru digunakan: "${sd.name}" (NISN: ${sd.nisn || '-'}).\nSisa cooldown: ${remaining} menit lagi.`);
                            return;
                        } else { localStorage.removeItem('ukktkj_session_done'); }
                    } catch(_) { localStorage.removeItem('ukktkj_session_done'); }
                }

                if (submitBtn) { submitBtn.disabled = true; submitBtn.querySelector('span').textContent = "Memeriksa..."; }

                // ‚îÄ‚îÄ 6. Cek duplikat / device block di Firebase ‚îÄ‚îÄ
                let isDuplicateName = false, isDeviceBlocked = false, blockedByWho = "";
                if (window.isFirebaseReady && window.db) {
                    try {
                        const fp = (window.getDeviceFingerprint || getDeviceFingerprint)();
                        const qSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));
                        const now = Date.now();
                        qSnap.forEach(ds => {
                            const d = ds.data();
                            if ((now - d.timestamp) / 60000 > window.deviceCooldownHours) return; // deviceCooldownHours = menit
                            const nisnMatch = d.studentNisn && studentNisn && d.studentNisn.toString().trim() === studentNisn.toString().trim();
                            const nameFb   = !d.studentNisn && d.studentName.toLowerCase() === name.toLowerCase() && d.className === cls;
                            if (nisnMatch || nameFb) {
                                if (d.status.includes('SELESAI') || d.status.includes('DISKUALIFIKASI')) isDuplicateName = true;
                            }
                            if (d.deviceFingerprint === fp && (d.status.includes('SELESAI') || d.status.includes('DISKUALIFIKASI'))) {
                                const beda = d.studentNisn && studentNisn ? d.studentNisn.toString() !== studentNisn.toString() : d.studentName.toLowerCase() !== name.toLowerCase();
                                if (beda) { isDeviceBlocked = true; blockedByWho = d.studentName + (d.studentNisn ? ' (NISN: '+d.studentNisn+')' : ''); }
                            }
                        });
                    } catch(dbErr) { console.warn("DB check offline:", dbErr); }
                }

                if (submitBtn) { submitBtn.disabled = false; submitBtn.querySelector('span').textContent = "MASUK"; }

                if (isDuplicateName) {
                    alert(`‚õî AKSES DITOLAK\n\n"${name}" sudah menyelesaikan atau didiskualifikasi.\nLogin ulang tidak diizinkan.`);
                    return;
                }
                if (isDeviceBlocked) {
                    alert(`‚õî PERANGKAT DIBLOKIR\n\nBaru dipakai oleh: "${blockedByWho}".\nGunakan perangkat sendiri. Terkunci ${window.deviceCooldownHours} menit.`);
                    return;
                }

                // ‚îÄ‚îÄ 7. Simpan data login ke global untuk dipakai saat klik paket ‚îÄ‚îÄ
                window._loginData = { name, studentNisn, cls, room, tokenInput, paketCocok };

                // ‚òÖ Simpan UID siswa ke Firestore dengan role=siswa
                try {
                    const uid = window.auth && window.auth.currentUser && window.auth.currentUser.uid;
                    if (uid && window.db) {
                        setDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'authorized_uids', uid), {
                            role: 'siswa',
                            nama: name,
                            nisn: studentNisn,
                            kelas: cls,
                            ruang: room,
                            loginAt: Date.now()
                        });
                        window.currentUID = uid;
                    }
                } catch(uidErr) { console.warn('[Auth] UID save:', uidErr); }

                // ‚îÄ‚îÄ 8. Tampilkan halaman SELAMAT DATANG ‚îÄ‚îÄ
                document.getElementById('welcome-name').textContent  = name;
                document.getElementById('welcome-nisn').textContent  = studentNisn;
                document.getElementById('welcome-kelas').textContent = cls;
                window.renderWelcomePaketList(paketCocok, cls, tokenInput);

                document.getElementById('section-login').classList.add('hidden-section');
                document.getElementById('section-welcome').classList.remove('hidden-section');
                if (typeof lucide !== 'undefined') lucide.createIcons();

            } catch(err) {
                console.error(err);
                alert("Gagal login: " + err.message);
                if (submitBtn) { submitBtn.disabled = false; submitBtn.querySelector('span').textContent = "MASUK"; }
            }
        };

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Render daftar paket di halaman selamat datang
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.renderWelcomePaketList = function(paketCocok, cls, tokenInput) {
            const container = document.getElementById('welcome-paket-list');
            if (!container) return;

            // Fallback jika tidak ada paket di Firebase tapi token global cocok
            if (paketCocok.length === 0 && tokenInput === window.currentExamToken) {
                const aktifPaket = (window.allPaketDB || []).filter(p =>
                    p.aktif !== false && (!p.token || p.token.toUpperCase() === tokenInput)
                );
                paketCocok = aktifPaket;
            }

            if (paketCocok.length === 0) {
                container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-6 px-4 text-center">
                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center mb-3" style="background:#fef9c3;">
                        <i data-lucide="calendar-x" class="w-7 h-7" style="color:#ca8a04;"></i>
                    </div>
                    <p class="text-gray-800 font-black text-sm mb-1">Belum Ada Jadwal atau Paket Ujian</p>
                    <p class="text-gray-500 text-xs leading-relaxed mb-4">
                        Saat ini belum ada ujian yang tersedia untuk kelasmu.<br>
                        Silakan <span class="font-bold text-blue-600">tanyakan kepada Pengawas</span> mengenai jadwal dan paket ujian yang akan digunakan.
                    </p>
                    <div class="w-full rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 flex items-start gap-3">
                        <i data-lucide="info" class="w-4 h-4 text-amber-500 shrink-0 mt-0.5"></i>
                        <p class="text-xs text-amber-800 text-left leading-relaxed font-medium">
                            Pastikan pengawas telah mengaktifkan paket ujian dan menetapkan jadwal sesuai kelas kamu sebelum memulai ujian.
                        </p>
                    </div>
                </div>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // ‚òÖ AUTO-RANDOM: Jika ada lebih dari 1 paket yang cocok,
            // sistem langsung memilih paket secara acak ‚Äî siswa tidak perlu memilih sendiri.
            // Ini memastikan distribusi paket merata dan mengurangi potensi contekan antar siswa.
            if (paketCocok.length > 1) {
                const randomIdx = Math.floor(Math.random() * paketCocok.length);
                const paketTerpilih = paketCocok[randomIdx];
                const jenisLabel = (paketTerpilih.jenis && paketTerpilih.jenis !== 'nonpaket') ? `Paket ${paketTerpilih.jenis}` : 'Ujian';

                container.innerHTML = `
                <div class="flex flex-col items-center py-5 px-4 text-center">
                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center mb-3" style="background:#dbeafe;">
                        <i data-lucide="shuffle" class="w-7 h-7" style="color:#1d4ed8;"></i>
                    </div>
                    <p class="text-xs font-bold text-blue-500 uppercase tracking-widest mb-1">Sistem Memilihkan Paket Untukmu</p>
                    <p class="text-gray-800 font-black text-base leading-tight mb-0.5">${paketTerpilih.nama}</p>
                    <p class="text-xs text-indigo-600 font-semibold mb-4">${paketTerpilih.mapel ? paketTerpilih.mapel + ' ¬∑ ' : ''}${jenisLabel}</p>
                    <button onclick="window.startExamFromWelcome('${paketTerpilih.id}')"
                        class="w-full py-3.5 rounded-xl font-black text-white text-sm transition-all active:scale-[0.98]"
                        style="background:linear-gradient(135deg,#1d4ed8,#6366f1);">
                        <i data-lucide="play-circle" class="w-4 h-4 inline mr-1.5 -mt-0.5"></i>
                        Mulai Ujian
                    </button>
                    <p class="text-[10px] text-gray-400 mt-2.5">Paket ditentukan otomatis oleh sistem secara acak untuk menjaga integritas ujian.</p>
                </div>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // Hanya 1 paket ‚Üí tampilkan tombol seperti biasa
            const cardAccents = [
                { icon:'#1d4ed8', badge:'#dbeafe', text:'#1e40af' },
                { icon:'#4338ca', badge:'#e0e7ff', text:'#3730a3' },
                { icon:'#0369a1', badge:'#e0f2fe', text:'#075985' },
                { icon:'#1e3a8a', badge:'#bfdbfe', text:'#1e40af' },
            ];
            container.innerHTML = paketCocok.map((p, i) => {
                const ac = cardAccents[i % cardAccents.length];
                const jenisLabel = (p.jenis && p.jenis !== 'nonpaket') ? `Paket ${p.jenis}` : 'Ujian';
                return `
                <button onclick="window.startExamFromWelcome('${p.id}')"
                    class="w-full text-left rounded-xl border border-blue-100 bg-white transition-all duration-150 active:scale-[0.98] hover:border-blue-300 hover:shadow-md"
                    style="box-shadow:0 1px 4px rgba(59,130,246,0.08);">
                    <div class="flex items-center gap-3 px-4 py-3.5">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center shrink-0" style="background:${ac.badge};">
                            <i data-lucide="book-open" class="w-5 h-5" style="color:${ac.icon}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-black text-sm text-gray-800 leading-tight truncate">${p.nama}</p>
                            <p class="text-xs mt-0.5 font-medium" style="color:${ac.text}">${p.mapel ? p.mapel + ' ¬∑ ' : ''}${jenisLabel}</p>
                        </div>
                        <div class="w-7 h-7 rounded-full flex items-center justify-center shrink-0" style="background:#dbeafe;">
                            <i data-lucide="arrow-right" class="w-3.5 h-3.5 text-blue-500"></i>
                        </div>
                    </div>
                </button>`;
            }).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };;

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Mulai ujian setelah klik paket di halaman welcome
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.startExamFromWelcome = async function(paketId) {
            try {
                const { name, studentNisn, cls, room, tokenInput } = window._loginData || {};
                if (!name) { alert("Sesi habis. Silakan login ulang."); return; }

                // Cari paket
                const paket = (window.allPaketDB || []).find(p => p.id === paketId);
                const pkt   = paket ? (paket.jenis && paket.jenis !== 'nonpaket' ? paket.jenis : 'A') : 'A';

                // Load soal berdasarkan paketId dari Firestore (TIDAK ada fallback ke hardcode)
                let dbQuestions = window.allQuestionsDB.filter(q => q.paketId === paketId && q.aktif !== false);

                // Jika soal paket tidak ditemukan di DB, tampilkan error ‚Äî jangan fallback ke paket lain
                if (dbQuestions.length === 0) {
                    alert("Belum ada soal untuk paket ini. Hubungi pengawas!");
                    return;
                }

                // Acak dulu, lalu potong sesuai jumlahSoal yang diset di paket
                shuffleArray(dbQuestions);
                const jumlahSoal = paket && paket.jumlahSoal && paket.jumlahSoal > 0 ? paket.jumlahSoal : dbQuestions.length;
                dbQuestions = dbQuestions.slice(0, jumlahSoal);

                currentStudent = { name, nisn: studentNisn, cls, pkt, room, paketId, paketNama: paket ? paket.nama : '' };
                document.getElementById('header-name').innerText   = name;
                document.getElementById('header-detail').innerText = `${cls} ¬∑ ${paket ? paket.nama : 'Paket '+pkt}`;

                currentQuestionList = [...dbQuestions];
                // Soal sudah diacak dan dibatasi di atas (shuffleArray + slice)
                violationLogs = [];
                violations    = 0;
                // ‚òÖ Reset guard flag agar finishExam & DQ modal bisa berjalan normal
                window._examFinished = false;
                window._dqShown = false;

                // Simpan/resume sesi Firebase
                // FIX DUPLIKAT: Cek dengan NISN *atau* nama+kelas jika NISN kosong
                // dan hapus/update semua dokumen "ghost" (SEDANG MENGERJAKAN yang basi)
                let existingActiveDocId = null;
                let ghostDocsToDelete = [];
                if (window.isFirebaseReady && window.db) {
                    try {
                        const fp = (window.getDeviceFingerprint || getDeviceFingerprint)();
                        const qSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));
                        qSnap.forEach(ds => {
                            const d = ds.data();
                            // Cek apakah ini dokumen milik siswa yang sama
                            const nisnMatch = d.studentNisn && studentNisn && 
                                              d.studentNisn.toString().trim() === studentNisn.toString().trim();
                            const nameMatch = !nisnMatch && 
                                              d.studentName && d.studentName.toLowerCase() === name.toLowerCase() &&
                                              d.className === cls;
                            const isMine = nisnMatch || nameMatch;
                            
                            if (isMine && !d.status.includes('SELESAI') && !d.status.includes('DISKUALIFIKASI')) {
                                if (!existingActiveDocId) {
                                    // Ambil dokumen pertama sebagai yang akan dilanjutkan
                                    existingActiveDocId = ds.id;
                                    window.examStartTime = d.timestamp;
                                } else {
                                    // Duplikat "SEDANG MENGERJAKAN" ‚Äî tandai untuk dihapus
                                    ghostDocsToDelete.push(ds.id);
                                }
                            }
                        });

                        // Hapus dokumen ghost (duplikat SEDANG MENGERJAKAN)
                        if (ghostDocsToDelete.length > 0) {
                            console.log(`[FIX] Menghapus ${ghostDocsToDelete.length} dokumen ghost duplikat.`);
                            await Promise.all(ghostDocsToDelete.map(gId =>
                                deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', gId))
                            ));
                        }
                    } catch(_) {}

                    if (existingActiveDocId) {
                        window.currentExamDocId = existingActiveDocId;
                        // Simpan ke sessionStorage agar tidak hilang saat refresh
                        try {
                            sessionStorage.setItem('ukktkj_current_exam_doc_id', existingActiveDocId);
                            sessionStorage.setItem('ukktkj_student_data', JSON.stringify({
                                name: name,
                                nisn: studentNisn,
                                cls: cls
                            }));
                        } catch(e) {}
                        await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', existingActiveDocId), {
                            status: "MELANJUTKAN (Re-Login)", packetType: pkt, paketId,
                            ruangUjian: room || '-',
                            deviceFingerprint: (window.getDeviceFingerprint || getDeviceFingerprint)()
                        });
                    } else {
                        const startData = {
                            timestamp: Date.now(), studentName: name, studentNisn,
                            className: cls, ruangUjian: room || '-', packetType: pkt, paketId,
                            sesiId:   window.currentSesiId   || 'default',
                            sesiName: window.currentSesiName || 'Sesi Default',
                            jadwalId: (window.allJadwalDB || []).find(j => j.isActive && j.paketId === paketId)?.id || window.currentSesiId || 'default',
                            score: '-', status: "SEDANG MENGERJAKAN",
                            violations: 0, violationLogs: [],
                            deviceFingerprint: (window.getDeviceFingerprint || getDeviceFingerprint)()
                        };
                        window.examStartTime = startData.timestamp;
                        await window.saveExamStart(startData);
                    }
                } else {
                    window.examStartTime = Date.now();
                }

                currentQuestionIndex = 0;
                renderQuestion();
                renderSidebarButtons();

                document.getElementById('section-welcome').classList.add('hidden-section');
                document.getElementById('section-exam').classList.remove('hidden-section');

                // ‚îÄ‚îÄ Paksa fullscreen saat ujian dimulai ‚îÄ‚îÄ
                try {
                    const el = document.documentElement;
                    if (el.requestFullscreen) await el.requestFullscreen().catch(() => {});
                    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                    else if (el.msRequestFullscreen) el.msRequestFullscreen();
                } catch(fsErr) { console.log("[FS] startExam:", fsErr); }

                window.renderWatermark(name);
                startExamLogic();

            } catch(err) {
                console.error(err);
                alert("Gagal memulai ujian: " + err.message);
            }
        };

        window.switchTeacherSubTab = function(tab) {
            const adminForm = document.getElementById('form-admin-login');
            const pengawasForm = document.getElementById('form-pengawas-login');
            const btnAdmin = document.getElementById('subtab-admin');
            const btnPengawas = document.getElementById('subtab-pengawas');

            if (tab === 'admin') {
                adminForm.classList.remove('hidden-section');
                pengawasForm.classList.add('hidden-section');
                btnAdmin.className = 'flex-1 py-2 text-xs font-bold rounded-lg bg-white text-gray-800 shadow-sm flex items-center justify-center gap-1.5';
                btnPengawas.className = 'flex-1 py-2 text-xs font-bold rounded-lg text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1.5';
            } else {
                adminForm.classList.add('hidden-section');
                pengawasForm.classList.remove('hidden-section');
                btnAdmin.className = 'flex-1 py-2 text-xs font-bold rounded-lg text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1.5';
                btnPengawas.className = 'flex-1 py-2 text-xs font-bold rounded-lg bg-white text-gray-800 shadow-sm flex items-center justify-center gap-1.5';
                // Populate ruang dropdown untuk pengawas
                window.updatePengawasRoomDropdown();
            }
        };

        window.updatePengawasRoomDropdown = function() {
            const sel = document.getElementById('pengawas-room-select');
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Pilih Ruang --</option>';
            (window.ruangList || []).forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = r.nama;
                sel.appendChild(opt);
            });
        };

        window.handleAdminLogin = async function(e) {
            e.preventDefault();
            const u = document.getElementById('admin-user').value.trim();
            const p = document.getElementById('admin-pass').value;
            const btn = e.target.querySelector('button[type="submit"]') || e.target.querySelector('button');

            if (!u || !p) { alert("Username dan password tidak boleh kosong!"); return; }
            if (btn) { btn.disabled = true; btn.textContent = "Memeriksa..."; }

            try {
                let loginOk = false;
                let adminDisplayName = u;

                // ‚îÄ‚îÄ Cek credentials ke Firebase ‚îÄ‚îÄ
                if (window.isFirebaseReady && window.db) {
                    try {
                        const snap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'admin_credentials'));
                        snap.forEach(ds => {
                            const d = ds.data();
                            // Bandingkan username (case-insensitive) dan password (case-sensitive)
                            if (d.username && d.username.toLowerCase() === u.toLowerCase() && d.password === p) {
                                loginOk = true;
                                adminDisplayName = d.displayName || u;
                            }
                        });
                    } catch(dbErr) {
                        console.warn("Firebase credentials check error:", dbErr);
                        // Fallback ke hardcoded jika Firebase error
                        if (u.toLowerCase() === 'authar' && p === 'Sedayu@123') {
                            loginOk = true; adminDisplayName = 'Admin';
                        }
                    }
                } else {
                    // Mode offline: fallback ke default (pertama kali setup)
                    if (u.toLowerCase() === 'authar' && p === 'Sedayu@123') {
                        loginOk = true; adminDisplayName = 'Admin';
                    }
                }

                if (!loginOk) {
                    alert("‚ùå Username atau Password Admin Salah!\n\nPeriksa kembali username dan password Anda.");
                    return;
                }

                // ‚îÄ‚îÄ Login berhasil ‚îÄ‚îÄ
                window.currentUserRole = 'admin';
                window.currentPengawasRuang = null;

                // ‚òÖ Simpan session ke sessionStorage agar bertahan saat refresh
                sessionStorage.setItem('integritest_staff_session', JSON.stringify({
                    role: 'admin',
                    displayName: adminDisplayName,
                    savedAt: Date.now()
                }));

                // ‚òÖ Simpan UID + role ke Firestore agar Firestore Rules bisa verifikasi
                try {
                    const uid = window.auth && window.auth.currentUser && window.auth.currentUser.uid;
                    if (uid && window.db) {
                        await setDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'authorized_uids', uid), {
                            role: 'admin',
                            username: u,
                            loginAt: Date.now()
                        });
                        window.currentUID = uid;
                    }
                } catch(uidErr) { console.warn('[Auth] UID save gagal:', uidErr); }
                if(window.setupRealtimeListener) window.setupRealtimeListener();
                if(window.listenForKelas) window.listenForKelas();
                if(window.listenForPaket) window.listenForPaket();
                if(window.listenForRuang) window.listenForRuang();
                if(window.listenForActiveSesi) window.listenForActiveSesi();

                document.getElementById('dash-header-title').textContent = 'Panel Admin / Koordinator';
                document.getElementById('dash-header-subtitle').textContent = `Akses Penuh ‚Äî Login sebagai: ${adminDisplayName}`;
                document.getElementById('dash-header-icon').className = 'bg-indigo-600 p-2 rounded-lg';
                document.getElementById('pengawas-room-badge').classList.add('hidden');
                document.getElementById('pengawas-exam-info').classList.add('hidden');
                // Tampilkan info judul ujian di header admin (jika sudah diset)
                const _adminInfoWrap = document.getElementById('admin-exam-info');
                const _savedAppAdmin = window._savedAppearance || {};
                if (_adminInfoWrap) {
                    const _aj = document.getElementById('admin-exam-judul');
                    const _as = document.getElementById('admin-exam-sub');
                    if (_aj) _aj.textContent = (_savedAppAdmin.judulUjian || '').trim();
                    if (_as) _as.textContent = (_savedAppAdmin.subJudul   || '').trim();
                    if (_savedAppAdmin.judulUjian || _savedAppAdmin.subJudul) { _adminInfoWrap.classList.remove('hidden'); _adminInfoWrap.style.display = 'flex'; }
                    else { _adminInfoWrap.classList.add('hidden'); _adminInfoWrap.style.display = ''; }
                }
                // Sembunyikan card token (khusus pengawas, bukan admin)
                const _tkCardAdmin = document.getElementById('pengawas-token-card');
                if (_tkCardAdmin) _tkCardAdmin.classList.add('hidden');

                document.querySelectorAll('.admin-only-tab').forEach(el => el.classList.remove('hidden'));
                // Sesuaikan lebar bottom nav mobile saat admin (semua tab tampil)
                const mobileNav = document.getElementById('mobile-bottom-nav');
                if (mobileNav) mobileNav.style.display = '';

                document.getElementById('section-login').classList.add('hidden-section');
                document.getElementById('section-dashboard').classList.remove('hidden-section');
                // Delay kecil agar DOM selesai render (terutama di HP)
                requestAnimationFrame(() => { window.switchDashTab('welcome'); });

                const teacherInput = document.getElementById('teacher-token-input');
                if(teacherInput) teacherInput.value = window.currentExamToken;
                if(typeof lucide !== 'undefined') lucide.createIcons();

                // Pastikan dropdown analitik terisi setelah semua listener siap
                // Delay cukup panjang agar Firestore sempat mengembalikan data
                setTimeout(() => {
                    if (window.renderIntegrityDashboard) window.renderIntegrityDashboard();
                }, 1500);

            } finally {
                if (btn) { btn.disabled = false; btn.textContent = "Masuk"; }
            }
        };

        window.handlePengawasLogin = function(e) {
            e.preventDefault();
            const ruangId = document.getElementById('pengawas-room-select').value;
            const passInput = document.getElementById('pengawas-pass').value.trim().toUpperCase();

            if (!ruangId) { alert("Silakan pilih ruang ujian terlebih dahulu!"); return; }

            const ruang = (window.ruangList || []).find(r => r.id === ruangId);
            if (!ruang) { alert("Ruang tidak ditemukan. Hubungi Admin."); return; }

            if (!ruang.password || passInput !== ruang.password.trim().toUpperCase()) {
                alert("‚ùå Password Ruang Salah!\n\nPastikan kamu memasukkan password yang benar untuk " + ruang.nama);
                return;
            }

            // Login berhasil sebagai pengawas
            window.currentUserRole = 'pengawas';
            window.currentPengawasRuang = ruang;

            // ‚òÖ Simpan session ke sessionStorage agar bertahan saat refresh
            sessionStorage.setItem('integritest_staff_session', JSON.stringify({
                role: 'pengawas',
                ruang: ruang,
                savedAt: Date.now()
            }));

            // ‚òÖ Simpan UID + role pengawas ke Firestore
            try {
                const uid = window.auth && window.auth.currentUser && window.auth.currentUser.uid;
                if (uid && window.db) {
                    setDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'authorized_uids', uid), {
                        role: 'pengawas',
                        ruangId: ruang.id,
                        ruangNama: ruang.nama,
                        loginAt: Date.now()
                    });
                    window.currentUID = uid;
                }
            } catch(uidErr) { console.warn('[Auth] UID save:', uidErr); }

            if(window.setupRealtimeListener) window.setupRealtimeListener();
            if(window.listenForKelas) window.listenForKelas();
            if(window.listenForPaket) window.listenForPaket();

            // Update header untuk pengawas
            document.getElementById('dash-header-title').textContent = 'Monitoring Ruang';
            document.getElementById('dash-header-subtitle').textContent = `Pengawas ${ruang.nama}`;
            document.getElementById('dash-header-icon').className = 'bg-amber-500 p-2 rounded-lg';
            // Sembunyikan info ujian admin header
            const _adminInfoHide = document.getElementById('admin-exam-info');
            if (_adminInfoHide) { _adminInfoHide.classList.add('hidden'); _adminInfoHide.style.display = ''; }
            // Tampilkan info ujian di kanan header
            const _app = window._savedAppearance || {};
            const _judulEl = document.getElementById('pengawas-exam-judul');
            const _subEl   = document.getElementById('pengawas-exam-sub');
            const _infoWrap = document.getElementById('pengawas-exam-info');
            if (_judulEl) _judulEl.textContent = _app.judulUjian || '';
            if (_subEl)   _subEl.textContent   = _app.subJudul   || '';
            if (_infoWrap && (_app.judulUjian || _app.subJudul)) _infoWrap.classList.remove('hidden');
            const badge = document.getElementById('pengawas-room-badge');
            badge.classList.remove('hidden');
            badge.classList.add('flex');
            document.getElementById('pengawas-room-label').textContent = ruang.nama;

            // Tampilkan card token di dashboard pengawas
            const tokenCard = document.getElementById('pengawas-token-card');
            if (tokenCard) { tokenCard.classList.remove('hidden'); }
            if (window.updatePengawasTokenDisplay) window.updatePengawasTokenDisplay();

            // Sembunyikan tab & elemen yang hanya untuk admin ‚Äî HARUS sebelum switchDashTab
            document.querySelectorAll('.admin-only-tab').forEach(el => el.classList.add('hidden'));
            // Mobile bottom nav: sesuaikan lebar karena hanya 2 tab yang tampil untuk pengawas
            document.querySelectorAll('.admin-only-el').forEach(el => el.classList.add('hidden'));

            // Buka dashboard dan paksa tab Monitoring Nilai aktif
            document.getElementById('section-login').classList.add('hidden-section');
            document.getElementById('section-dashboard').classList.remove('hidden-section');
            // switchDashTab dipanggil SETELAH hide agar class 'hidden' sudah ada saat className di-set ulang
            window.switchDashTab('nilai');

            // Load data untuk pengawas
            if(window.listenForActiveSesi) window.listenForActiveSesi();
            if(window.setupRealtimeListener) window.setupRealtimeListener();
            if(window.listenForKelas) window.listenForKelas();
            if(window.listenForPaket) window.listenForPaket();

            // Set filter ruang otomatis ke ruang pengawas
            const filterRuang = document.getElementById('filter-ruang');
            if (filterRuang) {
                setTimeout(() => {
                    filterRuang.value = ruang.nama;
                    if (!filterRuang.value) filterRuang.value = ruangId;
                    window.filterDashboard();
                }, 900);
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.handleTeacherLogin = function(e) {
            // Wrapper lama, sekarang diarahkan ke admin login
            e.preventDefault();
            window.handleAdminLogin(e);
        };

        window.changeQuestion = function(delta) {
            const newIndex = currentQuestionIndex + delta;
            if (newIndex >= 0 && newIndex < currentQuestionList.length) {
                currentQuestionIndex = newIndex;
                renderQuestion();
            }
        };

        window.toggleSidebar = function() {
            const sidebar = document.getElementById('exam-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('sidebar-closed')) {
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.remove('sidebar-open');
                sidebar.classList.add('sidebar-closed');
                overlay.classList.add('hidden');
            }
        };

        // --- CONFIRM FINISH EXAM WITH ANTI-SUBMIT CHECK ---
        window.confirmFinishExam = function() {
            // NEW: Anti-Submit Check ‚Äî gunakan modal internal, BUKAN alert() agar tidak trigger anti-cheat
            if (window.currentMinExamDuration > 0 && window.examStartTime) {
                const elapsedMs = Date.now() - window.examStartTime;
                const elapsedMin = elapsedMs / 60000;
                
                if (elapsedMin < window.currentMinExamDuration) {
                    const remaining = Math.ceil(window.currentMinExamDuration - elapsedMin);
                    // Tampilkan modal internal (bukan alert browser) agar tidak memicu anti-cheat
                    window._suppressCheat = true;
                    document.getElementById('early-submit-msg').innerText = 
                        `Anda baru bisa mengumpulkan jawaban setelah ${window.currentMinExamDuration} menit pertama berlalu.\nSilakan periksa kembali jawaban Anda.`;
                    document.getElementById('early-submit-remaining').innerText = 
                        `‚è≥ Sisa waktu tunggu: ${remaining} menit lagi`;
                    document.getElementById('modal-early-submit').classList.remove('hidden');
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                    return;
                }
            }

            const answeredCount = Object.keys(userAnswers).filter(k => {
                const v = userAnswers[k];
                const q = (currentQuestionList || []).find(x => x.id === k);
                if (q && q.tipe === 'essay') return v && v.text && v.text.trim().length > 0;
                return !(Array.isArray(v) && v.length === 0);
            }).length;
            const total = currentQuestionList.length;
            
            let msg = "Apakah Anda yakin ingin menyelesaikan ujian?";
            if (answeredCount < total) {
                msg = `PERHATIAN: Masih ada ${total - answeredCount} soal yang belum dijawab! Yakin mau selesai?`;
            }
            
            document.getElementById('modal-desc').innerText = msg;
            
            // Set suppress agar blur saat modal terbuka tidak dianggap curang
            window._suppressCheat = true;
            const modal = document.getElementById('modal-confirm');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        };

        window.closeModal = function() {
            window._suppressCheat = false;
            const modal = document.getElementById('modal-confirm');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        };

        window.finalFinish = function() {
            window._suppressCheat = false;
            const modal = document.getElementById('modal-confirm');
            modal.classList.remove('show');
            // Tunggu animasi modal selesai baru panggil finishExam
            setTimeout(() => {
                modal.classList.add('hidden');
                finishExam();
            }, 250);
        };

        window.logout = function() {
            sessionStorage.removeItem('integritest_staff_session');
            location.reload();
        };

        // ‚òÖ RESTORE SESSION setelah refresh halaman
        // Membaca sessionStorage dan mengembalikan state login admin/pengawas
        // tanpa perlu login ulang, selama tab browser masih terbuka.
        window.restoreStaffSession = function() {
            const raw = sessionStorage.getItem('integritest_staff_session');
            if (!raw) return; // tidak ada sesi tersimpan, tampilkan login normal

            let session;
            try { session = JSON.parse(raw); } catch(e) { sessionStorage.removeItem('integritest_staff_session'); return; }

            // Tolak session lebih dari 12 jam (keamanan)
            if (!session.savedAt || (Date.now() - session.savedAt) > 12 * 60 * 60 * 1000) {
                sessionStorage.removeItem('integritest_staff_session');
                return;
            }

            if (session.role === 'admin') {
                // ‚îÄ‚îÄ Restore admin session ‚îÄ‚îÄ
                window.currentUserRole = 'admin';
                window.currentPengawasRuang = null;

                if(window.setupRealtimeListener) window.setupRealtimeListener();
                if(window.listenForKelas) window.listenForKelas();
                if(window.listenForPaket) window.listenForPaket();
                if(window.listenForRuang) window.listenForRuang();
                if(window.listenForActiveSesi) window.listenForActiveSesi();

                const adminDisplayName = session.displayName || 'Admin';
                document.getElementById('dash-header-title').textContent = 'Panel Admin / Koordinator';
                document.getElementById('dash-header-subtitle').textContent = `Akses Penuh ‚Äî Login sebagai: ${adminDisplayName}`;
                document.getElementById('dash-header-icon').className = 'bg-indigo-600 p-2 rounded-lg';
                document.getElementById('pengawas-room-badge').classList.add('hidden');
                document.getElementById('pengawas-exam-info').classList.add('hidden');
                // Tampilkan info judul ujian di header admin (jika sudah diset)
                const _adminInfoWrapR = document.getElementById('admin-exam-info');
                const _savedAppRestore = window._savedAppearance || {};
                if (_adminInfoWrapR) {
                    const _ajR = document.getElementById('admin-exam-judul');
                    const _asR = document.getElementById('admin-exam-sub');
                    if (_ajR) _ajR.textContent = (_savedAppRestore.judulUjian || '').trim();
                    if (_asR) _asR.textContent = (_savedAppRestore.subJudul   || '').trim();
                    if (_savedAppRestore.judulUjian || _savedAppRestore.subJudul) { _adminInfoWrapR.classList.remove('hidden'); _adminInfoWrapR.style.display = 'flex'; }
                    else { _adminInfoWrapR.classList.add('hidden'); _adminInfoWrapR.style.display = ''; }
                }
                // Sembunyikan card token (khusus pengawas)
                const _tkCardRestore = document.getElementById('pengawas-token-card');
                if (_tkCardRestore) _tkCardRestore.classList.add('hidden');
                document.querySelectorAll('.admin-only-tab').forEach(el => el.classList.remove('hidden'));
                const mobileNav = document.getElementById('mobile-bottom-nav');
                if (mobileNav) mobileNav.style.display = '';

                document.getElementById('section-login').classList.add('hidden-section');
                document.getElementById('section-dashboard').classList.remove('hidden-section');
                requestAnimationFrame(() => { window.switchDashTab('welcome'); });

                const teacherInput = document.getElementById('teacher-token-input');
                if (teacherInput) teacherInput.value = window.currentExamToken;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                setTimeout(() => { if (window.renderIntegrityDashboard) window.renderIntegrityDashboard(); }, 800);

                console.log('[Session] Admin session restored');

            } else if (session.role === 'pengawas' && session.ruang) {
                // ‚îÄ‚îÄ Restore pengawas session ‚îÄ‚îÄ
                const ruang = session.ruang;

                // Verifikasi ruang masih ada di ruangList (bisa berubah kalau admin hapus)
                // Kalau ruangList belum dimuat, pakai data dari session langsung
                window.currentUserRole = 'pengawas';
                window.currentPengawasRuang = ruang;

                if(window.setupRealtimeListener) window.setupRealtimeListener();
                if(window.listenForKelas) window.listenForKelas();
                if(window.listenForPaket) window.listenForPaket();
                if(window.listenForRuang) window.listenForRuang();
                if(window.listenForActiveSesi) window.listenForActiveSesi();

                document.getElementById('dash-header-title').textContent = 'Monitoring Ruang';
                document.getElementById('dash-header-subtitle').textContent = `Pengawas ${ruang.nama}`;
                document.getElementById('dash-header-icon').className = 'bg-amber-500 p-2 rounded-lg';
                // Tampilkan info ujian di kanan header
                const _app2 = window._savedAppearance || {};
                const _judulEl2  = document.getElementById('pengawas-exam-judul');
                const _subEl2    = document.getElementById('pengawas-exam-sub');
                const _infoWrap2 = document.getElementById('pengawas-exam-info');
                if (_judulEl2)  _judulEl2.textContent  = _app2.judulUjian || '';
                if (_subEl2)    _subEl2.textContent    = _app2.subJudul   || '';
                if (_infoWrap2 && (_app2.judulUjian || _app2.subJudul)) _infoWrap2.classList.remove('hidden');
                const badge = document.getElementById('pengawas-room-badge');
                badge.classList.remove('hidden');
                badge.classList.add('flex');
                document.getElementById('pengawas-room-label').textContent = ruang.nama;

                // Tampilkan card token di dashboard pengawas (restore session)
                const tokenCardRestore = document.getElementById('pengawas-token-card');
                if (tokenCardRestore) { tokenCardRestore.classList.remove('hidden'); }
                if (window.updatePengawasTokenDisplay) window.updatePengawasTokenDisplay();

                document.querySelectorAll('.admin-only-tab').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.admin-only-el').forEach(el => el.classList.add('hidden'));

                document.getElementById('section-login').classList.add('hidden-section');
                document.getElementById('section-dashboard').classList.remove('hidden-section');
                window.switchDashTab('nilai');

                const filterRuangEl = document.getElementById('filter-ruang');
                if (filterRuangEl) { filterRuangEl.value = ruang.nama; filterRuangEl.disabled = true; }

                if (typeof lucide !== 'undefined') lucide.createIcons();
                console.log('[Session] Pengawas session restored:', ruang.nama);
            }
        };
        
        // ====================================================
        // PAGINATION ENGINE ‚Äî shared across all sections
        // ====================================================
        window._pg = {
            monitoring: { page: 1, perPage: 15 },
            paket:      { page: 1, perPage: 9  },
            soal:       { page: 1, perPage: 10 },
            kelas:      { page: 1, perPage: 15 },
            ruang:      { page: 1, perPage: 15 },
            analitik:   { page: 1, perPage: 15 },
        };

        // Render a pager control into a wrapper element
        function renderPagerHTML(section, total, page, perPage) {
            const totalPages = Math.max(1, Math.ceil(total / perPage));
            page = Math.max(1, Math.min(page, totalPages));
            if (total === 0) return '';

            const start = (page - 1) * perPage + 1;
            const end   = Math.min(page * perPage, total);

            const mkBtn = (label, p, disabled, active) =>
                `<button onclick="window.goPage('${section}',${p})"
                    class="min-w-[32px] h-8 px-2 text-xs font-bold rounded-lg border transition-all
                    ${active   ? 'bg-blue-600 text-white border-blue-600 shadow-sm' :
                      disabled ? 'bg-gray-50 text-gray-300 border-gray-100 cursor-default pointer-events-none' :
                                 'bg-white text-gray-600 border-gray-300 hover:bg-blue-50 hover:border-blue-400'}"
                    ${disabled ? 'disabled' : ''}>${label}</button>`;

            let pages = '';
            for (let p = 1; p <= totalPages; p++) {
                const near = p >= page - 2 && p <= page + 2;
                const edge = p === 1 || p === totalPages;
                if (edge || near) {
                    pages += mkBtn(p, p, false, p === page);
                } else if (p === page - 3 || p === page + 3) {
                    pages += `<span class="text-gray-400 text-xs px-1">‚Ä¶</span>`;
                }
            }

            return `<div class="flex items-center justify-between px-5 py-3 bg-gray-50 border-t rounded-b-xl text-sm">
                <span class="text-xs text-gray-500">
                    Data <span class="font-bold text-gray-700">${start}‚Äì${end}</span> dari <span class="font-bold text-gray-700">${total}</span>
                </span>
                <div class="flex items-center gap-1">
                    ${mkBtn('‚Äπ Prev', page-1, page<=1, false)}
                    ${pages}
                    ${mkBtn('Next ‚Ä∫', page+1, page>=totalPages, false)}
                </div>
            </div>`;
        }

        // Called by pager buttons
        window.goPage = function(section, p) {
            if (!window._pg[section]) return;
            window._pg[section].page = p;
            const map = {
                monitoring: () => filterDashboardInternal(),
                paket:      () => window.renderPaketGrid(),
                soal:       () => window.filterQuestionBank(),
                kelas:      () => window.renderKelasList(),
                ruang:      () => window.renderRuangList(),
                analitik:   () => window.renderIntegrityDashboard(),
            };
            if (map[section]) map[section]();
        };
        // ====================================================

        window.filterDashboard = function() {
            filterDashboardInternal();
        };

        window.exportToCSV = function() {
            exportToExcelInternal(); // legacy alias
        };
        window.exportToExcel = function() {
            exportToExcelInternal();
        };

        // ‚îÄ‚îÄ STATISTIK KELAS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.showKelasStatistikModal = function() {
            const modal = document.getElementById('modal-kelas-statistik');
            if (!modal) return;
            modal.classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();

            const data = (window.currentFilteredData || window._allDashboardData || [])
                .filter(r => r.status !== 'SEDANG MENGERJAKAN' && !r.status.includes('MELANJUTKAN'));

            const content = document.getElementById('kelas-statistik-content');
            if (!content) return;

            if (data.length === 0) {
                content.innerHTML = `<div class="text-center py-12 text-gray-400">
                    <i data-lucide="inbox" class="w-10 h-10 mx-auto mb-2 text-gray-300"></i>
                    <p class="font-semibold">Belum ada data yang selesai ujian</p>
                    <p class="text-xs mt-1">Statistik akan muncul setelah siswa menyelesaikan ujian.</p>
                </div>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // Group by kelas
            const byKelas = {};
            data.forEach(r => {
                const cls = r.className || 'Tidak Diketahui';
                if (!byKelas[cls]) byKelas[cls] = [];
                byKelas[cls].push(r);
            });

            // Hitung statistik keseluruhan
            const allScores = data.map(r => typeof r.score === 'number' ? r.score : parseFloat(r.score)).filter(s => !isNaN(s));
            const grandAvg = allScores.length ? (allScores.reduce((a,b)=>a+b,0)/allScores.length).toFixed(1) : '-';
            const grandLulus = allScores.filter(s => s >= 75).length;
            const grandPct = allScores.length ? Math.round((grandLulus/allScores.length)*100) : 0;
            const grandDQ = data.filter(r => (r.status||'').includes('DISKUALIFIKASI')).length;

            // Build HTML
            let html = `
                <!-- Summary cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-black text-blue-700">${data.length}</div>
                        <div class="text-xs text-blue-500 font-semibold mt-1">Total Selesai</div>
                    </div>
                    <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-black text-emerald-700">${grandAvg}</div>
                        <div class="text-xs text-emerald-500 font-semibold mt-1">Rata-rata Nilai</div>
                    </div>
                    <div class="bg-violet-50 border border-violet-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-black text-violet-700">${grandPct}%</div>
                        <div class="text-xs text-violet-500 font-semibold mt-1">Tingkat Lulus</div>
                    </div>
                    <div class="bg-red-50 border border-red-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-black text-red-600">${grandDQ}</div>
                        <div class="text-xs text-red-400 font-semibold mt-1">Diskualifikasi</div>
                    </div>
                </div>

                <!-- Per kelas -->
                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                    <i data-lucide="layers" class="w-4 h-4 text-violet-500"></i> Detail Per Kelas
                </h4>
                <div class="space-y-3">
            `;

            Object.entries(byKelas).sort().forEach(([kelas, rows]) => {
                const scores = rows.map(r => typeof r.score === 'number' ? r.score : parseFloat(r.score)).filter(s => !isNaN(s));
                const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1) : '-';
                const max = scores.length ? Math.max(...scores) : '-';
                const min = scores.length ? Math.min(...scores) : '-';
                const lulus = scores.filter(s => s >= 75).length;
                const tLulus = scores.filter(s => s < 75).length;
                const pct = scores.length ? Math.round((lulus/scores.length)*100) : 0;
                const dq  = rows.filter(r => (r.status||'').includes('DISKUALIFIKASI')).length;
                const pctColor = pct >= 75 ? 'text-emerald-600 bg-emerald-50' : pct >= 50 ? 'text-amber-600 bg-amber-50' : 'text-red-600 bg-red-50';
                const avgColor = parseFloat(avg) >= 75 ? 'text-emerald-700' : parseFloat(avg) >= 60 ? 'text-amber-600' : 'text-red-600';
                const barW = Math.max(4, pct);

                html += `
                <div class="border border-gray-200 rounded-xl overflow-hidden bg-white shadow-sm">
                    <div class="flex items-center justify-between px-5 py-3 bg-gray-50 border-b border-gray-100">
                        <div class="flex items-center gap-2">
                            <i data-lucide="users" class="w-4 h-4 text-indigo-500"></i>
                            <span class="font-bold text-gray-800 text-sm">${kelas}</span>
                            <span class="text-xs text-gray-400 font-medium">${rows.length} peserta</span>
                        </div>
                        <span class="text-xs font-black px-3 py-1 rounded-full ${pctColor}">${pct}% Lulus</span>
                    </div>
                    <div class="px-5 py-3">
                        <!-- Progress bar lulus -->
                        <div class="flex items-center gap-2 mb-3">
                            <div class="flex-1 bg-gray-100 rounded-full h-2 overflow-hidden">
                                <div class="h-2 rounded-full ${pct>=75?'bg-emerald-500':pct>=50?'bg-amber-400':'bg-red-400'} transition-all duration-500" style="width:${barW}%"></div>
                            </div>
                            <span class="text-xs text-gray-500 font-medium w-8">${pct}%</span>
                        </div>
                        <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-center text-xs">
                            <div class="bg-gray-50 rounded-lg p-2">
                                <div class="font-black ${avgColor} text-lg">${avg}</div>
                                <div class="text-gray-400 mt-0.5">Rata-rata</div>
                            </div>
                            <div class="bg-emerald-50 rounded-lg p-2">
                                <div class="font-black text-emerald-700 text-lg">${max}</div>
                                <div class="text-emerald-400 mt-0.5">Tertinggi</div>
                            </div>
                            <div class="bg-red-50 rounded-lg p-2">
                                <div class="font-black text-red-600 text-lg">${min}</div>
                                <div class="text-red-300 mt-0.5">Terendah</div>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-2">
                                <div class="font-black text-blue-700 text-lg">${lulus}</div>
                                <div class="text-blue-400 mt-0.5">Lulus</div>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-2">
                                <div class="font-black text-orange-600 text-lg">${tLulus}</div>
                                <div class="text-orange-400 mt-0.5">Tidak Lulus</div>
                            </div>
                            <div class="bg-red-50 rounded-lg p-2">
                                <div class="font-black text-red-700 text-lg">${dq}</div>
                                <div class="text-red-400 mt-0.5">DQ</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            html += `</div>`;
            content.innerHTML = html;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.closeKelasStatistikModal = function() {
            const modal = document.getElementById('modal-kelas-statistik');
            if (modal) modal.classList.add('hidden');
        };

        // ‚òÖ UPDATE DISCUSSION STATUS AFTER EXAM (NEW) ‚òÖ
        window.updateDiscussionStatus = function() {
            const btn = document.getElementById('btn-review');
            const statusDiv = document.getElementById('discussion-status');

            if (!window.showDiscussionAfterExam) {
                // Pembahasan dinonaktifkan sama sekali
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                statusDiv.classList.remove('hidden');
                statusDiv.innerHTML = 'üîí Admin telah menonaktifkan pembahasan untuk ujian ini.';
                return;
            }

            if (window.discussionVisibility === 'never') {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                statusDiv.classList.remove('hidden');
                statusDiv.innerHTML = 'üîí Pembahasan tidak tersedia.';
                return;
            }

            if (window.discussionVisibility === 'manual') {
                if (!window.manualDiscussionOpen) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    statusDiv.classList.remove('hidden');
                    statusDiv.innerHTML = '‚è≥ Pembahasan belum dibuka. Tunggu pengumuman dari admin.';
                    return;
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    statusDiv.classList.add('hidden');
                    return;
                }
            }

            // Mode 'after-exam' dan 'after-deadline' - pembahasan tersedia
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            statusDiv.classList.add('hidden');
        };

        window.toggleReview = function() {
            // ‚òÖ CEK IZIN PEMBAHASAN ‚òÖ
            if (!window.isDiscussionAllowed()) {
                alert('‚õî Pembahasan belum tersedia. Admin akan membuka pembahasan pada waktu yang ditentukan.');
                return;
            }

            const reviewContainer = document.getElementById('review-container');
            const btn = document.getElementById('btn-review');
            
            if(reviewContainer.classList.contains('hidden')) {
                reviewContainer.classList.remove('hidden');
                btn.innerHTML = `<i data-lucide="eye-off" class="w-5 h-5"></i> Tutup Pembahasan`;
                setTimeout(() => {
                    reviewContainer.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            } else {
                reviewContainer.classList.add('hidden');
                btn.innerHTML = `<i data-lucide="book-open" class="w-5 h-5"></i> Lihat Pembahasan`;
                document.getElementById('section-result').scrollTo({ top: 0, behavior: 'smooth' });
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function renderQuestion() {
            if(!currentQuestionList || !currentQuestionList[currentQuestionIndex]) return;
            const q = currentQuestionList[currentQuestionIndex];
            const container = document.getElementById('question-area');
            const total = currentQuestionList.length;
            const labels = ['A','B','C','D','E'];
            const isMultiple = q.tipe === 'multiple';
            const isTrueFalse = q.tipe === 'truefalse';
            const isEssay = q.tipe === 'essay';

            let optionsHTML = '';

            if (isEssay) {
                const userText = (userAnswers[q.id] && userAnswers[q.id].text) ? userAnswers[q.id].text : '';
                optionsHTML = `
                    <div class="mt-2">
                        <label class="block text-xs font-bold text-purple-600 mb-2 flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            Tulis Jawaban Kamu
                        </label>
                        <textarea
                            id="essay-input-${q.id}"
                            rows="6"
                            class="w-full px-4 py-3 border-2 border-purple-200 rounded-xl outline-none focus:ring-2 focus:ring-purple-400 focus:border-purple-400 text-sm resize-none bg-white transition-colors"
                            placeholder="Tulis jawaban uraianmu di sini..."
                            oninput="saveEssayAnswer('${q.id}', this.value)"
                        >${userText}</textarea>
                        <div class="flex items-center justify-between mt-1">
                            <p class="text-xs text-purple-500">Jawab selengkap mungkin sesuai pemahaman kamu.</p>
                            <p class="text-xs text-gray-400" id="essay-charcount-${q.id}">${userText.length} karakter</p>
                        </div>
                    </div>
                `;
            } else if (isTrueFalse) {
                // Render dua tombol besar: BENAR dan SALAH
                const userAns = userAnswers[q.id]; // true, false, or undefined
                const benarSel = userAns === true;
                const salahSel = userAns === false;

                const benarClass = benarSel
                    ? "flex-1 flex flex-col items-center justify-center gap-2 p-6 rounded-2xl border-2 border-green-500 bg-green-50 ring-2 ring-green-400 cursor-pointer transition-all"
                    : "flex-1 flex flex-col items-center justify-center gap-2 p-6 rounded-2xl border-2 border-gray-200 bg-white hover:bg-green-50 hover:border-green-300 cursor-pointer transition-all";
                const salahClass = salahSel
                    ? "flex-1 flex flex-col items-center justify-center gap-2 p-6 rounded-2xl border-2 border-red-500 bg-red-50 ring-2 ring-red-400 cursor-pointer transition-all"
                    : "flex-1 flex flex-col items-center justify-center gap-2 p-6 rounded-2xl border-2 border-gray-200 bg-white hover:bg-red-50 hover:border-red-300 cursor-pointer transition-all";

                optionsHTML = `
                    <div class="flex gap-4 mt-2">
                        <div class="${benarClass}" onclick="saveAnswer('${q.id}', true, false, false, this)">
                            <div class="w-14 h-14 rounded-full flex items-center justify-center ${benarSel ? 'bg-green-500' : 'bg-gray-100'}">
                                <svg class="w-8 h-8 ${benarSel ? 'text-white' : 'text-gray-400'}" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                            </div>
                            <span class="font-black text-xl ${benarSel ? 'text-green-700' : 'text-gray-500'}">BENAR</span>
                        </div>
                        <div class="${salahClass}" onclick="saveAnswer('${q.id}', false, false, false, this)">
                            <div class="w-14 h-14 rounded-full flex items-center justify-center ${salahSel ? 'bg-red-500' : 'bg-gray-100'}">
                                <svg class="w-8 h-8 ${salahSel ? 'text-white' : 'text-gray-400'}" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                            </div>
                            <span class="font-black text-xl ${salahSel ? 'text-red-700' : 'text-gray-500'}">SALAH</span>
                        </div>
                    </div>
                `;
            } else {
                // For multiple choice, userAnswers[q.id] is an array; for single it's an index
                q.options.forEach((opt, optIdx) => {
                    let isSelected;
                    if (isMultiple) {
                        const ans = userAnswers[q.id];
                        isSelected = Array.isArray(ans) && ans.includes(optIdx);
                    } else {
                        isSelected = userAnswers[q.id] === optIdx;
                    }

                    const activeClass = isSelected
                        ? (isMultiple ? "border-emerald-500 bg-emerald-50 ring-2 ring-emerald-400" : "border-blue-500 bg-blue-50 ring-2 ring-blue-400")
                        : "border-gray-200 hover:bg-gray-50 hover:border-gray-300";

                    const indicatorClass = isSelected
                        ? (isMultiple
                            ? "w-7 h-7 rounded-lg bg-emerald-600 flex items-center justify-center shrink-0 text-white font-bold text-sm shadow"
                            : "w-7 h-7 rounded-full bg-blue-600 flex items-center justify-center shrink-0 text-white font-bold text-sm shadow")
                        : (isMultiple
                            ? "w-7 h-7 rounded-lg border-2 border-gray-300 flex items-center justify-center shrink-0 text-gray-400 font-bold text-sm"
                            : "w-7 h-7 rounded-full border-2 border-gray-300 flex items-center justify-center shrink-0 text-gray-400 font-bold text-sm");

                    const checkIcon = isSelected && isMultiple ? `<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>` : labels[optIdx];

                    const optImg = (q.optionImages && q.optionImages[optIdx]) ? q.optionImages[optIdx] : '';
                    const imgHtml = optImg
                        ? `<img src="${optImg}" alt="Gambar pilihan ${labels[optIdx]}" class="mt-2 max-h-28 rounded-lg border object-contain bg-white w-full" onerror="this.style.display='none'">`
                        : '';

                    const innerLayout = optImg
                        ? `<div class="flex flex-col w-full">
                                <div class="flex items-center gap-3">
                                    <div class="${indicatorClass}">${checkIcon}</div>
                                    ${opt ? `<span class="text-gray-700 text-sm md:text-base font-medium">${opt}</span>` : ''}
                                </div>
                                ${imgHtml}
                           </div>`
                        : `<div class="${indicatorClass}">${checkIcon}</div>
                           <span class="text-gray-700 text-base md:text-lg ml-3">${opt}</span>`;

                    optionsHTML += `
                        <label class="flex items-center p-4 rounded-xl border-2 cursor-pointer transition-all mb-3 ${activeClass}" onclick="saveAnswer('${q.id}', ${optIdx}, ${isMultiple}, false, this)">
                            ${innerLayout}
                        </label>
                    `;
                });
            }

            // Badge tipe soal
            const tipeBadge = isEssay
                ? `<span class="inline-flex items-center gap-1 bg-purple-100 text-purple-700 px-2.5 py-1 rounded-lg text-xs font-bold ml-2"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg> Esai</span>`
                : isTrueFalse
                    ? `<span class="inline-flex items-center gap-1 bg-amber-100 text-amber-700 px-2.5 py-1 rounded-lg text-xs font-bold ml-2"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg> Benar / Salah</span>`
                    : isMultiple
                        ? `<span class="inline-flex items-center gap-1 bg-emerald-100 text-emerald-700 px-2.5 py-1 rounded-lg text-xs font-bold ml-2"><svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Jawaban Ganda</span>`
                        : '';

            // Gambar soal
            const qImgHtml = q.image
                ? `<div class="my-4 flex justify-center">
                       <img src="${q.image}" alt="Gambar soal" class="max-h-64 rounded-xl border border-gray-200 shadow-sm object-contain bg-white cursor-zoom-in" onclick="window.openImgZoom(this.src)" onerror="this.parentElement.remove()">
                       <p class="text-xs text-gray-400 text-center mt-1">Klik gambar untuk perbesar</p>
                   </div>`
                : '';

            const questionText = q.text
                ? `<p class="text-lg md:text-xl text-gray-800 font-medium leading-relaxed">${q.text}</p>`
                : '';

            const hintBox = isMultiple
                ? `<div class="flex items-center gap-2 bg-emerald-50 border border-emerald-200 rounded-xl px-3 py-2 mb-3">
                        <svg class="w-4 h-4 text-emerald-600 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <p class="text-xs text-emerald-700 font-semibold">Pilih semua jawaban yang benar (bisa lebih dari satu)</p>
                   </div>`
                : isTrueFalse
                    ? `<div class="flex items-center gap-2 bg-amber-50 border border-amber-200 rounded-xl px-3 py-2 mb-3">
                            <svg class="w-4 h-4 text-amber-600 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <p class="text-xs text-amber-700 font-semibold">Apakah pernyataan di atas BENAR atau SALAH?</p>
                       </div>`
                    : isEssay
                        ? `<div class="flex items-center gap-2 bg-purple-50 border border-purple-200 rounded-xl px-3 py-2 mb-3">
                                <svg class="w-4 h-4 text-purple-600 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <p class="text-xs text-purple-700 font-semibold">Soal uraian ‚Äî tulis jawaban selengkap mungkin. Dikoreksi guru/AI setelah ujian.</p>
                           </div>`
                        : '';

            const html = `
                <div class="bg-white rounded-xl shadow-sm border p-6 md:p-8 animate-fade-in">
                    <div class="flex flex-col gap-4">
                        <div class="flex justify-between items-start border-b pb-4 mb-2">
                            <div class="flex items-center flex-wrap gap-1">
                                <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded text-sm font-bold">Soal No. ${currentQuestionIndex + 1}</span>
                                ${tipeBadge}
                            </div>
                            <span class="text-xs text-gray-400">Dari ${total} soal</span>
                        </div>
                        ${questionText}
                        ${qImgHtml}
                        ${hintBox}
                        <div class="space-y-1 option-group" id="opts-${q.id}">
                            ${optionsHTML}
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            updateNavButtons();
            renderSidebarButtons();
        }

        // Zoom gambar soal
        window.openImgZoom = function(src) {
            let overlay = document.getElementById('img-zoom-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'img-zoom-overlay';
                overlay.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm cursor-zoom-out';
                overlay.onclick = () => overlay.remove();
                overlay.innerHTML = `<img src="" class="max-w-[90vw] max-h-[90vh] rounded-xl shadow-2xl object-contain" id="img-zoom-img">`;
                document.body.appendChild(overlay);
            }
            document.getElementById('img-zoom-img').src = src;
            overlay.classList.remove('hidden');
        };

        function updateNavButtons() {
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const btnFinish = document.getElementById('btn-finish-main');

            if(btnPrev) btnPrev.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === currentQuestionList.length - 1) {
                if(btnNext) btnNext.classList.add('hidden');
                if(btnFinish) btnFinish.classList.remove('hidden');
            } else {
                if(btnNext) btnNext.classList.remove('hidden');
                if(btnFinish) btnFinish.classList.add('hidden');
            }
        }

        function jumpToQuestion(idx) {
            currentQuestionIndex = idx;
            renderQuestion();
            if (window.innerWidth < 768) {
                window.toggleSidebar();
            }
        }

        window.saveEssayAnswer = function(qId, text) {
            if (!userAnswers[qId]) userAnswers[qId] = {};
            userAnswers[qId].text = text;
            // Update char count without re-rendering (avoids losing focus)
            const cc = document.getElementById('essay-charcount-' + qId);
            if (cc) cc.textContent = text.length + ' karakter';
            // Update sidebar dot (answered if non-empty)
            renderSidebarButtons();
        };

        window.saveAnswer = function(qId, optIdx, isMultiple, isTrueFalse, element) {
            if (isTrueFalse !== undefined && isTrueFalse === false && typeof optIdx === 'boolean') {
                // truefalse: optIdx is actually the boolean value (true/false)
                userAnswers[qId] = optIdx;
            } else if (isMultiple) {
                // Toggle: add or remove from array
                if (!Array.isArray(userAnswers[qId])) userAnswers[qId] = [];
                const arr = userAnswers[qId];
                const pos = arr.indexOf(optIdx);
                if (pos === -1) arr.push(optIdx);
                else arr.splice(pos, 1);
                // If empty array, remove key so sidebar shows unanswered
                if (arr.length === 0) delete userAnswers[qId];
                else userAnswers[qId] = arr;
            } else {
                userAnswers[qId] = optIdx;
            }
            renderQuestion();
        };

        function renderSidebarButtons() {
            const grid = document.getElementById('question-grid');
            if(!grid) return;
            grid.innerHTML = '';
            
            currentQuestionList.forEach((q, idx) => {
                const ans = userAnswers[q.id];
                const isEssayQ = q.tipe === 'essay';
                const isAnswered = isEssayQ
                    ? (ans && ans.text && ans.text.trim().length > 0)
                    : ans !== undefined && !(Array.isArray(ans) && ans.length === 0);
                const isActive = idx === currentQuestionIndex;
                
                let btnClass = "h-10 w-full rounded font-bold text-sm flex items-center justify-center transition-colors ";
                
                if (isActive) {
                    btnClass += "border-2 border-blue-600 bg-white text-blue-600";
                } else if (isAnswered) {
                    btnClass += "bg-green-500 text-white hover:bg-green-600";
                } else {
                    btnClass += "bg-slate-200 text-slate-600 hover:bg-slate-300";
                }

                const btn = document.createElement('button');
                btn.className = btnClass;
                btn.innerText = idx + 1;
                btn.onclick = () => jumpToQuestion(idx);
                grid.appendChild(btn);
            });
        }

        function startExamLogic() {
            timeLeft = (window.currentExamDuration || 60) * 60;
            
            examTimer = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                const timerDisplay = document.getElementById('timer-display');
                if(timerDisplay) timerDisplay.innerText = `${m}:${s}`;
                
                if (timeLeft < 300) { 
                    const timerBox = document.getElementById('timer-box');
                    if(timerBox) timerBox.className = "flex items-center gap-2 px-4 py-2 rounded-lg font-mono font-bold text-lg bg-red-100 text-red-600";
                }

                if (timeLeft <= 0) {
                    finishExam();
                }
            }, 1000);

            // --- LISTENERS ---
            document.addEventListener("visibilitychange", handleVisibility);
            window.addEventListener("blur", handleBlur); 
            
            // --- NEW: TOLERANSI ROTASI LAYAR ---
            // Saat HP diputar (resize), matikan deteksi blur sebentar
            window.addEventListener("resize", handleResizeToleransi);

            // ‚îÄ‚îÄ FULLSCREEN CHANGE: paksa kembali fullscreen jika siswa keluar (Esc) ‚îÄ‚îÄ
            function handleFullscreenChange() {
                const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
                if (!isFs && !isWarningActive) {
                    // Tampilkan peringatan terlebih dahulu, lalu saat klik "lanjut" fullscreen diminta lagi
                    registerViolation("Anda keluar dari layar penuh (Fullscreen)!");
                }
            }
            // Simpan ke window agar bisa di-remove dari finishExam (beda scope)
            window._handleFullscreenChange = handleFullscreenChange;
            document.addEventListener("fullscreenchange", handleFullscreenChange);
            document.addEventListener("webkitfullscreenchange", handleFullscreenChange);
            document.addEventListener("msfullscreenchange", handleFullscreenChange);
            
            document.addEventListener("contextmenu", e => e.preventDefault());

            history.pushState(null, null, location.href);
            window.onpopstate = function () {
                history.go(1);
            };
            window.onbeforeunload = function() {
                return "PERINGATAN: Ujian sedang berlangsung.";
            };
        }

        // --- NEW: FUNGSI HANDLER ROTASI ---
        function handleResizeToleransi() {
            isRotating = true;
            // Beri waktu 1.5 detik toleransi setelah layar diputar
            setTimeout(() => {
                isRotating = false;
            }, 1500);
        }

        function handleVisibility() {
            // Visibility change (pindah tab total/minimize) tetap dianggap curang
            // meski sedang rotasi, karena pindah tab != rotasi
            // Tapi JANGAN anggap curang jika modal submit sedang terbuka
            if (window._suppressCheat) return;
            if (document.hidden) {
                registerViolation("Anda meninggalkan tab ujian!");
            }
        }

        function handleBlur() {
            // JIKA SEDANG ROTASI (isRotating = true), JANGAN ANGGAP CURANG
            if (isRotating) return;
            // JIKA MODAL SUBMIT SEDANG TERBUKA, JANGAN ANGGAP CURANG
            if (window._suppressCheat) return;

            if (!document.hidden) {
                registerViolation("Terdeteksi interaksi di luar layar ujian (Aplikasi Mengambang/Notifikasi)!");
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ANTI-CHEAT ENGINE ‚Äî VERSI LENGKAP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ‚îÄ‚îÄ ALARM AUDIO 3 LAPIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _audioCtx = null;
        function playAlarm() {
            // Layer 1: Audio URL eksternal
            try {
                const a = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                a.volume = 1.0;
                a.play().catch(() => {});
            } catch(e) {}

            // Layer 2: Web Audio API ‚Äî sirine buatan sendiri (tidak bisa diblokir)
            try {
                if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const ctx = _audioCtx;
                const playTone = (freq, t0, dur) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(freq, t0);
                    osc.frequency.linearRampToValueAtTime(freq * 1.6, t0 + dur * 0.5);
                    osc.frequency.linearRampToValueAtTime(freq, t0 + dur);
                    gain.gain.setValueAtTime(0.45, t0);
                    gain.gain.exponentialRampToValueAtTime(0.001, t0 + dur);
                    osc.start(t0); osc.stop(t0 + dur);
                };
                const now = ctx.currentTime;
                playTone(880, now,       0.28);
                playTone(660, now + 0.30, 0.28);
                playTone(880, now + 0.60, 0.28);
                playTone(440, now + 0.90, 0.50);
            } catch(e) {}

            // Layer 3: Getaran HP Android (Vibrate API)
            try {
                if (navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 600]);
            } catch(e) {}
        }

        // ‚îÄ‚îÄ FLASH LAYAR MERAH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function flashScreen() {
            const flash = document.getElementById('warning-flash');
            if (!flash) return;
            let n = 0;
            const iv = setInterval(() => {
                flash.style.opacity = n % 2 === 0 ? '0.45' : '0';
                if (++n >= 8) { clearInterval(iv); flash.style.opacity = '0'; }
            }, 110);
        }

        // ‚îÄ‚îÄ WATERMARK NAMA SISWA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.renderWatermark = function(name) {
            const overlay = document.getElementById('watermark-overlay');
            const canvas  = document.getElementById('watermark-canvas');
            if (!overlay || !canvas) return;
            overlay.classList.remove('hidden');

            // HP Kentang: gunakan resolusi canvas lebih kecil (scale 0.5)
            const scale = window._perfMode ? 0.5 : 1;
            const W = Math.round(window.innerWidth  * scale);
            const H = Math.round(window.innerHeight * scale);
            canvas.width  = W;
            canvas.height = H;
            canvas.style.width  = '100%';
            canvas.style.height = '100%';

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, W, H);
            ctx.fillStyle = '#1e3a5f';
            ctx.font = `bold ${Math.round(18 * scale)}px Arial`;
            ctx.textAlign = 'center';
            const text = `${name} ‚Ä¢ INTEGRITEST ‚Ä¢ SMKN 1 BRONDONG`;
            ctx.save();
            ctx.translate(W / 2, H / 2);
            ctx.rotate(-28 * Math.PI / 180);
            const stepY = Math.round(200 * scale);
            const stepX = Math.round(380 * scale);
            for (let y = -H * 1.5; y < H * 1.5; y += stepY) {
                for (let x = -W * 1.5; x < W * 1.5; x += stepX) {
                    ctx.fillText(text, x, y);
                }
            }
            ctx.restore();
        };
        window.clearWatermark = function() {
            const o = document.getElementById('watermark-overlay');
            if (o) o.classList.add('hidden');
        };
        // Redraw saat resize / rotasi layar ‚Äî THROTTLE 500ms untuk HP kentang
        let _wmResizeTimer = null;
        window.addEventListener('resize', () => {
            const nm = document.getElementById('header-name');
            if (!nm || !nm.innerText || nm.innerText === 'Nama Siswa') return;
            clearTimeout(_wmResizeTimer);
            _wmResizeTimer = setTimeout(() => window.renderWatermark(nm.innerText), 500);
        });

        // ‚îÄ‚îÄ DETEKSI PRIVATE / INCOGNITO MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function detectPrivateMode() {
            return new Promise(resolve => {
                try {
                    const req = indexedDB.open('__priv_chk__');
                    req.onerror = () => resolve(true); // private mode = IndexedDB error
                    req.onsuccess = (e) => {
                        e.target.result.close();
                        indexedDB.deleteDatabase('__priv_chk__');
                        if (navigator.storage && navigator.storage.estimate) {
                            navigator.storage.estimate().then(est => {
                                // Private mode biasanya quota < 120 MB
                                resolve(est.quota !== undefined && est.quota < 120 * 1024 * 1024);
                            }).catch(() => resolve(false));
                        } else { resolve(false); }
                    };
                } catch(e) { resolve(false); }
            });
        }

        // ‚îÄ‚îÄ MODAL PERINGATAN FULLSCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _warnCdInterval = null;
        window.showWarningModal = function(vNum, message, isDQ) {
            const modal = document.getElementById('modal-warning-student');
            if (!modal) return;
            const studentNm = (document.getElementById('header-name') || {}).innerText || '';
            document.getElementById('ws-name').textContent = studentNm;
            document.getElementById('ws-vcount').textContent = vNum;

            // Judul & warna badge sesuai level
            if (isDQ) {
                document.getElementById('ws-title').textContent = 'DISKUALIFIKASI!';
                document.getElementById('ws-consequence').textContent = 'üíÄ Ujian dihentikan. Nilai dikirim dengan status DISKUALIFIKASI.';
                document.getElementById('ws-consequence').style.color = '#fca5a5';
            } else {
                document.getElementById('ws-title').textContent = 'TERDETEKSI CURANG!';
                if (vNum === 2) {
                    document.getElementById('ws-consequence').textContent = 'üö® PERINGATAN TERAKHIR! Satu lagi = DISKUALIFIKASI OTOMATIS!';
                    document.getElementById('ws-consequence').style.color = '#fbbf24';
                } else {
                    document.getElementById('ws-consequence').textContent = '‚ö° Pelanggaran ke-3 = DISKUALIFIKASI OTOMATIS!';
                    document.getElementById('ws-consequence').style.color = '#fca5a5';
                }
            }

            // Pesan detail sesuai jenis pelanggaran
            const detailMap = {
                'Anda meninggalkan tab ujian!':
                    'üìµ Kamu terdeteksi berpindah tab atau meminimalkan browser!\nIni melanggar aturan ujian yang berlaku.',
                'Terdeteksi interaksi di luar layar ujian (Aplikasi Mengambang/Notifikasi)!':
                    'üì± Terdeteksi ada interaksi di luar layar ujian!\nPastikan tidak ada aplikasi lain yang aktif di atas browser.'
            };
            document.getElementById('ws-detail').textContent = detailMap[message] || message;

            // Nasihat dinamis berdasarkan jumlah pelanggaran
            const nasihatList = [
                'Ini adalah peringatan pertama. Ujian yang jujur mencerminkan karakter aslimu. Kamu pasti bisa tanpa kecurangan!',
                'Sudah dua kali terdeteksi. Ingat, setiap pelanggaran tercatat permanen. Lebih baik nilai rendah dengan jujur daripada curang dan menanggung malu.',
                'Ini peringatan terakhir! Satu pelanggaran lagi dan kamu akan DIDISKUALIFIKASI. Berhentilah sekarang, mulailah dengan hati yang bersih.'
            ];
            const nasihatEl = document.getElementById('ws-nasihat');
            if (nasihatEl) nasihatEl.textContent = nasihatList[Math.min(violations - 1, 2)];

            modal.classList.remove('hidden');
            flashScreen();

            // Countdown 5 detik ‚Äî tombol baru aktif setelah hitungan selesai
            let secs = 5;
            const cdEl  = document.getElementById('ws-cd');
            const cdWr  = document.getElementById('ws-cd-wrapper');
            const btn   = document.getElementById('ws-close-btn');
            cdWr.classList.remove('hidden');
            btn.disabled = true;
            btn.className = 'w-full max-w-sm py-4 rounded-2xl font-black text-lg uppercase tracking-widest bg-gray-700 text-gray-500 cursor-not-allowed transition-all duration-500';
            cdEl.textContent = secs;

            if (_warnCdInterval) clearInterval(_warnCdInterval);
            _warnCdInterval = setInterval(() => {
                secs--;
                cdEl.textContent = secs;
                if (secs <= 0) {
                    clearInterval(_warnCdInterval);
                    btn.disabled = false;
                    btn.className = 'w-full max-w-sm py-4 rounded-2xl font-black text-lg uppercase tracking-widest bg-red-600 hover:bg-red-700 text-white cursor-pointer shadow-xl shadow-red-500/50 active:scale-95 transition-all duration-300';
                    cdWr.classList.add('hidden');
                    
                    // AUTO TRANSITION: Jika ini DQ (violations = 3), otomatis tutup modal warning dan tampilkan modal DQ
                    if (isDQ) {
                        window._dqAutoTransitionTimer = setTimeout(() => {
                            modal.classList.add('hidden');
                            isWarningActive = false;
                            _showDQModal();
                        }, 1000); // Delay 1 detik agar user sempat lihat tombol aktif
                    }
                }
            }, 1000);
        };

        window.closeWarningModal = function() {
            const modal = document.getElementById('modal-warning-student');
            if (modal) modal.classList.add('hidden');
            document.getElementById('ws-cd-wrapper').classList.remove('hidden');
            isWarningActive = false;
            // Cancel auto-transition timer jika ada (cegah double-call _showDQModal)
            if (window._dqAutoTransitionTimer) {
                clearTimeout(window._dqAutoTransitionTimer);
                window._dqAutoTransitionTimer = null;
            }
            // Selalu paksa kembali ke fullscreen saat siswa klik lanjut
            try {
                const el = document.documentElement;
                if (el.requestFullscreen) el.requestFullscreen().catch(()=>{});
                else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                else if (el.msRequestFullscreen) el.msRequestFullscreen();
            } catch(e) {}
            if (violations >= 3) _showDQModal();
        };

        function _showDQModal() {
            // ‚òÖ GUARD: Pastikan DQ modal hanya ditampilkan sekali
            if (window._dqShown) return;
            window._dqShown = true;

            const modal = document.getElementById('modal-dq-final');
            if (!modal) { 
                console.error('Modal DQ tidak ditemukan, langsung ke result');
                finishExam(true); 
                return; 
            }
            
            // Tampilkan modal
            modal.classList.remove('hidden');
            
            // Set nama siswa
            const nm = (document.getElementById('header-name') || {}).innerText || '';
            const dqNameEl = document.getElementById('dq-name');
            if (dqNameEl) dqNameEl.textContent = nm;
            
            // Countdown dari 5 detik
            let secs = 5;
            const cdEl = document.getElementById('dq-cd');
            if (!cdEl) {
                console.error('Element countdown tidak ditemukan');
                finishExam(true);
                return;
            }
            
            cdEl.textContent = secs;
            console.log('Memulai countdown DQ dari', secs);
            
            const iv = setInterval(() => {
                secs--;
                console.log('Countdown DQ:', secs);
                if (cdEl) cdEl.textContent = secs;
                
                if (secs <= 0) { 
                    clearInterval(iv);
                    console.log('Countdown selesai, pindah ke result');
                    finishExam(true); 
                }
            }, 1000);
        }

        // ‚îÄ‚îÄ REGISTER VIOLATION (engine utama) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function registerViolation(message) {
            if (isWarningActive) return;
            if (violations >= 3) return;

            isWarningActive = true;
            violations++;
            playAlarm();
            violationLogs.push({ time: Date.now(), message });

            if (window.isFirebaseReady && window.currentExamDocId && window.db) {
                const statusUpdate = violations >= 3 ? "DISKUALIFIKASI (Kecurangan)" : "SEDANG MENGERJAKAN";
                updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', window.currentExamDocId), {
                    violations, violationLogs, status: statusUpdate
                }).catch(console.error);
            }

            // Tampilkan modal fullscreen (bukan alert biasa)
            setTimeout(() => {
                window.showWarningModal(violations, message, violations >= 3);
            }, 150);
        }

        function finishExam(forced = false) {
            // ‚òÖ GUARD: Pastikan finishExam hanya berjalan sekali
            if (window._examFinished) return;
            window._examFinished = true;

            clearInterval(examTimer);
            
            // ‚òÖ HAPUS listener fullscreenchange SEBELUM apapun agar tidak memicu registerViolation
            try {
                const fsHandler = window._handleFullscreenChange || function(){};
                document.removeEventListener("fullscreenchange", fsHandler);
                document.removeEventListener("webkitfullscreenchange", fsHandler);
                document.removeEventListener("msfullscreenchange", fsHandler);
                window._handleFullscreenChange = null;
            } catch(e) {}

            // Hapus semua listener anti-cheat lainnya
            document.removeEventListener("visibilitychange", handleVisibility);
            window.removeEventListener("blur", handleBlur);
            window.removeEventListener("resize", handleResizeToleransi);
            window.onpopstate = null;
            window.onbeforeunload = null;

            // Matikan watermark & tutup modal anti-cheat siswa
            window.clearWatermark();
            const mw = document.getElementById('modal-warning-student');
            if (mw) mw.classList.add('hidden');

            // ‚òÖ JANGAN keluar dari fullscreen ‚Äî biarkan halaman hasil tetap fullscreen
            // agar tidak ada celah curang setelah ujian. Fullscreen baru keluar saat klik "Kembali ke Login".
            // Jika belum fullscreen karena alasan tertentu, paksa masuk fullscreen lagi
            try {
                const el = document.documentElement;
                const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
                if (!isFs) {
                    if (el.requestFullscreen) el.requestFullscreen().catch(() => {});
                    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                }
            } catch(e) {}

            // ‚îÄ‚îÄ Hitung skor (safe: jaga dari array kosong) ‚îÄ‚îÄ
            const qList = currentQuestionList || [];
            let correctCount = 0;
            let nonEssayCount = 0;
            let hasEssay = false;
            const essayAnswersMap = {}; // { qId: { text, rubrik, skorMaks } }

            qList.forEach(q => {
                if (q.tipe === 'essay') {
                    hasEssay = true;
                    const userText = (userAnswers[q.id] && userAnswers[q.id].text) ? userAnswers[q.id].text.trim() : '';
                    essayAnswersMap[q.id] = {
                        qText: q.text || '',
                        rubrik: q.essayRubrik || '',
                        skorMaks: q.essaySkorMaks || 10,
                        jawabanSiswa: userText,
                        skorAI: null,
                        skorGuru: null,
                        komentarAI: '',
                        status: 'pending'
                    };
                    return; // essay tidak dihitung dalam skor otomatis
                }
                nonEssayCount++;
                if (typeof q.correct === 'undefined') return;
                const isMultiple = q.tipe === 'multiple';
                const isTrueFalse = q.tipe === 'truefalse';
                if (isTrueFalse) {
                    const correctBool = q.correct === true || q.correct === 'true';
                    if (userAnswers[q.id] === correctBool) correctCount++;
                } else if (isMultiple && Array.isArray(q.correct)) {
                    const userAns = Array.isArray(userAnswers[q.id]) ? [...userAnswers[q.id]].sort() : [];
                    const corrArr = [...q.correct].sort();
                    if (userAns.length === corrArr.length && userAns.every((v, i) => v === corrArr[i])) correctCount++;
                } else {
                    const correctIdx = Array.isArray(q.correct) ? q.correct[0] : q.correct;
                    if (userAnswers[q.id] === correctIdx) correctCount++;
                }
            });
            // Gunakan nilaiMaksimal dari paket (default 100 jika tidak diset)
            const _paketData = (window.allPaketDB || []).find(p => p.id === (currentStudent || {}).paketId);
            const nilaiMaksimal = (_paketData && _paketData.nilaiMaksimal && _paketData.nilaiMaksimal > 0) ? _paketData.nilaiMaksimal : 100;
            // Skor dari soal non-esai saja (esai pending)
            const score = nonEssayCount > 0 ? Math.round((correctCount / qList.length) * nilaiMaksimal) : 0;

            const _cs = currentStudent || {};
            const resultData = {
                timestamp:    Date.now(),
                studentName:  _cs.name      || '-',
                studentNisn:  _cs.nisn      || '-',
                className:    _cs.cls       || '-',
                packetType:   _cs.pkt       || '-',
                paketId:      _cs.paketId   || '',
                paketNama:    _cs.paketNama || '',
                ruangUjian:   _cs.room      || '-',
                sesiId:       window.currentSesiId   || 'default',
                sesiName:     window.currentSesiName || '',
                score:        score,
                scoreNonEssay: score,
                status:       forced ? "DISKUALIFIKASI (Kecurangan)" : (hasEssay ? "SELESAI (Esai Pending)" : "SELESAI"),
                violations:   forced ? 3 : violations,
                violationLogs: violationLogs,
                hasEssay:     hasEssay,
                essayPending: hasEssay && !forced,
                essayAnswers: hasEssay ? essayAnswersMap : {}
            };

            if(window.saveExamResult) window.saveExamResult(resultData);
            setTimeout(() => {
                if (window._patchResultPage) window._patchResultPage(forced ? 3 : violations, forced);
            }, 300);
            if (window._integrityAutoRefresh) window._integrityAutoRefresh();

            try { localStorage.setItem('ukktkj_session_done', JSON.stringify({
                name: (currentStudent || {}).name,
                date: new Date().toISOString()
            })); } catch(e) {}

            // ‚òÖ Hapus UID siswa dari authorized_uids setelah ujian selesai
            try {
                const uid = window.currentUID || (window.auth && window.auth.currentUser && window.auth.currentUser.uid);
                if (uid && window.db) {
                    deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'authorized_uids', uid))
                        .catch(() => {});
                }
            } catch(e) {}

            // ‚îÄ‚îÄ PINDAH HALAMAN DULU ‚Äî sebelum DOM manipulation apapun ‚îÄ‚îÄ
            const dqModal = document.getElementById('modal-dq-final');
            if (dqModal) dqModal.classList.add('hidden');
            
            const examSection = document.getElementById('section-exam');
            const resultSection = document.getElementById('section-result');
            
            examSection.classList.add('hidden-section');
            resultSection.classList.remove('hidden-section');
            
            // Pastikan halaman scroll ke atas dan fokus ke section result
            window.scrollTo(0, 0);
            resultSection.scrollIntoView({ behavior: 'instant', block: 'start' });

            // ‚îÄ‚îÄ Isi UI halaman hasil (semua null-safe) ‚îÄ‚îÄ
            const resultIcon     = document.getElementById('result-icon-container');
            const resultTitle    = document.getElementById('result-title');
            const resultMsg      = document.getElementById('result-message');
            const scoreEl        = document.getElementById('final-score-display');
            const motivationalEl = document.getElementById('motivational-message');
            const btnReview      = document.getElementById('btn-review');

            if (scoreEl) scoreEl.innerText = hasEssay ? '?' : score;
            // Tampilkan detail: benar/total soal dan nilai per soal
            const detailEl = document.getElementById('final-score-detail');
            if (detailEl) {
                if (hasEssay) {
                    const essayCount = Object.keys(essayAnswersMap).length;
                    detailEl.innerHTML = `Benar <strong>${correctCount}</strong> dari <strong>${nonEssayCount}</strong> soal pilihan &nbsp;¬∑&nbsp; <span class="text-purple-600 font-bold">+ ${essayCount} soal esai menunggu koreksi</span>`;
                } else {
                    const nilaiPerSoal = qList.length > 0 ? (nilaiMaksimal / qList.length).toFixed(2).replace(/\.?0+$/, '') : 0;
                    detailEl.innerHTML = `Benar <strong>${correctCount}</strong> dari <strong>${qList.length}</strong> soal &nbsp;¬∑&nbsp; Nilai maks: <strong>${nilaiMaksimal}</strong> &nbsp;¬∑&nbsp; Per soal: <strong>${nilaiPerSoal} poin</strong>`;
                }
            }

            if (forced) {
                try { playAlarm(); } catch(e) {}
                if (resultIcon) {
                    resultIcon.className = "w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse";
                    resultIcon.innerHTML = `<i data-lucide="alert-octagon" class="w-10 h-10"></i>`;
                }
                if (resultTitle) {
                    resultTitle.innerText = "ANDA DIDISKUALIFIKASI";
                    resultTitle.className = "text-2xl font-bold text-red-600 mb-2";
                }
                if (resultMsg) {
                    resultMsg.innerText = "Setiap kecurangan akan terdeteksi. Kejujuran adalah yang terpenting.";
                    resultMsg.className = "text-red-500 mb-6 font-bold text-lg";
                }
                if (scoreEl) scoreEl.className = "text-5xl font-extrabold text-red-600";
                if (motivationalEl) {
                    motivationalEl.innerHTML = "Sistem mencatat 3x pelanggaran. Kejujuran adalah hal terpenting dalam ujian ini.";
                    motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-red-100 text-red-800 border-red-500";
                }
                if (btnReview) btnReview.style.display = 'none';

            } else {
                resultIcon.className = "w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6";
                resultIcon.innerHTML = `<i data-lucide="check-circle" class="w-10 h-10"></i>`;
                
                resultTitle.innerText = "Ujian Selesai!";
                resultTitle.className = "text-2xl font-bold text-gray-800 mb-2";
                
                resultMsg.innerText = "Jawaban telah terkirim ke server.";
                resultMsg.className = "text-gray-500 mb-6";
                
                if (score < nilaiMaksimal * 0.5) {
                    scoreEl.className = "text-5xl font-extrabold text-red-600";
                    motivationalEl.innerHTML = `üì¢ "Waduh, Monitor Ketua! Sinyal otak sepertinya lagi RTO nih. Jangan panik, remidi adalah jalan ninjaku! Semangat belajar lagi ya! üöÄ"`;
                    motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-red-100 text-red-800 border-red-500";
                } else if (score < nilaiMaksimal * 0.8) {
                    scoreEl.className = "text-5xl font-extrabold text-yellow-600";
                    motivationalEl.innerHTML = `üî• "Lumayan! Dikit lagi jadi sepuh TKJ. Tingkatin lagi belajarnya biar nggak cuma jadi user, tapi jadi admin masa depan!"`;
                    motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-yellow-100 text-yellow-800 border-yellow-500";
                } else {
                    scoreEl.className = "text-5xl font-extrabold text-green-600";
                    motivationalEl.innerHTML = `üëë "Menyala Abangku! üî• Nilai di atas rata-rata. Pertahankan prestasimu, masa depan cerah menanti! Server aman, hati tenang."`;
                    motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-green-100 text-green-800 border-green-500";
                }

                const reviewListEl = document.getElementById('review-list');
                reviewListEl.innerHTML = '';
                const labels = ['A','B','C','D','E'];
                
                currentQuestionList.forEach((q, idx) => {
                    if (!q || !q.options && q.tipe !== 'truefalse') return;
                    const isMultiple = q.tipe === 'multiple';
                    const isTrueFalse = q.tipe === 'truefalse';
                    const userAnsRaw = userAnswers[q.id];
                    const isSkipped = userAnsRaw === undefined || (Array.isArray(userAnsRaw) && userAnsRaw.length === 0);

                    let isCorrect;
                    if (isTrueFalse) {
                        const correctBool = q.correct === true || q.correct === 'true';
                        isCorrect = !isSkipped && userAnsRaw === correctBool;
                    } else if (isMultiple && Array.isArray(q.correct)) {
                        const userArr = Array.isArray(userAnsRaw) ? [...userAnsRaw].sort() : [];
                        const corrArr = [...q.correct].sort();
                        isCorrect = !isSkipped && userArr.length === corrArr.length && userArr.every((v, i) => v === corrArr[i]);
                    } else {
                        const correctIdx = Array.isArray(q.correct) ? q.correct[0] : q.correct;
                        isCorrect = userAnsRaw === correctIdx;
                    }
                    
                    let statusClass = isCorrect ? "bg-green-50 border-green-200" : (isSkipped ? "bg-gray-50 border-gray-200" : "bg-red-50 border-red-200");
                    let icon = isCorrect
                        ? `<i data-lucide="check" class="text-green-600 w-5 h-5"></i>`
                        : (isSkipped ? `<i data-lucide="minus" class="text-gray-400 w-5 h-5"></i>` : `<i data-lucide="x" class="text-red-600 w-5 h-5"></i>`);

                    // User answer text
                    let userAnsText;
                    if (isSkipped) {
                        userAnsText = "<span class='text-gray-500 italic'>Tidak dijawab</span>";
                    } else if (isTrueFalse) {
                        userAnsText = userAnsRaw === true ? '‚úì BENAR' : '‚úó SALAH';
                    } else if (isMultiple && Array.isArray(userAnsRaw)) {
                        userAnsText = userAnsRaw.sort().map(i => `<span class="font-bold">${labels[i] || i}</span>: ${q.options[i] || ''}` ).join(', ');
                    } else {
                        userAnsText = q.options[userAnsRaw] || "Opsi Tidak Valid";
                    }

                    // Correct answer text
                    let correctAnsText;
                    if (isTrueFalse) {
                        const correctBool = q.correct === true || q.correct === 'true';
                        correctAnsText = correctBool ? '‚úì BENAR' : '‚úó SALAH';
                    } else if (isMultiple && Array.isArray(q.correct)) {
                        correctAnsText = q.correct.map(i => `<span class="font-bold">${labels[i] || i}</span>: ${q.options[i] || ''}`).join(', ');
                    } else {
                        const ci = Array.isArray(q.correct) ? q.correct[0] : q.correct;
                        correctAnsText = q.options[ci] || "Kunci Jawaban Tidak Valid";
                    }

                    const tipeBadge = isTrueFalse
                        ? `<span class="text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-bold ml-1">B/S</span>`
                        : isMultiple
                            ? `<span class="text-[10px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded font-bold ml-1">Ganda</span>`
                            : '';

                    const reviewItem = `
                        <div class="p-4 rounded-lg border ${statusClass}">
                            <div class="flex items-start gap-3">
                                <div class="mt-1 min-w-[20px]">${icon}</div>
                                <div class="w-full">
                                    <p class="font-semibold text-gray-800 mb-2 text-sm md:text-base">
                                        <span class="text-gray-500 mr-1">${idx + 1}.</span> ${q.text || '(Soal bergambar)'}${tipeBadge}
                                    </p>
                                    <div class="mt-3 text-sm space-y-1">
                                        <div class="flex flex-col sm:flex-row gap-1 sm:gap-2">
                                            <span class="font-bold text-gray-600 w-24 shrink-0">Jawabanmu:</span>
                                            <span class="${isCorrect ? 'text-green-700 font-medium' : (isSkipped ? 'text-gray-500' : 'text-red-600 font-medium')}">${userAnsText}</span>
                                        </div>
                                        ${!isCorrect ? `
                                        <div class="flex flex-col sm:flex-row gap-1 sm:gap-2">
                                            <span class="font-bold text-gray-600 w-24 shrink-0">Kunci:</span>
                                            <span class="text-green-700 font-bold">${correctAnsText}</span>
                                        </div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    reviewListEl.innerHTML += reviewItem;
                });
                
                btnReview.style.display = 'flex'; 
            }
            
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.updateDashboardTable = function(data) {
            dashboardData = data;
            // Simpan semua data tanpa filter agar PDF rekap kelas selalu lengkap
            window._allDashboardData = data;
            filterDashboardInternal();
        };

        function filterDashboardInternal() {
            const filterPkt  = document.getElementById('filter-session').value;
            const filterCls  = document.getElementById('filter-class').value;
            const filterDate = document.getElementById('filter-date').value;
            const filterRuangEl = document.getElementById('filter-ruang');
            const filterSesiEl  = document.getElementById('filter-sesi');
            let filterRuang  = filterRuangEl ? filterRuangEl.value : 'all';
            let filterSesi   = filterSesiEl  ? filterSesiEl.value  : 'active';

            // Jika login sebagai pengawas, paksa filter ke ruang mereka
            if (window.currentPengawasRuang) {
                filterRuang = (window.currentPengawasRuang.nama || '').trim();
                if (filterRuangEl) {
                    filterRuangEl.value = filterRuang;
                    filterRuangEl.disabled = true;
                }
                // Pengawas juga hanya lihat sesi aktif (tidak bisa lihat history)
                filterSesi = 'active';
                if (filterSesiEl) { filterSesiEl.value = 'active'; filterSesiEl.disabled = true; }
            } else {
                if (filterRuangEl) filterRuangEl.disabled = false;
                if (filterSesiEl)  filterSesiEl.disabled  = false;
            }

            const tbody = document.getElementById('dashboard-table-body');
            tbody.innerHTML = '';

            // ‚îÄ‚îÄ DEDUPLICATION: 1 siswa = 1 entri di monitoring ‚îÄ‚îÄ
            // Jika ada duplikat (NISN sama atau nama+kelas sama), ambil dokumen terbaru.
            // Dokumen yang status-nya SELESAI/DISKUALIFIKASI diprioritaskan di atas SEDANG MENGERJAKAN.
            const dedupMap = new Map();
            dashboardData.forEach(item => {
                const key = item.studentNisn
                    ? item.studentNisn.toString().trim()
                    : `${(item.studentName||'').toLowerCase()}__${item.className||''}`;
                
                if (!dedupMap.has(key)) {
                    dedupMap.set(key, item);
                } else {
                    const existing = dedupMap.get(key);
                    const existFinished = existing.status.includes('SELESAI') || existing.status.includes('DISKUALIFIKASI');
                    const newFinished   = item.status.includes('SELESAI') || item.status.includes('DISKUALIFIKASI');
                    // Prioritas: SELESAI/DQ > MELANJUTKAN > SEDANG MENGERJAKAN; jika sama, ambil terbaru
                    if (!existFinished && newFinished) {
                        dedupMap.set(key, item);
                    } else if (existFinished === newFinished && item.timestamp > existing.timestamp) {
                        dedupMap.set(key, item);
                    }
                }
            });
            const dedupedData = Array.from(dedupMap.values());

            window.currentFilteredData = dedupedData.filter(item => {
                // ‚îÄ‚îÄ FIX: Siswa yang SEDANG MENGERJAKAN selalu tampil di monitoring
                // agar guru/pengawas bisa memantau real-time.
                // Filter sesi, paket, tanggal hanya berlaku untuk data yang sudah selesai.
                const isLive = item.status === 'SEDANG MENGERJAKAN' || item.status.includes('MELANJUTKAN');

                // ‚îÄ‚îÄ Filter Sesi ‚îÄ‚îÄ
                let matchSesi = true;
                if (!isLive) { // live siswa selalu lolos filter sesi
                    if (filterSesi === 'active') {
                        // Cocokkan dengan semua jadwal yang sedang aktif
                        const jadwalAktifIds = (window.allJadwalDB || [])
                            .filter(j => j.isActive === true)
                            .map(j => j.id);
                        if (jadwalAktifIds.length > 0) {
                            matchSesi = jadwalAktifIds.includes(item.sesiId);
                        } else {
                            // Tidak ada jadwal aktif ‚Üí tampilkan data terbaru (hari ini)
                            const today = new Date().toISOString().slice(0,10);
                            const itemDate = item.timestamp ? new Date(item.timestamp).toISOString().slice(0,10) : '';
                            matchSesi = itemDate === today || item.sesiId === (window.currentSesiId || 'default');
                        }
                    } else if (filterSesi !== 'all') {
                        matchSesi = item.sesiId === filterSesi;
                    }
                }

                const matchPkt   = filterPkt === 'all' || item.packetType === filterPkt;
                const matchCls   = filterCls === 'all' || item.className === filterCls;
                const matchRuang = filterRuang === 'all' || (item.ruangUjian || '-').trim().toLowerCase() === filterRuang.trim().toLowerCase();
                let matchDate = true;
                if (filterDate && !isLive) { // tanggal tidak memblokir siswa live
                    const itemDate = new Date(item.timestamp);
                    const y = itemDate.getFullYear();
                    const m = String(itemDate.getMonth() + 1).padStart(2, '0');
                    const d = String(itemDate.getDate()).padStart(2, '0');
                    const itemDateStr = `${y}-${m}-${d}`;
                    matchDate = itemDateStr === filterDate;
                }
                return matchSesi && matchPkt && matchCls && matchRuang && matchDate;
            });

            // ‚îÄ‚îÄ Update Stat Cards ‚îÄ‚îÄ
            updateStatCards(window.currentFilteredData);

            if (window.currentFilteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-12 text-center text-gray-400">
                    <div class="flex flex-col items-center gap-2">
                        <i data-lucide="inbox" class="w-10 h-10 text-gray-300"></i>
                        <p class="font-semibold">Belum ada peserta</p>
                        <p class="text-xs text-gray-300">${filterSesi === 'active' ? 'Belum ada siswa login di sesi aktif ini.' : 'Tidak ada data yang cocok dengan filter.'}</p>
                    </div>
                </td></tr>`;
                const pw = document.getElementById('pager-monitoring-wrap');
                if (pw) pw.innerHTML = '';
                if(typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ
            const pgM = window._pg.monitoring;
            const totalM = window.currentFilteredData.length;
            pgM.page = Math.max(1, Math.min(pgM.page, Math.ceil(totalM / pgM.perPage)));
            const sliceStart = (pgM.page - 1) * pgM.perPage;
            const pageData = window.currentFilteredData.slice(sliceStart, sliceStart + pgM.perPage);

            pageData.forEach(item => {
                const date = new Date(item.timestamp).toLocaleTimeString('id-ID');

                const isCheating = item.status.includes('DISKUALIFIKASI');
                const isDoing = item.status === 'SEDANG MENGERJAKAN' || item.status.includes('MELANJUTKAN');

                let statusColor = isCheating ? 'text-red-600 font-extrabold flex items-center gap-1' : 'text-green-600 font-bold';
                let rowClass = isCheating ? 'bg-red-50 border-red-200' : 'hover:bg-slate-50 border-b';
                let statusIcon = isCheating ? `<i data-lucide="alert-circle" class="w-4 h-4"></i>` : '';

                if (isDoing) {
                    statusColor = 'text-blue-600 font-bold flex items-center gap-1';
                    rowClass = 'bg-blue-50/50 border-blue-100 hover:bg-blue-50 border-b animate-pulse';
                    statusIcon = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
                }

                const violationDisplay = item.violations > 0
                    ? `<button onclick="window.showViolationDetails('${item.id}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-xs font-bold flex items-center gap-1 mx-auto transition-colors shadow-sm">
                         ${item.violations}x <i data-lucide="info" class="w-3 h-3"></i>
                       </button>`
                    : '-';

                const pktColor = item.packetType === 'A' ? 'bg-blue-100 text-blue-700' : item.packetType === 'B' ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700';
                const ruangLabel = item.ruangUjian || '-';
                const ruangColor = ruangLabel !== '-' ? 'bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-xs font-bold' : 'text-gray-400 text-xs';
                const sesiInfo = filterSesi === 'all' && item.sesiName
                    ? `<div class="text-[10px] text-indigo-500 font-semibold mt-0.5">${item.sesiName}</div>` : '';

                const row = `
                    <tr class="${rowClass} transition-colors">
                        <td class="px-6 py-4">
                            <div class="font-semibold text-gray-900">${item.studentName}</div>
                            ${sesiInfo}
                        </td>
                        <td class="px-6 py-4 text-gray-500 text-sm">${item.studentNisn || '-'}</td>
                        <td class="px-6 py-4 text-gray-600 text-sm">${item.className || '-'}</td>
                        <td class="px-6 py-4"><span class="${ruangColor}">${ruangLabel}</span></td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${pktColor}">${item.paketNama || ('Paket ' + item.packetType)}</span></td>
                        <td class="px-6 py-4 text-center text-lg font-bold ${(item.score??-1)>=80?'text-emerald-600':(item.score??-1)>=60?'text-amber-500':'text-red-500'}">
                            ${item.essayPending ? `<span class="inline-flex flex-col items-center gap-0.5"><span class="text-base">${item.score ?? '-'}</span><span class="text-[9px] bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded-full font-bold leading-none">+esai‚è≥</span></span>` : (item.score ?? '-')}
                        </td>
                        <td class="px-6 py-4"><span class="${statusColor}">${statusIcon} ${item.status}</span></td>
                        <td class="px-6 py-4 text-center">${violationDisplay}</td>
                        <td class="px-6 py-4 text-center">
                            ${(()=>{
                                const sc = typeof calcIntegrityScore === 'function' ? calcIntegrityScore(item) : null;
                                if (sc === null) return '<span class="text-gray-300 text-xs">‚Äî</span>';
                                const color = sc===100?'text-emerald-600 bg-emerald-50':sc>=70?'text-amber-600 bg-amber-50':'text-red-600 bg-red-50';
                                return `<span class="px-2 py-1 rounded font-black text-sm ${color}">${sc}</span>`;
                            })()}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex gap-1 justify-center">
                                ${isDoing ? `<button onclick="window.forceFinishStudent('${item.id}')" class="text-orange-600 hover:bg-orange-50 px-2 py-1.5 rounded transition-colors border border-orange-200 hover:border-orange-400 text-xs font-bold" title="Paksa Selesaikan Ujian Siswa Ini"><i data-lucide="flag" class="w-4 h-4 inline"></i> Selesaikan</button>` : ''}
                                ${item.essayPending ? `<button onclick="window.openKoreksiEssay('${item.id}')" class="text-purple-600 hover:bg-purple-50 p-1.5 rounded transition-colors border border-purple-200 hover:border-purple-400" title="Koreksi Soal Esai"><i data-lucide="pencil-line" class="w-4 h-4"></i></button>` : (item.hasEssay && !item.essayPending ? `<button onclick="window.openKoreksiEssay('${item.id}')" class="text-gray-400 hover:bg-gray-50 p-1.5 rounded transition-colors" title="Lihat Koreksi Esai"><i data-lucide="check-circle" class="w-4 h-4"></i></button>` : '')}
                                <button onclick="window.openNoteModal('${item.id}')" class="text-blue-500 hover:bg-blue-50 p-1.5 rounded transition-colors" title="Tambah Catatan Pengawas">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.exportSinglePDF('${item.id}')" class="text-emerald-600 hover:bg-emerald-50 p-1.5 rounded transition-colors" title="Export PDF Integritas">
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.deleteExamResult('${item.id}')" class="text-red-500 hover:bg-red-100 p-1.5 rounded transition-colors" title="Hapus Data">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Render pager
            const pw = document.getElementById('pager-monitoring-wrap');
            if (pw) pw.innerHTML = renderPagerHTML('monitoring', totalM, pgM.page, pgM.perPage);

            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updateStatCards(data) {
            const total    = data.length;
            const selesai  = data.filter(d => d.status === 'SELESAI').length;
            const ongoing  = data.filter(d => d.status === 'SEDANG MENGERJAKAN' || d.status.includes('MELANJUTKAN')).length;
            const dq       = data.filter(d => d.status.includes('DISKUALIFIKASI')).length;
            const withViol = data.filter(d => (d.violations||0) > 0 && !d.status.includes('DISKUALIFIKASI')).length;
            const scores   = data.map(d => typeof d.score === 'number' ? d.score : parseFloat(d.score)).filter(s => !isNaN(s) && s >= 0);
            const avg      = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : null;
            const lulus    = scores.filter(s => s >= 75).length;

            const pct = (n) => total > 0 ? Math.round(n/total*100) : 0;
            const set = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
            const setBar = (id, pctVal) => { const el = document.getElementById(id); if(el) el.style.width = pctVal + '%'; };

            set('sc-total', total);
            set('sc-selesai', selesai);    set('sc-selesai-pct', pct(selesai)+'%');    setBar('sc-bar-selesai', pct(selesai));
            set('sc-ongoing', ongoing);    set('sc-ongoing-pct', pct(ongoing)+'%');    setBar('sc-bar-ongoing', pct(ongoing));
            set('sc-dq', dq);              set('sc-dq-pct', pct(dq)+'%');              setBar('sc-bar-dq', pct(dq));
            set('sc-violations', withViol);set('sc-violations-pct', pct(withViol)+'%');setBar('sc-bar-violations', pct(withViol));
            set('sc-avg', avg !== null ? avg : '‚Äî');
            set('sc-lulus', lulus);        set('sc-lulus-pct', scores.length > 0 ? Math.round(lulus/scores.length*100)+'%' : '0%');
            // ‚òÖ BARU: refresh analitik otomatis
            if (window._integrityAutoRefresh) window._integrityAutoRefresh(data);
        }

        // ============================================================
        // ‚òÖ FITUR BARU: SKOR INTEGRITAS + ANALITIK DASHBOARD
        // ============================================================

        // ============================================================
        // FORMULA SKOR INTEGRITAS (PROGRESIF BERBOBOT)
        // Pelanggaran ke-1: -20 poin  ‚Üí skor 80
        // Pelanggaran ke-2: -40 poin tambahan ‚Üí total -60 ‚Üí skor 40
        // Pelanggaran ke-3+: DISKUALIFIKASI ‚Üí skor 0
        // Rumus: max(0, 100 - bobot_kumulatif)
        // ============================================================
        function calcIntegrityScore(item) {
            if (!item || item.status === 'SEDANG MENGERJAKAN') return null;
            if (item.status.includes('DISKUALIFIKASI')) return 0;
            const viol = item.violations || 0;
            if (viol >= 3) return 0;
            // Formula: tiap pelanggaran -20 poin
            // 0 viol = 100 (Teladan), 1 viol = 80 (Baik), 2 viol = 60 (Cukup), 3+ = DQ (0)
            return Math.max(0, 100 - (viol * 20));
        }

        // Kategori predikat sesuai permintaan
        function getIntegrityCategory(score) {
            if (score === null) return { label: '‚Äî', predikat: '‚Äî', bg: 'bg-gray-100', text: 'text-gray-500', headerColor: '#475569' };
            if (score === 100)  return { label: 'üèÜ Sangat Terpuji', predikat: 'üéñÔ∏è TELADAN', bg: 'bg-emerald-100', text: 'text-emerald-700', headerColor: '#065f46' };
            if (score >= 80)   return { label: '‚úÖ Baik (Terpuji)', predikat: '‚úÖ BAIK', bg: 'bg-green-100', text: 'text-green-700', headerColor: '#166534' };
            if (score >= 60)   return { label: '‚ö†Ô∏è Cukup (Butuh Pembinaan)', predikat: '‚ö†Ô∏è CUKUP', bg: 'bg-amber-100', text: 'text-amber-700', headerColor: '#92400e' };
            if (score > 0)     return { label: '‚õî Kurang (Perlu Pendampingan)', predikat: '‚õî EVALUASI', bg: 'bg-red-100', text: 'text-red-700', headerColor: '#991b1b' };
            return { label: '‚ùå Diskualifikasi', predikat: '‚õî EVALUASI', bg: 'bg-rose-100', text: 'text-rose-700', headerColor: '#881337' };
        }

        // Catatan otomatis per-siswa berdasarkan jumlah pelanggaran
        function getAutoNote(viol, isDQ) {
            if (isDQ || viol >= 3) return {
                kategori: 'Critical / Disqualified',
                note: 'Sesi ujian dihentikan secara otomatis oleh sistem karena pengabaian standar integritas digital secara berulang (3 kali peringatan). Laporan ini diterbitkan sebagai data objektif bagi guru pembimbing untuk melakukan pendekatan persuasif dan evaluasi mendalam terhadap perilaku akademik peserta didik.'
            };
            if (viol === 0) return {
                kategori: 'Excellent Integrity',
                note: 'Peserta didik menunjukkan dedikasi luar biasa terhadap nilai kejujuran digital. Konsistensi dalam menjaga fokus tanpa anomali sistem merupakan cerminan karakter unggul yang siap menghadapi tantangan akademik masa depan. Pertahankan standar integritas ini sebagai modal utama kesuksesan.'
            };
            if (viol === 1) return {
                kategori: 'Minor Alert',
                note: 'Secara umum, peserta didik mengikuti prosedur ujian dengan baik. Terdapat satu catatan aktivitas di luar jendela utama yang langsung direspon dengan perbaikan sikap. Diharapkan adanya peningkatan disiplin dan fokus digital agar proses evaluasi berjalan lebih optimal di sesi berikutnya.'
            };
            return {
                kategori: 'Needs Improvement',
                note: 'Sistem mendeteksi beberapa kali upaya pengalihan layar yang mengganggu standarisasi integritas ujian. Meskipun sesi berhasil diselesaikan, laporan ini merekomendasikan adanya dialog pembinaan karakter untuk memperkuat pemahaman peserta didik mengenai pentingnya kejujuran di lingkungan digital.'
            };
        }

        // Kesimpulan sistem otomatis
        function getSystemConclusion(score, isDQ) {
            if (isDQ || score === 0) return 'Sistem mendeteksi adanya anomali aktivitas yang memerlukan tindak lanjut persuasif. Laporan ini dapat digunakan sebagai dasar dialog pembinaan antara guru dan peserta didik untuk memahami kendala yang dihadapi.';
            if (score === 100) return 'Peserta didik menunjukkan konsistensi luar biasa dalam menjunjung tinggi nilai kejujuran digital. Perilaku ini mencerminkan kesiapan karakter dalam menghadapi tantangan akademik yang lebih tinggi.';
            if (score >= 80) return 'Peserta didik mengikuti prosedur ujian dengan baik dengan sedikit catatan. Secara umum integritas terjaga, namun diharapkan adanya peningkatan disiplin pada sesi berikutnya.';
            if (score >= 60) return 'Secara umum peserta didik mengikuti prosedur dengan baik, namun terdapat catatan aktivitas di luar jendela ujian. Disarankan untuk dilakukan penguatan fokus dan disiplin digital pada sesi berikutnya.';
            return 'Sistem mendeteksi adanya anomali aktivitas yang memerlukan tindak lanjut persuasif. Laporan ini dapat digunakan sebagai dasar dialog pembinaan antara guru dan peserta didik untuk memahami kendala yang dihadapi.';
        }

        // QR verifikasi visual (pattern ASCII berbasis hash ID siswa)
        function makeQRPlaceholder(seed) {
            const h = [...String(seed)].reduce((a, c) => ((a << 5) - a + c.charCodeAt(0)) | 0, 0);
            const hex = Math.abs(h).toString(16).toUpperCase().padStart(8, '0');
            return `<div style="display:inline-block;border:2px solid #2563eb;padding:4px 5px;font-family:monospace;font-size:6.5px;line-height:1.4;color:#2563eb;background:white;border-radius:4px">
                <div>‚ñà‚ñÄ‚ñÄ‚ñà ${hex.slice(0,2)} ‚ñÄ</div>
                <div>‚ñà ‚ñÑ ‚ñà ${hex.slice(2,4)}</div>
                <div>‚ñà‚ñÑ‚ñÑ‚ñà ${hex.slice(4,6)} ‚ñÑ</div>
                <div>‚ñÑ ${hex.slice(6)} ‚ñÑ‚ñÑ</div>
                <div style="font-size:5.5px;text-align:center;margin-top:2px;letter-spacing:0.5px;color:#1d4ed8;font-weight:700">VERIFIED ‚úì</div>
            </div>`;
        }

        // ‚îÄ‚îÄ DESIGN TOKENS (seragam dengan web: blue-600/indigo-700/slate-900) ‚îÄ‚îÄ
        const PDF_COLORS = {
            primary:    '#2563eb',   // blue-600  ‚Äî accent utama web
            primaryDark:'#1d4ed8',   // blue-700
            indigo:     '#4f46e5',   // indigo-600
            indigoDark: '#3730a3',   // indigo-800
            dark:       '#0f172a',   // slate-900
            darkMid:    '#1e293b',   // slate-800
            mid:        '#334155',   // slate-700
            muted:      '#64748b',   // slate-500
            subtle:     '#94a3b8',   // slate-400
            border:     '#e2e8f0',   // slate-200
            surface:    '#f8fafc',   // slate-50
            white:      '#ffffff',
            // Status colors
            green:      '#16a34a',   // green-600
            greenBg:    '#f0fdf4',
            greenBorder:'#bbf7d0',
            amber:      '#d97706',   // amber-600
            amberBg:    '#fffbeb',
            amberBorder:'#fde68a',
            red:        '#dc2626',   // red-600
            redBg:      '#fef2f2',
            redBorder:  '#fecaca',
        };

        // Warna badge per status integritas
        function getStatusPalette(score, isDQ) {
            if (isDQ || score === 0)  return { accent: PDF_COLORS.red,   bg: PDF_COLORS.redBg,   border: PDF_COLORS.redBorder,   stripe: '#fee2e2' };
            if (score === 100)        return { accent: PDF_COLORS.green,  bg: PDF_COLORS.greenBg, border: PDF_COLORS.greenBorder, stripe: '#dcfce7' };
            if (score >= 80)          return { accent: PDF_COLORS.green,  bg: PDF_COLORS.greenBg, border: PDF_COLORS.greenBorder, stripe: '#dcfce7' };
            if (score >= 60)          return { accent: PDF_COLORS.amber,  bg: PDF_COLORS.amberBg, border: PDF_COLORS.amberBorder, stripe: '#fef9c3' };
            return                           { accent: PDF_COLORS.red,   bg: PDF_COLORS.redBg,   border: PDF_COLORS.redBorder,   stripe: '#fee2e2' };
        }

        // Bangun halaman PDF per siswa ‚Äî redesign modern
        function buildStudentCard(d, idx, schoolName, judulUjianCard) {
            const isDQ = (d.status || '').includes('DISKUALIFIKASI');
            const intScore = calcIntegrityScore(d);
            const cat = getIntegrityCategory(intScore);
            const autoNote = getAutoNote(d.violations || 0, isDQ);
            const conclusion = getSystemConclusion(intScore, isDQ);
            const now = new Date().toLocaleString('id-ID');
            const ujianTime = d.timestamp ? new Date(d.timestamp).toLocaleString('id-ID') : '-';
            const pal = getStatusPalette(intScore, isDQ);
            const statusLabel = isDQ ? 'DISKUALIFIKASI' : (d.score >= 75 ? 'LULUS' : 'TIDAK LULUS');
            const statusColor = isDQ ? PDF_COLORS.red : (d.score >= 75 ? PDF_COLORS.green : PDF_COLORS.amber);

            // Divider pill untuk section header
            const sectionHead = (icon, label) =>
                `<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                    <div style="width:3px;height:14px;border-radius:2px;background:${PDF_COLORS.primary}"></div>
                    <div style="font-size:9.5px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:${PDF_COLORS.muted}">${icon} ${label}</div>
                </div>`;

            // Log insiden
            const logs = d.violationLogs || [];
            const logHTML = logs.length === 0
                ? `<tr><td colspan="2" style="padding:10px 14px;font-style:italic;color:${PDF_COLORS.subtle};font-size:11px;text-align:center">
                        Tidak ada insiden tercatat ‚Äî sesi ujian berjalan bersih ‚úì
                   </td></tr>`
                : logs.map((l, li) => {
                    const t = l.time ? new Date(l.time).toLocaleTimeString('id-ID') : '-';
                    return `<tr style="background:${li%2===0?PDF_COLORS.surface:PDF_COLORS.white}">
                        <td style="padding:7px 12px;font-size:10.5px;font-weight:700;color:${PDF_COLORS.primary};white-space:nowrap;width:115px;border-right:1px solid ${PDF_COLORS.border}">${t}</td>
                        <td style="padding:7px 12px;font-size:10.5px;color:${PDF_COLORS.mid}">
                            ${l.message || 'Aktivitas mencurigakan terdeteksi'}
                            &nbsp;<span style="background:${PDF_COLORS.primary};color:white;font-size:8.5px;font-weight:700;padding:2px 7px;border-radius:20px">Teguran ${li+1}</span>
                        </td>
                    </tr>`;
                  }).join('');

            // Catatan pengawas
            const customNote = d._customNote || '';
            const noteBody = customNote
                ? `<p style="font-size:12px;color:${PDF_COLORS.mid};line-height:1.7;margin:0 0 8px 0">${autoNote.note}</p>
                   <p style="font-size:12px;color:${PDF_COLORS.darkMid};line-height:1.7;margin:0"><strong>Catatan Pengawas:</strong> ${customNote}</p>`
                : `<p style="font-size:12px;color:${PDF_COLORS.mid};line-height:1.7;margin:0 0 12px 0">${autoNote.note}</p>
                   <div style="border:1.5px dashed ${PDF_COLORS.border};border-radius:8px;padding:10px 14px;background:${PDF_COLORS.surface};min-height:44px">
                     <div style="font-size:8.5px;color:${PDF_COLORS.subtle};text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Catatan Pengawas (isi manual sebelum dicetak)</div>
                     <div style="border-bottom:1px solid ${PDF_COLORS.border};margin-bottom:7px"></div>
                     <div style="border-bottom:1px solid ${PDF_COLORS.border}"></div>
                   </div>`;

            // Mini score bar
            const barWidth = Math.max(intScore, 3);
            const barColor = pal.accent;

            return `<div style="font-family:'Segoe UI',system-ui,Arial,sans-serif;max-width:720px;margin:0 auto;page-break-after:always;padding-bottom:8px;background:white;border-radius:16px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.08)">

                <!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
                <div style="background:linear-gradient(135deg,${PDF_COLORS.primaryDark} 0%,${PDF_COLORS.indigoDark} 50%,${PDF_COLORS.dark} 100%);padding:22px 28px;display:flex;justify-content:space-between;align-items:flex-start;position:relative;overflow:hidden">
                    <!-- Subtle grid overlay -->
                    <div style="position:absolute;inset:0;opacity:0.05;background-image:linear-gradient(rgba(255,255,255,0.8) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.8) 1px,transparent 1px);background-size:20px 20px"></div>
                    <div style="position:relative">
                        <div style="font-size:8.5px;letter-spacing:3px;opacity:0.5;text-transform:uppercase;margin-bottom:6px;color:white">Laporan Karakter Akademik Digital</div>
                        <div style="font-size:20px;font-weight:900;letter-spacing:-0.5px;color:white;line-height:1.1">${judulUjianCard || 'Ujian Digital'}</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:4px;font-weight:500">${schoolName}</div>
                        <!-- Status pill -->
                        <div style="display:inline-flex;align-items:center;gap:5px;margin-top:10px;background:${pal.accent};color:white;font-size:9px;font-weight:800;padding:4px 10px;border-radius:20px;letter-spacing:0.5px">
                            ${isDQ ? '‚úï DISKUALIFIKASI' : intScore===100 ? '‚úì INTEGRITAS SEMPURNA' : intScore>=70 ? '‚ö† PERLU PEMBINAAN' : '‚úï PERLU EVALUASI'}
                        </div>
                    </div>
                    <div style="position:relative;text-align:right;flex-shrink:0">
                        <div style="font-size:8px;color:rgba(255,255,255,0.45);margin-bottom:6px">Diterbitkan: ${now}</div>
                        ${makeQRPlaceholder(d.studentNisn || d.studentName || idx)}
                        <div style="font-size:7px;color:rgba(255,255,255,0.35);margin-top:4px">IntegrityTest Engine v2</div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê IDENTITAS SISWA ‚ïê‚ïê -->
                <div style="background:${PDF_COLORS.surface};border-bottom:1px solid ${PDF_COLORS.border};padding:16px 28px;display:grid;grid-template-columns:2fr 1fr 1fr;gap:16px">
                    <div>
                        <div style="font-size:8.5px;color:${PDF_COLORS.subtle};font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Nama Peserta Didik</div>
                        <div style="font-size:17px;font-weight:800;color:${PDF_COLORS.dark}">${d.studentName || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size:8.5px;color:${PDF_COLORS.subtle};font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">NISN</div>
                        <div style="font-size:13px;font-weight:700;color:${PDF_COLORS.mid}">${d.studentNisn || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size:8.5px;color:${PDF_COLORS.subtle};font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Kelas</div>
                        <div style="font-size:13px;font-weight:700;color:${PDF_COLORS.mid}">${d.className || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size:8.5px;color:${PDF_COLORS.subtle};font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Ruang Ujian</div>
                        <div style="font-size:13px;font-weight:700;color:${PDF_COLORS.mid}">${d.ruangUjian || '-'}</div>
                    </div>
                    <div>
                        <div style="font-size:8.5px;color:${PDF_COLORS.subtle};font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Waktu Ujian</div>
                        <div style="font-size:11px;font-weight:600;color:${PDF_COLORS.muted}">${ujianTime}</div>
                    </div>
                    <div>
                        <div style="font-size:8.5px;color:${PDF_COLORS.subtle};font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Paket Soal</div>
                        <div style="font-size:13px;font-weight:700;color:${PDF_COLORS.mid}">Paket ${d.packetType || '-'}</div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê SCORE CARDS ‚ïê‚ïê -->
                <div style="padding:18px 28px;background:white;border-bottom:1px solid ${PDF_COLORS.border}">
                    ${sectionHead('‚ñ¶', 'Ringkasan Hasil Ujian')}
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px">

                        <!-- Nilai Akademik -->
                        <div style="border:1.5px solid ${PDF_COLORS.border};border-radius:12px;padding:14px;text-align:center;background:${PDF_COLORS.surface}">
                            <div style="font-size:8.5px;color:${PDF_COLORS.primary};font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Nilai Akademik</div>
                            <div style="font-size:32px;font-weight:900;color:${PDF_COLORS.primaryDark};line-height:1">${d.score ?? '‚Äî'}</div>
                            <div style="font-size:9px;color:${PDF_COLORS.subtle};margin-top:4px">dari 100 poin</div>
                            <!-- mini bar -->
                            <div style="margin-top:8px;height:3px;background:${PDF_COLORS.border};border-radius:2px;overflow:hidden">
                                <div style="height:100%;width:${Math.max(d.score||0,2)}%;background:${PDF_COLORS.primary};border-radius:2px"></div>
                            </div>
                        </div>

                        <!-- Indeks Integritas -->
                        <div style="border:1.5px solid ${pal.border};border-radius:12px;padding:14px;text-align:center;background:${pal.bg}">
                            <div style="font-size:8.5px;color:${pal.accent};font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Indeks Integritas</div>
                            <div style="font-size:32px;font-weight:900;color:${pal.accent};line-height:1">${intScore}</div>
                            <div style="font-size:9px;color:${pal.accent};opacity:0.7;margin-top:4px">${intScore}%</div>
                            <div style="margin-top:8px;height:3px;background:${pal.border};border-radius:2px;overflow:hidden">
                                <div style="height:100%;width:${barWidth}%;background:${barColor};border-radius:2px"></div>
                            </div>
                        </div>

                        <!-- Status -->
                        <div style="border:1.5px solid ${PDF_COLORS.border};border-radius:12px;padding:14px;text-align:center;background:${PDF_COLORS.surface}">
                            <div style="font-size:8.5px;color:${PDF_COLORS.muted};font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">Status Ujian</div>
                            <div style="font-size:14px;font-weight:900;color:${statusColor};margin-top:8px;line-height:1.2">${statusLabel}</div>
                            <div style="margin-top:8px;font-size:9px;color:${PDF_COLORS.subtle}">${d.violations||0} pelanggaran</div>
                        </div>

                        <!-- Predikat -->
                        <div style="border:1.5px solid ${pal.border};border-radius:12px;padding:14px;text-align:center;background:${pal.accent};color:white">
                            <div style="font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;opacity:0.75">Predikat</div>
                            <div style="font-size:13px;font-weight:900;line-height:1.3;margin-top:8px">${cat.predikat}</div>
                            <div style="font-size:8.5px;margin-top:8px;opacity:0.7">${autoNote.kategori}</div>
                        </div>

                    </div>
                </div>

                <!-- ‚ïê‚ïê LOG INSIDEN ‚ïê‚ïê -->
                <div style="padding:18px 28px;background:white;border-bottom:1px solid ${PDF_COLORS.border}">
                    ${sectionHead('‚óé', 'Log Insiden & Aktivitas Sistem')}
                    <div style="border:1px solid ${PDF_COLORS.border};border-radius:10px;overflow:hidden">
                        <table style="width:100%;border-collapse:collapse">
                            <thead>
                                <tr style="background:${PDF_COLORS.primaryDark}">
                                    <th style="padding:8px 12px;text-align:left;font-size:9px;color:rgba(255,255,255,0.8);font-weight:700;text-transform:uppercase;letter-spacing:0.5px;width:120px">Waktu Kejadian</th>
                                    <th style="padding:8px 12px;text-align:left;font-size:9px;color:rgba(255,255,255,0.8);font-weight:700;text-transform:uppercase;letter-spacing:0.5px">Deskripsi Aktivitas Terdeteksi</th>
                                </tr>
                            </thead>
                            <tbody>${logHTML}</tbody>
                        </table>
                    </div>
                </div>

                <!-- ‚ïê‚ïê CATATAN PENGAWAS ‚ïê‚ïê -->
                <div style="padding:18px 28px;background:white;border-bottom:1px solid ${PDF_COLORS.border}">
                    ${sectionHead('‚úé', 'Catatan Otomatis & Pengawas')}
                    <div style="border-left:3px solid ${PDF_COLORS.primary};padding:12px 16px;background:${PDF_COLORS.surface};border-radius:0 10px 10px 0">
                        ${noteBody}
                    </div>
                </div>

                <!-- ‚ïê‚ïê KESIMPULAN SISTEM ‚ïê‚ïê -->
                <div style="padding:16px 28px;background:${pal.bg};border-bottom:1px solid ${pal.border}">
                    ${sectionHead('‚¨°', 'Kesimpulan Sistem (Auto-Generated)')}
                    <div style="font-size:11.5px;color:${PDF_COLORS.mid};line-height:1.8;font-style:italic;border-left:3px solid ${pal.accent};padding-left:14px">"${conclusion}"</div>
                </div>

                <!-- ‚ïê‚ïê FOOTER ‚ïê‚ïê -->
                <div style="background:${PDF_COLORS.dark};padding:14px 28px;display:flex;justify-content:space-between;align-items:center;gap:16px">
                    <div style="font-size:9.5px;color:rgba(255,255,255,0.3);font-style:italic;line-height:1.65;flex:1;max-width:500px">
                        "Hasil ujian adalah potret kompetensi kognitif, namun integritas adalah cermin kualitas diri. Laporan ini diterbitkan bukan untuk menghukum, melainkan untuk mendukung tumbuh kembang karakter yang autentik."
                    </div>
                    <div style="text-align:right;flex-shrink:0;border-left:1px solid rgba(255,255,255,0.08);padding-left:16px">
                        <div style="font-size:10px;color:rgba(255,255,255,0.5);font-weight:700;letter-spacing:0.5px">INTEGRITEST</div>
                        <div style="font-size:8px;color:rgba(255,255,255,0.25);margin-top:2px">Dok. #${String(idx+1).padStart(4,'0')}-${(d.studentNisn||'0000').toString().slice(-4)}</div>
                        <div style="font-size:8px;color:${PDF_COLORS.primary};margin-top:3px;font-weight:600">‚úì Verified &amp; Auto-Generated</div>
                    </div>
                </div>

                <div style="height:32px"></div>
            </div>`;
        }

        window.renderIntegrityDashboard = function() {
            const isAdmin = !window.currentPengawasRuang;
            const rawData = dashboardData || [];
            let finished = rawData.filter(d => d.status !== 'SEDANG MENGERJAKAN');

            // ‚ïê‚ïê STEP 1: Filter pengawas DULU sebelum apapun ‚ïê‚ïê
            // Pengawas hanya boleh lihat data ruangnya sendiri + sesi aktif
            if (!isAdmin && window.currentPengawasRuang) {
                const pgNama = (window.currentPengawasRuang.nama || '').trim().toLowerCase();
                const pgId   = (window.currentPengawasRuang.id   || '').trim().toLowerCase();
                finished = finished.filter(d => {
                    const dr = (d.ruangUjian || '').trim().toLowerCase();
                    return dr === pgNama || dr === pgId;
                });
                // Default: hanya tampilkan data jadwal aktif (bisa di-override filter dropdown)
                const fSesiDropdown = document.getElementById('analitik-filter-sesi')?.value || 'all';
                const jadwalAktifIds3 = (window.allJadwalDB || []).filter(j => j.isActive).map(j => j.id);
                if (fSesiDropdown === 'all' && jadwalAktifIds3.length > 0) {
                    finished = finished.filter(d => jadwalAktifIds3.includes(d.sesiId));
                }
            }

            // ‚ïê‚ïê STEP 2: Ambil nilai filter yang dipilih user ‚ïê‚ïê
            const sesiSel   = document.getElementById('analitik-filter-sesi');
            const ruangSel  = document.getElementById('analitik-filter-ruang');
            const kelasSel  = document.getElementById('analitik-filter-kelas');
            const ruangWrap = document.getElementById('analitik-filter-ruang-wrap');
            const fPredikat = document.getElementById('analitik-filter-predikat')?.value || 'all';
            const fSesi     = sesiSel?.value  || 'all';
            const fRuang    = isAdmin ? (ruangSel?.value || 'all') : 'locked'; // pengawas: tidak pakai filter ruang manual
            const fKelas    = kelasSel?.value || 'all';

            // ‚ïê‚ïê STEP 3: Terapkan filter admin (sesi/ruang/kelas) ‚ïê‚ïê
            if (fSesi  !== 'all') finished = finished.filter(d => (d.sesiId || 'default') === fSesi);
            if (isAdmin && fRuang !== 'all') finished = finished.filter(d => (d.ruangUjian || '') === fRuang);
            if (fKelas !== 'all') finished = finished.filter(d => (d.className || '') === fKelas);

            // ‚ïê‚ïê STEP 4: Populate dropdown dari data yang sudah ter-filter ruang ‚ïê‚ïê
            // (sehingga pilihan dropdown relevan dengan scope user)
            const baseForDropdown = (() => {
                // Untuk dropdown: pakai data yang sudah filter ruang/pengawas tapi BELUM filter sesi/kelas
                let base = rawData.filter(d => d.status !== 'SEDANG MENGERJAKAN');
                if (!isAdmin && window.currentPengawasRuang) {
                    const _pgNama = (window.currentPengawasRuang.nama || '').trim().toLowerCase();
                    const _pgId   = (window.currentPengawasRuang.id   || '').trim().toLowerCase();
                    base = base.filter(d => { const dr=(d.ruangUjian||'').trim().toLowerCase(); return dr===_pgNama||dr===_pgId; });
                }
                return base;
            })();

            // Sembunyikan filter ruang untuk pengawas
            if (ruangWrap) ruangWrap.style.display = isAdmin ? '' : 'none';

            // ‚ïê‚ïê POPULATE DROPDOWN: Gabungkan data master + data ujian ‚ïê‚ïê
            // Dropdown diisi dari jadwal & data master

            // Isi dropdown jadwal ‚Äî dari allJadwalDB
            if (sesiSel) {
                const curSesi = sesiSel.value;
                sesiSel.innerHTML = '<option value="all">Semua Jadwal</option>';
                const sortedJ = (window.allJadwalDB || []).slice().sort((a,b) => {
                    if (a.tanggal !== b.tanggal) return b.tanggal > a.tanggal ? 1 : -1;
                    return b.jamMulai > a.jamMulai ? 1 : -1;
                });
                sortedJ.forEach(j => {
                    const opt = document.createElement('option');
                    opt.value = j.id;
                    const aktif = j.isActive ? ' ‚ö°' : '';
                    opt.textContent = (j.nama || j.id) + aktif + (j.tanggal ? ' ¬∑ ' + j.tanggal : '');
                    sesiSel.appendChild(opt);
                });
                if (curSesi && sesiSel.querySelector('option[value="' + curSesi + '"]')) sesiSel.value = curSesi;
            }

            // Isi dropdown ruang (admin only) ‚Äî dari ruangList (master) + data ujian
            if (ruangSel && isAdmin) {
                const curRuang = ruangSel.value;
                // Nama ruang dari database master
                const ruangNamaFromMaster = (window.ruangList || []).map(r => r.nama).filter(Boolean);
                // Nama ruang dari data ujian yang sudah ada (untuk antisipasi data lama)
                const ruangNamaFromData = baseForDropdown.map(d => d.ruangUjian).filter(Boolean);
                // Gabungkan dan deduplikasi
                const ruangSet = [...new Set([...ruangNamaFromMaster, ...ruangNamaFromData])].sort();
                ruangSel.innerHTML = '<option value="all">Semua Ruang</option>';
                ruangSet.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r; opt.textContent = r;
                    ruangSel.appendChild(opt);
                });
                if (curRuang && ruangSel.querySelector(`option[value="${curRuang}"]`)) ruangSel.value = curRuang;
            }

            // Isi dropdown kelas ‚Äî dari kelasList (master) + data ujian
            if (kelasSel) {
                const curKelas = kelasSel.value;
                // Nama kelas dari database master
                const kelasNamaFromMaster = (window.kelasList || []).map(k => k.nama).filter(Boolean);
                // Nama kelas dari data ujian yang sudah ada
                const kelasNamaFromData = baseForDropdown.map(d => d.className).filter(Boolean);
                // Gabungkan dan deduplikasi
                const kelasSet = [...new Set([...kelasNamaFromMaster, ...kelasNamaFromData])].sort();
                kelasSel.innerHTML = '<option value="all">Semua Kelas</option>';
                kelasSet.forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k; opt.textContent = k;
                    kelasSel.appendChild(opt);
                });
                if (curKelas && kelasSel.querySelector(`option[value="${curKelas}"]`)) kelasSel.value = curKelas;
            }

            // ‚ïê‚ïê STEP 5: Handle empty state ‚ïê‚ïê
            const emptyBanner = document.getElementById('analitik-empty-banner');

            if (finished.length === 0) {
                if (emptyBanner) emptyBanner.style.display = '';
                document.getElementById('avg-integrity-score').textContent = '‚Äî';
                document.getElementById('honest-count').textContent = '0';
                document.getElementById('honest-pct').textContent = '0% dari total';
                document.getElementById('minor-viol-count').textContent = '0';
                document.getElementById('dq-count-analitik').textContent = '0';
                document.getElementById('chart-integrity-dist').innerHTML = '<div class="flex flex-col items-center justify-center py-10 gap-2 text-gray-300"><i data-lucide="bar-chart-2" class="w-10 h-10"></i><p class="text-sm font-semibold text-gray-400">Menunggu data ujian...</p><p class="text-xs text-gray-300">Terisi otomatis setelah siswa menyelesaikan ujian</p></div>';
                document.getElementById('chart-viol-per-class').innerHTML = '<div class="flex flex-col items-center justify-center py-10 gap-2 text-gray-300"><i data-lucide="users" class="w-10 h-10"></i><p class="text-sm font-semibold text-gray-400">Menunggu data ujian...</p><p class="text-xs text-gray-300">Terisi otomatis setelah siswa menyelesaikan ujian</p></div>';
                document.getElementById('integrity-table-body').innerHTML = '<tr><td colspan="9" class="text-center py-14"><div class="flex flex-col items-center gap-2 text-gray-300"><i data-lucide="clipboard-list" class="w-12 h-12"></i><p class="font-bold text-gray-400 text-base">Belum ada data integritas</p><p class="text-sm text-gray-300 max-w-xs">Tabel terisi otomatis setelah siswa menyelesaikan ujian. Tidak perlu refresh halaman.</p></div></td></tr>';
                const pager = document.getElementById('analitik-pager'); if (pager) pager.innerHTML = '';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }
            if (emptyBanner) emptyBanner.style.display = 'none';

            // ‚îÄ‚îÄ Hitung skor integritas ‚îÄ‚îÄ
            let withScores = finished.map(d => ({
                ...d, integrityScore: calcIntegrityScore(d)
            })).filter(d => d.integrityScore !== null);

            // Filter predikat
            if (fPredikat !== 'all') {
                withScores = withScores.filter(d => {
                    if (fPredikat === 'teladan')  return d.integrityScore === 100;
                    if (fPredikat === 'baik')     return d.integrityScore >= 80 && d.integrityScore < 100;
                    if (fPredikat === 'cukup')    return d.integrityScore >= 60 && d.integrityScore < 80;
                    if (fPredikat === 'evaluasi') return d.integrityScore > 0 && d.integrityScore < 60;
                    if (fPredikat === 'dq')       return d.integrityScore === 0;
                    return true;
                });
            }

            // ‚îÄ‚îÄ Summary cards ‚îÄ‚îÄ
            const scores = withScores.map(d => d.integrityScore);
            const avg    = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
            const honest = withScores.filter(d => d.integrityScore >= 80).length;
            const minor  = withScores.filter(d => (d.violations||0) >= 1 && (d.violations||0) <= 2 && !d.status.includes('DISKUALIFIKASI')).length;
            const dq     = withScores.filter(d => d.integrityScore === 0).length;
            const total  = withScores.length;

            document.getElementById('avg-integrity-score').textContent = avg;
            document.getElementById('honest-count').textContent = honest;
            document.getElementById('honest-pct').textContent = total > 0 ? Math.round(honest/total*100)+'% dari total' : '0% dari total';
            document.getElementById('minor-viol-count').textContent = minor;
            document.getElementById('dq-count-analitik').textContent = dq;

            // Update info filter
            const filterInfo = document.getElementById('analitik-filter-info');
            if (filterInfo) {
                const hasFilter = fSesi !== 'all' || (isAdmin && fRuang !== 'all') || fKelas !== 'all' || fPredikat !== 'all';
                filterInfo.textContent = hasFilter ? `Menampilkan ${total} hasil` : '';
                filterInfo.classList.toggle('hidden', !hasFilter);
            }

            // ‚îÄ‚îÄ Chart 1: Distribusi Skor ‚îÄ‚îÄ
            const bands = [
                { label: 'Score 100 (Teladan)',      min: 100, max: 100, color: '#10b981' },
                { label: 'Score 80‚Äì99 (Baik)',       min: 80,  max: 99,  color: '#34d399' },
                { label: 'Score 60‚Äì79 (Cukup)',      min: 60,  max: 79,  color: '#f59e0b' },
                { label: 'Score 1‚Äì59 (Evaluasi)',    min: 1,   max: 59,  color: '#ef4444' },
                { label: 'Score 0 (Diskualifikasi)', min: 0,   max: 0,   color: '#991b1b' },
            ];
            const distEl = document.getElementById('chart-integrity-dist');
            distEl.innerHTML = '';
            bands.forEach(band => {
                const count = withScores.filter(d => d.integrityScore >= band.min && d.integrityScore <= band.max).length;
                const pct   = total > 0 ? Math.round(count/total*100) : 0;
                distEl.innerHTML += `
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-500 w-44 shrink-0">${band.label}</span>
                        <div class="flex-1 bg-gray-100 rounded-full h-5 overflow-hidden">
                            <div class="h-full rounded-full flex items-center justify-end pr-2 transition-all duration-700"
                                 style="width:${Math.max(pct,0)}%; background:${band.color}; min-width:${count>0?'2rem':'0'}">
                                ${count > 0 ? `<span class="text-white text-xs font-bold">${count}</span>` : ''}
                            </div>
                        </div>
                        <span class="text-xs font-bold text-gray-600 w-10 text-right">${pct}%</span>
                    </div>`;
            });

            // ‚îÄ‚îÄ Chart 2: Pelanggaran per Kelas ‚îÄ‚îÄ
            const classMap = {};
            withScores.forEach(d => {
                const cls = d.className || 'Tidak Diketahui';
                if (!classMap[cls]) classMap[cls] = { total: 0, viol: 0 };
                classMap[cls].total++;
                if ((d.violations||0) > 0) classMap[cls].viol++;
            });
            const classEl = document.getElementById('chart-viol-per-class');
            const classEntries = Object.entries(classMap).sort((a,b) => b[1].viol - a[1].viol);
            if (classEntries.length === 0) {
                classEl.innerHTML = '<p class="text-center text-gray-400 text-sm py-8">Belum ada data kelas.</p>';
            } else {
                classEl.innerHTML = '';
                const maxViol = Math.max(...classEntries.map(([,v]) => v.viol), 1);
                classEntries.forEach(([cls, val]) => {
                    const pct  = Math.round(val.viol/val.total*100);
                    const barW = Math.round(val.viol/maxViol*100);
                    const color = pct === 0 ? '#10b981' : pct < 30 ? '#f59e0b' : '#ef4444';
                    classEl.innerHTML += `
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-gray-600 font-bold w-28 shrink-0 truncate">${cls}</span>
                            <div class="flex-1 bg-gray-100 rounded-full h-5 overflow-hidden">
                                <div class="h-full rounded-full transition-all duration-700 flex items-center justify-end pr-2"
                                     style="width:${Math.max(barW,0)}%; background:${color}; min-width:${val.viol>0?'2rem':'0'}">
                                    ${val.viol > 0 ? `<span class="text-white text-xs font-bold">${val.viol}</span>` : ''}
                                </div>
                            </div>
                            <span class="text-xs text-gray-500 w-20 text-right">${val.viol}/${val.total} (${pct}%)</span>
                        </div>`;
                });
            }

            // ‚îÄ‚îÄ Tabel dengan Pagination ‚îÄ‚îÄ
            const sorted = [...withScores].sort((a,b) => b.integrityScore - a.integrityScore);
            const pgA = window._pg.analitik;
            pgA.page = Math.max(1, Math.min(pgA.page, Math.ceil(sorted.length / pgA.perPage)));
            const sliceStart = (pgA.page - 1) * pgA.perPage;
            const pageItems  = sorted.slice(sliceStart, sliceStart + pgA.perPage);

            const tbody = document.getElementById('integrity-table-body');
            if (pageItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center py-10 text-gray-400">Tidak ada data untuk filter ini.</td></tr>`;
            } else {
                tbody.innerHTML = '';
                pageItems.forEach((d, i) => {
                    const globalRank = sliceStart + i;
                    const cat = getIntegrityCategory(d.integrityScore);
                    const rankIcon = globalRank === 0 ? 'ü•á' : globalRank === 1 ? 'ü•à' : globalRank === 2 ? 'ü•â' : `#${globalRank+1}`;
                    const scoreBar = `
                        <div class="flex items-center gap-2 justify-center">
                            <div class="w-20 bg-gray-100 rounded-full h-2 overflow-hidden">
                                <div class="h-full rounded-full" style="width:${d.integrityScore}%; background:${d.integrityScore>=80?'#10b981':d.integrityScore>=60?'#f59e0b':'#ef4444'}"></div>
                            </div>
                            <span class="font-black text-gray-800 w-7 text-right text-sm">${d.integrityScore}</span>
                        </div>`;
                    const hasNote = d._customNote ? 'üìù' : '';
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-slate-50 transition-colors ${d.integrityScore === 0 ? 'bg-red-50' : ''}">
                            <td class="px-4 py-3 text-center font-bold text-gray-500 text-sm">${rankIcon}</td>
                            <td class="px-4 py-3 font-semibold text-gray-800 text-sm">${d.studentName} ${hasNote}</td>
                            <td class="px-4 py-3 text-gray-500 text-xs">${d.className || '-'}</td>
                            <td class="px-4 py-3 text-gray-500 text-xs">${d.ruangUjian || '-'}</td>
                            <td class="px-4 py-3 text-center font-bold text-gray-700 text-sm">${d.score ?? '-'}</td>
                            <td class="px-4 py-3 text-center">${(d.violations||0) > 0
                                ? `<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded font-bold text-xs">${d.violations}√ó</span>`
                                : '<span class="text-emerald-500 font-bold text-xs">‚úì Bersih</span>'}</td>
                            <td class="px-4 py-3">${scoreBar}</td>
                            <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded-lg text-xs font-bold ${cat.bg} ${cat.text}">${cat.label}</span></td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex items-center justify-center gap-1.5">
                                    <button onclick="window.openNoteModal('${d.id}')"
                                        class="flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 transition-colors"
                                        title="Tambah/Edit Catatan Pengawas">
                                        <i data-lucide="pencil" class="w-3 h-3"></i> Catatan
                                    </button>
                                    <button onclick="window.exportSinglePDF('${d.id}')"
                                        class="flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border border-emerald-200 transition-colors"
                                        title="Export PDF siswa ini">
                                        <i data-lucide="file-text" class="w-3 h-3"></i> PDF
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                });
            }

            // Render pager
            const pagerEl = document.getElementById('analitik-pager');
            if (pagerEl) pagerEl.innerHTML = renderPagerHTML('analitik', sorted.length, pgA.page, pgA.perPage);

            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // Reset filter analitik
        window.resetAnalitikFilter = function() {
            const ids = ['analitik-filter-sesi','analitik-filter-ruang','analitik-filter-kelas','analitik-filter-predikat'];
            ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = 'all'; });
            if (window._pg) window._pg.analitik.page = 1;
            window.renderIntegrityDashboard();
        };

        // ‚îÄ‚îÄ Tambahkan integrityScore ke tabel monitoring ‚îÄ‚îÄ
        window.addIntegrityToMonitorRow = function(item) {
            const score = calcIntegrityScore(item);
            if (score === null) return '';
            const cat = getIntegrityCategory(score);
            return `<span class="px-2 py-0.5 rounded text-xs font-bold ${cat.bg} ${cat.text}">${score}</span>`;
        };

        // ‚îÄ‚îÄ Skor Integritas di Hasil Siswa ‚îÄ‚îÄ
        window.getStudentIntegrityForResult = function(viols, isDQ) {
            if (isDQ) return 0;
            return Math.max(0, 100 - (viols * 20));
        };

        // ‚îÄ‚îÄ Export Laporan PDF Integritas ‚îÄ‚îÄ
        window.generateIntegrityReport = function(singleId) {
            // ‚îÄ‚îÄ Sumber data: gunakan SEMUA data (tanpa filter ruang/sesi)
            // agar rekap kelas selalu menampilkan keseluruhan siswa sekelas,
            // bukan hanya siswa di ruang pengawas yang sedang login.
            const data = window._allDashboardData || dashboardData || [];
            let finished = data.filter(d => d.status !== 'SEDANG MENGERJAKAN');
            if (singleId) finished = finished.filter(d => d.id === singleId);
            if (finished.length === 0) { alert('Belum ada data ujian selesai untuk diexport.'); return; }

            const withScores = finished.map(d => ({
                ...d, integrityScore: calcIntegrityScore(d)
            })).filter(d => d.integrityScore !== null)
              .sort((a, b) => {
                  // Urutkan per kelas, lalu per nama
                  const cls = (a.className||'').localeCompare(b.className||'');
                  if (cls !== 0) return cls;
                  return (a.studentName||'').localeCompare(b.studentName||'');
              });

            const now = new Date().toLocaleString('id-ID');
            const _appPdf = window._savedAppearance || {};
            const judulUjianPdf = (_appPdf.judulUjian || 'Ujian Digital').trim();
            const schoolName    = (_appPdf.subJudul   || 'Sistem Integritas Ujian Digital').trim();

            // ‚îÄ‚îÄ Halaman per siswa (selalu ada, untuk semua mode) ‚îÄ‚îÄ
            const studentPages = withScores.map((d, i) => buildStudentCard(d, i, schoolName, judulUjianPdf)).join('');

            // ‚îÄ‚îÄ Jika export satu siswa, langsung tampilkan tanpa rekap ‚îÄ‚îÄ
            if (singleId) {
                const html = `<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8">
                <title>Laporan Siswa ‚Äî ${withScores[0]?.studentName||''} ¬∑ ${judulUjianPdf}</title>
                <style>
                    *{box-sizing:border-box;-webkit-print-color-adjust:exact;print-color-adjust:exact}
                    body{font-family:'Segoe UI',Arial,sans-serif;margin:0;padding:24px;background:#f1f5f9}
                    @media print{body{background:white;padding:0}.no-print{display:none!important}div[style*="page-break-after:always"]{page-break-after:always}}
                </style></head><body>
                <div class="no-print" style="margin-bottom:20px;background:white;padding:14px 20px;border-radius:14px;display:flex;align-items:center;gap:10px;box-shadow:0 2px 10px rgba(0,0,0,0.06);border:1px solid #e2e8f0">
                    <div style="width:3px;height:20px;border-radius:2px;background:#2563eb;margin-right:4px"></div>
                    <div style="font-size:13px;font-weight:800;color:#0f172a;flex:1">${judulUjianPdf} &nbsp;<span style="font-weight:600;color:#2563eb;font-size:11px">${schoolName}</span>&nbsp;<span style="font-weight:400;color:#64748b;font-size:11px">‚Äî ${withScores[0]?.studentName||''}</span></div>
                    <button onclick="window.print()" style="background:#2563eb;color:white;border:none;padding:9px 20px;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer">üñ®Ô∏è Cetak / Simpan PDF</button>
                    <button onclick="window.close()" style="background:#f1f5f9;color:#334155;border:1.5px solid #e2e8f0;padding:9px 18px;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer">‚úï Tutup</button>
                </div>
                ${studentPages}</body></html>`;
                const win = window.open('', '_blank');
                if (win) { win.document.write(html); win.document.close(); }
                else { alert('Popup diblokir browser. Izinkan popup untuk tab ini lalu coba lagi.'); }
                return;
            }

            // ‚îÄ‚îÄ Rekap keseluruhan (header) ‚îÄ‚îÄ
            const totalAvg = withScores.length ? Math.round(withScores.reduce((s,d) => s + d.integrityScore, 0) / withScores.length) : 0;
            const totalHonest = withScores.filter(d => d.integrityScore === 100).length;
            const totalDQ     = withScores.filter(d => d.integrityScore === 0).length;
            const totalPerlu  = withScores.length - totalHonest - totalDQ;

            // ‚îÄ‚îÄ Kelompokkan per kelas ‚îÄ‚îÄ
            const classMap = {};
            withScores.forEach(d => {
                const cls = d.className || 'Tanpa Kelas';
                if (!classMap[cls]) classMap[cls] = [];
                classMap[cls].push(d);
            });
            const classNames = Object.keys(classMap).sort();

            // ‚îÄ‚îÄ Bangun halaman rekap per kelas ‚îÄ‚îÄ
            function buildClassRecapPage(cls, siswaList) {
                const avgCls   = Math.round(siswaList.reduce((s,d) => s + d.integrityScore, 0) / siswaList.length);
                const honestC  = siswaList.filter(d => d.integrityScore === 100).length;
                const dqC      = siswaList.filter(d => d.integrityScore === 0).length;
                const perluC   = siswaList.length - honestC - dqC;
                const barW = Math.max(avgCls, 2);
                const barCol = avgCls >= 80 ? '#16a34a' : avgCls >= 60 ? '#d97706' : '#dc2626';
                const rows = siswaList.map((d, i) => {
                    const cat = getIntegrityCategory(d.integrityScore);
                    const sc = d.integrityScore;
                    const isDQ2 = (d.status||'').includes('DISKUALIFIKASI');
                    const scColor = sc===100?'#16a34a':sc>=70?'#d97706':'#dc2626';
                    return `<tr style="background:${isDQ2?'#fef2f2':i%2===0?'#f8fafc':'white'}">
                        <td style="padding:7px 10px;text-align:center;font-weight:700;color:#94a3b8;font-size:11px">${i+1}</td>
                        <td style="padding:7px 10px;font-weight:700;color:#0f172a;font-size:12px">${d.studentName||'-'}</td>
                        <td style="padding:7px 10px;color:#64748b;font-size:11.5px">${d.studentNisn||'-'}</td>
                        <td style="padding:7px 10px;color:#64748b;font-size:11.5px">${d.ruangUjian||'-'}</td>
                        <td style="padding:7px 10px;text-align:center;font-weight:800;font-size:13px;color:#1d4ed8">${d.score??'‚Äî'}</td>
                        <td style="padding:7px 10px;text-align:center;font-size:11.5px;color:#64748b">${d.violations||0}</td>
                        <td style="padding:7px 10px;text-align:center;font-weight:900;font-size:13px;color:${scColor}">${sc}</td>
                        <td style="padding:7px 10px;font-size:10.5px;color:#64748b">${cat.label.replace(/[üèÜ‚úÖ‚ö†Ô∏èüö®‚ùå‚õî]/g,'').trim()}</td>
                    </tr>`;
                }).join('');
                return `
                <div style="background:white;border-radius:16px;overflow:hidden;margin-bottom:32px;box-shadow:0 2px 12px rgba(0,0,0,0.07);page-break-after:always">
                    <!-- Header rekap kelas -->
                    <div style="background:linear-gradient(135deg,#2563eb 0%,#4f46e5 60%,#1e293b 100%);padding:22px 28px;display:flex;justify-content:space-between;align-items:center;position:relative;overflow:hidden">
                        <div style="position:absolute;inset:0;opacity:0.05;background-image:linear-gradient(rgba(255,255,255,0.8) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.8) 1px,transparent 1px);background-size:20px 20px"></div>
                        <div style="position:relative">
                            <div style="font-size:8.5px;letter-spacing:3px;opacity:0.5;text-transform:uppercase;color:white;margin-bottom:5px">Rekap Kelas ‚Äî Dokumen Resmi</div>
                            <div style="font-size:11px;font-weight:700;color:rgba(255,255,255,0.7);margin-bottom:3px">${judulUjianPdf}</div>
                            <div style="font-size:24px;font-weight:900;color:white;line-height:1">${cls}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.55);margin-top:5px">${schoolName} ¬∑ ${now}</div>
                        </div>
                        <div style="position:relative;text-align:center">
                            <div style="font-size:52px;font-weight:900;color:white;line-height:1">${avgCls}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.55);margin-top:4px">Rata-rata Indeks Integritas</div>
                            <div style="margin-top:6px;height:3px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden;width:80px;margin-left:auto;margin-right:auto">
                                <div style="height:100%;width:${barW}%;background:${barCol};border-radius:2px"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Stat cards -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;border-bottom:1px solid #e2e8f0">
                        <div style="padding:14px 16px;text-align:center;border-right:1px solid #e2e8f0">
                            <div style="font-size:8.5px;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:0.5px">Total Peserta</div>
                            <div style="font-size:30px;font-weight:900;color:#0f172a;margin-top:2px">${siswaList.length}</div>
                        </div>
                        <div style="padding:14px 16px;text-align:center;border-right:1px solid #e2e8f0;background:#f0fdf4">
                            <div style="font-size:8.5px;color:#16a34a;font-weight:700;text-transform:uppercase;letter-spacing:0.5px">‚úì Sempurna</div>
                            <div style="font-size:30px;font-weight:900;color:#16a34a;margin-top:2px">${honestC}</div>
                        </div>
                        <div style="padding:14px 16px;text-align:center;border-right:1px solid #e2e8f0;background:#fffbeb">
                            <div style="font-size:8.5px;color:#d97706;font-weight:700;text-transform:uppercase;letter-spacing:0.5px">‚ö† Pembinaan</div>
                            <div style="font-size:30px;font-weight:900;color:#d97706;margin-top:2px">${perluC}</div>
                        </div>
                        <div style="padding:14px 16px;text-align:center;background:#fef2f2">
                            <div style="font-size:8.5px;color:#dc2626;font-weight:700;text-transform:uppercase;letter-spacing:0.5px">‚úï Diskualifikasi</div>
                            <div style="font-size:30px;font-weight:900;color:#dc2626;margin-top:2px">${dqC}</div>
                        </div>
                    </div>
                    <!-- Tabel siswa -->
                    <div style="padding:20px 28px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
                            <div style="width:3px;height:14px;border-radius:2px;background:#2563eb"></div>
                            <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:#64748b">Daftar Siswa ‚Äî ${cls} (${siswaList.length} siswa)</div>
                        </div>
                        <div style="border:1px solid #e2e8f0;border-radius:10px;overflow:hidden">
                            <table style="width:100%;border-collapse:collapse;font-size:12px">
                                <thead><tr style="background:#1d4ed8;color:white">
                                    <th style="padding:8px 10px;text-align:center;font-weight:700">No</th>
                                    <th style="padding:8px 10px;text-align:left;font-weight:700">Nama Siswa</th>
                                    <th style="padding:8px 10px;text-align:left;font-weight:700">NISN</th>
                                    <th style="padding:8px 10px;text-align:left;font-weight:700">Ruang</th>
                                    <th style="padding:8px 10px;text-align:center;font-weight:700">Nilai</th>
                                    <th style="padding:8px 10px;text-align:center;font-weight:700">Pelang.</th>
                                    <th style="padding:8px 10px;text-align:center;font-weight:700">Integritas</th>
                                    <th style="padding:8px 10px;text-align:left;font-weight:700">Predikat</th>
                                </tr></thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    </div>
                    <div style="padding:10px 28px;background:#0f172a;color:rgba(255,255,255,0.25);font-size:9px;font-style:italic;text-align:center">
                        Formula: Skor = max(0, 100 ‚àí bobot_pelanggaran). Pindah tab 1√ó=‚àí20, 2√ó=‚àí60, ‚â•3√ó=Diskualifikasi. INTEGRITEST Engine v2.
                    </div>
                </div>`;
            }

            // ‚îÄ‚îÄ Halaman ringkasan semua kelas (cover) ‚îÄ‚îÄ
            const coverClassRows = classNames.map((cls, ci) => {
                const list = classMap[cls];
                const avgC = Math.round(list.reduce((s,d)=>s+d.integrityScore,0)/list.length);
                const dqC  = list.filter(d=>d.integrityScore===0).length;
                const honC = list.filter(d=>d.integrityScore===100).length;
                const avgColor = avgC>=80?'#16a34a':avgC>=60?'#d97706':'#dc2626';
                return `<tr style="background:${ci%2===0?'#f8fafc':'white'}">
                    <td style="padding:9px 14px;font-weight:700;color:#0f172a;font-size:13px">${cls}</td>
                    <td style="padding:9px 14px;text-align:center;color:#64748b;font-size:12px">${list.length} siswa</td>
                    <td style="padding:9px 14px;text-align:center">
                        <span style="font-weight:800;font-size:14px;color:${avgColor}">${avgC}</span>
                        <div style="margin-top:3px;height:3px;background:#e2e8f0;border-radius:2px;overflow:hidden;width:60px;margin-left:auto;margin-right:auto">
                            <div style="height:100%;width:${Math.max(avgC,2)}%;background:${avgColor};border-radius:2px"></div>
                        </div>
                    </td>
                    <td style="padding:9px 14px;text-align:center;color:#16a34a;font-weight:700;font-size:13px">${honC}</td>
                    <td style="padding:9px 14px;text-align:center;color:#dc2626;font-weight:700;font-size:13px">${dqC}</td>
                </tr>`;
            }).join('');

            const coverPage = `
            <div style="background:white;border-radius:16px;overflow:hidden;margin-bottom:32px;box-shadow:0 2px 12px rgba(0,0,0,0.07);page-break-after:always">
                <!-- Cover header -->
                <div style="background:linear-gradient(135deg,#1d4ed8 0%,#4f46e5 55%,#0f172a 100%);padding:28px 32px;display:flex;justify-content:space-between;align-items:center;position:relative;overflow:hidden">
                    <div style="position:absolute;inset:0;opacity:0.05;background-image:linear-gradient(rgba(255,255,255,0.8) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.8) 1px,transparent 1px);background-size:20px 20px"></div>
                    <div style="position:relative">
                        <div style="font-size:8.5px;letter-spacing:3px;opacity:0.45;text-transform:uppercase;color:white;margin-bottom:8px">Dokumen Resmi ‚Äî Rekap Seluruh Kelas</div>
                        <div style="font-size:26px;font-weight:900;color:white;letter-spacing:-0.5px;line-height:1.1">${judulUjianPdf}</div>
                        <div style="font-size:13px;font-weight:700;color:rgba(255,255,255,0.75);margin-top:4px;letter-spacing:0.3px">${schoolName}</div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.45);margin-top:4px">Diterbitkan: ${now}</div>
                        <div style="display:inline-flex;gap:10px;margin-top:12px">
                            <div style="background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:20px;padding:4px 12px;font-size:9.5px;color:rgba(255,255,255,0.75);font-weight:600">${withScores.length} peserta</div>
                            <div style="background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:20px;padding:4px 12px;font-size:9.5px;color:rgba(255,255,255,0.75);font-weight:600">${classNames.length} kelas</div>
                        </div>
                    </div>
                    <div style="position:relative;text-align:center;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:16px;padding:18px 24px">
                        <div style="font-size:54px;font-weight:900;color:white;line-height:1">${totalAvg}</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.55);margin-top:6px">Rata-rata Indeks Integritas</div>
                    </div>
                </div>
                <!-- Stat row -->
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;border-bottom:1px solid #e2e8f0">
                    <div style="padding:16px 18px;text-align:center;border-right:1px solid #e2e8f0">
                        <div style="font-size:8.5px;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:0.5px">Total Peserta</div>
                        <div style="font-size:32px;font-weight:900;color:#0f172a;margin-top:4px">${withScores.length}</div>
                    </div>
                    <div style="padding:16px 18px;text-align:center;border-right:1px solid #e2e8f0;background:#f0fdf4">
                        <div style="font-size:8.5px;color:#16a34a;font-weight:700;text-transform:uppercase;letter-spacing:0.5px">‚úì Integritas Sempurna</div>
                        <div style="font-size:32px;font-weight:900;color:#16a34a;margin-top:4px">${totalHonest}</div>
                    </div>
                    <div style="padding:16px 18px;text-align:center;border-right:1px solid #e2e8f0;background:#fffbeb">
                        <div style="font-size:8.5px;color:#d97706;font-weight:700;text-transform:uppercase;letter-spacing:0.5px">‚ö† Perlu Pembinaan</div>
                        <div style="font-size:32px;font-weight:900;color:#d97706;margin-top:4px">${totalPerlu}</div>
                    </div>
                    <div style="padding:16px 18px;text-align:center;background:#fef2f2">
                        <div style="font-size:8.5px;color:#dc2626;font-weight:700;text-transform:uppercase;letter-spacing:0.5px">‚úï Diskualifikasi</div>
                        <div style="font-size:32px;font-weight:900;color:#dc2626;margin-top:4px">${totalDQ}</div>
                    </div>
                </div>
                <!-- Tabel ringkasan kelas -->
                <div style="padding:24px 32px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
                        <div style="width:3px;height:14px;border-radius:2px;background:#2563eb"></div>
                        <div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:#64748b">Ringkasan per Kelas (${classNames.length} kelas)</div>
                    </div>
                    <div style="border:1px solid #e2e8f0;border-radius:12px;overflow:hidden">
                        <table style="width:100%;border-collapse:collapse;font-size:13px">
                            <thead><tr style="background:#1d4ed8;color:white">
                                <th style="padding:10px 14px;text-align:left;font-weight:700">Kelas</th>
                                <th style="padding:10px 14px;text-align:center;font-weight:700">Jumlah Siswa</th>
                                <th style="padding:10px 14px;text-align:center;font-weight:700">Rata-rata Integritas</th>
                                <th style="padding:10px 14px;text-align:center;font-weight:700">Sempurna</th>
                                <th style="padding:10px 14px;text-align:center;font-weight:700">Diskualifikasi</th>
                            </tr></thead>
                            <tbody>${coverClassRows}</tbody>
                        </table>
                    </div>
                </div>
                <div style="padding:12px 32px;background:#0f172a;color:rgba(255,255,255,0.2);font-size:9px;font-style:italic;text-align:center">
                    Formula: Skor = max(0, 100 ‚àí bobot_pelanggaran). Pindah tab 1√ó=‚àí20, 2√ó=‚àí60, ‚â•3√ó=Diskualifikasi (0). INTEGRITEST Engine v2.
                </div>
            </div>`;

            // ‚îÄ‚îÄ Gabungkan: cover ‚Üí rekap per kelas ‚Üí laporan per siswa ‚îÄ‚îÄ
            const classRekapPages = classNames.map(cls => buildClassRecapPage(cls, classMap[cls])).join('');

            const html = `<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8">
            <title>${judulUjianPdf} ‚Äî ${schoolName} ¬∑ ${now}</title>
            <style>
                *{box-sizing:border-box;-webkit-print-color-adjust:exact;print-color-adjust:exact}
                body{font-family:'Segoe UI',system-ui,Arial,sans-serif;margin:0;padding:28px;background:#f1f5f9;color:#1e293b}
                @media print{
                    body{background:#f1f5f9;padding:12px}
                    .no-print{display:none!important}
                    div[style*="page-break-after:always"]{page-break-after:always}
                }
            </style></head><body>

            <!-- TOMBOL AKSI -->
            <div class="no-print" style="margin-bottom:20px;background:white;padding:14px 20px;border-radius:14px;display:flex;align-items:center;gap:10px;box-shadow:0 2px 10px rgba(0,0,0,0.06);border:1px solid #e2e8f0">
                <div style="width:3px;height:20px;border-radius:2px;background:#2563eb;margin-right:4px"></div>
                <div style="font-size:13px;font-weight:800;color:#0f172a;letter-spacing:-0.3px;flex:1">${judulUjianPdf} &nbsp;<span style="font-weight:600;color:#2563eb;font-size:12px">${schoolName}</span>&nbsp;<span style="font-weight:400;color:#64748b;font-size:11px">¬∑ ${withScores.length} peserta ¬∑ ${classNames.length} kelas ¬∑ ${now}</span></div>
                <button onclick="window.print()" style="background:#2563eb;color:white;border:none;padding:9px 20px;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:6px">üñ®Ô∏è Cetak / Simpan PDF</button>
                <button onclick="window.close()" style="background:#f1f5f9;color:#334155;border:1.5px solid #e2e8f0;padding:9px 18px;border-radius:10px;font-weight:700;font-size:13px;cursor:pointer">‚úï Tutup</button>
            </div>

            <!-- HALAMAN COVER: RINGKASAN SEMUA KELAS -->
            ${coverPage}

            <!-- HALAMAN REKAP PER KELAS -->
            ${classRekapPages}

            <!-- HALAMAN LAPORAN PER SISWA -->
            ${studentPages}

            </body></html>`;

            const win = window.open('', '_blank');
            if (win) { win.document.write(html); win.document.close(); }
            else { alert('Popup diblokir browser. Izinkan popup untuk tab ini lalu coba lagi.'); }
        };

        // Export PDF satu siswa dari tabel monitoring
        window.exportSinglePDF = function(studentId) { window.generateIntegrityReport(studentId); };

        // ‚îÄ‚îÄ Modal Catatan Pengawas Per Siswa ‚îÄ‚îÄ
        window._studentNotes = {};  // simpan catatan per ID siswa (in-memory)

        window.openNoteModal = function(studentId) {
            const data = dashboardData || [];
            const student = data.find(d => d.id === studentId);
            if (!student) return;
            const viol = student.violations || 0;
            const isDQ = (student.status||'').includes('DISKUALIFIKASI');
            const autoNote = getAutoNote(viol, isDQ);

            document.getElementById('note-student-id').value = studentId;
            document.getElementById('note-student-name').textContent = student.studentName || '-';
            document.getElementById('note-auto-text').textContent = 'üí¨ Catatan otomatis: ' + autoNote.note.slice(0, 100) + '...';
            document.getElementById('note-custom-input').value = window._studentNotes[studentId] || '';
            document.getElementById('modal-note').classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.saveStudentNote = function() {
            const id = document.getElementById('note-student-id').value;
            const note = document.getElementById('note-custom-input').value.trim();
            window._studentNotes[id] = note;
            // Sisipkan ke dashboardData agar PDF bisa akses
            const data = dashboardData || [];
            const student = data.find(d => d.id === id);
            if (student) student._customNote = note;
            document.getElementById('modal-note').classList.add('hidden');
            // Toast notifikasi kecil
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 right-6 z-[999] bg-gray-900 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-xl animate-fade-in';
            toast.textContent = '‚úÖ Catatan pengawas disimpan';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        };

        // ‚îÄ‚îÄ Auto-update analitik ketika data berubah ‚îÄ‚îÄ
        const _origUpdateStatCards = window.updateStatCards || function(){};
        window._integrityAutoRefresh = function(data) {
            if (data) window._lastAnalitikData = data;
            const panel = document.getElementById('panel-analitik');
            if (panel && !panel.classList.contains('hidden-section')) {
                window.renderIntegrityDashboard();
            }
        };

        // ‚ïê‚ïê FITUR BARU: TAMPILKAN SKOR INTEGRITAS DI HASIL SISWA ‚ïê‚ïê
        // Patch fungsi finishExam untuk inject skor integritas ke halaman hasil
        const _origFinishExam = window._finishExamPatched;
        window._patchResultPage = function(viols, isDQ) {
            const intScore = window.getStudentIntegrityForResult(viols, isDQ);
            const cat = getIntegrityCategory(intScore);
            const existingBadge = document.getElementById('integrity-score-badge');
            if (existingBadge) existingBadge.remove();

            const resultSection = document.getElementById('section-result');
            if (!resultSection) return;
            const firstCard = resultSection.querySelector('.bg-white, [class*="bg-slate"]');
            if (!firstCard) return;

            const badge = document.createElement('div');
            badge.id = 'integrity-score-badge';
            badge.className = 'mt-4 mx-auto max-w-xs';
            badge.innerHTML = `
                <div class="rounded-2xl border-2 p-4 text-center ${intScore >= 80 ? 'border-emerald-300 bg-emerald-50' : intScore >= 60 ? 'border-amber-300 bg-amber-50' : 'border-red-300 bg-red-50'}">
                    <p class="text-xs font-bold uppercase tracking-wider ${intScore >= 80 ? 'text-emerald-600' : intScore >= 60 ? 'text-amber-600' : 'text-red-600'} mb-1">Skor Integritas Kamu</p>
                    <p class="text-5xl font-black ${intScore >= 80 ? 'text-emerald-600' : intScore >= 60 ? 'text-amber-600' : 'text-red-600'}">${intScore}</p>
                    <p class="text-sm font-bold mt-1 ${cat.text}">${cat.label}</p>
                    <p class="text-xs text-gray-400 mt-2">${intScore >= 100 ? 'Luar biasa! Kamu mengerjakan dengan jujur tanpa pelanggaran.' : intScore >= 80 ? 'Bagus! Kamu mengerjakan dengan cukup jujur.' : intScore >= 60 ? 'Ada beberapa pelanggaran terdeteksi.' : intScore > 0 ? 'Banyak pelanggaran terdeteksi sistem.' : 'Ujian tidak sah karena pelanggaran berulang.'}</p>
                </div>`;

            const scoreDisplay = document.getElementById('final-score-display');
            if (scoreDisplay && scoreDisplay.parentElement) {
                scoreDisplay.parentElement.after(badge);
            }
        };

        // EXPORT EXCEL PROFESIONAL
        // ============================================================
        function exportToExcelInternal() {
            if (typeof XLSX === 'undefined') { alert("Library XLSX belum siap, coba refresh halaman."); return; }

            const dataToExport = window.currentFilteredData && window.currentFilteredData.length > 0
                ? window.currentFilteredData : dashboardData;

            if (!dataToExport || dataToExport.length === 0) return alert("Belum ada data untuk diexport");

            // --- Ambil data tampilan dari settings ---
            const _app = window._savedAppearance || {};
            const namaUjian   = (_app.judulUjian || 'Rekap Nilai Ujian').trim();
            const namaSekolah = (_app.subJudul   || 'INTEGRITEST').trim();

            // --- Info filter untuk judul ---
            const filterPkt  = document.getElementById('filter-session').value;
            const filterCls  = document.getElementById('filter-class').value;
            const filterDate = document.getElementById('filter-date').value;

            const labelPkt  = filterPkt  !== 'all' ? `Paket ${filterPkt}` : 'Semua Paket';
            const labelCls  = filterCls  !== 'all' ? filterCls : 'Semua Kelas';
            const labelDate = filterDate ? filterDate : new Date().toLocaleDateString('id-ID');

            // --- Nama file dinamis ---
            let filename = namaUjian.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-]/g,'');
            if (!filename) filename = 'Rekap_Nilai';
            if (filterCls  !== 'all') filename += `_${filterCls.replace(/\s+/g,'-')}`;
            if (filterPkt  !== 'all') filename += `_Paket-${filterPkt}`;
            if (filterDate)           filename += `_${filterDate}`;
            filename += '.xlsx';

            // ================================================================
            // KALKULASI STATISTIK
            // ================================================================
            const scores = dataToExport.map(r => typeof r.score === 'number' ? r.score : parseFloat(r.score)).filter(s => !isNaN(s));
            const total      = dataToExport.length;
            const totalSelesai  = dataToExport.filter(r => r.status === 'SELESAI').length;
            const totalDQ       = dataToExport.filter(r => (r.status||'').includes('DISKUALIFIKASI')).length;
            const totalOngoing  = dataToExport.filter(r => r.status === 'SEDANG MENGERJAKAN').length;
            const avgScore   = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0) / scores.length) : 0;
            const maxScore   = scores.length ? Math.max(...scores) : 0;
            const minScore   = scores.length ? Math.min(...scores) : 0;
            const lulus      = scores.filter(s => s >= 75).length;
            const tLulus     = scores.filter(s => s < 75).length;
            const pctLulus   = scores.length ? Math.round((lulus / scores.length) * 100) : 0;

            // ================================================================
            // SHEET 1: REKAP NILAI (utama)
            // ================================================================
            const wb = XLSX.utils.book_new();

            // Baris header dokumen (baris 1-7 = info sekolah + judul)
            const headerRows = [
                [namaSekolah],                                               // R1: Nama Sekolah
                [namaUjian],                                                 // R2: Nama Ujian
                [''],                                                         // R3
                [`Laporan Rekap Nilai ‚Äî ${namaUjian}`],                      // R4
                [`Kelas: ${labelCls}  |  Paket: ${labelPkt}  |  Tanggal: ${labelDate}`], // R5
                [`Dicetak: ${new Date().toLocaleString('id-ID')}`],          // R6
                [''],                                                         // R7
            ];

            // Baris kolom tabel
            const colHeaders = [
                'No.', 'Tanggal', 'Jam', 'Nama Siswa', 'NISN', 'Kelas', 'Ruang',
                'Paket', 'Nilai', 'Predikat', 'Status', 'Pelanggaran'
            ];

            // Data baris
            const dataRows = dataToExport.map((row, i) => {
                const dateObj = new Date(row.timestamp);
                const dateStr = dateObj.toLocaleDateString('id-ID');
                const timeStr = dateObj.toLocaleTimeString('id-ID');
                const sc = typeof row.score === 'number' ? row.score : parseFloat(row.score);
                let predikat = '-';
                if (!isNaN(sc)) {
                    if (sc >= 90)      predikat = 'A (Sangat Baik)';
                    else if (sc >= 80) predikat = 'B (Baik)';
                    else if (sc >= 70) predikat = 'C (Cukup)';
                    else if (sc >= 60) predikat = 'D (Kurang)';
                    else               predikat = 'E (Sangat Kurang)';
                }
                return [
                    i + 1,
                    dateStr,
                    timeStr,
                    row.studentName  || '-',
                    row.studentNisn  || '-',
                    row.className    || '-',
                    row.ruangUjian   || '-',
                    `Paket ${row.packetType || '-'}`,
                    isNaN(sc) ? row.score : sc,
                    predikat,
                    row.status       || '-',
                    row.violations   || 0,
                ];
            });

            // Gabungkan semua ke dalam AOA
            const aoa = [
                ...headerRows,
                colHeaders,
                ...dataRows,
                [''], // baris kosong pemisah
            ];

            // Baris statistik di bagian bawah
            const statsStartRow = aoa.length + 1;
            aoa.push(['RINGKASAN STATISTIK']);
            aoa.push(['Total Peserta',     total]);
            aoa.push(['Selesai',           totalSelesai]);
            aoa.push(['Diskualifikasi',    totalDQ]);
            aoa.push(['Sedang Mengerjakan',totalOngoing]);
            aoa.push(['Nilai Rata-rata',   avgScore]);
            aoa.push(['Nilai Tertinggi',   maxScore]);
            aoa.push(['Nilai Terendah',    minScore]);
            aoa.push(['Lulus (‚â•75)',        lulus]);
            aoa.push(['Tidak Lulus (<75)', tLulus]);
            aoa.push(['Persentase Lulus',  `${pctLulus}%`]);

            const ws = XLSX.utils.aoa_to_sheet(aoa);

            // ---- Lebar kolom ----
            ws['!cols'] = [
                {wch: 5},   // No
                {wch: 13},  // Tanggal
                {wch: 10},  // Jam
                {wch: 28},  // Nama
                {wch: 14},  // NISN
                {wch: 12},  // Kelas
                {wch: 10},  // Paket
                {wch: 8},   // Nilai
                {wch: 20},  // Predikat
                {wch: 28},  // Status
                {wch: 12},  // Pelanggaran
            ];

            // ---- Baris header info (merge cells) ----
            // Judul sekolah merge A1:K1
            const lastCol = 10; // index K
            ws['!merges'] = [
                { s:{r:0,c:0}, e:{r:0,c:lastCol} }, // Nama sekolah
                { s:{r:1,c:0}, e:{r:1,c:lastCol} }, // Sistem
                { s:{r:3,c:0}, e:{r:3,c:lastCol} }, // Judul laporan
                { s:{r:4,c:0}, e:{r:4,c:lastCol} }, // Info filter
                { s:{r:5,c:0}, e:{r:5,c:lastCol} }, // Dicetak
                { s:{r:statsStartRow-1,c:0}, e:{r:statsStartRow-1,c:lastCol} }, // Ringkasan header
            ];

            // ---- STYLING menggunakan SheetJS style object ----
            // Helper: set cell style
            function sc_(ws, addr, style) {
                if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                ws[addr].s = style;
            }
            function cellAddr(r, c) {
                return XLSX.utils.encode_cell({r, c});
            }

            // Style definitions
            const styleTitleSchool = {
                font: { bold: true, sz: 16, color: { rgb: '1E3A5F' } },
                alignment: { horizontal: 'center', vertical: 'center' },
                fill: { fgColor: { rgb: 'DBEAFE' } },
            };
            const styleSubtitle = {
                font: { bold: false, sz: 11, color: { rgb: '374151' } },
                alignment: { horizontal: 'center' },
                fill: { fgColor: { rgb: 'DBEAFE' } },
            };
            const styleLaporan = {
                font: { bold: true, sz: 14, color: { rgb: 'FFFFFF' } },
                alignment: { horizontal: 'center', vertical: 'center' },
                fill: { fgColor: { rgb: '1D4ED8' } },
            };
            const styleFilter = {
                font: { sz: 10, color: { rgb: '374151' } },
                alignment: { horizontal: 'center' },
                fill: { fgColor: { rgb: 'EFF6FF' } },
            };
            const stylePrinted = {
                font: { italic: true, sz: 9, color: { rgb: '9CA3AF' } },
                alignment: { horizontal: 'center' },
                fill: { fgColor: { rgb: 'EFF6FF' } },
            };
            const styleColHeader = {
                font: { bold: true, sz: 10, color: { rgb: 'FFFFFF' } },
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                fill: { fgColor: { rgb: '1E40AF' } },
                border: {
                    top:    { style: 'thin', color: { rgb: '93C5FD' } },
                    bottom: { style: 'thin', color: { rgb: '93C5FD' } },
                    left:   { style: 'thin', color: { rgb: '93C5FD' } },
                    right:  { style: 'thin', color: { rgb: '93C5FD' } },
                }
            };
            const styleDataEven = {
                font: { sz: 10 },
                alignment: { vertical: 'center' },
                border: {
                    top:    { style: 'thin', color: { rgb: 'E5E7EB' } },
                    bottom: { style: 'thin', color: { rgb: 'E5E7EB' } },
                    left:   { style: 'thin', color: { rgb: 'E5E7EB' } },
                    right:  { style: 'thin', color: { rgb: 'E5E7EB' } },
                }
            };
            const styleDataOdd = {
                font: { sz: 10 },
                alignment: { vertical: 'center' },
                fill: { fgColor: { rgb: 'F0F9FF' } },
                border: {
                    top:    { style: 'thin', color: { rgb: 'E5E7EB' } },
                    bottom: { style: 'thin', color: { rgb: 'E5E7EB' } },
                    left:   { style: 'thin', color: { rgb: 'E5E7EB' } },
                    right:  { style: 'thin', color: { rgb: 'E5E7EB' } },
                }
            };
            const styleCenter = { alignment: { horizontal: 'center', vertical: 'center' } };
            const styleStatsHeader = {
                font: { bold: true, sz: 11, color: { rgb: 'FFFFFF' } },
                fill: { fgColor: { rgb: '059669' } },
                alignment: { horizontal: 'center' },
            };
            const styleStatsLabel = {
                font: { bold: true, sz: 10, color: { rgb: '065F46' } },
                fill: { fgColor: { rgb: 'D1FAE5' } },
                alignment: { horizontal: 'left' },
                border: { bottom: { style: 'thin', color: { rgb: 'A7F3D0' } } }
            };
            const styleStatsValue = {
                font: { bold: true, sz: 10, color: { rgb: '1D4ED8' } },
                fill: { fgColor: { rgb: 'EFF6FF' } },
                alignment: { horizontal: 'center' },
                border: { bottom: { style: 'thin', color: { rgb: 'BFDBFE' } } }
            };

            // Apply header styles
            for (let c = 0; c <= lastCol; c++) {
                sc_(ws, cellAddr(0, c), styleTitleSchool);
                sc_(ws, cellAddr(1, c), styleSubtitle);
                sc_(ws, cellAddr(3, c), styleLaporan);
                sc_(ws, cellAddr(4, c), styleFilter);
                sc_(ws, cellAddr(5, c), stylePrinted);
            }

            // Row heights (in points)
            ws['!rows'] = [];
            ws['!rows'][0] = { hpt: 30 }; // sekolah
            ws['!rows'][1] = { hpt: 18 };
            ws['!rows'][3] = { hpt: 26 }; // judul laporan
            ws['!rows'][4] = { hpt: 18 };
            ws['!rows'][5] = { hpt: 15 };
            ws['!rows'][7] = { hpt: 22 }; // col headers (row index 7)

            // Apply column header styles (row 7 = index 7)
            const colHeaderRow = 7;
            for (let c = 0; c <= lastCol; c++) {
                sc_(ws, cellAddr(colHeaderRow, c), styleColHeader);
            }

            // Apply data row styles
            dataRows.forEach((row, i) => {
                const r = colHeaderRow + 1 + i;
                const baseStyle = i % 2 === 0 ? styleDataEven : styleDataOdd;
                const sc = row[7]; // nilai (index 7)

                for (let c = 0; c <= lastCol; c++) {
                    let style = JSON.parse(JSON.stringify(baseStyle));

                    // Kolom No, Tanggal, Jam, Paket, Nilai, Predikat, Pelanggaran ‚Üí center
                    if ([0, 1, 2, 6, 7, 8, 10].includes(c)) {
                        style.alignment = { ...style.alignment, horizontal: 'center' };
                    }

                    // Kolom Nilai ‚Äî warnai sesuai nilai
                    if (c === 7 && typeof sc === 'number') {
                        style.font = { bold: true, sz: 11 };
                        if (sc >= 80)      style.font.color = { rgb: '16A34A' };
                        else if (sc >= 75) style.font.color = { rgb: 'D97706' };
                        else               style.font.color = { rgb: 'DC2626' };
                    }

                    // Kolom Status ‚Äî warnai
                    if (c === 9) {
                        const status = row[9] || '';
                        if (status.includes('DISKUALIFIKASI')) {
                            style.font = { bold: true, sz: 10, color: { rgb: 'DC2626' } };
                            style.fill = { fgColor: { rgb: 'FEE2E2' } };
                        } else if (status === 'SELESAI') {
                            style.font = { bold: true, sz: 10, color: { rgb: '16A34A' } };
                        } else if (status === 'SEDANG MENGERJAKAN') {
                            style.font = { bold: false, sz: 10, color: { rgb: '2563EB' } };
                        }
                    }

                    // Kolom Pelanggaran
                    if (c === 10 && row[10] > 0) {
                        style.font = { bold: true, sz: 10, color: { rgb: 'DC2626' } };
                    }

                    sc_(ws, cellAddr(r, c), style);
                }
            });

            // Apply statistik styles
            const statsLabelRow = statsStartRow; // row index di AOA (0-based)
            sc_(ws, cellAddr(statsLabelRow - 1, 0), styleStatsHeader); // "RINGKASAN STATISTIK"
            for (let c = 1; c <= lastCol; c++) sc_(ws, cellAddr(statsLabelRow - 1, c), styleStatsHeader);

            for (let i = 0; i < 11; i++) {
                sc_(ws, cellAddr(statsLabelRow + i, 0), styleStatsLabel);
                sc_(ws, cellAddr(statsLabelRow + i, 1), styleStatsValue);
            }

            XLSX.utils.book_append_sheet(wb, ws, 'Rekap Nilai');

            // ================================================================
            // SHEET 2: STATISTIK PER KELAS (baru, lebih detail)
            // ================================================================
            const wsKelas = buildKelasStatistikSheet(dataToExport);
            if (wsKelas) XLSX.utils.book_append_sheet(wb, wsKelas, 'Statistik Per Kelas');

            // ================================================================
            // SHEET 3: ANALISIS PER KELAS (grafik data)
            // ================================================================
            const wsAnalysis = buildAnalysisSheet(dataToExport);
            if (wsAnalysis) XLSX.utils.book_append_sheet(wb, wsAnalysis, 'Distribusi Nilai');

            // ================================================================
            // SHEET 3: DETAIL PELANGGARAN
            // ================================================================
            const wsPelanggaran = buildPelanggaranSheet(dataToExport);
            if (wsPelanggaran) XLSX.utils.book_append_sheet(wb, wsPelanggaran, 'Detail Pelanggaran');

            // Tulis file
            XLSX.writeFile(wb, filename);
        }

        function buildKelasStatistikSheet(data) {
            if (!data || data.length === 0) return null;

            const finishedData = data.filter(r => r.status !== 'SEDANG MENGERJAKAN' && !r.status.includes('MELANJUTKAN'));
            if (finishedData.length === 0) return null;

            const _app2 = window._savedAppearance || {};
            const _namaUjian2   = (_app2.judulUjian || 'Rekap Nilai Ujian').trim();
            const _namaSekolah2 = (_app2.subJudul   || 'INTEGRITEST').trim();

            const now = new Date().toLocaleString('id-ID');
            const byKelas = {};
            finishedData.forEach(row => {
                const cls = row.className || 'Tidak Diketahui';
                if (!byKelas[cls]) byKelas[cls] = [];
                byKelas[cls].push(row);
            });

            const aoa = [
                [_namaSekolah2],
                [`${_namaUjian2} ‚Äî Statistik Nilai Per Kelas`],
                [`Dicetak: ${now}`],
                [''],
            ];

            function sc_(ws, addr, style) { if (!ws[addr]) ws[addr] = {v:'',t:'s'}; ws[addr].s = style; }
            function ca(r, c) { return XLSX.utils.encode_cell({r, c}); }

            const merges = [
                { s:{r:0,c:0}, e:{r:0,c:11} }, // Nama sekolah
                { s:{r:1,c:0}, e:{r:1,c:11} }, // Nama ujian
                { s:{r:2,c:0}, e:{r:2,c:11} }, // Dicetak
            ];
            let currentRow = 4; // 0-indexed (mulai setelah 4 baris header)

            Object.entries(byKelas).sort().forEach(([kelas, rows]) => {
                const scores = rows.map(r => typeof r.score === 'number' ? r.score : parseFloat(r.score)).filter(s => !isNaN(s));
                const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1) : '-';
                const max = scores.length ? Math.max(...scores) : '-';
                const min = scores.length ? Math.min(...scores) : '-';
                const lulus = scores.filter(s => s >= 75).length;
                const tLulus = scores.filter(s => s < 75).length;
                const pct = scores.length ? Math.round((lulus/scores.length)*100) : 0;
                const dq = rows.filter(r => (r.status||'').includes('DISKUALIFIKASI')).length;
                const avgViol = rows.length ? (rows.reduce((a,r)=>a+(r.violations||0),0)/rows.length).toFixed(2) : 0;

                // Distribusi per kelas
                const dist = [
                    { label:'A (90-100)', cnt: scores.filter(s=>s>=90).length },
                    { label:'B (80-89)',  cnt: scores.filter(s=>s>=80&&s<90).length },
                    { label:'C (70-79)',  cnt: scores.filter(s=>s>=70&&s<80).length },
                    { label:'D (60-69)',  cnt: scores.filter(s=>s>=60&&s<70).length },
                    { label:'E (<60)',    cnt: scores.filter(s=>s<60).length },
                ];

                // Header kelas
                aoa.push([`KELAS: ${kelas}`, '', '', '', '', '', '', '', '', '', '', '']);
                merges.push({ s:{r:currentRow,c:0}, e:{r:currentRow,c:11} });
                currentRow++;

                // Sub-header ringkasan
                aoa.push(['Peserta', 'Selesai', 'Rata-rata', 'Tertinggi', 'Terendah', 'Lulus (‚â•75)', 'Tidak Lulus', '% Lulus', 'DQ', 'Rata-rata Pelanggaran', '', '']);
                currentRow++;

                // Data ringkasan
                aoa.push([rows.length, rows.filter(r=>r.status==='SELESAI').length, parseFloat(avg), max, min, lulus, tLulus, `${pct}%`, dq, parseFloat(avgViol), '', '']);
                currentRow++;

                // Distribusi
                aoa.push(['Predikat', 'Jumlah', '% dari kelas', '', '', '', '', '', '', '', '', '']);
                currentRow++;
                dist.forEach(d => {
                    const dpct = scores.length ? Math.round((d.cnt/scores.length)*100) : 0;
                    aoa.push([d.label, d.cnt, `${dpct}%`, '', '', '', '', '', '', '', '', '']);
                    currentRow++;
                });

                aoa.push(['']); currentRow++;
            });

            const ws = XLSX.utils.aoa_to_sheet(aoa);
            ws['!cols'] = Array(12).fill({wch:14});
            ws['!cols'][0] = {wch:20};
            ws['!merges'] = merges;

            // Apply styles for title
            for (let c = 0; c <= 11; c++) {
                sc_(ws, ca(0,c), { font:{bold:true,sz:14,color:{rgb:'1E3A5F'}}, fill:{fgColor:{rgb:'DBEAFE'}}, alignment:{horizontal:'center'} });
                sc_(ws, ca(1,c), { font:{bold:true,sz:13,color:{rgb:'1E40AF'}}, fill:{fgColor:{rgb:'EFF6FF'}}, alignment:{horizontal:'center'} });
                sc_(ws, ca(2,c), { font:{sz:9,color:{rgb:'6B7280'}}, fill:{fgColor:{rgb:'F8FAFC'}}, alignment:{horizontal:'center'} });
            }
            ws['!rows'] = [];
            ws['!rows'][0] = { hpt: 26 };
            ws['!rows'][1] = { hpt: 22 };
            ws['!rows'][2] = { hpt: 14 };

            return ws;
        }

        function buildAnalysisSheet(data) {
            if (!data || data.length === 0) return null;

            // ‚îÄ‚îÄ Hanya data yang sudah selesai untuk analisis ‚îÄ‚îÄ
            const finishedData = data.filter(r => r.status !== 'SEDANG MENGERJAKAN' && !r.status.includes('MELANJUTKAN'));

            // Group by kelas
            const byKelas = {};
            finishedData.forEach(row => {
                const cls = row.className || 'Tidak Diketahui';
                if (!byKelas[cls]) byKelas[cls] = [];
                byKelas[cls].push(row);
            });

            const _app3 = window._savedAppearance || {};
            const _namaUjian3   = (_app3.judulUjian || 'Rekap Nilai Ujian').trim();
            const _namaSekolah3 = (_app3.subJudul   || 'INTEGRITEST').trim();

            const now = new Date().toLocaleString('id-ID');
            const aoa = [
                [_namaSekolah3],
                [`${_namaUjian3} ‚Äî Analisis Statistik Per Kelas`],
                [`Dicetak: ${now}   |   Total Data: ${finishedData.length} peserta (sudah selesai)`],
                [''],
                ['Kelas', 'Peserta', 'Rata-rata', 'Tertinggi', 'Terendah', 'Lulus (‚â•75)', 'Tidak Lulus', '% Lulus', 'DQ', 'Rata-rata Pelanggaran'],
            ];

            const classRows = [];
            Object.entries(byKelas).sort().forEach(([kelas, rows]) => {
                const scores = rows.map(r => typeof r.score === 'number' ? r.score : parseFloat(r.score)).filter(s => !isNaN(s));
                const avg    = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1) : '-';
                const max    = scores.length ? Math.max(...scores) : '-';
                const min    = scores.length ? Math.min(...scores) : '-';
                const lulus  = scores.filter(s => s >= 75).length;
                const tLulus = scores.filter(s => s < 75).length;
                const pct    = scores.length ? Math.round((lulus/scores.length)*100) : 0;
                const dq     = rows.filter(r => (r.status||'').includes('DISKUALIFIKASI')).length;
                const avgViol = rows.length ? (rows.reduce((a,r)=>a+(r.violations||0),0)/rows.length).toFixed(1) : 0;
                const rowData = [kelas, rows.length, parseFloat(avg), max, min, lulus, tLulus, `${pct}%`, dq, parseFloat(avgViol)];
                aoa.push(rowData);
                classRows.push({ pct, avg: parseFloat(avg), dq });
            });

            // Baris total
            aoa.push(['']);
            const allScores = finishedData.map(r => typeof r.score === 'number' ? r.score : parseFloat(r.score)).filter(s => !isNaN(s));
            const totalLulus = allScores.filter(s => s >= 75).length;
            const totalDQ = finishedData.filter(r => (r.status||'').includes('DISKUALIFIKASI')).length;
            const grandAvg = allScores.length ? (allScores.reduce((a,b)=>a+b,0)/allScores.length).toFixed(1) : 0;
            const grandAvgViol = finishedData.length ? (finishedData.reduce((a,r)=>a+(r.violations||0),0)/finishedData.length).toFixed(1) : 0;
            aoa.push([
                'GRAND TOTAL',
                finishedData.length,
                parseFloat(grandAvg),
                allScores.length ? Math.max(...allScores) : '-',
                allScores.length ? Math.min(...allScores) : '-',
                totalLulus,
                allScores.filter(s => s < 75).length,
                allScores.length ? `${Math.round((totalLulus/allScores.length)*100)}%` : '-',
                totalDQ,
                parseFloat(grandAvgViol),
            ]);

            // ‚îÄ‚îÄ Distribusi Nilai ‚îÄ‚îÄ
            aoa.push(['']);
            aoa.push(['DISTRIBUSI NILAI (KESELURUHAN)']);
            aoa.push(['Rentang', 'Predikat', 'Jumlah Siswa', 'Persentase']);
            const distrib = [
                { label:'90 - 100', pred:'A (Sangat Baik)',  filter: s => s >= 90 },
                { label:'80 - 89',  pred:'B (Baik)',          filter: s => s >= 80 && s < 90 },
                { label:'70 - 79',  pred:'C (Cukup)',         filter: s => s >= 70 && s < 80 },
                { label:'60 - 69',  pred:'D (Kurang)',        filter: s => s >= 60 && s < 70 },
                { label:'< 60',     pred:'E (Sangat Kurang)', filter: s => s < 60  },
            ];
            distrib.forEach(d => {
                const cnt = allScores.filter(d.filter).length;
                const pct = allScores.length ? Math.round((cnt/allScores.length)*100) : 0;
                aoa.push([d.label, d.pred, cnt, `${pct}%`]);
            });

            const ws = XLSX.utils.aoa_to_sheet(aoa);
            ws['!cols'] = [{wch:20},{wch:10},{wch:12},{wch:12},{wch:12},{wch:13},{wch:13},{wch:10},{wch:6},{wch:18}];
            ws['!merges'] = [
                { s:{r:0,c:0}, e:{r:0,c:9} },
                { s:{r:1,c:0}, e:{r:1,c:9} },
                { s:{r:2,c:0}, e:{r:2,c:9} },
            ];

            // Helper style cells
            function sc_(ws, addr, style) {
                if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                ws[addr].s = style;
            }
            function ca(r, c) { return XLSX.utils.encode_cell({r, c}); }

            const sTitle = { font:{bold:true,sz:14,color:{rgb:'1E3A5F'}}, fill:{fgColor:{rgb:'DBEAFE'}}, alignment:{horizontal:'center'} };
            const sSub   = { font:{bold:true,sz:13,color:{rgb:'1E40AF'}}, fill:{fgColor:{rgb:'EFF6FF'}}, alignment:{horizontal:'center'} };
            const sSub2  = { font:{sz:9,color:{rgb:'6B7280'}}, fill:{fgColor:{rgb:'F8FAFC'}}, alignment:{horizontal:'center'} };
            const sHead  = { font:{bold:true,sz:10,color:{rgb:'FFFFFF'}}, fill:{fgColor:{rgb:'1E40AF'}}, alignment:{horizontal:'center',wrapText:true},
                             border:{top:{style:'thin',color:{rgb:'93C5FD'}},bottom:{style:'thin',color:{rgb:'93C5FD'}},left:{style:'thin',color:{rgb:'93C5FD'}},right:{style:'thin',color:{rgb:'93C5FD'}}} };
            const sTotal = { font:{bold:true,sz:10,color:{rgb:'FFFFFF'}}, fill:{fgColor:{rgb:'1D4ED8'}}, alignment:{horizontal:'center'} };
            const sDHead = { font:{bold:true,sz:11,color:{rgb:'FFFFFF'}}, fill:{fgColor:{rgb:'7C3AED'}}, alignment:{horizontal:'center'} };
            const sDSub  = { font:{bold:true,sz:9,color:{rgb:'FFFFFF'}},  fill:{fgColor:{rgb:'7C3AED'}}, alignment:{horizontal:'center'} };

            // Title rows
            for (let c = 0; c <= 9; c++) {
                sc_(ws, ca(0,c), sTitle);
                sc_(ws, ca(1,c), sSub);
                sc_(ws, ca(2,c), sSub2);
            }
            // Header row (row 4)
            for (let c = 0; c <= 9; c++) sc_(ws, ca(4,c), sHead);

            // Data rows
            const dataStartR = 5;
            classRows.forEach((cr, i) => {
                const r = dataStartR + i;
                const baseEven = { font:{sz:10}, fill:{fgColor:{rgb:'F0F9FF'}}, alignment:{horizontal:'center'}, border:{bottom:{style:'thin',color:{rgb:'E5E7EB'}}} };
                const baseOdd  = { font:{sz:10}, alignment:{horizontal:'center'}, border:{bottom:{style:'thin',color:{rgb:'E5E7EB'}}} };
                const base = i%2===0 ? baseEven : baseOdd;
                for (let c = 0; c <= 9; c++) {
                    let s = JSON.parse(JSON.stringify(base));
                    if (c === 0) s.alignment = { horizontal:'left' };
                    // % Lulus (c=7): warna sesuai pct
                    if (c === 7) {
                        s.font = { bold:true, sz:10, color:{ rgb: cr.pct>=75 ? '16A34A' : cr.pct>=50 ? 'D97706' : 'DC2626' } };
                    }
                    // Rata-rata (c=2): warna
                    if (c === 2) {
                        s.font = { bold:true, sz:10, color:{ rgb: cr.avg>=80 ? '16A34A' : cr.avg>=60 ? 'D97706' : 'DC2626' } };
                    }
                    // DQ (c=8): merah jika ada
                    if (c === 8 && cr.dq > 0) {
                        s.font = { bold:true, sz:10, color:{ rgb:'DC2626' } };
                    }
                    sc_(ws, ca(r, c), s);
                }
            });

            // Grand total row
            const totalR = dataStartR + classRows.length + 1; // +1 for empty row
            for (let c = 0; c <= 9; c++) sc_(ws, ca(totalR, c), sTotal);

            // Distribusi section header
            const distribTitleR = totalR + 2;
            for (let c = 0; c <= 9; c++) sc_(ws, ca(distribTitleR, c), sDHead);
            const distribHeadR = distribTitleR + 1;
            for (let c = 0; c <= 3; c++) sc_(ws, ca(distribHeadR, c), sDSub);

            ws['!rows'] = [];
            ws['!rows'][0] = { hpt: 28 };
            ws['!rows'][4] = { hpt: 22 };

            return ws;
        }

        function buildPelanggaranSheet(data) {
            const cheaters = data.filter(r => r.violations > 0 || (r.status||'').includes('DISKUALIFIKASI'));
            if (cheaters.length === 0) return null;

            const _app4 = window._savedAppearance || {};
            const _namaUjian4   = (_app4.judulUjian || 'Rekap Nilai Ujian').trim();
            const _namaSekolah4 = (_app4.subJudul   || 'INTEGRITEST').trim();

            const aoa = [
                [_namaSekolah4],
                [`${_namaUjian4} ‚Äî Laporan Detail Pelanggaran`],
                [`Dicetak: ${new Date().toLocaleString('id-ID')}`],
                [''],
                ['No.', 'Nama Siswa', 'NISN', 'Kelas', 'Paket', 'Nilai', 'Status', 'Jml Pelanggaran', 'Log Pelanggaran'],
            ];

            cheaters.forEach((row, i) => {
                const logs = (row.violationLogs || []).map((l, li) => {
                    const t = new Date(l.time).toLocaleTimeString('id-ID');
                    return `${li+1}. [${t}] ${l.message}`;
                }).join('\n');
                aoa.push([
                    i + 1,
                    row.studentName  || '-',
                    row.studentNisn  || '-',
                    row.className    || '-',
                    `Paket ${row.packetType || '-'}`,
                    row.score,
                    row.status       || '-',
                    row.violations   || 0,
                    logs || 'Tidak ada log',
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(aoa);
            ws['!cols'] = [{wch:5},{wch:28},{wch:14},{wch:12},{wch:10},{wch:8},{wch:28},{wch:15},{wch:60}];
            ws['!merges'] = [
                { s:{r:0,c:0}, e:{r:0,c:8} }, // Nama sekolah
                { s:{r:1,c:0}, e:{r:1,c:8} }, // Nama ujian
                { s:{r:2,c:0}, e:{r:2,c:8} }, // Dicetak
            ];

            // Style header pelanggaran
            function sc_p(ws, addr, style) { if (!ws[addr]) ws[addr] = {v:'',t:'s'}; ws[addr].s = style; }
            function ca_p(r, c) { return XLSX.utils.encode_cell({r, c}); }
            for (let c = 0; c <= 8; c++) {
                sc_p(ws, ca_p(0,c), { font:{bold:true,sz:14,color:{rgb:'7F1D1D'}}, fill:{fgColor:{rgb:'FEE2E2'}}, alignment:{horizontal:'center'} });
                sc_p(ws, ca_p(1,c), { font:{bold:true,sz:12,color:{rgb:'991B1B'}}, fill:{fgColor:{rgb:'FEF2F2'}}, alignment:{horizontal:'center'} });
                sc_p(ws, ca_p(2,c), { font:{sz:9,color:{rgb:'6B7280'}}, fill:{fgColor:{rgb:'F8FAFC'}},            alignment:{horizontal:'center'} });
                sc_p(ws, ca_p(4,c), { font:{bold:true,sz:10,color:{rgb:'FFFFFF'}}, fill:{fgColor:{rgb:'DC2626'}}, alignment:{horizontal:'center',wrapText:true} });
            }
            ws['!rows'] = [{ hpt:24 },{ hpt:20 },{ hpt:14 },{},{ hpt:22 }];
            return ws;
        }

        // ==========================================
        // IMPORT SOAL - EXCEL & WORD + DOWNLOAD TEMPLATE
        // ==========================================

        // Variabel global untuk menyimpan soal yang sudah di-parse
        window.parsedExcelQuestions = [];
        window.parsedWordQuestions  = [];


        // ---------- DOWNLOAD TEMPLATE EXCEL ----------
        window.downloadExcelTemplate = function() {
            if (typeof XLSX === 'undefined') { alert("Library XLSX belum siap, coba refresh halaman."); return; }

            const wb = XLSX.utils.book_new();

            // Sheet 1: Template kosong
            const header = [['packet','question','question_image','option_a','image_a','option_b','image_b','option_c','image_c','option_d','image_d','option_e','image_e','correct']];
            const contoh = [
                ['A','Apa kepanjangan dari TKJ?','','Teknik Komputer dan Jaringan','','Teknologi Komunikasi Jaringan','','Teknik Komunikasi dan Jaringan','','Teknologi Komputer dan Jaringan','','','','A'],
                ['A','Protokol untuk mengirim email adalah...','','SMTP','','HTTP','','FTP','','SSH','','DNS','','A'],
                ['B','Perhatikan topologi jaringan berikut!','https://drive.google.com/file/d/GANTI_ID_GAMBAR_SOAL/view','Star','','Bus','','Ring','','Mesh','','','','A'],
                ['C','Pilih gambar yang menunjukkan kabel UTP!','','','https://drive.google.com/file/d/GANTI_ID_GAMBAR_A/view','','https://drive.google.com/file/d/GANTI_ID_GAMBAR_B/view','','','','','','','','A'],
            ];
            const wsData = [...header, ...contoh];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Set lebar kolom
            ws['!cols'] = [
                {wch:8},{wch:50},{wch:45},{wch:28},{wch:45},{wch:28},{wch:45},{wch:28},{wch:45},{wch:28},{wch:45},{wch:28},{wch:45},{wch:10}
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Template Soal');

            // Sheet 2: Petunjuk
            const petunjuk = [
                ['PETUNJUK PENGISIAN TEMPLATE SOAL (dengan dukungan gambar)'],
                [''],
                ['Kolom','Keterangan','Contoh'],
                ['packet','Paket soal: A, B, atau C','A'],
                ['question','Teks pertanyaan (boleh kosong jika soal hanya berupa gambar)','Perhatikan gambar topologi berikut!'],
                ['question_image','[OPSIONAL] URL gambar soal dari Google Drive atau URL langsung','https://drive.google.com/file/d/ID_FILE/view'],
                ['option_a','Teks pilihan jawaban A (boleh kosong jika pilihan berupa gambar)','Star Topology'],
                ['image_a','[OPSIONAL] URL gambar untuk pilihan A','https://drive.google.com/file/d/ID_FILE_A/view'],
                ['option_b','Teks pilihan jawaban B','Bus Topology'],
                ['image_b','[OPSIONAL] URL gambar untuk pilihan B',''],
                ['option_c','Teks pilihan jawaban C','Ring Topology'],
                ['image_c','[OPSIONAL] URL gambar untuk pilihan C',''],
                ['option_d','Teks pilihan jawaban D','Mesh Topology'],
                ['image_d','[OPSIONAL] URL gambar untuk pilihan D',''],
                ['option_e','Teks pilihan jawaban E (opsional)',''],
                ['image_e','[OPSIONAL] URL gambar untuk pilihan E',''],
                ['correct','Huruf jawaban benar: A, B, C, D, atau E (WAJIB huruf kapital)','A'],
                [''],
                ['CARA MENDAPATKAN LINK GOOGLE DRIVE:'],
                ['1. Upload gambar ke Google Drive'],
                ['2. Klik kanan file gambar ‚Üí pilih "Bagikan" atau "Share"'],
                ['3. Ubah akses menjadi "Siapa pun yang memiliki link"'],
                ['4. Salin link dan paste di kolom question_image atau image_a/b/c/d/e'],
                ['5. Sistem akan otomatis mengkonversi link ke format yang bisa ditampilkan'],
                [''],
                ['CATATAN PENTING:'],
                ['- Kolom gambar semuanya OPSIONAL, boleh dikosongkan'],
                ['- question + question_image tidak boleh keduanya kosong'],
                ['- Minimal 4 pilihan jawaban (A-D) harus ada, option_e opsional'],
                ['- correct HARUS huruf kapital: A, B, C, D, atau E'],
                ['- Paket harus huruf kapital: A, B, atau C'],
            ];
            const wsPetunjuk = XLSX.utils.aoa_to_sheet(petunjuk);
            wsPetunjuk['!cols'] = [{wch:12},{wch:50},{wch:40}];
            XLSX.utils.book_append_sheet(wb, wsPetunjuk, 'Petunjuk');

            XLSX.writeFile(wb, 'Template_Soal_INTEGRITEST.xlsx');
        };

        // ---------- DOWNLOAD TEMPLATE WORD (sebagai HTML yang dibuka Word) ----------
        window.downloadWordTemplate = function() {
            const html = `
<html xmlns:o='urn:schemas-microsoft-com:office:office'
      xmlns:w='urn:schemas-microsoft-com:office:word'
      xmlns='http://www.w3.org/TR/REC-html40'>
<head>
<meta charset='utf-8'>
<title>Template Soal INTEGRITEST</title>
<style>
body { font-family: Arial, sans-serif; font-size: 11pt; }
h1 { font-size: 14pt; color: #1d4ed8; }
h2 { font-size: 12pt; color: #374151; }
table { border-collapse: collapse; width: 100%; }
th { background: #1d4ed8; color: white; padding: 8px; border: 1px solid #93c5fd; font-size: 10pt; }
td { padding: 8px; border: 1px solid #d1d5db; font-size: 10pt; vertical-align: top; }
tr:nth-child(even) { background: #eff6ff; }
.note { background: #fef3c7; border: 1px solid #f59e0b; padding: 10px; margin: 10px 0; border-radius: 4px; }
.correct { color: #16a34a; font-weight: bold; }
</style>
</head>
<body>
<h1>Template Soal - INTEGRITEST</h1>
<div class="note">
<strong>&#9888; PETUNJUK PENTING:</strong><br>
&bull; Jangan ubah nama kolom pada baris pertama tabel<br>
&bull; Kolom <b>packet</b>: isi dengan A, B, atau C (huruf kapital)<br>
&bull; Kolom <b>correct</b>: isi dengan huruf kapital A, B, C, D, atau E<br>
&bull; Kolom gambar (<b>question_image, image_a, image_b</b> dst): isi URL Google Drive &mdash; klik kanan file di Drive &rarr; Bagikan &rarr; Salin link<br>
&bull; Kolom gambar boleh dikosongkan (opsional)<br>
&bull; Soal boleh hanya berupa gambar tanpa teks, atau gambar + teks<br>
&bull; Simpan file dalam format .docx sebelum diimport
</div>

<h2>Tabel Soal (isi di bawah baris header)</h2>
<table>
<tr>
<th>packet</th>
<th>question</th>
<th>question_image</th>
<th>option_a</th>
<th>image_a</th>
<th>option_b</th>
<th>image_b</th>
<th>option_c</th>
<th>image_c</th>
<th>option_d</th>
<th>image_d</th>
<th>option_e</th>
<th>image_e</th>
<th>correct</th>
</tr>
<tr>
<td>A</td>
<td>Apa kepanjangan dari TKJ?</td>
<td></td>
<td>Teknik Komputer dan Jaringan</td><td></td>
<td>Teknologi Komunikasi Jaringan</td><td></td>
<td>Teknik Komunikasi dan Jaringan</td><td></td>
<td>Teknologi Komputer dan Jaringan</td><td></td>
<td>Teknik Komputer dan Jasa</td><td></td>
<td class="correct">A</td>
</tr>
<tr>
<td>B</td>
<td>Perhatikan topologi jaringan berikut ini!</td>
<td>https://drive.google.com/file/d/GANTI_ID_GAMBAR_SOAL/view</td>
<td>Star Topology</td><td></td>
<td>Bus Topology</td><td></td>
<td>Ring Topology</td><td></td>
<td>Mesh Topology</td><td></td>
<td></td><td></td>
<td class="correct">A</td>
</tr>
<tr>
<td>C</td>
<td>Pilih gambar yang menunjukkan kabel UTP!</td>
<td></td>
<td></td><td>https://drive.google.com/file/d/ID_GAMBAR_A/view</td>
<td></td><td>https://drive.google.com/file/d/ID_GAMBAR_B/view</td>
<td></td><td>https://drive.google.com/file/d/ID_GAMBAR_C/view</td>
<td></td><td>https://drive.google.com/file/d/ID_GAMBAR_D/view</td>
<td></td><td></td>
<td class="correct">A</td>
</tr>
</table>
<br>
<p><i>Tambahkan soal baru dengan menambah baris di bawah contoh di atas. Hapus baris contoh sebelum diimport jika tidak diperlukan.</i></p>
</body></html>`;

            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Template_Soal_INTEGRITEST.doc';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // ---------- HELPER: Build preview table HTML ----------
        function buildPreviewTable(questions) {
            if (!questions || questions.length === 0) return '<p class="p-4 text-gray-400">Tidak ada soal valid yang terdeteksi.</p>';
            const rows = questions.slice(0, 10).map((q, i) => {
                const hasQImg  = q.image ? 'üñºÔ∏è' : '';
                const hasOptImg = (q.optionImages || []).some(x => x) ? 'üñºÔ∏è' : '';
                const pktColor = q.packet==='A'?'bg-blue-100 text-blue-700':q.packet==='B'?'bg-purple-100 text-purple-700':'bg-orange-100 text-orange-700';
                return `<tr class="${i%2===0?'bg-white':'bg-gray-50'}">
                    <td class="px-3 py-2 text-center font-bold text-xs">${i+1}</td>
                    <td class="px-3 py-2"><span class="inline-block px-2 py-0.5 rounded text-xs font-bold ${pktColor}">${q.packet}</span></td>
                    <td class="px-3 py-2 text-xs text-gray-700 max-w-xs truncate">${hasQImg} ${q.text || '<em class="text-gray-400">hanya gambar</em>'}</td>
                    <td class="px-3 py-2 text-xs text-gray-500 text-center">${q.options.length} ${hasOptImg}</td>
                    <td class="px-3 py-2 text-center"><span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">${['A','B','C','D','E'][q.correct]}</span></td>
                </tr>`;
            }).join('');
            const extra = questions.length > 10 ? `<tr><td colspan="5" class="px-3 py-2 text-center text-gray-400 text-xs">... dan ${questions.length-10} soal lainnya</td></tr>` : '';
            return `<table class="w-full text-sm">
                <thead class="bg-gray-100 text-gray-700 text-xs font-bold">
                    <tr><th class="px-3 py-2">#</th><th class="px-3 py-2">Paket</th><th class="px-3 py-2 text-left">Pertanyaan</th><th class="px-3 py-2 text-center">Opsi</th><th class="px-3 py-2">Kunci</th></tr>
                </thead>
                <tbody>${rows}${extra}</tbody>
            </table>`;
        }

        // ---------- HELPER: Parse rows jadi format soal (dengan dukungan gambar) ----------
        function parseRows(rows) {
            const questions  = [];
            const correctMap = { A:0, B:1, C:2, D:3, E:4 };
            rows.forEach((row) => {
                const g = (keys) => { for(const k of keys) { const v = row[k]; if(v !== undefined && v !== null) return v.toString().trim(); } return ''; };

                const packet  = g(['packet','Packet','PACKET']).toUpperCase();
                const text    = g(['question','Question','QUESTION','pertanyaan','soal']);
                const optA    = g(['option_a','Option_A','option_A','a','A','pilihan_a']);
                const optB    = g(['option_b','Option_B','option_B','b','B','pilihan_b']);
                const optC    = g(['option_c','Option_C','option_C','c','C','pilihan_c']);
                const optD    = g(['option_d','Option_D','option_D','d','D','pilihan_d']);
                const optE    = g(['option_e','Option_E','option_E','e','E','pilihan_e']);
                const correct = g(['correct','Correct','CORRECT','kunci','jawaban']).toUpperCase();

                // Gambar soal & gambar tiap opsi (URL Google Drive atau URL biasa)
                const qImg  = g(['question_image','image','gambar_soal','img']);
                const imgA  = g(['image_a','img_a','gambar_a']);
                const imgB  = g(['image_b','img_b','gambar_b']);
                const imgC  = g(['image_c','img_c','gambar_c']);
                const imgD  = g(['image_d','img_d','gambar_d']);
                const imgE  = g(['image_e','img_e','gambar_e']);

                if (!packet || !['A','B','C'].includes(packet)) return;
                if (!text && !qImg) return;  // Boleh hanya gambar tanpa teks
                if (!optA || !optB || !optC || !optD) return;
                if (!(correct in correctMap)) return;

                const options      = [optA, optB, optC, optD];
                const optionImages = [
                    window.convertGDriveUrl(imgA),
                    window.convertGDriveUrl(imgB),
                    window.convertGDriveUrl(imgC),
                    window.convertGDriveUrl(imgD),
                ];
                if (optE) { options.push(optE); optionImages.push(window.convertGDriveUrl(imgE)); }

                questions.push({
                    packet,
                    text,
                    image: window.convertGDriveUrl(qImg),
                    options,
                    optionImages,
                    correct: correctMap[correct],
                    createdAt: Date.now()
                });
            });
            return questions;
        }

        // ---------- EXCEL IMPORT ----------
        window.handleExcelDrop = function(e) {
            e.preventDefault();
            document.getElementById('excel-drop-zone').classList.remove('border-green-500','bg-green-50');
            const file = e.dataTransfer.files[0];
            if (file) window.handleExcelFile(file);
        };

        window.handleExcelFile = function(file) {
            if (!file) return;
            if (typeof XLSX === 'undefined') { alert("Library XLSX belum siap."); return; }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const wb = XLSX.read(e.target.result, { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

                    const questions = parseRows(rows);
                    window.parsedExcelQuestions = questions;

                    document.getElementById('excel-count').innerText = questions.length;
                    document.getElementById('excel-preview-table').innerHTML = buildPreviewTable(questions);
                    document.getElementById('excel-preview').classList.remove('hidden');

                    if (questions.length === 0) {
                        document.getElementById('excel-preview-table').innerHTML = `<div class="p-4 text-red-600 text-sm"><strong>Tidak ada soal valid ditemukan.</strong> Pastikan format kolom sesuai template dan minimal ada 4 pilihan jawaban (A-D).</div>`;
                    }
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                } catch(err) {
                    alert("Gagal membaca file Excel: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.uploadParsedQuestions = async function() {
            if (!window.isFirebaseReady) { alert("Mode Offline: Tidak bisa upload ke database."); return; }
            const questions = window.parsedExcelQuestions;
            if (!questions || questions.length === 0) { alert("Tidak ada soal untuk diupload."); return; }

            const btn = document.getElementById('btn-upload-excel');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Mengupload...`;
            if(typeof lucide !== 'undefined') lucide.createIcons();

            showImportStatus('info', `Mengupload ${questions.length} soal ke database...`);
            let uploaded = 0, skipped = 0;

            try {
                for (const q of questions) {
                    const exists = window.allQuestionsDB.some(dbQ => dbQ.text === q.text && dbQ.packet === q.packet);
                    if (!exists) {
                        await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'), q);
                        uploaded++;
                    } else {
                        skipped++;
                    }
                }
                showImportStatus('success', `‚úÖ Berhasil upload ${uploaded} soal baru! (${skipped} soal duplikat dilewati)`);
                document.getElementById('excel-preview').classList.add('hidden');
                document.getElementById('excel-file-input').value = '';
                window.parsedExcelQuestions = [];
            } catch(err) {
                showImportStatus('error', `‚ùå Gagal upload: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload ke Database`;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
        };

        // ---------- WORD IMPORT ----------
        window.handleWordDrop = function(e) {
            e.preventDefault();
            document.getElementById('word-drop-zone').classList.remove('border-blue-500','bg-blue-50');
            const file = e.dataTransfer.files[0];
            if (file) window.handleWordFile(file);
        };

        window.handleWordFile = function(file) {
            if (!file) return;
            if (!file.name.endsWith('.docx')) { alert("Hanya file .docx yang didukung!"); return; }
            if (typeof mammoth === 'undefined') { alert("Library mammoth belum siap."); return; }

            const logEl = document.getElementById('word-log');
            logEl.classList.remove('hidden');
            logEl.innerText = '‚è≥ Membaca file Word...';

            const reader = new FileReader();
            reader.onload = function(e) {
                mammoth.convertToHtml({ arrayBuffer: e.target.result })
                    .then(result => {
                        const parser = new DOMParser();
                        const docHtml = parser.parseFromString(result.value, 'text/html');
                        const tables = docHtml.querySelectorAll('table');
                        
                        if (tables.length === 0) {
                            logEl.innerText = '‚ö†Ô∏è Tidak ditemukan tabel di dalam file Word. Pastikan soal diformat dalam tabel sesuai template.';
                            return;
                        }

                        // Ambil tabel pertama yang valid
                        let allRows = [];
                        tables.forEach(table => {
                            const rows = table.querySelectorAll('tr');
                            if (rows.length < 2) return;

                            // Cek apakah ini tabel soal (ada header 'packet' atau 'question')
                            const headerCells = rows[0].querySelectorAll('th, td');
                            const headerTexts = Array.from(headerCells).map(c => c.innerText.trim().toLowerCase());
                            if (!headerTexts.includes('packet') && !headerTexts.includes('question')) return;

                            // Parse rows
                            Array.from(rows).slice(1).forEach(row => {
                                const cells = row.querySelectorAll('td, th');
                                if (cells.length < 8) return;
                                const rowData = {};
                                headerTexts.forEach((h, i) => { rowData[h] = cells[i] ? cells[i].innerText.trim() : ''; });
                                allRows.push(rowData);
                            });
                        });

                        const questions = parseRows(allRows);
                        window.parsedWordQuestions = questions;

                        document.getElementById('word-count').innerText = questions.length;
                        document.getElementById('word-preview-table').innerHTML = buildPreviewTable(questions);
                        document.getElementById('word-preview').classList.remove('hidden');

                        if (questions.length === 0) {
                            document.getElementById('word-preview-table').innerHTML = `<div class="p-4 text-red-600 text-sm"><strong>Tidak ada soal valid.</strong> Pastikan tabel di Word sesuai format template (ada header: packet, question, option_a, ..., correct)</div>`;
                            logEl.innerText = `‚ö†Ô∏è ${allRows.length} baris ditemukan tapi tidak ada yang valid. Cek format kolom.`;
                        } else {
                            logEl.classList.add('hidden');
                        }
                        if(typeof lucide !== 'undefined') lucide.createIcons();
                    })
                    .catch(err => {
                        logEl.innerText = '‚ùå Gagal membaca Word: ' + err.message;
                    });
            };
            reader.readAsArrayBuffer(file);
        };

        window.uploadParsedWordQuestions = async function() {
            if (!window.isFirebaseReady) { alert("Mode Offline: Tidak bisa upload ke database."); return; }
            const questions = window.parsedWordQuestions;
            if (!questions || questions.length === 0) { alert("Tidak ada soal untuk diupload."); return; }

            const btn = document.getElementById('btn-upload-word');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Mengupload...`;
            if(typeof lucide !== 'undefined') lucide.createIcons();

            showImportStatus('info', `Mengupload ${questions.length} soal ke database...`);
            let uploaded = 0, skipped = 0;

            try {
                for (const q of questions) {
                    const exists = window.allQuestionsDB.some(dbQ => dbQ.text === q.text && dbQ.packet === q.packet);
                    if (!exists) {
                        await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'), q);
                        uploaded++;
                    } else {
                        skipped++;
                    }
                }
                showImportStatus('success', `‚úÖ Berhasil upload ${uploaded} soal baru dari Word! (${skipped} duplikat dilewati)`);
                document.getElementById('word-preview').classList.add('hidden');
                document.getElementById('word-file-input').value = '';
                document.getElementById('word-log').classList.add('hidden');
                window.parsedWordQuestions = [];
            } catch(err) {
                showImportStatus('error', `‚ùå Gagal upload: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload ke Database`;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
        };

        function showImportStatus(type, msg) {
            const el = document.getElementById('import-status');
            el.classList.remove('hidden', 'bg-blue-50', 'border-blue-200', 'text-blue-800',
                                'bg-green-50', 'border-green-200', 'text-green-800',
                                'bg-red-50', 'border-red-200', 'text-red-800');
            const styles = {
                info:    ['bg-blue-50','border-blue-200','text-blue-800'],
                success: ['bg-green-50','border-green-200','text-green-800'],
                error:   ['bg-red-50','border-red-200','text-red-800'],
            };
            el.classList.add(...(styles[type] || styles.info));
            el.innerText = msg;
            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        if(typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Tampilkan badge perf-mode di panel tampilan jika HP kentang
        document.addEventListener('DOMContentLoaded', () => {
            if (window._perfMode) {
                const badge = document.getElementById('perf-mode-info');
                if (badge) badge.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
